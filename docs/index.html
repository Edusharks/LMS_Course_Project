<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Editor & Viewer</title>
<style>

/* Global Variables & Basic Styles */
:root {
    --primary: #5E81F4;
    --secondary: #FF7AC6;
    --accent: #FFB800; /* Yellow */
    --light: #F5F7FA;
    --dark: #1A1D28;
    --success: #7CE7AC;
    --danger: #FF7E7E; /* Red (Used for active slide sub-tab now) */
    --primary-rgb: 94, 129, 244; /* Default RGB values */
    --secondary-rgb: 255, 122, 198;
    --base-font-family: 'Segoe UI', sans-serif; /* Default */
    --base-font-size: 16px; /* Default */
    --transition-speed: 0.3s;
    --transition-ease: ease;
    --sidebar-width: 24%; /* Decreased sidebar width slightly */
    --sidebar-min-width: 180px; /* Decreased min-width */
    --project-default-font-family: 'Segoe UI', sans-serif;
    --project-default-font-size: 16px;
}

html {
    scroll-behavior: smooth;
    box-sizing: border-box;
    font-size: var(--base-font-size); /* Applied globally from course settings */
}

*, *:before, *:after {
    box-sizing: inherit;
}

body {
    font-family: var(--base-font-family); /* Applied globally from course settings */
    margin: 0;
    padding: 0;
    background-color: var(--light);
    color: var(--dark);
    line-height: 1.6;
    transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease), font-family var(--transition-speed) var(--transition-ease), font-size var(--transition-speed) var(--transition-ease);
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px 15px;
}

h2 {
    color: var(--primary);
    border-bottom: 3px solid var(--secondary);
    padding-bottom: 8px;
    display: inline-block;
    font-size: 1.4rem;
    margin-top: 0;
    margin-bottom: 25px;
    transition: color var(--transition-speed) var(--transition-ease), border-color var(--transition-speed) var(--transition-ease);
}

h3 {
    color: var(--dark);
    margin-top: 30px;
    margin-bottom: 15px;
    font-size: 1.2rem;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
}

/* Whitespace Preservation */
#courseDescription,
#overviewText,
.step-content p.description,
#videoKeyPoints li,
.slide-description, /* Updated slide description class */
.quiz-question p.question-text {
    white-space: pre-wrap; /* Preserves spaces and newlines */
}


/* Page Header Styles (Course & Project) */
.page-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-bottom: 30px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 25px 20px;
    border-radius: 18px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    text-align: center;
    position: relative; /* Keep relative for positioning children */
    transition: background var(--transition-speed) var(--transition-ease);
}

.page-header img.header-image {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 12px;
    border: 4px solid white;
}

.page-header .header-title-container {
    flex-grow: 1;
}

.page-header .header-title {
    color: white;
    margin: 0 0 8px 0;
    font-size: 1.9rem;
    text-shadow: 1px 1px 4px rgba(0,0,0,0.25);
}

.page-header .header-subtitle {
    color: rgba(255, 255, 255, 0.95);
    font-size: 1.05rem;
    margin: 0;
}

/* Edit, Export, Back buttons - base style */
.edit-btn, .export-btn, .back-btn {
    background-color: rgba(255, 255, 255, 0.25);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.6);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 3px 7px rgba(0,0,0,0.2);
    transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
    z-index: 10;
    text-decoration: none;
    flex-shrink: 0; /* Prevent shrinking in flex container */
}

.edit-btn:hover, .export-btn:hover, .back-btn:hover {
    background-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
    box-shadow: 0 4px 9px rgba(0,0,0,0.25);
}

/* Course View Button Positions */
#course-view .page-header .edit-btn { position: absolute; top: 20px; right: 20px; }
#course-view .page-header .export-btn { position: absolute; top: 20px; right: 75px; }

/* --- PROJECT BUTTON POSITION CHANGE (Now Right) --- */
#project-view .page-header {
    position: relative; /* Ensure header is positioning context */
}

/* Container for Back/Edit buttons */
.header-button-group {
    position: absolute;
    top: 20px;
    right: 20px; /* Position group top-right */
    display: flex;
    gap: 10px; /* Space between buttons */
    align-items: center;
    z-index: 11; /* Ensure it's above other potential elements */
}
/* Specific styles for buttons inside the project header group */
#project-view .page-header .back-btn {
    font-size: 24px;
    order: 1; /* Back button first visually */
}
#project-view .page-header .edit-btn {
     order: 2; /* Edit button second visually */
}


/* NEW Container for Toggle Button and Progress Bar */
.progress-controls-container {
    display: flex;
    align-items: center;
    gap: 15px; /* Space between button and progress bar */
    margin-bottom: 15px; /* Space below the entire row */
}

/* Sidebar toggle button styling - NOW INSIDE FLEX CONTAINER */
#toggleSidebarBtn {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    background-color: var(--primary);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.6);
    border-radius: 50%;
    cursor: pointer;
    font-size: 22px;
    box-shadow: 0 3px 7px rgba(0,0,0,0.2);
    transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
    text-decoration: none;
}

#toggleSidebarBtn:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 9px rgba(0,0,0,0.25);
}

/* Progress Bar */
.progress-container {
    width: auto;
    flex-grow: 1;
    background-color: #e0e0e0;
    border-radius: 10px;
    margin: 0;
    height: 12px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary), var(--secondary));
    border-radius: 10px;
    width: 0%;
    transition: width .5s ease-in-out, background var(--transition-speed) var(--transition-ease);
}


/* == COURSE VIEW Specific Styles == */
#course-view {
    animation: fadeIn 0.5s;
}

#course-description-container {
    background-color: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    margin-bottom: 30px;
    font-size: 1.05rem;
    line-height: 1.7;
}
#course-description-container h2 {
    margin-bottom: 15px;
    font-size: 1.3rem;
}

/* --- Course Multimedia Section Styles --- */
#course-multimedia-section {
    background-color: white;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    margin-bottom: 30px;
    position: relative; /* Keep for positioning button */
    overflow: hidden; /* Keep for minimizing transition */
    transition: padding-top 0.3s ease, padding-bottom 0.3s ease, max-height 0.4s ease-out, opacity 0.3s ease-in;
}
#course-multimedia-section h2 {
    margin-bottom: 20px;
    font-size: 1.3rem;
}
#course-multimedia-content {
    margin-top: 15px;
    max-width: 100%;
    overflow: visible; /* Allow potential overflow from wrapper shadows etc. */
    border-radius: 12px; /* Keep radius if desired */
    background-color: transparent; /* MODIFIED: Removed light grey background */
    transition: max-height 0.4s ease-out, opacity 0.3s ease-in, margin-top 0.3s ease;
    max-height: 1000px; /* Keep for minimize transition */
    opacity: 1; /* Keep for minimize transition */
}

/* Styles for IMG directly inside content (not in a wrapper) */
#course-multimedia-content > img {
    display: block;
    max-width: 1000px;     /* Max width for direct images */
    height: auto;
    margin-left: auto;     /* Center direct images */
    margin-right: auto;
    border: none;
    border-radius: 12px;
    box-shadow: 0 3px 8px rgba(0,0,0,.1);
}

/* Wrapper for IFRAMEs (Video/Presentation) - Controls size & aspect ratio */
#course-multimedia-content .media-wrapper-16-9 {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;             /* Height determined by padding */
    overflow: hidden;      /* Clip iframe to rounded corners */
    max-width: 1000px;     /* Max width of the wrapper */
    margin-left: auto;     /* Center the wrapper */
    margin-right: auto;
    border-radius: 12px;   /* Apply rounding to the wrapper */
    background-color: transparent; /* MODIFIED: Ensure no background color here */
    box-shadow: 0 5px 12px rgba(0,0,0,.1); /* Add shadow to wrapper */
}

/* Styles for IFRAME inside the wrapper */
 #course-multimedia-content .media-wrapper-16-9 iframe {
    position: absolute;
    top: 0;
    left: 0;
    /* REMOVED: align-items & justify-content (not applicable here) */
    width: 100%;        /* Fill wrapper width */
    height: 100%;       /* Fill wrapper height */
    border: none;       /* Ensure no iframe border */
    border-radius: 12px;/* Match wrapper radius */
 }


/* Toggle Button (No changes needed from your snippet) */
#toggle-multimedia-btn {
    position: absolute;
    top: 20px; right: 20px;
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--dark);
    border: 1px solid rgba(0, 0, 0, 0.2);
    width: 32px; height: 32px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px; font-weight: bold;
    line-height: 1;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: background-color 0.3s, transform 0.2s;
    z-index: 5;
    padding: 0;
}
#toggle-multimedia-btn:hover {
    background-color: rgba(0, 0, 0, 0.2);
    transform: scale(1.05);
}

/* Minimized State (No changes needed from your snippet) */
#course-multimedia-section.multimedia-minimized {
    padding-top: 15px;
    padding-bottom: 15px;
}
 #course-multimedia-section.multimedia-minimized #course-multimedia-content {
    max-height: 0;
    opacity: 0;
    margin-top: 0;
    overflow: hidden; /* Keep hidden when minimized */
}
/* --- End Course Multimedia Styles --- */

/* Project Grid (Course View) */
#projectGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    margin-top: 20px;
}

.project-tab {
    background-color: white;
    border-radius: 15px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
    overflow: hidden;
    cursor: pointer;
    transition: transform var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
    display: flex;
    flex-direction: column;
    text-decoration: none;
    color: inherit;
    position: relative;
}
.project-tab:hover {
    transform: translateY(-6px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.12);
}
.project-tab img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    object-position: center;
    border-bottom: 1px solid #eee;
}
.project-tab-info {
    padding: 20px 15px;
    text-align: center;
    background-color: #fdfdff;
    flex-grow: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}
.project-tab-info span {
    font-weight: 600;
    color: var(--primary);
    font-size: 1.1rem;
    transition: color var(--transition-speed) var(--transition-ease);
}

.completion-tick {
    position: absolute;
    top: 12px; right: 12px;
    width: 30px; height: 30px;
    background-color: var(--success);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 19px; font-weight: bold;
    line-height: 1;
    box-shadow: 0 2px 5px rgba(0,0,0,0.25);
    z-index: 5;
}

/* == PROJECT VIEW Specific Styles == */
#project-view {
    animation: fadeIn 0.5s;
    font-family: var(--project-default-font-family);
    font-size: var(--project-default-font-size);
}
#project-view .page-header .header-image { width: 100px; height: 100px; border-radius: 10px; }
#project-view .page-header .header-title { font-size: 1.7rem; }
#project-view .page-header .header-subtitle { font-size: 1rem; }

/* NEW Project Layout: Sidebar + Content Area */
.project-layout {
    display: flex;
    flex-direction: row;
    gap: 25px;
    margin-top: 0;
    transition: gap 0.3s ease;
}
/* Collapsed State */
.project-layout.sidebar-collapsed {
    gap: 0;
}
.project-layout.sidebar-collapsed #project-sidebar {
     width: 0;
     min-width: 0;
     padding: 15px 0;
     overflow: hidden;
     opacity: 0;
     visibility: hidden;
 }

#project-sidebar {
    width: var(--sidebar-width);
    min-width: var(--sidebar-min-width);
    flex-shrink: 0;
    background-color: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    height: fit-content;
    transition: width 0.3s ease, min-width 0.3s ease, padding 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
    position: relative;
    opacity: 1;
    visibility: visible;
}

#project-main-content {
    flex-grow: 1;
    min-width: 0;
    transition: width 0.3s ease;
}

/* Styling for Tabs WITHIN the Sidebar */
#project-sidebar #projectTabs {
    display: flex;
    flex-direction: column;
    gap: 10px;
    overflow-x: visible;
    padding-bottom: 0;
    margin-bottom: 0;
}
#project-sidebar #projectTabs::-webkit-scrollbar { display: none; }
#project-sidebar #projectTabs .tab {
    width: 100%;
    text-align: left;
    white-space: normal;
    box-shadow: 0 2px 5px rgba(0,0,0,.05);
    border-radius: 8px;
    border: 1px solid #eee;
    padding: 11px 16px;
    margin-bottom: 0;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s, box-shadow 0.3s, transform 0.3s;
    position: relative;
    overflow: hidden;
    background-color: #fff;
    color: var(--dark);
}
#project-sidebar #projectTabs .tab.active {
    background-color: var(--primary);
    color: #fff;
    transform: none;
    box-shadow: 0 3px 8px rgba(var(--primary-rgb, 94, 129, 244),.2);
}
#project-sidebar #projectTabs .tab:hover:not(.active) {
    background-color: #eef2ff;
    transform: none;
    box-shadow: 0 3px 7px rgba(0,0,0,.07);
}

/* Styling for Tab Content WITHIN the Main Content Area */
#project-main-content .tab-content {
    display: none;
    background-color: #fff;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 5px 15px rgba(0,0,0,.06);
    animation: fadeIn .5s ease-out;
    margin-bottom: 0;
}
#project-main-content .tab-content.active {
    display: block;
}
#project-main-content .tab-content h2 {
    font-size: 1.3rem;
    margin-bottom: 20px;
}


/* --- Content Element Styles (Overview, Video, Slides, Challenges, Quiz) --- */

/* Video Section */
.video-container {
    position: relative;
    padding-bottom: 56.25%; height: 0;
    overflow: hidden;
    border-radius: 12px; box-shadow: 0 5px 12px rgba(0,0,0,.1);
    background-color: #000;
    max-width: 1000px;
    margin: 20px auto;
}
.video-container iframe {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: 12px; border: none;
}

/* --- Step-by-Step (Slides) Section --- */
#slides { }

/* Styling for the sub-tabs container in the sidebar */
.slide-sub-tabs {
    margin-top: 10px;
    padding-left: 15px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: flex-direction 0.3s ease;
}
.slide-sub-tabs .sub-tab {
    display: block;
    padding: 8px 15px;
    font-size: 0.9em;
    font-weight: 500;
    color: var(--dark);
    background-color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, width 0.2s ease;
    text-decoration: none;
    border: 1px solid #ccc;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    text-align: left;
    line-height: 1.4;
    box-shadow: none;
    width: 100%;
    flex-shrink: 0;
}
.slide-sub-tabs .sub-tab:hover {
    background-color: #f0f0f0;
    border-color: #aaa;
}
.slide-sub-tabs .sub-tab.active {
    background-color: var(--danger);
    color: white;
    font-weight: 600;
    border-color: var(--danger);
    box-shadow: 0 1px 4px rgba(0,0,0, 0.1);
}

/* Styling for the content displayed when a sub-tab is active */
#project-main-content #slides .slide-display-area {
    margin: 0;
}
.slide-content-container {
     display: none;
     animation: fadeIn 0.4s ease-out;
}
.slide-content-container.active {
    display: block;
}
.slide-description {
    margin: 0 0 15px 0;
    font-size: 1rem;
    color: #333;
}
.slide-media-wrapper {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    /* MODIFICATION START: Ensure overflow is visible */
    overflow: visible; /* Make sure wrapper doesn't clip iframe */
    /* MODIFICATION END */
    background-color: #eee;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,.1);
    max-width: 1000px;
    margin: 0 auto 15px auto;
}

.slide-media-wrapper iframe,
.slide-media-wrapper img {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: none;
    border-radius: 10px;
    background-color: transparent;
}
.slide-media-wrapper img {
    object-fit: contain; /* Keep for images */
}
/* --- End Step-by-Step (Slides) Styles --- */

/* Learn Items & Challenges (Using Step Styling) */
.step {
    display: flex; gap: 20px;
    margin-bottom: 25px; padding: 20px;
    background-color: #fdfdff; border-radius: 12px;
    align-items: flex-start;
    border-left: 6px solid var(--secondary);
    box-shadow: 0 2px 6px rgba(0,0,0,.05);
    transition: border-color var(--transition-speed) var(--transition-ease);
}
.step-number {
    background-color: var(--secondary); color: #fff;
    min-width: 35px; height: 35px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; flex-shrink: 0; font-size: 1rem;
    transition: background-color var(--transition-speed) var(--transition-ease);
}
#challengesContainer .step-number {
    background-color: var(--accent); color: var(--dark);
}

.step-content { flex: 1; display: flex; flex-direction: column; }
.step-content strong {
    font-size: 1.1rem; color: var(--primary);
    display: block; margin-bottom: 8px;
    transition: color var(--transition-speed) var(--transition-ease);
}
.step-content p.description {
    margin: 0 0 15px; font-size: 1rem; color: #333; line-height: 1.6;
}
.step-content p.description:last-child { margin-bottom: 0; }
.step-content .step-media {
    margin-top: 15px; max-width: 100%; width: 100%;
    overflow: hidden; border-radius: 10px; background-color: #f0f0f0;
}
.step-content .step-media img,
.step-content .step-media iframe {
    display: block; max-width: 100%; height: auto;
    border-radius: 10px; border: none;
    box-shadow: 0 3px 8px rgba(0,0,0,.1);
}
.step-content .step-media img {
    max-width: 300px; max-height: 225px;
    width: auto; height: auto; object-fit: contain;
    margin-left: 0; margin-right: auto;
}
.step-content .step-media iframe {
     aspect-ratio: 16 / 9; width: 100%; max-width: 640px;
     margin-left: 0; margin-right: auto;
}


/* Quiz Section */
.quiz-question {
    background-color: #fdfdff; padding: 25px;
    margin-bottom: 20px; border-radius: 12px;
    box-shadow: 0 3px 10px rgba(var(--primary-rgb, 94, 129, 244),.12);
    border: 1px solid #e0e8ff;
}
.quiz-question p.question-text {
    margin: 0 0 20px; font-size: 1.05rem;
    font-weight: 700; color: var(--dark);
}
.quiz-options { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
.quiz-option {
    display: block; padding: 14px 18px; margin-bottom: 0;
    background-color: #f5f7fa; border: 1px solid #d8dde6;
    border-radius: 10px; cursor: pointer;
    transition: all .3s ease; font-size: 1rem;
    position: relative; text-align: left; opacity: 1;
    display: flex; flex-direction: column; align-items: flex-start;
}
.quiz-option img.option-image {
    max-width: 200px; max-height: 150px; height: auto;
    display: block; margin-bottom: 10px; border-radius: 6px;
    object-fit: contain; background-color: #fff;
}
.quiz-option span.option-text { display: block; }

.quiz-option:hover { background-color: #e8ecf3; border-color: #c4cde0; transform: translateX(3px); }
.quiz-option.selected { border-color: var(--primary); background-color: #e8f0fe; font-weight: 500; }
.quiz-option.correct { background-color: var(--success); color: #fff; border-color: #63c899; font-weight: 700; }
.quiz-option.correct.selected { background-color: var(--success); color: #fff; border-color: #63c899; }
.quiz-option.incorrect.selected {
    background-color: var(--danger); color: #fff;
    border-color: #e66a6a; font-weight: 700;
    text-decoration: line-through; text-decoration-thickness: 2px;
    border-color: #e66a6a!important;
}
.quiz-question.answered .quiz-option:not(.selected):not(.correct) {
    opacity: .6; cursor: default;
    background-color: #f5f7fa; border-color: #d8dde6;
    text-decoration: none; transform: none;
}
.quiz-question.answered .quiz-option.correct:not(.selected) { opacity: 1; }

.quiz-feedback {
    margin-top: 15px; padding: 12px 18px; border-radius: 8px;
    display: none; font-size: .9rem;
    border-width: 1px; border-style: solid; font-weight: 500;
}
.quiz-feedback.correct { background-color: #e6f7ed; color: #1d6c45; border-color: #c3e6cb; }
.quiz-feedback.incorrect { background-color: #fde8e8; color: #9b1c1c; border-color: #f5c6cb; }

.final-quiz-result {
    margin-top: 25px; padding: 18px; border-radius: 10px;
    text-align: center; font-weight: 700; font-size: 1.15rem;
}
.final-quiz-result.success { background-color: #e6f7ed; color: #1d6c45; border: 1px solid #c3e6cb; }
.final-quiz-result.fail { background-color: #fde8e8; color: #9b1c1c; border: 1px solid #f5c6cb; }

.submit-btn {
    background-color: var(--accent); color: var(--dark);
    border: none; padding: 14px 30px; border-radius: 30px;
    font-weight: 700; cursor: pointer; margin-top: 30px; font-size: 1.05rem;
    transition: all .3s; display: block;
    width: 100%; max-width: 280px; margin-left: auto; margin-right: auto;
    box-shadow: 0 3px 8px rgba(0,0,0,.15);
    transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease), transform var(--transition-speed) var(--transition-ease);
}
.submit-btn:hover:not(:disabled) { background-color: #ffc833; box-shadow: 0 5px 12px rgba(0,0,0,.2); transform: translateY(-2px); }
.submit-btn:disabled {
    background-color: #ccc; color: #666; cursor: not-allowed;
    box-shadow: none; transform: none; opacity: .7;
}


/* == MODAL STYLES (Course & Project Editors) == */
.modal {
    display: none; position: fixed; top: 0; left: 0;
    width: 100%; height: 100%; background-color: rgba(0,0,0,.7);
    z-index: 1000; overflow-y: auto; padding: 40px 15px;
}
.modal-content {
    background-color: #fff; margin: 40px auto; padding: 30px 35px;
    border-radius: 15px; width: 90%; max-width: 850px;
    box-shadow: 0 8px 25px rgba(0,0,0,.3); position: relative;
}
.close-modal {
    position: absolute; top: 15px; right: 20px;
    font-size: 32px; font-weight: 700; color: #aaa; cursor: pointer;
    line-height: 1; z-index: 1001; padding: 5px; transition: color 0.3s;
}
.close-modal:hover { color: #333; }
.modal h2 { margin-bottom: 25px; }

/* Form Styles within Modals */
.edit-form { margin-top: 25px; }
.edit-form label {
    display: block; margin-bottom: 6px; font-weight: 600;
    color: var(--primary); font-size: .95rem;
}
.edit-form input[type=text], .edit-form input[type=url], .edit-form textarea, .edit-form select {
    width: 100%; padding: 12px; margin-bottom: 18px;
    border: 1px solid #ccc; border-radius: 6px; font-size: 1rem;
    box-sizing: border-box; transition: border-color 0.3s;
    font-family: inherit; /* Inherit body font */
}
.edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus {
    border-color: var(--primary); outline: none;
    box-shadow: 0 0 0 2px rgba(var(--primary-rgb, 94, 129, 244), 0.2);
}
.edit-form textarea { resize: vertical; min-height: 80px; white-space: pre-wrap; }

.edit-form button, button.remove-item-btn, button.add-item-btn {
    background-color: var(--primary); color: #fff;
    border: none; padding: 10px 18px; border-radius: 6px; cursor: pointer;
    margin-right: 10px; margin-top: 10px; font-size: .95rem; font-weight: 500;
    transition: background-color .3s, transform 0.2s, box-shadow 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.edit-form button:hover, button.remove-item-btn:hover, button.add-item-btn:hover {
    background-color: #4a6cdc; transform: translateY(-1px);
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

/* Add/Remove Buttons */
button.remove-item-btn {
    background-color: var(--danger); margin-left: 10px; font-weight: 700;
    line-height: 1; padding: 6px 10px; width: 30px; height: 30px;
    font-size: 1rem; display: flex; align-items: center; justify-content: center;
    box-shadow: none;
}
button.remove-item-btn:hover { background-color: #e66a6a; transform: scale(1.1); }
button.add-item-btn {
    background-color: var(--success); display: inline-block; margin-top: 15px;
    margin-left: 0; margin-right: 0; width: fit-content;
}
button.add-item-btn:hover { background-color: #63c899; }

/* Modal Action Buttons (Save/Cancel) */
.modal-actions {
    margin-top: 30px; text-align: right;
    border-top: 1px solid #eee; padding-top: 20px;
}
.modal-actions button { display: inline-block; }
.modal-actions button[type="submit"], .modal-actions button[onclick^="save"] { background-color: var(--success); }
.modal-actions button[type="submit"]:hover, .modal-actions button[onclick^="save"]:hover { background-color: #63c899; }
.modal-actions button[onclick^="closeModal"] { background-color: #aaa; margin-right: 0; }
.modal-actions button[onclick^="closeModal"]:hover { background-color: #888; }

/* Editor Section Styling */
.edit-section { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; }
#projectEditModal .edit-section h4, #courseEditModal .edit-section h4 {
    color: var(--primary); margin-bottom: 15px; padding-bottom: 6px;
    border-bottom: 2px solid var(--secondary); display: inline-block; font-size: 1.15rem;
}
#projectEditModal .edit-section h5 {
    color: var(--dark); margin-top: 25px; margin-bottom: 12px;
    font-size: 1.05rem; font-weight: 600;
}

/* Item Grouping for Lists (Learn, Slides, Challenges, Quiz) */
.edit-item-group {
    margin-bottom: 25px; padding: 20px; border: 1px solid #ddd;
    border-radius: 10px; background-color: #fdfdff; position: relative;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.edit-item-group .remove-item-btn { position: absolute; top: 15px; right: 15px; }
.edit-item-group>label { /* Labels directly under group (like "Item 1 Title:") */
    font-weight: 700; color: var(--dark); font-size: 1rem;
    margin-top: 5px; display: block; margin-bottom: 10px;
}
.edit-item-group label { /* Normal labels within group */
    font-weight: 500; color: #555; font-size: .9rem;
}
.edit-item-group input[type=text], .edit-item-group input[type=url],
.edit-item-group textarea, .edit-item-group select {
    margin-bottom: 12px;
}

/* Media Controls in Editor Lists */
.media-controls { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; }
.media-controls label { font-weight: 500; color: #555; font-size: .9rem; }
.media-url-input-container { margin-top: 8px; }
.media-url-input-container label.sr-only { /* Already handled by global .sr-only */ }

/* Course Multimedia Editor */
.course-multimedia-editor-fields { margin-top: 8px; padding-left: 10px; border-left: 3px solid #eee; }

/* Quiz Editor Specifics */
.incorrect-answer-label { font-size: .9rem; color: #777; margin-top: 10px; font-weight: 500; }
.quiz-answer-image-url label { font-size: .85rem; color: #666; margin-top: -8px; margin-bottom: 10px; }
.quiz-answer-image-url input[type=url] { padding: 8px; font-size: .9rem; margin-bottom: 10px; }


/* Color/Font/Size Pickers */
.color-picker { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
.color-option {
    width: 32px; height: 32px; border-radius: 50%; cursor: pointer;
    border: 2px solid #ddd; transition: transform .2s, border-color .2s, box-shadow .2s;
}
.color-option.selected { border: 3px solid var(--dark); transform: scale(1.15); box-shadow: 0 0 8px rgba(0,0,0,0.2); }
input[type=color] {
    width: 38px; height: 38px; border: 1px solid #ccc; padding: 2px;
    border-radius: 50%; overflow: hidden; cursor: pointer;
    vertical-align: middle; background-color: white;
}
input[type=color]::-webkit-color-swatch-wrapper { padding: 0; }
input[type=color]::-webkit-color-swatch { border: none; border-radius: 50%; }
input[type=color].inherited-style { border: 2px dashed #aaa !important; }

/* NEW Font/Size Selectors */
.font-selector, .size-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 18px;
    flex-wrap: wrap;
}
.font-option, .size-option {
    padding: 6px 14px;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color .3s, color .3s, border-color .3s;
    font-size: 0.9rem;
    background-color: #fff;
    color: #333;
}
.font-option.selected, .size-option.selected {
    background-color: var(--primary);
    color: #fff;
    border-color: var(--primary);
    font-weight: 500;
}
.font-option:hover:not(.selected), .size-option:hover:not(.selected) {
    background-color: #eef2ff;
    border-color: #c4cde0;
}
/* Apply font family preview */
.font-option[data-font*="Segoe"] { font-family: 'Segoe UI', sans-serif; }
.font-option[data-font*="Arial"] { font-family: Arial, sans-serif; }
.font-option[data-font*="Georgia"] { font-family: Georgia, serif; }
.font-option[data-font*="Courier"] { font-family: 'Courier New', monospace; }
.font-option[data-font*="Verdana"] { font-family: Verdana, sans-serif; }
.font-option[data-font*="Comic"] { font-family: 'Comic Sans MS', cursive; }
/* END NEW */

/* Project Tab List Editor (in Course Modal) */
#courseEditModal #projectTabsEditor { margin-top: 25px; padding-top: 20px; border-top: 1px solid #eee; }
#projectTabsEditor h4 {
    margin-bottom: 18px; color: var(--primary); display: inline-block;
    border-bottom: 2px solid var(--secondary); padding-bottom: 6px; font-size: 1.1rem;
}
#projectTabsList { max-height: 350px; overflow-y: auto; padding-right: 10px; }
.project-tab-edit-item {
    display: grid; grid-template-columns: auto 1fr auto; gap: 15px; align-items: center;
    padding: 15px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px;
    background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.04);
}
.project-tab-edit-item .index { font-weight: bold; font-size: 1rem; color: var(--secondary); }
.project-tab-edit-item .inputs { display: flex; flex-direction: column; gap: 8px; }
.project-tab-edit-item label { font-size: 0.85rem; margin-bottom: 3px; color: #555; font-weight: 500; }
.project-tab-edit-item input { padding: 8px; font-size: 0.9rem; }

/* General Editor Hints */
#projectEditModal #editingProjectNameLabel { color: var(--secondary); font-weight: bold; }
#projectEditModal .form-hint, #courseEditModal .form-hint {
    font-size: 0.85rem; color: #666; margin-top: -10px; margin-bottom: 15px;
}


/* == RESPONSIVE STYLES == */
@media (min-width: 768px) {
    .container { padding: 30px; }
    .page-header { flex-direction: row; text-align: left; align-items: center; padding: 30px 35px; gap: 30px; }
    #course-view .page-header img.header-image { width: 150px; height: 150px; border-radius: 15px; }
    .page-header .header-title { font-size: 2.2rem; }
    .page-header .header-subtitle { font-size: 1.2rem; }
    .step-content .step-media { max-width: 80%; margin-left: 0; }
    #project-view .page-header img.header-image { width: 120px; height: 120px; }
    #project-view .page-header .header-title { font-size: 2.1rem; }
    #project-view .page-header .header-subtitle { font-size: 1.1rem; }
    /* Show sidebar toggle button when layout is side-by-side */
    #toggleSidebarBtn {
        display: flex; /* Ensure it shows on wider screens */
    }
}

@media (max-width: 900px) { /* Adjust breakpoint for sidebar behavior */
    :root {
        --sidebar-width: 100%; /* Sidebar takes full width when stacked */
        --sidebar-min-width: 0; /* Allow it to shrink fully */
    }
    .project-layout {
        flex-direction: column; /* Stack sidebar above content */
        gap: 20px;
        margin-top: 20px; /* Restore margin when progress controls are simpler */
    }
    #project-sidebar {
        width: 100%;
        height: auto;
        box-shadow: none;
        border: 1px solid #eee;
        padding: 10px;
        background: #fff;
        overflow: visible; /* Allow horizontal scrolling tabs */
        transition: none; /* Disable collapse transitions when stacked */
        opacity: 1;
        visibility: visible;
    }
    /* Hide sidebar toggle button when layout is stacked */
    #toggleSidebarBtn {
        display: none;
    }
    /* Adjust progress container when button is hidden */
    .progress-controls-container {
        gap: 0; /* Remove gap */
        margin-bottom: 0; /* Remove bottom margin if project-layout handles it */
    }
    .progress-controls-container .progress-container {
        width: 100%; /* Ensure it takes full width */
        margin-bottom: 10px; /* Add back some bottom margin */
    }

    .project-layout.sidebar-collapsed #project-sidebar {
        /* Reset collapse styles when stacked */
         width: 100%;
         min-width: 0;
         padding: 10px;
         overflow: visible;
         opacity: 1;
         visibility: visible;
     }
    /* Tabs go horizontal when stacked */
    #project-sidebar #projectTabs {
        flex-direction: row; /* Tabs back to horizontal */
        overflow-x: auto;
        padding-bottom: 8px;
         -webkit-overflow-scrolling: touch;
    }
     #project-sidebar #projectTabs::-webkit-scrollbar {
         height: 4px; background-color: #eee; border-radius: 2px;
     }
     #project-sidebar #projectTabs::-webkit-scrollbar-thumb {
         background-color: var(--primary); border-radius: 2px;
     }
     #project-sidebar #projectTabs .tab {
        width: auto; white-space: nowrap; flex-shrink: 0;
        padding: 10px 20px; font-size: .95rem;
        border-radius: 30px; text-align: center;
        overflow: visible;
    }
     #project-sidebar #projectTabs .tab.active { transform: translateY(-3px); }
     #project-sidebar #projectTabs .tab:hover:not(.active) { transform: translateY(-2px); }

    /* --- Slides Sub-tabs: Horizontal on Mobile --- */
     .slide-sub-tabs {
        flex-direction: row;
        overflow-x: auto;
        padding-left: 0;
        padding-bottom: 8px;
        gap: 10px;
        margin-top: 8px;
        width: 100%;
         -webkit-overflow-scrolling: touch;
     }
     .slide-sub-tabs::-webkit-scrollbar {
         height: 4px; background-color: #ddd; border-radius: 2px;
     }
     .slide-sub-tabs::-webkit-scrollbar-thumb {
         background-color: var(--danger); border-radius: 2px;
     }
     .slide-sub-tabs .sub-tab {
        width: auto;
        white-space: nowrap;
        flex-shrink: 0;
        padding: 8px 15px;
        border-radius: 20px;
        text-align: center;
     }
     /* --- End Slides Sub-tabs Mobile --- */
}

@media (max-width: 767px) {
     #toggleSidebarBtn { display: none; }
     /* Adjust button group position */
     .header-button-group { top: 15px; right: 15px; } /* Changed left to right */
}


@media (max-width: 600px) {
    .container { padding: 15px 10px; }
    .page-header { padding: 20px 15px; flex-direction: column; align-items: center; text-align: center; }
    #project-main-content .tab-content,
    #course-description-container,
    #course-multimedia-section { padding: 20px; }

    /* Adjust header buttons for smaller screens */
    .edit-btn, .export-btn, .back-btn { width: 36px; height: 36px; font-size: 18px; }
    #course-view .page-header .edit-btn { top: 15px; right: 15px; }
    #course-view .page-header .export-btn { top: 15px; right: 65px; }

    /* Adjust button group position */
    .header-button-group { top: 15px; right: 15px; } /* Changed left to right */

    h2 { font-size: 1.3rem; }
    .page-header .header-title { font-size: 1.6rem; }
    .page-header .header-subtitle { font-size: .95rem; }
    .modal-content { padding: 25px 20px; }

    #course-multimedia-section { padding: 20px 15px; }
    #toggle-multimedia-btn { top: 15px; right: 15px; width: 30px; height: 30px; font-size: 16px;}

    .step { flex-direction: column; align-items: flex-start; gap: 10px; }
    .step-number { margin-top: 0; margin-bottom: 5px; }
    .step-content .step-media img { max-width: 100%; max-height: 180px; }
     .step-content .step-media iframe { max-width: 100%; }

     .quiz-option img.option-image { max-width: 150px; max-height: 110px; }

    #project-view .page-header .header-title { font-size: 1.5rem; }
    #project-view .page-header .header-subtitle { font-size: .95rem; }

    .modal-actions { text-align: center; }
    .modal-actions button { width: 48%; margin: 5px 1%; }
    .modal-actions button[onclick^="closeModal"] { margin-right: 1%; }
}

</style>
</head>
<body>
    <!-- Container for the whole application -->
    <div class="container">

        <!-- == COURSE VIEW (Visible by default) == -->
        <div id="course-view">
            <header class="page-header" id="course-header">
                <button class="edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details" title="Edit Course">✏️</button>
                <button class="export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML" title="Export Course">⬇️</button>
                <img src="https://via.placeholder.com/150" alt="Course Image" class="header-image" id="courseImage">
                <div class="header-title-container">
                    <h1 class="header-title" id="courseTitle">Loading Course...</h1>
                </div>
            </header>

            <section id="course-description-container">
                <h2>About This Course</h2>
                <p id="courseDescription">Loading course description...</p>
            </section>

            <section id="course-multimedia-section" style="display: none;">
                <h2>Introduction</h2>
                <button id="toggle-multimedia-btn" onclick="toggleCourseMultimedia()" aria-label="Toggle Multimedia Visibility" title="Minimize/Maximize Course Intro">—</button>
                <div id="course-multimedia-content">
                    <p>Loading multimedia...</p>
                </div>
            </section>

            <section>
                <h2>Projects</h2>
                <div id="projectGrid">
                    <p>Loading projects...</p>
                </div>
            </section>
        </div>

        <!-- == PROJECT VIEW (Hidden by default) == -->
        <div id="project-view" style="display: none;">
            <header class="page-header" id="project-header">
                 <div class="header-button-group">
                    <button class="back-btn" id="backToCourseBtn" onclick="showCourseView()" aria-label="Back to Course" title="Back to Course">←</button>
                    <button class="edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project" title="Edit Project">✏️</button>
                </div>
                <img src="" alt="Project Image" class="header-image" id="projectImage">
                <div class="header-title-container">
                    <h1 class="header-title" id="projectTitle">Project Title</h1>
                    <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
                </div>
            </header>

             <div class="progress-controls-container">
                <button id="toggleSidebarBtn" onclick="toggleProjectSidebar()" aria-label="Toggle Sidebar" title="Collapse/Expand Sidebar">❮</button>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <div class="project-layout" id="projectLayout">
                <aside id="project-sidebar">
                     <nav id="projectTabs">
                        <div class="tab active" data-tab-id="overview" onclick="openProjectTab('overview', this)">Overview</div>
                        <div class="tab" data-tab-id="video" onclick="openProjectTab('video', this)">Video Lesson</div>
                        <div class="tab" data-tab-id="slides" onclick="openProjectTab('slides', this)">
                            Step-by-Step
                            <div class="slide-sub-tabs" data-for-tab="slides" style="display: none;">
                                <!-- Sub-tabs added here -->
                            </div>
                        </div>
                        <div class="tab" data-tab-id="challenges" onclick="openProjectTab('challenges', this)">Challenges</div>
                        <div class="tab" data-tab-id="quiz" onclick="openProjectTab('quiz', this)">Quiz</div>
                    </nav>
                </aside>

                <main id="project-main-content">
                    <div id="projectTabContentContainer">
                        <section id="overview" class="tab-content active">
                            <h2>About This Project</h2>
                            <p id="overviewText">Loading overview...</p>
                            <h3>What You'll Learn</h3>
                            <div id="learnContainer"><p>Loading learning objectives...</p></div>
                        </section>
                        <section id="video" class="tab-content">
                            <h2>Video Lesson</h2>
                            <p id="videoIntroText"></p>
                            <h3 id="videoTitle"></h3>
                            <div class="video-container">
                                <iframe src="" frameborder="0" loading="lazy" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" allowfullscreen id="mainVideo" title="Project Video"></iframe>
                            </div>
                            <h3>Key Points</h3>
                            <ul id="videoKeyPoints" style="list-style: disc;"><p>Loading key points...</p></ul>
                        </section>
                        <section id="slides" class="tab-content">
                             <h2>Step-by-Step Guide</h2>
                             <div class="slide-display-area" id="slideshowContainer">
                                <p>Loading slides...</p>
                             </div>
                        </section>
                        <section id="challenges" class="tab-content">
                            <h2>Project Challenges</h2>
                            <p>Try these challenges to test your skills:</p>
                            <div id="challengesContainer"><p>Loading challenges...</p></div>
                        </section>
                        <section id="quiz" class="tab-content">
                            <h2>Project Quiz</h2>
                            <p>Test your knowledge from this project:</p>
                            <div id="quizContainer"><p>Loading quiz...</p></div>
                            <button class="submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz</button>
                        </section>
                    </div>
                </main>
            </div>
        </div>

    </div>


    <!-- ==== MODALS ==== -->
    <div id="courseEditModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor">×</span>
            <h2>Edit Course Details</h2>
            <form class="edit-form" onsubmit="event.preventDefault(); saveCourseChanges();">
                <section class="edit-section" style="border-top: none; padding-top: 0;">
                    <h4>Course Metadata</h4>
                    <label for="editCourseTitle">Course Title:</label>
                    <input type="text" id="editCourseTitle" required>
                    <label for="editCourseImage">Course Header Image URL:</label>
                    <input type="url" id="editCourseImage" placeholder="https://example.com/image.jpg">
                    <label for="editCourseDescription">Course Description:</label>
                    <textarea id="editCourseDescription" rows="6"></textarea>
                </section>

                <section id="courseMultimediaEditor" class="edit-section">
                    <h4>Course Multimedia (Optional)</h4>
                    <p class="form-hint">Add an introductory image, video, or presentation displayed above the projects.</p>
                    <label for="editCourseMultimediaType">Multimedia Type:</label>
                    <select id="editCourseMultimediaType" onchange="toggleCourseMultimediaEditorFields(this.value)">
                        <option value="none">None (Hidden)</option>
                        <option value="image">Image</option>
                        <option value="video">Video Embed</option>
                        <option value="presentation">Presentation Embed</option>
                         <option value="iframe">Generic Iframe</option> <!-- Added generic iframe -->
                    </select>
                    <div id="courseMultimediaEditorFieldsContainer" class="course-multimedia-editor-fields" style="display:none;">
                        <label for="editCourseMultimediaUrl">Media URL:</label>
                        <input type="url" id="editCourseMultimediaUrl" placeholder="Enter Image URL or Embed URL...">
                        <label for="editCourseMultimediaTitle">Media Title (Optional):</label>
                        <input type="text" id="editCourseMultimediaTitle" placeholder="e.g., Course Intro Video">
                    </div>
                </section>

                <section id="courseStyleEditor" class="edit-section">
                    <h4>Course Theme Colors</h4>
                    <p class="form-hint">Set the main colors used globally unless overridden by a specific project.</p>
                    <label>Primary Color:</label>
                    <div class="color-picker">
                        <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('primary', '#5E81F4')" title="Blue"></div>
                        <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('primary', '#FF7AC6')" title="Pink"></div>
                        <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('primary', '#7CE7AC')" title="Green"></div>
                        <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('primary', '#FFB800')" title="Orange"></div>
                        <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('primary', '#9B51E0')" title="Purple"></div>
                        <input type="color" id="coursePrimaryColorPicker" oninput="customCourseColorSelected('primary', this.value)" aria-label="Custom Primary Color">
                    </div>
                    <label>Secondary Color:</label>
                    <div class="color-picker">
                        <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('secondary', '#5E81F4')" title="Blue"></div>
                        <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('secondary', '#FF7AC6')" title="Pink"></div>
                        <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('secondary', '#7CE7AC')" title="Green"></div>
                        <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('secondary', '#FFB800')" title="Orange"></div>
                        <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('secondary', '#9B51E0')" title="Purple"></div>
                        <input type="color" id="courseSecondaryColorPicker" oninput="customCourseColorSelected('secondary', this.value)" aria-label="Custom Secondary Color">
                    </div>
                    <label>Accent Color:</label>
                    <div class="color-picker">
                         <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('accent', '#FFB800')" title="Orange"></div>
                         <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('accent', '#FF7AC6')" title="Pink"></div>
                         <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('accent', '#7CE7AC')" title="Green"></div>
                         <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('accent', '#5E81F4')" title="Blue"></div>
                         <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('accent', '#9B51E0')" title="Purple"></div>
                        <input type="color" id="courseAccentColorPicker" oninput="customCourseColorSelected('accent', this.value)" aria-label="Custom Accent Color">
                    </div>

                    <h5 style="margin-top: 30px;">Global Font & Size</h5>
                    <label for="courseFontSelector">Global Font Family:</label>
                    <div class="font-selector" id="courseFontSelector">
                        <div class="font-option" data-font="Segoe UI" onclick="selectCourseStyle('fontFamily', `'Segoe UI', sans-serif`)">Segoe UI (Default)</div>
                        <div class="font-option" data-font="Arial" onclick="selectCourseStyle('fontFamily', `'Arial', Helvetica, sans-serif`)">Arial</div>
                        <div class="font-option" data-font="Georgia" onclick="selectCourseStyle('fontFamily', `'Georgia', 'Times New Roman', serif`)">Georgia</div>
                        <div class="font-option" data-font="Courier New" onclick="selectCourseStyle('fontFamily', `'Courier New', monospace`)">Courier New</div>
                        <div class="font-option" data-font="Verdana" onclick="selectCourseStyle('fontFamily', `'Verdana', Geneva, sans-serif`)">Verdana</div>
                        <div class="font-option" data-font="Comic Sans MS" onclick="selectCourseStyle('fontFamily', `'Comic Sans MS', cursive, sans-serif`)">Comic Sans</div>
                    </div>
                    <label for="courseSizeSelector">Global Base Text Size:</label>
                    <div class="size-selector" id="courseSizeSelector">
                        <div class="size-option" onclick="selectCourseStyle('baseSize', 'small')">Small (14px)</div>
                        <div class="size-option" onclick="selectCourseStyle('baseSize', 'medium')">Medium (16px - Default)</div>
                        <div class="size-option" onclick="selectCourseStyle('baseSize', 'large')">Large (18px)</div>
                    </div>
                </section>

                <section id="projectTabsEditor" class="edit-section">
                    <h4>Manage Project Tabs</h4>
                    <p class="form-hint">Add, remove, or rename project tabs. Max 25 projects.</p>
                    <div id="projectTabsList"></div>
                    <button type="button" class="add-item-btn" onclick="addProjectTabEditField()">+ Add New Project Tab</button>
                </section>

                <div class="modal-actions">
                    <button type="button" onclick="closeModal('courseEditModal')">Cancel</button>
                    <button type="submit">Save Course</button>
                </div>
            </form>
        </div>
    </div>

    <div id="projectEditModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor">×</span>
            <h2>Edit Project Details</h2>
            <p style="font-size: 0.9rem; color: #555; margin-bottom: 20px;">Editing project: <strong id="editingProjectNameLabel"></strong></p>
            <form class="edit-form" onsubmit="event.preventDefault(); saveProjectChanges();">
                <input type="hidden" id="editingProjectId">

                <label for="editSectionProject">Select Section to Edit:</label>
                <select id="editSectionProject" onchange="showProjectEditSection()">
                    <option value="projMeta">Project Header & Course Tab</option>
                    <option value="overview">Overview & Learn</option>
                    <option value="video">Video Lesson</option>
                    <option value="slides">Step-by-Step Slides</option>
                    <option value="challenges">Challenges</option>
                    <option value="quiz">Quiz Questions</option>
                    <option value="projStyle">Project Styles (Font, Size, Colors)</option>
                </select>

                <section id="projMetaEdit" class="edit-section" style="border-top: none; padding-top: 10px;">
                    <h4>Project Header & Course Tab</h4>
                    <label for="editProject_Title">Project Title:</label>
                    <input type="text" id="editProject_Title" required>
                    <label for="editProject_Subtitle">Subtitle:</label>
                    <input type="text" id="editProject_Subtitle" placeholder="Short description">
                    <label for="editProject_HeaderImage">Project Header Image URL:</label>
                    <input type="url" id="editProject_HeaderImage" placeholder="https://...">
                    <p class="form-hint">~100x100px recommended.</p>
                    <hr style="margin: 20px 0;">
                    <label for="editProject_TabName">Tab Name (on Course Page):</label>
                    <input type="text" id="editProject_TabName" required placeholder="e.g., Beating Heart">
                    <label for="editProject_TabImage">Tab Image URL (on Course Page):</label>
                    <input type="url" id="editProject_TabImage" placeholder="https://...">
                    <p class="form-hint">Square image (~300x300px) recommended.</p>
                </section>

                <section id="overviewEdit" class="edit-section" style="display:none;">
                    <h4>Overview Content</h4>
                    <label for="editProject_OverviewText">Overview Text:</label>
                    <textarea id="editProject_OverviewText" rows="5" placeholder="Describe..."></textarea>
                    <hr style="margin: 25px 0;">
                    <h4>"What You'll Learn" Items</h4>
                    <p class="form-hint">Max 8 items.</p>
                    <div id="learnEditContainer"></div>
                    <button type="button" class="add-item-btn" onclick="addLearnEditField()">+ Add Item</button>
                </section>

                <section id="videoEdit" class="edit-section" style="display:none;">
                    <h4>Video Lesson Content</h4>
                    <label for="editProject_VideoIntroText">Introduction Text (Above Video):</label>
                    <textarea rows="2" id="editProject_VideoIntroText" placeholder="e.g., Watch this..."></textarea>
                    <label for="editProject_VideoTitle">Video Section Title (Above Video):</label>
                    <input type="text" id="editProject_VideoTitle" placeholder="e.g., Animation">
                    <label for="editProject_VideoUrl">Video Embed URL:</label>
                    <input type="url" id="editProject_VideoUrl" placeholder="https://...">
                    <label for="editProject_VideoKeyPoints">Key Points (one per line):</label>
                    <textarea id="editProject_VideoKeyPoints" rows="5" placeholder="Point 1..."></textarea>
                </section>

                <section id="slidesEdit" class="edit-section" style="display:none;">
                    <h4>Step-by-Step Slides</h4>
                    <p class="form-hint">Max 20 slides. Choose media type for each slide.</p>
                    <div id="slidesEditContainer"></div>
                    <button type="button" class="add-item-btn" onclick="addSlideEditField()">+ Add Slide</button>
                </section>

                <section id="challengesEdit" class="edit-section" style="display:none;">
                    <h4>Project Challenges</h4>
                    <p class="form-hint">Max 10 challenges.</p>
                    <div id="challengesEditContainer"></div>
                    <button type="button" class="add-item-btn" onclick="addChallengeEditField()">+ Add Challenge</button>
                </section>

                <section id="quizEdit" class="edit-section" style="display:none;">
                    <h4>Quiz Questions</h4>
                    <p class="form-hint">Max 20 questions. Mark one answer correct. Up to 3 incorrect.</p>
                    <div id="quizEditContainer"></div>
                    <button type="button" class="add-item-btn" onclick="addQuizEditField()">+ Add Question</button>
                </section>

                <section id="projStyleEdit" class="edit-section" style="display:none;">
                    <h4>Project Specific Styles</h4>
                    <p class="form-hint">Optionally override global course styles.</p>
                    <h5>Color Overrides</h5>
                    <p class="form-hint" style="margin-bottom: 10px;">Dashed border = inheriting course color.</p>
                     <button type="button" onclick="clearProjectColorOverrides()" style="font-size: 0.85rem; padding: 5px 10px; margin-bottom: 20px; background-color: #bbb; font-weight: normal; box-shadow: none;">Use Course Default Colors</button>
                    <label>Project Primary Color Override:</label>
                    <div class="color-picker" id="projectPrimaryColorPickerContainer">
                        <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('primary', '#5E81F4')" title="Blue"></div>
                        <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('primary', '#FF7AC6')" title="Pink"></div>
                        <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('primary', '#7CE7AC')" title="Green"></div>
                        <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('primary', '#FFB800')" title="Orange"></div>
                        <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('primary', '#9B51E0')" title="Purple"></div>
                        <input type="color" id="projectPrimaryColorPicker" oninput="customProjectColorSelected('primary', this.value)" aria-label="Custom Project Primary Color">
                    </div>
                    <label>Project Secondary Color Override:</label>
                    <div class="color-picker" id="projectSecondaryColorPickerContainer">
                        <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('secondary', '#5E81F4')" title="Blue"></div>
                        <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('secondary', '#FF7AC6')" title="Pink"></div>
                        <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('secondary', '#7CE7AC')" title="Green"></div>
                        <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('secondary', '#FFB800')" title="Orange"></div>
                        <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('secondary', '#9B51E0')" title="Purple"></div>
                        <input type="color" id="projectSecondaryColorPicker" oninput="customProjectColorSelected('secondary', this.value)" aria-label="Custom Project Secondary Color">
                    </div>
                    <label>Project Accent Color Override:</label>
                    <div class="color-picker" id="projectAccentColorPickerContainer">
                        <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('accent', '#FFB800')" title="Orange"></div>
                        <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('accent', '#FF7AC6')" title="Pink"></div>
                        <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('accent', '#7CE7AC')" title="Green"></div>
                        <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('accent', '#5E81F4')" title="Blue"></div>
                        <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('accent', '#9B51E0')" title="Purple"></div>
                        <input type="color" id="projectAccentColorPicker" oninput="customProjectColorSelected('accent', this.value)" aria-label="Custom Project Accent Color">
                    </div>
                    <h5 style="margin-top: 30px;">Font & Size Override</h5>
                    <label>Font Family Override:</label>
                    <div class="font-selector" id="projectFontSelector">
                        <div class="font-option" onclick="selectProjectStyle('fontFamily', null)" >Use Course Default</div>
                        <div class="font-option" data-font="Segoe UI" onclick="selectProjectStyle('fontFamily', `'Segoe UI', sans-serif`)">Segoe UI</div>
                        <div class="font-option" data-font="Arial" onclick="selectProjectStyle('fontFamily', `'Arial', Helvetica, sans-serif`)">Arial</div>
                        <div class="font-option" data-font="Georgia" onclick="selectProjectStyle('fontFamily', `'Georgia', 'Times New Roman', serif`)">Georgia</div>
                        <div class="font-option" data-font="Courier New" onclick="selectProjectStyle('fontFamily', `'Courier New', monospace`)">Courier New</div>
                        <div class="font-option" data-font="Verdana" onclick="selectProjectStyle('fontFamily', `'Verdana', Geneva, sans-serif`)">Verdana</div>
                        <div class="font-option" data-font="Comic Sans MS" onclick="selectProjectStyle('fontFamily', `'Comic Sans MS', cursive, sans-serif`)">Comic Sans</div>
                    </div>
                    <label>Base Text Size Override:</label>
                    <div class="size-selector" id="projectSizeSelector">
                         <div class="size-option" onclick="selectProjectStyle('baseSize', null)">Use Course Default</div>
                        <div class="size-option" onclick="selectProjectStyle('baseSize', 'small')">Small (14px)</div>
                        <div class="size-option" onclick="selectProjectStyle('baseSize', 'medium')">Medium (16px)</div>
                        <div class="size-option" onclick="selectProjectStyle('baseSize', 'large')">Large (18px)</div>
                    </div>
                </section>

                <div class="modal-actions">
                    <button type="button" onclick="closeModal('projectEditModal')">Cancel</button>
                    <button type="submit">Save Project</button>
                </div>
            </form>
        </div>
    </div>

<script>

// --- Global Data Storage ---
let courseData = {
    title: "Micro:bit Level 1",
    description: "Explore the exciting world of physical computing with the BBC micro:bit!\nThis course contains several projects designed to introduce you to coding concepts and hardware interaction in a fun, hands-on way.",
    imageUrl: "https://static.wixstatic.com/media/ecb02e_d86006f33f6c4a448e2c1ec1517c2690~mv2.png",
    courseMultimedia: {
        type: 'video', url: 'https://video.wixstatic.com/video/ecb02e_618c362136c24e12886ac4ef43b86562/720p/mp4/file.mp4', title: 'Introduction to Microbit', minimized: false,
    },
    style: {
        primaryColor: '#5E81F4',
        secondaryColor: '#FF7AC6',
        accentColor: '#FFB800',
        fontFamily: `'Segoe UI', sans-serif`,
        baseSize: 'medium'
    },
    projects: [
        {
            id: 'proj_catch_and_win', tabName: "8. Catch and Win", tabImage: "https://static.wixstatic.com/media/ecb02e_da4d01ce625b4cc0a0f79b7e553f50f9~mv2.gif", projectTitle: "Catch and Win Game", projectSubtitle: "Make your Own game with Microbit", projectHeaderImage: "https://static.wixstatic.com/media/ecb02e_0d14c8f0fcc740b49dd9dee5dddf4802~mv2.gif",
            overviewText: "Turn your Micro:bit into a fun arcade-style game!\nControl a paddle at the bottom of the screen using the A and B buttons to catch falling objects.\nEvery successful catch earns you points, but miss too many, and it’s game over!",
            videoIntroText: "This shows how the final game works. Try to build it!", videoTitle: "Catch and Win Game Play", videoUrl: "https://video.wixstatic.com/video/ecb02e_6cd237055ba94d3aa4c314361c4a6619/720p/mp4/file.mp4",
            videoKeyPoints: [ "Player sprite controlled with Button A (left) / B (right).", "Falling objects spawn randomly at y=0.", "Collision at player's (x,4).", "Use plot/unplot for sprites.", "'forever' block for game loop.", "'pause (ms)' controls speed.", "Variables track score, player_x, misses.", "Game ends after set misses.", "'show number' displays final score." ],
            learnData: [
                { title: "Micro:bit LEDs", description: "Understand the 5x5 LED grid.", mediaType: 'image', mediaUrl: 'https://os.mbed.com/docs/mbed-os/v6.16/apis/assets/images/Glossary_MB_LEDMatrix.png' },
                { title: "'Forever' Loop", description: "Learn how 'forever' runs code continuously.", mediaType: 'none', mediaUrl: '' },
                { title: "Displaying Images", description: "Explore 'show leds' and 'show icon'.", mediaType: 'image', mediaUrl: 'https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif' },
                { title: "Timing with 'Pause'", description: "Use 'pause (ms)' to control speed.", mediaType: 'none', mediaUrl: '' },
                { title: "Sequencing", description: "Code order determines animation sequence.", mediaType: 'none', mediaUrl: '' }
            ],
             // MODIFICATION START: Using 'iframe' type based on earlier preference
             slidesData: [
                 { description: "1. Game Building Blocks: Explore MakeCode for player controls, falling objects, and LED plotting for sprite animation.", url: "https://view.genially.com/67985dd4b5a925bc9a375172", type: "iframe" },
                 { description: "2. What's a Sprite?: Learn about movable characters (player, objects) on the Micro:bit grid using plot/unplot.", url: "https://view.genially.com/67ebbba7d41a27cc8ddc2218", type: "iframe" },
                 { description: "3. Try 'Snap the Dot': Practice game concepts with this simple reaction game.", url: "https://view.genially.com/67ebba390c63eea3efd8a34f", type: "iframe" },
                 { description: "4. 'Snap the Dot' Explained: Press Button A when the random LED lights up.", url: "https://view.genially.com/67de49ded67908621a726b03", type: "iframe" },
                 { description: "5. Try 'Catch and Win': Play the full game example.", url: "https://video.wixstatic.com/video/ecb02e_6cd237055ba94d3aa4c314361c4a6619/720p/mp4/file.mp4", type: "iframe" }, // Video treated as iframe
                 { description: "6. Build 'Catch and Win': Step-by-step tutorial to create the game yourself!", url: "https://view.genially.com/67de49e4ab31ac746b27c48b", type: "iframe" },
            ],
            // MODIFICATION END
            challengesData: [
                { title: "Speed Control", description: "Change 'pause (ms)' values (e.g., 1000, 100). How does it affect the game?", mediaType: 'none', mediaUrl: '' },
                { title: "Different Icon", description: "Use 'show icon' instead of 'show leds'. Try Heart/SmallHeart.", mediaType: 'none', mediaUrl: '' },
                { title: "Your Own Animation", description: "Create a new two-frame animation (e.g., blinking eye).", mediaType: 'image', mediaUrl: 'https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png' },
            ],
            quizData: [
                { questionText: "Which block makes code run over and over?", correctAnswer: "'forever'", incorrectAnswers: ["'on start'", "'pause (ms)'", "'show icon'"], correctAnswerImageUrl: null, incorrectAnswersImageUrls: [null, null, null] },
                { questionText: "How many LEDs in the Micro:bit display grid?", correctAnswer: "25 (5x5)", incorrectAnswers: ["10 (2x5)", "5 (1x5)", "50 (5x10)"], correctAnswerImageUrl: "https://teach.microbit.org/images/microbit-led-display.png", incorrectAnswersImageUrls: [null, null, null] },
                { questionText: "What unit does 'pause (ms)' use?", correctAnswer: "Milliseconds", incorrectAnswers: ["Seconds", "Minutes", "Microseconds"], correctAnswerImageUrl: null, incorrectAnswersImageUrls: [null, null, null] },
                { questionText: "To animate, show image, then _______, then show another.", correctAnswer: "Pause", incorrectAnswers: ["Stop", "Repeat", "Shake"], correctAnswerImageUrl: null, incorrectAnswersImageUrls: [null, null, null] }
            ],
            style: { fontFamily: null, baseSize: null, primaryColor: '#E63946', secondaryColor: '#F1FAEE', accentColor: '#A8DADC' },
            isCompleted: false
        }
    ]
};

// State variables
let currentProjectId = null;
let currentProjectDataCache = null;
let currentlyPlayingVideoIframe = null;
let currentlyActiveProjectTabId = 'overview';

// Constants
const MAX_PROJECTS = 25; // Changed to 25
const MAX_SLIDES = 20;
const MAX_CHALLENGES = 10;
const MAX_LEARN_ITEMS = 8;
const MAX_QUIZ_QUESTIONS = 20;
const MAX_INCORRECT_ANSWERS = 3;

// --- THEME APPLICATION ---
function hexToRgb(hex) { let r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return r ? { r: parseInt(r[1], 16), g: parseInt(r[2], 16), b: parseInt(r[3], 16) } : null; }
function applyThemeColors(p, s, a) { const rt = document.documentElement; rt.style.setProperty('--primary', p || '#5E81F4'); rt.style.setProperty('--secondary', s || '#FF7AC6'); rt.style.setProperty('--accent', a || '#FFB800'); const pr = hexToRgb(p || '#5E81F4'); if (pr) rt.style.setProperty('--primary-rgb', `${pr.r},${pr.g},${pr.b}`); const sr = hexToRgb(s || '#FF7AC6'); if (sr) rt.style.setProperty('--secondary-rgb', `${sr.r},${sr.g},${sr.b}`); }

function applyCourseTheme() {
    const cs = courseData.style || {};
    applyThemeColors(cs.primaryColor, cs.secondaryColor, cs.accentColor);
    const rt=document.documentElement;
    rt.style.setProperty('--base-font-family', cs.fontFamily || `'Segoe UI', sans-serif`);
    let fontSize = '16px';
    if (cs.baseSize === 'small') fontSize = '14px';
    else if (cs.baseSize === 'large') fontSize = '18px';
    rt.style.setProperty('--base-font-size', fontSize);
    const pv = document.getElementById('project-view');
    if(pv){pv.style.fontFamily=''; pv.style.fontSize='';}
}

function applyProjectSpecificStyles(p) {
    if (!p) return;
    const ps = p.style || {};
    const cs = courseData.style || {};
    applyThemeColors(ps.primaryColor || cs.primaryColor, ps.secondaryColor || cs.secondaryColor, ps.accentColor || cs.accentColor);
    const pv = document.getElementById('project-view');
    if (pv) {
        pv.style.fontFamily = ps.fontFamily ? ps.fontFamily : '';
        let effectiveFontSize = '';
        if (ps.baseSize === 'small') effectiveFontSize = '14px';
        else if (ps.baseSize === 'large') effectiveFontSize = '18px';
        else if (ps.baseSize === 'medium') effectiveFontSize = '16px';
        pv.style.fontSize = effectiveFontSize;
    }
}

// --- VIEW NAVIGATION ---
function showCourseView() {
    pauseCurrentlyPlayingVideo();
    document.getElementById('course-view').style.display = 'block';
    document.getElementById('project-view').style.display = 'none';
    currentProjectId = null;
    currentProjectDataCache = null;
    currentlyActiveProjectTabId = 'overview';
    document.title = courseData.title || "Course Viewer";
    applyCourseTheme();
    renderCoursePage();
    window.scrollTo(0, 0);
}
function showProjectView(pid) {
    const ci = document.querySelector('#course-multimedia-section iframe');
    if (ci && ci.src) pauseVideoIframe(ci);
    const p = courseData.projects.find(proj => proj.id === pid);
    if (!p) {
        console.error(`Project ${pid} not found!`);
        showCourseView();
        return;
    }
    currentProjectId = pid;
    currentlyActiveProjectTabId = 'overview';
    renderProjectPage(p);
    document.getElementById('course-view').style.display = 'none';
    document.getElementById('project-view').style.display = 'block';
    document.title = p.projectTitle || "Project Viewer";
    applyCourseTheme();
    applyProjectSpecificStyles(p);
    window.scrollTo(0, 0);
    try { history.pushState({ projectId: pid }, p.projectTitle || '', `#project-${pid}`); }
    catch (e) { console.warn("History API error."); }
}
window.onpopstate = function(e) { pauseCurrentlyPlayingVideo(); if (e.state && e.state.projectId) { showProjectView(e.state.projectId); } else { showCourseView(); } };

// --- VIDEO HANDLING ---
function pauseVideoIframe(ifr) { if (!ifr) return; const oSrc = ifr.getAttribute('data-original-src') || ifr.src; if (oSrc && oSrc !== 'about:blank' && oSrc !== '') { if (!ifr.hasAttribute('data-original-src')) ifr.setAttribute('data-original-src', oSrc); ifr.src = 'about:blank'; } if (currentlyPlayingVideoIframe === ifr) currentlyPlayingVideoIframe = null; }
function resumeVideoIframe(ifr) { if (!ifr) return; const oSrc = ifr.getAttribute('data-original-src'); if (oSrc) { ifr.src = getUrlWithNoAutoplay(oSrc); currentlyPlayingVideoIframe = ifr; } }
function pauseCurrentlyPlayingVideo() { if (currentlyPlayingVideoIframe) pauseVideoIframe(currentlyPlayingVideoIframe); }
function getUrlWithNoAutoplay(u) { if (!u || u === 'about:blank') return u; let fu = u; try { let o = new URL(u); if (u.includes('youtube.com')||u.includes('youtu.be')) o.searchParams.set('autoplay','0'); else if (u.includes('player.vimeo.com')) o.searchParams.set('autoplay','0'); else if (u.includes('wistia.com')) { o.searchParams.set('autoplay','false'); o.searchParams.set('playerPreference','false'); } else { o.searchParams.set('autoplay','false'); o.searchParams.set('autoplay','0'); } fu = o.toString(); } catch(e){} return fu; }

// --- COURSE PAGE RENDERING ---
function renderCoursePage() { const c = courseData; document.getElementById('courseTitle').textContent = c.title; const ci = document.getElementById('courseImage'); if (ci) { ci.src = c.imageUrl || ''; ci.alt = c.title + " Image"; ci.onerror = function() { console.error('Failed to load course image:', this.src); this.src='https://via.placeholder.com/150/eee/999?text=Err'; }; } document.getElementById('courseDescription').textContent = c.description; renderCourseMultimedia(); const g = document.getElementById('projectGrid'); g.innerHTML = ''; if (!c.projects || c.projects.length === 0) { g.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No projects added.</p>'; return; } c.projects.forEach(p => { if (!p || !p.id) return; const t = document.createElement('a'); t.className = 'project-tab'; t.href = `#project-${p.id}`; t.setAttribute('onclick', `event.preventDefault(); showProjectView('${p.id}');`); const i = document.createElement('img'); i.src = p.tabImage || 'https://via.placeholder.com/300x200/eee/999?text=Project'; i.alt = p.tabName || 'Project Tab'; i.loading = 'lazy'; i.onerror = function() { console.error('Failed to load project tab image:', this.src); this.src='https://via.placeholder.com/300x200/eee/999?text=Load+Error'; }; const d = document.createElement('div'); d.className = 'project-tab-info'; const s = document.createElement('span'); s.textContent = p.tabName || 'Unnamed Project'; d.appendChild(s); t.appendChild(i); t.appendChild(d); if (p.isCompleted) { const k = document.createElement('span'); k.className = 'completion-tick'; k.innerHTML = '✔'; k.setAttribute('aria-label', 'Completed'); k.title = 'Completed'; t.appendChild(k); } g.appendChild(t); }); }

// --- Course Multimedia Rendering & Toggling ---
function renderCourseMultimedia() {
    const s = document.getElementById('course-multimedia-section');
    const d = document.getElementById('course-multimedia-content');
    const b = document.getElementById('toggle-multimedia-btn');
    const m = courseData.courseMultimedia || { type: 'none', url: '', title: '', minimized: false };

    if (!s || !d || !b) { if (s) s.style.display = 'none'; return; }
    d.innerHTML = ''; s.classList.remove('multimedia-minimized');
    if (m.type === 'none' || !m.url) { s.style.display = 'none'; return; }
    s.style.display = 'block';
    const u = m.url.trim(), t = m.title?.trim() || 'Course Multimedia';
    let me = null;
    if (m.type === 'image') {
        const i = document.createElement('img'); i.src = u; i.alt = t; i.loading = 'lazy'; i.onerror = function() { console.error('Failed to load course multimedia image:', this.src); this.alt = 'Image Load Error'; }; me = i;
    } else { // Treat video, presentation, iframe all as iframes here
        const w = document.createElement('div'); w.className = 'media-wrapper-16-9';
        const ifr = document.createElement('iframe'); ifr.setAttribute('data-original-src', u); ifr.src = getUrlWithNoAutoplay(u); ifr.title = t; ifr.frameBorder = "0"; ifr.loading = 'lazy';
        ifr.allow = "fullscreen; picture-in-picture; accelerometer; clipboard-write; encrypted-media; gyroscope;"; // Standard allow list
        ifr.allowFullscreen = true;
        ifr.sandbox="allow-scripts allow-same-origin allow-presentation allow-popups allow-forms"; // Simpler sandbox + popups/forms
        w.appendChild(ifr); me = w;
    }
    if (me) d.appendChild(me); else d.innerHTML = '<p>Unsupported multimedia type.</p>';
    if (m.minimized) {
        s.classList.add('multimedia-minimized'); b.innerHTML = '+'; b.title = 'Maximize Course Intro'; b.setAttribute('aria-label', 'Maximize Course Intro');
        const ifr = d.querySelector('iframe'); if(ifr) pauseVideoIframe(ifr);
    } else {
        s.classList.remove('multimedia-minimized'); b.innerHTML = '—'; b.title = 'Minimize Course Intro'; b.setAttribute('aria-label', 'Minimize Course Intro');
    }
}
function toggleCourseMultimedia() {
    const s = document.getElementById('course-multimedia-section'), b = document.getElementById('toggle-multimedia-btn'), d = document.getElementById('course-multimedia-content'), ifr = d?.querySelector('iframe');
    if (!s || !b || !courseData.courseMultimedia) return;
    const isCurrentlyMinimized = s.classList.contains('multimedia-minimized'), shouldBeMinimized = !isCurrentlyMinimized;
    courseData.courseMultimedia.minimized = shouldBeMinimized; s.classList.toggle('multimedia-minimized', shouldBeMinimized);
    if (shouldBeMinimized) {
        b.innerHTML = '+'; b.title = 'Maximize Course Intro'; b.setAttribute('aria-label', 'Maximize Course Intro'); if (ifr) pauseVideoIframe(ifr);
    } else {
        b.innerHTML = '—'; b.title = 'Minimize Course Intro'; b.setAttribute('aria-label', 'Minimize Course Intro');
        if (ifr && ifr.src === 'about:blank' && ifr.getAttribute('data-original-src')) resumeVideoIframe(ifr);
        else if (!ifr && courseData.courseMultimedia.url) renderCourseMultimedia();
        else if (ifr && ifr.src !== 'about:blank') currentlyPlayingVideoIframe = ifr;
    }
}

// --- Project Sidebar Toggle ---
function toggleProjectSidebar() {
    const layout = document.getElementById('projectLayout'), button = document.getElementById('toggleSidebarBtn');
    if (layout && button) {
        layout.classList.toggle('sidebar-collapsed');
        const isCollapsed = layout.classList.contains('sidebar-collapsed');
        button.innerHTML = isCollapsed ? '☰' : '❮'; button.title = isCollapsed ? 'Expand Sidebar' : 'Collapse Sidebar'; button.setAttribute('aria-label', isCollapsed ? 'Expand Sidebar' : 'Collapse Sidebar');
    } else { console.error("Could not find project layout or sidebar toggle button."); }
}

// --- PROJECT PAGE RENDERING ---
function renderProjectPage(p) { if (!p) return; const pv = document.getElementById('project-view'); if (!pv) return; const pl = document.getElementById('projectLayout'), tb = document.getElementById('toggleSidebarBtn'); if (pl) pl.classList.remove('sidebar-collapsed'); if (tb) { tb.innerHTML = '❮'; tb.title = 'Collapse Sidebar'; tb.setAttribute('aria-label', 'Collapse Sidebar'); } const ph = pv.querySelector('#project-header'); if (ph) { ph.querySelector('#projectImage').src = p.projectHeaderImage || p.tabImage || ''; ph.querySelector('#projectImage').alt = p.projectTitle + " Hdr"; ph.querySelector('#projectImage').onerror = function() { console.error('Failed to load project header image:', this.src); this.src='https://via.placeholder.com/100/eee/999?text=Err'; }; ph.querySelector('#projectTitle').textContent = p.projectTitle || 'Project'; ph.querySelector('#projectSubtitle').textContent = p.projectSubtitle || ''; } const cc = pv.querySelector('#projectTabContentContainer'); if (!cc) return; const oc = cc.querySelector('#overview'); if (oc) { oc.querySelector('#overviewText').textContent = p.overviewText || ''; renderLearnItemsForProject(p.learnData || [], oc.querySelector('#learnContainer')); } const vc = cc.querySelector('#video'); if (vc) { const vi = vc.querySelector('#mainVideo'), kul = vc.querySelector('#videoKeyPoints'); vc.querySelector('#videoIntroText').textContent = p.videoIntroText || ''; vc.querySelector('#videoTitle').textContent = p.videoTitle || ''; if (vi) { const vu = p.videoUrl || ''; vi.setAttribute('data-original-src', vu); vi.src = getUrlWithNoAutoplay(vu); } if (kul) { kul.innerHTML = ''; if (p.videoKeyPoints && p.videoKeyPoints.length > 0) p.videoKeyPoints.forEach(pt => { if (pt && pt.trim()) kul.appendChild(document.createElement('li')).textContent = pt; }); if (kul.innerHTML === '') kul.innerHTML = '<li>No key points.</li>'; } } const sl = cc.querySelector('#slides'); if (sl) renderSlideshowForProject(p.slidesData || [], sl.querySelector('#slideshowContainer'), pv.querySelector('#projectTabs .tab[data-tab-id="slides"] .slide-sub-tabs')); const ch = cc.querySelector('#challenges'); if (ch) renderChallengesForProject(p.challengesData || [], ch.querySelector('#challengesContainer')); const qz = cc.querySelector('#quiz'); if (qz) renderQuizForProject(p.quizData || [], qz.querySelector('#quizContainer'), qz.querySelector('#submitQuizBtn')); const ptb = pv.querySelector('#projectTabs'); if (ptb) { const fptb = ptb.querySelector('.tab[data-tab-id="overview"]'); if (fptb) openProjectTab('overview', fptb); else updateProjectProgressBar(''); ptb.querySelectorAll('.slide-sub-tabs').forEach(sub => sub.style.display = 'none'); } }

// --- Project Specific Content Rendering Helpers ---

// MODIFICATION START: Use updated renderMediaElement with adjusted attributes
function renderMediaElement(mType, mUrl, title) {
    if (!mUrl) return '';
    const url = mUrl.trim();
    if (!url) return '';
    const sTitle = title || 'Media';

    if (mType === 'image') {
        return `<img src="${url}" loading="lazy" alt="${sTitle}" onerror="console.error('Failed to load media image:', this.src); this.alt='Image Load Error';">`;
    }

    // Handle iframe type (used for video, presentation, etc.)
    if (mType === 'iframe' || mType === 'video' || mType === 'presentation') { // Handle all embed types as iframe
        const sUrl = getUrlWithNoAutoplay(url);

        // --- Use simpler sandbox BUT more comprehensive allow ---
        const sbAttrs = "allow-scripts allow-same-origin allow-presentation allow-popups allow-forms"; // Added popups/forms back just in case
        // Restore more common video-related permissions
        const alAttrs = "fullscreen; picture-in-picture; accelerometer; clipboard-write; encrypted-media; gyroscope;";

        console.log(`Rendering IFRAME (${mType}) for: ${sUrl}`); // Logging

        return `<iframe src="${sUrl}"
                        frameborder="0"
                        loading="lazy"
                        allowfullscreen
                        sandbox="${sbAttrs}"
                        allow="${alAttrs}"
                        title="${sTitle}"
                        data-original-src="${url}"></iframe>`;
    }

    console.warn("Unsupported media type in renderMediaElement:", mType, url);
    return `<p style="color: red; font-weight: bold;">Error: Unsupported media type '${mType}'</p>`;
}
// MODIFICATION END

function renderLearnItemsForProject(d, c) { if (!c) return; c.innerHTML = ''; const v = (d || []).filter(i => i.title && i.title.trim()); if (v.length === 0) { c.innerHTML = '<p>No objectives.</p>'; return; } v.forEach((i, x) => { const el = document.createElement('div'); el.className = 'step'; el.innerHTML = `<div class="step-number">${x + 1}</div><div class="step-content"><strong></strong>${i.description ? '<p class="description"></p>' : ''}<div class="step-media" style="display: none;"></div></div>`; el.querySelector('strong').textContent = i.title; if (i.description) el.querySelector('p.description').textContent = i.description; const m = el.querySelector('.step-media'), mh = renderMediaElement(i.mediaType, i.mediaUrl, i.title); if (mh) { m.innerHTML = mh; m.style.display = 'block'; } c.appendChild(el); }); }
function renderChallengesForProject(d, c) { if (!c) return; c.innerHTML = ''; const v = (d || []).filter(i => i.title && i.title.trim()); if (v.length === 0) { c.innerHTML = '<p>No challenges.</p>'; return; } v.forEach((i) => { const el = document.createElement('div'); el.className = 'step'; el.innerHTML = `<div class="step-number">★</div><div class="step-content"><strong></strong>${i.description ? '<p class="description"></p>' : ''}<div class="step-media" style="display:none;"></div></div>`; el.querySelector('strong').textContent = i.title; if (i.description) el.querySelector('p.description').textContent = i.description; const m = el.querySelector('.step-media'), mh = renderMediaElement(i.mediaType, i.mediaUrl, i.title); if (mh) { m.innerHTML = mh; m.style.display = 'block'; } c.appendChild(el); }); }
function renderSlideshowForProject(d, mainC, subC) { if (!mainC || !subC) { if(mainC) mainC.innerHTML='<p>Error loading slides.</p>'; return; } mainC.innerHTML = ''; subC.innerHTML = ''; const v = (d || []).filter(s => s.url && s.url.trim()); if (v.length === 0) { mainC.innerHTML = '<p>No slides.</p>'; subC.style.display = 'none'; return; } subC.style.display = 'flex';
      v.forEach((s, x) => {
        const id = `slide-${currentProjectId}-${x}`;
        // Use 'iframe' type for anything not 'image'
        const ct = (s.type === 'image') ? 'image' : 'iframe';
        const u = s.url.trim();
        const ds = s.description || '';
        const ti = ds || `Slide ${x + 1}`;

        const sub = document.createElement('a'); sub.className = 'sub-tab'; sub.textContent = `Step ${x + 1}`; sub.href = `#${id}`; sub.setAttribute('onclick', `event.preventDefault(); showSlideContent('${id}', this);`); sub.setAttribute('data-slide-index', x); sub.title = ds || `Step ${x + 1}`; subC.appendChild(sub);

        const scd = document.createElement('div'); scd.className = 'slide-content-container'; scd.id = id;
        let dHtml = ''; if (ds) { const p = document.createElement('p'); p.className = 'slide-description'; p.textContent = ds; dHtml = p.outerHTML; }
        scd.innerHTML = `${dHtml}<div class="slide-media-wrapper">${renderMediaElement(ct, u, ti)}</div>`;
        mainC.appendChild(scd);
    });
    if (mainC.children.length > 0 && !mainC.querySelector('.active')) {
        const firstSubTab = subC.querySelector('.sub-tab');
        if (firstSubTab) {
            const firstSlideIndex = firstSubTab.getAttribute('data-slide-index');
            const firstSlideId = `slide-${currentProjectId}-${firstSlideIndex}`;
            showSlideContent(firstSlideId, firstSubTab);
        }
    }
}

// MODIFICATION START: Add iframe reload logic to showSlideContent
function showSlideContent(sId, cSub) {
    const msc = document.getElementById('slideshowContainer');
    if (!msc) return;
    pauseCurrentlyPlayingVideo();

    // Hide all others and pause their iframes
    msc.querySelectorAll('.slide-content-container').forEach(c => {
        c.classList.remove('active');
        const ifr = c.querySelector('iframe');
        if (ifr) pauseVideoIframe(ifr); // Use pause logic which sets src to about:blank
    });

    const tsc = msc.querySelector(`#${sId}`); // Target slide container

    // --- Navigation styling ---
    const subCont = cSub?.closest('.slide-sub-tabs');
    if (subCont) subCont.querySelectorAll('.sub-tab').forEach(sub => sub.classList.remove('active'));
    if (cSub) {
        cSub.classList.add('active');
        cSub.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    }

    // --- Make target visible and attempt iframe reload ---
    if (tsc) {
        tsc.classList.add('active'); // Make the container visible

        // --- Try reloading iframe src after display ---
        const targetIframe = tsc.querySelector('iframe');
        if (targetIframe) {
            const originalSrc = targetIframe.getAttribute('data-original-src');
            console.log(`Target iframe found for ${sId}. Original src: ${originalSrc}`);

            // Add a very short delay before trying to set the src again
            setTimeout(() => {
                if (targetIframe && originalSrc && targetIframe.src !== originalSrc) {
                    console.log(`Reloading iframe src for ${sId} to: ${originalSrc}`);
                    targetIframe.src = getUrlWithNoAutoplay(originalSrc); // Use the non-autoplay version
                    currentlyPlayingVideoIframe = targetIframe; // Mark as potentially playing
                } else if (targetIframe && !originalSrc) {
                    console.warn(`Target iframe for ${sId} has no data-original-src attribute!`);
                } else if (targetIframe && targetIframe.src === originalSrc) {
                     console.log(`Iframe src for ${sId} already seems correct.`);
                     currentlyPlayingVideoIframe = targetIframe; // Still mark as potentially playing if src is good
                }
            }, 50); // 50ms delay, adjust if needed
        }
        // --- End of iframe reload logic ---
    }
}
// MODIFICATION END

function renderQuizForProject(d, c, b) { if (!c || !b) return; c.innerHTML = ''; c.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove(); b.disabled = false; b.style.display = 'none'; const v = (d || []).filter(q => q.questionText?.trim() && q.correctAnswer?.trim()); if (v.length === 0) { c.innerHTML = '<p>No quiz.</p>'; return; } b.style.display = 'block'; v.forEach((q, x) => { const qd = document.createElement('div'); qd.className = 'quiz-question'; qd.innerHTML = `<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>`; qd.querySelector('.question-text').textContent = `${x + 1}. ${q.questionText}`; const od = qd.querySelector('.quiz-options'); let os = [{ text: q.correctAnswer.trim(), imageUrl: q.correctAnswerImageUrl?.trim() || null, isCorrect: true }]; (q.incorrectAnswers || []).forEach((aT, i) => { const t = aT?.trim(); if (t) os.push({ text: t, imageUrl: (q.incorrectAnswersImageUrls && q.incorrectAnswersImageUrls[i]?.trim()) ? q.incorrectAnswersImageUrls[i].trim() : null, isCorrect: false }); }); shuffleArray(os); os.forEach((oD) => { const oe = document.createElement('div'); oe.className = 'quiz-option'; oe.setAttribute('role', 'button'); oe.setAttribute('tabindex', '0'); oe.onclick = () => selectQuizOption(oe); oe.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(oe); } }; oe.setAttribute('data-is-correct', oD.isCorrect.toString()); if (oD.imageUrl) { const g = document.createElement('img'); g.src = oD.imageUrl; g.alt = `Option for ${oD.text}`; g.className = 'option-image'; g.loading = 'lazy'; g.onerror = function() { console.error('Failed to load quiz option image:', this.src); this.alt = 'Img Err'; this.style.display='none'; }; oe.appendChild(g); } const ts = document.createElement('span'); ts.className = 'option-text'; ts.textContent = oD.text; oe.appendChild(ts); od.appendChild(oe); }); c.appendChild(qd); }); }

// --- Project Interaction ---
function openProjectTab(tid, el) { pauseCurrentlyPlayingVideo(); currentlyActiveProjectTabId = tid; const c = document.getElementById('projectTabContentContainer'); if (!c) return; c.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active')); const bs = document.getElementById('projectTabs'); if (bs) { bs.querySelectorAll('.tab').forEach(b => b.classList.remove('active')); bs.querySelectorAll('.slide-sub-tabs').forEach(sub => sub.style.display = 'none'); } const t = c.querySelector('#' + tid); if (t) t.classList.add('active'); if (el) el.classList.add('active'); if (tid === 'slides' && el) { const subCont = el.querySelector('.slide-sub-tabs'); if (subCont) { subCont.style.display = 'flex';
        const msc = document.getElementById('slideshowContainer'); const currentActiveSlide = msc?.querySelector('.slide-content-container.active'); let targetSubTab = null;
        if(currentActiveSlide) { const activeIndex = Array.from(msc.children).indexOf(currentActiveSlide); if(activeIndex !== -1) targetSubTab = subCont.querySelector(`.sub-tab[data-slide-index="${activeIndex}"]`); }
        if (!targetSubTab) targetSubTab = subCont.querySelector('.sub-tab');
        if (targetSubTab) { const targetIndex = targetSubTab.getAttribute('data-slide-index'); const targetSlideId = `slide-${currentProjectId}-${targetIndex}`; showSlideContent(targetSlideId, targetSubTab); } else if(msc) msc.innerHTML = '<p>Error loading slide navigation.</p>';
    } } if (tid === 'video') { const vIfr = document.querySelector('#video #mainVideo'); if(vIfr && vIfr.src === 'about:blank') resumeVideoIframe(vIfr); else if (vIfr) currentlyPlayingVideoIframe = vIfr; } updateProjectProgressBar(tid); }
function updateProjectProgressBar(tn) { const p = document.getElementById('progressBar'); if (!p) return; let r = 0; const o = ['overview', 'video', 'slides', 'challenges', 'quiz']; const i = o.indexOf(tn); if (i >= 0) r = ((i + 1) / o.length) * 100; p.style.width = r + '%'; }
function selectQuizOption(oe) { const qd = oe.closest('.quiz-question'); if (!qd || qd.classList.contains('answered')) return; qd.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected')); oe.classList.add('selected'); }
function submitQuiz() { const qs = document.querySelectorAll('#project-view #quizContainer .quiz-question'); let ac = 0, sc = 0; const tq = qs.length; if (tq === 0) return; let fu = null; qs.forEach((q) => { const s = q.querySelector('.quiz-option.selected'); q.classList.remove('answered'); q.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none'); q.querySelectorAll('.quiz-option').forEach(opt => { opt.classList.remove('correct', 'incorrect'); opt.style.opacity = '1'; opt.style.cursor = 'pointer'; opt.onclick = () => selectQuizOption(opt); opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); } }; }); q.style.outline = ''; if (s) ac++; else if (!fu) fu = q; }); if (ac < tq) { alert(`Answer all ${tq} questions!`); if (fu) { fu.scrollIntoView({ behavior: 'smooth', block: 'center' }); fu.style.outline = '2px solid var(--danger)'; setTimeout(() => { if (fu) fu.style.outline = ''; }, 2500); } return; } qs.forEach((q) => { const s = q.querySelector('.quiz-option.selected'), fc = q.querySelector('.quiz-feedback.correct'), fi = q.querySelector('.quiz-feedback.incorrect'), ao = q.querySelectorAll('.quiz-option'); q.classList.add('answered'); const isc = s.getAttribute('data-is-correct') === 'true'; ao.forEach(opt => { const oic = opt.getAttribute('data-is-correct') === 'true'; if (oic) opt.classList.add('correct'); if (opt === s && !isc) opt.classList.add('incorrect'); if (opt !== s && !oic) opt.style.opacity = "0.6"; if (opt === s && isc) opt.style.opacity = "1"; if (oic && opt !== s) opt.style.opacity = "1"; opt.style.cursor = "default"; opt.onclick = null; opt.onkeydown = null; }); if (isc) { sc++; if (fc) fc.style.display = 'block'; } else { if (fi) { const co = q.querySelector('.quiz-option.correct'), cts = co?.querySelector('span.option-text'); fi.textContent = `Not quite. Correct: "${cts ? cts.textContent : (co ? co.textContent : 'N/A')}".`; fi.style.display = 'block'; } } }); const sb = document.querySelector('#project-view #submitQuizBtn'); if (sb) sb.disabled = true; const qtc = document.querySelector('#project-view #quiz'); let rd = qtc?.querySelector('.final-quiz-result'); if (!rd && qtc) { rd = document.createElement('div'); qtc.appendChild(rd); } if (rd) { const sp = tq > 0 ? Math.round((sc / tq) * 100) : 0; const p = sp >= 70; rd.textContent = `Quiz Complete! Score: ${sc}/${tq} (${sp}%).`; rd.className = 'final-quiz-result ' + (p ? 'success' : 'fail'); rd.style.display = 'block'; rd.scrollIntoView({ behavior: 'smooth', block: 'center' }); if (p && currentProjectId) markProjectAsCompleted(currentProjectId); } }
function markProjectAsCompleted(pid) { const p = courseData.projects.find(pr => pr.id === pid); if (p && !p.isCompleted) { p.isCompleted = true; const ctvt = document.querySelector(`#course-view #projectGrid .project-tab[href='#project-${pid}']`); if (ctvt && !ctvt.querySelector('.completion-tick')) { const tk = document.createElement('span'); tk.className = 'completion-tick'; tk.innerHTML = '✔'; tk.setAttribute('aria-label', 'Completed'); tk.title = 'Completed'; ctvt.appendChild(tk); } } }
function checkProjectCompletionStatus() { /* Placeholder */ }

// --- MODAL & EDITING LOGIC ---
function closeModal(mId) { const m = document.getElementById(mId); if (m) m.style.display = 'none'; if (mId === 'projectEditModal' && currentProjectDataCache?.id && currentProjectId === currentProjectDataCache.id && document.getElementById('project-view').style.display !== 'none') { const op = courseData.projects.find(p => p.id === currentProjectId); if (op) applyProjectSpecificStyles(op); } else if (mId === 'projectEditModal') { applyCourseTheme(); } currentProjectDataCache = null; }
function openCourseEditModal() { const m = document.getElementById('courseEditModal'); if (!m) return; m.querySelector('#editCourseTitle').value = courseData.title || ''; m.querySelector('#editCourseImage').value = courseData.imageUrl || ''; m.querySelector('#editCourseDescription').value = courseData.description || ''; const md = courseData.courseMultimedia || { type: 'none', url: '', title: '' }, mts = m.querySelector('#editCourseMultimediaType'), mui = m.querySelector('#editCourseMultimediaUrl'), mti = m.querySelector('#editCourseMultimediaTitle'); if (mts) mts.value = md.type; if (mui) mui.value = md.url || ''; if (mti) mti.value = md.title || ''; toggleCourseMultimediaEditorFields(md.type); renderProjectTabsEditor(); loadCourseColorSelections(); loadCourseStyleSelections();
    m.style.display = 'block'; }
function toggleCourseMultimediaEditorFields(st) { const fc = document.getElementById('courseMultimediaEditorFieldsContainer'), ui = document.getElementById('editCourseMultimediaUrl'); if (!fc || !ui) return; if (st === 'none') { fc.style.display = 'none'; ui.required = false; } else { fc.style.display = 'block'; ui.required = true; ui.placeholder = (st === 'image') ? 'Image URL...' : 'Embed URL...'; } }
function renderProjectTabsEditor() { const lc = document.getElementById('projectTabsList'); if (!lc) return; lc.innerHTML = ''; (courseData.projects || []).forEach((p, i) => { if (!p || !p.id) return; const idv = document.createElement('div'); idv.className = 'project-tab-edit-item'; idv.setAttribute('data-project-id', p.id); idv.innerHTML = `<span class="index">${i + 1}</span><div class="inputs"><label for="tab-name-${p.id}">Tab Name:</label><input type="text" id="tab-name-${p.id}" class="edit-tab-name" value="${p.tabName || ''}" required><label for="tab-image-${p.id}">Tab Image URL:</label><input type="url" id="tab-image-${p.id}" class="edit-tab-image" value="${p.tabImage || ''}" placeholder="https://..."></div><button type="button" class="remove-item-btn" onclick="removeProjectTab('${p.id}', this)" title="Remove project">&times;</button>`; lc.appendChild(idv); }); if (!courseData.projects || courseData.projects.length === 0) lc.innerHTML = '<p>No projects.</p>'; }
function addProjectTabEditField() { if ((courseData.projects || []).length >= MAX_PROJECTS) { alert(`Max ${MAX_PROJECTS} projects.`); return; } const npi = (courseData.projects?.length || 0) + 1, npid = `proj_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; const np = { id: npid, tabName: `New ${npi}`, tabImage: "", projectTitle: `New ${npi} Title`, projectSubtitle: "", projectHeaderImage: "", overviewText: "", videoIntroText: "", videoTitle: "", videoUrl: "", videoKeyPoints: [], learnData: [], slidesData: [], challengesData: [], quizData: [], style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null }, isCompleted: false }; if (!courseData.projects) courseData.projects = []; courseData.projects.push(np); renderProjectTabsEditor(); const lc = document.getElementById('projectTabsList'), nel = lc?.querySelector(`[data-project-id="${npid}"]`); nel?.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); nel?.querySelector('input')?.focus(); }
function removeProjectTab(pid, btn) { const pidx = courseData.projects.findIndex(p => p.id === pid); if (pidx === -1) return; const pn = courseData.projects[pidx]?.tabName || pid; if (!confirm(`⚠️ Remove project "${pn}"? Cannot be undone.`)) return; courseData.projects.splice(pidx, 1); renderProjectTabsEditor(); renderCoursePage(); if (currentProjectId === pid) showCourseView(); }

// Course Style Selection (Color, Font, Size)
function selectCourseColor(t, c) { if (!courseData.style) courseData.style = {}; courseData.style[t + 'Color'] = c; applyCourseTheme(); const piId = `course${t.charAt(0).toUpperCase() + t.slice(1)}ColorPicker`, pi = document.getElementById(piId), pc = pi?.closest('.color-picker'); if (pi) pi.value = c; if (pc) pc.querySelectorAll('.color-option').forEach(o => o.classList.toggle('selected', areColorsEqual(o.style.backgroundColor, c))); }
function customCourseColorSelected(t, c) { selectCourseColor(t, c); const piId = `course${t.charAt(0).toUpperCase() + t.slice(1)}ColorPicker`, pc = document.getElementById(piId)?.closest('.color-picker'); pc?.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected')); }
function loadCourseColorSelections() { const cs = courseData.style || {}; selectCourseColor('primary', cs.primaryColor || '#5E81F4'); selectCourseColor('secondary', cs.secondaryColor || '#FF7AC6'); selectCourseColor('accent', cs.accentColor || '#FFB800'); }
function selectCourseStyle(prop, val) { if (!courseData.style) courseData.style = {}; courseData.style[prop] = val; applyCourseTheme(); loadCourseStyleSelections(); }
function loadCourseStyleSelections() { const cs = courseData.style || {}; const ff = cs.fontFamily || `'Segoe UI', sans-serif`; const fsCont = document.getElementById('courseFontSelector'); if (fsCont) fsCont.querySelectorAll('.font-option').forEach(o => { const fVal = o.getAttribute('onclick').match(/selectCourseStyle\('fontFamily',\s*'(.*?)'\)/)?.[1]; o.classList.toggle('selected', fVal === ff); }); const bs = cs.baseSize || 'medium'; const szCont = document.getElementById('courseSizeSelector'); if (szCont) szCont.querySelectorAll('.size-option').forEach(o => { const sVal = o.getAttribute('onclick').match(/selectCourseStyle\('baseSize',\s*'(.*?)'\)/)?.[1]; o.classList.toggle('selected', sVal === bs); }); }
function saveCourseChanges() { const m = document.getElementById('courseEditModal'); if (!m) return; const mt = m.querySelector('#editCourseMultimediaType')?.value || 'none', mui = m.querySelector('#editCourseMultimediaUrl'), mu = mui?.value.trim(); let iv = true; if (mt !== 'none' && !mu) { alert(`URL required for multimedia type ${mt}.`); mui?.focus(); if(mui)mui.style.borderColor='red'; iv = false; } else if (mui) mui.style.borderColor = ''; if (!iv) return;
    courseData.title = document.getElementById('editCourseTitle')?.value.trim() || courseData.title; courseData.imageUrl = document.getElementById('editCourseImage')?.value.trim() || courseData.imageUrl; courseData.description = document.getElementById('editCourseDescription')?.value.trim() || courseData.description;
    if (!courseData.courseMultimedia) courseData.courseMultimedia = {}; courseData.courseMultimedia.type = mt; courseData.courseMultimedia.url = (mt !== 'none') ? mu : ''; courseData.courseMultimedia.title = (mt !== 'none') ? m.querySelector('#editCourseMultimediaTitle')?.value.trim() || '' : '';
    document.querySelectorAll('#projectTabsList .project-tab-edit-item').forEach(i => { const pid = i.getAttribute('data-project-id'), p = courseData.projects.find(pr => pr.id === pid); if (p) { p.tabName = i.querySelector('.edit-tab-name')?.value.trim() || p.tabName || 'Project'; p.tabImage = i.querySelector('.edit-tab-image')?.value.trim() || p.tabImage; } });
    applyCourseTheme(); renderCoursePage(); closeModal('courseEditModal');
}
function openProjectEditModal() { const m = document.getElementById('projectEditModal'); if (!m || !currentProjectId) { alert("Select project first."); return; } const pi = courseData.projects.findIndex(p => p.id === currentProjectId); if (pi === -1) { alert("Error: Project data not found."); return; } currentProjectDataCache = JSON.parse(JSON.stringify(courseData.projects[pi])); const p = currentProjectDataCache; m.querySelector('#editingProjectId').value = p.id; m.querySelector('#editingProjectNameLabel').textContent = p.projectTitle || p.tabName || 'Project'; m.querySelector('#editProject_Title').value = p.projectTitle || ''; m.querySelector('#editProject_Subtitle').value = p.projectSubtitle || ''; m.querySelector('#editProject_HeaderImage').value = p.projectHeaderImage || ''; m.querySelector('#editProject_TabName').value = p.tabName || ''; m.querySelector('#editProject_TabImage').value = p.tabImage || ''; m.querySelector('#editProject_OverviewText').value = p.overviewText || ''; m.querySelector('#editProject_VideoIntroText').value = p.videoIntroText || ''; m.querySelector('#editProject_VideoTitle').value = p.videoTitle || ''; m.querySelector('#editProject_VideoUrl').value = p.videoUrl || ''; m.querySelector('#editProject_VideoKeyPoints').value = (p.videoKeyPoints || []).join('\n'); loadLearnEditFieldsForProject(p.learnData || [], m.querySelector('#learnEditContainer')); loadSlidesEditFieldsForProject(p.slidesData || [], m.querySelector('#slidesEditContainer')); loadChallengesEditFieldsForProject(p.challengesData || [], m.querySelector('#challengesEditContainer')); loadQuizEditFieldsForProject(p.quizData || [], m.querySelector('#quizEditContainer')); loadProjectStyleSelections(p.style || {}); loadProjectColorSelections(p.style || {}); m.style.display = 'block'; document.getElementById('editSectionProject').value = 'projMeta'; showProjectEditSection(); }
function createEditItemGroup(i, pfx, gen, rem) { const ig = document.createElement('div'); ig.className = 'edit-item-group'; ig.innerHTML = gen(i); const rb = document.createElement('button'); rb.type = 'button'; rb.className = 'remove-item-btn'; rb.innerHTML = '&times;'; rb.title = `Remove ${pfx}`; rb.setAttribute('aria-label', `Remove ${pfx} ${i + 1}`); rb.onclick = () => rem(ig); ig.appendChild(rb); const ms = ig.querySelector('.media-type-select'); if (ms) handleMediaTypeChange(ms); return ig; }
function handleMediaTypeChange(s) { const uic = s.closest('.edit-item-group')?.querySelector('.media-url-input-container'), ui = uic?.querySelector('.media-url-input'); if (uic && ui) { const sh = (s.value !== 'none' && s.value !== ''); uic.style.display = sh ? 'block' : 'none'; ui.required = sh; ui.placeholder = (s.value === 'image') ? 'Image URL...' : 'Embed URL...'; } }
function loadLearnEditFieldsForProject(d, c) { if (!c) return; c.innerHTML = ''; const it = d || []; it.forEach((i, x) => { const p = 'learn', cnt = (idx) => `<label for="${p}-title-${idx}"><b>Item ${idx + 1} Title:</b></label><input type="text" id="${p}-title-${idx}" class="${p}-title" value="${i.title || ''}" required><label for="${p}-desc-${idx}">Description:</label><textarea id="${p}-desc-${idx}" class="${p}-desc" rows="2">${i.description || ''}</textarea><div class="media-controls"><label for="${p}-media-type-${idx}">Media:</label><select id="${p}-media-type-${idx}" class="media-type-select" onchange="handleMediaTypeChange(this)"><option value="none" ${!i.mediaType || i.mediaType === 'none' ? 'selected' : ''}>None</option><option value="image" ${i.mediaType === 'image' ? 'selected' : ''}>Image</option><option value="video" ${i.mediaType === 'video' ? 'selected' : ''}>Video Embed</option><option value="presentation" ${i.mediaType === 'presentation' ? 'selected' : ''}>Presentation Embed</option><option value="iframe" ${i.mediaType === 'iframe' ? 'selected' : ''}>Generic Iframe</option></select><div class="media-url-input-container" style="display: none;"><label for="${p}-media-url-${idx}" class="sr-only">URL:</label><input type="url" id="${p}-media-url-${idx}" class="media-url-input" value="${i.mediaUrl || ''}"></div></div>`; c.appendChild(createEditItemGroup(x, p, cnt, handleRemoveLearnItem)); }); if (it.length === 0) c.innerHTML = '<p>No items.</p>'; }

// MODIFICATION START: Change slide description input to textarea
function loadSlidesEditFieldsForProject(data, container) {
   if (!container) return; container.innerHTML = '';
   const items = data || [];
   items.forEach((slide, index) => {
       const prefix = 'slide';
       // Use the content generation logic from your old working function
       const content = (i) => `
           <label for="${prefix}-url-${i}"><b>Slide ${i + 1} URL (Image or Embed Link):</b></label>
           <input type="url" id="${prefix}-url-${i}" class="${prefix}-url" value="${slide.url || ''}" required placeholder="https://...">

           <label for="${prefix}-desc-${i}">Description (Optional Caption):</label>
           <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="3" placeholder="Brief description of the slide...">${slide.description || ''}</textarea>

           <label for="${prefix}-type-${i}">Content Type:</label>
           <select id="${prefix}-type-${i}" class="${prefix}-type">
               <option value="iframe" ${!slide.type || slide.type === 'iframe' ? 'selected' : ''}>Embed (Video/Presentation)</option>
               <option value="image" ${slide.type === 'image' ? 'selected' : ''}>Image</option>
           </select>`;
       container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveSlideItem));
   });
   if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No slides added.</p>';
}
// MODIFICATION END


function loadChallengesEditFieldsForProject(d, c) { if (!c) return; c.innerHTML = ''; const it = d || []; it.forEach((ch, x) => { const p = 'challenge', cnt = (idx) => `<label for="${p}-title-${idx}"><b>Ch ${idx + 1} Title:</b></label><input type="text" id="${p}-title-${idx}" class="${p}-title" value="${ch.title || ''}" required><label for="${p}-desc-${idx}">Desc:</label><textarea id="${p}-desc-${idx}" class="${p}-desc" rows="2">${ch.description || ''}</textarea><div class="media-controls"><label for="${p}-media-type-${idx}">Media:</label><select id="${p}-media-type-${idx}" class="media-type-select" onchange="handleMediaTypeChange(this)"><option value="none" ${!ch.mediaType || ch.mediaType === 'none' ? 'selected' : ''}>None</option><option value="image" ${ch.mediaType === 'image' ? 'selected' : ''}>Image</option><option value="video" ${ch.mediaType === 'video' ? 'selected' : ''}>Video Embed</option><option value="presentation" ${ch.mediaType === 'presentation' ? 'selected' : ''}>Presentation Embed</option><option value="iframe" ${ch.mediaType === 'iframe' ? 'selected' : ''}>Generic Iframe</option></select><div class="media-url-input-container" style="display: none;"><label for="${p}-media-url-${idx}" class="sr-only">URL:</label><input type="url" id="${p}-media-url-${idx}" class="media-url-input" value="${ch.mediaUrl || ''}"></div></div>`; c.appendChild(createEditItemGroup(x, p, cnt, handleRemoveChallengeItem)); }); if (it.length === 0) c.innerHTML = '<p>No challenges.</p>'; }
function loadQuizEditFieldsForProject(d, c) { if (!c) return; c.innerHTML = ''; const it = d || []; it.forEach((q, qIdx) => { const p = 'quiz'; let incHTML = ''; for (let i = 0; i < MAX_INCORRECT_ANSWERS; i++) { const txt = (q.incorrectAnswers && q.incorrectAnswers[i]) ? q.incorrectAnswers[i] : '', img = (q.incorrectAnswersImageUrls && q.incorrectAnswersImageUrls[i]) ? q.incorrectAnswersImageUrls[i] : ''; incHTML += `<div style="margin-left:15px;border-left:2px solid #eee;padding-left:15px;margin-top:10px;"><label for="${p}-incorrect-${qIdx}-${i}" class="incorrect-answer-label">Incorrect ${i + 1}:</label><input type="text" id="${p}-incorrect-${qIdx}-${i}" class="${p}-incorrect" value="${txt}" placeholder="Optional"><div class="quiz-answer-image-url"><label for="${p}-incorrect-img-${qIdx}-${i}">Img URL:</label><input type="url" id="${p}-incorrect-img-${qIdx}-${i}" class="${p}-incorrect-img" value="${img}" placeholder="https://..."></div></div>`; } const cnt = (idx) => `<label for="${p}-question-${idx}"><b>Q ${idx + 1}:</b></label><textarea id="${p}-question-${idx}" class="${p}-question" rows="2" required>${q.questionText || ''}</textarea><div style="margin-top:10px;border:1px solid #c3e6cb;border-radius:5px;padding:10px;background-color:#e6f7ed;"><label for="${p}-correct-${idx}" style="color:#1d6c45;font-weight:bold;">Correct:</label><input type="text" id="${p}-correct-${idx}" class="${p}-correct" value="${q.correctAnswer || ''}" required><div class="quiz-answer-image-url"><label for="${p}-correct-img-${idx}">Img URL:</label><input type="url" id="${p}-correct-img-${idx}" class="${p}-correct-img" value="${q.correctAnswerImageUrl || ''}" placeholder="https://..."></div></div>${incHTML}`; c.appendChild(createEditItemGroup(qIdx, p, cnt, handleRemoveQuizItem)); }); if (it.length === 0) c.innerHTML = '<p>No questions.</p>'; }
function loadProjectStyleSelections(psd) { const m=document.getElementById('projectEditModal'); if(!m)return; const s=psd||{}; const cf=s.fontFamily||null, fs=m.querySelector('#projectFontSelector'); if(fs)fs.querySelectorAll('.font-option').forEach(o=>{const at=o.getAttribute('onclick'), mc=at?.match(/selectProjectStyle\('fontFamily',\s*(null|(['"`])(.*?)\2)\)/); let ov=undefined; if(mc)ov=mc[1]==='null'?null:mc[3]; o.classList.toggle('selected', ov===cf);}); const csz=s.baseSize||null, szs=m.querySelector('#projectSizeSelector'); if(szs)szs.querySelectorAll('.size-option').forEach(o=>{const at=o.getAttribute('onclick'), mc=at?.match(/selectProjectStyle\('baseSize',\s*(null|'small'|'medium'|'large')\)/); const ov=mc?(mc[1]==='null'?null:mc[1]):undefined; o.classList.toggle('selected', ov===csz);}); }
function loadProjectColorSelections(psd) { const s=psd||{}; selectProjectColor('primary',s.primaryColor||null,false); selectProjectColor('secondary',s.secondaryColor||null,false); selectProjectColor('accent',s.accentColor||null,false); }
function selectProjectStyle(prop, val) { if (!currentProjectDataCache) return; if (!currentProjectDataCache.style) currentProjectDataCache.style = {}; currentProjectDataCache.style[prop] = val; loadProjectStyleSelections(currentProjectDataCache.style); if (document.getElementById('project-view').style.display !== 'none' && currentProjectDataCache.id === currentProjectId) applyProjectSpecificStyles(currentProjectDataCache); }
function selectProjectColor(t, c, live=true) { if (!currentProjectDataCache) return; if (!currentProjectDataCache.style) currentProjectDataCache.style = {}; currentProjectDataCache.style[t + 'Color'] = c; const piId = `project${t.charAt(0).toUpperCase() + t.slice(1)}ColorPicker`, pi = document.getElementById(piId), pc = document.getElementById(`${piId}Container`); if (pi) { const ec = c || courseData.style?.[t + 'Color'] || '#ffffff'; try { pi.value = ec; } catch(e){ pi.value = '#ffffff';} pi.classList.toggle('inherited-style', c === null); } if (pc) pc.querySelectorAll('.color-option').forEach(o => o.classList.toggle('selected', c !== null && areColorsEqual(o.style.backgroundColor, c))); if (live && document.getElementById('project-view').style.display !== 'none' && currentProjectDataCache.id === currentProjectId) applyProjectSpecificStyles(currentProjectDataCache); }
function customProjectColorSelected(t, c) { selectProjectColor(t, c, true); const pc = document.getElementById(`project${t.charAt(0).toUpperCase() + t.slice(1)}ColorPickerContainer`); pc?.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected')); }
function clearProjectColorOverrides() { if (!confirm("Reset project colors to course theme?")) return; selectProjectColor('primary', null, false); selectProjectColor('secondary', null, false); selectProjectColor('accent', null, false); if (document.getElementById('project-view').style.display !== 'none' && currentProjectDataCache?.id === currentProjectId) applyProjectSpecificStyles(currentProjectDataCache); }
function findIndexAndRemove(el, arrName, reloadFn) { if (!currentProjectDataCache || !currentProjectDataCache[arrName]) return; const cont = el.parentNode, items = Array.from(cont.children).filter(ch => ch.classList.contains('edit-item-group')), idx = items.indexOf(el); if (idx > -1) { const itype = arrName.replace('Data', ''); let cmsg = `Remove this ${itype}?`; if (itype === 'quiz' || itype === 'slide') cmsg = `⚠️ Permanently remove ${itype}?`; if (confirm(cmsg)) { currentProjectDataCache[arrName].splice(idx, 1); if (typeof window[reloadFn] === 'function') window[reloadFn](currentProjectDataCache[arrName], cont); } } else { el.remove(); } }
function handleRemoveLearnItem(el) { findIndexAndRemove(el, 'learnData', 'loadLearnEditFieldsForProject'); }
function handleRemoveSlideItem(el) { findIndexAndRemove(el, 'slidesData', 'loadSlidesEditFieldsForProject'); }
function handleRemoveChallengeItem(el) { findIndexAndRemove(el, 'challengesData', 'loadChallengesEditFieldsForProject'); }
function handleRemoveQuizItem(el) { findIndexAndRemove(el, 'quizData', 'loadQuizEditFieldsForProject'); }
function addItemToProjectData(arrName, max, nObj, reloadFn, contSel, focusSel = null) { if (!currentProjectDataCache) return; if (!currentProjectDataCache[arrName]) currentProjectDataCache[arrName] = []; if (currentProjectDataCache[arrName].length >= max) { alert(`Max ${max} items.`); return; } currentProjectDataCache[arrName].push(nObj); const cont = document.querySelector(contSel); if (cont && typeof window[reloadFn] === 'function') { window[reloadFn](currentProjectDataCache[arrName], cont); const items = cont.querySelectorAll('.edit-item-group'), li = items[items.length - 1]; if (li) { li.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); if (focusSel) li.querySelector(focusSel)?.focus(); } } }
function addLearnEditField() { addItemToProjectData('learnData', MAX_LEARN_ITEMS, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadLearnEditFieldsForProject', '#projectEditModal #learnEditContainer', '.learn-title'); }
// MODIFICATION START: Default new slide type to iframe
function addSlideEditField() { addItemToProjectData('slidesData', MAX_SLIDES, { url: "", description: "", type:"iframe" }, 'loadSlidesEditFieldsForProject', '#projectEditModal #slidesEditContainer', '.slide-url'); }
// MODIFICATION END
function addChallengeEditField() { addItemToProjectData('challengesData', MAX_CHALLENGES, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadChallengesEditFieldsForProject', '#projectEditModal #challengesEditContainer', '.challenge-title'); }
function addQuizEditField() { addItemToProjectData('quizData', MAX_QUIZ_QUESTIONS, { questionText:"", correctAnswer:"", incorrectAnswers: Array(MAX_INCORRECT_ANSWERS).fill(""), correctAnswerImageUrl: null, incorrectAnswersImageUrls: Array(MAX_INCORRECT_ANSWERS).fill(null) }, 'loadQuizEditFieldsForProject', '#projectEditModal #quizEditContainer', '.quiz-question'); }
function showProjectEditSection() { const m = document.getElementById('projectEditModal'), s = document.getElementById('editSectionProject'); if (!m || !s) return; m.querySelectorAll('.edit-section').forEach(sec => sec.style.display = 'none'); const sid = s.value + 'Edit', ts = m.querySelector('#' + sid); if (ts) ts.style.display = 'block'; }

// MODIFICATION START: Update slide saving logic in saveProjectChanges
function saveProjectChanges() { const pid = document.getElementById('editingProjectId')?.value; const pi = courseData.projects.findIndex(p => p.id === pid); if (pi === -1 || !currentProjectDataCache) { alert("Error: Could not save."); return; } const m = document.getElementById('projectEditModal'); if (!m) { alert("Error: Modal not found."); return; } let upd = { id: currentProjectDataCache.id, isCompleted: currentProjectDataCache.isCompleted, style: currentProjectDataCache.style ? JSON.parse(JSON.stringify(currentProjectDataCache.style)) : { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null }, projectTitle: m.querySelector('#editProject_Title')?.value.trim() || 'Project', projectSubtitle: m.querySelector('#editProject_Subtitle')?.value.trim() || '', projectHeaderImage: m.querySelector('#editProject_HeaderImage')?.value.trim() || '', tabName: m.querySelector('#editProject_TabName')?.value.trim() || 'Tab', tabImage: m.querySelector('#editProject_TabImage')?.value.trim() || '', overviewText: m.querySelector('#editProject_OverviewText')?.value.trim() || '', videoIntroText: m.querySelector('#editProject_VideoIntroText')?.value.trim() || '', videoTitle: m.querySelector('#editProject_VideoTitle')?.value.trim() || '', videoUrl: m.querySelector('#editProject_VideoUrl')?.value.trim() || '', videoKeyPoints: m.querySelector('#editProject_VideoKeyPoints')?.value.split('\n').map(s => s.trim()).filter(s => s), learnData: [], slidesData: [], challengesData: [], quizData: [] }; let iv = true; try { m.querySelectorAll('#learnEditContainer .edit-item-group').forEach(i => { if (!iv) return; const ti = i.querySelector('.learn-title'), t = ti?.value.trim(), di = i.querySelector('.learn-desc'), mts = i.querySelector('.media-type-select'), mui = i.querySelector('.media-url-input'), mt = mts?.value || 'none', mu = (mt !== 'none' && mui) ? mui.value.trim() : ''; if (!t && ti?.required) { alert("Learn Item Title required."); ti.style.borderColor='red'; ti.focus(); iv=false; return; } if (mt !== 'none' && !mu && mui?.required) { alert(`URL required for media in Learn: "${t||'?'}"`); mui.style.borderColor='red'; mui.focus(); iv=false; return; } if(t || di?.value.trim()){ upd.learnData.push({ title: t, description: di?.value.trim()||"", mediaType: mt, mediaUrl: mu }); if(ti)ti.style.borderColor=''; if(mui)mui.style.borderColor=''; } }); if (!iv) throw new Error("V Fail Learn");

    // Use the updated slide saving logic
    m.querySelectorAll('#slidesEditContainer .edit-item-group').forEach(i => {
        if (!iv) return;
        const ui = i.querySelector('.slide-url');
        const di = i.querySelector('.slide-desc');
        const ts = i.querySelector('.slide-type'); // Get the type select
        const u = ui?.value.trim();
        // Read the type as 'iframe' or 'image'
        const itemType = ts?.value || 'iframe'; // Default to iframe

        if (!u && ui?.required) { alert("Slide URL required."); ui.style.borderColor='red'; ui.focus(); iv=false; return; }
        if (u || di?.value.trim()){
            // Save the type as 'iframe' or 'image'
            upd.slidesData.push({ url: u, description: di?.value.trim()||"", type: itemType });
            if(ui) ui.style.borderColor='';
        }
    });
    if (!iv) throw new Error("V Fail Slides");

    m.querySelectorAll('#challengesEditContainer .edit-item-group').forEach(i => { if (!iv) return; const ti = i.querySelector('.challenge-title'), di = i.querySelector('.challenge-desc'), mts = i.querySelector('.media-type-select'), mui = i.querySelector('.media-url-input'), t = ti?.value.trim(), mt = mts?.value || 'none', mu = (mt !== 'none' && mui) ? mui.value.trim() : ''; if (!t && ti?.required) { alert("Challenge Title required."); ti.style.borderColor='red'; ti.focus(); iv=false; return; } if (mt !== 'none' && !mu && mui?.required) { alert(`URL required for media in Challenge: "${t||'?'}"`); mui.style.borderColor='red'; mui.focus(); iv=false; return; } if(t || di?.value.trim()){ upd.challengesData.push({ title: t, description: di?.value.trim()||"", mediaType: mt, mediaUrl: mu }); if(ti)ti.style.borderColor=''; if(mui)mui.style.borderColor=''; } }); if (!iv) throw new Error("V Fail Challenges"); m.querySelectorAll('#quizEditContainer .edit-item-group').forEach((i, qIdx) => { if (!iv) return; const qi = i.querySelector('.quiz-question'), ci = i.querySelector('.quiz-correct'), cii = i.querySelector('.quiz-correct-img'), q = qi?.value.trim(), c = ci?.value.trim(), cimg = cii?.value.trim()||null; if (!q && qi?.required) { alert("Question text required."); qi.style.borderColor='red'; qi.focus(); iv=false; return; } if (!c && ci?.required) { alert("Correct Answer text required."); ci.style.borderColor='red'; ci.focus(); iv=false; return; } if (q && c) { let inc = [], incImgs = []; i.querySelectorAll(`.quiz-incorrect`).forEach((inp, incIdx) => { const imgInp = i.querySelector(`#quiz-incorrect-img-${qIdx}-${incIdx}`); const txt = inp.value.trim(), img = imgInp?.value.trim()||null; if (txt) { inc.push(txt); incImgs.push(img); } }); while(incImgs.length < MAX_INCORRECT_ANSWERS) incImgs.push(null); upd.quizData.push({ questionText: q, correctAnswer: c, incorrectAnswers: inc, correctAnswerImageUrl: cimg, incorrectAnswersImageUrls: incImgs.slice(0, MAX_INCORRECT_ANSWERS) }); qi.style.borderColor=''; ci.style.borderColor=''; } }); if (!iv) throw new Error("V Fail Quiz"); courseData.projects[pi] = upd; console.log("Project saved:", upd); applyProjectSpecificStyles(upd); renderProjectPage(upd); renderCoursePage(); closeModal('projectEditModal'); currentProjectDataCache = null; } catch (error) { if (error.message && !error.message.startsWith("V Fail")) { console.error("Save error:", error); alert("Error saving."); } console.warn("Save abort:", error.message); }
}
// MODIFICATION END

// --- Utility Functions ---
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function areColorsEqual(c1, c2) { if (c1 === c2) return true; if (!c1 || !c2) return false; if (String(c1).trim().toLowerCase() === String(c2).trim().toLowerCase()) return true; const toRgba = (c) => { const x=document.createElement('canvas').getContext('2d'); if(!x) return null; try { x.fillStyle='#000'; x.fillStyle=c; const cc=x.fillStyle; if(cc.startsWith('#')){const rgb=hexToRgb(cc); return rgb?`rgba(${rgb.r},${rgb.g},${rgb.b},1)`:null;} if(cc.startsWith('rgb(')) return cc.replace('rgb(','rgba(').replace(')',',1)'); if(cc.startsWith('rgba')) return cc; } catch(e){} return null; }; try { const r1 = toRgba(c1), r2 = toRgba(c2); return r1 && r2 && r1 === r2; } catch(e){ return String(c1).trim().toLowerCase() === String(c2).trim().toLowerCase(); } }

// --- EXPORT COURSE ---
// MODIFICATION START: Update export script's renderMediaElement and showSlideContent
function exportCourseHTML() {
    console.log("Exporting Course...");
    const originalProject = currentProjectId ? courseData.projects.find(p => p.id === currentProjectId) : null;
    try {
        applyCourseTheme();
        const exportDoc = document.documentElement.cloneNode(true);

        exportDoc.querySelector('#courseEditModal')?.remove();
        exportDoc.querySelector('#projectEditModal')?.remove();
        exportDoc.querySelectorAll('.edit-btn, .export-btn').forEach(b => b.remove());
        const backBtn = exportDoc.querySelector('#project-view .back-btn');
        if(backBtn) backBtn.setAttribute('onclick', 'showCourseView()');

        exportDoc.querySelector('#course-view').style.display = 'block';
        const exportPV = exportDoc.querySelector('#project-view');
        if (exportPV) {
             exportPV.style.display = 'none'; exportPV.style.fontFamily = ''; exportPV.style.fontSize = '';
             const layout = exportPV.querySelector('#projectLayout'); if(layout) layout.classList.remove('sidebar-collapsed');
             const toggleBtn = exportPV.querySelector('#toggleSidebarBtn'); if(toggleBtn) { toggleBtn.innerHTML = '❮'; toggleBtn.setAttribute('aria-label', 'Collapse Sidebar'); toggleBtn.setAttribute('onclick', 'toggleProjectSidebar()'); }
        }
        const exportMS = exportDoc.querySelector('#course-multimedia-section');
        if (exportMS) {
            const md = courseData.courseMultimedia; const ih = md?.type === 'none' || !md?.url; exportMS.style.display = ih ? 'none' : 'block';
            if (!ih) {
                const im = !!md?.minimized; exportMS.classList.toggle('multimedia-minimized', im);
                const etb = exportMS.querySelector('#toggle-multimedia-btn'); if (etb) { etb.innerHTML = im ? '+' : '—'; etb.setAttribute('onclick', 'toggleCourseMultimedia()'); }
                const ifr = exportMS.querySelector('iframe'); if (ifr) { const originalSrc = md.url; ifr.setAttribute('data-original-src', originalSrc); ifr.src = im ? 'about:blank' : getUrlWithNoAutoplay(originalSrc); }
            }
        }
        exportDoc.querySelectorAll('.quiz-question').forEach(q => { q.classList.remove('answered'); q.querySelectorAll('.quiz-option').forEach(o => {o.classList.remove('selected', 'correct', 'incorrect'); o.style.opacity='1'; o.style.cursor='pointer'; o.setAttribute('onclick', 'selectQuizOption(this)'); o.setAttribute('onkeydown', "if(event.key==='Enter'||event.key===' '){event.preventDefault();selectQuizOption(this)}"); }); q.querySelectorAll('.quiz-feedback').forEach(f => f.style.display = 'none'); });
        exportDoc.querySelector('.final-quiz-result')?.remove();
        const esb = exportDoc.querySelector('#project-view #submitQuizBtn'); if (esb) { esb.disabled = false; esb.setAttribute('onclick', 'submitQuiz()'); }
        exportDoc.querySelectorAll('.slide-content-container.active').forEach(s => s.classList.remove('active')); exportDoc.querySelectorAll('.slide-sub-tabs .sub-tab.active').forEach(t => t.classList.remove('active')); exportDoc.querySelectorAll('.slide-sub-tabs').forEach(t => t.style.display='none');
        exportDoc.querySelectorAll('#projectTabs .tab').forEach(t => t.classList.remove('active')); exportDoc.querySelector('#projectTabs .tab[data-tab-id="overview"]')?.classList.add('active');
        exportDoc.querySelectorAll('#projectTabContentContainer .tab-content').forEach(tc => tc.classList.remove('active')); exportDoc.querySelector('#projectTabContentContainer #overview')?.classList.add('active');
        exportDoc.querySelectorAll('#projectTabs > .tab').forEach(tab => { const tabId = tab.getAttribute('data-tab-id'); if(tabId) tab.setAttribute('onclick', `openProjectTab('${tabId}', this)`); });
        exportDoc.querySelectorAll('.slide-sub-tabs .sub-tab').forEach(subTab => { subTab.setAttribute('onclick', `event.preventDefault(); showSlideContent(\`slide-\${currentProjectId}-\${this.getAttribute('data-slide-index')}\`, this);`); });
        exportDoc.querySelectorAll('script').forEach(s => s.remove());

        const viewerScript = document.createElement('script');
        const courseDataString = JSON.stringify(courseData).replace(/</g, '\\u003c').replace(/>/g, '\\u003e');

        viewerScript.textContent = `
// --- Embedded Viewer Script ---
const courseData = ${courseDataString}; let currentProjectId = null; let currentlyPlayingVideoIframe = null; let currentlyActiveProjectTabId = 'overview'; const MAX_INCORRECT_ANSWERS = ${MAX_INCORRECT_ANSWERS};
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}} function hexToRgb(h){let r=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
function applyThemeColors(p,s,a){const rt=document.documentElement;rt.style.setProperty('--primary',p||'#5E81F4');rt.style.setProperty('--secondary',s||'#FF7AC6');rt.style.setProperty('--accent',a||'#FFB800');const pr=hexToRgb(p||'#5E81F4');if(pr)rt.style.setProperty('--primary-rgb',\`\${pr.r},\${pr.g},\${pr.b}\`);const sr=hexToRgb(s||'#FF7AC6');if(sr)rt.style.setProperty('--secondary-rgb',\`\${sr.r},\${sr.g},\${sr.b}\`)} function applyCourseTheme(){const cs=courseData.style||{};applyThemeColors(cs.primaryColor,cs.secondaryColor,cs.accentColor);const rt=document.documentElement;rt.style.setProperty('--base-font-family',cs.fontFamily||"'Segoe UI',sans-serif");let fs='16px';if(cs.baseSize==='small')fs='14px';else if(cs.baseSize==='large')fs='18px';rt.style.setProperty('--base-font-size',fs);const pv=document.getElementById('project-view');if(pv){pv.style.fontFamily='';pv.style.fontSize=''} } function applyProjectSpecificStyles(p){if(!p)return;const ps=p.style||{};const cs=courseData.style||{};applyThemeColors(ps.primaryColor||cs.primaryColor,ps.secondaryColor||cs.secondaryColor,ps.accentColor||cs.accentColor);const pv=document.getElementById('project-view');if(!pv)return;pv.style.fontFamily=ps.fontFamily?ps.fontFamily:'';let ef='';if(ps.baseSize==='small')ef='14px';else if(ps.baseSize==='large')ef='18px';else if(ps.baseSize==='medium')ef='16px';pv.style.fontSize=ef}
function getUrlWithNoAutoplay(u){if(!u||u==='about:blank')return u;let fu=u;try{let o=new URL(u);if(u.includes('youtube.com')||u.includes('youtu.be'))o.searchParams.set('autoplay','0');else if(u.includes('player.vimeo.com'))o.searchParams.set('autoplay','0');else if(u.includes('wistia.com')){o.searchParams.set('autoplay','false');o.searchParams.set('playerPreference','false')}else{o.searchParams.set('autoplay','false');o.searchParams.set('autoplay','0')} fu=o.toString()}catch(e){} return fu} function pauseVideoIframe(ifr){if(!ifr)return;const oSrc=ifr.getAttribute('data-original-src')||ifr.src;if(oSrc&&oSrc!=='about:blank'&&oSrc!==''){if(!ifr.hasAttribute('data-original-src'))ifr.setAttribute('data-original-src',oSrc);ifr.src='about:blank'} if(currentlyPlayingVideoIframe===ifr)currentlyPlayingVideoIframe=null} function resumeVideoIframe(ifr){if(!ifr)return;const oSrc=ifr.getAttribute('data-original-src');if(oSrc){ifr.src=getUrlWithNoAutoplay(oSrc);currentlyPlayingVideoIframe=ifr} } function pauseCurrentlyPlayingVideo(){if(currentlyPlayingVideoIframe)pauseVideoIframe(currentlyPlayingVideoIframe)}
function showCourseView(){pauseCurrentlyPlayingVideo();document.getElementById('course-view').style.display='block';document.getElementById('project-view').style.display='none';currentProjectId=null;currentlyActiveProjectTabId='overview';document.title=courseData.title||"Course";applyCourseTheme();renderCoursePage();window.scrollTo(0,0);try{history.pushState(null, courseData.title || '', window.location.pathname + window.location.search);} catch(e){}} function showProjectView(pid){const ci=document.querySelector('#course-multimedia-section iframe');if(ci)pauseVideoIframe(ci);const p=courseData.projects.find(pr=>pr.id===pid);if(!p){showCourseView();return} currentProjectId=pid;currentlyActiveProjectTabId='overview';renderProjectPage(p);document.getElementById('course-view').style.display='none';document.getElementById('project-view').style.display='block';document.title=p.projectTitle||"Project";applyCourseTheme();applyProjectSpecificStyles(p);window.scrollTo(0,0);try{history.pushState({projectId:pid},p.projectTitle||'',\`#project-\${pid}\`)}catch(e){}} window.onpopstate=function(e){pauseCurrentlyPlayingVideo();if(e.state&&e.state.projectId&&courseData.projects.some(p=>p.id===e.state.projectId)){showProjectView(e.state.projectId)}else{showCourseView()} };
function renderCoursePage(){const c=courseData;document.getElementById('courseTitle').textContent=c.title;const i=document.getElementById('courseImage');if(i){i.src=c.imageUrl||'';i.alt=c.title+" Img"; i.onerror = function() { console.error('Failed to load course image:', this.src); this.src='https://via.placeholder.com/150/eee/999?text=Err'; };} document.getElementById('courseDescription').textContent=c.description;renderCourseMultimedia();const g=document.getElementById('projectGrid');g.innerHTML='';if(!c.projects||c.projects.length===0){g.innerHTML='<p>No projects.</p>';return} c.projects.forEach(p=>{if(!p||!p.id)return;const t=document.createElement('a');t.className='project-tab';t.href=\`#project-\${p.id}\`;t.setAttribute('onclick',\`event.preventDefault();showProjectView('\${p.id}');\`);t.innerHTML=\`<img src="\${p.tabImage||'https://via.placeholder.com/300x200/eee/999?text=Project'}" alt="\${p.tabName||'Project'}" loading="lazy" onerror="console.error('Failed to load project tab image:', this.src); this.src='https://via.placeholder.com/300x200/eee/999?text=Load+Error';"><div class="project-tab-info"><span>\${p.tabName||'Project'}</span></div>\`;if(p.isCompleted){const k=document.createElement('span');k.className='completion-tick';k.innerHTML='✔';k.setAttribute('aria-label','Completed');t.appendChild(k)} g.appendChild(t)})}
function renderCourseMultimedia(){const s=document.getElementById('course-multimedia-section'),d=document.getElementById('course-multimedia-content'),b=document.getElementById('toggle-multimedia-btn'),m=courseData.courseMultimedia||{type:'none',url:'',title:'',minimized:false};if(!s||!d||!b){ if(s) s.style.display = 'none'; return; } d.innerHTML='';s.classList.remove('multimedia-minimized');const ih=m.type==='none'||!m.url;s.style.display=ih?'none':'block';if(ih)return; const u=m.url.trim(),t=m.title?.trim()||'Media';let eh='';if(m.type==='image') eh=\`<img src="\${u}" alt="\${t}" loading="lazy" onerror="console.error('Failed to load course multimedia image:', this.src); this.alt='Image Load Error';">\`;else{const su=getUrlWithNoAutoplay(u);const sb="allow-scripts allow-same-origin allow-presentation allow-popups allow-forms";const al="fullscreen; picture-in-picture; accelerometer; clipboard-write; encrypted-media; gyroscope;";eh=\`<div class="media-wrapper-16-9"><iframe src="\${su}" data-original-src="\${u}" title="\${t}" frameBorder="0" loading="lazy" allow="\${al}" allowfullscreen sandbox="\${sb}"></iframe></div>\`} if(eh)d.innerHTML=eh;else d.innerHTML='<p>Unsupported.</p>'; const im=!!m.minimized;s.classList.toggle('multimedia-minimized',im);b.innerHTML=im?'+':'—';b.title=im?'Maximize Course Intro':'Minimize Course Intro';b.setAttribute('aria-label',im?'Maximize Course Intro':'Minimize Course Intro');if(im){const ifr=d.querySelector('iframe');if(ifr)pauseVideoIframe(ifr)}}
function renderProjectPage(p){if(!p)return;const pv=document.getElementById('project-view');if(!pv)return;const pl=document.getElementById('projectLayout'),tgb=document.getElementById('toggleSidebarBtn');if(pl)pl.classList.remove('sidebar-collapsed');if(tgb){tgb.innerHTML='❮';tgb.title='Collapse Sidebar'} const h=pv.querySelector('#project-header');if(h){h.querySelector('#projectImage').src=p.projectHeaderImage||p.tabImage||'';h.querySelector('#projectImage').alt=p.projectTitle+" Hdr"; h.querySelector('#projectImage').onerror = function() { console.error('Failed to load project header image:', this.src); this.src='https://via.placeholder.com/100/eee/999?text=Err'; }; h.querySelector('#projectTitle').textContent=p.projectTitle||'Project';h.querySelector('#projectSubtitle').textContent=p.projectSubtitle||''} const ct=pv.querySelector('#projectTabContentContainer');if(!ct)return;const ov=ct.querySelector('#overview');if(ov){ov.querySelector('#overviewText').textContent=p.overviewText||'';renderLearnItemsForProject(p.learnData||[],ov.querySelector('#learnContainer'))} const vd=ct.querySelector('#video');if(vd){vd.querySelector('#videoIntroText').textContent=p.videoIntroText||'';vd.querySelector('#videoTitle').textContent=p.videoTitle||'';const vi=vd.querySelector('#mainVideo');if(vi){const vu=p.videoUrl||'';vi.setAttribute('data-original-src',vu);vi.src=getUrlWithNoAutoplay(vu)} const ul=vd.querySelector('#videoKeyPoints');ul.innerHTML='';(p.videoKeyPoints||[]).forEach(pt=>{if(pt&&pt.trim())ul.innerHTML+=\`<li>\${pt.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</li>\`});if(!ul.innerHTML)ul.innerHTML='<li>No points.</li>'} const sl=ct.querySelector('#slides');if(sl)renderSlideshowForProject(p.slidesData||[],sl.querySelector('#slideshowContainer'),pv.querySelector('#projectTabs .tab[data-tab-id="slides"] .slide-sub-tabs'));const ch=ct.querySelector('#challenges');if(ch)renderChallengesForProject(p.challengesData||[],ch.querySelector('#challengesContainer'));const qz=ct.querySelector('#quiz');if(qz)renderQuizForProject(p.quizData||[],qz.querySelector('#quizContainer'),qz.querySelector('#submitQuizBtn'));const tb=pv.querySelector('#projectTabs');const ftb=tb?.querySelector('.tab[data-tab-id="overview"]');if(ftb)openProjectTab('overview',ftb);else updateProjectProgressBar('');if(tb)tb.querySelectorAll('.slide-sub-tabs').forEach(sub=>sub.style.display='none')}
function renderMediaElement(t,u,ti){if(!u)return'';const url=u.trim();if(!url)return'';const st=ti||'Media';if(t==='image'){return\`<img src="\${url}" loading="lazy" alt="\${st}" onerror="console.error('Failed to load media image:', this.src); this.alt='Image Load Error';">\`} if(t==='iframe'||t==='video'||t==='presentation'){const su=getUrlWithNoAutoplay(url);const sb="allow-scripts allow-same-origin allow-presentation allow-popups allow-forms";const al="fullscreen; picture-in-picture; accelerometer; clipboard-write; encrypted-media; gyroscope;";console.log(\`Viewer Rendering IFRAME (\${t}) for: \${su}\`);return\`<iframe src="\${su}" frameborder="0" loading="lazy" allowfullscreen sandbox="\${sb}" allow="\${al}" title="\${st}" data-original-src="\${url}"></iframe>\`} console.warn("Viewer Unsupported media type:",t,url);return'<p style="color: red; font-weight: bold;">Error: Unsupported media type \\'\${t}\\'</p>'}
function renderLearnItemsForProject(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p>No items.</p>';return} v.forEach((i,x)=>{const el=document.createElement('div');el.className='step';el.innerHTML=\`<div class="step-number">\${x+1}</div><div class="step-content"><strong>\${i.title.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong>\${i.description?'<p class="description"></p>':''}<div class="step-media" style="display:none;"></div></div>\`;if(i.description)el.querySelector('p.description').textContent=i.description;const m=el.querySelector('.step-media'),mh=renderMediaElement(i.mediaType,i.mediaUrl,i.title);if(mh){m.innerHTML=mh;m.style.display='block'} c.appendChild(el)})} function renderChallengesForProject(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p>No items.</p>';return} v.forEach(i=>{const el=document.createElement('div');el.className='step';el.innerHTML=\`<div class="step-number">★</div><div class="step-content"><strong>\${i.title.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong>\${i.description?'<p class="description"></p>':''}<div class="step-media" style="display:none;"></div></div>\`;if(i.description)el.querySelector('p.description').textContent=i.description;const m=el.querySelector('.step-media'),mh=renderMediaElement(i.mediaType,i.mediaUrl,i.title);if(mh){m.innerHTML=mh;m.style.display='block'} c.appendChild(el)})}
function renderSlideshowForProject(d,mc,sc){if(!mc||!sc){if(mc)mc.innerHTML='<p>Error.</p>';return} mc.innerHTML='';sc.innerHTML='';const v=(d||[]).filter(s=>s.url&&s.url.trim());if(v.length===0){mc.innerHTML='<p>No slides.</p>';sc.style.display='none';return} sc.style.display='flex';v.forEach((s,x)=>{const id=\`slide-\${currentProjectId}-\${x}\`,ct=(s.type==='image')?'image':'iframe',u=s.url.trim(),ds=s.description||'',ti=ds||'Slide '+(x+1);const sub=document.createElement('a');sub.className='sub-tab';sub.textContent=\`Step \${x+1}\`;sub.href=\`#\${id}\`;sub.setAttribute('onclick',\`event.preventDefault();showSlideContent('\${id}',this);\`);sub.setAttribute('data-slide-index',x);sub.title=ds||'Step '+(x+1);sc.appendChild(sub);const cont=document.createElement('div');cont.className='slide-content-container';cont.id=id;let dh='';if(ds){const p=document.createElement('p');p.className='slide-description';p.textContent=ds;dh=p.outerHTML} cont.innerHTML=\`\${dh}<div class="slide-media-wrapper">\${renderMediaElement(ct,u,ti)}</div>\`;mc.appendChild(cont)}); if (mc.children.length > 0 && !mc.querySelector('.active')) {const fs = sc.querySelector('.sub-tab'); if (fs) {const fi = fs.getAttribute('data-slide-index'); const fid = \`slide-\${currentProjectId}-\${fi}\`; showSlideContent(fid, fs);}}}
function showSlideContent(sid,cSub){const msc=document.getElementById('slideshowContainer');if(!msc)return;pauseCurrentlyPlayingVideo();msc.querySelectorAll('.slide-content-container').forEach(c=>{c.classList.remove('active');const ifr=c.querySelector('iframe');if(ifr)pauseVideoIframe(ifr)});const t=msc.querySelector(\`#\${sid}\`);const sc=cSub?.closest('.slide-sub-tabs');if(sc)sc.querySelectorAll('.sub-tab').forEach(sub=>sub.classList.remove('active'));if(cSub){cSub.classList.add('active');cSub.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'})} if(t){t.classList.add('active');const ti=t.querySelector('iframe');if(ti){const os=ti.getAttribute('data-original-src');console.log(\`Viewer: Target iframe found for \${sid}. Original src: \${os}\`);setTimeout(()=>{if(ti&&os&&ti.src!==os){console.log(\`Viewer: Reloading iframe src for \${sid} to: \${os}\`);ti.src=getUrlWithNoAutoplay(os);currentlyPlayingVideoIframe=ti}else if(ti&&!os){console.warn(\`Viewer: Target iframe for \${sid} has no data-original-src!\`)}else if(ti&&ti.src===os){console.log(\`Viewer: Iframe src for \${sid} already seems correct.\`);currentlyPlayingVideoIframe=ti}},50)}} }
function renderQuizForProject(d,c,b){if(!c||!b)return;c.innerHTML='';c.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();b.disabled=false;b.style.display='none';const v=(d||[]).filter(q=>q.questionText?.trim()&&q.correctAnswer?.trim());if(v.length===0){c.innerHTML='<p>No quiz.</p>';return} b.style.display='block';v.forEach((q,x)=>{const dv=document.createElement('div');dv.className='quiz-question';dv.innerHTML=\`<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>\`;dv.querySelector('.question-text').textContent=\`\${x+1}. \${q.questionText.replace(/</g, "&lt;").replace(/>/g, "&gt;")}\`;const od=dv.querySelector('.quiz-options');let os=[{text:q.correctAnswer.trim(),imageUrl:q.correctAnswerImageUrl?.trim()||null,isCorrect:true}];(q.incorrectAnswers||[]).forEach((at,i)=>{const t=at?.trim();if(t)os.push({text:t,imageUrl:(q.incorrectAnswersImageUrls&&q.incorrectAnswersImageUrls[i]?.trim())?q.incorrectAnswersImageUrls[i].trim():null,isCorrect:false})});shuffleArray(os);os.forEach(opD=>{const oe=document.createElement('div');oe.className='quiz-option';oe.setAttribute('role','button');oe.setAttribute('tabindex','0');oe.onclick=()=>selectQuizOption(oe);oe.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(oe)}};oe.setAttribute('data-is-correct',opD.isCorrect.toString());if(opD.imageUrl){const g=document.createElement('img');g.src=opD.imageUrl;g.alt=\`Option for \${opD.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}\`;g.className='option-image';g.loading='lazy'; g.onerror = function() { console.error('Failed to load quiz option image:', this.src); this.alt = 'Img Err'; this.style.display='none'; }; oe.appendChild(g)} const ts=document.createElement('span');ts.className='option-text';ts.textContent=opD.text.replace(/</g, "&lt;").replace(/>/g, "&gt;");oe.appendChild(ts);od.appendChild(oe)});c.appendChild(dv)})}
function openProjectTab(tid,el){pauseCurrentlyPlayingVideo();currentlyActiveProjectTabId=tid;const c=document.getElementById('projectTabContentContainer');if(!c)return;c.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));const bs=document.getElementById('projectTabs');if(bs){bs.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));bs.querySelectorAll('.slide-sub-tabs').forEach(sub=>sub.style.display='none')} const t=c.querySelector('#'+tid);if(t)t.classList.add('active');if(el)el.classList.add('active');if(tid==='slides'&&el){const sc=el.querySelector('.slide-sub-tabs');if(sc){sc.style.display='flex';const msc=document.getElementById('slideshowContainer');const act=msc?.querySelector('.slide-content-container.active');let tSub=null;if(act){const actIdx=Array.from(msc.children).indexOf(act);if(actIdx!==-1)tSub=sc.querySelector(\`.sub-tab[data-slide-index="\${actIdx}"]\`)} if(!tSub)tSub=sc.querySelector('.sub-tab');if(tSub){const tIdx=tSub.getAttribute('data-slide-index');const tId=\`slide-\${currentProjectId}-\${tIdx}\`;showSlideContent(tId,tSub)}else if(msc)msc.innerHTML='<p>Error.</p>'}} if(tid==='video'){const vIfr=document.querySelector('#video #mainVideo');if(vIfr&&vIfr.src==='about:blank')resumeVideoIframe(vIfr);else if(vIfr)currentlyPlayingVideoIframe=vIfr} updateProjectProgressBar(tid)} function updateProjectProgressBar(tn){const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tn);if(i>=0)r=((i+1)/o.length)*100;p.style.width=r+'%'} function selectQuizOption(oe){const qd=oe.closest('.quiz-question');if(!qd||qd.classList.contains('answered'))return;qd.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));oe.classList.add('selected')} function markProjectAsCompleted(pid){const p=courseData.projects.find(pr=>pr.id===pid);if(p&&!p.isCompleted){p.isCompleted=true;const tab=document.querySelector(\`#course-view .project-tab[href='#project-\${pid}']\`);if(tab&&!tab.querySelector('.completion-tick')){const tk=document.createElement('span');tk.className='completion-tick';tk.innerHTML='✔';tk.setAttribute('aria-label','Completed');tab.appendChild(tk)}}}
function submitQuiz(){const qs=document.querySelectorAll('#project-view #quizContainer .quiz-question');let ac=0,sc=0;const tt=qs.length;if(tt===0)return;let fu=null;qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');q.classList.remove('answered');q.querySelectorAll('.quiz-feedback').forEach(f=>f.style.display='none');q.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('correct','incorrect');o.style.opacity='1';o.style.cursor='pointer';o.onclick=()=>selectQuizOption(o);o.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(o)}}});q.style.outline='';if(s)ac++;else if(!fu)fu=q});if(ac<tt){alert('Answer all '+tt+' questions!');if(fu){fu.scrollIntoView({behavior:'smooth',block:'center'});fu.style.outline='2px solid var(--danger)';setTimeout(()=>{if(fu)fu.style.outline=''},2500)} return} qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');const fc=q.querySelector('.quiz-feedback.correct');const fi=q.querySelector('.quiz-feedback.incorrect');const ao=q.querySelectorAll('.quiz-option');q.classList.add('answered');const isc=s.getAttribute('data-is-correct')==='true';ao.forEach(o=>{const oc=o.getAttribute('data-is-correct')==='true';if(oc)o.classList.add('correct');if(o===s&&!isc)o.classList.add('incorrect');if(o!==s&&!oc)o.style.opacity="0.6";if(o===s&&isc)o.style.opacity="1";if(oc&&o!==s)o.style.opacity="1";o.style.cursor="default";o.onclick=null;o.onkeydown=null});if(isc){sc++;if(fc)fc.style.display='block'}else{if(fi){const co=q.querySelector('.quiz-option.correct');const cts=co?.querySelector('span.option-text');fi.textContent=\`Not quite. Correct: "\${cts?cts.textContent.replace(/</g, "&lt;").replace(/>/g, "&gt;"):(co?co.textContent.replace(/</g, "&lt;").replace(/>/g, "&gt;"):'N/A')}"\`;fi.style.display='block'}}});const b=document.querySelector('#project-view #submitQuizBtn');if(b)b.disabled=true;const qc=document.querySelector('#project-view #quiz');let rd=qc?.querySelector('.final-quiz-result');if(!rd&&qc){rd=document.createElement('div');qc.appendChild(rd)} if(rd){const pc=tt>0?Math.round((sc/tt)*100):0;const ps=pc>=70;rd.textContent=\`Quiz Complete! Score: \${sc}/\${tt} (\${pc}%).\`;rd.className='final-quiz-result '+(ps?'success':'fail');rd.style.display='block';rd.scrollIntoView({behavior:'smooth',block:'center'});if(ps&&currentProjectId)markProjectAsCompleted(currentProjectId)} }
function toggleProjectSidebar(){const l=document.getElementById('projectLayout'),b=document.getElementById('toggleSidebarBtn');if(l&&b){l.classList.toggle('sidebar-collapsed');const iC=l.classList.contains('sidebar-collapsed');b.innerHTML=iC?'☰':'❮';b.title=iC?'Expand Sidebar':'Collapse Sidebar';b.setAttribute('aria-label',iC?'Expand Sidebar':'Collapse Sidebar')}} function toggleCourseMultimedia(){const s=document.getElementById('course-multimedia-section'),b=document.getElementById('toggle-multimedia-btn'),d=document.getElementById('course-multimedia-content');const ifr=d?.querySelector('iframe');if(!s||!b||!courseData.courseMultimedia)return; const iM=!s.classList.contains('multimedia-minimized');s.classList.toggle('multimedia-minimized',iM);if(iM){b.innerHTML='+';b.title='Maximize Course Intro';b.setAttribute('aria-label','Maximize Course Intro');if(ifr)pauseVideoIframe(ifr)} else{b.innerHTML='—';b.title='Minimize Course Intro';b.setAttribute('aria-label','Minimize Course Intro');if(ifr&&ifr.src==='about:blank'&&ifr.getAttribute('data-original-src')){resumeVideoIframe(ifr)}else if(!ifr&&courseData.courseMultimedia.url){renderCourseMultimedia()}else if(ifr){currentlyPlayingVideoIframe=ifr}} }
document.addEventListener('DOMContentLoaded', function(){console.log("Viewer: DOM Loaded");applyCourseTheme();renderCoursePage();let displayedProject=false;if(window.location.hash&&window.location.hash.startsWith('#project-')){const pid=window.location.hash.substring(9);if(courseData.projects.some(p=>p.id===pid)){try { showProjectView(pid); displayedProject=true; } catch (e) { console.error("View: Error showing project from hash", e); showCourseView(); }} else { console.warn("View: Project ID from hash not found:", pid); showCourseView(); }} if(!displayedProject) { if (document.getElementById('course-view').style.display === 'none') { showCourseView(); } try{ history.replaceState(null, courseData.title || '', window.location.pathname + window.location.search); } catch(e) {}} console.log("Exported Viewer Initialized.");});
`; // End of viewer script string
        // MODIFICATION END
        exportDoc.querySelector('body').appendChild(viewerScript);

        const htmlContent = '<!DOCTYPE html>\n' + exportDoc.outerHTML;
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
        const downloadUrl = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = downloadUrl; const filenameBase = (courseData.title || "course").replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_'); a.download = `${filenameBase}_export.html`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(downloadUrl);
        console.log("Course export finished.");
    } catch (error) {
        console.error("Error during COURSE export:", error); alert("An error occurred during course export. Check console.");
    } finally {
         if (originalProject) applyProjectSpecificStyles(originalProject); else applyCourseTheme();
    }
}


// --- INITIAL PAGE LOAD (Editor Mode) ---
document.addEventListener('DOMContentLoaded', function() {
    console.log("Editor/Viewer Initializing...");
    applyCourseTheme();
    renderCoursePage();
    let displayedProject = false;
    if (window.location.hash && window.location.hash.startsWith('#project-')) {
        const pid = window.location.hash.substring(9);
        if (courseData.projects.some(p => p.id === pid)) {
            try { showProjectView(pid); displayedProject = true; }
            catch (e) { console.error("Error showing project from hash:", e); showCourseView(); }
        } else {
             console.warn("Project ID from hash not found, showing course view:", pid);
             try { history.replaceState(null, courseData.title || '', window.location.pathname + window.location.search); } catch(e) {}
             showCourseView();
        }
    }
    if (!displayedProject && document.getElementById('course-view').style.display === 'none') { showCourseView(); }
    console.log("Initialization complete.");
});

</script>

</body>
</html>
