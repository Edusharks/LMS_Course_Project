
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Editor & Viewer - Combined</title> <!-- Updated Title -->
<style>
    /* --- Base Styles --- */
    :root {
        /* Default Theme Colors (Can be overridden by Course or Project Editor) */
        --primary: #5E81F4;
        --secondary: #FF7AC6;
        --accent: #FFB800;
        --light: #F5F7FA;
        --dark: #1A1D28;
        --success: #7CE7AC;
        --danger: #FF7E7E;
        /* Base Font Settings (Can be overridden by Project Editor) */
        --base-font-family: 'Segoe UI', sans-serif;
        --base-font-size: 16px;
    }
    html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--base-font-size); }
    *, *:before, *:after { box-sizing: inherit; }
    body { font-family: var(--base-font-family); margin: 0; padding: 0; background-color: var(--light); color: var(--dark); line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
    h2 { color: var(--primary); border-bottom: 3px solid var(--secondary); padding-bottom: 8px; display: inline-block; font-size: 1.3rem; margin-top: 0; margin-bottom: 20px; }
    h3 { color: var(--dark); margin-top: 25px; margin-bottom: 10px; font-size: 1.15rem; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

    /* --- Header Styles (Generic for Course/Project) --- */
    .page-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        text-align: center;
        position: relative; /* Needed for absolute positioning of buttons */
    }
    .page-header img.header-image { /* Common class for header images */
        width: 120px; /* Default size */
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 3px solid white;
    }
    .page-header .header-title-container { flex-grow: 1; }
    .page-header .header-title { color: white; margin: 0 0 5px 0; font-size: 1.8rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
    .page-header .header-subtitle { color: rgba(255, 255, 255, 0.9); font-size: 1rem; margin: 0; }

    /* --- Edit/Export/Back Buttons --- */
    .edit-btn, .export-btn, .back-btn {
        position: absolute;
        top: 15px;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.5);
        width: 38px;
        height: 38px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 19px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.3s, transform 0.2s;
        z-index: 10;
        text-decoration: none;
    }
    .edit-btn:hover, .export-btn:hover, .back-btn:hover { background-color: rgba(255, 255, 255, 0.4); transform: scale(1.1); }
    /* Positions */
    #course-view .page-header .edit-btn { right: 15px; }
    #course-view .page-header .export-btn { right: 65px; } /* ONLY on course header */
    #project-view .page-header .edit-btn { right: 15px; }
    #project-view .page-header .back-btn { right: 65px; font-size: 24px; /* Make arrow slightly bigger */ }


    /* --- Course View Specific Styles --- */
    #course-view { animation: fadeIn 0.5s; }
    #course-description-container {
        background-color: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 25px;
        font-size: 1rem;
        line-height: 1.7;
    }
    #projectGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .project-tab {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.07);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
        position: relative; /* For completion tick */
    }
    .project-tab:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .project-tab img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
    }
    .project-tab-info {
        padding: 15px;
        text-align: center;
        background-color: #fdfdff;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .project-tab-info span {
        font-weight: bold;
        color: var(--primary);
        font-size: 1.05rem;
    }
    .completion-tick {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        background-color: var(--success);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        line-height: 1;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 5;
    }

    /* --- Project View Specific Styles --- */
    #project-view {
        /* Project specific font/size applied here via JS */
        animation: fadeIn 0.5s;
    }
    /* Slightly smaller image for project header */
    #project-view .page-header .header-image { width: 100px; height: 100px; }
    #project-view .page-header .header-title { font-size: 1.6rem; }
    #project-view .page-header .header-subtitle { font-size: 0.95rem; }

    /* --- Styling for project content (Merged from Project Code) --- */
    .progress-container{width:100%;background-color:#e0e0e0;border-radius:10px;margin:20px 0;height:10px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:10px;width:0%;transition:width .5s ease-in-out}
    #projectTabs { /* Target specifically */
        display:flex;gap:8px;margin-bottom:15px;overflow-x:auto;padding-bottom:5px;-webkit-overflow-scrolling:touch
    }
    #projectTabs::-webkit-scrollbar{display:none}
    #projectTabs .tab{ /* Target specifically */
        padding:8px 15px;background-color:#fff;border-radius:30px;cursor:pointer;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.05);white-space:nowrap;font-size:.9rem;flex-shrink:0;transition:background-color .3s,color .3s,transform .2s
    }
    #projectTabs .tab.active{background-color:var(--primary);color:#fff;transform:translateY(-2px)}
    #projectTabs .tab:hover:not(.active){background-color:#eef2ff;transform:translateY(-1px)}
    #projectTabContentContainer .tab-content{ /* Target specifically */
        display:none;background-color:#fff;padding:20px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,.05);animation:fadeIn .5s ease-out;margin-bottom:20px
    }
    #projectTabContentContainer .tab-content.active{display:block}
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:15px 0;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:10px;border:none}
    .slide{display:none;text-align:center}
    .slideshow{position:relative;margin:15px 0;background-color:#f9f9ff;padding:15px;border-radius:10px}
    .slide-content-wrapper{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:0 auto 15px;max-width:100%;background-color:#eee;border-radius:8px}
    .slide iframe,.slide img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);background-color:transparent}
    .slide p{margin:10px 0 0;font-size:.9rem;color:#555}
    .slide.active{display:block;animation:fadeIn .5s}
    .slide-nav {
        text-align: center;
        margin-top: 15px;
        display: flex;
        justify-content: space-between; /* Aligns buttons nicely */
        gap: 10px;
    }
    .slide-nav button{background-color:var(--primary);color:#fff;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:.9rem;transition:background-color .3s,transform .2s}
    .slide-nav button:hover{background-color:#4a6cdc;transform:scale(1.05)}
    .step{display:flex;gap:15px;margin-bottom:20px;padding:15px;background-color:#fdfdff;border-radius:10px;align-items:flex-start;border-left:5px solid var(--secondary);box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .step-number{background-color:var(--secondary);color:#fff;min-width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;font-size:.9rem;margin-top:3px}
    .step-content{flex:1;display:flex;flex-direction:column}
    .step-content strong{font-size:1.05rem;color:var(--primary);display:block;margin-bottom:5px}
    .step-content p.description{margin:0 0 15px;font-size:.95rem;color:#333;line-height:1.5}
    .step-content p.description:last-child{margin-bottom:0}
    .step-content .step-media{margin-top:10px;max-width:100%;width:100%;overflow:hidden;border-radius:8px;background-color:#f0f0f0}
    .step-content .step-media img{display:block;max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .step-content .step-media iframe{display:block;width:100%;aspect-ratio:16/9;border:none;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .quiz-question{background-color:#fdfdff;padding:20px;margin-bottom:15px;border-radius:10px;box-shadow:0 2px 8px rgba(94,129,244,.1);border:1px solid #e0e8ff}
    .quiz-question p.question-text{margin:0 0 15px;font-size:1rem;font-weight:700;color:var(--dark)}
    .quiz-options{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .quiz-option{display:block;padding:12px 15px;margin-bottom:0;background-color:#f5f7fa;border:1px solid #d8dde6;border-radius:8px;cursor:pointer;transition:all .3s ease;font-size:.9rem;position:relative;text-align:left;opacity:1}
    .quiz-option:hover{background-color:#e8ecf3;border-color:#c4cde0}
    .quiz-option.selected{border-color:var(--primary);background-color:#e8f0fe}
    .quiz-option.correct{background-color:var(--success);color:#fff;border-color:#63c899;font-weight:700}
    .quiz-option.correct.selected{background-color:var(--success);color:#fff;border-color:#63c899}
    .quiz-option.incorrect.selected{background-color:var(--danger);color:#fff;border-color:#e66a6a;font-weight:700;text-decoration:line-through;text-decoration-thickness:2px;border-color:#e66a6a!important}
    .quiz-question.answered .quiz-option:not(.selected):not(.correct){opacity:.6;cursor:default;background-color:#f5f7fa;border-color:#d8dde6;text-decoration:none}
    .quiz-question.answered .quiz-option.correct:not(.selected){opacity:1}
    .quiz-feedback{margin-top:12px;padding:10px 15px;border-radius:5px;display:none;font-size:.85rem;border-width:1px;border-style:solid}
    .quiz-feedback.correct{background-color:#e6f7ed;color:#1d6c45;border-color:#c3e6cb}
    .quiz-feedback.incorrect{background-color:#fde8e8;color:#9b1c1c;border-color:#f5c6cb}
    .final-quiz-result{margin-top:20px;padding:15px;border-radius:8px;text-align:center;font-weight:700;font-size:1.1rem}
    .final-quiz-result.success{background-color:#e6f7ed;color:#1d6c45;border:1px solid #c3e6cb}
    .final-quiz-result.fail{background-color:#fde8e8;color:#9b1c1c;border:1px solid #f5c6cb}
    .submit-btn{background-color:var(--accent);color:var(--dark);border:none;padding:12px 25px;border-radius:30px;font-weight:700;cursor:pointer;margin-top:25px;font-size:1rem;transition:all .3s;display:block;width:100%;max-width:250px;margin-left:auto;margin-right:auto;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .submit-btn:hover:not(:disabled){background-color:#ffc833;box-shadow:0 4px 8px rgba(0,0,0,.15);transform:translateY(-1px)}
    .submit-btn:disabled{background-color:#ccc;color:#666;cursor:not-allowed;box-shadow:none;transform:none;opacity:.7}

    /* --- Modal Styles (Generic) --- */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);z-index:1000;overflow-y:auto;padding:30px 0}
    .modal-content{background-color:#fff;margin:30px auto;padding:25px 30px;border-radius:10px;width:90%;max-width:800px;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}
    .close-modal{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#aaa;cursor:pointer;line-height:1;z-index:1001;padding:5px}
    .close-modal:hover{color:#333}
    .edit-form{margin-top:20px}
    .edit-form label{display:block;margin-bottom:5px;font-weight:700;color:var(--primary);font-size:.9rem}
    .edit-form input[type=text],.edit-form input[type=url],.edit-form textarea,.edit-form select{width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:5px;font-size:.9rem;box-sizing:border-box}
    .edit-form textarea{resize:vertical;min-height:60px}
    /* General Buttons inside modals */
    .edit-form button, button.remove-item-btn, button.add-item-btn{
         background-color: var(--primary); color: #fff; border: none; padding: 10px 15px; border-radius: 5px;
         cursor: pointer; margin-right: 10px; margin-top: 5px; font-size: .9rem; transition: background-color .3s
    }
    .edit-form button:hover, button.remove-item-btn:hover, button.add-item-btn:hover{ background-color: #4a6cdc }
    /* Save/Cancel specifically */
    .edit-form button[onclick^="save"], .edit-form button[onclick^="closeModal"] { margin-top: 20px; }

    button.remove-item-btn{background-color:var(--danger);margin-left:10px;font-weight:700;line-height:1;padding:6px 10px}
    button.remove-item-btn:hover{background-color:#e66a6a}
    button.add-item-btn{background-color:var(--success);display:block;margin-top:15px;margin-left:0;margin-right:0;width:fit-content}
    button.add-item-btn:hover{background-color:#63c899}
    .edit-section{margin-top:20px;padding-top:15px;border-top:1px solid #eee}
    .edit-item-group{margin-bottom:20px;padding:15px;border:1px solid #ddd;border-radius:8px;background-color:#fdfdff;position:relative}
    .edit-item-group .remove-item-btn{position:absolute;top:10px;right:10px;font-size:1.2rem}
    .edit-item-group>label{font-weight:700;color:var(--dark);font-size:.95rem;margin-top:5px} /* Bold top-level label */
    .edit-item-group label{font-weight:400;color:#555;font-size:.85rem} /* Default labels inside group */
    .edit-item-group input[type=text],.edit-item-group input[type=url],.edit-item-group textarea,.edit-item-group select{margin-bottom:10px}
    .media-controls{margin-top:10px;padding-top:10px;border-top:1px dashed #eee}
    .media-controls label{font-weight:400;color:#555;font-size:.85rem}
    .media-url-input-container { margin-top: 5px; } /* Container for URL input */
    .incorrect-answer-label{font-size:.85rem;color:#777;margin-top:8px;font-weight:400}

    /* Style Editor Sections (Color, Font, Size) - Common Structure for both Modals */
    .color-picker { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; transition: transform .2s, border-color .2s; }
    .color-option.selected { border: 3px solid var(--dark); transform: scale(1.1); }
    input[type=color] { width: 35px; height: 35px; border: none; padding: 0; border-radius: 50%; overflow: hidden; cursor: pointer; vertical-align: middle; }
    .font-selector{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
    .font-option{padding:5px 12px;border:1px solid #ddd;border-radius:4px;cursor:pointer;transition:background-color .3s,color .3s}
    .font-option.selected{background-color:var(--primary);color:#fff;border-color:var(--primary)}
    .size-selector{display:flex;gap:10px;align-items:center;margin-bottom:15px}
    .size-option{padding:5px 12px;border:1px solid #ddd;border-radius:4px;cursor:pointer;transition:background-color .3s,color .3s}
    .size-option.selected{background-color:var(--primary);color:#fff;border-color:var(--primary)}

    /* --- Course Editor Specific Styles --- */
    #courseEditModal #projectTabsEditor { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
    #projectTabsEditor h4 { margin-bottom: 15px; color: var(--primary); display: inline-block; border-bottom: 2px solid var(--secondary); padding-bottom: 5px; }
    #projectTabsList { max-height: 300px; overflow-y: auto; padding-right: 10px;}
    .project-tab-edit-item { display: grid; grid-template-columns: auto 1fr auto; gap: 10px; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 5px; margin-bottom: 10px; }
    .project-tab-edit-item .index { font-weight: bold; }
    .project-tab-edit-item .inputs { display: flex; flex-direction: column; gap: 5px;}
    .project-tab-edit-item label { font-size: 0.8rem; margin-bottom: 2px; color: #555; font-weight: normal;}
    .project-tab-edit-item input { padding: 6px; font-size: 0.85rem;}

    /* Project Editor Specific Styling */
    #projectEditModal .edit-section h4, #courseEditModal .edit-section h4{ /* Specific h4 style inside modal sections */
        color: var(--primary);
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 2px solid var(--secondary);
        display: inline-block;
    }
     #projectEditModal .edit-section h5{ /* Specific h5 style inside modal sections */
        color: var(--dark);
        margin-top: 20px;
        margin-bottom: 8px;
        font-size: 1rem;
     }


    /* --- Media Queries --- */
    @media (min-width:768px){
        .page-header{flex-direction:row;text-align:left;align-items:center;padding:25px;gap:25px}
        #course-view .page-header img.header-image{width:150px;height:150px} /* Course header image */
        .page-header .header-title{font-size:2rem}
        .page-header .header-subtitle{font-size:1.1rem}
        .step{align-items:center}
        .step-number{margin-top:0;width:35px;height:35px;font-size:1rem}
        .step-content .step-media{max-width:70%;margin-left:auto;margin-right:auto}
        #project-view .page-header img.header-image{width:120px;height:120px} /* Project header image */
        #project-view .page-header .header-title{font-size:2rem}
        #project-view .page-header .header-subtitle{font-size:1rem}
        #projectTabs .tab { padding: 10px 20px; font-size: 1rem; } /* Larger project tabs on desktop */
     }
    @media (max-width:600px){
        .container{padding:10px}
        .page-header{padding:15px}
        #projectTabContentContainer .tab-content{padding:15px}
        /* Button positioning on small screens */
        #course-view .page-header .edit-btn { right: 10px; top: 10px; }
        #course-view .page-header .export-btn { right: 55px; top: 10px; }
        #project-view .page-header .edit-btn { right: 10px; top: 10px; }
        #project-view .page-header .back-btn { right: 55px; top: 10px; font-size: 22px; }
        h2{font-size:1.2rem}
        .page-header .header-title{font-size:1.5rem}
        .page-header .header-subtitle{font-size:.9rem}
        .modal-content{padding:20px}
        .step-content .step-media{max-width:100%}
        #project-view .page-header .header-title{font-size:1.4rem}
        #project-view .page-header .header-subtitle{font-size:.9rem}
    }

</style>
</head>
<body>

<!-- Container for the whole application -->
<div class="container">

    <!-- == COURSE VIEW (Visible by default) == -->
    <div id="course-view">
        <div class="page-header" id="course-header">
             <button class="edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details">✏️</button>
             <button class="export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML">⬇️</button>
             <img src="" alt="Course Image" class="header-image" id="courseImage">
             <div class="header-title-container">
                 <h1 class="header-title" id="courseTitle">Course Title</h1>
                 <!-- Course subtitle/short desc could go here if needed -->
             </div>
        </div>

        <div id="course-description-container">
            <h2>About This Course</h2>
            <p id="courseDescription">Loading course description...</p>
        </div>

        <h2>Projects</h2>
        <div id="projectGrid">
            <!-- Project tabs will be dynamically inserted here -->
            <p>Loading projects...</p>
        </div>
    </div>

    <!-- == PROJECT VIEW (Hidden by default) == -->
    <div id="project-view" style="display: none;">
        <!-- Project Header (Populated Dynamically) -->
        <div class="page-header" id="project-header">
            <button class="back-btn" id="backToCourseBtn" onclick="showCourseView()" aria-label="Back to Course">←</button>
            <button class="edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project">✏️</button>
            <!-- Project Export Button REMOVED -->
            <img src="" alt="Project Image" class="header-image" id="projectImage">
            <div class="header-title-container">
                <h1 class="header-title" id="projectTitle">Project Title</h1>
                <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
            </div>
        </div>

        <!-- Existing Project Content Structure (Merged from Project Code) -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="tabs" id="projectTabs">
            <!-- Tabs are dynamically generated or hardcoded if fixed -->
            <!-- Example structure (content loaded dynamically) -->
            <div class="tab active" onclick="openProjectTab('overview', this)">Overview</div>
            <div class="tab" onclick="openProjectTab('video', this)">Video Lesson</div>
            <div class="tab" onclick="openProjectTab('slides', this)">Step-by-Step</div>
            <div class="tab" onclick="openProjectTab('challenges', this)">Challenges</div>
            <div class="tab" onclick="openProjectTab('quiz', this)">Quiz</div>
        </div>
        <div id="projectTabContentContainer">
            <!-- Project Tab Content Templates -->
             <div id="overview" class="tab-content active">
                 <h2>About This Project</h2>
                 <p id="overviewText">Loading overview...</p>
                 <h3>What You'll Learn</h3>
                 <div id="learnContainer"><p>Loading learning objectives...</p></div>
             </div>
             <div id="video" class="tab-content">
                 <h2>Video Lesson</h2>
                 <p id="videoIntroText"></p>
                 <h3 id="videoTitle"></h3>
                 <div class="video-container">
                     <iframe src="" frameborder="0" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="mainVideo" title="Project Video"></iframe>
                 </div>
                 <h3>Key Points</h3>
                 <ul id="videoKeyPoints" style="font-size: 0.9rem; padding-left: 20px; list-style: disc;"><p>Loading key points...</p></ul>
             </div>
             <div id="slides" class="tab-content">
                 <h2>Step-by-Step Guide</h2>
                 <div class="slideshow" id="slideshowContainer"><p>Loading slides...</p></div>
                 <div class="slide-nav">
                     <button onclick="prevSlide()">Previous</button>
                     <button onclick="nextSlide()">Next</button>
                 </div>
             </div>
             <div id="challenges" class="tab-content">
                 <h2>Project Challenges</h2>
                 <p>Try these challenges:</p>
                 <div id="challengesContainer"><p>Loading challenges...</p></div>
             </div>
             <div id="quiz" class="tab-content">
                 <h2>Project Quiz</h2>
                 <p>Test your knowledge:</p>
                 <div id="quizContainer"><p>Loading quiz...</p></div>
                 <!-- Final result area added by script -->
                 <button class="submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz</button>
             </div>
        </div>
    </div>

</div><!-- End .container -->


<!-- ==== MODALS ==== -->

<!-- == COURSE Editor Modal == -->
<div id="courseEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor">&times;</span>
        <h2>Edit Course Details</h2>
        <div class="edit-form">
            <div class="edit-section">
                <h4>Course Metadata</h4>
                <label for="editCourseTitle">Course Title:</label>
                <input type="text" id="editCourseTitle">

                <label for="editCourseImage">Course Header Image URL:</label>
                <input type="url" id="editCourseImage">

                <label for="editCourseDescription">Course Description:</label>
                <textarea id="editCourseDescription" rows="6"></textarea>
            </div>

            <!-- Course Theme Color Editor -->
            <div id="courseStyleEditor" class="edit-section">
                 <h4>Course Theme Colors</h4>
                 <p style="font-size: 0.8rem; color: #666;">Set the main colors used globally unless overridden by a specific project.</p>
                 <label>Primary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('primary', '#5E81F4')"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('primary', '#FF7AC6')"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('primary', '#7CE7AC')"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('primary', '#FFB800')"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('primary', '#9B51E0')"></div>
                     <input type="color" id="coursePrimaryColorPicker" oninput="customCourseColorSelected('primary', this.value)" aria-label="Custom Primary Color">
                 </div>
                 <label>Secondary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('secondary', '#5E81F4')"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('secondary', '#FF7AC6')"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('secondary', '#7CE7AC')"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('secondary', '#FFB800')"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('secondary', '#9B51E0')"></div>
                     <input type="color" id="courseSecondaryColorPicker" oninput="customCourseColorSelected('secondary', this.value)" aria-label="Custom Secondary Color">
                 </div>
                 <label>Accent Color:</label>
                 <div class="color-picker">
                      <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('accent', '#FFB800')"></div>
                      <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('accent', '#FF7AC6')"></div>
                      <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('accent', '#7CE7AC')"></div>
                      <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('accent', '#5E81F4')"></div>
                      <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('accent', '#9B51E0')"></div>
                     <input type="color" id="courseAccentColorPicker" oninput="customCourseColorSelected('accent', this.value)" aria-label="Custom Accent Color">
                 </div>
            </div>

            <!-- Project Tabs Editor -->
            <div id="projectTabsEditor" class="edit-section">
                 <h4>Manage Project Tabs</h4>
                 <div id="projectTabsList">
                     <!-- Project tab edit items will be listed here -->
                 </div>
                 <button type="button" class="add-item-btn" onclick="addProjectTabEditField()">Add New Project Tab</button>
            </div>

            <hr style="margin: 25px 0;">
            <button type="button" onclick="saveCourseChanges()" style="background-color: var(--success); margin-right: 15px;">Save Course</button>
            <button type="button" onclick="closeModal('courseEditModal')" style="background-color: #aaa;">Cancel</button>
        </div>
    </div>
</div>


<!-- == PROJECT Editor Modal (Merged) == -->
<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor">&times;</span>
        <h2>Edit Project Details</h2>
         <p style="font-size: 0.85rem; color: #666;">Editing project: <strong id="editingProjectNameLabel"></strong></p>
        <div class="edit-form">
             <input type="hidden" id="editingProjectId"> <!-- Store ID of project being edited -->

            <label for="editSectionProject">Select Section to Edit:</label>
            <select id="editSectionProject" onchange="showProjectEditSection()">
                <option value="projMeta">Project Header & Course Tab</option>
                <option value="overview">Overview & Learn</option>
                <option value="video">Video Lesson</option>
                <option value="slides">Step-by-Step Slides</option>
                <option value="challenges">Challenges</option>
                <option value="quiz">Quiz Questions</option>
                <option value="projStyle">Project Styles (Font, Size, Colors)</option>
            </select>

            <!-- === Project Metadata Edit (Project Modal: Title, Subtitle, Header Image, Tab Name, Tab Image) === -->
            <div id="projMetaEdit" class="edit-section">
                 <h4>Project Header & Course Tab</h4>
                <label for="editProject_Title">Project Title:</label>
                <input type="text" id="editProject_Title">
                <label for="editProject_Subtitle">Subtitle:</label>
                <input type="text" id="editProject_Subtitle">
                <label for="editProject_HeaderImage">Project Header Image URL:</label>
                <input type="url" id="editProject_HeaderImage">
                <p style="font-size: 0.8rem; color: #666;">Appears on the project page. ~100x100px recommended.</p>
                 <hr style="margin: 15px 0;">
                 <label for="editProject_TabName">Tab Name (on Course Page):</label>
                 <input type="text" id="editProject_TabName">
                 <label for="editProject_TabImage">Tab Image URL (on Course Page):</label>
                 <input type="url" id="editProject_TabImage">
                 <p style="font-size: 0.8rem; color: #666;">Appears on the main course grid. Square image (~300x300px) recommended.</p>
            </div>

            <!-- === Overview & Learn Edit (Project Modal) === -->
            <div id="overviewEdit" class="edit-section" style="display:none;">
                 <h4>Overview Content</h4>
                <label for="editProject_OverviewText">Overview Text:</label>
                <textarea id="editProject_OverviewText" rows="5"></textarea>
                 <hr style="margin: 20px 0;">
                  <h4>"What You'll Learn" Items</h4>
                  <p style="font-size: 0.8rem; color: #666;">Add key learning objectives. Optionally include media.</p>
                  <div id="learnEditContainer"> <!-- Populated by loadLearnEditFieldsForProject --> </div>
                  <button type="button" class="add-item-btn" onclick="addLearnEditField()">Add Learning Item</button>
            </div>

            <!-- === Video Edit (Project Modal) === -->
            <div id="videoEdit" class="edit-section" style="display:none;">
                 <h4>Video Lesson Content</h4>
                 <label for="editProject_VideoIntroText">Introduction Text (Above Video):</label>
                 <input type="text" id="editProject_VideoIntroText">
                 <label for="editProject_VideoTitle">Video Section Title (Above Video):</label>
                 <input type="text" id="editProject_VideoTitle">
                 <label for="editProject_VideoUrl">Video Embed URL:</label>
                 <input type="url" id="editProject_VideoUrl" placeholder="e.g., https://www.youtube.com/embed/VIDEO_ID">
                 <label for="editProject_VideoKeyPoints">Key Points (one per line, below video):</label>
                 <textarea id="editProject_VideoKeyPoints" rows="5"></textarea>
            </div>

            <!-- === Slides Edit (Project Modal) === -->
            <div id="slidesEdit" class="edit-section" style="display:none;">
                <h4>Step-by-Step Slides</h4>
                <p style="font-size: 0.8rem; color: #666;">Add slides with multimedia content (image or embed URL). Max 10 slides.</p>
                <div id="slidesEditContainer"> <!-- Populated by loadSlidesEditFieldsForProject --> </div>
                <button type="button" class="add-item-btn" onclick="addSlideEditField()">Add Slide</button>
            </div>

            <!-- === Challenges Edit (Project Modal) === -->
            <div id="challengesEdit" class="edit-section" style="display:none;">
                <h4>Project Challenges</h4>
                <p style="font-size: 0.8rem; color: #666;">Add challenges for users, optionally with an image or video. Max 10 challenges.</p>
                <div id="challengesEditContainer"> <!-- Populated by loadChallengesEditFieldsForProject --> </div>
                <button type="button" class="add-item-btn" onclick="addChallengeEditField()">Add Challenge</button>
            </div>

            <!-- === Quiz Edit (Project Modal) === -->
            <div id="quizEdit" class="edit-section" style="display:none;">
                <h4>Quiz Questions</h4>
                <p style="font-size: 0.8rem; color: #666;">Add questions. Mark one answer as correct. Provide 2-3 incorrect options. Max 10 questions.</p>
                 <div id="quizEditContainer"> <!-- Populated by loadQuizEditFieldsForProject --> </div>
                 <button type="button" class="add-item-btn" onclick="addQuizEditField()">Add Question</button>
            </div>

            <!-- === Project Style Edit (Project Modal) === -->
            <div id="projStyleEdit" class="edit-section" style="display:none;">
                 <h4>Project Specific Styles</h4>
                 <p style="font-size: 0.8rem; color: #666;">Optionally override the global course styles just for this project.</p>

                 <h5>Color Overrides</h5>
                 <p style="font-size: 0.8rem; color: #666;">Select colors below to override the main course theme for this project only. Leave as default (or clear custom) to use course colors.</p>
                  <button type="button" onclick="clearProjectColorOverrides()" style="font-size: 0.8rem; padding: 4px 8px; margin-bottom: 15px; background-color: #bbb;">Use Course Default Colors</button>

                 <label>Project Primary Color Override:</label>
                 <div class="color-picker" id="projectPrimaryColorPickerContainer">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('primary', '#5E81F4')"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('primary', '#FF7AC6')"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('primary', '#7CE7AC')"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('primary', '#FFB800')"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('primary', '#9B51E0')"></div>
                     <input type="color" id="projectPrimaryColorPicker" oninput="customProjectColorSelected('primary', this.value)" aria-label="Custom Project Primary Color">
                 </div>
                 <label>Project Secondary Color Override:</label>
                 <div class="color-picker" id="projectSecondaryColorPickerContainer">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('secondary', '#5E81F4')"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('secondary', '#FF7AC6')"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('secondary', '#7CE7AC')"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('secondary', '#FFB800')"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('secondary', '#9B51E0')"></div>
                     <input type="color" id="projectSecondaryColorPicker" oninput="customProjectColorSelected('secondary', this.value)" aria-label="Custom Project Secondary Color">
                 </div>
                 <label>Project Accent Color Override:</label>
                 <div class="color-picker" id="projectAccentColorPickerContainer">
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('accent', '#FFB800')"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('accent', '#FF7AC6')"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('accent', '#7CE7AC')"></div>
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('accent', '#5E81F4')"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('accent', '#9B51E0')"></div>
                     <input type="color" id="projectAccentColorPicker" oninput="customProjectColorSelected('accent', this.value)" aria-label="Custom Project Accent Color">
                 </div>

                 <h5 style="margin-top: 25px;">Font & Size Override</h5>
                 <label>Font Family Override:</label>
                 <div class="font-selector" id="projectFontSelector">
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', null)" >Use Course Default</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Segoe UI', sans-serif`)" style="font-family: 'Segoe UI', sans-serif;">Segoe UI</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Arial', Helvetica, sans-serif`)" style="font-family: Arial, sans-serif;">Arial</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Georgia', 'Times New Roman', serif`)" style="font-family: Georgia, serif;">Georgia</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Courier New', monospace`)" style="font-family: 'Courier New', monospace;">Courier New</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Verdana', Geneva, sans-serif`)" style="font-family: Verdana, sans-serif;">Verdana</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Comic Sans MS', cursive, sans-serif`)" style="font-family: 'Comic Sans MS', cursive;">Comic Sans</div>
                 </div>

                 <label>Base Text Size Override:</label>
                 <div class="size-selector" id="projectSizeSelector">
                      <div class="size-option" onclick="selectProjectStyle('baseSize', null)">Use Course Default</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'small')">Small (14px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'medium')">Medium (16px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'large')">Large (18px)</div>
                 </div>
            </div>

            <hr style="margin: 25px 0;">
            <button type="button" onclick="saveProjectChanges()" style="background-color: var(--success); margin-right: 15px;">Save Project</button>
            <button type="button" onclick="closeModal('projectEditModal')" style="background-color: #aaa;">Cancel</button>
        </div>
    </div>
</div>


<script>
    // --- Global Data Storage ---
    let courseData = {
        title: "Micro:bit Adventures",
        description: "Explore the exciting world of physical computing with the BBC micro:bit! This course contains several projects to get you started.",
        imageUrl: "https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60",
        // Course-level theme colors
        style: {
            primaryColor: '#5E81F4',
            secondaryColor: '#FF7AC6',
            accentColor: '#FFB800',
            // No course-level font/size needed here, defaults in :root CSS
        },
        projects: [
            // Project 1: Beating Heart (Data merged from project page)
            {
                id: 'proj_heart',
                tabName: "Beating Heart",
                tabImage: "https://www.elecfreaks.com/wp-content/uploads/2022/12/2-1.png",
                projectTitle: "Beating Heart Project",
                projectSubtitle: "Make your Micro:bit display a beating heart animation!",
                projectHeaderImage: "https://www.elecfreaks.com/wp-content/uploads/2022/12/2-1.png",
                overviewText: "In this project, you'll learn how to create a beating heart animation on your Micro:bit's LED display. This is a great first project to understand how the Micro:bit works!",
                videoIntroText: "Watch this video to learn how to create the beating heart animation:",
                videoTitle: "Programming the Beating Heart",
                videoUrl: "https://www.youtube.com/embed/2yzT7_QGLLc",
                videoKeyPoints: [
                    "The LED matrix has 25 lights (5 rows x 5 columns)",
                    "'on start' runs once when the Micro:bit turns on",
                    "'forever' keeps repeating the code inside it",
                    "We use 'show icon'/'show leds' and 'pause' blocks to create animation"
                ],
                learnData: [
                    { title: "Hardware Basics", description: "Understand the Micro:bit LED matrix (5x5 grid) and how to connect & flash code.", mediaType: 'image', mediaUrl: 'https://images.prismic.io/circuito/749f1698-88a8-4e1d-8173-f45b055a214c_microbit+pinout+diagram.png?auto=compress,format' },
                    { title: "Core Programming Blocks", description: "Learn the difference between 'on start' (runs once) and 'forever' (loops continuously).", mediaType: 'none', mediaUrl: '' },
                    { title: "Animation Technique", description: "Use 'show leds' or 'show icon' combined with 'pause' blocks to create the illusion of movement.", mediaType: 'none', mediaUrl: '' },
                    { title: "Computational Thinking: Sequencing", description: "Understand that the order of blocks matters for the animation to work correctly.", mediaType: 'none', mediaUrl: '' }
                ],
                slidesData: [
                    { url: "https://view.genially.com/67de49ded67908621a726b03", description: "1. Introduction to the Beating Heart project", type: "iframe" },
                    { url: "https://view.genially.com/67de49e4ab31ac746b27c48b", description: "2. Setting up your Micro:bit environment", type: "iframe" },
                    { url: "https://clearinghouse.starnetlibraries.org/images/525/microbit-heart.jpg", description: "3. Programming the Beating Heart animation", type: "image" },
                ],
                challengesData: [
                    { title: "Faster or Slower?", description: "Change the pause times (milliseconds) in the code to speed up or slow down the heartbeat.", mediaType: 'none', mediaUrl: '' },
                    { title: "Different Animation", description: "Try creating a different simple animation, like a blinking smiley face or a flashing arrow.", mediaType: 'image', mediaUrl: 'https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png' },
                    { title: "Button Control", description: "Modify the code so the animation only plays when Button A is pressed.", mediaType: 'none', mediaUrl: '' },
                ],
                quizData: [
                    { questionText: "What block makes code run repeatedly forever?", correctAnswer: "'forever' loop", incorrectAnswers: ["'on start' block", "'pause (ms)' block", "'show leds' block"] },
                    { questionText: "How many individual LEDs are on the Micro:bit display?", correctAnswer: "25 (a 5x5 grid)", incorrectAnswers: ["10", "5", "100"] },
                    { questionText: "To create an animation, you typically show something, then...", correctAnswer: "Pause, then show something different", incorrectAnswers: ["Immediately show something different", "Stop the program", "Shake the Micro:bit"] },
                    { questionText: "What does the 'pause (ms)' block measure time in?", correctAnswer: "Milliseconds (1/1000th of a second)", incorrectAnswers: ["Seconds", "Minutes", "Microseconds"] }
                ],
                // Project specific style overrides (null = inherit from course)
                style: {
                    fontFamily: `'Comic Sans MS', cursive, sans-serif`, // Override example
                    baseSize: null, // Inherit size
                    primaryColor: '#7CE7AC', // Green Primary for this project only
                    secondaryColor: null,     // Inherit Secondary from course
                    accentColor: null         // Inherit Accent from course
                 },
                 isCompleted: false // Completion flag
            },
            // Project 2: Smiley Buttons (Basic data for structure)
            {
                 id: 'proj_smiley',
                 tabName: "Smiley Buttons",
                 tabImage: "https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png",
                 projectTitle: "Smiley Buttons Project",
                 projectSubtitle: "Show different faces when buttons are pressed.",
                 projectHeaderImage: "https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png",
                 overviewText: "Learn how to react to button presses using 'if' conditions and input blocks.",
                 videoIntroText: "This section might have a video.",
                 videoTitle: "Button Input Basics",
                 videoUrl: "", // No video URL provided
                 videoKeyPoints: ["Use 'on button A pressed'", "Use 'if...then...else' for choices"],
                 learnData: [
                     {title:"Input Events", description:"Using 'on button A pressed'", mediaType:'none', mediaUrl:''},
                     {title:"Conditional Logic", description:"Using 'if...then...else' blocks", mediaType:'none', mediaUrl:''}
                  ],
                 slidesData: [], // No slides for this example
                 challengesData: [
                     {title: "Show on Both Buttons", description: "Make it show a surprise face when A+B buttons are pressed together.", mediaType:'none', mediaUrl:''}
                 ],
                 quizData: [
                     {questionText: "Which block detects Button A being clicked?", correctAnswer:"'on button A pressed'", incorrectAnswers:["'forever'", "'show leds'"]}
                 ],
                 // Default style (inherits all from course)
                 style: {
                     fontFamily: null,
                     baseSize: null,
                     primaryColor: null,
                     secondaryColor: null,
                     accentColor: null
                 },
                 isCompleted: false
             }
            // Add more project objects here...
        ]
    };

    // State variables
    let currentProjectId = null; // ID of the project being viewed/edited
    let currentProjectDataCache = null; // Temporary store for project data during editing
    let currentSlideIndex = 0;

    // --- Constants for limits ---
    const MAX_PROJECTS = 9; const MAX_SLIDES = 10; const MAX_CHALLENGES = 10;
    const MAX_LEARN_ITEMS = 8; const MAX_QUIZ_QUESTIONS = 10; const MAX_INCORRECT_ANSWERS = 3;

    // --- THEME APPLICATION ---
    function applyCourseTheme() {
        console.log("Applying COURSE theme");
        const root = document.documentElement;
        const courseStyle = courseData.style || {};
        root.style.setProperty('--primary', courseStyle.primaryColor || '#5E81F4');
        root.style.setProperty('--secondary', courseStyle.secondaryColor || '#FF7AC6');
        root.style.setProperty('--accent', courseStyle.accentColor || '#FFB800');

        // Apply global font/size defaults (these vars are used by body style)
        root.style.setProperty('--base-font-family', `'Segoe UI', sans-serif`); // Course default font
        root.style.setProperty('--base-font-size', '16px'); // Course default size

        // Ensure project-specific inline styles are cleared when returning to course view
        const projectViewEl = document.getElementById('project-view');
         if (projectViewEl) {
             projectViewEl.style.fontFamily = '';
             projectViewEl.style.fontSize = '';
        }
    }

    function applyProjectSpecificStyles(project) {
        if (!project) return;
        console.log("Applying PROJECT specific styles (if any) for:", project.id);
        const root = document.documentElement; // Apply overrides globally for simplicity
        const projectStyle = project.style || {};
        const courseStyle = courseData.style || {}; // Fallback to course style

        // Apply Color Overrides (only if defined in project style, otherwise use course)
        root.style.setProperty('--primary', projectStyle.primaryColor || courseStyle.primaryColor || '#5E81F4');
        root.style.setProperty('--secondary', projectStyle.secondaryColor || courseStyle.secondaryColor || '#FF7AC6');
        root.style.setProperty('--accent', projectStyle.accentColor || courseStyle.accentColor || '#FFB800');

        // Apply Font Family Override (directly on #project-view element)
        const projectViewEl = document.getElementById('project-view');
        if (projectViewEl) {
             const projectFont = projectStyle.fontFamily; // Can be null
             // Use project font if set, otherwise fall back to the CSS variable (which reflects course default)
             projectViewEl.style.fontFamily = projectFont ? projectFont : 'var(--base-font-family)';
        }


        // Apply Base Size Override (directly on #project-view element)
        if (projectViewEl) {
             const projectSize = projectStyle.baseSize; // Can be null, 'small', 'medium', 'large'
             let effectiveFontSize = 'var(--base-font-size)'; // Use CSS variable (reflects course default) by default
             if (projectSize === 'small') effectiveFontSize = '14px';
             else if (projectSize === 'large') effectiveFontSize = '18px';
             else if (projectSize === 'medium') effectiveFontSize = '16px'; // Explicit medium override

             projectViewEl.style.fontSize = effectiveFontSize;
        }
    }


    // --- VIEW NAVIGATION ---
    function showCourseView() {
        document.getElementById('course-view').style.display = 'block';
        document.getElementById('project-view').style.display = 'none';
        currentProjectId = null;
        currentProjectDataCache = null;
        document.title = courseData.title || "Course Viewer";
        applyCourseTheme(); // Reset theme to course defaults
        renderCoursePage(); // Re-render to show updated completion ticks
        window.scrollTo(0, 0);
    }

    function showProjectView(projectId) {
        const project = courseData.projects.find(p => p.id === projectId);
        if (!project) {
            console.error(`Project with ID ${projectId} not found!`);
            showCourseView(); // Go back if project doesn't exist
            return;
        }

        currentProjectId = projectId;
        // DO NOT cache here for viewing, only for editing. Render directly from courseData.
        // currentProjectDataCache = JSON.parse(JSON.stringify(project)); // DEEP CLONE for editing later

        renderProjectPage(project); // Populate the project view template with data

        document.getElementById('course-view').style.display = 'none';
        document.getElementById('project-view').style.display = 'block';
        document.title = project.projectTitle || "Project Viewer";

        // Apply course theme first, then project-specific overrides
        applyCourseTheme();
        applyProjectSpecificStyles(project);

        window.scrollTo(0, 0);
    }


    // --- COURSE PAGE RENDERING ---
    function renderCoursePage() {
        console.log("Rendering Course Page");
        const course = courseData;

        // Update Course Header
        document.getElementById('courseTitle').textContent = course.title;
        const courseImg = document.getElementById('courseImage');
        if(courseImg) { courseImg.src = course.imageUrl || ''; courseImg.alt = course.title + " Image"; }
        document.getElementById('courseDescription').textContent = course.description;

        const grid = document.getElementById('projectGrid');
        grid.innerHTML = ''; // Clear existing

        if (!course.projects || course.projects.length === 0) {
            grid.innerHTML = '<p>No projects have been added to this course yet.</p>';
            return;
        }

        course.projects.forEach(project => {
            if (!project || !project.id) return; // Skip if project or ID is missing

            const tab = document.createElement('a');
            tab.className = 'project-tab';
            tab.href = `#project-${project.id}`;
            // Prevent default link behavior, use JS navigation
            tab.onclick = (event) => { event.preventDefault(); showProjectView(project.id); };

            const img = document.createElement('img');
            img.src = project.tabImage || 'https://via.placeholder.com/300x200/eee/999?text=Project';
            img.alt = project.tabName || 'Project Tab';
            img.loading = 'lazy';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-tab-info';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = project.tabName || 'Unnamed Project';
            infoDiv.appendChild(nameSpan);

            tab.appendChild(img);
            tab.appendChild(infoDiv);

            // Add completion tick if project is completed
            if (project.isCompleted) {
                const tick = document.createElement('span');
                tick.className = 'completion-tick';
                tick.innerHTML = '&#10004;'; // Checkmark symbol
                tick.setAttribute('aria-label', 'Project Completed');
                tab.appendChild(tick);
            }

            grid.appendChild(tab);
        });
    }


    // --- PROJECT PAGE RENDERING ---
    function renderProjectPage(project) {
        console.log("Rendering Project:", project?.projectTitle);
        if (!project) {
            console.error("renderProjectPage called with null project");
            return;
        }

        const projectView = document.getElementById('project-view');
        if (!projectView) return;

        // Populate Project Header
        const projectHeader = projectView.querySelector('#project-header');
        if (projectHeader) {
            projectHeader.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || 'https://via.placeholder.com/100x100/eee/999?text=Proj';
            projectHeader.querySelector('#projectImage').alt = project.projectTitle + " Header Image";
            projectHeader.querySelector('#projectTitle').textContent = project.projectTitle || 'Project Title';
            projectHeader.querySelector('#projectSubtitle').textContent = project.projectSubtitle || '';
        }

        // -- Populate Project Tab Content --
        const contentContainer = projectView.querySelector('#projectTabContentContainer');
        if (!contentContainer) return;

        // Overview Tab
        const overviewContent = contentContainer.querySelector('#overview');
        if (overviewContent) {
            overviewContent.querySelector('#overviewText').textContent = project.overviewText || 'No overview provided.';
            renderLearnItemsForProject(project.learnData || [], overviewContent.querySelector('#learnContainer'));
        } else { console.warn("Overview content area not found"); }

        // Video Tab
        const videoContent = contentContainer.querySelector('#video');
        if (videoContent) {
             const videoIframe = videoContent.querySelector('#mainVideo');
             const keyPointsUL = videoContent.querySelector('#videoKeyPoints');
             videoContent.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
             videoContent.querySelector('#videoTitle').textContent = project.videoTitle || '';
             if(videoIframe) videoIframe.src = project.videoUrl || '';
             if(keyPointsUL) {
                 keyPointsUL.innerHTML = ''; // Clear old points
                 if (project.videoKeyPoints && project.videoKeyPoints.length > 0) {
                     project.videoKeyPoints.forEach(p => {
                          if (p && p.trim()) {
                              const li = document.createElement('li'); li.textContent = p; keyPointsUL.appendChild(li);
                          }
                     });
                 }
                 if (keyPointsUL.innerHTML === '') keyPointsUL.innerHTML = '<li>No key points provided.</li>';
             }
        } else { console.warn("Video content area not found"); }

        // Slides Tab
        const slidesContent = contentContainer.querySelector('#slides');
        if (slidesContent) {
            renderSlideshowForProject(project.slidesData || [], slidesContent.querySelector('#slideshowContainer'));
        } else { console.warn("Slides content area not found"); }

        // Challenges Tab
        const challengesContent = contentContainer.querySelector('#challenges');
        if (challengesContent) {
            renderChallengesForProject(project.challengesData || [], challengesContent.querySelector('#challengesContainer'));
        } else { console.warn("Challenges content area not found"); }

        // Quiz Tab
        const quizContent = contentContainer.querySelector('#quiz');
        if (quizContent) {
             renderQuizForProject(project.quizData || [], quizContent.querySelector('#quizContainer'), quizContent.querySelector('#submitQuizBtn'));
        } else { console.warn("Quiz content area not found"); }

        // Activate the first project tab ('Overview') and update progress
        const projectTabsBar = projectView.querySelector('#projectTabs');
        if (projectTabsBar) {
             const firstProjectTabButton = projectTabsBar.querySelector('.tab'); // Assume first is Overview
             if (firstProjectTabButton) {
                  // Find the tabName from the first button's onclick
                  const clickAttr = firstProjectTabButton.getAttribute('onclick') || '';
                  const match = clickAttr.match(/openProjectTab\('([^']+)'/);
                  const firstTabName = match ? match[1] : 'overview'; // Default to overview if parsing fails
                  openProjectTab(firstTabName, firstProjectTabButton);
             } else {
                  updateProjectProgressBar(''); // Reset progress if no tabs
             }
        }
    }


    // --- Project Specific Content Rendering Helpers ---
    function renderLearnItemsForProject(learnItemsData, container) {
         if (!container) return; container.innerHTML = '';
         const validItems = (learnItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p>No learning objectives specified.</p>'; return; }
         validItems.forEach((item, index) => {
             const el = document.createElement('div'); el.className = 'step'; // Use step styling
             el.innerHTML = `<div class="step-number">${index + 1}</div>
                             <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
             if(item.description) el.querySelector('p.description').textContent = item.description;

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                 mediaDiv.style.display = 'block';
                 const url = item.mediaUrl.trim();
                 const title = item.title || 'Media';
                 if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                 else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             }
             container.appendChild(el);
         });
    }

    function renderChallengesForProject(challengesItemsData, container) {
         if (!container) return; container.innerHTML = '';
         const validItems = (challengesItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p>No challenges specified for this project.</p>'; return; }
         validItems.forEach((item) => {
             const el = document.createElement('div'); el.className = 'step';
             el.innerHTML = `<div class="step-number" style="background-color: var(--accent); color: var(--dark);">★</div>
                              <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
            if(item.description) el.querySelector('p.description').textContent = item.description;

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                 mediaDiv.style.display = 'block';
                 const url = item.mediaUrl.trim();
                 const title = item.title || 'Media';
                 if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                 else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             }
             container.appendChild(el);
         });
    }

     function renderSlideshowForProject(slidesItemsData, container) {
         const slidesView = container?.closest('.tab-content#slides'); // Get parent tab content
         const nav = slidesView?.querySelector('.slide-nav'); // Find nav within the slides tab
         if (!container || !nav) { console.error("Slideshow container or nav not found"); return; }
         container.innerHTML = '';
         const validSlides = (slidesItemsData || []).filter(slide => slide.url && slide.url.trim());

         if (validSlides.length === 0) {
             container.innerHTML = '<p>No slides available for this project.</p>';
             nav.style.display = 'none'; // Hide nav if no slides
             return;
         }

         nav.style.display = 'flex'; // Ensure nav is visible
         validSlides.forEach((slide, index) => {
             const slideDiv = document.createElement('div'); slideDiv.className = 'slide';
             const contentType = slide.type === 'image' ? 'image' : 'iframe';
             const url = slide.url.trim();
             const title = slide.description || `Slide ${index + 1}`;

             slideDiv.innerHTML = `<div class="slide-content-wrapper"></div>${slide.description ? '<p></p>' : ''}`;
             const wrapper = slideDiv.querySelector('.slide-content-wrapper');
             if (contentType === 'iframe') {
                 wrapper.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             } else if (contentType === 'image') {
                 wrapper.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
             }
             if (slide.description) slideDiv.querySelector('p').textContent = slide.description;

             container.appendChild(slideDiv);
         });

         currentSlideIndex = 0;
         showSlide(currentSlideIndex); // Show the first slide
     }

      function renderQuizForProject(quizItemsData, container, submitBtn) {
          if (!container || !submitBtn) { console.error("Quiz container or submit btn not found"); return; }
          container.innerHTML = ''; // Clear previous quiz
          // Remove any previous final result message within the quiz tab content
          container.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();

          submitBtn.disabled = false; // Re-enable button
          submitBtn.style.display = 'none'; // Hide initially

          const validQuestions = (quizItemsData || []).filter(q => q.questionText && q.questionText.trim() && q.correctAnswer && q.correctAnswer.trim());

          if (validQuestions.length === 0) {
              container.innerHTML = '<p>No quiz questions available for this project.</p>';
              return; // Keep button hidden
          }

          submitBtn.style.display = 'block'; // Show submit button only if questions exist

          validQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>`;
                questionDiv.querySelector('.question-text').textContent = `${index + 1}. ${q.questionText}`;
                const optionsDiv = questionDiv.querySelector('.quiz-options');

                // Combine correct and valid incorrect answers
                let options = [q.correctAnswer.trim()];
                 (q.incorrectAnswers || []).forEach(ans => { if (ans && ans.trim()) options.push(ans.trim()); });

                shuffleArray(options); // Randomize option order

                options.forEach((optionText) => {
                    const isCorrect = (optionText === q.correctAnswer.trim());
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = optionText;
                    optionEl.setAttribute('role', 'button');
                    optionEl.setAttribute('tabindex', '0');
                    optionEl.onclick = () => selectQuizOption(optionEl);
                    optionEl.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(optionEl); }};
                    optionEl.setAttribute('data-is-correct', isCorrect.toString());
                    optionsDiv.appendChild(optionEl);
                });
               container.appendChild(questionDiv);
          });
      }

    // --- Project-Specific Tab/Progress/Slides/Quiz Interaction ---
    function openProjectTab(tabName, element) {
        const container = document.getElementById('projectTabContentContainer');
        if (!container) return;
        container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        const buttonsContainer = document.getElementById('projectTabs');
        if (buttonsContainer) buttonsContainer.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        const targetContent = container.querySelector('#' + tabName);
        if (targetContent) targetContent.classList.add('active');
        element?.classList.add('active');
        updateProjectProgressBar(tabName);
    }

    function updateProjectProgressBar(tabName) {
         const progressBar = document.getElementById('progressBar');
         if (!progressBar) return;
         let progress = 0;
         const tabOrder = ['overview', 'video', 'slides', 'challenges', 'quiz'];
         const tabIndex = tabOrder.indexOf(tabName);
         if (tabIndex >= 0) {
             progress = ((tabIndex + 1) / tabOrder.length) * 100;
         }
         progressBar.style.width = progress + '%';
    }

    function showSlide(n) {
        const slides = document.querySelectorAll('#project-view #slideshowContainer .slide');
        const validSlidesCount = slides.length;
        if (validSlidesCount === 0) return;

        slides.forEach(slide => slide.classList.remove('active'));
        currentSlideIndex = (n % validSlidesCount + validSlidesCount) % validSlidesCount;
        if(slides[currentSlideIndex]) {
            slides[currentSlideIndex].classList.add('active');
        }
    }
    function nextSlide() { showSlide(currentSlideIndex + 1); }
    function prevSlide() { showSlide(currentSlideIndex - 1); }

    function selectQuizOption(optionElement) {
        const questionDiv = optionElement.closest('.quiz-question');
        if (!questionDiv || questionDiv.classList.contains('answered')) return;
        questionDiv.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
        optionElement.classList.add('selected');
    }

    function submitQuiz() {
         const questions = document.querySelectorAll('#project-view #quizContainer .quiz-question');
         let answeredCount = 0, score = 0;
         const totalQuestions = questions.length;
         if (totalQuestions === 0) return;

         let firstUnanswered = null;

         // 1. Check if all questions are answered and reset styles
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              qDiv.classList.remove('answered'); // Reset state
              qDiv.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none');
              qDiv.querySelectorAll('.quiz-option').forEach(opt => {
                   opt.classList.remove('correct', 'incorrect');
                   opt.style.opacity = '1';
                   opt.style.cursor = 'pointer';
                   opt.onclick = () => selectQuizOption(opt); // Re-attach click
                   opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); }};
              });
              if (selectedOption) {
                   answeredCount++;
              } else if (!firstUnanswered) {
                   firstUnanswered = qDiv;
              }
         });

         // 2. Stop if not all answered
         if (answeredCount < totalQuestions) {
             alert(`Please answer all ${totalQuestions} questions before submitting!`);
             if(firstUnanswered) {
                 firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});
                 firstUnanswered.style.outline='2px solid var(--danger)';
                 setTimeout(()=> { if(firstUnanswered) firstUnanswered.style.outline=''; }, 2500);
             }
             return;
         }

         // 3. Grade the Quiz
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              const feedbackCorrect = qDiv.querySelector('.quiz-feedback.correct');
              const feedbackIncorrect = qDiv.querySelector('.quiz-feedback.incorrect');
              const allOptions = qDiv.querySelectorAll('.quiz-option');

              qDiv.classList.add('answered'); // Mark as answered for display
              const isSelectedCorrect = selectedOption.getAttribute('data-is-correct') === 'true';

              // Disable interactions and style options
              allOptions.forEach(opt => {
                   const optIsCorrect = opt.getAttribute('data-is-correct') === 'true';
                   if (optIsCorrect) opt.classList.add('correct');
                   if (opt === selectedOption) {
                       if (!isSelectedCorrect) opt.classList.add('incorrect');
                   } else if (!optIsCorrect) {
                        opt.style.opacity = "0.6";
                   }
                   opt.style.cursor = "default";
                   opt.onclick = null; opt.onkeydown = null; // Disable interactions
              });

              // Provide feedback
              if (isSelectedCorrect) {
                    score++;
                    if(feedbackCorrect) feedbackCorrect.style.display='block';
              } else {
                  if(feedbackIncorrect) {
                      const correctOptionElement = qDiv.querySelector('.quiz-option.correct');
                      feedbackIncorrect.textContent = `Not quite. The correct answer was: "${correctOptionElement ? correctOptionElement.textContent : 'N/A'}".`;
                      feedbackIncorrect.style.display='block';
                  }
              }
         });

         // 4. Show Final Result & Mark Complete
         const submitBtn = document.querySelector('#project-view #submitQuizBtn');
         if(submitBtn) submitBtn.disabled = true;

         const quizTabContent = document.querySelector('#project-view #quiz'); // Find the quiz tab content div
         let resultDiv = quizTabContent?.querySelector('.final-quiz-result');
         if (!resultDiv && quizTabContent) { // Create if doesn't exist, append inside tab content
              resultDiv = document.createElement('div');
              quizTabContent.appendChild(resultDiv);
          }

          if (resultDiv) {
              const scorePercent = totalQuestions > 0 ? score / totalQuestions : 0;
              resultDiv.textContent = `Quiz Complete! You scored ${score} out of ${totalQuestions}!`;
              resultDiv.className = 'final-quiz-result ' + (scorePercent >= 0.7 ? 'success' : 'fail');
              resultDiv.style.display = 'block';
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

              // Mark project as completed if quiz was passed
              if (scorePercent >= 0.7 && currentProjectId) {
                  markProjectAsCompleted(currentProjectId);
                  // The visual update (tick mark) happens when navigating back to course view
              }
          }
    }

     function markProjectAsCompleted(projectId) {
         const project = courseData.projects.find(p => p.id === projectId);
         if (project && !project.isCompleted) {
             console.log(`Marking project ${projectId} as completed.`);
             project.isCompleted = true;
             // Save persistence could be added here if needed (e.g., localStorage)
         }
     }

    // --- MODAL & EDITING LOGIC ---

    // General Modal Controls
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'none';
    }

    // --- Course Editor ---
    function openCourseEditModal() {
         const modal = document.getElementById('courseEditModal');
         if (!modal) return;
         // Load existing course data into fields
         modal.querySelector('#editCourseTitle').value = courseData.title || '';
         modal.querySelector('#editCourseImage').value = courseData.imageUrl || '';
         modal.querySelector('#editCourseDescription').value = courseData.description || '';
         renderProjectTabsEditor(); // Render the list of projects for management
         loadCourseColorSelections(); // Load current course colors into pickers
         modal.style.display = 'block';
    }

     function renderProjectTabsEditor() {
         const listContainer = document.getElementById('projectTabsList');
         if (!listContainer) return;
         listContainer.innerHTML = ''; // Clear current list

         (courseData.projects || []).forEach((project, index) => {
             if (!project || !project.id) return;
             const itemDiv = document.createElement('div');
             itemDiv.className = 'project-tab-edit-item';
             itemDiv.setAttribute('data-project-id', project.id);
             itemDiv.innerHTML = `
                 <span class="index">${index + 1}.</span>
                 <div class="inputs">
                     <label for="tab-name-${project.id}">Name (on course page):</label>
                     <input type="text" id="tab-name-${project.id}" class="edit-tab-name" value="${project.tabName || ''}" required>
                     <label for="tab-image-${project.id}">Image URL (on course page):</label>
                     <input type="url" id="tab-image-${project.id}" class="edit-tab-image" value="${project.tabImage || ''}">
                 </div>
                 <button type="button" class="remove-item-btn" onclick="removeProjectTab('${project.id}', this)" title="Remove this project" aria-label="Remove Project ${index + 1}">&times;</button>
             `;
             listContainer.appendChild(itemDiv);
         });
         if (!courseData.projects || courseData.projects.length === 0) {
              listContainer.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No projects added yet.</p>';
         }
     }

     function addProjectTabEditField() {
          if ((courseData.projects || []).length >= MAX_PROJECTS) {
               alert(`Maximum ${MAX_PROJECTS} projects allowed per course.`);
               return;
          }
          const newProjectId = `proj_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; // More unique ID
          const newProject = {
                id: newProjectId,
                tabName: `New Project ${ (courseData.projects?.length || 0) + 1}`, tabImage: "",
                projectTitle: "New Project Title", projectSubtitle: "", projectHeaderImage: "",
                overviewText: "Add project description here.", videoIntroText: "", videoTitle: "", videoUrl: "", videoKeyPoints: [],
                learnData: [], slidesData: [], challengesData: [], quizData: [],
                style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null },
                isCompleted: false
            };

          if (!courseData.projects) courseData.projects = [];
          courseData.projects.push(newProject);
          renderProjectTabsEditor(); // Refresh the list in the modal
          document.getElementById('projectTabsList')?.lastElementChild?.scrollIntoView({behavior:'smooth'});
     }

     function removeProjectTab(projectIdToRemove, buttonElement) {
          const projIndex = courseData.projects.findIndex(p=>p.id===projectIdToRemove);
          if (projIndex === -1) return;

          const projName = courseData.projects[projIndex]?.tabName || projectIdToRemove;
          if (!confirm(`⚠️ Are you sure you want to REMOVE project "${projName}"?\n\nThis CANNOT be undone and will delete all its content (slides, quiz, etc.)!`)) {
               return;
          }
          // Remove the project from the main data array
          courseData.projects.splice(projIndex, 1);
          // Remove the item visually from the editor list immediately
          buttonElement?.closest('.project-tab-edit-item')?.remove();
          // Optional: Refresh the list numbering if needed (or handle via CSS :nth-child)
          // renderProjectTabsEditor(); // Alternative: full refresh
          renderCoursePage(); // Refresh the main course grid view
          // If the deleted project was currently being viewed, go back to course view
          if (currentProjectId === projectIdToRemove) {
              showCourseView();
          }
     }

    // Course Color Picker Logic
     function selectCourseColor(type, color) {
        // Store preference in the main course data
        if (!courseData.style) courseData.style = {};
        courseData.style[type + 'Color'] = color;
        // Apply theme to see changes live
        applyCourseTheme();

        // Update visual selection state in the COURSE editor modal
        const pickerInput = document.getElementById(`course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`);
         const pickerContainer = pickerInput?.closest('.color-picker');
         if (pickerInput) pickerInput.value = color;
         if (pickerContainer) {
             pickerContainer.querySelectorAll('.color-option').forEach(option => {
                 option.classList.toggle('selected', areColorsEqual(option.style.backgroundColor, color));
             });
         }
    }
    function customCourseColorSelected(type, color) {
        selectCourseColor(type, color);
        const pickerContainer = document.getElementById(`course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`)?.closest('.color-picker');
        pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));
    }
     function loadCourseColorSelections() {
         // Set the colors in the editor using the select function (updates UI & data)
         selectCourseColor('primary', courseData.style?.primaryColor || '#5E81F4');
         selectCourseColor('secondary', courseData.style?.secondaryColor || '#FF7AC6');
         selectCourseColor('accent', courseData.style?.accentColor || '#FFB800');
     }

    function saveCourseChanges() {
         // Save Course Title, Image, Description
         courseData.title = document.getElementById('editCourseTitle')?.value.trim() || courseData.title;
         courseData.imageUrl = document.getElementById('editCourseImage')?.value.trim() || courseData.imageUrl;
         courseData.description = document.getElementById('editCourseDescription')?.value.trim() || courseData.description;

         // Save Project Tab Names and Images (from the editor list)
         document.querySelectorAll('#projectTabsList .project-tab-edit-item').forEach(item => {
             const projectId = item.getAttribute('data-project-id');
             const project = courseData.projects.find(p => p.id === projectId);
             if (project) {
                 project.tabName = item.querySelector('.edit-tab-name')?.value.trim() || project.tabName || 'Unnamed Project';
                 project.tabImage = item.querySelector('.edit-tab-image')?.value.trim() || project.tabImage;
             }
         });

         applyCourseTheme(); // Apply potentially changed course colors
         renderCoursePage(); // Re-render the main course page
         closeModal('courseEditModal');
         alert("Course changes saved successfully!");
    }


    // --- Project Editor ---
    function openProjectEditModal() {
         const modal = document.getElementById('projectEditModal');
         if (!modal || !currentProjectId) {
              alert("Please navigate to a project page first to edit it.");
              return;
         }
         const projectIndex = courseData.projects.findIndex(p => p.id === currentProjectId);
          if (projectIndex === -1) {
               alert("Error: Cannot find data for the current project.");
               return;
          }
         // Create a DEEP CLONE of the project data for editing to allow cancellation
         currentProjectDataCache = JSON.parse(JSON.stringify(courseData.projects[projectIndex]));

         const project = currentProjectDataCache; // Work with the clone

         modal.querySelector('#editingProjectId').value = project.id;
         modal.querySelector('#editingProjectNameLabel').textContent = project.projectTitle || project.tabName || 'Unnamed Project';

         // Load simple text/URL fields from the CLONE
         modal.querySelector('#editProject_Title').value = project.projectTitle || '';
         modal.querySelector('#editProject_Subtitle').value = project.projectSubtitle || '';
         modal.querySelector('#editProject_HeaderImage').value = project.projectHeaderImage || '';
         modal.querySelector('#editProject_TabName').value = project.tabName || '';
         modal.querySelector('#editProject_TabImage').value = project.tabImage || '';
         modal.querySelector('#editProject_OverviewText').value = project.overviewText || '';
         modal.querySelector('#editProject_VideoIntroText').value = project.videoIntroText || '';
         modal.querySelector('#editProject_VideoTitle').value = project.videoTitle || '';
         modal.querySelector('#editProject_VideoUrl').value = project.videoUrl || '';
         modal.querySelector('#editProject_VideoKeyPoints').value = (project.videoKeyPoints || []).join('\n');

         // Load data for dynamic list sections FROM THE CLONE
         loadLearnEditFieldsForProject(project.learnData || [], modal.querySelector('#learnEditContainer'));
         loadSlidesEditFieldsForProject(project.slidesData || [], modal.querySelector('#slidesEditContainer'));
         loadChallengesEditFieldsForProject(project.challengesData || [], modal.querySelector('#challengesEditContainer'));
         loadQuizEditFieldsForProject(project.quizData || [], modal.querySelector('#quizEditContainer'));

         // Load project-specific styles FROM THE CLONE
         loadProjectStyleSelections(project.style || {});
         loadProjectColorSelections(project.style || {});

         modal.style.display = 'block'; // Show the modal
         // Set default section and show it
         document.getElementById('editSectionProject').value = 'projMeta';
         showProjectEditSection();
    }

     // --- Editor Field Loaders (Project Modal Specific - Operate on CACHED data) ---
     // Helper to create grouped items in project editor
     function createEditItemGroup(index, typePrefix, contentGenerator, removeHandler) {
          const itemGroup = document.createElement('div');
          itemGroup.className = 'edit-item-group';
          itemGroup.innerHTML = contentGenerator(index); // Generate specific inputs via callback

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button'; removeBtn.className = 'remove-item-btn';
          removeBtn.innerHTML = '&times;';
          removeBtn.title = `Remove this ${typePrefix} item`;
          removeBtn.setAttribute('aria-label', `Remove ${typePrefix} ${index + 1}`);
          removeBtn.onclick = () => removeHandler(itemGroup); // Pass the group element
          itemGroup.appendChild(removeBtn);

          // Auto-show/hide media URL input
          const mediaTypeSelect = itemGroup.querySelector('.media-type-select');
          if (mediaTypeSelect) handleMediaTypeChange(mediaTypeSelect); // Trigger initial check

          return itemGroup;
     }
     function handleMediaTypeChange(selectElement) { // Helper for media URL visibility
        const urlInputContainer = selectElement.closest('.edit-item-group')?.querySelector('.media-url-input-container');
        if (urlInputContainer) { urlInputContainer.style.display = (selectElement.value === 'none') ? 'none' : 'block'; }
     }
     // Loaders - they receive the *cached* data array and the container element
     function loadLearnEditFieldsForProject(data, container) {
          if (!container) return; container.innerHTML = '';
          data.forEach((item, index) => {
              const prefix = 'learn'; // For IDs
              const content = (i) => `
                  <label for="${prefix}-title-${i}"><b>Item ${i + 1} Title:</b></label>
                  <input type="text" id="${prefix}-title-${i}" class="${prefix}-title" value="${item.title || ''}" required>
                  <label for="${prefix}-desc-${i}">Description:</label>
                  <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="2">${item.description || ''}</textarea>
                  <div class="media-controls">
                     <label for="${prefix}-media-type-${i}">Optional Media:</label>
                     <select id="${prefix}-media-type-${i}" class="media-type-select" onchange="handleMediaTypeChange(this)">
                         <option value="none" ${item.mediaType === 'none' ? 'selected' : ''}>None</option>
                         <option value="image" ${item.mediaType === 'image' ? 'selected' : ''}>Image URL</option>
                         <option value="video" ${item.mediaType === 'video' ? 'selected' : ''}>Video Embed URL</option>
                     </select>
                     <div class="media-url-input-container" style="display: none;"> ${/* Initially hidden by handleMediaTypeChange */''}
                         <label for="${prefix}-media-url-${i}" class="sr-only">Media URL:</label>
                         <input type="url" id="${prefix}-media-url-${i}" class="media-url-input" placeholder="Enter Media URL..." value="${item.mediaUrl || ''}">
                     </div>
                  </div>`;
              container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveLearnItem));
          });
          if (data.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No learning items added.</p>';
     }
     function loadSlidesEditFieldsForProject(data, container) {
        if (!container) return; container.innerHTML = '';
        data.forEach((slide, index) => {
            const prefix = 'slide';
            const content = (i) => `
                <label for="${prefix}-url-${i}"><b>Slide ${i + 1} URL (Image or Embed Link):</b></label>
                <input type="url" id="${prefix}-url-${i}" class="${prefix}-url" value="${slide.url || ''}" required>
                <label for="${prefix}-desc-${i}">Description (Optional Caption):</label>
                <input type="text" id="${prefix}-desc-${i}" class="${prefix}-desc" value="${slide.description || ''}">
                <label for="${prefix}-type-${i}">Content Type:</label>
                <select id="${prefix}-type-${i}" class="${prefix}-type">
                    <option value="iframe" ${slide.type === 'iframe' ? 'selected' : ''}>Embed (Video/Presentation)</option>
                    <option value="image" ${slide.type === 'image' ? 'selected' : ''}>Image</option>
                </select>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveSlideItem));
        });
        if (data.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No slides added.</p>';
     }
      function loadChallengesEditFieldsForProject(data, container) {
        if (!container) return; container.innerHTML = '';
        data.forEach((challenge, index) => {
            const prefix = 'challenge';
             const content = (i) => `
                <label for="${prefix}-title-${i}"><b>Challenge ${i + 1} Title:</b></label>
                <input type="text" id="${prefix}-title-${i}" class="${prefix}-title" value="${challenge.title || ''}" required>
                <label for="${prefix}-desc-${i}">Description:</label>
                <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="2">${challenge.description || ''}</textarea>
                 <div class="media-controls">
                    <label for="${prefix}-media-type-${i}">Optional Media:</label>
                    <select id="${prefix}-media-type-${i}" class="media-type-select" onchange="handleMediaTypeChange(this)">
                        <option value="none" ${challenge.mediaType === 'none' ? 'selected' : ''}>None</option>
                        <option value="image" ${challenge.mediaType === 'image' ? 'selected' : ''}>Image URL</option>
                        <option value="video" ${challenge.mediaType === 'video' ? 'selected' : ''}>Video Embed URL</option>
                    </select>
                    <div class="media-url-input-container" style="display: none;">
                         <label for="${prefix}-media-url-${i}" class="sr-only">Media URL:</label>
                         <input type="url" id="${prefix}-media-url-${i}" class="media-url-input" placeholder="Enter Media URL..." value="${challenge.mediaUrl || ''}">
                    </div>
                </div>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveChallengeItem));
        });
        if (data.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No challenges added.</p>';
     }
      function loadQuizEditFieldsForProject(data, container) {
        if (!container) return; container.innerHTML = '';
        data.forEach((q, index) => {
             const prefix = 'quiz';
            let incorrectInputsHTML = '';
            for (let i = 0; i < MAX_INCORRECT_ANSWERS; i++) {
                const val = (q.incorrectAnswers && q.incorrectAnswers[i]) ? q.incorrectAnswers[i] : '';
                incorrectInputsHTML += `
                    <label for="${prefix}-incorrect-${index}-${i}" class="incorrect-answer-label">Incorrect Option ${i + 1}:</label>
                    <input type="text" id="${prefix}-incorrect-${index}-${i}" class="${prefix}-incorrect" value="${val}" placeholder="(Optional)">`;
            }
            const content = (i) => `
                <label for="${prefix}-question-${i}"><b>Question ${i + 1}:</b></label>
                <textarea id="${prefix}-question-${i}" class="${prefix}-question" rows="2" required>${q.questionText || ''}</textarea>
                <label for="${prefix}-correct-${i}" style="color: var(--success); font-weight: bold;">Correct Answer:</label>
                <input type="text" id="${prefix}-correct-${i}" class="${prefix}-correct" value="${q.correctAnswer || ''}" required>
                ${incorrectInputsHTML}`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveQuizItem));
        });
        if (data.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No quiz questions added.</p>';
      }

     // Project Style & Color Editor Logic (Operates on CACHE)
     function loadProjectStyleSelections(projectStyleData) {
         const modal = document.getElementById('projectEditModal');
         if (!modal) return;
         const styleData = projectStyleData || {};

         // Font Family
         const currentFont = styleData.fontFamily || null; // Explicitly null if not set
          const fontSelector = modal.querySelector('#projectFontSelector');
          if (fontSelector) {
              fontSelector.querySelectorAll('.font-option').forEach(option => {
                   const onclickAttr = option.getAttribute('onclick');
                   // Match null or the quoted string, handling potential single/double quotes variations
                   const match = onclickAttr?.match(/selectProjectStyle\('fontFamily',\s*(null|(['"`])(.*?)\2)\)/);
                  let optionValue = undefined;
                  if (match) {
                      optionValue = match[1] === 'null' ? null : match[3]; // Get 'null' or the font string
                  }
                  option.classList.toggle('selected', optionValue === currentFont);
              });
          }

         // Base Size
         const currentSize = styleData.baseSize || null;
         const sizeSelector = modal.querySelector('#projectSizeSelector');
         if (sizeSelector) {
             sizeSelector.querySelectorAll('.size-option').forEach(option => {
                  const onclickAttr = option.getAttribute('onclick');
                  const match = onclickAttr?.match(/selectProjectStyle\('baseSize',\s*(null|'small'|'medium'|'large')\)/);
                  const optionValue = match ? (match[1] === 'null' ? null : match[1]) : undefined;
                  option.classList.toggle('selected', optionValue === currentSize);
             });
         }
     }
     function loadProjectColorSelections(projectStyleData) {
        const styleData = projectStyleData || {};
        // Pass null if no project-specific color override is set in the cache
        selectProjectColor('primary', styleData.primaryColor || null, false); // Don't apply live preview on initial load
        selectProjectColor('secondary', styleData.secondaryColor || null, false);
        selectProjectColor('accent', styleData.accentColor || null, false);
     }

     // Selects project style (font/size), updates CACHE and modal UI
     function selectProjectStyle(styleProperty, value) {
         if (!currentProjectDataCache) return;
         if (!currentProjectDataCache.style) currentProjectDataCache.style = {};
         currentProjectDataCache.style[styleProperty] = value;
         // Update the visual selection in the PROJECT editor modal
         loadProjectStyleSelections(currentProjectDataCache.style);
         // console.log("Updated project cache style:", currentProjectDataCache.style); // For debugging
     }
     // Selects project color override, updates CACHE and modal UI
     function selectProjectColor(type, color, applyLive = true) { // 'color' can be null or hex string
         if (!currentProjectDataCache) return;
         if (!currentProjectDataCache.style) currentProjectDataCache.style = {};
         currentProjectDataCache.style[type + 'Color'] = color;

         // Update PROJECT editor modal UI
         const pickerInputId = `project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
         const pickerInput = document.getElementById(pickerInputId);
         const pickerContainer = document.getElementById(`${pickerInputId}Container`);

         if (pickerInput) {
              // Show course color in picker if override is null, otherwise show the override color
              pickerInput.value = color || courseData.style?.[type + 'Color'] || '#ffffff';
              pickerInput.style.border = color ? 'none' : '2px dashed #ccc'; // Indicate inheritance
         }
         if (pickerContainer) {
             pickerContainer.querySelectorAll('.color-option').forEach(option => {
                 option.classList.toggle('selected', color !== null && areColorsEqual(option.style.backgroundColor, color));
             });
         }
         // Optional live preview (apply changes to background project view)
         if (applyLive) { applyProjectSpecificStyles(currentProjectDataCache); }
         // console.log("Updated project cache style:", currentProjectDataCache.style); // For debugging
     }
     function customProjectColorSelected(type, color) {
        selectProjectColor(type, color, true); // Apply live preview
        const pickerContainer = document.getElementById(`project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPickerContainer`);
        pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));
     }
     function clearProjectColorOverrides() {
         if (!confirm("Reset project colors to use the main course theme?")) return;
         // Set colors to null in cache, trigger UI update (without live preview)
         selectProjectColor('primary', null, false);
         selectProjectColor('secondary', null, false);
         selectProjectColor('accent', null, false);
         alert("Project colors reset to course defaults. Save project to apply changes.");
     }

     // --- Add/Remove handlers for dynamic list items in project editor (operate on CACHE) ---
     function findIndexAndRemove(element, dataArrayName, reloadFunctionName) {
        if (!currentProjectDataCache || !currentProjectDataCache[dataArrayName]) return;
        const container = element.parentNode;
        const items = Array.from(container.children).filter(child => child.classList.contains('edit-item-group'));
        const index = items.indexOf(element);
        if (index > -1) {
             currentProjectDataCache[dataArrayName].splice(index, 1); // Remove from the cached data array
             // Reload fields for this section using the cached data
             window[reloadFunctionName](currentProjectDataCache[dataArrayName], container);
        } else { console.error("Could not find item index to remove."); element.remove(); }
     }
     function handleRemoveLearnItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'learnData', 'loadLearnEditFieldsForProject'); }
     function handleRemoveSlideItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'slidesData', 'loadSlidesEditFieldsForProject'); }
     function handleRemoveChallengeItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'challengesData', 'loadChallengesEditFieldsForProject'); }
     function handleRemoveQuizItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'quizData', 'loadQuizEditFieldsForProject'); }

     // Add item functions for project editor (operate on CACHE)
     function addItemToProjectData(dataArrayName, maxItems, newItemObject, reloadFunctionName, containerSelector, focusSelector = null) {
         if (!currentProjectDataCache) return; // Need cache context
         if (!currentProjectDataCache[dataArrayName]) currentProjectDataCache[dataArrayName] = []; // Ensure array exists
         if (currentProjectDataCache[dataArrayName].length >= maxItems) { alert(`Maximum ${maxItems} items allowed.`); return; }

         currentProjectDataCache[dataArrayName].push(newItemObject); // Add to cache

         const container = document.querySelector(containerSelector);
         // Reload the UI section using the updated cache
         if (container && typeof window[reloadFunctionName] === 'function') {
             window[reloadFunctionName](currentProjectDataCache[dataArrayName], container);
             // Scroll and focus
             const lastItem = container.lastElementChild;
             if (lastItem && lastItem.classList.contains('edit-item-group')) {
                   lastItem.scrollIntoView({behavior:'smooth', block:'nearest'});
                   if(focusSelector) lastItem.querySelector(focusSelector)?.focus();
             }
         } else { console.error(`Reload function ${reloadFunctionName} or container ${containerSelector} not found.`); }
     }
     function addLearnEditField() { addItemToProjectData('learnData', MAX_LEARN_ITEMS, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadLearnEditFieldsForProject', '#projectEditModal #learnEditContainer', '.learn-title'); }
     function addSlideEditField() { addItemToProjectData('slidesData', MAX_SLIDES, { url: "", description: "", type:"iframe" }, 'loadSlidesEditFieldsForProject', '#projectEditModal #slidesEditContainer', '.slide-url'); }
     function addChallengeEditField() { addItemToProjectData('challengesData', MAX_CHALLENGES, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadChallengesEditFieldsForProject', '#projectEditModal #challengesEditContainer', '.challenge-title'); }
     function addQuizEditField() { addItemToProjectData('quizData', MAX_QUIZ_QUESTIONS, { questionText:"", correctAnswer:"", incorrectAnswers: Array(MAX_INCORRECT_ANSWERS).fill("") }, 'loadQuizEditFieldsForProject', '#projectEditModal #quizEditContainer', '.quiz-question'); }


     // Show different editing sections within the PROJECT editor modal
     function showProjectEditSection() {
         const modal = document.getElementById('projectEditModal');
         const select = document.getElementById('editSectionProject');
         if (!modal || !select) return;
         modal.querySelectorAll('.edit-section').forEach(section => section.style.display = 'none');
         // ID mapping: 'projMeta' -> 'projMetaEdit', 'overview' -> 'overviewEdit', etc.
         const sectionId = select.value + 'Edit';
         const targetSection = modal.querySelector('#' + sectionId);
         if (targetSection) {
             targetSection.style.display = 'block';
         } else { console.warn("Edit section not found:", sectionId); }
     }

    // Saves changes from Project Modal back to main courseData
    function saveProjectChanges() {
         const projectId = document.getElementById('editingProjectId')?.value;
         const projectIndex = courseData.projects.findIndex(p => p.id === projectId);
         if (projectIndex === -1 || !currentProjectDataCache) { alert("Error: Could not find project data to save."); return; }

         const modal = document.getElementById('projectEditModal');
         if (!modal) { alert("Error: Project edit modal not found."); return; }

         // --- Create a new object with data read from the modal & cache ---
         let updatedProjectData = {
             id: projectId, // Keep the original ID
             isCompleted: currentProjectDataCache.isCompleted, // Preserve completion status
             style: { ...(currentProjectDataCache.style || {}) }, // Copy style object from cache

             // Read simple fields from modal
             projectTitle: modal.querySelector('#editProject_Title')?.value.trim() || 'Project Title',
             projectSubtitle: modal.querySelector('#editProject_Subtitle')?.value.trim() || '',
             projectHeaderImage: modal.querySelector('#editProject_HeaderImage')?.value.trim() || '',
             tabName: modal.querySelector('#editProject_TabName')?.value.trim() || 'Unnamed Tab',
             tabImage: modal.querySelector('#editProject_TabImage')?.value.trim() || '',
             overviewText: modal.querySelector('#editProject_OverviewText')?.value.trim() || '',
             videoIntroText: modal.querySelector('#editProject_VideoIntroText')?.value.trim() || '',
             videoTitle: modal.querySelector('#editProject_VideoTitle')?.value.trim() || '',
             videoUrl: modal.querySelector('#editProject_VideoUrl')?.value.trim() || '',
             videoKeyPoints: modal.querySelector('#editProject_VideoKeyPoints')?.value.split('\n').map(s => s.trim()).filter(s => s),

             // Read dynamic list fields from modal inputs
             learnData: [], slidesData: [], challengesData: [], quizData: []
         };

         try {
             // Learn Items
             modal.querySelectorAll('#learnEditContainer .edit-item-group').forEach(item => {
                 const titleInput = item.querySelector('.learn-title');
                 const title = titleInput?.value.trim();
                 if (title) { // Only save if title exists
                     const mediaTypeSelect = item.querySelector('.media-type-select');
                     const mediaUrlInput = item.querySelector('.media-url-input');
                     const mediaType = mediaTypeSelect?.value || 'none';
                     updatedProjectData.learnData.push({
                         title: title,
                         description: item.querySelector('.learn-desc')?.value.trim() || "",
                         mediaType: mediaType,
                         mediaUrl: (mediaType !== 'none' && mediaUrlInput) ? mediaUrlInput.value.trim() : ''
                     });
                 } else if (titleInput?.required && !title) titleInput.style.border = '1px solid red';
             });

             // Slides
             modal.querySelectorAll('#slidesEditContainer .edit-item-group').forEach(item => {
                  const urlInput = item.querySelector('.slide-url');
                  const url = urlInput?.value.trim();
                  if (url) {
                      updatedProjectData.slidesData.push({
                           url: url,
                           description: item.querySelector('.slide-desc')?.value.trim() || "",
                           type: item.querySelector('.slide-type')?.value || "iframe"
                       });
                  } else if (urlInput?.required && !url) urlInput.style.border = '1px solid red';
             });

              // Challenges
             modal.querySelectorAll('#challengesEditContainer .edit-item-group').forEach(item => {
                  const titleInput = item.querySelector('.challenge-title');
                  const title = titleInput?.value.trim();
                  if (title) {
                      const mediaTypeSelect = item.querySelector('.media-type-select');
                      const mediaUrlInput = item.querySelector('.media-url-input');
                      const mediaType = mediaTypeSelect?.value || 'none';
                      updatedProjectData.challengesData.push({
                           title: title,
                           description: item.querySelector('.challenge-desc')?.value.trim() || "",
                           mediaType: mediaType,
                           mediaUrl: (mediaType !== 'none' && mediaUrlInput) ? mediaUrlInput.value.trim() : ''
                      });
                  } else if (titleInput?.required && !title) titleInput.style.border = '1px solid red';
             });

             // Quiz Questions
             modal.querySelectorAll('#quizEditContainer .edit-item-group').forEach(item => {
                  const questionInput = item.querySelector('.quiz-question');
                  const correctInput = item.querySelector('.quiz-correct');
                  const question = questionInput?.value.trim();
                  const correct = correctInput?.value.trim();

                  if (question && correct) {
                       let incorrect = [];
                       item.querySelectorAll('.quiz-incorrect').forEach(inp => { if(inp.value.trim()) incorrect.push(inp.value.trim()); });
                       updatedProjectData.quizData.push({ questionText: question, correctAnswer: correct, incorrectAnswers: incorrect });
                  } else {
                      if (questionInput?.required && !question) questionInput.style.border = '1px solid red';
                      if (correctInput?.required && !correct) correctInput.style.border = '1px solid red';
                  }
             });

             // --- COMMIT Changes: Replace the project object in the main courseData array ---
             courseData.projects[projectIndex] = updatedProjectData;

             // --- Update UI & Close ---
             renderProjectPage(updatedProjectData); // Update the project view display with new data
             renderCoursePage();       // Update the course grid (tab name/image might have changed)
             closeModal('projectEditModal');
             alert(`Project "${updatedProjectData.projectTitle || updatedProjectData.tabName}" changes saved!`);
             currentProjectDataCache = null; // Clear the edit cache

         } catch (error) {
              console.error("Error saving project changes:", error);
              alert("An error occurred while saving the project. Check the console for details.");
         }
    }

    // --- Utility Functions ---
    function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}
    function areColorsEqual(color1, color2){
        if (!color1 || !color2) return false;
        if (color1 === color2) return true;
        try{
            const dummy = document.createElement('div'); dummy.style.color = color1;
            const n1 = dummy.style.color; dummy.style.color = color2; const n2 = dummy.style.color;
            return Boolean(n1 && n2 && n1 === n2);
        } catch(e) { return String(color1).trim().toLowerCase() === String(color2).trim().toLowerCase(); }
    }

    // --- EXPORT COURSE (Keep original course export, ensure it includes all data) ---
    function exportCourseHTML() {
        console.log("Starting COURSE export...");
        try {
            applyCourseTheme(); // Ensure base course theme is active for export styles
            const exportDocElement = document.documentElement.cloneNode(true);

            // Clean up editor UI
            exportDocElement.querySelector('#courseEditModal')?.remove();
            exportDocElement.querySelector('#projectEditModal')?.remove();
            exportDocElement.querySelectorAll('.edit-btn').forEach(btn => btn.remove());
            exportDocElement.querySelectorAll('.export-btn').forEach(btn => btn.remove()); // Course export button
            exportDocElement.querySelectorAll('.back-btn').forEach(btn => btn.remove()); // Project back button

            // Reset view state for export
            exportDocElement.querySelector('#course-view').style.display = 'block';
            exportDocElement.querySelector('#project-view').style.display = 'none';
             // Clear any lingering project-specific inline styles
             const exportProjectViewEl = exportDocElement.querySelector('#project-view');
             if(exportProjectViewEl) { exportProjectViewEl.style.fontFamily = ''; exportProjectViewEl.style.fontSize = ''; }

            // Reset quiz state visually
            exportDocElement.querySelectorAll('.quiz-question').forEach(q => {
                q.classList.remove('answered');
                q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected', 'correct', 'incorrect'));
                 q.querySelectorAll('.quiz-feedback').forEach(f => f.style.display = 'none');
             });
            exportDocElement.querySelector('.final-quiz-result')?.remove();
            const exportSubmitBtn = exportDocElement.querySelector('#project-view #submitQuizBtn');
            if (exportSubmitBtn) exportSubmitBtn.disabled = false;

            // Remove ALL original script tags
            exportDocElement.querySelectorAll('script').forEach(script => script.remove());

            // Create the minimal viewer script
            const viewerScript = document.createElement('script');
            // Embed the CURRENT, complete courseData state
            viewerScript.textContent = `
                // --- EXPORTED VIEWER SCRIPT ---
                const courseDataForView = ${JSON.stringify(courseData)};
                let currentSlideIndex = 0;
                let currentProjectIdForView = null;

                // --- Utilities ---
                function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}
                function areColorsEqual(c1, c2){ if(!c1||!c2)return!1;if(c1===c2)return!0;try{const d=document.createElement('div');d.style.color=c1;const n1=d.style.color;d.style.color=c2;const n2=d.style.color;return!(!n1||!n2)&&n1===n2}catch(e){return String(c1).trim().toLowerCase()===String(c2).trim().toLowerCase()}}

                // --- Theme & Style Application ---
                 function applyCourseThemeForView() {
                    const root = document.documentElement; const cs = courseDataForView.style || {};
                    root.style.setProperty('--primary', cs.primaryColor || '#5E81F4');
                    root.style.setProperty('--secondary', cs.secondaryColor || '#FF7AC6');
                    root.style.setProperty('--accent', cs.accentColor || '#FFB800');
                    root.style.setProperty('--base-font-family', "'Segoe UI', sans-serif"); // Default font
                    root.style.setProperty('--base-font-size', '16px'); // Default size
                    const pView = document.getElementById('project-view'); if(pView){ pView.style.fontFamily=''; pView.style.fontSize=''; }
                 }
                function applyProjectStylesForView(project) {
                    if (!project) return; const root = document.documentElement;
                    const pStyle = project.style || {}; const cStyle = courseDataForView.style || {};
                    root.style.setProperty('--primary', pStyle.primaryColor || cStyle.primaryColor || '#5E81F4');
                    root.style.setProperty('--secondary', pStyle.secondaryColor || cStyle.secondaryColor || '#FF7AC6');
                    root.style.setProperty('--accent', pStyle.accentColor || cStyle.accentColor || '#FFB800');
                    const pView = document.getElementById('project-view'); if(!pView) return;
                    pView.style.fontFamily = pStyle.fontFamily || 'var(--base-font-family)';
                    let effSize='var(--base-font-size)';
                    if(pStyle.baseSize==='small')effSize='14px';else if(pStyle.baseSize==='large')effSize='18px';else if(pStyle.baseSize==='medium')effSize='16px';
                    pView.style.fontSize = effSize;
                }

                // --- View Navigation ---
                function showCourseView() {
                    document.getElementById('course-view').style.display = 'block';
                    document.getElementById('project-view').style.display = 'none';
                    currentProjectIdForView = null; document.title = courseDataForView.title || "Course";
                    applyCourseThemeForView(); renderCoursePageForView(); window.scrollTo(0,0);
                }
                function showProjectView(projectId) {
                     const project = courseDataForView.projects.find(p => p.id === projectId);
                     if (!project) { showCourseView(); return; }
                     currentProjectIdForView = projectId;
                     renderProjectPageForView(project);
                     document.getElementById('course-view').style.display = 'none';
                     document.getElementById('project-view').style.display = 'block';
                     document.title = project.projectTitle || "Project";
                     applyCourseThemeForView(); applyProjectStylesForView(project); // Apply base then overrides
                     window.scrollTo(0,0);
                 }

                 // --- Content Rendering (Viewer Version - Includes all project parts) ---
                function renderCoursePageForView() {
                    const c = courseDataForView; document.getElementById('courseTitle').textContent = c.title;
                    const img = document.getElementById('courseImage'); if(img){ img.src = c.imageUrl || ''; img.alt = c.title + " Image"; }
                    document.getElementById('courseDescription').textContent = c.description;
                    const grid = document.getElementById('projectGrid'); grid.innerHTML = '';
                    if (!c.projects || c.projects.length === 0) { grid.innerHTML = '<p>No projects found.</p>'; return; }
                    c.projects.forEach(p => {
                        if (!p || !p.id) return; const t = document.createElement('a');
                        t.className = 'project-tab'; t.href = '#project-' + p.id;
                        t.onclick = (e) => { e.preventDefault(); showProjectView(p.id); };
                        t.innerHTML = \`<img src="\${p.tabImage||'https://via.placeholder.com/300x200/eee/999?text=Prj'}" alt="\${p.tabName||'Project'}" loading="lazy"><div class="project-tab-info"><span>\${p.tabName||'Project'}</span></div>\`;
                        if(p.isCompleted){ const tick=document.createElement('span'); tick.className='completion-tick'; tick.innerHTML='&#10004;'; tick.setAttribute('aria-label','Completed'); t.appendChild(tick); }
                        grid.appendChild(t);
                     });
                }
                function renderProjectPageForView(project) { // Renders all sections based on project data
                      if (!project) return; const pView = document.getElementById('project-view'); if (!pView) return;
                      const header = pView.querySelector('#project-header');
                      if(header){ header.querySelector('#projectImage').src=project.projectHeaderImage||project.tabImage||''; header.querySelector('#projectImage').alt=project.projectTitle+" Header"; header.querySelector('#projectTitle').textContent=project.projectTitle; header.querySelector('#projectSubtitle').textContent=project.projectSubtitle; }
                      const cont = pView.querySelector('#projectTabContentContainer'); if(!cont) return;
                      const ov = cont.querySelector('#overview'); if(ov){ ov.querySelector('#overviewText').textContent = project.overviewText||''; renderLearnItemsForProjectView(project.learnData||[],ov.querySelector('#learnContainer')); }
                      const vid = cont.querySelector('#video'); if(vid){ vid.querySelector('#videoIntroText').textContent=project.videoIntroText||''; vid.querySelector('#videoTitle').textContent=project.videoTitle||''; vid.querySelector('#mainVideo').src=project.videoUrl||''; const ul=vid.querySelector('#videoKeyPoints'); ul.innerHTML=''; (project.videoKeyPoints||[]).forEach(pt=>{if(pt&&pt.trim())ul.innerHTML+=\`<li>\${pt}</li>\`;}); if(!ul.innerHTML)ul.innerHTML='<li>No points.</li>'; }
                      const sli = cont.querySelector('#slides'); if(sli) renderSlideshowForProjectView(project.slidesData||[], sli.querySelector('#slideshowContainer'));
                      const chal = cont.querySelector('#challenges'); if(chal) renderChallengesForProjectView(project.challengesData||[], chal.querySelector('#challengesContainer'));
                      const quiz = cont.querySelector('#quiz'); if(quiz) renderQuizForProjectView(project.quizData||[], quiz.querySelector('#quizContainer'), quiz.querySelector('#submitQuizBtn'));
                      const tabsBar = pView.querySelector('#projectTabs'); const firstTab = tabsBar?.querySelector('.tab'); if(firstTab){ const clickAttr=firstTab.getAttribute('onclick')||''; const match=clickAttr.match(/openProjectTab\\('([^']+)'/); openProjectTab(match?match[1]:'overview', firstTab); } else { updateProjectProgressBar(''); }
                }
                 function renderLearnItemsForProjectView(data, c){ if(!c)return; c.innerHTML=''; const v=(data||[]).filter(i=>(i.title||'').trim()); if(v.length===0){c.innerHTML='<p>No details.</p>';return;} v.forEach((item, idx)=>{ const el=document.createElement('div'); el.className='step'; el.innerHTML=\`<div class="step-number">\${idx+1}</div><div class="step-content"><strong>\${item.title}</strong>\${(item.description||'').trim()?\`<p class="description">\${item.description}</p>\`:''}<div class="step-media" style="display:none;"></div></div>\`; const m=el.querySelector('.step-media'); if(item.mediaType&&item.mediaType!=='none'&&item.mediaUrl){const u=item.mediaUrl.trim();if(u){m.style.display='block';if(item.mediaType==='image')m.innerHTML=\`<img src="\${u}" loading="lazy" alt="\${item.title||'Media'}">\`; else if(item.mediaType==='video')m.innerHTML=\`<iframe src="\${u}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${item.title||'Media'}"></iframe>\`;}} c.appendChild(el); }); }
                 function renderChallengesForProjectView(data, c){ if(!c)return; c.innerHTML=''; const v=(data||[]).filter(i=>(i.title||'').trim()); if(v.length===0){c.innerHTML='<p>No challenges.</p>';return;} v.forEach(item=>{ const el=document.createElement('div'); el.className='step'; el.innerHTML=\`<div class="step-number" style="background-color: var(--accent); color: var(--dark);">★</div><div class="step-content"><strong>\${item.title}</strong>\${(item.description||'').trim()?\`<p class="description">\${item.description}</p>\`:''}<div class="step-media" style="display:none;"></div></div>\`; const m=el.querySelector('.step-media'); if(item.mediaType&&item.mediaType!=='none'&&item.mediaUrl){const u=item.mediaUrl.trim();if(u){m.style.display='block';if(item.mediaType==='image')m.innerHTML=\`<img src="\${u}" loading="lazy" alt="\${item.title||'Media'}">\`; else if(item.mediaType==='video')m.innerHTML=\`<iframe src="\${u}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${item.title||'Media'}"></iframe>\`;}} c.appendChild(el); }); }
                 function renderSlideshowForProjectView(data, c){ const n=c?.closest('.tab-content#slides')?.querySelector('.slide-nav'); if(!c||!n)return; c.innerHTML=''; const v=(data||[]).filter(s=>s.url&&s.url.trim()); if(v.length===0){c.innerHTML='<p>No slides.</p>';n.style.display='none';return;} n.style.display='flex'; v.forEach((s, idx)=>{ const el=document.createElement('div'); el.className='slide'; const u=s.url.trim(); const t=s.type==='image'?'image':'iframe'; const d=s.description||''; el.innerHTML=\`<div class="slide-content-wrapper"></div>\${d?\`<p>\${d}</p>\`:''}\`; const w=el.querySelector('.slide-content-wrapper'); if(t==='iframe')w.innerHTML=\`<iframe src="\${u}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${d||'Slide '+(idx+1)}"></iframe>\`; else if(t==='image')w.innerHTML=\`<img src="\${u}" loading="lazy" alt="\${d||'Slide '+(idx+1)}">\`; c.appendChild(el); }); currentSlideIndex=0; showSlide(0); }
                 function renderQuizForProjectView(data, c, btn){ if(!c||!btn)return; c.innerHTML=''; c.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove(); btn.disabled=false; btn.style.display='none'; const v=(data||[]).filter(q=>(q.questionText||'').trim()&&(q.correctAnswer||'').trim()); if(v.length===0){c.innerHTML='<p>No quiz.</p>';return;} btn.style.display='block'; v.forEach((q,idx)=>{ const div=document.createElement('div'); div.className='quiz-question'; div.innerHTML=\`<p class="question-text">\${idx+1}. \${q.questionText}</p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>\`; const optsDiv=div.querySelector('.quiz-options'); let opts=[q.correctAnswer.trim()]; (q.incorrectAnswers||[]).forEach(ans=>{if(ans&&ans.trim())opts.push(ans.trim());}); shuffleArray(opts); opts.forEach(optTxt=>{ const correct=(optTxt===q.correctAnswer.trim()); const optEl=document.createElement('div'); optEl.className='quiz-option'; optEl.textContent=optTxt; optEl.setAttribute('role','button'); optEl.setAttribute('tabindex','0'); optEl.onclick=()=>selectQuizOption(optEl); optEl.onkeydown=(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(optEl);}}; optEl.setAttribute('data-is-correct',correct.toString()); optsDiv.appendChild(optEl); }); c.appendChild(div); }); }

                // --- Interaction Functions (Viewer Version) ---
                function openProjectTab(tabName, element) { const c=document.getElementById('projectTabContentContainer');if(!c)return; c.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));const b=document.getElementById('projectTabs');if(b)b.querySelectorAll('.tab').forEach(btn=>btn.classList.remove('active'));const t=c.querySelector('#'+tabName);if(t)t.classList.add('active');element?.classList.add('active');updateProjectProgressBar(tabName); }
                function updateProjectProgressBar(tabName) { const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tabName);if(i>=0)r=((i+1)/o.length)*100;p.style.width=r+'%'; }
                function showSlide(n) { const s=document.querySelectorAll('#project-view #slideshowContainer .slide');const c=s.length;if(c===0)return;s.forEach(sl=>sl.classList.remove('active'));currentSlideIndex=(n%c+c)%c;if(s[currentSlideIndex])s[currentSlideIndex].classList.add('active'); }
                function nextSlide(){ showSlide(currentSlideIndex+1); } function prevSlide(){ showSlide(currentSlideIndex-1); }
                function selectQuizOption(optionElement) { const qDiv=optionElement.closest('.quiz-question');if(!qDiv||qDiv.classList.contains('answered'))return; qDiv.querySelectorAll('.quiz-option').forEach(opt=>opt.classList.remove('selected')); optionElement.classList.add('selected'); }
                function markProjectAsCompletedInView(projectId) { const proj=courseDataForView.projects.find(p=>p.id===projectId); if(proj&&!proj.isCompleted) proj.isCompleted = true; }
                function submitQuiz() {
                     const qs=document.querySelectorAll('#project-view #quizContainer .quiz-question');let ans=0,score=0;const total=qs.length;if(total===0)return;let firstUnanswered=null;
                     qs.forEach(q=>{ const sel=q.querySelector('.quiz-option.selected'); q.classList.remove('answered'); q.querySelectorAll('.quiz-feedback').forEach(f=>f.style.display='none'); q.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('correct','incorrect');o.style.opacity='1';o.style.cursor='pointer';o.onclick=()=>selectQuizOption(o);o.onkeydown=(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(o);}};}); if(sel)ans++;else if(!firstUnanswered)firstUnanswered=q; });
                     if(ans<total){ alert('Please answer all '+total+' questions!'); if(firstUnanswered){firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});firstUnanswered.style.outline='2px solid red';setTimeout(()=>firstUnanswered.style.outline='',2000);} return;}
                     qs.forEach(q=>{ const sel=q.querySelector('.quiz-option.selected'); const fbC=q.querySelector('.quiz-feedback.correct'); const fbI=q.querySelector('.quiz-feedback.incorrect'); const allO=q.querySelectorAll('.quiz-option'); q.classList.add('answered'); const isC=sel.getAttribute('data-is-correct')==='true'; allO.forEach(o=>{ const oC=o.getAttribute('data-is-correct')==='true'; if(oC)o.classList.add('correct'); if(o===sel){ if(!isC)o.classList.add('incorrect'); } else if(!oC){ o.style.opacity="0.6"; } o.style.cursor="default"; o.onclick=null; o.onkeydown=null; }); if(isC){score++;if(fbC)fbC.style.display='block';} else {if(fbI){ const cO=q.querySelector('.quiz-option.correct'); fbI.textContent=\`Not quite. Correct: "\${cO?cO.textContent:'N/A'}"\`; fbI.style.display='block';}} });
                     const btn=document.querySelector('#project-view #submitQuizBtn');if(btn)btn.disabled=true;
                     const resCont=document.querySelector('#project-view #quiz'); let resDiv=resCont?.querySelector('.final-quiz-result'); if(!resDiv&&resCont){resDiv=document.createElement('div');resCont.appendChild(resDiv);}
                     if(resDiv){ const perc=total>0?score/total:0; resDiv.textContent=\`Quiz Complete! Score: \${score}/\${total}\`; resDiv.className='final-quiz-result '+(perc>=0.7?'success':'fail'); resDiv.style.display='block'; resDiv.scrollIntoView({behavior:'smooth',block:'center'}); if(perc>=0.7&&currentProjectIdForView) markProjectAsCompletedInView(currentProjectIdForView); }
                 }

                // --- Initial Load for Exported Viewer ---
                document.addEventListener('DOMContentLoaded', function() {
                    applyCourseThemeForView();
                    renderCoursePageForView();
                    // Handle deep links before showing default view
                    let displayedProject = false;
                    if (window.location.hash && window.location.hash.startsWith('#project-')) {
                         const pid = window.location.hash.substring(9);
                         if (courseDataForView.projects.some(p => p.id === pid)) {
                              showProjectView(pid);
                              displayedProject = true;
                         }
                    }
                    if (!displayedProject) showCourseView(); // Show course view if no valid project hash
                    console.log("Exported Course Viewer Initialized.");
                });
            `;
            exportDocElement.querySelector('body').appendChild(viewerScript);

            // Generate HTML string and trigger download
            const htmlContent = '<!DOCTYPE html>\n' + exportDocElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            const filename = (courseData.title || "course_export").replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_').toLowerCase() + '.html';
            a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            console.log("Course export completed.");

        } catch (error) {
            console.error("Error during COURSE export:", error);
            alert("An error occurred during course export. Check console.");
        }
    }

    // --- INITIAL PAGE LOAD (Editor Mode) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Course Editor/Viewer Initializing...");
        applyCourseTheme(); // Apply initial theme
        renderCoursePage(); // Render the course grid
        showCourseView();   // Show course view by default
        console.log("Initialization complete.");
    });

</script>

</body>
</html>
