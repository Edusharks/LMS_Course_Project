<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Dashboard Main</title>
    <style>
        /* Global Variables & Basic Styles */
        :root {
            --primary: #5E81F4; --secondary: #FF7AC6; --accent: #FFB800;
            --light: #F5F7FA; --dark: #1A1D28; --success: #7CE7AC; --danger: #FF7E7E;
            --primary-rgb: 94, 129, 244;
            --global-font-family: 'Segoe UI', sans-serif; --global-font-size: 16px; --global-text-color: var(--dark);
            --transition-speed: 0.3s;
            --card-bg: #ffffff; --card-shadow: 0 3px 10px rgba(0,0,0,0.07); --card-hover-shadow: 0 6px 15px rgba(0,0,0,0.1);
            --card-border-radius: 10px; --card-padding: 20px; --card-image-height: 160px;
            --toggle-switch-width: 50px; --toggle-switch-height: 26px;
            --sidebar-width: 270px; --header-image-size: 60px; --course-header-image-height: 120px;
            --challenge-icon-size: 40px;
            --error-image-fallback: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666666' font-size='12' font-family='sans-serif'%3EError%3C/text%3E%3C/svg%3E");
        }
        html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--global-font-size); }
        *, *:before, *:after { box-sizing: inherit; }
        body { font-family: var(--global-font-family); color: var(--global-text-color); margin: 0; padding: 0; background-color: var(--light); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, font-family var(--transition-speed) ease, font-size var(--transition-speed) ease; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* Headings & Buttons */
        h1, h2, h3, h4 { color: var(--primary); transition: color var(--transition-speed) ease; margin-top: 0; }
        h1 { font-size: 2rem; margin-bottom: 20px; color: var(--dark); }
        .page-header .header-title { margin: 0 0 5px 0; color: white; font-size: 1.8rem; }
        .page-header .header-subtitle { margin: 0; color: rgba(255,255,255,0.9); font-size: 1rem; }
        h2 { font-size: 1.6rem; border-bottom: 2px solid var(--secondary); padding-bottom: 5px; display: inline-block; margin-bottom: 20px; transition: border-color var(--transition-speed) ease; }
        h3 { font-size: 1.3rem; margin-bottom: 10px; }
        h4 { font-size: 1.1rem; color: var(--dark); margin: 10px 0 5px 0; }
        button { cursor: pointer; font-family: inherit; padding: 8px 15px; border-radius: 6px; border: 1px solid transparent; transition: all 0.2s ease; font-size: 0.95rem; vertical-align: middle; background-color: #eee; color: #333; }
        button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0.9; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }
        .action-btn { font-size: 0.8em; padding: 4px 8px; margin-left: 5px; border: none; opacity: 0.7; font-weight: bold; vertical-align: middle; line-height: 1; display: inline-flex; align-items: center; justify-content: center; background-color: transparent; }
        .action-btn:hover:not(:disabled) { opacity: 1; background-color: rgba(0,0,0,0.05); }
        .add-btn { background-color: var(--success); color: white; font-weight: bold; border: none; }
        .add-btn:hover:not(:disabled) { background-color: #63c899; }
        .edit-btn { background-color: var(--accent); color: var(--dark); border: none;}
        .edit-btn:hover:not(:disabled) { background-color: #ffc833; }
        .remove-btn { background-color: var(--danger); color: white; border: none;}
        .remove-btn:hover:not(:disabled) { background-color: #e66a6a; }
        .back-btn { background-color: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 6px 12px; font-size: 0.9em;}
        .back-btn:hover { background-color: rgba(255,255,255,0.4); }
        #app-settings-btn { background-color: #fff; border: 1px solid #ccc; color: #555; border-radius: 4px; width: 30px; height: 30px; font-size: 1.1rem; display: inline-flex; align-items: center; justify-content: center; padding: 5px; margin-left: 10px; }
        #app-settings-btn:hover { background-color: #eee; }

        /* Editor/Student Toggle Switch */
        .mode-toggle-switch { display: inline-flex; align-items: center; }
        .mode-toggle-switch .toggle-container { position: relative; width: var(--toggle-switch-width); height: var(--toggle-switch-height); }
        .mode-toggle-switch input[type="checkbox"] { opacity: 0; width: 0; height: 0; position: absolute; }
        .mode-toggle-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.2); transition: .4s; border-radius: var(--toggle-switch-height); }
        .mode-toggle-switch .slider:before { position: absolute; content: ""; height: calc(var(--toggle-switch-height) - 6px); width: calc(var(--toggle-switch-height) - 6px); left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        .mode-toggle-switch input:checked + .slider { background-color: var(--success); }
        .mode-toggle-switch input:checked + .slider:before { transform: translateX(calc(var(--toggle-switch-width) - var(--toggle-switch-height))); }
        .mode-toggle-switch input:focus + .slider { box-shadow: 0 0 1px var(--success); }

        /* Views */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .view-header h1 { margin-bottom: 0; text-align: left; }
        .view-controls { display: flex; gap: 10px; align-items: center; }

        /* Card View Only Styles */
        .item-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .item-card { background-color: var(--card-bg); border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; overflow: hidden; cursor: pointer; text-align: center; }
        .item-card:hover { transform: translateY(-3px); box-shadow: var(--card-hover-shadow); }
        .item-card .item-image { width: 100%; height: var(--card-image-height); object-fit: cover; background-color: #eee; display: block; border-bottom: 1px solid #eee; }
        .item-card .item-image[data-error="true"] { object-fit: contain; padding: 10px; height: var(--card-image-height); }
        .item-card .item-content { padding: var(--card-padding); }
        .item-card h4 { font-size: 1.15rem; color: var(--primary); margin: 0 0 8px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-card p { font-size: 0.9rem; color: #555; margin-bottom: 0; line-height: 1.4; word-break: break-word; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; min-height: 2.8em; }
        .item-card .item-card-actions, .item-heading-container, .item-inline-actions { display: none; } /* Hide actions */
        .add-item-container { text-align: center; margin-top: 30px; }

        /* Shared Page Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: background var(--transition-speed) ease; gap: 15px; }
        .page-header .header-content { display: flex; align-items: center; gap: 15px; flex-grow: 1; min-width: 0; }
        .page-header .header-title-container { flex-grow: 1; min-width: 0; }
        .page-header .header-actions { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .page-header .header-actions .header-btn { background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); width: 38px; height: 38px; border-radius: 50%; font-size: 18px; padding: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .page-header .header-actions .header-btn:hover { background-color: rgba(255,255,255,0.4); }

        /* Project Header Image */
        #project-view .page-header #projectHeaderImage { width: var(--header-image-size); height: var(--header-image-size); object-fit: cover; border-radius: 8px; border: 3px solid rgba(255, 255, 255, 0.5); background-color: rgba(255, 255, 255, 0.2); flex-shrink: 0; }
        #project-view .page-header #projectHeaderImage[data-error="true"] { background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center; }

        /* Course Header Image & Layout */
        #course-view .page-header .header-content { flex-direction: column; align-items: flex-start; }
        #course-view .page-header #courseHeaderImage { width: 100%; height: var(--course-header-image-height); object-fit: cover; border-radius: 6px; margin-bottom: 10px; background-color: rgba(255, 255, 255, 0.1); display: block; }
        #course-view .page-header #courseHeaderImage[data-error="true"] { background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center; object-fit: contain; height: var(--course-header-image-height); }
        #course-view .page-header .header-title-container { width: 100%; }

        /* Course View Content */
        #course-view .course-content-header { margin-bottom: 15px; }
        #course-view .course-main-content { background-color: var(--card-bg); padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; min-height: 100px; }
        #course-view #course-content-area > p:first-child:last-child { text-align: center; color: #888; margin-top: 20px; font-style: italic; } /* Placeholder */

        /* Element Controls */
        .element-controls { margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; }
        .element-controls p { font-weight: bold; margin: 0 0 10px 0; color: var(--primary); }
        .element-controls button { margin-right: 10px; margin-bottom: 10px; background-color: #eef2ff; color: var(--primary); border: 1px solid var(--primary); font-size: 0.9em; font-weight: 500; }
        .element-controls button:hover:not(:disabled) { background-color: var(--primary); color: white; }

        /* Project View Layout */
        #project-view .project-layout { display: flex; gap: 25px; }
        #project-view #project-sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); height: fit-content; }
        #project-view #project-tabs { margin-bottom: 15px; }
        #project-view .tab, #project-view .sub-tab { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid #eee; transition: all 0.2s ease; background-color: #fff; position: relative; }
        #project-view .tab:hover:not(.active), #project-view .sub-tab:hover:not(.active) { background-color: #f0f5ff; border-color: #c4cde0; }
        #project-view .tab.active, #project-view .sub-tab.active { font-weight: bold; box-shadow: 0 2px 5px rgba(var(--primary-rgb), 0.2); }
        #project-view .tab.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        #project-view .sub-tab.active { background-color: var(--secondary); border-color: var(--secondary); color: white; box-shadow: 0 2px 5px rgba(255, 122, 198, 0.2); }
        #project-view .tab:hover .tab-controls, #project-view .sub-tab:hover .sub-tab-controls, #project-view .tab.active .tab-controls, #project-view .sub-tab.active .sub-tab-controls { display: inline-flex; gap: 5px; }
        #project-view.student-mode .tab:hover .tab-controls, #project-view.student-mode .sub-tab:hover .sub-tab-controls { display: none; } /* Hide on hover in student mode */
        #project-view .tab.active .action-btn { color: var(--primary); background-color: white; opacity: 1; }
        #project-view .sub-tab.active .action-btn { color: var(--secondary); background-color: white; opacity: 1; }
        #project-view .tab-name, #project-view .sub-tab-name { flex-grow: 1; margin-right: 10px; word-break: break-word; padding: 2px 0; }
        #project-view .sub-tab { margin-left: 20px; padding: 8px 10px; font-size: 0.9em; margin-bottom: 5px; background-color: #f9f9fc; }
        #project-view .tab-controls, #project-view .sub-tab-controls { display: none; flex-shrink: 0; }
        #project-view .sidebar-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
        #project-view .sidebar-actions .add-btn { width: 80%; }
        #project-view #project-main-content { flex-grow: 1; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 400px; }
        #project-view #tab-content-area { margin-bottom: 30px; }
        #project-view #tab-content-area > p:first-child:last-child { text-align: center; color: #888; margin-top: 30px; font-style: italic; } /* Placeholder */

        /* Generic Content Elements */
        .content-element { margin-bottom: 25px; padding: 20px; border: 1px dashed #e0e0e0; border-radius: 8px; position: relative; transition: all 0.2s ease; }
        .content-element:hover { border-style: solid; border-color: #b0b0b0; background-color: #fdfdfd; }
        .element-actions { position: absolute; top: 8px; right: 8px; display: none; background: rgba(245, 247, 250, 0.9); padding: 4px; border-radius: 5px; z-index: 10; gap: 4px; }
        .content-element:hover .element-actions { display: flex; }
        .element-heading { font-size: 1.5rem; border-bottom: none; margin-bottom: 10px; color: inherit; font-family: inherit; }
        .element-text { white-space: pre-wrap; line-height: 1.7; margin: 0; color: inherit; font-family: inherit;}
        .media-heading { font-size: 1.3rem; margin-bottom: 8px; color: var(--dark); border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .media-description { font-size: 0.95rem; color: #555; margin-top: 5px; margin-bottom: 15px; white-space: pre-wrap; }
        .element-image img { display: block; max-width: 100%; height: auto; border-radius: 8px; border: none; background-color: #eee; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        .element-image img[data-error="true"] { content: var(--error-image-fallback); min-height: 80px; }
        .element-image-wrapper { margin-top: 10px; overflow: hidden; position: relative; max-width: 100%; }
        .media-wrapper-16-9 { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 1000px; margin: 10px auto 0 auto; border-radius: 12px; background-color: #eee; box-shadow: 0 5px 12px rgba(0,0,0,.1); }
        .media-wrapper-16-9 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px; }

        /* Project Specific Elements (Quiz, Challenges) - Style remains the same */
        #project-view .element-quiz { background-color: #f8f9ff; padding: 20px; border: 1px solid #e0e8ff; }
        #project-view .quiz-container-inner { margin-top: 10px; } /* ... rest of quiz styles ... */
        #project-view .element-challenges { padding: 15px; background-color: #fff8e1; border: 1px solid #ffe082; }
        #project-view .challenges-list { list-style: none; padding: 0; margin: 0; } /* ... rest of challenge styles ... */

        /* Modal Styles */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.6); z-index: 1000; overflow-y: auto; padding: 20px; align-items: center; justify-content: center; animation: fadeInModal 0.3s ease; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #fff; margin: auto; padding: 25px 30px; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,.3); position: relative; display: flex; flex-direction: column; max-height: 90vh; animation: slideInModal 0.3s ease-out; }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 32px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; padding: 0 5px; z-index: 1010; }
        .close-modal:hover { color: #333; }
        #modal-title { margin-bottom: 20px; font-size: 1.4rem; }
        #modal-form-content { margin-top: 10px; overflow-y: auto; padding: 5px 15px 5px 5px; flex-grow: 1; }
        #modal-form-content label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); font-size: .95rem; }
        #modal-form-content input[type=text], #modal-form-content input[type=url], #modal-form-content input[type=number], #modal-form-content input[type=color], #modal-form-content textarea, #modal-form-content select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: inherit; background-color: #fdfdfd; }
        #modal-form-content input[type=color] { padding: 2px; height: 40px; }
        #modal-form-content textarea { min-height: 100px; white-space: pre-wrap; resize: vertical; }
        #modal-form-content input:focus, #modal-form-content textarea:focus, #modal-form-content select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2); background-color: #fff; }
        #modal-form-content .input-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        #modal-form-content .input-group > div { flex: 1; min-width: 150px; }
        #modal-form-content fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 15px 20px; margin-bottom: 20px; }
        #modal-form-content legend { font-weight: bold; padding: 0 8px; font-size: 1em; color: var(--primary); }
        #modal-form-content .form-field-group { margin-bottom: 15px; } /* Styling for project info fields */
        #modal-form-content .form-field-group label { margin-bottom: 3px; }

        /* Modal Text Style Options */
        .global-text-style-options { border: 1px solid #eee; padding: 15px; margin-top: 15px; border-radius: 6px; } /* ... styles ... */

        /* Project Specific Modal Forms (Quiz/Challenge/ColorPicker) - Styles remain same */
        #project-view #edit-modal .quiz-edit-question { /* ... styles ... */ }
        #project-view #edit-modal #challenges-editor-list { /* ... styles ... */ }
        #project-view #edit-modal .challenge-edit-item { /* ... styles ... */ }
        #project-view #edit-modal .color-picker { /* ... styles ... */ }

        .modal-actions { margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 20px; flex-shrink: 0; }
        .modal-actions button { margin-left: 10px; padding: 10px 20px; }
        .modal-actions button.cancel-btn { background-color: #aaa; color: white; border: none; }
        .modal-actions button.cancel-btn:hover { background-color: #888; }
        .modal-actions button.save-btn { background-color: var(--success); color: white; font-weight: bold; border: none;}
        .modal-actions button.save-btn:hover { background-color: #63c899; }


        /* --- STUDENT MODE STYLES --- */
        /* Course View Student Mode */
        #course-view.student-mode #course-element-add-controls,
        #course-view.student-mode .element-actions,
        #course-view.student-mode #edit-course-header-btn { /* Hide course header edit btn */
            display: none !important;
        }
        /* Project View Student Mode */
        #project-view.student-mode #edit-project-styles-btn, /* Header edit button */
        #project-view.student-mode #element-add-controls, /* Add element controls */
        #project-view.student-mode #project-sidebar .sidebar-actions .add-btn, /* Add tab button */
        #project-view.student-mode .tab-controls, /* Tab edit/remove/add-sub */
        #project-view.student-mode .sub-tab-controls, /* Sub-tab edit/remove */
        #project-view.student-mode .element-actions { /* Element edit/remove */
            display: none !important;
        }
        /* Shared Student Mode Styles */
        .view.student-mode .edit-btn, .view.student-mode .remove-btn, .view.student-mode .add-btn:not(#add-course-btn):not(#add-project-btn) { /* Hide general edit/remove/add buttons, except main Add Course/Project */
            display: none !important;
        }
        .view.student-mode .content-element:hover { border-color: #e0e0e0; background-color: transparent; border-style: dashed; }
        .view.student-mode #project-tabs .tab, .view.student-mode #project-tabs .sub-tab { cursor: default; }
        .view.student-mode #project-tabs .tab:not(.active):hover, .view.student-mode #project-tabs .sub-tab:not(.active):hover { background-color: #fff; border-color: #eee; }

        /* Responsive Styles */
        @media (max-width: 900px) { /* Project sidebar wraps */
            #project-view .project-layout { flex-direction: column; }
            #project-view #project-sidebar { width: 100%; margin-bottom: 20px; height: auto; }
            #project-view #project-tabs { display: flex; overflow-x: auto; padding-bottom: 10px; white-space: nowrap; border-bottom: 1px solid #eee;}
            #project-view .tab, #project-view .sub-tab { flex-shrink: 0; margin-right: 8px; margin-bottom: 0; }
            #project-view .tab-controls, #project-view .sub-tab-controls { display: none !important; }
            #project-view .tab-name, #project-view .sub-tab-name { margin-right: 0; } #project-view .sub-tab { margin-left: 5px; }
            #course-view .course-main-content { padding: 15px; }
        }
        @media (max-width: 768px) { /* Header stacks */
            .page-header { flex-direction: column; align-items: stretch; gap: 10px; padding: 15px; }
            .page-header .header-content { gap: 10px; justify-content: center; flex-direction: column; align-items: center; text-align: center; }
            #course-view .page-header .header-content { align-items: stretch; } /* Allow course header image to stretch */
            .page-header .header-actions { justify-content: center; flex-wrap: wrap; margin-top: 10px; }
            .view-header { flex-direction: column; align-items: stretch; text-align: center; gap: 5px; }
            .view-header h1 { text-align: center;}
            .item-list { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
        }
        @media (max-width: 600px) { /* Single column cards, smaller elements */
             :root { --global-font-size: 15px; --header-image-size: 50px; --challenge-icon-size: 30px; --card-image-height: 140px;}
             .container { padding: 10px; }
             h1 { font-size: 1.6rem; } h2 { font-size: 1.4rem; }
             .item-list { grid-template-columns: 1fr; gap: 15px; }
             #course-view .course-main-content { padding: 10px; }
             .element-controls { text-align: center; }
             .element-controls button { font-size: 0.85rem; padding: 6px 10px; margin: 5px;}
             .content-element { padding: 15px; }
             #project-view #project-main-content { padding: 15px; }
             #project-view .quiz-question-content {flex-direction: column;} /* Quiz layout adjustments */
             #project-view .challenge-item { gap: 10px; } /* Challenge layout adjustments */
             .modal-content { padding: 20px; margin: 10px; width: calc(100% - 20px); }
             .modal-actions { display: flex; justify-content: space-between;}
             .modal-actions button { flex-grow: 1; margin: 0 5px; padding: 10px 15px; font-size: 0.9rem;}
        }
    </style>
</head>
<body>

    <div class="container">

        <!-- View: Dashboard (Courses List) -->
        <div id="dashboard-view" class="view">
            <div class="view-header">
                <h1>My Courses</h1>
                <div class="view-controls">
                    <button id="app-settings-btn" title="App Settings">⚙️</button>
                </div>
            </div>
            <div id="course-list" class="item-list"> <!-- Card View Only -->
                <!-- Course cards rendered here -->
            </div>
            <div class="add-item-container">
                <button id="add-course-btn" class="add-btn">+ Add New Course</button>
            </div>
        </div>

        <!-- View: Course -->
        <div id="course-view" class="view">
             <header class="page-header course-content-header">
                 <div class="header-content"> <!-- Image + Title Container -->
                     <img id="courseHeaderImage" src="" alt="Course Header Image" data-error="false">
                     <div class="header-title-container">
                         <h2 class="header-title" id="course-content-main-title">Course Name</h2>
                     </div>
                 </div>
                 <div class="header-actions"> <!-- Right Aligned Actions -->
                    <div class="mode-toggle-switch" title="Toggle Editor/Student Mode">
                        <div class="toggle-container"><input type="checkbox" id="view-mode-toggle-course-input" checked><span class="slider"></span></div>
                    </div>
                    <button id="edit-course-header-btn" class="header-btn" title="Edit Course Header">✏️</button> <!-- Renamed Button -->
                    <button id="back-to-dashboard-btn" class="back-btn" title="Back to Courses">&larr;</button>
                 </div>
             </header>

             <div id="course-content-area" class="course-main-content">
                 <p>Loading course content...</p>
             </div>
             <div id="course-element-add-controls" class="element-controls">
                 <p>Add to this course description:</p>
                 <button data-action="add-course-element" data-type="heading">Heading</button>
                 <button data-action="add-course-element" data-type="text">Text Block</button>
                 <button data-action="add-course-element" data-type="image">Image/GIF</button>
                 <button data-action="add-course-element" data-type="video">Video</button>
                 <button data-action="add-course-element" data-type="presentation">Presentation</button>
             </div>
             <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
             <div class="view-header">
                 <h1 id="course-view-title" style="border: none; font-size: 1.8rem;">Projects</h1>
                 <!-- No view controls needed here -->
             </div>
             <div id="project-list" class="item-list"> <!-- Card View Only -->
                <!-- Project cards rendered here -->
            </div>
            <div class="add-item-container">
                <button id="add-project-btn" class="add-btn">+ Add New Project</button>
            </div>
        </div>

        <!-- View: Project Editor -->
        <div id="project-view" class="view">
             <header class="page-header">
                <div class="header-content">
                    <img id="projectHeaderImage" src="" alt="Project Header Image" data-error="false">
                    <div class="header-title-container">
                        <h2 class="header-title" id="projectTitle">Project Title</h2>
                        <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="mode-toggle-switch" title="Toggle Editor/Student Mode">
                         <div class="toggle-container"><input type="checkbox" id="view-mode-toggle-project-input" checked><span class="slider"></span></div>
                    </div>
                    <button id="edit-project-styles-btn" class="header-btn" title="Edit Project Info & Styles">⚙️</button>
                    <button id="back-to-projects-btn" class="back-btn" title="Back to Projects">&larr;</button>
                 </div>
            </header>
            <div class="project-layout">
                <aside id="project-sidebar">
                    <nav id="project-tabs"></nav>
                    <div class="sidebar-actions">
                        <button id="add-tab-btn" class="add-btn">+ Add Tab</button>
                    </div>
                </aside>
                <main id="project-main-content">
                    <div id="tab-content-area"><p>Select a section.</p></div>
                    <div id="element-add-controls" class="element-controls" style="display: none;">
                        <p>Add to this section:</p>
                        <button data-type="heading">Heading</button>
                        <button data-type="text">Text Block</button>
                        <button data-type="image">Image/GIF</button>
                        <button data-type="video">Video</button>
                        <button data-type="presentation">Presentation</button>
                        <button data-type="challenges">Challenges Section</button>
                        <button data-type="quiz">Quiz Section</button>
                    </div>
                </main>
            </div>
        </div>

    </div> <!-- End .container -->

    <!-- Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal" title="Close">&times;</span>
            <h3 id="modal-title">Edit</h3>
            <div id="modal-form-content"><!-- Form content generated by JS --></div>
            <div class="modal-actions">
                <button type="button" id="cancel-modal-btn" class="cancel-btn">Cancel</button>
                <button type="button" id="save-modal-btn" class="save-btn">Save Changes</button>
            </div>
        </div>
    </div>

<script>
// --- Constants ---
const APP_DATA_KEY = 'courseAppData_v1.4';
const PROJECT_DATA_PREFIX = 'projectData_';
const MAX_COURSES = 25; const MAX_PROJECTS_PER_COURSE = 25; const MAX_CHALLENGES = 25;
const FONT_FAMILIES = [ { name: 'Default (Segoe UI)', value: "'Segoe UI', sans-serif" }, { name: 'Arial', value: "Arial, Helvetica, sans-serif" }, { name: 'Georgia', value: "Georgia, 'Times New Roman', serif" }, { name: 'Verdana', value: "Verdana, Geneva, sans-serif" }, { name: 'Courier New', value: "'Courier New', monospace" }, { name: 'Comic Sans MS', value: "'Comic Sans MS', cursive, sans-serif" } ];
const FONT_SIZES = ['small', 'medium', 'large', 'xlarge', 'custom'];
const DEFAULT_FONT_SIZE_NAME = 'medium'; const DEFAULT_FONT_SIZE_CSS = '16px'; const DEFAULT_FONT_FAMILY = "'Segoe UI', sans-serif";
const DEFAULT_TEXT_COLOR = '#1A1D28'; const DEFAULT_PRIMARY_COLOR = '#5E81F4'; const DEFAULT_SECONDARY_COLOR = '#FF7AC6'; const DEFAULT_ACCENT_COLOR = '#FFB800';
const IMAGE_FALLBACK_SRC = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666666' font-size='12' font-family='sans-serif'%3EError%3C/text%3E%3C/svg%3E";
const DEFAULT_COURSE_IMAGE = 'https://via.placeholder.com/400x120/eee/ccc?text=Course+Image';

// --- Utility Functions ---
function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
function generateId(prefix = 'id_') { return prefix + Date.now() + '_' + Math.random().toString(36).substring(2, 9); }
function getEmbedUrlWithOptions(url) { if (!url || typeof url !== 'string') return 'about:blank'; try { if (!url.startsWith('http:') && !url.startsWith('https:') && !url.startsWith('//')) { if (url !== 'about:blank') { console.warn(`Invalid URL format for embedding: ${url}`); return 'about:blank'; } else { return url; } } let pUrl = new URL(url); if (pUrl.hostname.includes('youtube.com') || pUrl.hostname.includes('youtu.be')) { pUrl.searchParams.set('autoplay', '0'); pUrl.searchParams.set('mute', '1'); pUrl.searchParams.set('playsinline', '1'); } else if (pUrl.hostname.includes('vimeo.com')) { pUrl.searchParams.set('autoplay', '0'); pUrl.searchParams.set('dnt', '1'); } else { pUrl.searchParams.set('autoplay', '0'); } return pUrl.toString(); } catch (e) { console.error(`Error processing embed URL "${url}":`, e); return 'about:blank'; } }
function handleImageError(imgElement) { const isCourseHeader = imgElement && imgElement.id === 'courseHeaderImage'; const fallbackSrc = isCourseHeader ? DEFAULT_COURSE_IMAGE : IMAGE_FALLBACK_SRC; if (imgElement && imgElement.src !== fallbackSrc) { console.warn(`Image failed to load: ${imgElement.currentSrc || imgElement.src}. Applying fallback.`); imgElement.src = fallbackSrc; imgElement.dataset.error = "true"; } }
function hexToRgb(hex) { let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null; }
function getModalValue(selector, defaultValue = '', trimValue = true) { const inputElement = modalFormContent?.querySelector(selector); if (!inputElement) { return defaultValue; } const value = inputElement.value; return trimValue ? value.trim() : value; }
function getDefaultElementData(type) { switch (type) { case 'heading': return { text: 'New Heading' }; case 'text': return { text: 'New text block...' }; case 'image': return { url: '', alt: '', width: 'auto', height: 'auto', heading: '', description: '' }; case 'video': return { url: '', heading: '', description: '' }; case 'presentation': return { url: '', heading: '', description: '' }; case 'challenges': return { heading: 'Challenges', description: '', challenges: [] }; case 'quiz': return { questions: [] }; default: console.warn(`getDefaultElementData: Unknown type ${type}`); return {}; } }

// --- Application State ---
let appData = { globalStyles: {}, courses: [] };
let currentProjectData = null;
let currentView = 'dashboard';
let activeCourseId = null;
let activeProjectId = null;
let editingContext = { type: null, id: null, parentId: null, isNew: false, elementType: null };

// --- DOM Element Lookups ---
const dashboardView = document.getElementById('dashboard-view'), courseView = document.getElementById('course-view'), projectView = document.getElementById('project-view');
const courseListContainer = document.getElementById('course-list'), projectListContainer = document.getElementById('project-list');
const courseViewTitle = document.getElementById('course-view-title'), courseContentMainTitle = document.getElementById('course-content-main-title'), courseHeaderImage = document.getElementById('courseHeaderImage');
const courseContentArea = document.getElementById('course-content-area'), courseElementAddControls = document.getElementById('course-element-add-controls');
const appSettingsButton = document.getElementById('app-settings-btn'), addCourseButton = document.getElementById('add-course-btn'), addProjectButton = document.getElementById('add-project-btn');
const backToDashboardButton = document.getElementById('back-to-dashboard-btn'), backToProjectsButton = document.getElementById('back-to-projects-btn');
const editCourseHeaderBtn = document.getElementById('edit-course-header-btn'); // Renamed
const courseModeToggleInput = document.getElementById('view-mode-toggle-course-input'), projectModeToggleInput = document.getElementById('view-mode-toggle-project-input');
const modal = document.getElementById('edit-modal'), modalTitle = document.getElementById('modal-title'), modalFormContent = document.getElementById('modal-form-content');
const closeModalButton = document.getElementById('close-modal-btn'), cancelModalButton = document.getElementById('cancel-modal-btn'), saveModalButton = document.getElementById('save-modal-btn');
let projectEditorElements = {}; // Populated in initProjectEditor

// --- Data Management ---
function loadAppData() { /* ... (logic as previously refined, ensures description/imageUrl exist) ... */ const storedData = localStorage.getItem(APP_DATA_KEY); if (storedData) { try { const parsed = JSON.parse(storedData); if (parsed && Array.isArray(parsed.courses)) { appData = { globalStyles: { appFontFamily: parsed.globalStyles?.appFontFamily || DEFAULT_FONT_FAMILY, appFontSize: parsed.globalStyles?.appFontSize || DEFAULT_FONT_SIZE_NAME, appPrimaryColor: parsed.globalStyles?.appPrimaryColor || DEFAULT_PRIMARY_COLOR, appSecondaryColor: parsed.globalStyles?.appSecondaryColor || DEFAULT_SECONDARY_COLOR, appAccentColor: parsed.globalStyles?.appAccentColor || DEFAULT_ACCENT_COLOR, appTextColor: parsed.globalStyles?.appTextColor || DEFAULT_TEXT_COLOR, }, courses: parsed.courses || [] }; appData.courses.forEach(course => { course.imageUrl = course.imageUrl || null; course.description = course.description || ''; course.content = Array.isArray(course.content) ? course.content : []; course.styles = course.styles || {}; if (!Array.isArray(course.projects)) course.projects = []; course.projects.forEach(project => { project.imageUrl = project.imageUrl || null; project.description = project.description || ''; }); }); console.log("App data loaded."); return; } } catch (e) { console.error("Failed to parse app data, resetting.", e); localStorage.removeItem(APP_DATA_KEY); } } appData = { globalStyles: { appFontFamily: DEFAULT_FONT_FAMILY, appFontSize: DEFAULT_FONT_SIZE_NAME, appPrimaryColor: DEFAULT_PRIMARY_COLOR, appSecondaryColor: DEFAULT_SECONDARY_COLOR, appAccentColor: DEFAULT_ACCENT_COLOR, appTextColor: DEFAULT_TEXT_COLOR, }, courses: [] }; console.log("Initialized default app data."); }
function saveAppData() { try { localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData)); console.log("App data saved."); } catch (e) { console.error("Failed to save app data:", e); alert("Error: Could not save application data."); } }
function getProjectDataKey(projectId) { return `${PROJECT_DATA_PREFIX}${projectId}`; }
function loadSpecificProjectData(projectId) { /* ... (logic as previously refined) ... */ const key = getProjectDataKey(projectId); const storedData = localStorage.getItem(key); if (storedData) { try { const parsed = JSON.parse(storedData); if (parsed && Array.isArray(parsed.tabs)) { parsed.styles = parsed.styles || {}; const defaultStyles = appData.globalStyles || {}; parsed.styles.primaryColor = parsed.styles.primaryColor === null ? null : (parsed.styles.primaryColor || defaultStyles.appPrimaryColor || DEFAULT_PRIMARY_COLOR); parsed.styles.secondaryColor = parsed.styles.secondaryColor === null ? null : (parsed.styles.secondaryColor || defaultStyles.appSecondaryColor || DEFAULT_SECONDARY_COLOR); parsed.styles.accentColor = parsed.styles.accentColor === null ? null : (parsed.styles.accentColor || defaultStyles.appAccentColor || DEFAULT_ACCENT_COLOR); parsed.styles.globalTextColor = parsed.styles.globalTextColor === null ? null : (parsed.styles.globalTextColor || defaultStyles.appTextColor || DEFAULT_TEXT_COLOR); parsed.styles.globalFontSize = parsed.styles.globalFontSize === null ? null : (parsed.styles.globalFontSize || defaultStyles.appFontSize || DEFAULT_FONT_SIZE_NAME); parsed.styles.globalFontFamily = parsed.styles.globalFontFamily === null ? null : (parsed.styles.globalFontFamily || defaultStyles.appFontFamily || DEFAULT_FONT_FAMILY); parsed.headerImage = parsed.headerImage || getDefaultProjectDataTemplate().headerImage; const projectMeta = findProjectMeta(projectId); parsed.title = parsed.title || projectMeta?.name || "Untitled Project"; parsed.subtitle = parsed.subtitle || projectMeta?.description || ""; console.log(`Project data loaded for ${projectId}`); return parsed; } } catch (e) { console.error(`Failed to parse project data for ${projectId}, returning default.`, e); } } console.log(`No valid data found for project ${projectId}, creating default.`); const projectMeta = findProjectMeta(projectId); const defaultData = getDefaultProjectDataTemplate(); defaultData.title = projectMeta?.name || "New Project"; defaultData.subtitle = projectMeta?.description || ""; defaultData.headerImage = projectMeta?.imageUrl || defaultData.headerImage; defaultData.styles = { primaryColor: null, secondaryColor: null, accentColor: null, globalTextColor: null, globalFontSize: null, globalFontFamily: null }; return defaultData; }
function saveSpecificProjectData(projectId, projectDataToSave) { /* ... (logic as previously refined, syncs meta) ... */ if (!projectId || !projectDataToSave) { console.error("Cannot save project data: Project ID or data missing."); return; } const key = getProjectDataKey(projectId); try { const projectMeta = findProjectMeta(projectId); if (projectMeta) { let metaChanged = false; if (projectMeta.name !== projectDataToSave.title) { projectMeta.name = projectDataToSave.title; metaChanged = true; } if (projectMeta.description !== projectDataToSave.subtitle) { projectMeta.description = projectDataToSave.subtitle; metaChanged = true; } if (projectMeta.imageUrl !== projectDataToSave.headerImage) { projectMeta.imageUrl = projectDataToSave.headerImage; metaChanged = true; } if (metaChanged) saveAppData(); } localStorage.setItem(key, JSON.stringify(projectDataToSave)); console.log(`Project data saved for ${projectId}`); } catch (e) { console.error(`Failed to save project data for ${projectId}:`, e); alert(`Error: Could not save project data for ${projectId}.`); } }
function deleteSpecificProjectData(projectId) { localStorage.removeItem(getProjectDataKey(projectId)); console.log(`Project data deleted for ${projectId}`); }
function getDefaultProjectDataTemplate() { const firstTabId = generateId('tab_'); return { title: "New Project", subtitle: "", headerImage: "https://via.placeholder.com/80/eee/ccc?text=P", styles: { primaryColor: null, secondaryColor: null, accentColor: null, globalFontFamily: null, globalFontSize: null, globalTextColor: null }, tabs: [ { id: firstTabId, name: "Section 1", subTabs: null, content: [ { id: generateId('el_'), type: 'heading', data: { text: 'Welcome!' } } ] } ] }; }
function findCourse(courseId) { return appData.courses.find(c => c.id === courseId); }
function findProjectMeta(projectId) { for (const course of appData.courses) { const project = course.projects.find(p => p.id === projectId); if (project) return project; } return null; }
function findProjectCourse(projectId) { for (const course of appData.courses) { if (course.projects.find(p => p.id === projectId)) return course; } return null; }
function findCourseElementData(courseId, elementId) { const course = findCourse(courseId); if (!course || !Array.isArray(course.content)) return null; const index = course.content.findIndex(el => el?.id === elementId); return index !== -1 ? { element: course.content[index], parentArray: course.content, index: index } : null; }

// --- Apply Global Styles ---
function applyGlobalAppStyles() { /* ... (logic as previously defined) ... */ const styles = appData.globalStyles; const root = document.documentElement; root.style.setProperty('--primary', styles.appPrimaryColor || DEFAULT_PRIMARY_COLOR); root.style.setProperty('--secondary', styles.appSecondaryColor || DEFAULT_SECONDARY_COLOR); root.style.setProperty('--accent', styles.appAccentColor || DEFAULT_ACCENT_COLOR); root.style.setProperty('--global-text-color', styles.appTextColor || DEFAULT_TEXT_COLOR); root.style.setProperty('--global-font-family', styles.appFontFamily || DEFAULT_FONT_FAMILY); const sizeMap = { small: '14px', medium: '16px', large: '18px', xlarge: '20px' }; const sizeName = styles.appFontSize || DEFAULT_FONT_SIZE_NAME; const cssFontSize = sizeMap[sizeName] || sizeName || DEFAULT_FONT_SIZE_CSS; root.style.setProperty('--global-font-size', cssFontSize); const rgb = hexToRgb(styles.appPrimaryColor || DEFAULT_PRIMARY_COLOR); if (rgb) root.style.setProperty('--primary-rgb', rgb); console.log("Global app styles applied."); }

// --- View Management ---
function showView(viewName, courseId = null, projectId = null) { /* ... (logic as previously refined, removes student-mode) ... */ console.log(`Showing view: ${viewName}`, `Course: ${courseId}`, `Project: ${projectId}`); document.querySelectorAll('.view').forEach(v => { v.classList.remove('active'); v.classList.remove('student-mode'); }); activeCourseId = null; activeProjectId = null; currentProjectData = null; teardownEventListeners_Editor(); if (courseModeToggleInput) courseModeToggleInput.checked = true; if (projectModeToggleInput) projectModeToggleInput.checked = true; let targetViewElement; let hash = '#'; switch (viewName) { case 'dashboard': targetViewElement = dashboardView; currentView = 'dashboard'; renderDashboardView(); break; case 'course': targetViewElement = courseView; currentView = 'course'; activeCourseId = courseId; if (!activeCourseId) { console.error("Course ID missing."); showView('dashboard'); return; } renderCourseView(activeCourseId); applyCourseSpecificStyles(activeCourseId); hash = `#/course/${activeCourseId}`; break; case 'project': targetViewElement = projectView; currentView = 'project'; activeProjectId = projectId; if (!activeProjectId) { console.error("Project ID missing."); showView('dashboard'); return; } const parentCourse = findProjectCourse(activeProjectId); activeCourseId = parentCourse?.id; initProjectEditor(activeProjectId); hash = `#/project/${activeProjectId}`; break; default: targetViewElement = dashboardView; currentView = 'dashboard'; renderDashboardView(); } if (targetViewElement) { targetViewElement.classList.add('active'); window.scrollTo(0, 0); } if (window.location.hash !== hash) { history.pushState({ view: viewName, courseId: activeCourseId, projectId: activeProjectId }, '', hash); } }

// --- Card Rendering Functions ---
function renderDashboardView() { /* ... (logic as previously refined for card view) ... */ courseListContainer.innerHTML = ''; if (appData.courses.length === 0) { courseListContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #777;">No courses created yet.</p>'; } else { appData.courses.forEach(course => { const itemElement = document.createElement('div'); itemElement.className = 'item-card item-container'; itemElement.dataset.courseId = course.id; itemElement.title = `View Course: ${course.name}`; const defaultImage = DEFAULT_COURSE_IMAGE; const imageUrl = course.imageUrl || defaultImage; const descriptionHtml = course.description ? `<p>${escapeHtml(course.description)}</p>` : '<p>&nbsp;</p>'; itemElement.innerHTML = `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(course.name)}" class="item-image" onerror="handleImageError(this)" data-error="false"><div class="item-content"><h4>${escapeHtml(course.name)}</h4>${descriptionHtml}</div>`; courseListContainer.appendChild(itemElement); checkRenderedImageError(itemElement.querySelector('.item-image')); }); } addCourseButton.disabled = appData.courses.length >= MAX_COURSES; updateMaxItemsMessage(addCourseButton, 'max-courses-msg', MAX_COURSES, 'courses'); }
function renderCourseView(courseId) { /* ... (logic as previously refined, sets header image) ... */ const course = findCourse(courseId); if (!course) { console.error(`Course not found: ${courseId}`); showView('dashboard'); return; } courseContentMainTitle.textContent = escapeHtml(course.name); const headerImgUrl = course.imageUrl || DEFAULT_COURSE_IMAGE; courseHeaderImage.src = headerImgUrl; courseHeaderImage.alt = `${escapeHtml(course.name)} Header Image`; courseHeaderImage.dataset.error = "false"; checkRenderedImageError(courseHeaderImage); courseContentArea.innerHTML = ''; if (course.content && course.content.length > 0) { course.content.forEach(elementData => renderElement(elementData, courseContentArea, 'course-element')); } else { courseContentArea.innerHTML = '<p style="text-align: center; color: #888; padding: 20px 0;">This course has no introductory content yet. Add some below!</p>'; } renderProjectListForCourse(courseId); courseElementAddControls.style.display = 'block'; }
function renderProjectListForCourse(courseId) { /* ... (logic as previously refined for card view) ... */ projectListContainer.innerHTML = ''; const course = findCourse(courseId); if (!course) return; courseViewTitle.textContent = `Projects`; const projects = course.projects || []; if (projects.length === 0) { projectListContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #777;">No projects added yet.</p>'; } else { projects.forEach(project => { const itemElement = document.createElement('div'); itemElement.className = 'item-card item-container'; itemElement.dataset.projectId = project.id; itemElement.dataset.courseId = courseId; itemElement.title = `View Project: ${project.name}`; const defaultImage = 'https://via.placeholder.com/300x150/eee/ccc?text=Project'; const imageUrl = project.imageUrl || defaultImage; const descriptionHtml = project.description ? `<p>${escapeHtml(project.description)}</p>` : '<p>&nbsp;</p>'; itemElement.innerHTML = `<img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(project.name)}" class="item-image" onerror="handleImageError(this)" data-error="false"><div class="item-content"><h4>${escapeHtml(project.name)}</h4>${descriptionHtml}</div>`; projectListContainer.appendChild(itemElement); checkRenderedImageError(itemElement.querySelector('.item-image')); }); } addProjectButton.disabled = projects.length >= MAX_PROJECTS_PER_COURSE; updateMaxItemsMessage(addProjectButton, 'max-projects-msg', MAX_PROJECTS_PER_COURSE, 'projects'); }
function checkRenderedImageError(imgElement) { /* ... (same) ... */ if (imgElement && imgElement.complete && imgElement.naturalWidth === 0 && !imgElement.dataset.error) { handleImageError(imgElement); } }
function updateMaxItemsMessage(button, msgId, max, itemType) { /* ... (same) ... */ document.getElementById(msgId)?.remove(); if(button.disabled) { button.insertAdjacentHTML('afterend', `<p id="${msgId}" style="color:var(--danger); font-size:0.9em; text-align: center;">Maximum ${itemType} (${max}) reached.</p>`); } }

// --- Generic Element Rendering ---
function renderElement(elData, container, contextType = 'project-element') { /* ... (logic as previously defined) ... */ const wrap = document.createElement('div'); wrap.className = `content-element element-${elData.type}`; wrap.dataset.elementId = elData.id; wrap.appendChild(createStandardActions(elData.id, elData.type, contextType)); let html = ''; try { const d = elData.data || {}; if (['image', 'video', 'presentation', 'challenges', 'quiz'].includes(elData.type)) { if (d.heading) html += `<h3 class="media-heading">${escapeHtml(d.heading)}</h3>`; if (d.description) html += `<p class="media-description">${escapeHtml(d.description)}</p>`; } switch (elData.type) { case 'heading': html += `<h2 class="element-heading">${escapeHtml(d.text || 'Heading')}</h2>`; break; case 'text': html += `<p class="element-text">${escapeHtml(d.text || 'Text block...')}</p>`; break; case 'image': const iUrl = d.url || '', iAlt = escapeHtml(d.alt || ''), iW = escapeHtml(d.width || 'auto'), iH = escapeHtml(d.height || 'auto'); html += `<div class="element-image-wrapper"><img src="${escapeHtml(iUrl)}" alt="${iAlt}" style="width:${iW};height:${iH};" onerror="handleImageError(this)" data-error="false"></div>`; break; case 'video': case 'presentation': const eUrl = d.url || 'about:blank', fUrl = getEmbedUrlWithOptions(eUrl); const eTitle = escapeHtml(elData.type === 'video' ? 'Video Content' : 'Presentation Content'); html += `<div class="media-wrapper-16-9"><iframe src="${escapeHtml(fUrl)}" title="${eTitle}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>`; break; case 'quiz': if (contextType === 'project-element') renderQuizElement_Editor(elData, wrap); else html += `<p>[Quiz Element - Viewable in Project Editor]</p>`; html = null; break; case 'challenges': if (contextType === 'project-element') renderChallengesElement_Editor(elData, wrap); else html += `<p>[Challenges Element - Viewable in Project Editor]</p>`; html = null; break; default: html = `<p>Unknown element type: ${escapeHtml(elData.type)}</p>`; } if (html !== null) { wrap.insertAdjacentHTML('beforeend', html); checkRenderedImageError(wrap.querySelector('img')); } } catch (e) { console.error("Error rendering element:", elData, e); wrap.insertAdjacentHTML('beforeend', `<p style="color:var(--danger);">Error rendering element.</p>`); } container.appendChild(wrap); }
function createStandardActions(id, type, contextType) { /* ... (same) ... */ const el = document.createElement('div'); el.className = 'element-actions'; const editAction = contextType === 'course-element' ? 'edit-course-element' : 'edit-element'; const removeAction = contextType === 'course-element' ? 'remove-course-element' : 'remove-element'; el.innerHTML = `<button class="edit-btn action-btn" title="Edit" data-action="${editAction}" data-element-id="${id}">✏️</button><button class="remove-btn action-btn" title="Remove" data-action="${removeAction}" data-element-id="${id}">&times;</button>`; return el; }

// --- Project Editor Logic ---
function initProjectEditor(projectId) { /* ... (logic as previously refined) ... */ console.log(`Initializing project editor for: ${projectId}`); currentProjectData = loadSpecificProjectData(projectId); if (!currentProjectData) { console.error("Failed to load project data for editor."); showView('course', activeCourseId); return; } projectEditorElements = { projectTitleElement: document.getElementById('projectTitle'), projectSubtitleElement: document.getElementById('projectSubtitle'), projectHeaderImageElement: document.getElementById('projectHeaderImage'), tabsContainer: projectView.querySelector('#project-tabs'), contentArea: projectView.querySelector('#tab-content-area'), addControls: projectView.querySelector('#element-add-controls'), addTabButton: projectView.querySelector('#add-tab-btn'), editStylesButton: projectView.querySelector('#edit-project-styles-btn') }; if (!projectEditorElements.tabsContainer || !projectEditorElements.contentArea || !projectEditorElements.addControls) { console.error("Essential project editor elements not found!"); projectView.querySelector('#project-main-content').innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading editor.</p>'; return; } projectEditorState.currentTabId = null; projectEditorState.currentSubTabId = null; applyProjectStyles_Editor(); renderSidebar_Editor(); initContent_Editor(); setupEventListeners_Editor(); console.log("Project Editor Initialized."); }
const projectEditorState = { currentTabId: null, currentSubTabId: null };
function applyProjectStyles_Editor() { /* ... (same) ... */ const styles = currentProjectData.styles || {}; const globalStyles = appData.globalStyles || {}; const root = document.documentElement; const finalPrimary = styles.primaryColor !== null ? styles.primaryColor : (globalStyles.appPrimaryColor || DEFAULT_PRIMARY_COLOR); const finalSecondary = styles.secondaryColor !== null ? styles.secondaryColor : (globalStyles.appSecondaryColor || DEFAULT_SECONDARY_COLOR); const finalAccent = styles.accentColor !== null ? styles.accentColor : (globalStyles.appAccentColor || DEFAULT_ACCENT_COLOR); const finalTextColor = styles.globalTextColor !== null ? styles.globalTextColor : (globalStyles.appTextColor || DEFAULT_TEXT_COLOR); const finalFontFamily = styles.globalFontFamily !== null ? styles.globalFontFamily : (globalStyles.appFontFamily || DEFAULT_FONT_FAMILY); const finalFontSizeName = styles.globalFontSize !== null ? styles.globalFontSize : (globalStyles.appFontSize || DEFAULT_FONT_SIZE_NAME); root.style.setProperty('--primary', finalPrimary); root.style.setProperty('--secondary', finalSecondary); root.style.setProperty('--accent', finalAccent); root.style.setProperty('--global-text-color', finalTextColor); root.style.setProperty('--global-font-family', finalFontFamily); const sizeMap = { small: '14px', medium: '16px', large: '18px', xlarge: '20px' }; const finalCssFontSize = sizeMap[finalFontSizeName] || finalFontSizeName || DEFAULT_FONT_SIZE_CSS; root.style.setProperty('--global-font-size', finalCssFontSize); const rgb = hexToRgb(finalPrimary); if (rgb) root.style.setProperty('--primary-rgb', rgb); projectEditorElements.projectTitleElement.textContent = currentProjectData.title || 'Project'; projectEditorElements.projectSubtitleElement.textContent = currentProjectData.subtitle || ''; const imgElement = projectEditorElements.projectHeaderImageElement; imgElement.src = currentProjectData.headerImage || IMAGE_FALLBACK_SRC; imgElement.dataset.error = "false"; imgElement.onerror = () => handleImageError(imgElement); checkRenderedImageError(imgElement); }
function renderSidebar_Editor() { /* ... (same) ... */ const { tabsContainer } = projectEditorElements; tabsContainer.innerHTML = ''; if (!currentProjectData.tabs?.length) { tabsContainer.innerHTML = '<p style="text-align:center;color:#888;font-style:italic;">No tabs.</p>'; return; } currentProjectData.tabs.forEach(t => { if (!t?.id) return; const tEl = document.createElement('div'); tEl.className = 'tab'; tEl.dataset.tabId = t.id; let isPActive = (t.id === projectEditorState.currentTabId && !projectEditorState.currentSubTabId && (!t.subTabs || t.subTabs.length === 0)); const nSpan = document.createElement('span'); nSpan.className = 'tab-name'; nSpan.textContent = t.name || '...'; nSpan.dataset.tabId = t.id; tEl.appendChild(nSpan); tEl.appendChild(createControlsDiv_Editor('tab', t.id)); tabsContainer.appendChild(tEl); if (Array.isArray(t.subTabs) && t.subTabs.length > 0) { if (t.id === projectEditorState.currentTabId && projectEditorState.currentSubTabId && t.subTabs.some(st => st?.id === projectEditorState.currentSubTabId)) { isPActive = false; } t.subTabs.forEach(st => { if (!st?.id) return; const sEl = document.createElement('div'); sEl.className = 'sub-tab'; sEl.dataset.subTabId = st.id; sEl.dataset.parentTabId = t.id; if (st.id === projectEditorState.currentSubTabId && t.id === projectEditorState.currentTabId) sEl.classList.add('active'); const sName = document.createElement('span'); sName.className = 'sub-tab-name'; sName.textContent = st.name || '...'; sName.dataset.parentTabId = t.id; sName.dataset.subTabId = st.id; sEl.appendChild(sName); sEl.appendChild(createControlsDiv_Editor('subtab', t.id, st.id)); tabsContainer.appendChild(sEl); }); } if (isPActive) tEl.classList.add('active'); }); }
function createControlsDiv_Editor(type, tId, sId = null) { /* ... (same) ... */ const d = document.createElement('div'); d.className = type === 'tab' ? 'tab-controls' : 'sub-tab-controls'; let h = ''; if (type === 'tab') { h += `<button class="add-btn action-btn" title="Add Sub-Tab" data-action="add-subtab" data-tab-id="${tId}">+ Sub</button><button class="edit-btn action-btn" title="Edit Tab" data-action="edit-tab" data-tab-id="${tId}">✏️</button><button class="remove-btn action-btn" title="Remove Tab" data-action="remove-tab" data-tab-id="${tId}">&times;</button>`; } else { h += `<button class="edit-btn action-btn" title="Edit Sub-Tab" data-action="edit-subtab" data-parent-tab-id="${tId}" data-sub-tab-id="${sId}">✏️</button><button class="remove-btn action-btn" title="Remove Sub-Tab" data-action="remove-subtab" data-parent-tab-id="${tId}" data-sub-tab-id="${sId}">&times;</button>`; } d.innerHTML = h; return d; }
function renderContentArea_Editor() { /* ... (same) ... */ const { contentArea, addControls } = projectEditorElements; contentArea.innerHTML = ''; addControls.style.display = 'none'; const contentArray = getCurrentContentArray_Editor(); if (contentArray === null) { const tabData = findTabData_Editor(projectEditorState.currentTabId); if (!projectEditorState.currentTabId) contentArea.innerHTML = '<p>Select a tab from the sidebar.</p>'; else if (tabData && Array.isArray(tabData.subTabs) && tabData.subTabs.length > 0 && !projectEditorState.currentSubTabId) contentArea.innerHTML = '<p>Select a sub-tab to view content.</p>'; else contentArea.innerHTML = '<p>Select a valid section.</p>'; return; } addControls.style.display = 'block'; if (contentArray.length === 0) { contentArea.innerHTML = '<p>This section is empty. Add elements below.</p>'; } else { contentArray.forEach(elData => { if (elData?.id && elData.type) { renderElement(elData, contentArea, 'project-element'); } }); } }
function renderQuizElement_Editor(quizData, wrap) { /* ... (same) ... */ const cont = document.createElement('div'); cont.className = 'quiz-container-inner'; cont.dataset.quizId = quizData.id; const qs = quizData.data?.questions || []; if (qs.length === 0) { cont.innerHTML = '<p>No questions defined.</p>'; } else { qs.forEach((q, i) => { if (!q) return; const qDiv = document.createElement('div'); qDiv.className = 'quiz-question'; qDiv.dataset.questionIndex = i; const qCont = document.createElement('div'); qCont.className = 'quiz-question-content'; if (q.questionImageUrl) { const img = document.createElement('img'); img.className = 'quiz-question-image'; img.src = escapeHtml(q.questionImageUrl); img.alt = `Q${i + 1} Img`; img.onerror = () => handleImageError(img); img.dataset.error = "false"; qCont.appendChild(img); checkRenderedImageError(img); } qCont.innerHTML += `<p class="quiz-question-text">${i + 1}. ${escapeHtml(q.questionText || '...')}</p>`; qDiv.appendChild(qCont); const optsDiv = document.createElement('div'); optsDiv.className = 'quiz-options'; const cAns = String(q.correctAnswer || '').trim(); const iAns = Array.isArray(q.incorrectAnswers) ? q.incorrectAnswers : []; const iImgs = Array.isArray(q.incorrectAnswersImageUrls) ? q.incorrectAnswersImageUrls : []; const iOpts = iAns.map((t, idx) => ({ text: String(t || '').trim(), img: iImgs[idx] || null })).filter(o => o.text !== ''); const allOptsData = [{ text: cAns, img: q.correctAnswerImageUrl || null, isC: true }, ...iOpts.map(o => ({ ...o, isC: false }))].filter(o => o.text !== ''); if (allOptsData.length > 0) { [...allOptsData].sort(() => Math.random() - 0.5).forEach(oD => { const oEl = document.createElement('div'); oEl.className = 'quiz-option'; oEl.dataset.isCorrect = oD.isC.toString(); if (oD.img) { const optImg = document.createElement('img'); optImg.className = 'quiz-option-image'; optImg.src = escapeHtml(oD.img); optImg.alt = 'Option Img'; optImg.onerror = () => handleImageError(optImg); optImg.dataset.error = "false"; oEl.appendChild(optImg); checkRenderedImageError(optImg); } oEl.innerHTML += `<span class="quiz-option-text">${escapeHtml(oD.text)}</span>`; optsDiv.appendChild(oEl); }); } else { optsDiv.innerHTML = '<p style="font-size:0.9em;color:red;">No options.</p>'; } qDiv.appendChild(optsDiv); qDiv.innerHTML += `<div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;">Incorrect</div>`; cont.appendChild(qDiv); }); } cont.innerHTML += `<button class="quiz-submit-btn" data-action="submit-quiz" data-quiz-id="${quizData.id}" ${qs.length === 0 ? 'disabled' : ''}>Submit</button><div class="final-quiz-result" style="display:none;"></div>`; wrap.appendChild(cont); }
function renderChallengesElement_Editor(elData, wrap) { /* ... (same) ... */ const chs = elData.data?.challenges || []; const list = document.createElement('ul'); list.className = 'challenges-list'; if (chs.length === 0) { list.innerHTML = '<li><p>No challenges.</p></li>'; } else { chs.forEach(c => { if (!c?.id || !c.heading) return; const item = document.createElement('li'); item.className = 'challenge-item'; item.dataset.challengeId = c.id; let itemHtml = ''; const iconUrl = c.iconUrl || IMAGE_FALLBACK_SRC; itemHtml += `<img class="challenge-icon" src="${escapeHtml(iconUrl)}" alt="Icon" onerror="handleImageError(this)" data-error="false">`; itemHtml += '<div class="challenge-content">'; itemHtml += `<h4>${escapeHtml(c.heading)}</h4>`; if (c.description) itemHtml += `<p>${escapeHtml(c.description)}</p>`; if (c.imageUrl) { const imgUrl = c.imageUrl; itemHtml += `<img src="${escapeHtml(imgUrl)}" alt="Challenge Img" onerror="handleImageError(this)" data-error="false">`; } itemHtml += '</div>'; item.innerHTML = itemHtml; item.querySelectorAll('img').forEach(img => checkRenderedImageError(img)); list.appendChild(item); }); } wrap.appendChild(list); }
function initContent_Editor() { /* ... (same) ... */ let targetTabId = null; let targetSubTabId = null; if (currentProjectData.tabs?.[0]?.id) { targetTabId = currentProjectData.tabs[0].id; const firstTab = currentProjectData.tabs[0]; if(Array.isArray(firstTab.subTabs) && firstTab.subTabs[0]?.id) { targetSubTabId = firstTab.subTabs[0].id; } } if (targetTabId) { setActiveTab_Editor(targetTabId, targetSubTabId); } else { renderSidebar_Editor(); renderContentArea_Editor(); } }
function findTabData_Editor(tabId) { /* ... (same) ... */ return currentProjectData?.tabs?.find(t => t?.id === tabId) || null; }
function findSubTabData_Editor(parentTabId, subTabId) { /* ... (same) ... */ return findTabData_Editor(parentTabId)?.subTabs?.find(st => st?.id === subTabId) || null; }
function getCurrentContentArray_Editor() { /* ... (same) ... */ const tab = findTabData_Editor(projectEditorState.currentTabId); if (!tab) return null; if (projectEditorState.currentSubTabId) { const subTab = findSubTabData_Editor(projectEditorState.currentTabId, projectEditorState.currentSubTabId); if (subTab) { if (!Array.isArray(subTab.content)) subTab.content = []; return subTab.content; } return null; } else { if (tab.subTabs === null || (Array.isArray(tab.subTabs) && tab.subTabs.length === 0)) { if (!Array.isArray(tab.content)) tab.content = []; return tab.content; } return null; } }
function findElementData_Editor(elementId) { /* ... (same) ... */ if (!currentProjectData?.tabs || !elementId) return null; for (const t of currentProjectData.tabs) { if (!t) continue; if ((!t.subTabs || t.subTabs.length === 0) && Array.isArray(t.content)) { const i = t.content.findIndex(el => el?.id === elementId); if (i !== -1) return { element: t.content[i], parentArray: t.content, parentType: 'tab', parentId: t.id, index: i }; } else if (Array.isArray(t.subTabs)) { for (const s of t.subTabs) { if (!s || !Array.isArray(s.content)) continue; const i = s.content.findIndex(el => el?.id === elementId); if (i !== -1) return { element: s.content[i], parentArray: s.content, parentType: 'subtab', parentId: s.id, grandparentTabId: t.id, index: i }; } } } console.warn("findElementData_Editor: Element not found:", elementId); return null; }
function setActiveTab_Editor(tId, sId = null) { /* ... (same) ... */ const tData = findTabData_Editor(tId); if (!tData) { initContent_Editor(); return; } const oldT = projectEditorState.currentTabId, oldS = projectEditorState.currentSubTabId; projectEditorState.currentTabId = tId; projectEditorState.currentSubTabId = null; if (Array.isArray(tData.subTabs) && tData.subTabs.length > 0) { if (sId && findSubTabData_Editor(tId, sId)) projectEditorState.currentSubTabId = sId; else if (tData.subTabs[0]?.id) projectEditorState.currentSubTabId = tData.subTabs[0].id; } if (projectEditorState.currentTabId !== oldT || projectEditorState.currentSubTabId !== oldS) { console.log(`Editor Active Tab: T=${projectEditorState.currentTabId}, S=${projectEditorState.currentSubTabId}`); renderSidebar_Editor(); renderContentArea_Editor(); } }
function addTabAction_Editor() { /* ... (same) ... */ const id = generateId('tab_'); const t = { id, name: `Tab ${currentProjectData.tabs.length + 1}`, subTabs: null, content: [] }; if (!Array.isArray(currentProjectData.tabs)) currentProjectData.tabs = []; currentProjectData.tabs.push(t); saveSpecificProjectData(activeProjectId, currentProjectData); setActiveTab_Editor(id); openEditModal('tab', id, null, true); }
function addSubTabAction_Editor(pId) { /* ... (same) ... */ const pTab = findTabData_Editor(pId); if (!pTab) return; const id = generateId('sub_'); const st = { id, name: `Sub ${pTab.subTabs?.length ? pTab.subTabs.length + 1 : 1}`, content: [] }; if (!Array.isArray(pTab.subTabs)) { if (pTab.content?.length) { if (!confirm("Adding sub-tab will remove direct tab content. Continue?")) return; } pTab.content = undefined; pTab.subTabs = []; } pTab.subTabs.push(st); saveSpecificProjectData(activeProjectId, currentProjectData); setActiveTab_Editor(pId, id); openEditModal('subtab', id, pId, true); }
function addElementAction_Editor(type) { /* ... (same) ... */ if (!projectEditorState.currentTabId) { alert("Select a tab/sub-tab first."); return; } const arr = getCurrentContentArray_Editor(); if (arr === null) { alert(findTabData_Editor(projectEditorState.currentTabId)?.subTabs ? "Select a sub-tab." : "Cannot add element here."); return; } const id = generateId(type + '_'); openEditModal('element', id, null, true, type); }
function removeTabAction_Editor(id) { /* ... (same) ... */ const i = currentProjectData.tabs?.findIndex(t => t?.id === id); if (i === -1) return; if (!confirm(`DELETE tab "${escapeHtml(currentProjectData.tabs[i].name)}"?`)) return; currentProjectData.tabs.splice(i, 1); saveSpecificProjectData(activeProjectId, currentProjectData); if (projectEditorState.currentTabId === id) { projectEditorState.currentTabId = null; projectEditorState.currentSubTabId = null; initContent_Editor(); } else renderSidebar_Editor(); }
function removeSubTabAction_Editor(pId, id) { /* ... (same) ... */ const pTab = findTabData_Editor(pId); const i = pTab?.subTabs?.findIndex(st => st?.id === id); if (!pTab || i === -1) return; if (!confirm(`DELETE sub-tab "${escapeHtml(pTab.subTabs[i].name)}"?`)) return; pTab.subTabs.splice(i, 1); saveSpecificProjectData(activeProjectId, currentProjectData); if (projectEditorState.currentSubTabId === id && projectEditorState.currentTabId === pId) { projectEditorState.currentSubTabId = null; setActiveTab_Editor(pId); } else renderSidebar_Editor(); }
function removeElementAction_Editor(id) { /* ... (same) ... */ const res = findElementData_Editor(id); if (!res) { alert("Element not found."); return; } if (!confirm(`Remove ${res.element.type} element?`)) return; res.parentArray.splice(res.index, 1); saveSpecificProjectData(activeProjectId, currentProjectData); renderContentArea_Editor(); }
function selectQuizOption_Editor(optEl) { /* ... (same) ... */ const qDiv = optEl.closest('.quiz-question'); if (!qDiv || qDiv.classList.contains('answered')) return; qDiv.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected')); optEl.classList.add('selected'); }
function submitQuizAction_Editor(quizId) { /* ... (same) ... */ const qEl = projectEditorElements.contentArea?.querySelector(`.content-element[data-element-id="${quizId}"]`); const cont = qEl?.querySelector('.quiz-container-inner'); if (!cont) return; const qs = cont.querySelectorAll('.quiz-question'); let score = 0, answered = 0; const total = qs.length; let firstUnanswered = null; if (total === 0) { alert("No questions!"); return; } qs.forEach(q => { const sel = q.querySelector('.quiz-option.selected'); q.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none'); q.classList.remove('answered'); q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('correct', 'incorrect')); if (sel) { answered++; q.classList.add('answered'); const isC = sel.dataset.isCorrect === 'true'; q.querySelectorAll('.quiz-option').forEach(o => { if (o.dataset.isCorrect === 'true') o.classList.add('correct'); if (o === sel && !isC) o.classList.add('incorrect'); }); if (isC) { score++; const fb = q.querySelector('.quiz-feedback.correct'); if (fb) fb.style.display = 'block'; } else { const fb = q.querySelector('.quiz-feedback.incorrect'); if (fb) { const cOpt = q.querySelector('.quiz-option.correct .quiz-option-text'); const cTxt = cOpt ? cOpt.textContent : 'N/A'; fb.innerHTML = `Incorrect. Correct: <strong>${escapeHtml(cTxt)}</strong>`; fb.style.display = 'block'; } } } else { if (!firstUnanswered) firstUnanswered = q; } }); const btn = cont.querySelector('.quiz-submit-btn'); const resDiv = cont.querySelector('.final-quiz-result'); if (answered < total) { alert(`Please answer all ${total} questions.`); if (firstUnanswered) { firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstUnanswered.style.outline = '2px solid var(--danger)'; setTimeout(() => { if (firstUnanswered) firstUnanswered.style.outline = 'none'; }, 2500); } } else { const perc = total > 0 ? Math.round((score / total) * 100) : 0; if (resDiv) { resDiv.textContent = `Score: ${score}/${total} (${perc}%)`; resDiv.className = `final-quiz-result ${perc >= 70 ? 'success' : 'fail'}`; resDiv.style.display = 'block'; resDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } if (btn) btn.disabled = true; qs.forEach(q => q.classList.add('answered')); } }

// --- Global Modal & Saving ---
function openEditModal(type, id = null, parentId = null, isNew = false, elementTypeForNew = null) { /* ... (logic as previously refined, uses courseHeader modal) ... */ if (!modal || !modalFormContent || !modalTitle) { console.error("Modal elements not found!"); return; } editingContext = { type, id, parentId, isNew, elementType: elementTypeForNew }; modalFormContent.innerHTML = ''; let title = 'Edit'; let formHtml = ''; let currentData = null; try { switch (type) { case 'course': title = 'Edit Course Description'; currentData = findCourse(id); if (!currentData) throw new Error("Course data not found."); formHtml = `<label for="edit-item-description">Description (for card view):</label><textarea id="edit-item-description" rows="3">${escapeHtml(currentData.description || '')}</textarea><p style="font-size:0.9em; color:#666;">Edit Name/Image via '✏️' on course page.</p>`; break; case 'project': title = isNew ? 'Add New Project' : 'Edit Project Details'; currentData = isNew ? { name: '', description: '', imageUrl: '' } : findProjectMeta(id); if (!currentData && !isNew) throw new Error("Project metadata not found."); if (!findCourse(parentId) && isNew) throw new Error("Parent course ID missing."); formHtml = `<label for="edit-item-name">Project Name:</label><input type="text" id="edit-item-name" value="${escapeHtml(currentData.name || '')}" required><label for="edit-item-description">Description (for card):</label><textarea id="edit-item-description" rows="3">${escapeHtml(currentData.description || '')}</textarea><label for="edit-item-imageurl">Card Image URL:</label><input type="url" id="edit-item-imageurl" value="${escapeHtml(currentData.imageUrl || '')}" placeholder="https://...">`; break; case 'appStyles': title = 'Edit Application Styles'; currentData = appData.globalStyles; formHtml = generateAppStyleForm(currentData); break; case 'courseHeader': title = 'Edit Course Header'; const courseForHeader = findCourse(activeCourseId); if (!courseForHeader) throw new Error("Active course not found."); currentData = courseForHeader; formHtml = generateCourseHeaderForm(currentData); break; case 'courseStyles': title = 'Edit Course Content Styles'; const courseForStyles = findCourse(activeCourseId); if (!courseForStyles) throw new Error("Active course not found."); currentData = courseForStyles.styles || {}; formHtml = generateCourseStyleForm(currentData); break; case 'course-element': const courseForElement = findCourse(activeCourseId); if (!courseForElement) throw new Error("Active course not found."); title = isNew ? `Add ${elementTypeForNew || 'Element'}` : 'Edit Element'; if (!isNew) { const findResult = findCourseElementData(activeCourseId, id); if (!findResult) throw new Error("Element data not found."); currentData = findResult.element; title = `Edit ${currentData.type}`; } else { const elementType = elementTypeForNew || id?.split('_')[0]; if (!elementType || ['quiz', 'challenges'].includes(elementType)) throw new Error("Invalid element type."); currentData = { id: id, type: elementType, data: getDefaultElementData(elementType) }; editingContext.elementType = elementType; } formHtml = generateElementForm(currentData); break; case 'tab': currentData = findTabData_Editor(id); if (!currentData && !isNew) throw new Error("Tab data not found."); title = isNew ? 'Add Tab' : 'Edit Tab'; formHtml = `<label for="edit-generic-name">Tab Name:</label><input type="text" id="edit-generic-name" value="${escapeHtml(currentData?.name || '')}" required>`; break; case 'subtab': currentData = findSubTabData_Editor(parentId, id); if (!currentData && !isNew) throw new Error("Sub-tab data not found."); title = isNew ? 'Add Sub-Tab' : 'Edit Sub-Tab'; formHtml = `<label for="edit-generic-name">Sub-Tab Name:</label><input type="text" id="edit-generic-name" value="${escapeHtml(currentData?.name || '')}" required>`; break; case 'element': title = isNew ? `Add ${elementTypeForNew || 'Element'}` : 'Edit Element'; if (!isNew) { const findResult = findElementData_Editor(id); if (!findResult) throw new Error("Element data not found."); currentData = findResult.element; title = `Edit ${currentData.type}`; } else { const elementType = elementTypeForNew || id?.split('_')[0]; if (!elementType) throw new Error("Element type missing."); currentData = { id: id, type: elementType, data: getDefaultElementData(elementType) }; editingContext.elementType = elementType; } formHtml = generateElementForm(currentData); break; case 'styles': title = 'Edit Project Info & Styles'; currentData = currentProjectData; if (!currentData) throw new Error("No project loaded."); formHtml = generateStyleForm_Editor(currentData); break; default: throw new Error(`Unknown modal type: ${type}`); } modalTitle.textContent = title; modalFormContent.innerHTML = formHtml; modal.style.display = 'flex'; const firstInput = modalFormContent.querySelector('input:not([type=hidden]):not([type=color]), textarea, select'); if (firstInput) setTimeout(() => firstInput.focus(), 50); } catch (e) { console.error("Error opening modal:", e); alert(`Error: ${e.message}`); closeModal(); } }
function generateAppStyleForm(s) { /* ... (same) ... */ s = s || {}; return `<fieldset><legend>Global Theme</legend><div class="color-picker"><label>Primary:</label><input type="color" id="edit-style-primary" value="${s.appPrimaryColor || DEFAULT_PRIMARY_COLOR}"><label>Secondary:</label><input type="color" id="edit-style-secondary" value="${s.appSecondaryColor || DEFAULT_SECONDARY_COLOR}"><label>Accent:</label><input type="color" id="edit-style-accent" value="${s.appAccentColor || DEFAULT_ACCENT_COLOR}"></div></fieldset><fieldset><legend>Global Text</legend>${generateGlobalTextStyleFormControls_App(s)}</fieldset>`; }
function generateGlobalTextStyleFormControls_App(s={}) { /* ... (same) ... */ const cF=s.appFontFamily||DEFAULT_FONT_FAMILY; const cS=s.appFontSize||DEFAULT_FONT_SIZE_NAME; const cC=s.appTextColor||DEFAULT_TEXT_COLOR; let fO=FONT_FAMILIES.map(f=>`<option value="${escapeHtml(f.value)}" ${cF===f.value?'selected':''}>${escapeHtml(f.name)}</option>`).join(''); let sO=FONT_SIZES.map(z=>{let iS=(cS===z);if(z==='custom'&&cS&&!FONT_SIZES.includes(cS))iS=true;return`<option value="${z}" ${iS?'selected':''}>${z==='custom'?'Custom...':z[0].toUpperCase()+z.slice(1)}</option>`;}).join(''); const iC=cS&&!FONT_SIZES.slice(0,-1).includes(cS); const cV=iC?cS:''; return `<div class="global-text-style-options"><label for="edit-global-style-font">Font:</label><select id="edit-global-style-font">${fO}</select><br><label for="edit-global-style-size">Size:</label><select id="edit-global-style-size">${sO}</select><input type="text" id="edit-global-style-size-custom" placeholder="e.g., 17px" value="${escapeHtml(cV)}" style="display:${iC?'inline-block':'none'};width:120px;margin-left:5px;"><br><label for="edit-global-style-color">Color:</label><input type="color" id="edit-global-style-color" value="${cC}"></div>`;}
function generateCourseHeaderForm(c) { return `<fieldset><legend>Course Header</legend><div class="form-field-group"><label for="edit-course-header-name">Course Name:</label><input type="text" id="edit-course-header-name" value="${escapeHtml(c.name||'')}" required></div><div class="form-field-group"><label for="edit-course-header-imageurl">Cover Image URL:</label><input type="url" id="edit-course-header-imageurl" value="${escapeHtml(c.imageUrl||'')}" placeholder="https://..."></div></fieldset>`; }
function generateCourseStyleForm(s) { /* ... (same placeholder) ... */ s = s || {}; return ` <p>Course content area styles.</p> <fieldset> <legend>Styles</legend> <label for="edit-course-style-bgcolor">Background:</label> <input type="color" id="edit-course-style-bgcolor" value="${s.backgroundColor || '#ffffff'}"> <br> <label for="edit-course-style-textcolor">Text Color:</label> <input type="color" id="edit-course-style-textcolor" value="${s.textColor || appData.globalStyles.appTextColor || DEFAULT_TEXT_COLOR}"> </fieldset> `; }
function generateElementForm(d) { /* ... (same) ... */ const data=d.data||{}; const type=d.type; let h=''; if(['image','video','presentation','quiz','challenges'].includes(type)){h+=`<fieldset><legend>Display Info</legend> <label for="edit-media-heading">Heading:</label> <input id="edit-media-heading" type="text" value="${escapeHtml(data.heading||'')}"> <label for="edit-media-description">Description:</label> <textarea id="edit-media-description" rows="3">${escapeHtml(data.description||'')}</textarea> </fieldset>`;} h+=`<fieldset><legend>${type[0].toUpperCase()+type.slice(1)} Content</legend>`; switch(type){ case 'heading': h+=`<label for="edit-element-text">Text:</label><input type="text" id="edit-element-text" value="${escapeHtml(data.text||'')}" required>`; break; case 'text': h+=`<label for="edit-element-text">Content:</label><textarea id="edit-element-text" rows="6">${escapeHtml(data.text||'')}</textarea>`; break; case 'image': h+=`<label for="edit-element-url">URL:</label><input type="url" id="edit-element-url" value="${escapeHtml(data.url||'')}" required> <label for="edit-element-alt">Alt Text:</label><input type="text" id="edit-element-alt" value="${escapeHtml(data.alt||'')}"> <div class="input-group"><div><label for="edit-element-width">Width:</label><input type="text" id="edit-element-width" value="${escapeHtml(data.width||'auto')}"></div> <div><label for="edit-element-height">Height:</label><input type="text" id="edit-element-height" value="${escapeHtml(data.height||'auto')}"></div></div>`; break; case 'video': case 'presentation': const lbl=type==='video'?'Video URL:':'Pres. URL:'; h+=`<label for="edit-element-url">${lbl}</label><input type="url" id="edit-element-url" value="${escapeHtml(data.url||'')}" required>`; break; case 'quiz': if(editingContext.type!=='element')h+='<p>Quiz edit in Project only.</p>'; else h+=generateQuizEditForm_Editor(data); break; case 'challenges': if(editingContext.type!=='element')h+='<p>Challenges edit in Project only.</p>'; else h+=generateChallengesEditForm_Editor(data); break; default: h+='<p>Unknown type.</p>';} h+=`</fieldset>`; return h; }
function generateStyleForm_Editor(p) { /* ... (logic as previously refined, uses form-field-group, no inherit btns) ... */ const s=p.styles||{}; return `<fieldset><legend>Info & Header</legend><div class="form-field-group"><label for="edit-style-title">Title:</label><input id="edit-style-title" type="text" value="${escapeHtml(p.title||'')}"></div><div class="form-field-group"><label for="edit-style-subtitle">Subtitle:</label><input id="edit-style-subtitle" type="text" value="${escapeHtml(p.subtitle||'')}"></div><div class="form-field-group"><label for="edit-style-headerimg">Header Img URL:</label><input type="url" id="edit-style-headerimg" value="${escapeHtml(p.headerImage||'')}"></div></fieldset><fieldset><legend>Theme Colors</legend><div class="color-picker"><label>1ry:</label><input type="color" id="edit-style-primary" value="${s.primaryColor||''}" title="Blank=Inherit"><label>2ry:</label><input type="color" id="edit-style-secondary" value="${s.secondaryColor||''}" title="Blank=Inherit"><label>Acc:</label><input type="color" id="edit-style-accent" value="${s.accentColor||''}" title="Blank=Inherit"></div></fieldset><fieldset><legend>Text Styles</legend>${generateGlobalTextStyleFormControls_Project(s)}</fieldset>`; }
function generateGlobalTextStyleFormControls_Project(s={}) { /* ... (logic as previously refined, no inherit btn) ... */ const gS=appData.globalStyles; const cF=s.globalFontFamily; const cS=s.globalFontSize; const cC=s.globalTextColor; let fO=FONT_FAMILIES.map(f=>`<option value="${escapeHtml(f.value)}" ${cF===f.value?'selected':''}>${escapeHtml(f.name)}</option>`).join(''); fO=`<option value="" ${cF===null||cF===undefined?'selected':''}>Inherit (${escapeHtml(gS.appFontFamily)})</option>`+fO; let sO=FONT_SIZES.map(z=>{let iS=cS===z;if(z==='custom'&&cS&&!FONT_SIZES.includes(cS))iS=true;return`<option value="${z}" ${iS?'selected':''}>${z==='custom'?'Custom...':z[0].toUpperCase()+z.slice(1)}</option>`;}).join(''); sO=`<option value="" ${cS===null||cS===undefined?'selected':''}>Inherit (${escapeHtml(gS.appFontSize)})</option>`+sO; const iC=(cS&&!FONT_SIZES.slice(0,-1).includes(cS)); const cV=iC?cS:''; return `<div class="global-text-style-options"><label>Font:</label><select id="edit-global-style-font">${fO}</select><br><label>Size:</label><select id="edit-global-style-size">${sO}</select><input id="edit-global-style-size-custom" placeholder="e.g., 17px" value="${escapeHtml(cV)}" style="display:${iC?'inline-block':'none'};width:100px;"><br><label>Color:</label><input type="color" id="edit-global-style-color" value="${cC||''}" title="Blank=Inherit"></div>`; }
function generateQuizEditForm_Editor(qD){ /* ... (same) ... */ let h='<fieldset><legend>Questions</legend><div id="quiz-editor-questions-container">';const qs=qD.questions||[];if(qs.length===0)h+='<p id="quiz-editor-no-questions-msg">No questions.</p>';else qs.forEach((q,i)=>{h+=renderSingleQuizQuestionForm_Editor(q,i);});h+='</div></fieldset><button type="button" id="quiz-editor-add-question-btn" class="add-btn quiz-edit-add-question-btn">+ Add Question</button>';return h;}
function renderSingleQuizQuestionForm_Editor(q={},i){ /* ... (same) ... */ const inc=Array.isArray(q.incorrectAnswers)?q.incorrectAnswers:[];const incImgs=Array.isArray(q.incorrectAnswersImageUrls)?q.incorrectAnswersImageUrls:[];let h=`<div class="quiz-edit-question" data-question-index="${i}"><h4>Q ${i+1}<button type="button" class="remove-btn action-btn quiz-editor-remove-question-btn" data-index="${i}" title="Remove Q ${i+1}">&times;</button></h4><label for="quiz-q-text-${i}">Text:</label><textarea id="quiz-q-text-${i}" rows="2" required>${escapeHtml(q.questionText||'')}</textarea><div class="quiz-image-input"><label for="quiz-q-image-${i}">Q Img URL:</label><input type="url" id="quiz-q-image-${i}" value="${escapeHtml(q.questionImageUrl||'')}"></div><label for="quiz-q-correct-${i}" style="color:var(--success);font-weight:bold;">Correct:</label><input type="text" id="quiz-q-correct-${i}" value="${escapeHtml(q.correctAnswer||'')}" required><div class="quiz-image-input"><label for="quiz-q-correct-image-${i}">Correct Img URL:</label><input type="url" id="quiz-q-correct-image-${i}" value="${escapeHtml(q.correctAnswerImageUrl||'')}"></div><label>Incorrect:</label>`;for(let j=0;j<3;j++){h+=`<div style="border-left:2px solid #eee;padding-left:10px;margin-bottom:10px;"><input type="text" class="quiz-q-incorrect" id="quiz-q-incorrect-${i}-${j}" value="${escapeHtml(inc[j]||'')}" placeholder="Incorrect ${j+1}"><div class="quiz-image-input"><label for="quiz-q-incorrect-image-${i}-${j}">Incorrect ${j+1} Img URL:</label><input type="url" class="quiz-q-incorrect-image" id="quiz-q-incorrect-image-${i}-${j}" value="${escapeHtml(incImgs[j]||'')}"></div></div>`;} h+=`</div>`;return h;}
function generateChallengesEditForm_Editor(chD){ /* ... (same) ... */ const d=chD||{challenges:[]}; let h=`<fieldset><legend>Challenges</legend><div id="challenges-editor-list">`;const chs=d.challenges||[];if(chs.length===0)h+='<p id="challenges-editor-no-items-msg">No items.</p>';else chs.forEach((c,i)=>h+=renderSingleChallengeForm_Editor(c,i));h+=`</div></fieldset><button type="button" id="challenges-editor-add-btn" class="add-btn" ${chs.length>=MAX_CHALLENGES?'disabled':''}>+ Add Item</button>${chs.length>=MAX_CHALLENGES?`<p style="color:var(--danger);font-size:0.9em;">Max items (${MAX_CHALLENGES}).</p>`:''}`;return h;}
function renderSingleChallengeForm_Editor(c={},i){ /* ... (same) ... */ return `<div class="challenge-edit-item" data-challenge-index="${i}" data-challenge-id="${c.id||''}"><h5 >Item ${i+1}<button type="button" class="remove-btn action-btn challenges-editor-remove-btn" data-index="${i}" title="Remove Item ${i+1}">&times;</button></h5><label for="challenge-heading-${i}">Heading:</label><input type="text" class="challenge-heading-input" id="challenge-heading-${i}" value="${escapeHtml(c.heading||'')}" required><label for="challenge-icon-${i}">Icon URL:</label><input type="url" class="challenge-icon-input" id="challenge-icon-${i}" value="${escapeHtml(c.iconUrl||'')}"><label for="challenge-desc-${i}">Desc:</label><textarea class="challenge-desc-input" id="challenge-desc-${i}" rows="2">${escapeHtml(c.description||'')}</textarea><label for="challenge-image-${i}">Image URL:</label><input type="url" class="challenge-image-input" id="challenge-image-${i}" value="${escapeHtml(c.imageUrl||'')}"></div>`; }
function closeModal() { /* ... (same) ... */ if (modal) modal.style.display = 'none'; if (modalFormContent) modalFormContent.innerHTML = ''; editingContext = { type: null, id: null, parentId: null, isNew: false, elementType: null }; }
function saveEditAction() { /* ... (logic as previously refined, handles courseHeader save) ... */ const { type, id, parentId, isNew, elementType } = editingContext; if (!type || !modalFormContent) { closeModal(); return; } console.log("Saving:", editingContext); try { let name, description, imageUrl; switch (type) { case 'course': description = getModalValue('#edit-item-description', '', false); const course = findCourse(id); if (!course) throw new Error("Course not found."); course.description = description; saveAppData(); if (currentView === 'dashboard') renderDashboardView(); break; case 'project': name = getModalValue('#edit-item-name'); description = getModalValue('#edit-item-description', '', false); imageUrl = getModalValue('#edit-item-imageurl', null); if (!name) throw new Error("Project name required."); const courseForProject = findCourse(parentId); if (!courseForProject) throw new Error("Parent course not found."); if (isNew) { if (courseForProject.projects.length >= MAX_PROJECTS_PER_COURSE) throw new Error(`Max projects reached.`); const newProjectId = generateId('proj_'); const newProjectMeta = { id: newProjectId, name, description, imageUrl }; courseForProject.projects.push(newProjectMeta); const defaultProjData = getDefaultProjectDataTemplate(); defaultProjData.title = name; defaultProjData.subtitle = description; defaultProjData.headerImage = imageUrl; saveSpecificProjectData(newProjectId, defaultProjData); } else { const projectMeta = findProjectMeta(id); if (!projectMeta) throw new Error("Project metadata not found."); projectMeta.name = name; projectMeta.description = description; projectMeta.imageUrl = imageUrl; const projectData = loadSpecificProjectData(id); projectData.title = name; projectData.subtitle = description; projectData.headerImage = imageUrl; saveSpecificProjectData(id, projectData); } saveAppData(); renderCourseView(parentId); break; case 'appStyles': const styles = appData.globalStyles; styles.appPrimaryColor = getModalValue('#edit-style-primary', DEFAULT_PRIMARY_COLOR, false); styles.appSecondaryColor = getModalValue('#edit-style-secondary', DEFAULT_SECONDARY_COLOR, false); styles.appAccentColor = getModalValue('#edit-style-accent', DEFAULT_ACCENT_COLOR, false); styles.appFontFamily = getModalValue('#edit-global-style-font', DEFAULT_FONT_FAMILY, false); styles.appTextColor = getModalValue('#edit-global-style-color', DEFAULT_TEXT_COLOR, false); const sizeSelApp = modalFormContent.querySelector('#edit-global-style-size'); if (sizeSelApp?.value === 'custom') { const customSize = getModalValue('#edit-global-style-size-custom', '').trim(); if (customSize && (customSize.includes('px') || customSize.includes('em') || customSize.includes('%') || /^\d+$/.test(customSize))) { styles.appFontSize = customSize; } else { styles.appFontSize = DEFAULT_FONT_SIZE_NAME; console.warn("Invalid custom font size.");} } else { styles.appFontSize = sizeSelApp?.value || DEFAULT_FONT_SIZE_NAME; } saveAppData(); applyGlobalAppStyles(); if (currentView === 'project') applyProjectStyles_Editor(); break; case 'courseHeader': const courseToEdit = findCourse(activeCourseId); if (!courseToEdit) throw new Error("Course not found."); const newName = getModalValue('#edit-course-header-name'); const newImageUrl = getModalValue('#edit-course-header-imageurl', null); if (!newName) throw new Error("Course name required."); courseToEdit.name = newName; courseToEdit.imageUrl = newImageUrl; saveAppData(); renderCourseView(activeCourseId); break; case 'courseStyles': const courseToStyle = findCourse(activeCourseId); if (!courseToStyle) throw new Error("Course not found."); if (!courseToStyle.styles) courseToStyle.styles = {}; courseToStyle.styles.backgroundColor = getModalValue('#edit-course-style-bgcolor', '#ffffff', false); courseToStyle.styles.textColor = getModalValue('#edit-course-style-textcolor', appData.globalStyles.appTextColor || DEFAULT_TEXT_COLOR, false); saveAppData(); applyCourseSpecificStyles(courseToStyle.id); break; case 'course-element': const courseForSave = findCourse(activeCourseId); if (!courseForSave) throw new Error("Course not found."); const savedElementData = saveElementEditFromModal(id, isNew, elementType); if (isNew) { if (!Array.isArray(courseForSave.content)) courseForSave.content = []; courseForSave.content.push(savedElementData); } else { const findResult = findCourseElementData(activeCourseId, id); if (!findResult) throw new Error("Failed to find element to update."); } saveAppData(); renderCourseView(activeCourseId); break; case 'tab': case 'subtab': const genericName = getModalValue('#edit-generic-name'); if (!genericName) throw new Error("Name required."); let itemToUpdate; if (type === 'tab') { itemToUpdate = findTabData_Editor(id); if (!itemToUpdate) throw new Error("Tab not found."); } else { itemToUpdate = findSubTabData_Editor(parentId, id); if (!itemToUpdate) throw new Error("Sub-tab not found."); } itemToUpdate.name = genericName; saveSpecificProjectData(activeProjectId, currentProjectData); renderSidebar_Editor(); break; case 'element': const savedProjEl = saveElementEditFromModal(id, isNew, elementType); if (isNew) { const targetArray = getCurrentContentArray_Editor(); if (!targetArray) throw new Error("Target array not found."); targetArray.push(savedProjEl); } else { const findResult = findElementData_Editor(id); if (!findResult) throw new Error("Failed to find element to update."); } saveSpecificProjectData(activeProjectId, currentProjectData); renderContentArea_Editor(); break; case 'styles': if (!currentProjectData) throw new Error("No project loaded."); currentProjectData.title = getModalValue('#edit-style-title') || currentProjectData.title; currentProjectData.subtitle = getModalValue('#edit-style-subtitle') || ''; currentProjectData.headerImage = getModalValue('#edit-style-headerimg') || ''; currentProjectData.styles = currentProjectData.styles || {}; currentProjectData.styles.primaryColor = getModalValue('#edit-style-primary', '', false) || null; currentProjectData.styles.secondaryColor = getModalValue('#edit-style-secondary', '', false) || null; currentProjectData.styles.accentColor = getModalValue('#edit-style-accent', '', false) || null; currentProjectData.styles.globalFontFamily = getModalValue('#edit-global-style-font', '', false) || null; currentProjectData.styles.globalTextColor = getModalValue('#edit-global-style-color', '', false) || null; const sizeSelProj = modalFormContent.querySelector('#edit-global-style-size'); if (sizeSelProj?.value === 'custom') { const customSize = getModalValue('#edit-global-style-size-custom', '').trim(); if (customSize && (customSize.includes('px') || customSize.includes('em') || customSize.includes('%') || /^\d+$/.test(customSize))) { currentProjectData.styles.globalFontSize = customSize; } else { currentProjectData.styles.globalFontSize = null; if(customSize) console.warn("Invalid custom font size.");} } else { currentProjectData.styles.globalFontSize = sizeSelProj?.value || null; } saveSpecificProjectData(activeProjectId, currentProjectData); applyProjectStyles_Editor(); break; default: throw new Error(`Unknown save type: ${type}`); } closeModal(); } catch (e) { console.error("Error saving edit:", e); alert(`Save failed: ${e.message}`); } }
function applyCourseSpecificStyles(courseId) { /* ... (same placeholder) ... */ const course = findCourse(courseId); if (!course || !course.styles || currentView !== 'course') return; const contentAreaEl = document.getElementById('course-content-area'); if (contentAreaEl) { contentAreaEl.style.backgroundColor = course.styles.backgroundColor || ''; contentAreaEl.style.color = course.styles.textColor || ''; console.log(`Applied specific styles for course ${courseId}`); } }
function saveElementEditFromModal(elementId, isNew, elementTypeFromContext) { /* ... (same) ... */ let elementData; let isCourseContext = editingContext.type === 'course-element'; if (isNew) { const elementType = elementTypeFromContext || elementId?.split('_')[0]; if (!elementType) throw new Error("Cannot determine type."); elementData = { id: elementId, type: elementType, data: getDefaultElementData(elementType) }; } else { const findResult = isCourseContext ? findCourseElementData(activeCourseId, elementId) : findElementData_Editor(elementId); if (!findResult) throw new Error(`Element data not found: ${elementId}`); elementData = findResult.element; if (!elementData.data) elementData.data = {}; } const getVal = (sel, trim = true) => getModalValue(sel, '', trim); if (['image', 'video', 'presentation', 'quiz', 'challenges'].includes(elementData.type)) { elementData.data.heading = getVal('#edit-media-heading'); elementData.data.description = getVal('#edit-media-description', false); } switch (elementData.type) { case 'heading': elementData.data.text = getVal('#edit-element-text'); if (!elementData.data.text.trim()) throw new Error("Heading text required."); break; case 'text': elementData.data.text = getVal('#edit-element-text', false); break; case 'image': elementData.data.url = getVal('#edit-element-url'); if (!elementData.data.url) throw new Error("Image URL required."); if (!elementData.data.url.startsWith('http') && !elementData.data.url.startsWith('//') && !elementData.data.url.startsWith('data:')) { console.warn(`URL "${elementData.data.url}" might not be valid.`); } elementData.data.alt = getVal('#edit-element-alt'); let width = getVal('#edit-element-width') || 'auto'; let height = getVal('#edit-element-height') || 'auto'; const sizeRegex = /^(auto|(\d+(\.\d+)?(px|%|em|rem|vw|vh)?))$/i; elementData.data.width = sizeRegex.test(width) ? width : 'auto'; elementData.data.height = sizeRegex.test(height) ? height : 'auto'; break; case 'video': case 'presentation': elementData.data.url = getVal('#edit-element-url'); if (!elementData.data.url) throw new Error("URL required."); if (!elementData.data.url.startsWith('http') && !elementData.data.url.startsWith('//')) { console.warn(`URL "${elementData.data.url}" might not be valid.`); } delete elementData.data.alt; delete elementData.data.width; delete elementData.data.height; break; case 'quiz': if (isCourseContext) throw new Error("Cannot save Quiz in course."); saveQuizEditFromModal_Project(elementData.data); break; case 'challenges': if (isCourseContext) throw new Error("Cannot save Challenges in course."); saveChallengesEditFromModal_Project(elementData.data); break; default: throw new Error(`Cannot save type: ${elementData.type}`); } return elementData; }
function saveQuizEditFromModal_Project(quizData) { /* ... (same) ... */ if(!modalFormContent)throw new Error("Modal missing.");quizData.questions=[];modalFormContent.querySelectorAll('.quiz-edit-question').forEach((qForm,i)=>{const qTxt=qForm.querySelector(`#quiz-q-text-${i}`)?.value.trim();const cAns=qForm.querySelector(`#quiz-q-correct-${i}`)?.value.trim();if(!qTxt||!cAns){console.warn(`Skipping Q ${i+1}: missing text/answer.`);return;} const qImg=qForm.querySelector(`#quiz-q-image-${i}`)?.value.trim()||null;const cImg=qForm.querySelector(`#quiz-q-correct-image-${i}`)?.value.trim()||null;const iAns=[],iImgs=[];for(let j=0;j<3;j++){const iTxt=qForm.querySelector(`#quiz-q-incorrect-${i}-${j}`)?.value.trim();if(iTxt){iAns.push(iTxt);iImgs.push(qForm.querySelector(`#quiz-q-incorrect-image-${i}-${j}`)?.value.trim()||null);}else{iImgs.push(null);}} while(iImgs.length<iAns.length)iImgs.push(null);quizData.questions.push({questionText:qTxt,questionImageUrl:qImg,correctAnswer:cAns,correctAnswerImageUrl:cImg,incorrectAnswers:iAns,incorrectAnswersImageUrls:iImgs});}); console.log("Quiz saved:",quizData.questions);}
function saveChallengesEditFromModal_Project(chData) { /* ... (same) ... */ if(!modalFormContent)throw new Error("Modal missing.");chData.challenges=[];modalFormContent.querySelectorAll('.challenge-edit-item').forEach(item=>{const head=item.querySelector('.challenge-heading-input')?.value.trim();if(!head){console.warn("Skipping challenge: heading missing.");return;} chData.challenges.push({id:item.dataset.challengeId||generateId('chal_'),heading:head,iconUrl:item.querySelector('.challenge-icon-input')?.value.trim()||null,description:item.querySelector('.challenge-desc-input')?.value||'',imageUrl:item.querySelector('.challenge-image-input')?.value.trim()||null});}); console.log("Challenges saved:",chData.challenges);}

// --- Event Listeners Setup ---
function setupGlobalEventListeners() { /* ... (logic as previously refined, handles card clicks, course header edits) ... */ appSettingsButton?.addEventListener('click', () => openEditModal('appStyles')); dashboardView?.addEventListener('click', (e) => { const target = e.target; const button = target.closest('button'); const itemContainer = target.closest('.item-container[data-course-id]'); if (button) { e.stopPropagation(); const buttonId = button.id; if (buttonId === 'add-course-btn') { if (!button.disabled) { openEditModal('course', null, null, true); } return; } /* Other dashboard buttons removed/handled elsewhere */ } else if (itemContainer) { e.stopPropagation(); showView('course', itemContainer.dataset.courseId); } }); courseView?.addEventListener('click', (e) => { const target = e.target; const button = target.closest('button'); const projectItemContainer = target.closest('#project-list .item-container[data-project-id]'); if (button) { e.stopPropagation(); const action = button.dataset.action; const buttonId = button.id; if (buttonId === 'back-to-dashboard-btn') { showView('dashboard'); return; } if (buttonId === 'edit-course-header-btn') { openEditModal('courseHeader'); return; } if (buttonId === 'add-project-btn') { if (!button.disabled) { openEditModal('project', null, activeCourseId, true); } return; } if (action === 'add-course-element') { const elementType = button.dataset.type; if (elementType) { openEditModal('course-element', generateId(elementType + '_'), activeCourseId, true, elementType); } return; } const elementIdForAction = button.closest('[data-element-id]')?.dataset.elementId; if (elementIdForAction && ['edit-course-element', 'remove-course-element'].includes(action)) { switch (action) { case 'edit-course-element': openEditModal('course-element', elementIdForAction, activeCourseId); break; case 'remove-course-element': removeCourseElement(activeCourseId, elementIdForAction); break; } return; } } else if (projectItemContainer) { e.stopPropagation(); showView('project', projectItemContainer.dataset.courseId, projectItemContainer.dataset.projectId); } }); courseModeToggleInput?.addEventListener('change', (e) => { const isStudentMode = !e.target.checked; courseView?.classList.toggle('student-mode', isStudentMode); console.log("Course View Student Mode:", isStudentMode); applyCourseSpecificStyles(activeCourseId); }); projectModeToggleInput?.addEventListener('change', (e) => { const isStudentMode = !e.target.checked; projectView?.classList.toggle('student-mode', isStudentMode); console.log("Project View Student Mode:", isStudentMode); if (currentView === 'project') renderSidebar_Editor(); }); closeModalButton?.addEventListener('click', closeModal); cancelModalButton?.addEventListener('click', closeModal); saveModalButton?.addEventListener('click', saveEditAction); modalFormContent?.addEventListener('click', handleModalFormInternalClick); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal?.style.display === 'flex') closeModal(); }); window.addEventListener('hashchange', handleHashChange); document.addEventListener('change', (e) => { if (e.target && e.target.id === 'edit-global-style-size') { const customInput = modalFormContent?.querySelector('#edit-global-style-size-custom'); if (customInput) { const showCustom = (e.target.value === 'custom'); customInput.style.display = showCustom ? 'inline-block' : 'none'; if (!showCustom) customInput.value = ''; if (showCustom) setTimeout(() => customInput.focus(), 0); } } }); }

// --- Remove Logic ---
function removeCourse(courseId) { /* ... (same) ... */ const course = findCourse(courseId); if (!course) return; if (confirm(`DELETE Course "${escapeHtml(course.name)}"? This deletes ALL projects!`)) { course.projects.forEach(p => deleteSpecificProjectData(p.id)); appData.courses = appData.courses.filter(c => c.id !== courseId); saveAppData(); renderDashboardView(); } }
function removeProject(projectId, courseId) { /* ... (same) ... */ const projectMeta = findProjectMeta(projectId); if (!projectMeta) return; if (confirm(`DELETE Project "${escapeHtml(projectMeta.name)}"?`)) { deleteSpecificProjectData(projectId); const course = findCourse(courseId); if (course) { course.projects = course.projects.filter(p => p.id !== projectId); saveAppData(); renderCourseView(courseId); } else { console.warn("Parent course not found."); showView('dashboard'); } } }
function removeCourseElement(courseId, elementId) { /* ... (same) ... */ const course = findCourse(courseId); const findResult = findCourseElementData(courseId, elementId); if (!course || !findResult) { alert("Cannot find item to remove."); return; } if (confirm(`Remove ${findResult.element.type} element?`)) { course.content.splice(findResult.index, 1); saveAppData(); renderCourseView(courseId); } }

// --- Modal Form Click Handler ---
function handleModalFormInternalClick(e) { /* ... (same logic for quiz/challenge edits) ... */ const target = e.target; const { type: currentModalType } = editingContext; if (currentModalType === 'element' || currentModalType === 'course-element') { const isProjectQuizChallengesEdit = (currentModalType === 'element') && (modalFormContent.querySelector('#quiz-editor-questions-container') || modalFormContent.querySelector('#challenges-editor-list')); if (isProjectQuizChallengesEdit) { if (target.matches('#quiz-editor-add-question-btn')) { const cont = modalFormContent.querySelector('#quiz-editor-questions-container'); const msg = modalFormContent.querySelector('#quiz-editor-no-questions-msg'); if (cont) { if (msg) msg.remove(); const idx = cont.children.length; cont.insertAdjacentHTML('beforeend', renderSingleQuizQuestionForm_Editor({}, idx)); const nI = cont.querySelector(`#quiz-q-text-${idx}`); if(nI) setTimeout(()=>nI.focus(), 50); } } else if (target.matches('.quiz-editor-remove-question-btn')) { const idx = parseInt(target.dataset.index, 10); if (!isNaN(idx) && confirm(`Remove Question ${idx + 1}?`)) { const qDiv = target.closest('.quiz-edit-question'); if (qDiv) { qDiv.remove(); const cont = modalFormContent.querySelector('#quiz-editor-questions-container'); if (cont && cont.children.length === 0 && !cont.querySelector('#quiz-editor-no-questions-msg')) { cont.innerHTML = '<p id="quiz-editor-no-questions-msg" style="text-align:center; font-style:italic;">No questions.</p>';}} } } else if (target.matches('#challenges-editor-add-btn')) { if (target.disabled) return; const list = modalFormContent.querySelector('#challenges-editor-list'); const msg = modalFormContent.querySelector('#challenges-editor-no-items-msg'); const count = list ? list.querySelectorAll('.challenge-edit-item').length : 0; if (list && count < MAX_CHALLENGES) { if (msg) msg.remove(); const idx = count; list.insertAdjacentHTML('beforeend', renderSingleChallengeForm_Editor({}, idx)); const nI = list.querySelector(`#challenge-heading-${idx}`); if(nI) setTimeout(()=>nI.focus(), 50); if (count + 1 >= MAX_CHALLENGES) target.disabled = true; } } else if (target.matches('.challenges-editor-remove-btn')) { const idx = parseInt(target.dataset.index, 10); if (!isNaN(idx) && confirm(`Remove Item ${idx + 1}?`)) { const cDiv = target.closest('.challenge-edit-item'); if (cDiv) { cDiv.remove(); const addBtn = modalFormContent.querySelector('#challenges-editor-add-btn'); if (addBtn) { const currentCount = modalFormContent.querySelectorAll('.challenge-edit-item').length; addBtn.disabled = (currentCount >= MAX_CHALLENGES); } const list = modalFormContent.querySelector('#challenges-editor-list'); if (list && list.children.length === 0 && !list.querySelector('#challenges-editor-no-items-msg')) { list.innerHTML = '<p id="challenges-editor-no-items-msg" style="text-align:center; font-style:italic;">No items.</p>'; }} } } } } }

// --- Project Editor Listeners ---
let isProjectEditorListenersActive = false;
const projectEditorEventHandlers = { handleProjectSidebarClick, handleProjectAddControlsClick, handleProjectContentAreaClick, handleProjectHeaderClick };
function setupEventListeners_Editor() { /* ... (same as previous) ... */ if (isProjectEditorListenersActive || currentView !== 'project') return; console.log("Setting up project editor listeners."); const { addTabButton, tabsContainer, contentArea, addControls } = projectEditorElements; const projectHeader = projectView.querySelector('.page-header'); addTabButton?.addEventListener('click', addTabAction_Editor); projectHeader?.addEventListener('click', projectEditorEventHandlers.handleProjectHeaderClick); tabsContainer?.addEventListener('click', projectEditorEventHandlers.handleProjectSidebarClick); addControls?.addEventListener('click', projectEditorEventHandlers.handleProjectAddControlsClick); contentArea?.addEventListener('click', projectEditorEventHandlers.handleProjectContentAreaClick); isProjectEditorListenersActive = true; }
function teardownEventListeners_Editor() { /* ... (same as previous) ... */ if (!isProjectEditorListenersActive) return; console.log("Tearing down project editor listeners."); const { addTabButton, tabsContainer, contentArea, addControls } = projectEditorElements; const projectHeader = projectView.querySelector('.page-header'); addTabButton?.removeEventListener('click', addTabAction_Editor); projectHeader?.removeEventListener('click', projectEditorEventHandlers.handleProjectHeaderClick); tabsContainer?.removeEventListener('click', projectEditorEventHandlers.handleProjectSidebarClick); addControls?.removeEventListener('click', projectEditorEventHandlers.handleProjectAddControlsClick); contentArea?.removeEventListener('click', projectEditorEventHandlers.handleProjectContentAreaClick); isProjectEditorListenersActive = false; }
function handleProjectHeaderClick(e) { /* ... (same) ... */ if (currentView !== 'project') return; const target = e.target; const button = target.closest('button'); if (button) { const buttonId = button.id; if (buttonId === 'back-to-projects-btn') { if (activeCourseId) showView('course', activeCourseId); else showView('dashboard'); } else if (buttonId === 'edit-project-styles-btn') { openEditModal('styles', activeProjectId); } } }
function handleProjectSidebarClick(e) { /* ... (same) ... */ if (currentView !== 'project') return; const target = e.target; const btn = target.closest('button[data-action]'); const name = target.closest('.tab-name,.sub-tab-name'); if (btn) { e.stopPropagation(); const act = btn.dataset.action; const tId = btn.dataset.tabId || btn.dataset.parentTabId; const sId = btn.dataset.subTabId; if (!tId && ['edit-subtab', 'remove-subtab', 'add-subtab'].includes(act)) { console.warn("Action needs tab ID."); return; } switch (act) { case 'edit-tab': openEditModal('tab', tId); break; case 'remove-tab': removeTabAction_Editor(tId); break; case 'add-subtab': addSubTabAction_Editor(tId); break; case 'edit-subtab': openEditModal('subtab', sId, tId); break; case 'remove-subtab': removeSubTabAction_Editor(tId, sId); break; } } else if (name?.classList.contains('sub-tab-name')) { setActiveTab_Editor(name.dataset.parentTabId, name.dataset.subTabId); } else if (name?.classList.contains('tab-name')) { setActiveTab_Editor(name.dataset.tabId); } }
function handleProjectAddControlsClick(e) { /* ... (same) ... */ if (currentView !== 'project') return; if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { addElementAction_Editor(e.target.dataset.type); } }
function handleProjectContentAreaClick(e) { /* ... (same) ... */ if (currentView !== 'project') return; const t = e.target; const actBtn = t.closest('button[data-action]'); const qOpt = t.closest('.quiz-option'); if (actBtn) { const act = actBtn.dataset.action; const elId = t.closest('.content-element')?.dataset.elementId; const qId = t.closest('.quiz-container-inner')?.dataset.quizId || actBtn.dataset.quizId; switch (act) { case 'edit-element': if (elId) openEditModal('element', elId); break; case 'remove-element': if (elId) removeElementAction_Editor(elId); break; case 'submit-quiz': if (qId) submitQuizAction_Editor(qId); break; } } else if (qOpt) { selectQuizOption_Editor(qOpt); } }

// --- Routing ---
function handleHashChange() { /* ... (same as previous) ... */ const hash = window.location.hash; console.log("Routing:", hash); teardownEventListeners_Editor(); if (!hash || hash === '#') { showView('dashboard'); } else if (hash.startsWith('#/course/')) { const courseId = hash.substring('#/course/'.length); showView('course', courseId); applyCourseSpecificStyles(courseId); } else if (hash.startsWith('#/project/')) { const projectId = hash.substring('#/project/'.length); showView('project', null, projectId); } else { console.warn(`Unknown hash: ${hash}`); showView('dashboard'); } }

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Ready. Init App.");
    loadAppData();
    applyGlobalAppStyles();
    setupGlobalEventListeners();
    handleHashChange(); // Initial view based on hash
});

</script>

</body>
</html>
