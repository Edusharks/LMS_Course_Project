<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Content Dashboard </title>
    <style>
        /* Global Variables & Basic Styles (Set by JS from appData.globalStyles) */
        :root {
            /* Defaults, will be overridden by JS */
            --primary: #5E81F4;
            --secondary: #FF7AC6;
            --accent: #FFB800;
            --light: #F5F7FA;
            --dark: #1A1D28;
            --success: #7CE7AC;
            --danger: #FF7E7E;
            --primary-rgb: 94, 129, 244; /* Will need JS update if color changes */
            --global-font-family: 'Segoe UI', sans-serif;
            --global-font-size: 16px;
            --global-text-color: var(--dark);

            --transition-speed: 0.3s;
            --card-bg: #ffffff;
            --card-shadow: 0 3px 10px rgba(0,0,0,0.07);
            --card-hover-shadow: 0 6px 15px rgba(0,0,0,0.1);
            --card-border-radius: 10px;
            --card-padding: 20px;
            --list-item-padding: 15px;
            --view-toggle-size: 30px;

            /* Project Editor specific - defaults if not overridden */
            --sidebar-width: 270px;
            --header-image-size: 80px;
            --challenge-icon-size: 40px;
            --error-image-fallback: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666666' font-size='12' font-family='sans-serif'%3EError%3C/text%3E%3C/svg%3E");
        }

        html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--global-font-size); }
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: var(--global-font-family); color: var(--global-text-color);
            margin: 0; padding: 0; background-color: var(--light); line-height: 1.6;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, font-family var(--transition-speed) ease, font-size var(--transition-speed) ease;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* --- General Headings & Buttons --- */
        h1, h2, h3, h4 { color: var(--primary); transition: color var(--transition-speed) ease; margin-top: 0; }
        h1 { font-size: 2rem; margin-bottom: 15px; text-align: center; color: var(--dark); }
        h2 { font-size: 1.6rem; border-bottom: 2px solid var(--secondary); padding-bottom: 5px; display: inline-block; margin-bottom: 20px; transition: border-color var(--transition-speed) ease; }
        h3 { font-size: 1.3rem; margin-bottom: 10px; }
        h4 { font-size: 1.1rem; color: var(--dark); margin: 0 0 5px 0; }

        button { cursor: pointer; font-family: inherit; padding: 8px 15px; border-radius: 6px; border: 1px solid transparent; transition: all 0.2s ease; font-size: 0.95rem; vertical-align: middle; background-color: #eee; color: #333; }
        button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0.9; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }

        .action-btn { font-size: 0.8em; padding: 4px 8px; margin-left: 5px; border: none; opacity: 0.7; font-weight: bold; vertical-align: middle; line-height: 1; display: inline-flex; align-items: center; justify-content: center; background-color: transparent; }
        .action-btn:hover:not(:disabled) { opacity: 1; background-color: rgba(0,0,0,0.05); }
        .add-btn { background-color: var(--success); color: white; font-weight: bold; border: none; }
        .add-btn:hover:not(:disabled) { background-color: #63c899; }
        .edit-btn { background-color: var(--accent); color: var(--dark); border: none;}
        .edit-btn:hover:not(:disabled) { background-color: #ffc833; }
        .remove-btn { background-color: var(--danger); color: white; border: none;}
        .remove-btn:hover:not(:disabled) { background-color: #e66a6a; }
        .view-btn { background-color: var(--primary); color: white; padding: 6px 12px; font-size: 0.9em; border: none;}
        .view-btn:hover:not(:disabled) { background-color: #4a6cdc; }
        .back-btn { background-color: #aaa; color: white; margin-bottom: 20px; padding: 6px 12px; font-size: 0.9em; border: none;}
        .back-btn:hover { background-color: #888; }
        .settings-btn { position: fixed; top: 15px; right: 15px; z-index: 900; background-color: rgba(255,255,255,0.8); backdrop-filter: blur(5px); border: 1px solid #ddd; border-radius: 50%; width: 40px; height: 40px; padding: 0; font-size: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* --- View Containers --- */
        .view { display: none; padding-top: 60px; /* Add padding for fixed settings button */ }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .view-header h1 { margin-bottom: 0; } /* Adjust heading margin in header */
        .view-controls { display: flex; gap: 10px; align-items: center; }

        /* --- Dashboard & Course View Styles --- */
        .item-list { margin-bottom: 30px; transition: all var(--transition-speed) ease;}
        /* Grid View */
        .item-list.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .item-card { display: flex; flex-direction: column; background-color: var(--card-bg); border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; overflow: hidden; cursor: pointer; }
        .item-card:hover { transform: translateY(-3px); box-shadow: var(--card-hover-shadow); }
        .item-card .item-image { width: 100%; height: 150px; object-fit: cover; background-color: #eee; border-bottom: 1px solid #eee; }
        .item-card .item-image[data-error="true"] { content: var(--error-image-fallback); object-fit: contain; padding: 10px; }
        .item-card .item-content { padding: var(--card-padding); flex-grow: 1; display: flex; flex-direction: column;}
        

 /* Adjust h4 margin and allow it to shrink */
 .item-card h4,
 .item-row h4 {
     margin-bottom: 0;
     flex-grow: 1;
     flex-shrink: 1;
     word-break: break-word;
     overflow: hidden;
     text-overflow: ellipsis;
     white-space: nowrap;
     color: var(--dark); /* Ensure title uses standard text color */
 }
  .item-card p { font-size: 0.9rem; color: #555; margin-bottom: 15px; word-break: break-word; flex-grow: 1; /* Pushes actions down */ display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
         /* Adjust original item-card-actions for grid view project count button */
 .item-card .item-card-actions {
     justify-content: flex-end; /* Push remaining buttons right */
     padding-top: 10px; /* Restore some padding */
     margin-top: auto; /* Push to bottom */
     border-top: 1px solid #eee; /* Restore border */
 }
 /* Ensure bottom actions are hidden in list view */
 .item-row .item-card-actions {
     display: none;
 }
 /* Ensure bottom actions hidden in project grid view */
 #project-list.grid-view .item-card .item-card-actions {
      display: none; /* Projects don't need the bottom action bar */
  }
 .item-card-actions .action-btn { padding: 6px; font-size: 1.1rem;} /* Make icons slightly bigger */

 .item-heading-container {
     display: flex;
     align-items: center;
     justify-content: space-between; /* Title left, actions right */
     gap: 15px;
     margin-bottom: 8px;
     flex-wrap: nowrap;
 }

 .item-inline-actions {
     display: flex;
     gap: 4px;
     flex-shrink: 0;
 }

 .item-inline-actions .action-btn {
     padding: 4px;
     font-size: 1rem;
     background-color: transparent;
     border: 1px solid transparent;
     opacity: 0.6;
     transition: all 0.2s ease; /* Add transition */
 }
 .item-inline-actions .action-btn:hover {
     opacity: 1;
     background-color: rgba(0,0,0,0.08);
     border-color: #ccc;
 }
 /* Style remove button specifically in this context */
 .item-inline-actions .remove-btn.action-btn {
     color: var(--danger); /* Set base color */
     opacity: 0.7; /* Slightly more visible */
 }
 .item-inline-actions .remove-btn.action-btn:hover {
     color: white; /* Text color on hover */
     background-color: var(--danger); /* Background on hover */
     border-color: var(--danger);
     opacity: 1;
 }
 /* Keep edit button subtle */
  .item-inline-actions .edit-btn.action-btn {
      color: var(--accent); /* Or use a neutral color like #555 */
  }
  .item-inline-actions .edit-btn.action-btn:hover {
      color: var(--dark); /* Text color on hover */
      background-color: var(--accent); /* Background on hover */
      border-color: var(--accent);
      opacity: 1;
 }


        
        
 /* List View */

 .item-list.list-view {
     display: flex;
     flex-direction: column;
     gap: 10px;
     max-width: 800px; /* <<<--- ADD: Constrain max width */
     margin-left: auto; /* <<<--- ADD: Center the list */
     margin-right: auto; /* <<<--- ADD: Center the list */
 }
 .item-row {
     display: flex;
     align-items: flex-start; /* Align items to the top */
     gap: 15px; /* Gap between image and content */
     background-color: var(--card-bg);
     border-radius: 8px; /* Slightly smaller radius for rows */
     box-shadow: 0 2px 5px rgba(0,0,0,0.06); /* Softer shadow */
     padding: var(--list-item-padding);
     transition: transform 0.2s ease, box-shadow 0.2s ease;
     cursor: pointer;
     border: 1px solid #eee; /* Subtle border */
 }
 .item-row:hover {
     transform: translateY(-2px);
     box-shadow: 0 4px 10px rgba(0,0,0,0.08);
     border-color: #ddd;
 }
 .item-row .item-image {
     width: 80px;  /* Adjust size as needed */
     height: 60px; /* Maintain aspect ratio */
     object-fit: cover;
     background-color: #eee;
     border-radius: 6px;
     flex-shrink: 0;
     margin-top: 3px; /* Align top of image roughly with top of text */
 }
 .item-row .item-image[data-error="true"] {
     content: var(--error-image-fallback);
     object-fit: contain;
     padding: 5px;
 }
 .item-row .item-content {
     flex-grow: 1;
     display: flex; /* Use flex to align actions to the right */
     justify-content: space-between;
     align-items: flex-start; /* Align text block and actions */
     gap: 15px; /* Gap between text content and actions */
 }
 .item-row .item-text-details { /* New wrapper for text */
     flex-grow: 1; /* Allow text to take up space */
 }
 .item-row h4 {
     margin-bottom: 4px;
     color: var(--primary);
     font-size: 1.05rem; /* Slightly smaller */
     word-break: break-word;
 }
 .item-row p {
     font-size: 0.9rem;
     color: #555;
     margin-bottom: 0; /* Remove bottom margin if description is last */
     line-height: 1.4;
     display: -webkit-box;
     -webkit-line-clamp: 2;
     -webkit-box-orient: vertical;
     overflow: hidden;
     text-overflow: ellipsis;
 }
 .item-row .item-card-actions {
     border-top: none;
     padding-top: 0;
     margin-top: 0; /* Remove top margin */
     gap: 5px;
     flex-shrink: 0; /* Prevent actions from wrapping */
     align-self: flex-start; /* Align actions to top */
 }
 /* Remove specific buttons if desired for list view */
 /* .item-row .item-card-actions .view-btn { display: none; } */

        .add-item-container { text-align: center; margin-top: 30px; }

        /* View Toggle Buttons */
        .view-toggle button { background: none; border: 1px solid #ccc; border-radius: 4px; padding: 5px; width: var(--view-toggle-size); height: var(--view-toggle-size); display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; color: #555; }
        .view-toggle button:hover { background-color: #eee; }
        .view-toggle button.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        .view-toggle button svg { width: 18px; height: 18px; fill: currentColor; }


        /* --- Project View Specific Styles (Inherit global styles, then apply specifics) --- */
        #project-view .page-header { /* ... keep original styles ... */ display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); transition: background var(--transition-speed) ease; }
        #project-view .header-content { /* ... keep original styles ... */ display: flex; align-items: center; gap: 20px; flex-grow: 1; }
        #project-view #projectHeaderImage { /* ... keep original styles ... */ width: var(--header-image-size); height: var(--header-image-size); object-fit: cover; border-radius: 8px; border: 3px solid rgba(255, 255, 255, 0.5); background-color: rgba(255, 255, 255, 0.2); flex-shrink: 0; }
        #project-view #projectHeaderImage[data-error="true"] { /* ... keep original styles ... */ background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center; }
        #project-view .header-title-container { /* ... keep original styles ... */ flex-grow: 1; }
        #project-view .page-header .header-title { /* ... keep original styles ... */ margin: 0 0 5px 0; color: white; font-size: 1.8rem;}
        #project-view .page-header .header-subtitle { /* ... keep original styles ... */ margin: 0; color: rgba(255,255,255,0.9); font-size: 1rem; }
        #project-view .page-header .header-btn { /* ... keep original styles ... */ background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5); width: 38px; height: 38px; border-radius: 50%; font-size: 20px; padding: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        #project-view .page-header .header-btn:hover { background-color: rgba(255,255,255,0.4); }
        #project-view .project-layout { display: flex; gap: 25px; }
        #project-view #project-sidebar { width: var(--sidebar-width); flex-shrink: 0; background-color: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); height: fit-content; }
        #project-view #project-tabs { margin-bottom: 15px; }
        #project-view .tab, #project-view .sub-tab { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid #eee; transition: all 0.2s ease; background-color: #fff; position: relative; }
        #project-view .tab:hover:not(.active), #project-view .sub-tab:hover:not(.active) { background-color: #f0f5ff; border-color: #c4cde0; }
        #project-view .tab.active, #project-view .sub-tab.active { font-weight: bold; box-shadow: 0 2px 5px rgba(var(--primary-rgb), 0.2); }
        #project-view .tab.active { background-color: var(--primary); color: white; border-color: var(--primary); }
        #project-view .sub-tab.active { background-color: var(--secondary); border-color: var(--secondary); color: white; box-shadow: 0 2px 5px rgba(255, 122, 198, 0.2); }
        #project-view .tab:hover .tab-controls, #project-view .sub-tab:hover .sub-tab-controls, #project-view .tab.active .tab-controls, #project-view .sub-tab.active .sub-tab-controls { display: inline-flex; gap: 5px; }
        #project-view .tab.active .action-btn { color: var(--primary); background-color: white; opacity: 1; }
        #project-view .sub-tab.active .action-btn { color: var(--secondary); background-color: white; opacity: 1; }
        #project-view .tab-name, #project-view .sub-tab-name { flex-grow: 1; margin-right: 10px; word-break: break-word; padding: 2px 0; }
        #project-view .sub-tab { margin-left: 20px; padding: 8px 10px; font-size: 0.9em; margin-bottom: 5px; background-color: #f9f9fc; }
        #project-view .tab-controls, #project-view .sub-tab-controls { display: none; flex-shrink: 0; }
        #project-view .sidebar-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
        #project-view .sidebar-actions .add-btn { width: 80%; }
        #project-view #project-main-content { flex-grow: 1; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 400px; }
        #project-view #tab-content-area { margin-bottom: 30px; }
        #project-view #tab-content-area > p { text-align: center; color: #888; margin-top: 30px; font-style: italic; }
        /* Keep all specific element styles (.content-element, .element-quiz etc.) prefixed with #project-view */
        #project-view .content-element { /* ... */ margin-bottom: 25px; padding: 20px; border: 1px dashed #e0e0e0; border-radius: 8px; position: relative; transition: all 0.2s ease; }
        #project-view .content-element:hover { border-style: solid; border-color: #b0b0b0; background-color: #fdfdfd; }
        #project-view .element-actions { /* ... */ position: absolute; top: 8px; right: 8px; display: none; background: rgba(245, 247, 250, 0.9); padding: 4px; border-radius: 5px; z-index: 10; gap: 4px; }
        #project-view .content-element:hover .element-actions { display: flex; }
        #project-view .element-text { /* ... */ white-space: pre-wrap; line-height: 1.7; margin: 0; color: inherit; font-family: inherit;}
        #project-view .media-description { /* ... */ font-size: 0.95rem; color: #555; margin-top: 5px; margin-bottom: 15px; white-space: pre-wrap; }
        #project-view .element-image img { /* ... */ display: block; max-width: 100%; height: auto; border-radius: 8px; border: none; background-color: #eee; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        #project-view .element-image img[data-error="true"] { content: var(--error-image-fallback); min-height: 80px; }
        #project-view .element-image-wrapper { /* ... */ margin-top: 10px; overflow: hidden; position: relative; max-width: 100%; }
        #project-view .media-wrapper-16-9 { /* ... */ position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 1000px; margin: 10px auto 0 auto; border-radius: 12px; background-color: #eee; box-shadow: 0 5px 12px rgba(0,0,0,.1); }
        #project-view .media-wrapper-16-9 iframe { /* ... */ position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px; }
        #project-view .element-quiz { /* ... */ background-color: #f8f9ff; padding: 20px; border: 1px solid #e0e8ff; }
        #project-view .quiz-container-inner { /* ... */ margin-top: 10px; }
        #project-view .quiz-question { /* ... */ margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        #project-view .quiz-question:last-child { border-bottom: none; margin-bottom: 0; }
        #project-view .quiz-question-content { /* ... */ display: flex; gap: 15px; align-items: flex-start; margin-bottom: 10px;}
        #project-view .quiz-question-image { /* ... */ order: -1; max-width: 150px; max-height: 120px; border-radius: 4px; object-fit: contain; flex-shrink: 0;}
        #project-view .quiz-question-image[data-error="true"] { content: var(--error-image-fallback); }
        #project-view .quiz-question-text { /* ... */ flex-grow: 1; font-weight: bold; color: var(--dark); margin: 0; }
        #project-view .quiz-options { /* ... */ display: flex; flex-direction: column; gap: 8px; }
        #project-view .quiz-option { /* ... */ display: flex; gap: 10px; align-items: center; padding: 10px 15px; background-color: #fff; border: 1px solid #d8dde6; border-radius: 6px; cursor: pointer; transition: all .2s ease; }
        #project-view .quiz-option-image { /* ... */ max-width: 100px; max-height: 75px; border-radius: 4px; object-fit: contain; flex-shrink: 0;}
        #project-view .quiz-option-image[data-error="true"] { content: var(--error-image-fallback); }
        #project-view .quiz-option-text { /* ... */ flex-grow: 1; }
        #project-view .quiz-question:not(.answered) .quiz-option:hover { background-color: #e8ecf3; border-color: #c4cde0; }
        #project-view .quiz-option.selected { /* ... */ border-color: var(--primary) !important; background-color: #e8f0fe; font-weight: 500; }
        #project-view .quiz-option.correct { /* ... */ background-color: var(--success) !important; color: #fff !important; border-color: #63c899 !important; font-weight: bold; }
        #project-view .quiz-option.incorrect { /* ... */ background-color: var(--danger) !important; color: #fff !important; border-color: #e66a6a !important; }
        #project-view .quiz-option.incorrect .quiz-option-text { text-decoration: line-through; }
        #project-view .quiz-question.answered .quiz-option { cursor: default; }
        #project-view .quiz-question.answered .quiz-option:not(.selected):not(.correct) { opacity: .6; }
        #project-view .quiz-feedback { /* ... */ margin-top: 10px; padding: 8px 12px; border-radius: 6px; display: none; font-size: .9rem; font-weight: 500;}
        #project-view .quiz-feedback.correct { /* ... */ background-color: #e6f7ed; color: #1d6c45; border: 1px solid #c3e6cb; }
        #project-view .quiz-feedback.incorrect { /* ... */ background-color: #fde8e8; color: #9b1c1c; border: 1px solid #f5c6cb; }
        #project-view .quiz-submit-btn { /* ... */ background-color: var(--accent); color: var(--dark); border: none; padding: 10px 25px; border-radius: 20px; font-weight: bold; margin-top: 20px; display: block; width: fit-content; }
        #project-view .quiz-submit-btn:hover:not(:disabled) { background-color: #ffc833; }
        #project-view .final-quiz-result { /* ... */ margin-top: 15px; padding: 12px 15px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.05rem;}
        #project-view .final-quiz-result.success { /* ... */ background-color: var(--success); color: white; }
        #project-view .final-quiz-result.fail { /* ... */ background-color: var(--danger); color: white; }
        #project-view .element-challenges { /* ... */ padding: 15px; background-color: #fff8e1; border: 1px solid #ffe082; }
        #project-view .challenges-list { /* ... */ list-style: none; padding: 0; margin: 0; }
        #project-view .challenge-item { /* ... */ display: flex; align-items: flex-start; gap: 15px; padding: 15px 0; border-bottom: 1px dotted #ccc; }
        #project-view .challenge-item:last-child { border-bottom: none; }
        #project-view .challenge-icon { /* ... */ width: var(--challenge-icon-size); height: var(--challenge-icon-size); flex-shrink: 0; border-radius: 50%; object-fit: contain; background-color: #eee;}
        #project-view .challenge-icon[data-error="true"] { content: var(--error-image-fallback); }
        #project-view .challenge-content { /* ... */ flex-grow: 1; }
        #project-view .challenge-content h4 { /* ... */ margin: 0 0 5px 0; font-size: 1.1rem; color: var(--dark); }
        #project-view .challenge-content p { /* ... */ margin: 0 0 10px 0; font-size: 0.95rem; color: #444; white-space: pre-wrap;}
        #project-view .challenge-content img { /* ... */ display: block; max-width: 250px; max-height: 180px; height: auto; margin-top: 10px; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #project-view .challenge-content img[data-error="true"] { content: var(--error-image-fallback); min-height: 50px; }
        #project-view #element-add-controls { /* ... */ margin-top: 20px; padding-top: 20px; border-top: 2px solid #eee; }
        #project-view #element-add-controls p { /* ... */ font-weight: bold; margin: 0 0 10px 0; color: var(--primary); }
        #project-view #element-add-controls button { /* ... */ margin-right: 10px; margin-bottom: 10px; background-color: #eef2ff; color: var(--primary); border: 1px solid var(--primary); font-size: 0.9em; font-weight: 500; }
        #project-view #element-add-controls button:hover:not(:disabled) { background-color: var(--primary); color: white; }
        #project-view h2.element-heading { /* ... */ font-size: 1.5rem; border-bottom: none; margin-bottom: 10px; color: inherit; font-family: inherit; }
        #project-view h3.media-heading { /* ... */ font-size: 1.3rem; margin-bottom: 8px; color: var(--dark); border-bottom: 1px solid #eee; padding-bottom: 4px; }

        /* --- Modal Styles (Keep original, ensure IDs are unique if needed) --- */
        /* ... (Keep original modal styles) ... */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.6); z-index: 1000; overflow-y: auto; padding: 20px; align-items: center; justify-content: center; animation: fadeInModal 0.3s ease; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #fff; margin: auto; padding: 25px 30px; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,.3); position: relative; display: flex; flex-direction: column; max-height: 90vh; animation: slideInModal 0.3s ease-out; }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 32px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; padding: 0 5px; z-index: 1010; }
        .close-modal:hover { color: #333; }
        #modal-title { margin-bottom: 20px; font-size: 1.4rem; }
        #modal-form-content { margin-top: 10px; overflow-y: auto; padding: 5px 15px 5px 5px; flex-grow: 1; }
        #modal-form-content label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); font-size: .95rem; }
        #modal-form-content input[type=text], #modal-form-content input[type=url], #modal-form-content input[type=number], #modal-form-content input[type=color], #modal-form-content textarea, #modal-form-content select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: inherit; background-color: #fdfdfd; }
        #modal-form-content input[type=color] { padding: 2px; height: 40px; }
        #modal-form-content textarea { min-height: 100px; white-space: pre-wrap; resize: vertical; }
        #modal-form-content input:focus, #modal-form-content textarea:focus, #modal-form-content select:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(var(--primary-rgb), 0.2); background-color: #fff; }
        #modal-form-content .input-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        #modal-form-content .input-group > div { flex: 1; min-width: 150px; }
        #modal-form-content fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 15px 20px; margin-bottom: 20px; }
        #modal-form-content legend { font-weight: bold; padding: 0 8px; font-size: 1em; color: var(--primary); }
        /* Keep specific modal form styles for Quiz/Challenges/Styles within #project-view context if needed */
        .global-text-style-options { border: 1px solid #eee; padding: 15px; margin-top: 15px; border-radius: 6px; } /* Make this global */
        .global-text-style-options label { font-size: 0.9rem; margin-right: 8px; display: inline-block; min-width: 80px; }
        .global-text-style-options select, .global-text-style-options input[type=color], .global-text-style-options input[type=text] { display: inline-block; width: auto; margin-right: 15px; margin-bottom: 10px; padding: 6px 8px; font-size: 0.9rem; }
        .global-text-style-options input[type=color] { height: 30px; width: 50px; vertical-align: middle;}
        .global-text-style-options br { display: block; margin-bottom: 5px; content: "";}

        #project-view .quiz-edit-question { border: 1px solid #eee; padding: 15px; border-radius: 6px; margin-bottom: 15px; background: #fdfdfd; position: relative; }
        #project-view .quiz-edit-question h4 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--dark); }
        #project-view .quiz-edit-question h4 .remove-btn { position: absolute; top: 10px; right: 10px; }
        #project-view .quiz-edit-question label { margin-top: 10px; font-weight: 500; font-size: 0.9rem;}
        #project-view .quiz-edit-question input[type=text], #project-view .quiz-edit-question input[type=url], #project-view .quiz-edit-question textarea { margin-bottom: 10px; font-size: 0.95rem; }
        #project-view .quiz-edit-question .quiz-image-input { margin-top: -5px; margin-bottom: 15px; }
        #project-view .quiz-edit-question .quiz-image-input label { font-size: 0.85rem; color: #555;}
        #project-view .quiz-edit-question .quiz-image-input input { padding: 6px 8px; font-size: 0.9rem;}
        #project-view .quiz-edit-question .quiz-q-incorrect { background-color: #fff7f7; border-color: #f5c6cb; }
        #modal-form-content #quiz-editor-add-question-btn { margin-top: 10px; display: block; width: fit-content; font-size: 0.9rem; } /* Keep ID global for simplicity */
        #project-view #challenges-editor-list { max-height: 400px; overflow-y: auto; padding: 5px; margin-bottom: 15px;}
        #project-view .challenge-edit-item { border: 1px solid #ddd; padding: 15px; border-radius: 6px; margin-bottom: 10px; background-color: #f9f9f9; position: relative;}
        #project-view .challenge-edit-item h5 { margin: 0 0 10px 0; font-size: 1rem; color: var(--dark); }
        #project-view .challenge-edit-item label { font-size: 0.9rem; }
        #project-view .challenge-edit-item input[type=text], #project-view .challenge-edit-item input[type=url], #project-view .challenge-edit-item textarea { font-size: 0.95rem; }
        #project-view .challenge-edit-item .remove-btn { position: absolute; top: 10px; right: 10px; }
        #modal-form-content #challenges-editor-add-btn { margin-top: 0; display: block; width: fit-content; font-size: 0.9rem; } /* Keep ID global */
        #project-view .color-picker { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        #project-view .color-picker label { margin-bottom: 0; margin-right: 5px; }

        .modal-actions { margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 20px; flex-shrink: 0; }
        .modal-actions button { margin-left: 10px; padding: 10px 20px; }
        .modal-actions button.cancel-btn { background-color: #aaa; color: white; border: none; }
        .modal-actions button.cancel-btn:hover { background-color: #888; }
        .modal-actions button.save-btn { background-color: var(--success); color: white; font-weight: bold; border: none;}
        .modal-actions button.save-btn:hover { background-color: #63c899; }

        /* Responsive Styles */
        /* ... (Keep original responsive styles, ensure they target new elements like .item-row if needed) ... */
         @media (max-width: 900px) {
            #project-view .project-layout { flex-direction: column; }
            #project-view #project-sidebar { width: 100%; margin-bottom: 20px; height: auto; }
            #project-view #project-tabs { display: flex; overflow-x: auto; padding-bottom: 10px; white-space: nowrap; border-bottom: 1px solid #eee;}
            #project-view #project-tabs p { text-align: left !important; }
            #project-view .tab, #project-view .sub-tab { flex-shrink: 0; margin-right: 8px; margin-bottom: 0; }
            #project-view .tab-controls, #project-view .sub-tab-controls { display: none !important; }
            #project-view .tab-name, #project-view .sub-tab-name { margin-right: 0; }
            #project-view .sub-tab { margin-left: 5px; }
        }
        @media (max-width: 600px) {
             :root { --global-font-size: 15px; --header-image-size: 60px; --challenge-icon-size: 30px;}
             .container { padding: 10px; }
             h1 { font-size: 1.6rem; }
             h2 { font-size: 1.4rem; }
             .settings-btn { top: 8px; right: 8px; width: 35px; height: 35px; font-size: 18px; }
             .view { padding-top: 55px; }
             .view-header { flex-direction: column; align-items: stretch; text-align: center; gap: 5px; }
             .item-list.grid-view { grid-template-columns: 1fr; }
             .item-row { flex-direction: column; align-items: stretch; text-align: center;}
             .item-row .item-image { width: 100%; height: 120px; margin-bottom: 10px; }
             .item-row .item-card-actions { justify-content: center;}

             #project-view .page-header { flex-direction: column; align-items: stretch; gap: 10px;}
             #project-view .header-content { gap: 15px;}
             #project-view .page-header .header-btn { position: absolute; top: 15px; right: 15px;}
             #project-view #project-main-content { padding: 15px; }
             #project-view .content-element { padding: 15px; }
             #project-view .quiz-question-content {flex-direction: column;}
             #project-view .quiz-question-image { max-width: 100px; max-height: 80px; margin-bottom: 5px;}
             #project-view .quiz-option { flex-direction: column; align-items: flex-start;}
             #project-view .quiz-option-image { max-width: 80px; max-height: 60px; margin-bottom: 5px;}
             #project-view .challenge-item { gap: 10px; }
             #project-view .challenge-content h4 { font-size: 1rem; }
             #project-view #element-add-controls button { font-size: 0.85rem; padding: 6px 10px;}

             .modal-content { padding: 20px; margin: 10px; width: calc(100% - 20px); }
             .modal-actions { display: flex; justify-content: space-between;}
             .modal-actions button { flex-grow: 1; margin: 0 5px; padding: 10px 15px; font-size: 0.9rem;}
        }


    </style>
</head>
<body>
    <button id="app-settings-btn" class="settings-btn" title="App Settings">⚙️</button>

    <div class="container">

        <!-- View: Dashboard (Courses List) -->
        <div id="dashboard-view" class="view">
            <div class="view-header">
                <h1>My Courses</h1>
                <div class="view-controls">
                    <span class="view-toggle">
                        <button id="dashboard-grid-view-btn" title="Grid View">
                            <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm0 10h8v8H3zm10-10h8v8h-8zm0 10h8v8h-8z"></path></svg>
                        </button>
                        <button id="dashboard-list-view-btn" title="List View">
                            <svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zm0 6h18v2H3zm0 6h18v2H3z"></path></svg>
                        </button>
                    </span>
                </div>
            </div>
            <div id="course-list" class="item-list grid-view"> <!-- Default to grid -->
                <!-- Course cards/rows will be rendered here by JS -->
            </div>
            <div class="add-item-container">
                <button id="add-course-btn" class="add-btn">+ Add New Course</button>
            </div>
        </div>

        <!-- View: Course (Projects List) -->
        <div id="course-view" class="view">
             <button id="back-to-dashboard-btn" class="back-btn">&larr; Back to Courses</button>
             <div class="view-header">
                 <h1 id="course-view-title">Projects</h1>
                 <div class="view-controls">
                     <span class="view-toggle">
                         <button id="course-grid-view-btn" title="Grid View">
                             <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm0 10h8v8H3zm10-10h8v8h-8zm0 10h8v8h-8z"></path></svg>
                         </button>
                         <button id="course-list-view-btn" title="List View">
                             <svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zm0 6h18v2H3zm0 6h18v2H3z"></path></svg>
                         </button>
                     </span>
                 </div>
             </div>
             <div id="project-list" class="item-list grid-view"> <!-- Default to grid -->
                <!-- Project cards/rows for the selected course will be rendered here -->
            </div>
             <div class="add-item-container">
                <button id="add-project-btn" class="add-btn">+ Add New Project</button>
            </div>
        </div>

        <!-- View: Project Editor -->
        <div id="project-view" class="view">
             <button id="back-to-projects-btn" class="back-btn">&larr; Back to Projects</button>
             <!-- Existing Project Editor HTML Structure -->
             <header class="page-header">
                <div class="header-content">
                    <img id="projectHeaderImage" src="" alt="Project Header Image" data-error="false">
                    <div class="header-title-container">
                        <h2 class="header-title" id="projectTitle">Project Title</h2>
                        <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
                    </div>
                </div>
                <button id="edit-project-styles-btn" class="header-btn" title="Edit Project Info & Styles">⚙️</button>
            </header>
            <div class="project-layout">
                <aside id="project-sidebar">
                    <nav id="project-tabs"></nav>
                    <div class="sidebar-actions">
                        <button id="add-tab-btn" class="add-btn">+ Add Tab</button>
                    </div>
                </aside>
                <main id="project-main-content">
                    <div id="tab-content-area"></div>
                    <div id="element-add-controls" class="element-controls" style="display: none;">
                        <p>Add to this section:</p>
                        <button data-type="heading">Heading</button>
                        <button data-type="text">Text Block</button>
                        <button data-type="image">Image/GIF</button>
                        <button data-type="video">Video</button>
                        <button data-type="presentation">Presentation</button>
                        <button data-type="challenges">Challenges Section</button>
                        <button data-type="quiz">Quiz Section</button>
                    </div>
                </main>
            </div>
             <!-- End of Existing Project Editor HTML Structure -->
        </div>

    </div> <!-- End .container -->

    <!-- Modal (Remains mostly the same, adaptable) -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal" title="Close">&times;</span>
            <h3 id="modal-title">Edit</h3>
            <div id="modal-form-content">
                <!-- Form content generated by JS -->
            </div>
            <div class="modal-actions">
                <button type="button" id="cancel-modal-btn" class="cancel-btn">Cancel</button>
                <button type="button" id="save-modal-btn" class="save-btn">Save Changes</button>
            </div>
        </div>
    </div>

<script>
// --- Constants ---
const APP_DATA_KEY = 'courseAppData_v1.1'; // Version bump for new structure
const PROJECT_DATA_PREFIX = 'projectData_';
const MAX_COURSES = 25;
const MAX_PROJECTS_PER_COURSE = 25;
const VIEW_PREFERENCE_KEY = 'itemViewPreference'; // For Grid/List toggle

// --- Project Editor Specific Constants ---
// ... (Keep FONT_FAMILIES, FONT_SIZES, DEFAULTS, MAX_CHALLENGES, IMAGE_FALLBACK_SRC etc.)
const FONT_FAMILIES = [ { name: 'Default (Segoe UI)', value: "'Segoe UI', sans-serif" }, { name: 'Arial', value: "Arial, Helvetica, sans-serif" }, { name: 'Georgia', value: "Georgia, 'Times New Roman', serif" }, { name: 'Verdana', value: "Verdana, Geneva, sans-serif" }, { name: 'Courier New', value: "'Courier New', monospace" }, { name: 'Comic Sans MS', value: "'Comic Sans MS', cursive, sans-serif" } ];
const FONT_SIZES = ['small', 'medium', 'large', 'xlarge', 'custom'];
const DEFAULT_FONT_SIZE_NAME = 'medium';
const DEFAULT_FONT_SIZE_CSS = '16px';
const DEFAULT_FONT_FAMILY = "'Segoe UI', sans-serif";
const DEFAULT_TEXT_COLOR = '#1A1D28'; // Matches --dark
const DEFAULT_PRIMARY_COLOR = '#5E81F4';
const DEFAULT_SECONDARY_COLOR = '#FF7AC6';
const DEFAULT_ACCENT_COLOR = '#FFB800';
const MAX_CHALLENGES = 25;
const IMAGE_FALLBACK_SRC = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666666' font-size='12' font-family='sans-serif'%3EError%3C/text%3E%3C/svg%3E";


// --- Utility Functions ---
function escapeHtml(unsafe) { /* ... (same) ... */ if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
function generateId(prefix = 'id_') { /* ... (same) ... */ return prefix + Date.now() + '_' + Math.random().toString(36).substring(2, 9); }
function getEmbedUrlWithOptions(url) { /* ... (same) ... */ if (!url || typeof url !== 'string') return 'about:blank'; try { if (!url.startsWith('http:') && !url.startsWith('https:') && !url.startsWith('//')) { if (url !== 'about:blank') { console.warn(`Invalid URL format for embedding: ${url}`); return 'about:blank'; } else { return url; } } let pUrl = new URL(url); if (pUrl.hostname.includes('youtube.com') || pUrl.hostname.includes('youtu.be')) { pUrl.searchParams.set('autoplay', '0'); pUrl.searchParams.set('mute', '1'); pUrl.searchParams.set('playsinline', '1'); } else if (pUrl.hostname.includes('vimeo.com')) { pUrl.searchParams.set('autoplay', '0'); pUrl.searchParams.set('dnt', '1'); } else { pUrl.searchParams.set('autoplay', '0'); } return pUrl.toString(); } catch (e) { console.error(`Error processing embed URL "${url}":`, e); return 'about:blank'; } }
function handleImageError(imgElement) { /* ... (same) ... */ if (imgElement && imgElement.src !== IMAGE_FALLBACK_SRC) { console.warn(`Image failed to load: ${imgElement.currentSrc || imgElement.src}. Applying fallback.`); imgElement.src = IMAGE_FALLBACK_SRC; imgElement.dataset.error = "true"; } }
function hexToRgb(hex) { // Helper to update --primary-rgb if color changes
    let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null;
}
// Helper to get value from modal input, with default and trimming option
function getModalValue(selector, defaultValue = '', trimValue = true) {
    const inputElement = modalFormContent?.querySelector(selector);
    if (!inputElement) {
        // console.warn(`getModalValue: Element not found for selector "${selector}"`);
        return defaultValue;
    }
    const value = inputElement.value;
    return trimValue ? value.trim() : value;
}

// Provides the default data structure for new project elements
function getDefaultElementData(type) {
    switch (type) {
        case 'heading':
            return { text: 'New Heading' };
        case 'text':
            return { text: 'New text block...' };
        case 'image':
            // Provide some default placeholder or leave empty
            return { url: '', alt: '', width: 'auto', height: 'auto', heading: '', description: '' };
        case 'video':
            return { url: '', heading: '', description: '' };
        case 'presentation':
            return { url: '', heading: '', description: '' };
        case 'challenges':
            return { heading: 'Challenges', description: '', challenges: [] };
        case 'quiz':
            return { questions: [] };
        default:
            console.warn(`getDefaultElementData called for unknown type: ${type}`);
            return {}; // Return empty object for unknown types
    }
}

    
// --- Application State ---
let appData = {
    globalStyles: { // NEW: Global styles
        appFontFamily: DEFAULT_FONT_FAMILY,
        appFontSize: DEFAULT_FONT_SIZE_NAME, // Use name like 'medium' or custom value '17px'
        appPrimaryColor: DEFAULT_PRIMARY_COLOR,
        appSecondaryColor: DEFAULT_SECONDARY_COLOR,
        appAccentColor: DEFAULT_ACCENT_COLOR,
        appTextColor: DEFAULT_TEXT_COLOR,
    },
    courses: []
};
let currentProjectData = null;
let currentView = 'dashboard';
let activeCourseId = null;
let activeProjectId = null;
let editingContext = { type: null, id: null, parentId: null, isNew: false };
let currentItemViewMode = localStorage.getItem(VIEW_PREFERENCE_KEY) || 'grid'; // 'grid' or 'list'

// --- DOM Element Lookups ---
// Views
const dashboardView = document.getElementById('dashboard-view');
const courseView = document.getElementById('course-view');
const projectView = document.getElementById('project-view');
// Content Holders
const courseListContainer = document.getElementById('course-list');
const projectListContainer = document.getElementById('project-list');
const courseViewTitle = document.getElementById('course-view-title');
// Buttons
const appSettingsButton = document.getElementById('app-settings-btn');
const addCourseButton = document.getElementById('add-course-btn');
const addProjectButton = document.getElementById('add-project-btn');
const backToDashboardButton = document.getElementById('back-to-dashboard-btn');
const backToProjectsButton = document.getElementById('back-to-projects-btn');
const dashboardGridViewBtn = document.getElementById('dashboard-grid-view-btn');
const dashboardListViewBtn = document.getElementById('dashboard-list-view-btn');
const courseGridViewBtn = document.getElementById('course-grid-view-btn');
const courseListViewBtn = document.getElementById('course-list-view-btn');
// Modal Elements
const modal = document.getElementById('edit-modal');
const modalTitle = document.getElementById('modal-title');
const modalFormContent = document.getElementById('modal-form-content');
const closeModalButton = document.getElementById('close-modal-btn');
const cancelModalButton = document.getElementById('cancel-modal-btn');
const saveModalButton = document.getElementById('save-modal-btn');
// Project View Elements Cache
let projectEditorElements = {};


// --- Data Management ---
function loadAppData() {
    const storedData = localStorage.getItem(APP_DATA_KEY);
    if (storedData) {
        try {
            const parsed = JSON.parse(storedData);
            if (parsed && Array.isArray(parsed.courses)) {
                // Merge stored data with defaults for globalStyles
                appData = {
                    ...{ globalStyles: { /* Default structure */
                        appFontFamily: DEFAULT_FONT_FAMILY,
                        appFontSize: DEFAULT_FONT_SIZE_NAME,
                        appPrimaryColor: DEFAULT_PRIMARY_COLOR,
                        appSecondaryColor: DEFAULT_SECONDARY_COLOR,
                        appAccentColor: DEFAULT_ACCENT_COLOR,
                        appTextColor: DEFAULT_TEXT_COLOR,
                     }}, // Default base
                    ...parsed, // Overwrite with stored data
                    globalStyles: { // Ensure globalStyles exists and merge its props
                        appFontFamily: parsed.globalStyles?.appFontFamily || DEFAULT_FONT_FAMILY,
                        appFontSize: parsed.globalStyles?.appFontSize || DEFAULT_FONT_SIZE_NAME,
                        appPrimaryColor: parsed.globalStyles?.appPrimaryColor || DEFAULT_PRIMARY_COLOR,
                        appSecondaryColor: parsed.globalStyles?.appSecondaryColor || DEFAULT_SECONDARY_COLOR,
                        appAccentColor: parsed.globalStyles?.appAccentColor || DEFAULT_ACCENT_COLOR,
                        appTextColor: parsed.globalStyles?.appTextColor || DEFAULT_TEXT_COLOR,
                    }
                };
                 // Add imageUrl to existing courses/projects if missing (migration)
                 appData.courses.forEach(course => {
                     course.imageUrl = course.imageUrl || null;
                     if (!Array.isArray(course.projects)) course.projects = [];
                     course.projects.forEach(project => {
                         project.imageUrl = project.imageUrl || null;
                     });
                 });
                console.log("App data loaded.");
                return;
            }
        } catch (e) { console.error("Failed to parse app data, resetting.", e); localStorage.removeItem(APP_DATA_KEY); }
    }
    // Initialize with default structure if load failed or no data
    appData = {
        globalStyles: {
             appFontFamily: DEFAULT_FONT_FAMILY, appFontSize: DEFAULT_FONT_SIZE_NAME,
             appPrimaryColor: DEFAULT_PRIMARY_COLOR, appSecondaryColor: DEFAULT_SECONDARY_COLOR,
             appAccentColor: DEFAULT_ACCENT_COLOR, appTextColor: DEFAULT_TEXT_COLOR,
         },
        courses: []
    };
    console.log("Initialized default app data.");
}
function saveAppData() { /* ... (same) ... */ try { localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData)); console.log("App data saved."); } catch (e) { console.error("Failed to save app data:", e); alert("Error: Could not save application data. Storage might be full."); } }
function getProjectDataKey(projectId) { /* ... (same) ... */ return `${PROJECT_DATA_PREFIX}${projectId}`; }
function loadSpecificProjectData(projectId) { /* ... (keep previous logic, ensure defaults align with global potentially) ... */
    const key = getProjectDataKey(projectId);
    const storedData = localStorage.getItem(key);
    if (storedData) {
        try {
            const parsed = JSON.parse(storedData);
             if (parsed && Array.isArray(parsed.tabs)) {
                 // Apply defaults for styles etc., using *global app defaults* as base
                 parsed.styles = parsed.styles || {};
                 const defaultStyles = appData.globalStyles || {}; // Use loaded global defaults
                 parsed.styles.primaryColor = parsed.styles.primaryColor || defaultStyles.appPrimaryColor || DEFAULT_PRIMARY_COLOR;
                 parsed.styles.secondaryColor = parsed.styles.secondaryColor || defaultStyles.appSecondaryColor || DEFAULT_SECONDARY_COLOR;
                 parsed.styles.accentColor = parsed.styles.accentColor || defaultStyles.appAccentColor || DEFAULT_ACCENT_COLOR;
                 // Project text style *can* override global, so check project first, then global, then hardcoded default
                 parsed.styles.globalTextColor = parsed.styles.globalTextColor || defaultStyles.appTextColor || DEFAULT_TEXT_COLOR;
                 parsed.styles.globalFontSize = parsed.styles.globalFontSize || defaultStyles.appFontSize || DEFAULT_FONT_SIZE_NAME;
                 parsed.styles.globalFontFamily = parsed.styles.globalFontFamily || defaultStyles.appFontFamily || DEFAULT_FONT_FAMILY;
                 parsed.headerImage = parsed.headerImage || getDefaultProjectDataTemplate().headerImage;

                 const projectMeta = findProjectMeta(projectId);
                 parsed.title = parsed.title || projectMeta?.name || "Untitled Project";
                 parsed.subtitle = parsed.subtitle || projectMeta?.description || "";

                 console.log(`Project data loaded for ${projectId}`);
                 return parsed;
             }
        } catch (e) { console.error(`Failed to parse project data for ${projectId}, returning default.`, e); }
    }
    console.log(`No valid data found for project ${projectId}, creating default.`);
    const projectMeta = findProjectMeta(projectId);
    const defaultData = getDefaultProjectDataTemplate(); // Get template
    // Apply meta and global styles to the default template
    defaultData.title = projectMeta?.name || "New Project";
    defaultData.subtitle = projectMeta?.description || "";
    defaultData.styles.primaryColor = appData.globalStyles.appPrimaryColor || DEFAULT_PRIMARY_COLOR;
    defaultData.styles.secondaryColor = appData.globalStyles.appSecondaryColor || DEFAULT_SECONDARY_COLOR;
    defaultData.styles.accentColor = appData.globalStyles.appAccentColor || DEFAULT_ACCENT_COLOR;
    defaultData.styles.globalTextColor = appData.globalStyles.appTextColor || DEFAULT_TEXT_COLOR;
    defaultData.styles.globalFontSize = appData.globalStyles.appFontSize || DEFAULT_FONT_SIZE_NAME;
    defaultData.styles.globalFontFamily = appData.globalStyles.appFontFamily || DEFAULT_FONT_FAMILY;
    return defaultData;
 }
function saveSpecificProjectData(projectId, projectDataToSave) { /* ... (keep previous logic) ... */
    if (!projectId || !projectDataToSave) { console.error("Cannot save project data: Project ID or data missing."); return; }
    const key = getProjectDataKey(projectId);
    try {
        const projectMeta = findProjectMeta(projectId);
        if (projectMeta) {
            let metaChanged = false;
            if (projectMeta.name !== projectDataToSave.title) { projectMeta.name = projectDataToSave.title; metaChanged = true; }
            // Update description in meta if needed (assuming subtitle isn't the desc)
            // if (projectMeta.description !== projectDataToSave.subtitle) { projectMeta.description = projectDataToSave.subtitle; metaChanged = true; }
            if (metaChanged) saveAppData();
        }
        localStorage.setItem(key, JSON.stringify(projectDataToSave)); console.log(`Project data saved for ${projectId}`);
    } catch (e) { console.error(`Failed to save project data for ${projectId}:`, e); alert(`Error: Could not save project data for ${projectId}. Storage might be full.`); }
}
function deleteSpecificProjectData(projectId) { /* ... (same) ... */ const key = getProjectDataKey(projectId); localStorage.removeItem(key); console.log(`Project data deleted for ${projectId}`); }
function getDefaultProjectDataTemplate() { /* ... (keep previous logic) ... */
    const firstTabId = generateId('tab_');
    return {
        title: "New Project", subtitle: "", headerImage: "https://via.placeholder.com/80/eee/ccc?text=P",
        styles: { /* Styles will be filled by global or specific load */ },
        tabs: [ { id: firstTabId, name: "Section 1", subTabs: null, content: [ { id: generateId('el_'), type: 'heading', data: { text: 'Welcome!' } } ] } ]
    };
}
function findCourse(courseId) { /* ... (same) ... */ return appData.courses.find(c => c.id === courseId); }
function findProjectMeta(projectId) { /* ... (same) ... */ for (const course of appData.courses) { const project = course.projects.find(p => p.id === projectId); if (project) return project; } return null; }
function findProjectCourse(projectId) { /* ... (same) ... */ for (const course of appData.courses) { const project = course.projects.find(p => p.id === projectId); if (project) return course; } return null; }

// --- Apply Global Styles ---
function applyGlobalAppStyles() {
    const styles = appData.globalStyles;
    const root = document.documentElement;

    root.style.setProperty('--primary', styles.appPrimaryColor || DEFAULT_PRIMARY_COLOR);
    root.style.setProperty('--secondary', styles.appSecondaryColor || DEFAULT_SECONDARY_COLOR);
    root.style.setProperty('--accent', styles.appAccentColor || DEFAULT_ACCENT_COLOR);
    root.style.setProperty('--global-text-color', styles.appTextColor || DEFAULT_TEXT_COLOR);
    root.style.setProperty('--global-font-family', styles.appFontFamily || DEFAULT_FONT_FAMILY);

    const sizeMap = { small: '14px', medium: '16px', large: '18px', xlarge: '20px' };
    const sizeName = styles.appFontSize || DEFAULT_FONT_SIZE_NAME;
    const cssFontSize = sizeMap[sizeName] || sizeName || DEFAULT_FONT_SIZE_CSS;
    root.style.setProperty('--global-font-size', cssFontSize);

    // Update RGB value for effects if primary color changed
    const rgb = hexToRgb(styles.appPrimaryColor || DEFAULT_PRIMARY_COLOR);
    if (rgb) root.style.setProperty('--primary-rgb', rgb);

    console.log("Global app styles applied.");
}

// --- View Management ---
function showView(viewName, courseId = null, projectId = null) { /* ... (keep previous logic) ... */
    console.log(`Showing view: ${viewName}`, `Course: ${courseId}`, `Project: ${projectId}`);
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    activeCourseId = null; activeProjectId = null; currentProjectData = null;

    let targetViewElement; let hash = '#';
    switch (viewName) {
        case 'dashboard':
            targetViewElement = dashboardView; currentView = 'dashboard';
            renderDashboardView(); setItemViewMode(courseListContainer, currentItemViewMode, dashboardGridViewBtn, dashboardListViewBtn);
            break;
        case 'course':
            targetViewElement = courseView; currentView = 'course'; activeCourseId = courseId;
            if (!activeCourseId) { console.error("Course ID missing."); showView('dashboard'); return; }
            renderCourseView(activeCourseId); setItemViewMode(projectListContainer, currentItemViewMode, courseGridViewBtn, courseListViewBtn);
            hash = `#/course/${activeCourseId}`;
            break;
        case 'project':
            targetViewElement = projectView; currentView = 'project'; activeProjectId = projectId;
            if (!activeProjectId) { console.error("Project ID missing."); showView('dashboard'); return; }
            const parentCourse = findProjectCourse(activeProjectId); activeCourseId = parentCourse?.id;
            initProjectEditor(activeProjectId); // This also applies project-specific styles over global ones
            hash = `#/project/${activeProjectId}`;
            break;
        default: targetViewElement = dashboardView; currentView = 'dashboard'; renderDashboardView(); setItemViewMode(courseListContainer, currentItemViewMode, dashboardGridViewBtn, dashboardListViewBtn);
    }
    if (targetViewElement) { targetViewElement.classList.add('active'); window.scrollTo(0, 0); }
    if (window.location.hash !== hash) { history.replaceState({ view: viewName, courseId: activeCourseId, projectId: activeProjectId }, '', hash); }
}


function setItemViewMode(container, mode, gridBtn, listBtn) {
    if (!container || !gridBtn || !listBtn) return;
    currentItemViewMode = mode;
    localStorage.setItem(VIEW_PREFERENCE_KEY, mode); // Save preference

    // Apply class immediately for CSS transition, but then re-render content
    container.classList.remove('grid-view', 'list-view');
    container.classList.add(mode === 'list' ? 'list-view' : 'grid-view');

    gridBtn.classList.toggle('active', mode === 'grid');
    listBtn.classList.toggle('active', mode === 'list');

    // Re-render the content to apply the correct HTML structure (card vs row)
    if (container.id === 'course-list') {
        renderDashboardView();
    } else if (container.id === 'project-list') {
        renderCourseView(activeCourseId); // Need the active course ID
    }
}

function renderDashboardView() {
    courseListContainer.innerHTML = '';
    if (appData.courses.length === 0) {
        courseListContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #777;">No courses created yet. Add one below!</p>';
    } else {
        appData.courses.forEach(course => {
            const itemElement = document.createElement('div');
            itemElement.className = courseListContainer.classList.contains('list-view') ? 'item-row item-container' : 'item-card item-container';
            itemElement.dataset.courseId = course.id;

            const defaultImage = 'https://via.placeholder.com/300x150/eee/ccc?text=Course';
            const imageUrl = course.imageUrl || defaultImage;
            const descriptionHtml = course.description ? `<p>${escapeHtml(course.description)}</p>` : '';

            const inlineActionsHtml = `
                <div class="item-inline-actions">
                    <button class="edit-btn action-btn" data-action="edit-course" title="Edit Course">✏️</button>
                    <button class="remove-btn action-btn" data-action="remove-course" title="Remove Course">×</button>
                </div>`;

            const headingHtml = `
                <div class="item-heading-container">
                    <h4>${escapeHtml(course.name)}</h4>
                    ${inlineActionsHtml}
                </div>`;

            if (courseListContainer.classList.contains('list-view')) {
                 itemElement.innerHTML = `
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(course.name)}" class="item-image" onerror="handleImageError(this)" data-error="false">
                    <div class="item-content">
                         <div class="item-text-details">
                             ${headingHtml}
                             ${descriptionHtml}
                         </div>
                    </div>`;
            } else { // Grid view
                itemElement.innerHTML = `
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(course.name)}" class="item-image" onerror="handleImageError(this)" data-error="false">
                    <div class="item-content">
                        ${headingHtml}
                        ${descriptionHtml || '<p style="flex-grow: 1;"></p>'} <!-- Placeholder pushes actions down -->
                        <div class="item-card-actions">
                             <!-- ADDED View Projects Button BACK for GRID VIEW -->
                             <button class="view-btn action-btn" data-action="view-projects" title="View Projects">
                                ▶ Projects (${course.projects?.length || 0})
                             </button>
                             <!-- Edit/Remove buttons are now inline -->
                        </div>
                    </div>
                `;
            }

            courseListContainer.appendChild(itemElement);
            const img = itemElement.querySelector('.item-image');
            if (img && img.complete && img.naturalWidth === 0 && !img.dataset.error) { handleImageError(img); }
        });
    }
    // Update add button state
    addCourseButton.disabled = appData.courses.length >= MAX_COURSES;
    document.getElementById('max-courses-msg')?.remove();
    if(addCourseButton.disabled) addCourseButton.insertAdjacentHTML('afterend', `<p id="max-courses-msg" style="color:var(--danger); font-size:0.9em;">Maximum courses (${MAX_COURSES}) reached.</p>`);
}

function renderCourseView(courseId) { // For Projects List
    projectListContainer.innerHTML = '';
    const course = findCourse(courseId);

    if (!course) { /* ... (keep error handling) ... */ return; }

    courseViewTitle.textContent = `${escapeHtml(course.name)} Projects`;
    const projects = course.projects || [];

    if (projects.length === 0) {
        projectListContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #777;">No projects created yet. Add one below!</p>';
    } else {
        projects.forEach(project => {
            const itemElement = document.createElement('div');
            itemElement.className = projectListContainer.classList.contains('list-view') ? 'item-row item-container' : 'item-card item-container';
            itemElement.dataset.projectId = project.id;
            itemElement.dataset.courseId = courseId;

            const defaultImage = 'https://via.placeholder.com/300x150/eee/ccc?text=Project';
            const imageUrl = project.imageUrl || defaultImage;
            const descriptionHtml = project.description ? `<p>${escapeHtml(project.description)}</p>` : '';

             // --- Structure with Actions on Right ---
             const inlineActionsHtml = `
                <div class="item-inline-actions">
                    <button class="edit-btn action-btn" data-action="edit-project" title="Edit Project">✏️</button>
                    <button class="remove-btn action-btn" data-action="remove-project" title="Remove Project">×</button>
                </div>`;

            // ENSURE H4 is first for title left, actions right layout
            const headingHtml = `
                <div class="item-heading-container">
                     <h4>${escapeHtml(project.name)}</h4>
                    ${inlineActionsHtml}
                </div>`;
             // --- End Structure ---


            if (projectListContainer.classList.contains('list-view')) {
                 itemElement.innerHTML = `
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(project.name)}" class="item-image" onerror="handleImageError(this)" data-error="false">
                     <div class="item-content">
                         <div class="item-text-details">
                            ${headingHtml}
                            ${descriptionHtml}
                         </div>
                         <!-- No bottom actions needed -->
                     </div>`;
            } else { // Grid View
                 itemElement.innerHTML = `
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(project.name)}" class="item-image" onerror="handleImageError(this)" data-error="false">
                    <div class="item-content">
                        ${headingHtml}
                        ${descriptionHtml || '<p style="flex-grow: 1;"></p>'} <!-- Placeholder pushes actions down -->
                        <div class="item-card-actions">
                            <!-- No bottom actions needed for projects -->
                        </div>
                    </div>
                `;
            }

            projectListContainer.appendChild(itemElement);
            const img = itemElement.querySelector('.item-image');
            if (img && img.complete && img.naturalWidth === 0 && !img.dataset.error) { handleImageError(img); }
        });
    }
    // Update add button state
    addProjectButton.disabled = projects.length >= MAX_PROJECTS_PER_COURSE;
     document.getElementById('max-projects-msg')?.remove();
     if(addProjectButton.disabled) addProjectButton.insertAdjacentHTML('afterend', `<p id="max-projects-msg" style="color:var(--danger); font-size:0.9em;">Maximum projects (${MAX_PROJECTS_PER_COURSE}) reached.</p>`);
}

function renderCourseView(courseId) {
    projectListContainer.innerHTML = '';
    const course = findCourse(courseId);

    if (!course) { /* ... (keep error handling) ... */ return; }

    courseViewTitle.textContent = `${escapeHtml(course.name)} Projects`;
    const projects = course.projects || [];

    if (projects.length === 0) {
        projectListContainer.innerHTML = '<p style="text-align: center; grid-column: 1 / -1; color: #777;">No projects created yet. Add one below!</p>';
    } else {
        projects.forEach(project => {
            const itemElement = document.createElement('div');
            itemElement.className = projectListContainer.classList.contains('list-view') ? 'item-row item-container' : 'item-card item-container';
            itemElement.dataset.projectId = project.id;
            itemElement.dataset.courseId = courseId; // Keep course ID for context

            const defaultImage = 'https://via.placeholder.com/300x150/eee/ccc?text=Project';
            const imageUrl = project.imageUrl || defaultImage;
            const descriptionHtml = project.description ? `<p>${escapeHtml(project.description)}</p>` : '';

             // --- NEW Structure ---
             const inlineActionsHtml = `
                <div class="item-inline-actions">
                    <button class="edit-btn action-btn" data-action="edit-project" title="Edit Project">✏️</button>
                    <button class="remove-btn action-btn" data-action="remove-project" title="Remove Project">×</button>
                </div>`;

            const headingHtml = `
                <div class="item-heading-container">
                    ${inlineActionsHtml}
                    <h4>${escapeHtml(project.name)}</h4>
                </div>`;
             // --- End NEW Structure ---


            if (projectListContainer.classList.contains('list-view')) {
                 // List View: Image, Content (Heading+Actions, Desc)
                 itemElement.innerHTML = `
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(project.name)}" class="item-image" onerror="handleImageError(this)" data-error="false">
                     <div class="item-content">
                         <div class="item-text-details">
                            ${headingHtml}
                            ${descriptionHtml}
                         </div>
                          <!-- Actions container removed/hidden by CSS -->
                     </div>`;
            } else {
                // Grid View: Image, Content (Heading+Actions, Desc, Bottom Actions - now empty)
                 itemElement.innerHTML = `
                    <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(project.name)}" class="item-image" onerror="handleImageError(this)" data-error="false">
                    <div class="item-content">
                        ${headingHtml}
                        ${descriptionHtml || '<p style="display:none;"></p>'}
                        <div class="item-card-actions">
                            <!-- No actions here anymore -->
                        </div>
                    </div>
                `;
            }

            projectListContainer.appendChild(itemElement);
            const img = itemElement.querySelector('.item-image');
            if (img && img.complete && img.naturalWidth === 0 && !img.dataset.error) { handleImageError(img); }
        });
    }
    // Update add button state
    addProjectButton.disabled = projects.length >= MAX_PROJECTS_PER_COURSE;
     document.getElementById('max-projects-msg')?.remove();
     if(addProjectButton.disabled) addProjectButton.insertAdjacentHTML('afterend', `<p id="max-projects-msg" style="color:var(--danger); font-size:0.9em;">Maximum projects (${MAX_PROJECTS_PER_COURSE}) reached.</p>`);
}


// --- Project Editor Initialization and Core Logic ---
// ... (Keep initProjectEditor and all _Editor suffixed functions exactly as in the previous response)
// initProjectEditor, projectEditorState, applyProjectStyles_Editor, renderSidebar_Editor,
// createControlsDiv_Editor, renderContentArea_Editor, renderElement_Editor,
// createStandardActions_Editor, renderQuizElement_Editor, renderChallengesElement_Editor,
// initContent_Editor, findTabData_Editor, findSubTabData_Editor, getCurrentContentArray_Editor,
// findElementData_Editor, setActiveTab_Editor, addTabAction_Editor, addSubTabAction_Editor,
// addElementAction_Editor, removeTabAction_Editor, removeSubTabAction_Editor,
// removeElementAction_Editor, selectQuizOption_Editor, submitQuizAction_Editor
// ... (Ensure these are all present and correct as before)

// --- Project Editor Initialization and Core Logic (Copied for completeness) ---

function initProjectEditor(projectId) {
    console.log(`Initializing project editor for: ${projectId}`);
    currentProjectData = loadSpecificProjectData(projectId);

    projectEditorElements = {
        projectTitleElement: document.getElementById('projectTitle'),
        projectSubtitleElement: document.getElementById('projectSubtitle'),
        projectHeaderImageElement: document.getElementById('projectHeaderImage'),
        tabsContainer: projectView.querySelector('#project-tabs'),
        contentArea: projectView.querySelector('#tab-content-area'),
        addControls: projectView.querySelector('#element-add-controls'),
        addTabButton: projectView.querySelector('#add-tab-btn'),
        editStylesButton: projectView.querySelector('#edit-project-styles-btn')
    };

    if (!projectEditorElements.tabsContainer || !projectEditorElements.contentArea) {
         console.error("Essential project editor elements not found within #project-view!");
         projectView.querySelector('#project-main-content').innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading project editor components.</p>';
         return;
     }

    projectEditorState.currentTabId = null;
    projectEditorState.currentSubTabId = null;

    applyProjectStyles_Editor();
    renderSidebar_Editor();
    initContent_Editor();
    setupEventListeners_Editor(); // Sets up project-specific listeners

    console.log("Project Editor Initialized.");
}

const projectEditorState = { currentTabId: null, currentSubTabId: null };

function applyProjectStyles_Editor() {
    const styles = currentProjectData.styles || {};
    const root = document.documentElement; // Global styles affect everything

    // Apply project-specific styles if they exist, otherwise global styles are already applied
    // Note: Global styles (font, size, text color) are set by applyGlobalAppStyles.
    // Project styles can override theme colors.
    root.style.setProperty('--primary', styles.primaryColor || appData.globalStyles.appPrimaryColor || DEFAULT_PRIMARY_COLOR);
    root.style.setProperty('--secondary', styles.secondaryColor || appData.globalStyles.appSecondaryColor || DEFAULT_SECONDARY_COLOR);
    root.style.setProperty('--accent', styles.accentColor || appData.globalStyles.appAccentColor || DEFAULT_ACCENT_COLOR);

     // Apply project-specific text styles ONLY if they differ from global; otherwise, let global ones apply.
     // This logic might need refinement based on exact desired behavior (project always wins vs. inherits)
     const globalStyles = appData.globalStyles;
     const projTextColor = styles.globalTextColor || globalStyles.appTextColor || DEFAULT_TEXT_COLOR;
     const projFontFamily = styles.globalFontFamily || globalStyles.appFontFamily || DEFAULT_FONT_FAMILY;
     const projFontSizeName = styles.globalFontSize || globalStyles.appFontSize || DEFAULT_FONT_SIZE_NAME;
     const sizeMap = { small: '14px', medium: '16px', large: '18px', xlarge: '20px' };
     const projCssFontSize = sizeMap[projFontSizeName] || projFontSizeName || DEFAULT_FONT_SIZE_CSS;

     root.style.setProperty('--global-text-color', projTextColor); // Apply calculated text color
     root.style.setProperty('--global-font-family', projFontFamily); // Apply calculated font family
     root.style.setProperty('--global-font-size', projCssFontSize); // Apply calculated font size

     // Update RGB based on final primary color for this project
     const finalPrimary = styles.primaryColor || globalStyles.appPrimaryColor || DEFAULT_PRIMARY_COLOR;
     const rgb = hexToRgb(finalPrimary);
     if (rgb) root.style.setProperty('--primary-rgb', rgb);


    // Apply project-specific header info
    projectEditorElements.projectTitleElement.textContent = currentProjectData.title || 'Project';
    projectEditorElements.projectSubtitleElement.textContent = currentProjectData.subtitle || '';
    const imgElement = projectEditorElements.projectHeaderImageElement;
    imgElement.src = currentProjectData.headerImage || IMAGE_FALLBACK_SRC;
    imgElement.dataset.error = "false";
    imgElement.onerror = () => handleImageError(imgElement);
    if (imgElement.complete && imgElement.naturalWidth === 0 && imgElement.src !== IMAGE_FALLBACK_SRC) { handleImageError(imgElement); }
}
function renderSidebar_Editor() {
    const { tabsContainer } = projectEditorElements;
    tabsContainer.innerHTML = '';
    if (!currentProjectData.tabs?.length) { tabsContainer.innerHTML = '<p style="text-align:center;color:#888;font-style:italic;">No tabs.</p>'; return; }
    currentProjectData.tabs.forEach(t => {
        if (!t?.id) return;
        const tEl = document.createElement('div'); tEl.className = 'tab'; tEl.dataset.tabId = t.id;
        let isPActive = (t.id === projectEditorState.currentTabId && !projectEditorState.currentSubTabId && (!t.subTabs || t.subTabs.length === 0));
        const nSpan = document.createElement('span'); nSpan.className = 'tab-name'; nSpan.textContent = t.name || '...'; nSpan.dataset.tabId = t.id;
        tEl.appendChild(nSpan); tEl.appendChild(createControlsDiv_Editor('tab', t.id)); tabsContainer.appendChild(tEl);
        if (Array.isArray(t.subTabs) && t.subTabs.length > 0) {
             if (t.id === projectEditorState.currentTabId && projectEditorState.currentSubTabId && t.subTabs.some(st => st?.id === projectEditorState.currentSubTabId)) { isPActive = false; }
            t.subTabs.forEach(st => {
                if (!st?.id) return;
                const sEl = document.createElement('div'); sEl.className = 'sub-tab'; sEl.dataset.subTabId = st.id; sEl.dataset.parentTabId = t.id;
                if (st.id === projectEditorState.currentSubTabId && t.id === projectEditorState.currentTabId) sEl.classList.add('active');
                const sName = document.createElement('span'); sName.className = 'sub-tab-name'; sName.textContent = st.name || '...'; sName.dataset.parentTabId = t.id; sName.dataset.subTabId = st.id;
                sEl.appendChild(sName); sEl.appendChild(createControlsDiv_Editor('subtab', t.id, st.id)); tabsContainer.appendChild(sEl);
            });
        } if (isPActive) tEl.classList.add('active');
    });
}
function createControlsDiv_Editor(type, tId, sId = null) { const d = document.createElement('div'); d.className = type === 'tab' ? 'tab-controls' : 'sub-tab-controls'; let h = ''; if (type === 'tab') { h += `<button class="add-btn action-btn" title="+Sub" data-action="add-subtab" data-tab-id="${tId}">+ Sub</button><button class="edit-btn action-btn" title="Edit" data-action="edit-tab" data-tab-id="${tId}">✏️</button><button class="remove-btn action-btn" title="Remove" data-action="remove-tab" data-tab-id="${tId}">&times;</button>`; } else { h += `<button class="edit-btn action-btn" title="Edit" data-action="edit-subtab" data-parent-tab-id="${tId}" data-sub-tab-id="${sId}">✏️</button><button class="remove-btn action-btn" title="Remove" data-action="remove-subtab" data-parent-tab-id="${tId}" data-sub-tab-id="${sId}">&times;</button>`; } d.innerHTML = h; return d; }
function renderContentArea_Editor() {
    const { contentArea, addControls } = projectEditorElements; contentArea.innerHTML = ''; addControls.style.display = 'none'; const arr = getCurrentContentArray_Editor();
    if (arr === null) { const t = findTabData_Editor(projectEditorState.currentTabId); if (!projectEditorState.currentTabId) contentArea.innerHTML = '<p>Select tab.</p>'; else if (t && Array.isArray(t.subTabs) && t.subTabs.length > 0 && !projectEditorState.currentSubTabId) contentArea.innerHTML = '<p>Select sub-tab.</p>'; else contentArea.innerHTML = '<p>Select valid section.</p>'; return; }
    addControls.style.display = 'block'; if (arr.length === 0) { contentArea.innerHTML = '<p>Empty section. Add elements below.</p>'; } else { arr.forEach(el => { if (el?.id && el.type) renderElement_Editor(el, contentArea); }); }
}
function renderElement_Editor(elData, container) {
    const wrap = document.createElement('div'); wrap.className = `content-element element-${elData.type}`; wrap.dataset.elementId = elData.id; wrap.appendChild(createStandardActions_Editor(elData.id, elData.type)); let html = ''; try { const d = elData.data || {}; if (['image', 'video', 'presentation', 'challenges'].includes(elData.type)) { if (d.heading) html += `<h3 class="media-heading">${escapeHtml(d.heading)}</h3>`; if (d.description) html += `<p class="media-description">${escapeHtml(d.description)}</p>`; }
        switch (elData.type) { case 'heading': html += `<h2 class="element-heading">${escapeHtml(d.text || 'H')}</h2>`; break; case 'text': html += `<p class="element-text">${escapeHtml(d.text || '...')}</p>`; break; case 'image': const iUrl = d.url || '', iAlt = escapeHtml(d.alt || ''), iW = escapeHtml(d.width || 'auto'), iH = escapeHtml(d.height || 'auto'); html += `<div class="element-image-wrapper"><img src="${escapeHtml(iUrl)}" alt="${iAlt}" style="width:${iW};height:${iH};" onerror="handleImageError(this)" data-error="false"></div>`; break; case 'video': case 'presentation': const eUrl = d.url || 'about:blank', fUrl = getEmbedUrlWithOptions(eUrl), eTitle = escapeHtml(elData.type[0] === 'v' ? 'Vid' : 'Pres'); html += `<div class="media-wrapper-16-9"><iframe src="${escapeHtml(fUrl)}" title="${eTitle}" frameborder="0" allow="accelerometer;clipboard-write;encrypted-media;gyroscope;picture-in-picture;web-share;fullscreen" allowfullscreen></iframe></div>`; break; case 'quiz': renderQuizElement_Editor(elData, wrap); html = null; break; case 'challenges': renderChallengesElement_Editor(elData, wrap); html = null; break; default: html = `<p>Unknown:${escapeHtml(elData.type)}</p>`; }
        if (html !== null) { wrap.insertAdjacentHTML('beforeend', html); const img = wrap.querySelector('img'); if (img && img.complete && img.naturalWidth === 0 && img.src !== IMAGE_FALLBACK_SRC) handleImageError(img); }
    } catch (e) { console.error("Render err:", elData, e); wrap.insertAdjacentHTML('beforeend', `<p style="color:red;">Render error.</p>`); } container.appendChild(wrap);
}
function createStandardActions_Editor(id, type) { const el = document.createElement('div'); el.className = 'element-actions'; el.innerHTML = `<button class="edit-btn action-btn" title="Edit" data-action="edit-element" data-element-id="${id}">✏️</button><button class="remove-btn action-btn" title="Remove" data-action="remove-element" data-element-id="${id}">&times;</button>`; return el; }
function renderQuizElement_Editor(quizData, wrap) { const cont = document.createElement('div'); cont.className = 'quiz-container-inner'; cont.dataset.quizId = quizData.id; const qs = quizData.data?.questions || []; if (qs.length === 0) { cont.innerHTML = '<p>No Qs.</p>'; } else { qs.forEach((q, i) => { if (!q) return; const qDiv = document.createElement('div'); qDiv.className = 'quiz-question'; qDiv.dataset.questionIndex = i; const qCont = document.createElement('div'); qCont.className = 'quiz-question-content'; if (q.questionImageUrl) { const img = document.createElement('img'); img.className = 'quiz-question-image'; img.src = escapeHtml(q.questionImageUrl); img.alt = `Q ${i + 1}`; img.onerror = () => handleImageError(img); img.dataset.error = "false"; qCont.appendChild(img); } qCont.innerHTML += `<p class="quiz-question-text">${i + 1}. ${escapeHtml(q.questionText || '...')}</p>`; qDiv.appendChild(qCont); const optsDiv = document.createElement('div'); optsDiv.className = 'quiz-options'; const cAns = String(q.correctAnswer || '').trim(); const iAns = Array.isArray(q.incorrectAnswers) ? q.incorrectAnswers : []; const iImgs = Array.isArray(q.incorrectAnswersImageUrls) ? q.incorrectAnswersImageUrls : []; const iOpts = iAns.map((t, idx) => ({ text: String(t || '').trim(), img: iImgs[idx] || null })).filter(o => o.text !== ''); const allOptsData = [{ text: cAns, img: q.correctAnswerImageUrl || null, isC: true }, ...iOpts.map(o => ({ ...o, isC: false }))].filter(o => o.text !== ''); if (allOptsData.length > 0) { [...allOptsData].sort(() => Math.random() - 0.5).forEach(oD => { const oEl = document.createElement('div'); oEl.className = 'quiz-option'; oEl.dataset.isCorrect = oD.isC.toString(); if (oD.img) { const optImg = document.createElement('img'); optImg.className = 'quiz-option-image'; optImg.src = escapeHtml(oD.img); optImg.alt = 'Opt'; optImg.onerror = () => handleImageError(optImg); optImg.dataset.error = "false"; oEl.appendChild(optImg); } oEl.innerHTML += `<span class="quiz-option-text">${escapeHtml(oD.text)}</span>`; optsDiv.appendChild(oEl); }); } else { optsDiv.innerHTML = '<p style="font-size:0.9em;color:red;">No options.</p>'; } qDiv.appendChild(optsDiv); qDiv.innerHTML += `<div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;">Incorrect</div>`; cont.appendChild(qDiv); }); } cont.innerHTML += `<button class="quiz-submit-btn" data-action="submit-quiz" data-quiz-id="${quizData.id}" ${qs.length === 0 ? 'disabled' : ''}>Submit</button><div class="final-quiz-result" style="display:none;"></div>`; wrap.appendChild(cont); }
function renderChallengesElement_Editor(elData, wrap) { const chs = elData.data?.challenges || []; const list = document.createElement('ul'); list.className = 'challenges-list'; if (chs.length === 0) { list.innerHTML = '<p>No challenges.</p>'; } else { chs.forEach(c => { if (!c?.id || !c.heading) return; const item = document.createElement('li'); item.className = 'challenge-item'; item.dataset.challengeId = c.id; let itemHtml = ''; const iconUrl = c.iconUrl || IMAGE_FALLBACK_SRC; itemHtml += `<img class="challenge-icon" src="${escapeHtml(iconUrl)}" alt="C" onerror="handleImageError(this)" data-error="false">`; itemHtml += '<div class="challenge-content">'; itemHtml += `<h4>${escapeHtml(c.heading)}</h4>`; if (c.description) itemHtml += `<p>${escapeHtml(c.description)}</p>`; if (c.imageUrl) { const imgUrl = c.imageUrl; itemHtml += `<img src="${escapeHtml(imgUrl)}" alt="Challenge" onerror="handleImageError(this)" data-error="false">`; } itemHtml += '</div>'; item.innerHTML = itemHtml; item.querySelectorAll('img').forEach(img => { if (img.complete && img.naturalWidth === 0 && img.src !== IMAGE_FALLBACK_SRC) handleImageError(img); }); list.appendChild(item); }); } wrap.appendChild(list); }
function initContent_Editor() { let targetTabId = null; let targetSubTabId = null; if (currentProjectData.tabs?.length > 0 && currentProjectData.tabs[0]?.id) { targetTabId = currentProjectData.tabs[0].id; } if (targetTabId) { setActiveTab_Editor(targetTabId, targetSubTabId); } else { renderSidebar_Editor(); renderContentArea_Editor(); } }
function findTabData_Editor(tabId) { return currentProjectData?.tabs?.find(t => t?.id === tabId) || null; }
function findSubTabData_Editor(parentTabId, subTabId) { return findTabData_Editor(parentTabId)?.subTabs?.find(st => st?.id === subTabId) || null; }
function getCurrentContentArray_Editor() { const tab = findTabData_Editor(projectEditorState.currentTabId); if (!tab) return null; if (projectEditorState.currentSubTabId) { const subTab = findSubTabData_Editor(projectEditorState.currentTabId, projectEditorState.currentSubTabId); if (subTab) { if (!Array.isArray(subTab.content)) subTab.content = []; return subTab.content; } return null; } else { if (tab.subTabs === null || (Array.isArray(tab.subTabs) && tab.subTabs.length === 0)) { if (!Array.isArray(tab.content)) tab.content = []; return tab.content; } return null; } }
function findElementData_Editor(elementId) { if (!currentProjectData?.tabs || !elementId) return null; for (const t of currentProjectData.tabs) { if (!t) continue; if ((!t.subTabs || t.subTabs.length === 0) && Array.isArray(t.content)) { const i = t.content.findIndex(el => el?.id === elementId); if (i !== -1) return { element: t.content[i], parentArray: t.content, parentType: 'tab', parentId: t.id, index: i }; } else if (Array.isArray(t.subTabs)) { for (const s of t.subTabs) { if (!s) continue; if (!Array.isArray(s.content)) s.content = []; const i = s.content.findIndex(el => el?.id === elementId); if (i !== -1) return { element: s.content[i], parentArray: s.content, parentType: 'subtab', parentId: s.id, grandparentTabId: t.id, index: i }; } } } console.warn("Elem NF in Editor:", elementId); return null; }
function setActiveTab_Editor(tId, sId = null) { const tData = findTabData_Editor(tId); if (!tData) { initContent_Editor(); return; } const oldT = projectEditorState.currentTabId, oldS = projectEditorState.currentSubTabId; projectEditorState.currentTabId = tId; projectEditorState.currentSubTabId = null; if (Array.isArray(tData.subTabs) && tData.subTabs.length > 0) { if (sId && findSubTabData_Editor(tId, sId)) projectEditorState.currentSubTabId = sId; else if (tData.subTabs[0]?.id) projectEditorState.currentSubTabId = tData.subTabs[0].id; } if (projectEditorState.currentTabId !== oldT || projectEditorState.currentSubTabId !== oldS) { console.log(`Editor Active: T=${projectEditorState.currentTabId}, S=${projectEditorState.currentSubTabId}`); renderSidebar_Editor(); renderContentArea_Editor(); } }
function addTabAction_Editor() { const id = generateId('tab_'); const t = { id, name: `Tab ${currentProjectData.tabs.length + 1}`, subTabs: null, content: [] }; if (!Array.isArray(currentProjectData.tabs)) currentProjectData.tabs = []; currentProjectData.tabs.push(t); saveSpecificProjectData(activeProjectId, currentProjectData); setActiveTab_Editor(id); openEditModal('tab', id, null, true); } // Calls global modal open
function addSubTabAction_Editor(pId) { const pTab = findTabData_Editor(pId); if (!pTab) return; const id = generateId('sub_'); const st = { id, name: `Sub ${pTab.subTabs?.length ? pTab.subTabs.length + 1 : 1}`, content: [] }; if (!Array.isArray(pTab.subTabs)) { if (pTab.content?.length) { if (!confirm("Add sub & remove direct content?")) return; } pTab.content = undefined; pTab.subTabs = []; } pTab.subTabs.push(st); saveSpecificProjectData(activeProjectId, currentProjectData); setActiveTab_Editor(pId, id); openEditModal('subtab', id, pId, true); } // Calls global modal open
function addElementAction_Editor(type) { if (!projectEditorState.currentTabId) { alert("Select section."); return; } const arr = getCurrentContentArray_Editor(); if (arr === null) { alert(findTabData_Editor(projectEditorState.currentTabId)?.subTabs ? "Select sub-tab." : "Select valid section."); return; } const id = generateId(type + '_'); openEditModal('element', id, null, true, type); } // Calls global modal open
function removeTabAction_Editor(id) { const i = currentProjectData.tabs?.findIndex(t => t?.id === id); if (i === -1) return; if (!confirm(`Remove tab "${escapeHtml(currentProjectData.tabs[i].name)}"?`)) return; currentProjectData.tabs.splice(i, 1); saveSpecificProjectData(activeProjectId, currentProjectData); if (projectEditorState.currentTabId === id) { projectEditorState.currentTabId = null; projectEditorState.currentSubTabId = null; initContent_Editor(); } else renderSidebar_Editor(); }
function removeSubTabAction_Editor(pId, id) { const pTab = findTabData_Editor(pId); const i = pTab?.subTabs?.findIndex(st => st?.id === id); if (!pTab || i === -1) return; if (!confirm(`Remove sub "${escapeHtml(pTab.subTabs[i].name)}"?`)) return; pTab.subTabs.splice(i, 1); saveSpecificProjectData(activeProjectId, currentProjectData); if (projectEditorState.currentSubTabId === id && projectEditorState.currentTabId === pId) { projectEditorState.currentSubTabId = null; setActiveTab_Editor(pId); } else renderSidebar_Editor(); }
function removeElementAction_Editor(id) { const res = findElementData_Editor(id); if (!res) { alert("Cannot find element."); return; } if (!confirm(`Remove ${res.element.type}?`)) return; res.parentArray.splice(res.index, 1); saveSpecificProjectData(activeProjectId, currentProjectData); renderContentArea_Editor(); }
function selectQuizOption_Editor(optEl) { const qDiv = optEl.closest('.quiz-question'); if (!qDiv || qDiv.classList.contains('answered')) return; qDiv.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected')); optEl.classList.add('selected'); }
function submitQuizAction_Editor(quizId) { const qEl = projectEditorElements.contentArea?.querySelector(`.content-element[data-element-id="${quizId}"]`); const cont = qEl?.querySelector('.quiz-container-inner'); if (!cont) return; const qs = cont.querySelectorAll('.quiz-question'); let score = 0, answered = 0; const total = qs.length; let firstUnanswered = null; if (total === 0) { alert("No Qs!"); return; } qs.forEach(q => { const sel = q.querySelector('.quiz-option.selected'); q.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none'); q.classList.remove('answered'); q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('correct', 'incorrect')); if (sel) { answered++; q.classList.add('answered'); const isC = sel.dataset.isCorrect === 'true'; q.querySelectorAll('.quiz-option').forEach(o => { if (o.dataset.isCorrect === 'true') o.classList.add('correct'); if (o === sel && !isC) o.classList.add('incorrect'); }); if (isC) { score++; const fb = q.querySelector('.quiz-feedback.correct'); if (fb) fb.style.display = 'block'; } else { const fb = q.querySelector('.quiz-feedback.incorrect'); if (fb) { const cOpt = q.querySelector('.quiz-option.correct .quiz-option-text'); const cTxt = cOpt ? cOpt.textContent : 'N/A'; fb.innerHTML = `Incorrect. Correct: <strong>${escapeHtml(cTxt)}</strong>`; fb.style.display = 'block'; } } } else { if (!firstUnanswered) firstUnanswered = q; } }); const btn = cont.querySelector('.quiz-submit-btn'); const resDiv = cont.querySelector('.final-quiz-result'); if (answered < total) { alert(`Answer all ${total} Qs.`); if (firstUnanswered) { firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstUnanswered.style.outline = '2px solid var(--danger)'; setTimeout(() => { if (firstUnanswered) firstUnanswered.style.outline = 'none'; }, 2500); } } else { const perc = total > 0 ? Math.round((score / total) * 100) : 0; if (resDiv) { resDiv.textContent = `Complete! ${score}/${total} (${perc}%)`; resDiv.className = `final-quiz-result ${perc >= 70 ? 'success' : 'fail'}`; resDiv.style.display = 'block'; resDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } if (btn) btn.disabled = true; qs.forEach(q => q.classList.add('answered')); } }


// --- Global Modal & Saving (Adapted for new features) ---

function openEditModal(type, id = null, parentId = null, isNew = false, elementTypeForNew = null) {
    if (!modal || !modalFormContent || !modalTitle) { console.error("Modal elements not found!"); return; }

    editingContext = { type, id, parentId, isNew, elementType: elementTypeForNew };
    modalFormContent.innerHTML = '';
    let title = 'Edit';
    let formHtml = '';
    let currentData = null;

    try {
        switch (type) {
            case 'course':
                title = isNew ? 'Add New Course' : 'Edit Course';
                currentData = isNew ? { name: '', description: '', imageUrl: '' } : findCourse(id);
                if (!currentData && !isNew) throw new Error("Course data not found.");
                formHtml = `
                    <label for="edit-item-name">Course Name:</label>
                    <input type="text" id="edit-item-name" value="${escapeHtml(currentData.name || '')}" required>
                    <label for="edit-item-description">Description:</label>
                    <textarea id="edit-item-description" rows="3">${escapeHtml(currentData.description || '')}</textarea>
                    <label for="edit-item-imageurl">Image URL (Optional):</label>
                    <input type="url" id="edit-item-imageurl" value="${escapeHtml(currentData.imageUrl || '')}" placeholder="https://...">
                `;
                break;
            case 'project':
                title = isNew ? 'Add New Project' : 'Edit Project';
                 currentData = isNew ? { name: '', description: '', imageUrl: '' } : findProjectMeta(id);
                if (!currentData && !isNew) throw new Error("Project metadata not found.");
                 formHtml = `
                    <label for="edit-item-name">Project Name:</label>
                    <input type="text" id="edit-item-name" value="${escapeHtml(currentData.name || '')}" required>
                    <label for="edit-item-description">Description:</label>
                    <textarea id="edit-item-description" rows="3">${escapeHtml(currentData.description || '')}</textarea>
                    <label for="edit-item-imageurl">Image URL (Optional):</label>
                    <input type="url" id="edit-item-imageurl" value="${escapeHtml(currentData.imageUrl || '')}" placeholder="https://...">
                `;
                break;
            case 'appStyles': // NEW: Global App Styles
                 title = 'Edit Application Styles';
                 currentData = appData.globalStyles;
                 formHtml = generateAppStyleForm(currentData);
                 break;

             // --- Project Editor Specific Cases ---
            case 'tab': currentData = findTabData_Editor(id); if (!currentData) throw new Error("Tab data not found."); title = isNew ? 'Add New Tab' : 'Edit Tab'; formHtml = `<label for="edit-generic-name">Tab Name:</label><input type="text" id="edit-generic-name" value="${escapeHtml(currentData.name || '')}" required>`; break;
            case 'subtab': currentData = findSubTabData_Editor(parentId, id); if (!currentData) throw new Error("Sub-tab data not found."); title = isNew ? 'Add New Sub-Tab' : 'Edit Sub-Tab'; formHtml = `<label for="edit-generic-name">Sub-Tab Name:</label><input type="text" id="edit-generic-name" value="${escapeHtml(currentData.name || '')}" required>`; break;
            case 'element': title = isNew ? `Add New ${elementTypeForNew || 'Element'}` : 'Edit Element'; if (!isNew) { const findResult = findElementData_Editor(id); if (!findResult) throw new Error("Element data not found."); currentData = findResult.element; title = `Edit ${currentData.type.charAt(0).toUpperCase() + currentData.type.slice(1)}`; } else { const elementType = elementTypeForNew || id?.split('_')[0]; if (!elementType) throw new Error("Element type not specified."); currentData = { id: id, type: elementType, data: getDefaultElementData(elementType) }; editingContext.elementType = elementType; } formHtml = generateElementForm_Editor(currentData); break;
            case 'styles': title = 'Edit Project Info & Styles'; currentData = currentProjectData; if (!currentData) throw new Error("No project loaded."); formHtml = generateStyleForm_Editor(currentData); break;
            default: throw new Error(`Unknown modal type: ${type}`);
        }

        modalTitle.textContent = title;
        modalFormContent.innerHTML = formHtml;
        modal.style.display = 'flex';
        const firstInput = modalFormContent.querySelector('input:not([type=hidden]):not([type=color]), textarea, select');
        if (firstInput) setTimeout(() => firstInput.focus(), 50);

    } catch (e) { console.error("Error opening or preparing edit modal:", e); alert(`Error: ${e.message}`); closeModal(); }
}

// Form generator for Global App Styles
function generateAppStyleForm(globalStylesData) {
    const s = globalStylesData || {};
    return `<fieldset>
                <legend>Global Theme Colors</legend>
                <div class="color-picker">
                    <label>Primary:</label><input type="color" id="edit-style-primary" value="${s.appPrimaryColor || DEFAULT_PRIMARY_COLOR}">
                    <label>Secondary:</label><input type="color" id="edit-style-secondary" value="${s.appSecondaryColor || DEFAULT_SECONDARY_COLOR}">
                    <label>Accent:</label><input type="color" id="edit-style-accent" value="${s.appAccentColor || DEFAULT_ACCENT_COLOR}">
                </div>
            </fieldset>
            <fieldset>
                <legend>Global Text Styles</legend>
                ${generateGlobalTextStyleFormControls_App(s)}
            </fieldset>`;
}

// Specific form generator for App Text styles (targets appData.globalStyles)
function generateGlobalTextStyleFormControls_App(styles = {}) {
    const currentFontFamily = styles.appFontFamily || DEFAULT_FONT_FAMILY;
    const currentFontSize = styles.appFontSize || DEFAULT_FONT_SIZE_NAME;
    const currentTextColor = styles.appTextColor || DEFAULT_TEXT_COLOR;

    let fontFamilyOptions = FONT_FAMILIES.map(font => `<option value="${escapeHtml(font.value)}" ${currentFontFamily === font.value ? 'selected' : ''}>${escapeHtml(font.name)}</option>`).join('');
    let fontSizeOptions = FONT_SIZES.map(size => { let isSelected = (currentFontSize === size); if (size === 'custom' && currentFontSize && !FONT_SIZES.includes(currentFontSize)) isSelected = true; return `<option value="${size}" ${isSelected ? 'selected' : ''}>${size === 'custom' ? 'Custom...' : size.charAt(0).toUpperCase() + size.slice(1)}</option>`; }).join('');
    const isCustomSize = currentFontSize && !FONT_SIZES.slice(0, -1).includes(currentFontSize);
    const customSizeValue = isCustomSize ? currentFontSize : '';

    return `<div class="global-text-style-options">
                <label for="edit-global-style-font">Font Family:</label>
                <select id="edit-global-style-font">${fontFamilyOptions}</select><br>
                <label for="edit-global-style-size">Font Size:</label>
                <select id="edit-global-style-size">${fontSizeOptions}</select>
                <input type="text" id="edit-global-style-size-custom" placeholder="e.g., 17px" value="${escapeHtml(customSizeValue)}" style="display:${isCustomSize ? 'inline-block' : 'none'};width:120px; margin-left: 5px;"><br>
                <label for="edit-global-style-color">Text Color:</label>
                <input type="color" id="edit-global-style-color" value="${currentTextColor}">
            </div>`;
}

// Form Generators for Project Editor (Keep _Editor versions)
function generateElementForm_Editor(elementData) { /* ... (same as before) ... */ const d = elementData.data || {}; const type = elementData.type; let h = ''; switch (type) { case 'heading': h = `<label>Heading:</label><input id="edit-element-text" value="${escapeHtml(d.text || '')}">`; break; case 'text': h = `<label>Text:</label><textarea id="edit-element-text" rows="6">${escapeHtml(d.text || '')}</textarea>`; break; case 'image': case 'video': case 'presentation': const isImg = type === 'image'; const tName = type[0].toUpperCase() + type.slice(1); h = `<fieldset><legend>${tName}</legend><label>URL:</label><input type="url" id="edit-element-url" value="${escapeHtml(d.url || '')}" required>${isImg ? `<label>Alt:</label><input id="edit-element-alt" value="${escapeHtml(d.alt || '')}">` : ''} ${isImg ? `<div class="input-group"><div><label>W:</label><input id="edit-element-width" value="${escapeHtml(d.width || 'auto')}"></div><div><label>H:</label><input id="edit-element-height" value="${escapeHtml(d.height || 'auto')}"></div></div>` : ''}</fieldset><fieldset><legend>Opt. H/D</legend><label>H:</label><input id="edit-media-heading" value="${escapeHtml(d.heading || '')}"><label>D:</label><textarea id="edit-media-description" rows="3">${escapeHtml(d.description || '')}</textarea></fieldset>`; break; case 'quiz': h = generateQuizEditForm_Editor(d); break; case 'challenges': h = generateChallengesEditForm_Editor(d); break; default: h = '<p>Cannot edit.</p>'; } return h; }
function generateStyleForm_Editor(projectData) { /* ... (same as before) ... */ const s = projectData.styles || {}; return `<fieldset><legend>Info&Header</legend><label>Title:</label><input id="edit-style-title" value="${escapeHtml(projectData.title || '')}"><label>Subtitle:</label><input id="edit-style-subtitle" value="${escapeHtml(projectData.subtitle || '')}"><label>Hdr Img:</label><input type="url" id="edit-style-headerimg" value="${escapeHtml(projectData.headerImage || '')}"></fieldset><fieldset><legend>Theme Colors</legend><div class="color-picker"><label>1ry:</label><input type="color" id="edit-style-primary" value="${s.primaryColor || ''}"><label>2ry:</label><input type="color" id="edit-style-secondary" value="${s.secondaryColor || ''}"><label>Acc:</label><input type="color" id="edit-style-accent" value="${s.accentColor || ''}"></div></fieldset><fieldset><legend>Project Text Styles (Overrides Global)</legend>${generateGlobalTextStyleFormControls_Project(s)}</fieldset>`; } // Changed legend slightly
function generateGlobalTextStyleFormControls_Project(styles={}) { /* ... (Similar to App version, but for project styles object) ... */
    const globalStyles = appData.globalStyles; // Get global for placeholders
    const cF = styles.globalFontFamily || ''; // Default empty means inherit global
    const cS = styles.globalFontSize || '';
    const cC = styles.globalTextColor || '';

    let fOpts = FONT_FAMILIES.map(font => `<option value="${escapeHtml(font.value)}" ${cF === font.value ? 'selected' : ''}>${escapeHtml(font.name)}</option>`).join('');
    fOpts = `<option value="" ${!cF ? 'selected':''}>Inherit Global (${globalStyles.appFontFamily})</option>` + fOpts; // Add inherit option

    let sOpts = FONT_SIZES.map(size => { let iS = cS === size; if (size === 'custom' && cS && !FONT_SIZES.includes(cS)) iS = true; return `<option value="${size}" ${iS ? 'selected' : ''}>${size === 'custom' ? 'Custom...' : size.charAt(0).toUpperCase() + size.slice(1)}</option>`; }).join('');
    sOpts = `<option value="" ${!cS ? 'selected':''}>Inherit Global (${globalStyles.appFontSize})</option>` + sOpts; // Add inherit option

    const isCustom = (cS && !FONT_SIZES.slice(0, -1).includes(cS)); const customVal = isCustom ? cS : '';
    return `<div class="global-text-style-options"><label>Font:</label><select id="edit-global-style-font">${fOpts}</select><br><label>Size:</label><select id="edit-global-style-size">${sOpts}</select><input id="edit-global-style-size-custom" placeholder="e.g., 17px" value="${escapeHtml(customVal)}" style="display:${isCustom ? 'inline-block' : 'none'};width:100px;"><br><label>Color:</label><input type="color" id="edit-global-style-color" value="${cC}"><button type="button" id="inherit-text-color-btn" style="margin-left: 5px; font-size: 0.8em; padding: 2px 5px;" title="Inherit Global Color (${globalStyles.appTextColor})">Inherit</button></div>`;
}
function generateQuizEditForm_Editor(quizData){ /* ... (same as before) ... */ let h = '<fieldset><legend>Qs</legend><div id="quiz-editor-questions-container">'; const qs = quizData.questions || []; if (qs.length === 0) h += '<p id="quiz-editor-no-questions-msg">No Qs.</p>'; else qs.forEach((q, i) => { h += renderSingleQuizQuestionForm_Editor(q, i); }); h += '</div></fieldset><button type="button" id="quiz-editor-add-question-btn" class="add-btn quiz-edit-add-question-btn">+Q</button>'; return h; }
function renderSingleQuizQuestionForm_Editor(q={},i){ /* ... (same as before) ... */ const inc = Array.isArray(q.incorrectAnswers) ? q.incorrectAnswers : []; const incImgs = Array.isArray(q.incorrectAnswersImageUrls) ? q.incorrectAnswersImageUrls : []; let h = `<div class="quiz-edit-question" data-question-index="${i}"><h4>Q ${i + 1}<button type="button" class="remove-btn action-btn quiz-editor-remove-question-btn" data-index="${i}">&times;</button></h4><label>Txt:</label><textarea id="quiz-q-text-${i}" rows="2" required>${escapeHtml(q.questionText || '')}</textarea><div class="quiz-image-input"><label>Q Img:</label><input type="url" id="quiz-q-image-${i}" value="${escapeHtml(q.questionImageUrl || '')}"></div><label style="color:green;">Correct:</label><input id="quiz-q-correct-${i}" value="${escapeHtml(q.correctAnswer || '')}" required><div class="quiz-image-input"><label>Correct Img:</label><input id="quiz-q-correct-image-${i}" value="${escapeHtml(q.correctAnswerImageUrl || '')}"></div><label>Incorrect:</label>`; for (let j = 0; j < 3; j++) { h += `<div style="border-left:2px solid #eee;padding-left:10px;margin-bottom:10px;"><input class="quiz-q-incorrect" value="${escapeHtml(inc[j] || '')}"><div class="quiz-image-input"><label>Inc ${j + 1} Img:</label><input class="quiz-q-incorrect-image" id="quiz-q-incorrect-image-${i}-${j}" value="${escapeHtml(incImgs[j] || '')}"></div></div>`; } h += `</div>`; return h; }
function generateChallengesEditForm_Editor(chData){ /* ... (same as before) ... */ const d = chData || { challenges: [] }; let h = `<fieldset><legend>Challenges Section</legend><label>Heading:</label><input id="edit-challenges-heading" value="${escapeHtml(d.heading || '')}"><label>Desc:</label><textarea id="edit-challenges-description" rows="2">${escapeHtml(d.description || '')}</textarea></fieldset><fieldset><legend>Items</legend><div id="challenges-editor-list">`; const chs = d.challenges || []; if (chs.length === 0) h += '<p id="challenges-editor-no-items-msg">No items.</p>'; else chs.forEach((c, i) => h += renderSingleChallengeForm_Editor(c, i)); h += `</div></fieldset><button type="button" id="challenges-editor-add-btn" class="add-btn" ${chs.length >= MAX_CHALLENGES ? 'disabled' : ''}>+Challenge</button>${chs.length >= MAX_CHALLENGES ? `<p style="color:var(--danger);font-size:0.9em;">Max ${MAX_CHALLENGES}.</p>` : ''}`; return h; }
function renderSingleChallengeForm_Editor(c={},i){ /* ... (same as before) ... */ return `<div class="challenge-edit-item" data-challenge-index="${i}" data-challenge-id="${c.id || ''}"><h5>Challenge ${i + 1}<button type="button" class="remove-btn action-btn challenges-editor-remove-btn" data-index="${i}">&times;</button></h5><label>Heading:</label><input class="challenge-heading-input" value="${escapeHtml(c.heading || '')}" required><label>Icon URL:</label><input class="challenge-icon-input" value="${escapeHtml(c.iconUrl || '')}"><label>Desc:</label><textarea class="challenge-desc-input" rows="2">${escapeHtml(c.description || '')}</textarea><label>Img URL:</label><input class="challenge-image-input" value="${escapeHtml(c.imageUrl || '')}" ></div>`; }


function closeModal() { /* ... (same) ... */ if (modal) modal.style.display = 'none'; if (modalFormContent) modalFormContent.innerHTML = ''; editingContext = { type: null, id: null, parentId: null, isNew: false }; }

function saveEditAction() {
    const { type, id, parentId, isNew, elementType } = editingContext;
    if (!type || !modalFormContent) { closeModal(); return; }
    try {
        let name, description, imageUrl; // Common vars

        switch (type) {
            case 'course':
                name = getModalValue('#edit-item-name'); description = getModalValue('#edit-item-description', '', false); imageUrl = getModalValue('#edit-item-imageurl', null);
                if (!name) throw new Error("Course name required.");
                if (isNew) { if (appData.courses.length >= MAX_COURSES) throw new Error("Max courses reached."); const newCourse = { id: generateId('course_'), name, description, imageUrl, projects: [] }; appData.courses.push(newCourse); } else { const course = findCourse(id); if (!course) throw new Error("Course not found."); course.name = name; course.description = description; course.imageUrl = imageUrl; }
                saveAppData(); renderDashboardView();
                break;
            case 'project':
                name = getModalValue('#edit-item-name'); description = getModalValue('#edit-item-description', '', false); imageUrl = getModalValue('#edit-item-imageurl', null);
                if (!name) throw new Error("Project name required."); const course = findCourse(parentId); if (!course) throw new Error("Parent course not found.");
                if (isNew) { if (course.projects.length >= MAX_PROJECTS_PER_COURSE) throw new Error(`Max projects reached for course "${course.name}".`); const newProjectId = generateId('proj_'); const newProjectMeta = { id: newProjectId, name, description, imageUrl }; course.projects.push(newProjectMeta); const defaultProjData = getDefaultProjectDataTemplate(); defaultProjData.title = name; defaultProjData.subtitle = description; saveSpecificProjectData(newProjectId, defaultProjData); } else { const projectMeta = findProjectMeta(id); if (!projectMeta) throw new Error("Project metadata not found."); projectMeta.name = name; projectMeta.description = description; projectMeta.imageUrl = imageUrl; const projectData = loadSpecificProjectData(id); projectData.title = name; /* projectData.subtitle = description; maybe? */ saveSpecificProjectData(id, projectData); }
                saveAppData(); renderCourseView(parentId);
                break;
             case 'appStyles': // NEW
                 const styles = appData.globalStyles;
                 styles.appPrimaryColor = getModalValue('#edit-style-primary', DEFAULT_PRIMARY_COLOR, false);
                 styles.appSecondaryColor = getModalValue('#edit-style-secondary', DEFAULT_SECONDARY_COLOR, false);
                 styles.appAccentColor = getModalValue('#edit-style-accent', DEFAULT_ACCENT_COLOR, false);
                 styles.appFontFamily = getModalValue('#edit-global-style-font', DEFAULT_FONT_FAMILY, false);
                 styles.appTextColor = getModalValue('#edit-global-style-color', DEFAULT_TEXT_COLOR, false);
                 const sizeSelApp = modalFormContent.querySelector('#edit-global-style-size');
                 if (sizeSelApp?.value === 'custom') { const customSize = getModalValue('#edit-global-style-size-custom', '').trim(); if (customSize && (customSize.includes('px') || customSize.includes('em') || customSize.includes('%') || /^\d+$/.test(customSize))) { styles.appFontSize = customSize; } else { styles.appFontSize = DEFAULT_FONT_SIZE_NAME; } } else { styles.appFontSize = sizeSelApp?.value || DEFAULT_FONT_SIZE_NAME; }
                 saveAppData();
                 applyGlobalAppStyles(); // Apply immediately
                 break;

            // --- Project Editor Saves ---
            case 'tab': case 'subtab': /* ... (keep previous _Editor logic) ... */ const genericName = getModalValue('#edit-generic-name'); if (!genericName) throw new Error("Name cannot be empty."); let itemToUpdate; if (type === 'tab') { itemToUpdate = findTabData_Editor(id); if (!itemToUpdate) throw new Error("Tab NF."); } else { itemToUpdate = findSubTabData_Editor(parentId, id); if (!itemToUpdate) throw new Error("Sub-tab NF."); } itemToUpdate.name = genericName; saveSpecificProjectData(activeProjectId, currentProjectData); renderSidebar_Editor(); break;
            case 'element': /* ... (keep previous _Editor logic) ... */ const savedElementData = saveElementEditFromModal_Project(id, isNew, elementType); if (isNew) { const targetArray = getCurrentContentArray_Editor(); if (!targetArray) throw new Error("Target array NF."); targetArray.push(savedElementData); } saveSpecificProjectData(activeProjectId, currentProjectData); renderContentArea_Editor(); break;
            case 'styles': /* ... (keep previous _Editor logic, ensure project styles saved correctly) ... */
                 currentProjectData.title = getModalValue('#edit-style-title') || currentProjectData.title;
                 currentProjectData.subtitle = getModalValue('#edit-style-subtitle') || currentProjectData.subtitle;
                 currentProjectData.headerImage = getModalValue('#edit-style-headerimg') || currentProjectData.headerImage;
                 if (!currentProjectData.styles) currentProjectData.styles = {};
                 currentProjectData.styles.primaryColor = getModalValue('#edit-style-primary', '', false) || null; // null means inherit global
                 currentProjectData.styles.secondaryColor = getModalValue('#edit-style-secondary', '', false) || null;
                 currentProjectData.styles.accentColor = getModalValue('#edit-style-accent', '', false) || null;
                 currentProjectData.styles.globalFontFamily = getModalValue('#edit-global-style-font', '', false) || null;
                 currentProjectData.styles.globalTextColor = getModalValue('#edit-global-style-color', '', false) || null;
                 const sizeSelProj = modalFormContent.querySelector('#edit-global-style-size');
                 if (sizeSelProj?.value === 'custom') { const customSize = getModalValue('#edit-global-style-size-custom', '').trim(); if (customSize && (customSize.includes('px') || customSize.includes('em') || customSize.includes('%') || /^\d+$/.test(customSize))) { currentProjectData.styles.globalFontSize = customSize; } else { currentProjectData.styles.globalFontSize = null; } } else { currentProjectData.styles.globalFontSize = sizeSelProj?.value || null; } // null means inherit
                 saveSpecificProjectData(activeProjectId, currentProjectData);
                 applyProjectStyles_Editor(); // Re-apply project styles (which now consider global)
                 break;
            default: throw new Error(`Unknown save type: ${type}`);
        }
        closeModal();
    } catch (e) { console.error("Error saving edit:", e); alert(`Save failed: ${e.message}`); }
}

// Specific save logic for elements *within* the project editor context
function saveElementEditFromModal_Project(elementId, isNew, elementTypeFromContext) { /* ... (keep previous logic) ... */ let elementData; if (isNew) { const elementType = elementTypeFromContext || elementId?.split('_')[0]; if (!elementType) throw new Error("Cannot determine element type."); elementData = { id: elementId, type: elementType, data: getDefaultElementData(elementType) }; } else { const findResult = findElementData_Editor(elementId); if (!findResult) throw new Error(`Element data not found: ${elementId}`); elementData = findResult.element; if (!elementData.data) elementData.data = {}; } const getVal = (sel, trim = true) => getModalValue(sel, '', trim); switch (elementData.type) { case 'heading': case 'text': elementData.data.text = getVal('#edit-element-text', false); if (elementData.type === 'heading' && !elementData.data.text.trim()) throw new Error("Heading text cannot be empty."); break; case 'image': case 'video': case 'presentation': elementData.data.url = getVal('#edit-element-url'); if (!elementData.data.url) throw new Error("URL is required."); if (!elementData.data.url.startsWith('http') && !elementData.data.url.startsWith('//') && !elementData.data.url.startsWith('data:')) { console.warn(`URL "${elementData.data.url}" might not be valid.`); } elementData.data.heading = getVal('#edit-media-heading'); elementData.data.description = getVal('#edit-media-description', false); if (elementData.type === 'image') { elementData.data.alt = getVal('#edit-element-alt'); let width = getVal('#edit-element-width') || 'auto'; let height = getVal('#edit-element-height') || 'auto'; const sizeRegex = /^(auto|(\d+(\.\d+)?(px|%|em|rem|vw|vh)?))$/i; elementData.data.width = sizeRegex.test(width) ? width : 'auto'; elementData.data.height = sizeRegex.test(height) ? height : 'auto'; } else { delete elementData.data.alt; delete elementData.data.width; delete elementData.data.height; } break; case 'quiz': saveQuizEditFromModal_Project(elementData.data); break; case 'challenges': saveChallengesEditFromModal_Project(elementData.data); break; default: throw new Error(`Cannot save element type: ${elementData.type}`); } return elementData; }
function saveQuizEditFromModal_Project(quizData) { /* ... (keep previous logic) ... */ if (!modalFormContent) throw new Error("MFC NF saving quiz."); quizData.questions = []; modalFormContent.querySelectorAll('.quiz-edit-question').forEach((qForm, i) => { const qTxt = qForm.querySelector(`#quiz-q-text-${i}`)?.value.trim(); const cAns = qForm.querySelector(`#quiz-q-correct-${i}`)?.value.trim(); if (!qTxt || !cAns) { console.warn(`Skip Q ${i + 1}: Missing text or correct answer.`); return; } const qImg = qForm.querySelector(`#quiz-q-image-${i}`)?.value.trim() || null; const cImg = qForm.querySelector(`#quiz-q-correct-image-${i}`)?.value.trim() || null; const iAns = [], iImgs = []; for (let j = 0; j < 3; j++) { const iTxt = qForm.querySelector(`#quiz-q-incorrect-${i}-${j}`)?.value.trim(); if (iTxt) { iAns.push(iTxt); iImgs.push(qForm.querySelector(`#quiz-q-incorrect-image-${i}-${j}`)?.value.trim() || null); } else { iImgs.push(null); } } while (iImgs.length < iAns.length) iImgs.push(null); quizData.questions.push({ questionText: qTxt, questionImageUrl: qImg, correctAnswer: cAns, correctAnswerImageUrl: cImg, incorrectAnswers: iAns, incorrectAnswersImageUrls: iImgs }); }); console.log("Quiz saved:", quizData.questions); }
function saveChallengesEditFromModal_Project(chData) { /* ... (keep previous logic) ... */ if (!modalFormContent) throw new Error("MFC NF saving C."); chData.heading = getModalValue('#edit-challenges-heading'); chData.description = getModalValue('#edit-challenges-description', '', false); chData.challenges = []; modalFormContent.querySelectorAll('.challenge-edit-item').forEach(item => { const head = item.querySelector('.challenge-heading-input')?.value.trim(); if (!head) return; chData.challenges.push({ id: item.dataset.challengeId || generateId('chal_'), heading: head, iconUrl: item.querySelector('.challenge-icon-input')?.value.trim() || null, description: item.querySelector('.challenge-desc-input')?.value || '', imageUrl: item.querySelector('.challenge-image-input')?.value.trim() || null }); }); console.log("Challenges saved:", chData.challenges); }

// --- Event Listeners Setup ---

function setupGlobalEventListeners() {
    // App Settings Button
    appSettingsButton?.addEventListener('click', () => openEditModal('appStyles'));

    // --- Dashboard View Event Delegation ---
    dashboardView?.addEventListener('click', (e) => {
        const target = e.target;
        const button = target.closest('button'); // Find closest button clicked
        const itemContainer = target.closest('.item-container');

        if (button) { // Handle button clicks first
            e.stopPropagation(); // Prevent item click navigation if clicking a button
            const action = button.dataset.action;
            const buttonId = button.id; // Get the button's ID

            // Handle View Toggle Buttons
            if (buttonId === 'dashboard-grid-view-btn') {
                setItemViewMode(courseListContainer, 'grid', dashboardGridViewBtn, dashboardListViewBtn);
                return; // Handled
            }
            if (buttonId === 'dashboard-list-view-btn') {
                setItemViewMode(courseListContainer, 'list', dashboardGridViewBtn, dashboardListViewBtn);
                return; // Handled
            }
             // Handle Add Course Button
             if (buttonId === 'add-course-btn') {
                if (appData.courses.length < MAX_COURSES) { openEditModal('course', null, null, true); }
                else { alert(`Max courses (${MAX_COURSES}) reached.`); }
                return; // Handled
             }

            // Handle Action Buttons on Items (Edit/Remove/View Projects)
            const courseId = button.closest('[data-course-id]')?.dataset.courseId;
            if (action && courseId) {
                 switch (action) {
                     case 'view-projects': showView('course', courseId); break;
                     case 'edit-course': openEditModal('course', courseId); break;
                     case 'remove-course': removeCourse(courseId); break;
                 }
                 return; // Handled
            }

        } else if (itemContainer && itemContainer.dataset.courseId) { // Handle click on item itself
            e.stopPropagation();
            showView('course', itemContainer.dataset.courseId);
        }
    });

    // --- Course View Event Delegation ---
    courseView?.addEventListener('click', (e) => {
         const target = e.target;
         const button = target.closest('button'); // Find closest button
         const itemContainer = target.closest('.item-container');

         if (button) {
            e.stopPropagation();
            const action = button.dataset.action;
            const buttonId = button.id;

            // Handle View Toggle Buttons
            if (buttonId === 'course-grid-view-btn') {
                setItemViewMode(projectListContainer, 'grid', courseGridViewBtn, courseListViewBtn);
                return; // Handled
            }
            if (buttonId === 'course-list-view-btn') {
                setItemViewMode(projectListContainer, 'list', courseGridViewBtn, courseListViewBtn);
                return; // Handled
            }
            // Handle Add Project Button
            if (buttonId === 'add-project-btn') {
                const course = findCourse(activeCourseId);
                if (course && course.projects.length < MAX_PROJECTS_PER_COURSE) { openEditModal('project', null, activeCourseId, true); }
                else if (course) { alert(`Max projects (${MAX_PROJECTS_PER_COURSE}) reached.`); }
                else { alert("Cannot find course."); }
                return; // Handled
            }
             // Handle Back Button
            if (buttonId === 'back-to-dashboard-btn') {
                 showView('dashboard');
                 return; // Handled
            }

            // Handle Action Buttons on Items
            const projectId = button.closest('[data-project-id]')?.dataset.projectId;
            const courseId = button.closest('[data-course-id]')?.dataset.courseId || activeCourseId;
            if (action && projectId) {
                 switch (action) {
                     case 'open-project': showView('project', courseId, projectId); break;
                     case 'edit-project': openEditModal('project', projectId, courseId); break;
                     case 'remove-project': removeProject(projectId, courseId); break;
                 }
                 return; // Handled
            }

         } else if (itemContainer && itemContainer.dataset.projectId) {
             e.stopPropagation();
             showView('project', itemContainer.dataset.courseId, itemContainer.dataset.projectId);
         }
    });

    // Project View Back Button (Direct listener is okay here)
    backToProjectsButton?.addEventListener('click', () => {
        if (activeCourseId) { showView('course', activeCourseId); }
        else { showView('dashboard'); }
    });

    // Modal Buttons
    closeModalButton?.addEventListener('click', closeModal);
    cancelModalButton?.addEventListener('click', closeModal);
    saveModalButton?.addEventListener('click', saveEditAction);

    // Modal Form Internal Actions (Delegated)
    modalFormContent?.addEventListener('click', handleModalFormInternalClick);

    // Global Keydown Listener
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal?.style.display === 'flex') closeModal(); });

    // Handle Hash Changes
    window.addEventListener('hashchange', handleHashChange);

    // Global listener for font size custom input toggle
    document.addEventListener('change', (e) => { /* ... (keep previous logic) ... */ if (e.target && e.target.id === 'edit-global-style-size') { const customInput = modalFormContent.querySelector('#edit-global-style-size-custom'); if (customInput) { const showCustom = (e.target.value === 'custom'); customInput.style.display = showCustom ? 'inline-block' : 'none'; if (!showCustom) customInput.value = ''; if (showCustom) customInput.focus(); } } });
}


// Extracted Remove Logic
function removeCourse(courseId) {
    const course = findCourse(courseId);
    if (course && confirm(`DELETE Course "${escapeHtml(course.name)}"?\n\nThis will also delete ALL ${course.projects.length} projects inside it permanently!`)) {
        course.projects.forEach(p => deleteSpecificProjectData(p.id));
        appData.courses = appData.courses.filter(c => c.id !== courseId);
        saveAppData(); renderDashboardView();
    }
}
function removeProject(projectId, courseId) {
     const projectMeta = findProjectMeta(projectId);
     if (projectMeta && confirm(`DELETE Project "${escapeHtml(projectMeta.name)}"? This cannot be undone.`)) {
         deleteSpecificProjectData(projectId);
         const course = findCourse(courseId);
         if (course) { course.projects = course.projects.filter(p => p.id !== projectId); saveAppData(); renderCourseView(courseId); }
     }
}

// Handles clicks inside the modal form for things specific to certain edit types
function handleModalFormInternalClick(e) {
    const target = e.target;
    const { type: currentModalType } = editingContext; // What type of item is the modal editing?

    // --- Project Element Editing Specifics (Quiz/Challenges) ---
    if (currentModalType === 'element') {
        if (target.matches('#quiz-editor-add-question-btn')) { /* ... (Add quiz Q logic using renderSingleQuizQuestionForm_Editor) ... */ const cont = modalFormContent.querySelector('#quiz-editor-questions-container'); const msg = modalFormContent.querySelector('#quiz-editor-no-questions-msg'); if (cont) { if (msg) msg.remove(); const idx = cont.children.length; cont.insertAdjacentHTML('beforeend', renderSingleQuizQuestionForm_Editor({}, idx)); const nI = cont.querySelector(`#quiz-q-text-${idx}`); if(nI) setTimeout(()=>nI.focus(), 50); } }
        else if (target.matches('.quiz-editor-remove-question-btn')) { /* ... (Remove quiz Q logic) ... */ const idx = parseInt(target.dataset.index, 10); if (!isNaN(idx) && confirm(`Remove Q ${idx + 1}?`)) { const qDiv = target.closest('.quiz-edit-question'); if (qDiv) { qDiv.remove(); const cont = modalFormContent.querySelector('#quiz-editor-questions-container'); if (cont && cont.children.length === 0 && !cont.querySelector('#quiz-editor-no-questions-msg')) { cont.innerHTML = '<p id="quiz-editor-no-questions-msg" style="text-align:center; font-style:italic;">No questions added yet.</p>';}} } }
        else if (target.matches('#challenges-editor-add-btn')) { /* ... (Add challenge logic using renderSingleChallengeForm_Editor) ... */ if (target.disabled) return; const list = modalFormContent.querySelector('#challenges-editor-list'); const msg = modalFormContent.querySelector('#challenges-editor-no-items-msg'); const count = list ? list.querySelectorAll('.challenge-edit-item').length : 0; if (list && count < MAX_CHALLENGES) { if (msg) msg.remove(); const idx = count; list.insertAdjacentHTML('beforeend', renderSingleChallengeForm_Editor({}, idx)); const nI = list.querySelector(`#challenge-heading-${idx}`); if(nI) setTimeout(()=>nI.focus(), 50); if (count + 1 >= MAX_CHALLENGES) target.disabled = true; } }
        else if (target.matches('.challenges-editor-remove-btn')) { /* ... (Remove challenge logic) ... */ const idx = parseInt(target.dataset.index, 10); if (!isNaN(idx) && confirm(`Remove Challenge ${idx + 1}?`)) { const cDiv = target.closest('.challenge-edit-item'); if (cDiv) { cDiv.remove(); const addBtn = modalFormContent.querySelector('#challenges-editor-add-btn'); if (addBtn) { const currentCount = modalFormContent.querySelectorAll('.challenge-edit-item').length; addBtn.disabled = (currentCount >= MAX_CHALLENGES); } const list = modalFormContent.querySelector('#challenges-editor-list'); if (list && list.children.length === 0 && !list.querySelector('#challenges-editor-no-items-msg')) { list.innerHTML = '<p id="challenges-editor-no-items-msg" style="text-align:center; font-style:italic;">No challenges added yet.</p>'; }} } }
    }

    // --- Project Styles Specifics ---
    if (currentModalType === 'styles') {
         if (target.matches('#inherit-text-color-btn')) {
             const colorInput = modalFormContent.querySelector('#edit-global-style-color');
             if (colorInput) {
                 colorInput.value = appData.globalStyles.appTextColor || DEFAULT_TEXT_COLOR; // Set to global
                 // Optionally clear the stored project-specific value on save if user clicks inherit
                 // This requires modification in saveEditAction case 'styles'
             }
         }
         // Could add similar buttons for font/size inherit
    }
}


// --- Project Editor Event Listeners Management ---
let isProjectEditorListenersActive = false;
const projectEditorEventHandlers = { // Store handlers to easily add/remove
    handleProjectSidebarClick, handleProjectAddControlsClick, handleProjectContentAreaClick
};

function setupEventListeners_Editor() {
    if (isProjectEditorListenersActive) return;
    console.log("Setting up project editor event listeners.");
    const { addTabButton, editStylesButton, tabsContainer, contentArea, addControls } = projectEditorElements;

    addTabButton?.addEventListener('click', addTabAction_Editor);
    editStylesButton?.addEventListener('click', () => openEditModal('styles', activeProjectId)); // Context is 'styles' for current project
    tabsContainer?.addEventListener('click', projectEditorEventHandlers.handleProjectSidebarClick);
    addControls?.addEventListener('click', projectEditorEventHandlers.handleProjectAddControlsClick);
    contentArea?.addEventListener('click', projectEditorEventHandlers.handleProjectContentAreaClick);
    // Note: Modal form internal clicks listener is global now (handleModalFormInternalClick)

    isProjectEditorListenersActive = true;
}

function teardownEventListeners_Editor() {
    if (!isProjectEditorListenersActive) return;
    console.log("Tearing down project editor event listeners.");
     const { addTabButton, editStylesButton, tabsContainer, contentArea, addControls } = projectEditorElements;

     // It's safer to remove specific listeners if they were added directly
     // addTabButton?.removeEventListener('click', addTabAction_Editor); // etc.
     // For delegated listeners, we don't strictly need to remove them if the parent element (#project-view)
     // is hidden or removed, but it's cleaner if we do. However, managing this precisely can be complex.
     // For now, the checks within the handlers (if (currentView !== 'project') return;) prevent them from acting inappropriately.

     isProjectEditorListenersActive = false;
}

// --- Project Editor Event Handlers (Keep same as before) ---
function handleProjectSidebarClick(e) { if (currentView !== 'project') return; /* ... */ const target = e.target; const btn = target.closest('button[data-action]'); const name = target.closest('.tab-name,.sub-tab-name'); if (btn) { e.stopPropagation(); const act = btn.dataset.action; const tId = btn.dataset.tabId || btn.dataset.parentTabId; const sId = btn.dataset.subTabId; if (!tId && ['edit-subtab', 'remove-subtab', 'add-subtab'].includes(act)) return; switch (act) { case 'edit-tab': openEditModal('tab', tId, null, false); break; case 'remove-tab': removeTabAction_Editor(tId); break; case 'add-subtab': addSubTabAction_Editor(tId); break; case 'edit-subtab': openEditModal('subtab', sId, tId, false); break; case 'remove-subtab': removeSubTabAction_Editor(tId, sId); break; } } else if (name?.classList.contains('sub-tab-name')) { setActiveTab_Editor(name.dataset.parentTabId, name.dataset.subTabId); } else if (name?.classList.contains('tab-name')) { setActiveTab_Editor(name.dataset.tabId); } }
function handleProjectAddControlsClick(e) { if (currentView !== 'project') return; /* ... */ if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { addElementAction_Editor(e.target.dataset.type); } }
function handleProjectContentAreaClick(e) { if (currentView !== 'project') return; /* ... */ const t = e.target; const actBtn = t.closest('button[data-action]'); const qOpt = t.closest('.quiz-option'); if (actBtn) { const act = actBtn.dataset.action; const elId = t.closest('.content-element')?.dataset.elementId; const qId = t.closest('.quiz-container-inner')?.dataset.quizId || actBtn.dataset.quizId; switch (act) { case 'edit-element': if (elId) openEditModal('element', elId); break; case 'remove-element': if (elId) removeElementAction_Editor(elId); break; case 'submit-quiz': if (qId) submitQuizAction_Editor(qId); break; } } else if (qOpt) { selectQuizOption_Editor(qOpt); } }


// --- Routing ---
function handleHashChange() {
    const hash = window.location.hash; console.log("Hash changed:", hash);
    teardownEventListeners_Editor(); // Remove project listeners before switching view

    if (!hash || hash === '#') { showView('dashboard');
    } else if (hash.startsWith('#/course/')) { const courseId = hash.substring('#/course/'.length); showView('course', courseId);
    } else if (hash.startsWith('#/project/')) { const projectId = hash.substring('#/project/'.length); showView('project', null, projectId);
    } else { showView('dashboard'); }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Loaded. Initializing Enhanced Editor App.");
    loadAppData();
    applyGlobalAppStyles(); // Apply loaded or default global styles first
    setupGlobalEventListeners();
    handleHashChange(); // Initial view based on hash
});

</script>

</body>
</html>
