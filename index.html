<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content Dashboard Main</title>
    <style>
        /* Global Variables & Basic Styles (Structural/Utility Only) */
        :root {
            /* Removed Theme Colors: --primary, --secondary, --accent, --primary-rgb */
            /* Removed Global Text Styles: --global-font-family, --global-font-size, --global-text-color */
            /* Kept Utility/Structural Colors & Variables */
            --light: #F5F7FA;
            --dark: #1A1D28; /* Default dark text/element color */
            --success: #7CE7AC;
            --danger: #FF7E7E;
            --default-primary: #5E81F4; /* Fallback if course/project doesn't define */
            --default-secondary: #FF7AC6;
            --default-accent: #FFB800;
            --default-font-family: 'Segoe UI', sans-serif;
            --default-font-size: 16px; /* Base size */
            --default-text-color: var(--dark);

            --transition-speed: 0.3s;
            --card-bg: #ffffff;
            --card-shadow: 0 3px 10px rgba(0,0,0,0.07);
            --card-hover-shadow: 0 6px 15px rgba(0,0,0,0.1);
            --card-border-radius: 10px;
            --card-padding: 20px;
            --list-item-padding: 15px;
            --view-toggle-size: 30px; /* Size for grid/list buttons */
            --action-icon-btn-size: 38px; /* Size for eye/edit buttons in headers */

            /* Project/Course Editor specific - defaults if not overridden */
            --sidebar-width: 270px;
            --sidebar-minimized-width: 0px; /* For minimized state */
            --header-image-size: 120px;
            --challenge-icon-size: 40px;
            --progress-bar-height: 8px;
            --error-image-fallback: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666666' font-size='12' font-family='sans-serif'%3EError%3C/text%3E%3C/svg%3E");
        }

        html { scroll-behavior: smooth; box-sizing: border-box; font-size: var(--default-font-size); } /* Use default */
        *, *:before, *:after { box-sizing: inherit; }

        body {
            font-family: var(--default-font-family); /* Use default */
            color: var(--default-text-color); /* Use default */
            margin: 0; padding: 0; background-color: var(--light); line-height: 1.6;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, font-family var(--transition-speed) ease, font-size var(--transition-speed) ease;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        /* --- General Headings & Buttons --- */
        /* Headings will inherit color from context (body, project, course) or inline styles */
        h1, h2, h3, h4 { transition: color var(--transition-speed) ease; margin-top: 0; color: inherit; }
        h1 { font-size: 2rem; margin-bottom: 15px; color: var(--dark); } /* Dashboard title retains dark */
        .page-header .header-title { margin: 0 0 5px 0; color: white; font-size: 1.8rem; }
        .page-header .header-subtitle { margin: 0; color: rgba(255,255,255,0.9); font-size: 1rem; }
        /* h2 border color will depend on project/course secondary */
        h2 { font-size: 1.6rem; border-bottom: 2px solid var(--project-secondary, var(--course-secondary, var(--default-secondary))); padding-bottom: 5px; display: inline-block; margin-bottom: 20px; transition: border-color var(--transition-speed) ease; }
        h3 { font-size: 1.3rem; margin-bottom: 10px; }
        h4 { font-size: 1.1rem; color: var(--dark); margin: 0 0 5px 0; }

        /* Element-specific headings/text (inline styles take precedence) */
        .element-heading { /* h2 inside content-element */
            border-bottom: none; /* Remove default border */
            margin-bottom: 10px;
            /* Inline styles for color, font, size, text-align will be applied by JS */
        }
        .element-text { /* p inside content-element */
            white-space: pre-wrap;
            line-height: 1.7;
            margin: 0;
             /* Inline styles for color, font, size, text-align will be applied by JS */
        }

        button { cursor: pointer; font-family: inherit; padding: 8px 15px; border-radius: 6px; border: 1px solid transparent; transition: all 0.2s ease; font-size: 0.95rem; vertical-align: middle; background-color: #eee; color: #333; }
        button:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0.9; }
        button:disabled { cursor: not-allowed; opacity: 0.6; }

        .action-btn { font-size: 0.8em; padding: 4px 8px; margin-left: 5px; border: none; opacity: 0.7; font-weight: bold; vertical-align: middle; line-height: 1; display: inline-flex; align-items: center; justify-content: center; background-color: transparent; }
        .action-btn:hover:not(:disabled) { opacity: 1; background-color: rgba(0,0,0,0.05); }
        .add-btn { background-color: var(--success); color: white; font-weight: bold; border: none; }
        .add-btn:hover:not(:disabled) { background-color: #63c899; }
        /* Edit button color will depend on context */
        .edit-btn { background-color: var(--project-accent, var(--course-accent, var(--default-accent))); color: var(--dark); border: none;}
        .edit-btn:hover:not(:disabled) { background-color: #ffc833; } /* Keep simple hover or make dynamic */
        .remove-btn { background-color: var(--danger); color: white; border: none;}
        .remove-btn:hover:not(:disabled) { background-color: #e66a6a; }
        /* View button color will depend on context */
        .view-btn { background-color: var(--project-primary, var(--course-primary, var(--default-primary))); color: white; padding: 6px 12px; font-size: 0.9em; border: none;}
        .view-btn:hover:not(:disabled) { background-color: #4a6cdc; } /* Keep simple hover or make dynamic */
        .back-btn { background-color: #aaa; color: white; padding: 6px 12px; font-size: 0.9em; border: none;}
        .back-btn:hover { background-color: #888; }

        /* --- View Containers --- */
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px;}
        .view-header h1 { margin-bottom: 0; text-align: left; }
        .view-controls { display: flex; gap: 10px; align-items: center; }

        /* --- Dashboard & Course View Styles --- */
        .item-list { margin-bottom: 30px; transition: all var(--transition-speed) ease;}
        .item-list.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; }
        .item-card { display: flex; flex-direction: column; background-color: var(--card-bg); border-radius: var(--card-border-radius); box-shadow: var(--card-shadow); transition: transform 0.2s ease, box-shadow 0.2s ease; position: relative; overflow: hidden; cursor: pointer; min-height: 280px; /* Adjust min-height for better alignment */ }
        .item-card:hover { transform: translateY(-3px); box-shadow: var(--card-hover-shadow); }
        .item-card .item-image { width: 100%; height: 150px; object-fit: cover; background-color: #eee; border-bottom: 1px solid #eee; flex-shrink: 0; }
        .item-card .item-image[data-error="true"] { content: var(--error-image-fallback); object-fit: contain; padding: 10px; background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .item-card .item-content { padding: var(--card-padding); flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .item-card .item-heading-container { margin-bottom: 8px; width: 100%; }
        .item-card p { font-size: 0.9rem; color: #555; margin-bottom: 15px; word-break: break-word; }
        .item-card .item-card-actions { display: none; }

        .add-item-card, .add-item-row {
             display: flex; align-items: center; justify-content: center;
             background-color: #e9eef5; border: 2px dashed #c4cde0;
             border-radius: var(--card-border-radius); box-shadow: none;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             cursor: pointer; color: var(--default-primary); /* Use default primary for add */
             font-size: 3rem; font-weight: bold; text-align: center; min-height: 280px;
        }
        .add-item-card:hover, .add-item-row:hover {
            background-color: #dde4f0; border-color: var(--default-primary); /* Use default primary */
        }
        .item-list.list-view .add-item-row { min-height: 80px; font-size: 2rem; padding: 15px; margin-top: 10px; }

        #project-list .item-card .item-card-actions { display: none; }
        #course-list .item-card .item-card-actions:empty { display: none; }

        .item-card-actions .action-btn { padding: 6px; font-size: 1.1rem;}
        .item-heading-container { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: nowrap; width: 100%; margin-top: 5px; }
        /* Heading color will depend on context */
        .item-heading-container h4 { margin: 0; flex-grow: 1; flex-shrink: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: var(--project-primary, var(--course-primary, var(--default-primary))); }
        .item-inline-actions { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
        .item-inline-actions .action-btn { padding: 4px; font-size: 1rem; background-color: transparent; border: 1px solid transparent; opacity: 0.6; transition: all 0.2s ease; }
        .item-inline-actions .action-btn:hover { opacity: 1; background-color: rgba(0,0,0,0.08); border-color: #ccc; }
        .item-inline-actions .remove-btn.action-btn { color: var(--danger); opacity: 0.7; }
        .item-inline-actions .remove-btn.action-btn:hover { color: white; background-color: var(--danger); border-color: var(--danger); opacity: 1; }
        /* Edit button color/hover depends on context */
        .item-inline-actions .edit-btn.action-btn { color: #555; }
        .item-inline-actions .edit-btn.action-btn:hover { color: var(--dark); background-color: var(--project-accent, var(--course-accent, var(--default-accent))); border-color: var(--project-accent, var(--course-accent, var(--default-accent))); opacity: 1; }

        .item-list.list-view { display: flex; flex-direction: column; gap: 10px; max-width: 800px; margin-left: auto; margin-right: auto; }
        .item-row { display: flex; align-items: center; gap: 15px; background-color: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.06); padding: var(--list-item-padding); transition: transform 0.2s ease, box-shadow 0.2s ease; cursor: pointer; border: 1px solid #eee; }
        .item-row:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.08); border-color: #ddd; }
        .item-row .item-image { width: 80px; height: 60px; object-fit: cover; background-color: #eee; border-radius: 6px; flex-shrink: 0; }
        .item-row .item-image[data-error="true"] { content: var(--error-image-fallback); object-fit: contain; padding: 5px; background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .item-row .item-content { flex-grow: 1; display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .item-row .item-text-details { flex-grow: 1; }
        /* Row heading color depends on context */
        .item-row h4 { margin-bottom: 4px; color: var(--project-primary, var(--course-primary, var(--default-primary))); font-size: 1.05rem; word-break: break-word; }
        .item-row p { font-size: 0.9rem; color: #555; margin-bottom: 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }

        /* View toggle uses context primary color */
        .view-toggle button { background: none; border: 1px solid #ccc; border-radius: 4px; padding: 5px; width: var(--view-toggle-size); height: var(--view-toggle-size); display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; color: #555; }
        .view-toggle button:hover { background-color: #eee; }
        .view-toggle button.active { background-color: var(--project-primary, var(--course-primary, var(--default-primary))); color: white; border-color: var(--project-primary, var(--course-primary, var(--default-primary))); }
        .view-toggle button svg { width: 18px; height: 18px; fill: currentColor; }
        /* Specific style for icon-only buttons */
        button.icon-btn {
             background-color: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.5);
             width: var(--action-icon-btn-size); height: var(--action-icon-btn-size);
             border-radius: 50%; font-size: 20px; padding: 0;
             display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        button.icon-btn:hover { background-color: rgba(255,255,255,0.4); }
        button.icon-btn svg { width: 20px; height: 20px; fill: currentColor; }

        /* Style for Dashboard view toggle icon button */
        #dashboard-view .view-controls .icon-btn {
             background-color: transparent; border: 1px solid #ccc; color: #555;
             width: var(--view-toggle-size); height: var(--view-toggle-size); font-size: 1.1rem;
        }
         #dashboard-view .view-controls .icon-btn:hover { background-color: #eee; }
         #dashboard-view .view-controls .icon-btn svg { width: 18px; height: 18px; }


        /* --- Shared Page Header Style (Project & Course) --- */
        /* Header uses course/project specific colors */
        .page-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 25px;
            background: linear-gradient(135deg, var(--course-primary, var(--project-primary, var(--default-primary))), var(--course-secondary, var(--project-secondary, var(--default-secondary))));
            color: white; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transition: background var(--transition-speed) ease; gap: 15px;
        }
        .page-header .header-content { display: flex; align-items: center; gap: 20px; flex-grow: 1; min-width: 0; }
        .page-header .header-title-container { flex-grow: 1; min-width: 0; }
        .page-header .header-actions { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .page-header .header-actions .back-btn { background-color: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); }
        .page-header .header-actions .back-btn:hover { background-color: rgba(255,255,255,0.4); }
        /* CHANGED: Use icon-btn class for consistency */
        #edit-project-styles-btn, #edit-course-styles-btn, #toggle-view-mode-btn, #toggle-project-view-mode-btn {
            /* Inherit from .icon-btn */
        }
        .page-header .header-image {
            width: var(--header-image-size); height: var(--header-image-size); object-fit: cover;
            border-radius: 8px; border: 3px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.2); flex-shrink: 0;
        }
        .page-header .header-image[data-error="true"] {
            background-image: var(--error-image-fallback); background-size: contain;
            background-repeat: no-repeat; background-position: center; object-fit: contain;
        }

        /* --- Course View Specific Styles --- */
        #course-view { /* Course specific CSS vars set by JS */
             --course-primary: var(--default-primary);
             --course-secondary: var(--default-secondary);
             --course-accent: var(--default-accent);
             --course-text-color: var(--default-text-color);
             /* Add font if needed, or inherit body */
        }
        #course-view .course-content-header { margin-bottom: 15px; }
        #course-view .course-main-content {
            /* Uses course specific vars for bg/color, applied by JS */
            background-color: #fff; padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; min-height: 100px;
            transition: background-color 0.3s ease, color 0.3s ease;
            color: var(--course-text-color); /* Apply text color */
        }
        #course-view .element-controls p { color: var(--course-primary); }
        #course-view .element-controls button { background-color: #eef2ff; color: var(--course-primary); border: 1px solid var(--course-primary); }
        #course-view .element-controls button:hover:not(:disabled) { background-color: var(--course-primary); color: white; }

        /* --- Project View Specific Styles (Layout, Sidebar, Styling Scope) --- */
        #project-view { /* Project specific CSS vars set by JS */
             --project-primary: var(--default-primary);
             --project-secondary: var(--default-secondary);
             --project-accent: var(--default-accent);
             --project-text-color: var(--default-text-color);
             --project-font-family: var(--default-font-family);
             --project-font-size: var(--default-font-size);
             --project-primary-rgb: 94, 129, 244; /* Default, updated by JS */
        }
        
    #project-view .project-layout {
        display: flex;
        /* gap: 25px; */
         /* transition: gap 0.3s ease; */ /* REMOVED or commented out */
    }

    #project-view #project-sidebar {
        width: var(--sidebar-width); /* Explicit width is important for translate */
        flex-shrink: 0;
        background-color: #fff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        height: fit-content;
        opacity: 1;
        overflow: hidden; /* Keep overflow hidden */
        /* --- CHANGED: Animate transform and opacity --- */
        transform: translateX(0); /* Start in default position */
        transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        /* Remove width/max-width/padding from transition */
    }

        
    #project-view.sidebar-minimized #project-sidebar {
         /* --- CHANGED: Use transform to slide left and fade out --- */
         transform: translateX(-100%); /* Slide completely to the left */
         opacity: 0;
         pointer-events: none; /* Prevent interaction */
         /* --- ADDED: Also remove padding/width when hidden to prevent layout shifts --- */
         padding-left: 0;
         padding-right: 0;
         width: 0; /* Collapse width instantly or with faster transition if needed */
         /* margin-right: 0; Remove if still present */
    }
        
        #project-view #project-tabs { margin-bottom: 15px; }
        #project-view .tab, #project-view .sub-tab { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer; border: 1px solid #eee; transition: all 0.2s ease; background-color: #fff; position: relative; }
        #project-view .tab:hover:not(.active), #project-view .sub-tab:hover:not(.active) { background-color: #f0f5ff; border-color: #c4cde0; }
        #project-view .tab.active { background-color: var(--project-primary); color: white; border-color: var(--project-primary); box-shadow: 0 2px 5px rgba(var(--project-primary-rgb), 0.2); font-weight: bold; }
        #project-view .sub-tab.active { background-color: var(--project-secondary); border-color: var(--project-secondary); color: white; box-shadow: 0 2px 5px rgba(255, 122, 198, 0.2); font-weight: bold; }
        #project-view .tab:hover .tab-controls, #project-view .sub-tab:hover .sub-tab-controls, #project-view .tab.active .tab-controls, #project-view .sub-tab.active .sub-tab-controls { display: inline-flex; gap: 5px; }
        #project-view.student-mode .tab:hover .tab-controls, #project-view.student-mode .sub-tab:hover .sub-tab-controls { display: none !important; }
        #project-view .tab.active .action-btn { color: var(--project-primary); background-color: white; opacity: 1; }
        #project-view .sub-tab.active .action-btn { color: var(--project-secondary); background-color: white; opacity: 1; }
        #project-view .tab-name, #project-view .sub-tab-name { flex-grow: 1; margin-right: 10px; word-break: break-word; padding: 2px 0; }
        /* Style for completed sections */
        #project-view .tab.completed-section, #project-view .sub-tab.completed-section { border-left: 4px solid var(--success); background-color: #f0fff4; }
        #project-view .tab-name::after, #project-view .sub-tab-name::after {
            content: ' âœ…'; font-size: 0.8em; margin-left: 5px;
            display: none; /* Hide by default */
        }
        #project-view .tab.completed-section .tab-name::after,
        #project-view .sub-tab.completed-section .sub-tab-name::after {
            display: inline; /* Show for completed */
        }
        #project-view .sub-tab { margin-left: 20px; padding: 8px 10px; font-size: 0.9em; margin-bottom: 5px; background-color: #f9f9fc; }
        #project-view .tab-controls, #project-view .sub-tab-controls { display: none; flex-shrink: 0; }
        #project-view .sidebar-actions { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; text-align: center; }
        #project-view .sidebar-actions .add-btn { width: 80%; }
        
    #project-view #project-main-content {
         flex-grow: 1; background-color: #fff; padding: 25px; border-radius: 10px;
         box-shadow: 0 2px 8px rgba(0,0,0,0.06); min-height: 400px;
         /* Font family, size, color applied via inline CSS variables on #project-view */
         color: var(--project-text-color);
         font-family: var(--project-font-family);
         font-size: var(--project-font-size);
         /* --- ADDED: Handle margin based on sidebar presence --- */
         margin-left: calc(var(--sidebar-width) + 25px); /* Add space for sidebar + original gap */
         transition: margin-left 0.3s ease-in-out; /* Animate the margin shift */
    }

    /* --- ADDED: Adjust main content margin when sidebar is minimized --- */
    #project-view.sidebar-minimized #project-main-content {
         margin-left: 0; /* Remove the left margin */
    }

        #project-view #tab-content-area { margin-bottom: 30px; }
        #project-view #tab-content-area > p { text-align: center; color: #888; margin-top: 30px; font-style: italic; }
        #project-view .element-controls p { color: var(--project-primary); }
        #project-view .element-controls button { background-color: #eef2ff; color: var(--project-primary); border: 1px solid var(--project-primary); }
        #project-view .element-controls button:hover:not(:disabled) { background-color: var(--project-primary); color: white; }

        /* NEW: Project Header Extension (Toggle & Progress) */
        .project-header-extension {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 25px; /* Match header padding */
            background-color: #f0f2f5; /* Light background */
            border-radius: 0 0 10px 10px; /* Rounded bottom corners */
            margin-top: -10px; /* Pull slightly under header */
            margin-bottom: 20px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        #toggle-sidebar-btn {
            background-color: #fff;
            border: 1px solid #ccc;
            color: #555;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            padding: 0;
            font-size: 18px; /* Adjust icon size */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            line-height: 1; /* Ensure icon is centered */
        }
        #toggle-sidebar-btn:hover { background-color: #eee; }
        #toggle-sidebar-btn svg { width: 18px; height: 18px; fill: currentColor; } /* CHANGED: For SVG icons */
        #toggle-sidebar-btn .icon-maximize { display: none; } /* Hide maximize icon initially */
        #project-view.sidebar-minimized #toggle-sidebar-btn .icon-minimize { display: none; } /* Hide minimize when sidebar is minimized */
        #project-view.sidebar-minimized #toggle-sidebar-btn .icon-maximize { display: block; } /* Show maximize when sidebar is minimized */

        #project-progress-container {
            flex-grow: 1;
            height: var(--progress-bar-height);
            background-color: #e0e0e0;
            border-radius: calc(var(--progress-bar-height) / 2);
            overflow: hidden;
            position: relative;
        }
        #project-progress-fill {
            height: 100%;
            width: 0%; /* Default to 0 */
            background-color: var(--project-primary); /* Use project primary color */
            border-radius: calc(var(--progress-bar-height) / 2);
            transition: width 0.4s ease-out;
            text-align: right;
            line-height: var(--progress-bar-height);
            font-size: calc(var(--progress-bar-height) * 0.8); /* Smaller text inside */
            color: white;
            padding-right: 5px;
            box-sizing: border-box;
            overflow: hidden; /* Hide text if bar is too small */
            white-space: nowrap;
        }


        /* --- Generic Content Element Styles (Project & Course) --- */
        .content-element {
            margin-bottom: 25px; padding: 20px;
            border: 1px dashed transparent; /* Default transparent border */
            border-radius: 8px; position: relative;
            transition: border-color 0.2s ease, background-color 0.2s ease;
            /* Alignment and Size classes will be added here by JS */
        }
        /* Add border only in editor mode */
        #project-view:not(.student-mode) .content-element,
        #course-view:not(.student-mode) .content-element {
            border-color: #e0e0e0;
        }
        /* Remove hover effects in student mode */
        .student-mode .content-element:hover {
             border-color: transparent !important; /* Override editor border */
             background-color: transparent !important;
             cursor: default;
        }
        /* Editor mode hover */
        .content-element:hover:not(.student-mode .content-element) {
            border-style: solid;
            border-color: #b0b0b0;
            background-color: #fdfdfd;
        }

        /* NEW Alignment & Width Classes */
        /* Block Alignment: Applied to .content-element wrapper */
        .content-element.align-left { margin-left: 0; margin-right: auto; }
        .content-element.align-center { margin-left: auto; margin-right: auto; }
        .content-element.align-right { margin-left: auto; margin-right: 0; }
        /* Block Width: Applied to .content-element wrapper */
        .content-element.width-small { max-width: 400px; }
        .content-element.width-medium { max-width: 700px; }
        .content-element.width-large { max-width: 1000px; }
        .content-element.width-full { max-width: 100%; width: 100%; }
        /* 'auto' width is default, no class needed or use .width-auto if explicit control is desired */

        /* Text Alignment: Applied via inline style by JS to heading/text paragraph */
        /* The wrapper's align-* class controls block position, inline style controls text inside */

        .element-actions { position: absolute; top: 8px; right: 8px; display: none; background: rgba(245, 247, 250, 0.9); padding: 4px; border-radius: 5px; z-index: 10; gap: 4px; }
        .content-element:hover .element-actions { display: flex; }
        .media-heading { font-size: 1.3rem; margin-bottom: 8px; color: inherit; /* Inherit color */ border-bottom: 1px solid #eee; padding-bottom: 4px; }
        .media-description { font-size: 0.95rem; color: inherit; opacity: 0.8; /* Slightly faded */ margin-top: 5px; margin-bottom: 15px; white-space: pre-wrap; }
        .element-image img { display: block; max-width: 100%; height: auto; border-radius: 8px; border: none; background-color: #eee; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
        .element-image img[data-error="true"] { content: var(--error-image-fallback); min-height: 80px; background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center; }
        .element-image-wrapper { margin-top: 10px; overflow: hidden; position: relative; max-width: 100%; /* Image wrapper respects parent width */ display: inline-block; /* Allows alignment */ }

        /* Video/Presentation wrapper - still 16:9, respects parent width */
        .media-wrapper-16-9 {
            position: relative; padding-bottom: 56.25%; /* 16:9 ratio */
            height: 0; overflow: hidden; max-width: 100%; /* Takes width from parent */
            margin: 10px 0 0 0; /* Adjusted margin */
            border-radius: 12px; background-color: #111; /* Darker bg for videos */
            box-shadow: 0 5px 12px rgba(0,0,0,.1);
            display: block; /* Ensure it takes block space */
        }
        /* Ensure video wrapper respects alignment of parent block */
        .content-element.align-center .media-wrapper-16-9,
        .content-element.align-left .media-wrapper-16-9,
        .content-element.align-right .media-wrapper-16-9 {
            margin-left: auto; margin-right: auto; /* Default center within block */
        }
        .content-element.align-left .media-wrapper-16-9 { margin-left: 0; }
        .content-element.align-right .media-wrapper-16-9 { margin-right: 0; }

        .media-wrapper-16-9 iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 12px; }

        /* CHANGED: Mark Complete Alignment */
        .element-markcomplete {
            padding: 10px 0;
             /* Alignment controlled by parent .content-element align-* class */
             text-align: inherit; /* Let parent container dictate alignment */
        }
        .element-markcomplete button {
             padding: 10px 25px; font-size: 1rem; font-weight: bold;
             border-radius: 25px; border: none;
             background-color: var(--project-primary, var(--course-primary, var(--default-primary))); /* Default state color */
             color: white;
             transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
             display: inline-flex; align-items: center; gap: 8px; /* For icon */
        }
        .element-markcomplete button.completed {
             background-color: var(--success) !important; /* Force success color when complete */
             cursor: default;
        }
        .element-markcomplete button .complete-icon { display: none; }
        .element-markcomplete button.completed .complete-icon { display: inline; }
        .element-markcomplete button:hover:not(:disabled):not(.completed) {
             transform: translateY(-2px); opacity: 0.9;
             box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        /* --- Project Editor Specific Element Styles (Use Project Vars) --- */
        #project-view .element-quiz { background-color: #f8f9ff; padding: 20px; border: 1px solid #e0e8ff; }
        #project-view .quiz-container-inner { margin-top: 10px; }
        #project-view .quiz-question { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        #project-view .quiz-question:last-child { border-bottom: none; margin-bottom: 0; }
        #project-view .quiz-question-content { display: flex; flex-direction: column; gap: 10px; align-items: flex-start; margin-bottom: 10px;} /* CHANGED: Column layout, align start */
        #project-view .quiz-question-image { order: 1; /* Place image after text */ max-width: 250px; max-height: 180px; border-radius: 4px; object-fit: contain; flex-shrink: 0; display: block; margin-top: 10px; } /* CHANGED: block, margin */
        #project-view .quiz-question-image[data-error="true"] { content: var(--error-image-fallback); background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center;}
        #project-view .quiz-question-text { flex-grow: 1; font-weight: bold; color: var(--project-text-color); margin: 0; text-align: left; } /* CHANGED: text-align left */
        #project-view .quiz-options { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; } /* CHANGED: margin-top */
        #project-view .quiz-option { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; padding: 10px 15px; background-color: #fff; border: 1px solid #d8dde6; border-radius: 6px; cursor: pointer; transition: all .2s ease; } /* CHANGED: column, align-start */
        #project-view .quiz-option-image { max-width: 150px; max-height: 100px; border-radius: 4px; object-fit: contain; flex-shrink: 0; display: block; margin-top: 5px; order: 1;} /* CHANGED: block, margin, order */
        #project-view .quiz-option-image[data-error="true"] { content: var(--error-image-fallback); background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center;}
        #project-view .quiz-option-text { flex-grow: 1; color: inherit; text-align: left; } /* CHANGED: text-align left */
        #project-view .quiz-question:not(.answered) .quiz-option:hover { background-color: #e8ecf3; border-color: #c4cde0; }
        #project-view .quiz-option.selected { border-color: var(--project-primary) !important; background-color: #e8f0fe; font-weight: 500; }
        #project-view .quiz-option.correct { background-color: var(--success) !important; color: #fff !important; border-color: #63c899 !important; font-weight: bold; }
        #project-view .quiz-option.incorrect { background-color: var(--danger) !important; color: #fff !important; border-color: #e66a6a !important; }
        #project-view .quiz-option.incorrect .quiz-option-text { text-decoration: line-through; }
        #project-view .quiz-question.answered .quiz-option { cursor: default; }
        #project-view .quiz-question.answered .quiz-option:not(.selected):not(.correct) { opacity: .6; }
        #project-view .quiz-feedback { margin-top: 10px; padding: 8px 12px; border-radius: 6px; display: none; font-size: .9rem; font-weight: 500;}
        #project-view .quiz-feedback.correct { background-color: #e6f7ed; color: #1d6c45; border: 1px solid #c3e6cb; }
        #project-view .quiz-feedback.incorrect { background-color: #fde8e8; color: #9b1c1c; border: 1px solid #f5c6cb; }
        #project-view .quiz-submit-btn { background-color: var(--project-accent); color: var(--dark); border: none; padding: 10px 25px; border-radius: 20px; font-weight: bold; margin-top: 20px; display: block; width: fit-content; }
        #project-view .quiz-submit-btn:hover:not(:disabled) { background-color: #ffc833; }
        #project-view .final-quiz-result { margin-top: 15px; padding: 12px 15px; border-radius: 6px; text-align: center; font-weight: bold; font-size: 1.05rem;}
        #project-view .final-quiz-result.success { background-color: var(--success); color: white; }
        #project-view .final-quiz-result.fail { background-color: var(--danger); color: white; }
        #project-view .element-challenges { padding: 15px; background-color: #fff8e1; border: 1px solid #ffe082; }
        #project-view .challenges-list { list-style: none; padding: 0; margin: 0; }
        #project-view .challenge-item { display: flex; align-items: flex-start; /* Align icon/content to top */ gap: 15px; padding: 15px 0; border-bottom: 1px dotted #ccc; position: relative; /* For image wrapper positioning */ } /* CHANGED: flex, gap */
        #project-view .challenge-item:last-child { border-bottom: none; }
        #project-view .challenge-icon { width: var(--challenge-icon-size); height: var(--challenge-icon-size); flex-shrink: 0; border-radius: 50%; object-fit: contain; background-color: #eee;}
        #project-view .challenge-icon[data-error="true"] { content: var(--error-image-fallback); background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center;}
        #project-view .challenge-content { flex-grow: 1; text-align: left; } /* CHANGED: text-align left */
        #project-view .challenge-content h4 { margin: 0 0 5px 0; font-size: 1.1rem; color: var(--project-text-color); }
        #project-view .challenge-content p { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--project-text-color); opacity: 0.9; white-space: pre-wrap;}
        /* CHANGED: Challenge Image Wrapper for layout control */
        #project-view .challenge-image-wrapper {
            flex-shrink: 0; /* Prevent shrinking */
            margin-left: 15px; /* Add space between text and image wrapper */
            width: auto; /* Allow wrapper to size based on image */
            /* Alignment classes will be added by JS */
        }
        #project-view .challenge-image-wrapper.align-left { margin-left: 0; margin-right: auto; text-align: left; }
        #project-view .challenge-image-wrapper.align-center { margin-left: auto; margin-right: auto; text-align: center; }
        #project-view .challenge-image-wrapper.align-right { margin-left: auto; margin-right: 0; text-align: right; }

        #project-view .challenge-image { display: block; /* Changed to block for alignment control */ height: auto; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); max-width: 100%; /* Max width relative to wrapper */ }
        /* Size classes for challenge image */
        #project-view .challenge-image.size-small { max-width: 150px; max-height: 120px; }
        #project-view .challenge-image.size-medium { max-width: 250px; max-height: 180px; }
        #project-view .challenge-image.size-large { max-width: 400px; max-height: 280px; }
        #project-view .challenge-image.size-custom { /* Width/Height applied inline */ }

        #project-view .challenge-image[data-error="true"] { content: var(--error-image-fallback); min-height: 50px; min-width: 80px; background-image: var(--error-image-fallback); background-size: contain; background-repeat: no-repeat; background-position: center;}


        /* --- Modal Styles --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.6); z-index: 1000; overflow-y: auto; padding: 20px; align-items: center; justify-content: center; animation: fadeInModal 0.3s ease; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: #fff; margin: auto; padding: 25px 30px; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 5px 15px rgba(0,0,0,.3); position: relative; display: flex; flex-direction: column; max-height: 90vh; animation: slideInModal 0.3s ease-out; }
        @keyframes slideInModal { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 32px; font-weight: bold; color: #aaa; cursor: pointer; line-height: 1; padding: 0 5px; z-index: 1010; }
        .close-modal:hover { color: #333; }
        #modal-title { margin-bottom: 20px; font-size: 1.4rem; }
        #modal-form-content { margin-top: 10px; overflow-y: auto; padding: 5px 15px 5px 5px; flex-grow: 1; }
        #modal-form-content label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); font-size: .95rem; }
        #modal-form-content input[type=text], #modal-form-content input[type=url], #modal-form-content input[type=number], #modal-form-content input[type=color], #modal-form-content textarea, #modal-form-content select { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: inherit; background-color: #fdfdfd; }
        #modal-form-content input[type=color] { padding: 2px; height: 40px; }
        #modal-form-content textarea { min-height: 100px; white-space: pre-wrap; resize: vertical; }
        /* Use default primary for focus ring */
        #modal-form-content input:focus, #modal-form-content textarea:focus, #modal-form-content select:focus { border-color: var(--default-primary); outline: none; box-shadow: 0 0 0 2px rgba(94, 129, 244, 0.2); background-color: #fff; }
        #modal-form-content .input-group { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        #modal-form-content .input-group > div { flex: 1; min-width: 150px; }
        #modal-form-content fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 15px 20px; margin-bottom: 20px; }
        /* Use default primary for legend */
        #modal-form-content legend { font-weight: bold; padding: 0 8px; font-size: 1em; color: var(--default-primary); }
        /* Styling for font/text controls within modal */
        .text-style-controls { border: 1px solid #eee; padding: 15px; margin-top: 15px; border-radius: 6px; background-color: #f9f9fc; }
        .text-style-controls label { font-size: 0.9rem; margin-right: 8px; display: inline-block; min-width: 80px; }
        .text-style-controls select, .text-style-controls input[type=color], .text-style-controls input[type=text] { display: inline-block; width: auto; margin-right: 15px; margin-bottom: 10px; padding: 6px 8px; font-size: 0.9rem; }
        .text-style-controls input[type=color] { height: 30px; width: 50px; vertical-align: middle;}
        .text-style-controls br { display: block; margin-bottom: 5px; content: "";}
        .text-style-controls .custom-size-input { display: none; width: 120px; margin-left: 5px; }
        .text-style-controls .custom-size-input.visible { display: inline-block; }
        .project-text-style-options { /* Alias for project-wide text controls */ }

        /* Project Editor Specific Modal Forms */
        #project-view #edit-modal .quiz-edit-question { border: 1px solid #eee; padding: 15px; border-radius: 6px; margin-bottom: 15px; background: #fdfdfd; position: relative; }
        #project-view #edit-modal .quiz-edit-question h4 { margin: 0 0 15px 0; font-size: 1.1rem; color: var(--dark); }
        #project-view #edit-modal .quiz-edit-question h4 .remove-btn { position: absolute; top: 10px; right: 10px; }
        #project-view #edit-modal .quiz-edit-question label { margin-top: 10px; font-weight: 500; font-size: 0.9rem;}
        #project-view #edit-modal .quiz-edit-question input[type=text], #project-view #edit-modal .quiz-edit-question input[type=url], #project-view #edit-modal .quiz-edit-question textarea { margin-bottom: 10px; font-size: 0.95rem; }
        #project-view #edit-modal .quiz-edit-question .quiz-image-input { margin-top: -5px; margin-bottom: 15px; }
        #project-view #edit-modal .quiz-edit-question .quiz-image-input label { font-size: 0.85rem; color: #555;}
        #project-view #edit-modal .quiz-edit-question .quiz-image-input input { padding: 6px 8px; font-size: 0.9rem;}
        #project-view #edit-modal .quiz-edit-question .quiz-q-incorrect { background-color: #fff7f7; border-color: #f5c6cb; }
        #modal-form-content #quiz-editor-add-question-btn { margin-top: 10px; display: block; width: fit-content; font-size: 0.9rem; }
        #project-view #edit-modal #challenges-editor-list { max-height: 400px; overflow-y: auto; padding: 5px; margin-bottom: 15px;}
        #project-view #edit-modal .challenge-edit-item { border: 1px solid #ddd; padding: 15px; border-radius: 6px; margin-bottom: 10px; background-color: #f9f9f9; position: relative;}
        #project-view #edit-modal .challenge-edit-item h5 { margin: 0 0 10px 0; font-size: 1rem; color: var(--dark); }
        #project-view #edit-modal .challenge-edit-item label { font-size: 0.9rem; }
        #project-view #edit-modal .challenge-edit-item input[type=text], #project-view #edit-modal .challenge-edit-item input[type=url], #project-view #edit-modal .challenge-edit-item textarea { font-size: 0.95rem; }
        #project-view #edit-modal .challenge-edit-item .remove-btn { position: absolute; top: 10px; right: 10px; }
        /* CHANGED: Challenge image layout controls in modal */
        #project-view #edit-modal .challenge-edit-item .challenge-image-layout-controls {
            display: flex; gap: 15px; flex-wrap: wrap; margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;
        }
        #project-view #edit-modal .challenge-edit-item .challenge-image-layout-controls > div { flex: 1; min-width: 120px; }
        #project-view #edit-modal .challenge-edit-item .challenge-image-layout-controls label { font-size: 0.85rem; }
        #project-view #edit-modal .challenge-edit-item .challenge-image-layout-controls select,
        #project-view #edit-modal .challenge-edit-item .challenge-image-layout-controls input { width: 100%; font-size: 0.9rem; padding: 6px; margin-bottom: 5px; }
        #project-view #edit-modal .challenge-edit-item .custom-size-input { display: none; }
        #project-view #edit-modal .challenge-edit-item .custom-size-input.visible { display: block; }

        #modal-form-content #challenges-editor-add-btn { margin-top: 0; display: block; width: fit-content; font-size: 0.9rem; }
        #project-view #edit-modal .color-picker { display: flex; gap: 15px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        #project-view #edit-modal .color-picker label { margin-bottom: 0; margin-right: 5px; }
        /* Alignment/Size controls in Modal for generic elements */
        #modal-form-content .layout-controls { display: flex; gap: 20px; margin-top: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        #modal-form-content .layout-controls > div { flex: 1; min-width: 150px; }
        #modal-form-content .layout-controls label { margin-bottom: 3px; font-size: 0.9rem; }
        #modal-form-content .layout-controls select { width: 100%; padding: 8px; }
        #modal-form-content .layout-controls .custom-size-input { display: none; } /* For image custom w/h */
        #modal-form-content .layout-controls .custom-size-input.visible { display: block; }


        .modal-actions { margin-top: 20px; text-align: right; border-top: 1px solid #eee; padding-top: 20px; flex-shrink: 0; }
        .modal-actions button { margin-left: 10px; padding: 10px 20px; }
        .modal-actions button.cancel-btn { background-color: #aaa; color: white; border: none; }
        .modal-actions button.cancel-btn:hover { background-color: #888; }
        .modal-actions button.save-btn { background-color: var(--success); color: white; font-weight: bold; border: none;}
        .modal-actions button.save-btn:hover { background-color: #63c899; }


        /* --- STUDENT MODE STYLES --- */
        /* General element hiding */
        .student-mode .edit-btn,
        .student-mode .remove-btn,
        .student-mode .action-btn[data-action^="edit-"],
        .student-mode .action-btn[data-action^="remove-"],
        .student-mode .action-btn[data-action^="add-"],
        .student-mode .element-actions,
        .student-mode .item-inline-actions,
        .student-mode .sidebar-actions,
        .student-mode .tab-controls,
        .student-mode .sub-tab-controls,
        .student-mode .element-controls,
        .student-mode .add-item-card,
        .student-mode .add-item-row {
            display: none !important;
        }

        /* Specific element hiding in student mode */
        /* REMOVED: #dashboard-view.student-mode #toggle-dashboard-view-mode-btn */
        #dashboard-view.student-mode .add-item-card,
        #dashboard-view.student-mode .add-item-row,
        #dashboard-view.student-mode .item-inline-actions { display: none !important; }

        #course-view.student-mode #edit-course-styles-btn { display: none !important; }

        #project-view.student-mode #edit-project-styles-btn { display: none !important; }

        /* Keep sidebar toggle and progress bar visible in student mode */
        /* (Commented section remains commented as requested previously) */
        /*
        #project-view.student-mode #toggle-sidebar-btn,
        #project-view.student-mode #project-progress-container {
            display: none !important;
        }
        */
        #project-view.student-mode .sidebar-actions { display: none !important; } /* Keep sidebar actions hidden */

        /* ----- ADDED RULES TO KEEP VIEW TOGGLES VISIBLE ----- */
        #dashboard-view.student-mode #toggle-dashboard-view-mode-btn,
        #course-view.student-mode #toggle-view-mode-btn,
        #project-view.student-mode #toggle-project-view-mode-btn {
            display: inline-flex !important; /* Use inline-flex as it's an icon button */
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important; /* Ensure it remains clickable */
        }
        /* ----- END ADDED RULES ----- */


        /* Remove borders and hover effects in student mode */
        .student-mode .content-element {
            border: 1px solid transparent !important; /* Ensure no border */
        }
        .student-mode .content-element:hover {
            border-color: transparent !important;
            background-color: transparent !important;
            cursor: default !important;
        }
        .student-mode .content-element:hover .element-actions { display: none !important; }

        /* Ensure sidebar tabs are clickable */
        #project-view.student-mode #project-tabs .tab,
        #project-view.student-mode #project-tabs .sub-tab {
            cursor: pointer !important; pointer-events: auto !important;
        }
        #project-view.student-mode #project-tabs .tab:not(.active):hover,
        #project-view.student-mode #project-tabs .sub-tab:not(.active):hover {
             background-color: #f0f5ff !important; border-color: #c4cde0 !important;
        }
        /* Quiz interaction in student mode */
        #project-view.student-mode .quiz-question:not(.answered) .quiz-option { cursor: pointer !important; pointer-events: auto !important; }
        #project-view.student-mode .quiz-question.answered .quiz-option { cursor: default !important; pointer-events: none !important; opacity: 0.7 !important; }
        #project-view.student-mode .quiz-question.answered .quiz-option.selected,
        #project-view.student-mode .quiz-question.answered .quiz-option.correct { opacity: 1 !important; }
        #project-view.student-mode .quiz-question.answered .quiz-submit-btn { display: none !important; }
        /* Mark complete button is always active in student mode until completed */
        #project-view.student-mode .element-markcomplete button.completed {
             cursor: default !important;
             pointer-events: none !important; /* Disable clicking after completion */
             opacity: 0.8; /* Slightly fade */
        }

        /* Responsive Styles */
        @media (max-width: 900px) {
            #project-view .project-layout { flex-direction: column; }
            #project-view #project-sidebar { width: 100% !important; /* Override inline style for width */ margin-bottom: 20px; height: auto; opacity: 1 !important; pointer-events: auto !important; padding: 15px !important; margin-right: 0 !important; } /* Ensure sidebar is always visible on mobile */
            #project-view.sidebar-minimized #project-sidebar { /* Disable minimizing on mobile */ width: 100% !important; margin-bottom: 20px; height: auto; opacity: 1 !important; pointer-events: auto !important; padding: 15px !important; margin-right: 0 !important; }
            #toggle-sidebar-btn, #project-progress-container { /* Keep visible unless hidden by student mode css */ }
            .project-header-extension { /* Ensure visibility follows general rules */ }
            #project-view #project-tabs { display: flex; overflow-x: auto; padding-bottom: 10px; white-space: nowrap; border-bottom: 1px solid #eee;}
            #project-view #project-tabs p { text-align: left !important; }
            #project-view .tab, #project-view .sub-tab { flex-shrink: 0; margin-right: 8px; margin-bottom: 0; }
            #project-view .tab-controls, #project-view .sub-tab-controls { display: none !important; }
            #project-view .tab-name, #project-view .sub-tab-name { margin-right: 0; }
            #project-view .sub-tab { margin-left: 5px; }
            #course-view .course-main-content { padding: 15px; }
        }
        @media (max-width: 768px) {
            .page-header { flex-direction: column; align-items: stretch; gap: 10px; padding: 15px; text-align: center;}
            .page-header .header-content { gap: 15px; justify-content: center;}
            .page-header .header-actions { justify-content: center; flex-wrap: wrap; }
            .view-header { flex-direction: column; align-items: stretch; text-align: center; gap: 5px; }
            .view-header h1 { text-align: center;}
        }
        @media (max-width: 600px) {
             :root { /* CHANGED: --global-font-size removed, using --default-font-size */ --default-font-size: 15px; --header-image-size: 80px; --challenge-icon-size: 30px;}
             .container { padding: 10px; }
             h1 { font-size: 1.6rem; }
             h2 { font-size: 1.4rem; }
             .item-list.grid-view { grid-template-columns: 1fr; }
             .item-card, .add-item-card { min-height: 250px; }
             .item-row { flex-direction: column; align-items: stretch; text-align: center;}
             .item-row .item-image { width: 100%; height: 120px; margin-bottom: 10px; align-self: center; }
             .item-row .item-content { align-items: center; }
             .item-row .item-inline-actions { justify-content: center;}
             .add-item-row { min-height: 100px; }

             #course-view .course-main-content { padding: 10px; }
             .element-controls { text-align: center; }
             .element-controls button { font-size: 0.85rem; padding: 6px 10px; margin: 5px;}
             .content-element { padding: 15px; }
             .content-element.width-small { max-width: 90%; } /* Adjust widths for mobile */
             .content-element.width-medium { max-width: 100%; }
             #project-view #project-main-content { padding: 15px; }
             #project-view .quiz-question-content {flex-direction: column;}
             #project-view .quiz-question-image { max-width: 150px; max-height: 100px; margin-bottom: 5px; margin-left: 0; margin-right: 0;} /* Align left */
             #project-view .quiz-option { flex-direction: column; align-items: flex-start;}
             #project-view .quiz-option-image { max-width: 120px; max-height: 80px; margin-bottom: 5px;}
             #project-view .challenge-item { flex-direction: column; /* Stack on mobile */ gap: 10px; }
             #project-view .challenge-image-wrapper { margin-left: 0; margin-top: 10px; /* Adjust spacing */ width: 100%; /* Take full width */ text-align: center; /* Center image by default on mobile */ }
             #project-view .challenge-image { margin-left: auto; margin-right: auto; /* Center within wrapper */ }
             #project-view .challenge-content h4 { font-size: 1rem; }
             .modal-content { padding: 20px; margin: 10px; width: calc(100% - 20px); max-height: calc(100vh - 20px); }
             .modal-actions { display: flex; justify-content: space-between;}
             .modal-actions button { flex-grow: 1; margin: 0 5px; padding: 10px 15px; font-size: 0.9rem;}
        }

    </style>
</head>
<body>

    <div class="container">

        <!-- View: Dashboard (Courses List) -->
        <div id="dashboard-view" class="view">
            <div class="view-header">
                <h1>My Courses</h1>
                <div class="view-controls">
                    <span class="view-toggle">
                        <button id="dashboard-grid-view-btn" title="Grid View">
                            <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm0 10h8v8H3zm10-10h8v8h-8zm0 10h8v8h-8z"></path></svg>
                        </button>
                        <button id="dashboard-list-view-btn" title="List View">
                            <svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zm0 6h18v2H3zm0 6h18v2H3z"></path></svg>
                        </button>
                    </span>
                    <!-- CHANGED: Added Student/Editor View Toggle Button -->
                    <button id="toggle-dashboard-view-mode-btn" class="icon-btn" title="Switch to Student View">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18" class="icon-student-view">
                           <title>Student View</title> <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                        </svg>
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18" class="icon-editor-view" style="display: none;">
                            <title>Editor View</title> <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                            <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/> <!-- Simple line through -->
                        </svg>
                    </button>
                </div>
            </div>
            <div id="course-list" class="item-list grid-view">
                <!-- Course cards/rows will be rendered here by JS -->
                <!-- ADD COURSE card/row will be rendered here by JS (conditionally) -->
            </div>
        </div>

        <!-- View: Course (Intro Content + Projects List) -->
        <div id="course-view" class="view">
             <header class="page-header course-content-header">
                 <div class="header-content">
                     <img id="courseHeaderImage" class="header-image" src="" alt="Course Header Image" data-error="false">
                     <div class="header-title-container">
                         <h2 class="header-title" id="course-content-main-title">Course Name</h2>
                     </div>
                 </div>
                 <div class="header-actions">
                    <button id="edit-course-styles-btn" class="icon-btn" title="Edit Course Info & Styles">ðŸŽ¨</button> <!-- Use icon-btn class -->
                    <!-- CHANGED: Use icon-btn class and SVG for eye icon -->
                    <button id="toggle-view-mode-btn" class="icon-btn" title="Switch to Student View">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="icon-student-view">
                           <title>Student View</title> <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                         </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="icon-editor-view" style="display: none;">
                             <title>Editor View</title> <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                             <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
                         </svg>
                    </button>
                    <button id="back-to-dashboard-btn" class="back-btn" title="Back to Courses">&larr; Back</button>
                 </div>
             </header>

             <div id="course-content-area" class="course-main-content">
                 <!-- Content rendered here by JS -->
             </div>

             <div id="course-element-add-controls" class="element-controls">
                 <p>Add to this course description:</p>
                 <button data-action="add-course-element" data-type="heading">Heading</button>
                 <button data-action="add-course-element" data-type="text">Text Block</button>
                 <button data-action="add-course-element" data-type="image">Image/GIF</button>
                 <button data-action="add-course-element" data-type="video">Video</button>
                 <button data-action="add-course-element" data-type="presentation">Presentation</button>
                 <!-- Mark Complete not applicable to course intro -->
             </div>

             <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">

             <div class="view-header">
                 <h1 id="course-view-title" style="border: none; font-size: 1.8rem;">Projects</h1>
                 <div class="view-controls">
                     <span class="view-toggle">
                         <button id="course-grid-view-btn" title="Grid View">
                             <svg viewBox="0 0 24 24"><path d="M3 3h8v8H3zm0 10h8v8H3zm10-10h8v8h-8zm0 10h8v8h-8z"></path></svg>
                         </button>
                         <button id="course-list-view-btn" title="List View">
                             <svg viewBox="0 0 24 24"><path d="M3 5h18v2H3zm0 6h18v2H3zm0 6h18v2H3z"></path></svg>
                         </button>
                     </span>
                 </div>
             </div>

             <div id="project-list" class="item-list grid-view">
                <!-- Project cards/rows for the selected course will be rendered here -->
                 <!-- ADD PROJECT card/row will be rendered here by JS (conditionally) -->
            </div>
        </div>

        <!-- View: Project Editor -->
        <div id="project-view" class="view">
             <header class="page-header">
                <div class="header-content">
                    <img id="projectHeaderImage" class="header-image" src="" alt="Project Header Image" data-error="false">
                    <div class="header-title-container">
                        <h2 class="header-title" id="projectTitle">Project Title</h2>
                        <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
                    </div>
                </div>
                 <div class="header-actions">
                    <button id="edit-project-styles-btn" class="icon-btn" title="Edit Project Info & Styles">âš™ï¸</button> <!-- Use icon-btn class -->
                    <!-- CHANGED: Use icon-btn class and SVG for eye icon -->
                    <button id="toggle-project-view-mode-btn" class="icon-btn" title="Switch to Student View">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="icon-student-view">
                            <title>Student View</title><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                         </svg>
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20" class="icon-editor-view" style="display: none;">
                              <title>Editor View</title><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                              <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2"/>
                          </svg>
                    </button>
                    <button id="back-to-projects-btn" class="back-btn" title="Back to Course">&larr; Back</button>
                 </div>
            </header>

            <!-- NEW: Project Header Extension -->
            <div class="project-header-extension">
                 <button id="toggle-sidebar-btn" title="Toggle Sidebar">
                    <span class="icon-minimize">â†</span> <!-- Left arrow for minimize -->
                    <span class="icon-maximize">â†’</span> <!-- Right arrow for maximize -->
                 </button>
                 <div id="project-progress-container" title="Project Progress">
                     <div id="project-progress-fill">0%</div>
                 </div>
             </div>

            <div class="project-layout">
                <aside id="project-sidebar">
                    <nav id="project-tabs"></nav>
                    <div class="sidebar-actions">
                        <button id="add-tab-btn" class="add-btn">+ Add Tab</button>
                    </div>
                </aside>
                <main id="project-main-content">
                    <div id="tab-content-area"></div>
                    <div id="element-add-controls" class="element-controls" style="display: none;">
                        <p>Add to this section:</p>
                        <button data-type="heading">Heading</button>
                        <button data-type="text">Text Block</button>
                        <button data-type="image">Image/GIF</button>
                        <button data-type="video">Video</button>
                        <button data-type="presentation">Presentation</button>
                        <button data-type="challenges">Challenges Section</button>
                        <button data-type="quiz">Quiz Section</button>
                        <button data-type="markcomplete">Mark Complete Button</button>
                    </div>
                </main>
            </div>
        </div>

    </div> <!-- End .container -->

    <!-- Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal" title="Close">&times;</span>
            <h3 id="modal-title">Edit</h3>
            <div id="modal-form-content">
                <!-- Form content generated by JS -->
            </div>
            <div class="modal-actions">
                <button type="button" id="cancel-modal-btn" class="cancel-btn">Cancel</button>
                <button type="button" id="save-modal-btn" class="save-btn">Save Changes</button>
            </div>
        </div>
    </div>

<script>
// --- Constants ---
const APP_DATA_KEY = 'courseAppData_v1.8'; // Version bump (Element Style Changes)
const PROJECT_DATA_PREFIX = 'projectData_';
const MAX_COURSES = 25;
const MAX_PROJECTS_PER_COURSE = 25;
const VIEW_PREFERENCE_KEY = 'itemViewPreference';

// --- Project Editor Specific Constants ---
const FONT_FAMILIES = [ { name: 'Default (Segoe UI)', value: "'Segoe UI', sans-serif" }, { name: 'Arial', value: "Arial, Helvetica, sans-serif" }, { name: 'Georgia', value: "Georgia, 'Times New Roman', serif" }, { name: 'Verdana', value: "Verdana, Geneva, sans-serif" }, { name: 'Courier New', value: "'Courier New', monospace" }, { name: 'Comic Sans MS', value: "'Comic Sans MS', cursive, sans-serif" } ];
const FONT_SIZES = ['small', 'medium', 'large', 'xlarge', 'custom']; // For preset dropdowns
const DEFAULT_FONT_SIZE_NAME = 'medium'; // Default preset name
const DEFAULT_FONT_SIZE_CSS = '16px'; // Default CSS value if not specified
const DEFAULT_FONT_FAMILY = "'Segoe UI', sans-serif";
const DEFAULT_TEXT_COLOR = '#1A1D28';
const DEFAULT_PRIMARY_COLOR = '#5E81F4';
const DEFAULT_SECONDARY_COLOR = '#FF7AC6';
const DEFAULT_ACCENT_COLOR = '#FFB800';
const MAX_CHALLENGES = 25;
const IMAGE_FALLBACK_SRC = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Crect width='80' height='80' fill='%23cccccc'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='%23666666' font-size='12' font-family='sans-serif'%3EError%3C/text%3E%3C/svg%3E";
const DEFAULT_COURSE_IMAGE = 'https://via.placeholder.com/300x150/eee/ccc?text=Course';
const DEFAULT_PROJECT_IMAGE = 'https://via.placeholder.com/300x150/eee/ccc?text=Project';
const DEFAULT_HEADER_IMAGE = 'https://via.placeholder.com/120/eee/ccc?text=H'; // Fallback for header if no specific image set
const DEFAULT_COURSE_PRIMARY = '#5E81F4';
const DEFAULT_COURSE_SECONDARY = '#FF7AC6';
const DEFAULT_COURSE_ACCENT = '#FFB800';
const DEFAULT_COURSE_BG = '#ffffff';
const DEFAULT_COURSE_TEXT = '#1A1D28';
const DEFAULT_ALIGNMENT = 'center';
const DEFAULT_SIZE = 'medium'; // Default size for media elements
const DEFAULT_TEXT_ALIGN = 'left'; // Default text alignment within elements


// --- Utility Functions ---
function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
function generateId(prefix = 'id_') { return prefix + Date.now() + '_' + Math.random().toString(36).substring(2, 9); }
function getEmbedUrlWithOptions(url) { // Stricter autoplay=0
    if (!url || typeof url !== 'string') return 'about:blank';
    try {
        if (!url.startsWith('http:') && !url.startsWith('https:') && !url.startsWith('//')) {
            if (url !== 'about:blank') { console.warn(`Invalid URL format for embedding: ${url}`); return 'about:blank'; }
            else { return url; }
        }
        let pUrl = new URL(url);
        let params = pUrl.searchParams;

        // Force autoplay=0 for known players
        if (pUrl.hostname.includes('youtube.com') || pUrl.hostname.includes('youtu.be')) {
            params.set('autoplay', '0');
            params.delete('mute');
            params.set('controls', '1');
            params.set('playsinline', '1');
        } else if (pUrl.hostname.includes('vimeo.com')) {
            params.set('autoplay', '0');
            params.set('dnt', '1');
            params.delete('muted');
        } else { // Generic attempt - set autoplay to 0 if not present
            if (!params.has('autoplay')) {
                params.set('autoplay', '0');
            }
            params.delete('mute');
            params.delete('muted');
        }
        // Reconstruct URL ensuring autoplay=0 is first if possible (sometimes helps)
        let finalUrl = pUrl.origin + pUrl.pathname;
        let searchString = '';
        if(params.has('autoplay')) { // Ensure autoplay=0 is prominent
             searchString += 'autoplay=0';
             params.delete('autoplay');
        }
        params.forEach((value, key) => {
            searchString += (searchString ? '&' : '') + `${key}=${encodeURIComponent(value)}`;
        });
        if(searchString) finalUrl += '?' + searchString;

        console.log("Generated Embed URL:", finalUrl);
        return finalUrl;
    } catch (e) {
        console.error(`Error processing embed URL "${url}":`, e);
        return 'about:blank';
    }
}
function handleImageError(imgElement) { if (imgElement && imgElement.src !== IMAGE_FALLBACK_SRC && !imgElement.dataset.errorFallbackApplied) { console.warn(`Image failed to load: ${imgElement.currentSrc || imgElement.src}. Applying fallback.`); imgElement.src = IMAGE_FALLBACK_SRC; imgElement.dataset.error = "true"; imgElement.dataset.errorFallbackApplied = "true"; } }
function hexToRgb(hex) { if (!hex) return null; let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : null; }
function getModalValue(selector, defaultValue = '', trimValue = true) { const inputElement = modalFormContent?.querySelector(selector); if (!inputElement) { return defaultValue; } const value = inputElement.value; return trimValue ? value.trim() : value; }
function getDefaultElementData(type) { // Added default text styles, alignment, size
    switch (type) {
        case 'heading': return { text: 'New Heading', textColor: null, fontFamily: null, fontSize: null, textAlign: DEFAULT_TEXT_ALIGN }; // Null means inherit project/course/body style
        case 'text': return { text: 'New text block...', textColor: null, fontFamily: null, fontSize: null, textAlign: DEFAULT_TEXT_ALIGN };
        case 'image': return { url: '', alt: '', width: 'auto', height: 'auto', heading: '', description: '', alignment: DEFAULT_ALIGNMENT, size: DEFAULT_SIZE };
        case 'video': return { url: '', heading: '', description: '', alignment: DEFAULT_ALIGNMENT, size: DEFAULT_SIZE };
        case 'presentation': return { url: '', heading: '', description: '', alignment: DEFAULT_ALIGNMENT, size: DEFAULT_SIZE };
        case 'challenges': return { heading: 'Challenges', description: '', challenges: [] }; // Individual challenges have image layout data
        case 'quiz': return { questions: [] };
        case 'markcomplete': return { text: 'Mark as Complete', completedText: 'Completed', alignment: DEFAULT_ALIGNMENT }; // Added alignment
        default: console.warn(`getDefaultElementData called for unknown type: ${type}`); return {};
    }
}
// Helper to get CSS value for font size (preset or custom)
function getCssFontSize(sizeNameOrValue) {
    const sizeMap = { small: '14px', medium: '16px', large: '18px', xlarge: '20px' };
    return sizeMap[sizeNameOrValue] || sizeNameOrValue || null; // Return mapped value, custom value, or null
}


// --- Application State ---
let appData = { courses: [] }; // Removed globalStyles
let currentProjectData = null;
let currentView = 'dashboard';
let activeCourseId = null;
let activeProjectId = null;
let editingContext = { type: null, id: null, parentId: null, isNew: false, elementType: null };
let currentItemViewMode = localStorage.getItem(VIEW_PREFERENCE_KEY) || 'grid';

// --- DOM Element Lookups ---
const dashboardView = document.getElementById('dashboard-view');
const courseView = document.getElementById('course-view');
const projectView = document.getElementById('project-view');
const courseListContainer = document.getElementById('course-list');
const projectListContainer = document.getElementById('project-list');
const courseViewTitle = document.getElementById('course-view-title');
const courseContentMainTitle = document.getElementById('course-content-main-title');
const courseHeaderImage = document.getElementById('courseHeaderImage');
const courseContentArea = document.getElementById('course-content-area');
const courseElementAddControls = document.getElementById('course-element-add-controls');
const backToDashboardButton = document.getElementById('back-to-dashboard-btn');
const backToProjectsButton = document.getElementById('back-to-projects-btn');
const dashboardGridViewBtn = document.getElementById('dashboard-grid-view-btn');
const dashboardListViewBtn = document.getElementById('dashboard-list-view-btn');
const courseGridViewBtn = document.getElementById('course-grid-view-btn');
const courseListViewBtn = document.getElementById('course-list-view-btn');
const editCourseStylesBtn = document.getElementById('edit-course-styles-btn');
const toggleViewModeBtn = document.getElementById('toggle-view-mode-btn'); // Course View Toggle
const toggleDashboardViewModeBtn = document.getElementById('toggle-dashboard-view-mode-btn'); // Dashboard View Toggle
const toggleProjectViewModeBtn = document.getElementById('toggle-project-view-mode-btn'); // Project View Toggle
const modal = document.getElementById('edit-modal');
const modalTitle = document.getElementById('modal-title');
const modalFormContent = document.getElementById('modal-form-content');
const closeModalButton = document.getElementById('close-modal-btn');
const cancelModalButton = document.getElementById('cancel-modal-btn');
const saveModalButton = document.getElementById('save-modal-btn');
let projectEditorElements = {}; // Populated in initProjectEditor


// --- Data Management ---
function loadAppData() { // Simplified: No global styles
    const storedData = localStorage.getItem(APP_DATA_KEY);
    if (storedData) {
        try {
            const parsed = JSON.parse(storedData);
            let coursesArray = [];
            if (Array.isArray(parsed)) {
                 console.warn("Old data format detected (Array). Migrating."); coursesArray = parsed;
            } else if (parsed && Array.isArray(parsed.courses)) {
                 coursesArray = parsed.courses;
            } else { throw new Error("Stored data is not a valid courses array or object."); }
            appData = { courses: coursesArray || [] };

             appData.courses.forEach(course => {
                 course.imageUrl = course.imageUrl || null;
                 course.headerImage = course.headerImage || course.imageUrl || null; // Add header image field
                 course.content = Array.isArray(course.content) ? course.content : [];
                 course.styles = course.styles || {};
                 course.styles.primaryColor = course.styles.primaryColor || DEFAULT_COURSE_PRIMARY;
                 course.styles.secondaryColor = course.styles.secondaryColor || DEFAULT_COURSE_SECONDARY;
                 course.styles.accentColor = course.styles.accentColor || DEFAULT_COURSE_ACCENT;
                 course.styles.backgroundColor = course.styles.backgroundColor || DEFAULT_COURSE_BG;
                 course.styles.textColor = course.styles.textColor || DEFAULT_COURSE_TEXT;

                 if (!Array.isArray(course.projects)) course.projects = [];
                 course.projects.forEach(project => {
                     project.imageUrl = project.imageUrl || null; // This is the 'cover' image
                 });
                 // Ensure course elements have necessary defaults (like alignment/size)
                 course.content.forEach(el => ensureElementDefaults(el));
             });
            console.log("App data loaded."); return;
        } catch (e) { console.error("Failed to parse app data, resetting.", e); localStorage.removeItem(APP_DATA_KEY); }
    }
    appData = { courses: [] }; console.log("Initialized default app data (no courses).");
}
function saveAppData() { try { localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData)); console.log("App data saved."); } catch (e) { console.error("Failed to save app data:", e); alert("Error: Could not save application data. Storage might be full."); } }
function getProjectDataKey(projectId) { return `${PROJECT_DATA_PREFIX}${projectId}`; }
function loadSpecificProjectData(projectId) {
    const key = getProjectDataKey(projectId); const storedData = localStorage.getItem(key);
    if (storedData) {
        try {
            const parsed = JSON.parse(storedData);
             if (parsed && Array.isArray(parsed.tabs)) {
                 parsed.styles = parsed.styles || {};
                 parsed.styles.primaryColor = parsed.styles.primaryColor || DEFAULT_PRIMARY_COLOR;
                 parsed.styles.secondaryColor = parsed.styles.secondaryColor || DEFAULT_SECONDARY_COLOR;
                 parsed.styles.accentColor = parsed.styles.accentColor || DEFAULT_ACCENT_COLOR;
                 parsed.styles.globalTextColor = parsed.styles.globalTextColor || DEFAULT_TEXT_COLOR;
                 parsed.styles.globalFontSize = parsed.styles.globalFontSize || DEFAULT_FONT_SIZE_NAME;
                 parsed.styles.globalFontFamily = parsed.styles.globalFontFamily || DEFAULT_FONT_FAMILY;

                 // CHANGED: Prioritize projectMeta.imageUrl later if needed, load headerImage from project data first
                 parsed.headerImage = parsed.headerImage || DEFAULT_HEADER_IMAGE;
                 const projectMeta = findProjectMeta(projectId); // Still needed for title/subtitle fallback
                 parsed.title = parsed.title || projectMeta?.name || "Untitled Project";
                 parsed.subtitle = parsed.subtitle || projectMeta?.description || "";

                 // Ensure tabs/subtabs have isComplete flag and elements have defaults
                  parsed.tabs.forEach(tab => {
                      tab.isComplete = tab.isComplete || false;
                      if(Array.isArray(tab.content)) tab.content.forEach(el => ensureElementDefaults(el));
                      if(Array.isArray(tab.subTabs)) {
                          tab.subTabs.forEach(subTab => {
                              subTab.isComplete = subTab.isComplete || false;
                              if(Array.isArray(subTab.content)) subTab.content.forEach(el => ensureElementDefaults(el));
                          });
                      } else { tab.subTabs = null; } // Ensure it's null if not an array
                  });

                 console.log(`Project data loaded for ${projectId}`);
                 return parsed;
             }
        } catch (e) { console.error(`Failed to parse project data for ${projectId}, returning default.`, e); }
    }
    console.log(`No valid data found for project ${projectId}, creating default.`);
    const projectMeta = findProjectMeta(projectId);
    const defaultData = getDefaultProjectDataTemplate();
    defaultData.title = projectMeta?.name || "New Project";
    defaultData.subtitle = projectMeta?.description || "";
    defaultData.headerImage = projectMeta?.imageUrl || DEFAULT_HEADER_IMAGE; // Use cover image as header default
    // Set explicit style defaults
    defaultData.styles.primaryColor = DEFAULT_PRIMARY_COLOR;
    defaultData.styles.secondaryColor = DEFAULT_SECONDARY_COLOR;
    defaultData.styles.accentColor = DEFAULT_ACCENT_COLOR;
    defaultData.styles.globalTextColor = DEFAULT_TEXT_COLOR;
    defaultData.styles.globalFontSize = DEFAULT_FONT_SIZE_NAME;
    defaultData.styles.globalFontFamily = DEFAULT_FONT_FAMILY;
    return defaultData;
 }
function saveSpecificProjectData(projectId, projectDataToSave) {
    if (!projectId || !projectDataToSave) { console.error("Cannot save project data: Project ID or data missing."); return; } const key = getProjectDataKey(projectId);
    try {
        const projectMeta = findProjectMeta(projectId);
        if (projectMeta) {
            let metaChanged = false;
            if (projectMeta.name !== projectDataToSave.title) { projectMeta.name = projectDataToSave.title; metaChanged = true; }
            if (projectMeta.description !== projectDataToSave.subtitle) { projectMeta.description = projectDataToSave.subtitle; metaChanged = true; }
            // CHANGED: Also update projectMeta.imageUrl if projectData.headerImage changed
             if (projectMeta.imageUrl !== projectDataToSave.headerImage) {
                projectMeta.imageUrl = projectDataToSave.headerImage; // Keep them synced for now
                metaChanged = true;
            }
            if (metaChanged) saveAppData(); // Save course list if name/desc/image changed
        }
        localStorage.setItem(key, JSON.stringify(projectDataToSave)); console.log(`Project data saved for ${projectId}`);
    } catch (e) { console.error(`Failed to save project data for ${projectId}:`, e); alert(`Error: Could not save project data for ${projectId}. Storage might be full.`); }
}
function deleteSpecificProjectData(projectId) { const key = getProjectDataKey(projectId); localStorage.removeItem(key); console.log(`Project data deleted for ${projectId}`); }
function getDefaultProjectDataTemplate() { // Add isComplete to tabs
    const firstTabId = generateId('tab_');
    return {
        title: "New Project",
        subtitle: "",
        headerImage: DEFAULT_HEADER_IMAGE, // Will be updated from meta on load if available
        styles: {
             primaryColor: DEFAULT_PRIMARY_COLOR,
             secondaryColor: DEFAULT_SECONDARY_COLOR,
             accentColor: DEFAULT_ACCENT_COLOR,
             globalFontFamily: DEFAULT_FONT_FAMILY,
             globalFontSize: DEFAULT_FONT_SIZE_NAME,
             globalTextColor: DEFAULT_TEXT_COLOR
        },
        tabs: [
            {
                id: firstTabId, name: "Section 1", subTabs: null, isComplete: false,
                content: [ { id: generateId('el_'), type: 'heading', data: getDefaultElementData('heading') } ]
            }
        ]
    };
}
// Helper to ensure element data has all required fields after loading
function ensureElementDefaults(el) {
    if (!el || !el.type) return;
    if (!el.data) el.data = {};
    const defaults = getDefaultElementData(el.type);
    for (const key in defaults) {
        if (!(key in el.data)) {
            el.data[key] = defaults[key];
        }
    }
     // Special check for challenge image layout defaults
    if (el.type === 'challenges' && Array.isArray(el.data.challenges)) {
        el.data.challenges.forEach(challenge => {
            if (!challenge.imageAlignment) challenge.imageAlignment = DEFAULT_ALIGNMENT;
            if (!challenge.imageSize) challenge.imageSize = DEFAULT_SIZE;
        });
    }
}

function findCourse(courseId) { return appData.courses.find(c => c.id === courseId); }
function findProjectMeta(projectId) { for (const course of appData.courses) { const project = course.projects.find(p => p.id === projectId); if (project) return project; } return null; }
function findProjectCourse(projectId) { for (const course of appData.courses) { const project = course.projects.find(p => p.id === projectId); if (project) return course; } return null; }
function findCourseElementData(courseId, elementId) {
    const course = findCourse(courseId); if (!course || !Array.isArray(course.content)) return null; const index = course.content.findIndex(el => el?.id === elementId); if (index !== -1) { return { element: course.content[index], parentArray: course.content, index: index }; } return null;
}

// --- View Management ---
function showView(viewName, courseId = null, projectId = null) {
    console.log(`Showing view: ${viewName}`, `Course: ${courseId}`, `Project: ${projectId}`);
    if (currentView === 'project' && viewName !== 'project' && projectView) {
        projectView.style.cssText = ''; // Clear inline styles
        projectView.classList.remove('sidebar-minimized'); // Ensure sidebar isn't stuck minimized
        console.log("Reset project-specific styles & sidebar state.");
    }

    document.querySelectorAll('.view').forEach(v => {
        v.classList.remove('active');
        v.classList.remove('student-mode'); // Reset student mode when changing views
    });
    activeCourseId = null; activeProjectId = null; currentProjectData = null;
    teardownEventListeners_Editor();

    // Reset all view mode buttons
    updateViewModeButton(toggleDashboardViewModeBtn, false);
    updateViewModeButton(toggleViewModeBtn, false);
    updateViewModeButton(toggleProjectViewModeBtn, false);

    let targetViewElement; let hash = '#';
    switch (viewName) {
        case 'dashboard':
            targetViewElement = dashboardView; currentView = 'dashboard';
            renderDashboardView(); setItemViewMode(courseListContainer, currentItemViewMode, dashboardGridViewBtn, dashboardListViewBtn);
            // Restore student mode if previously set for dashboard? (Optional)
            // if(dashboardView.dataset.studentMode === 'true') toggleViewMode(dashboardView, toggleDashboardViewModeBtn);
            break;
        case 'course':
            targetViewElement = courseView; currentView = 'course'; activeCourseId = courseId;
            if (!activeCourseId || !findCourse(activeCourseId)) { // CHANGED: Check if course exists
                console.error("Course ID missing or invalid."); showView('dashboard'); return;
            }
            applyCourseSpecificStyles(activeCourseId); // Apply styles BEFORE rendering
            renderCourseView(activeCourseId); setItemViewMode(projectListContainer, currentItemViewMode, courseGridViewBtn, courseListViewBtn);
            hash = `#/course/${activeCourseId}`;
            break;
        case 'project':
            targetViewElement = projectView; currentView = 'project'; activeProjectId = projectId;
            if (!activeProjectId) { console.error("Project ID missing."); showView('dashboard'); return; }
            const parentCourse = findProjectCourse(activeProjectId); activeCourseId = parentCourse?.id;
            if (!activeCourseId) { console.error("Could not find parent course for project."); showView('dashboard'); return; } // Check if parent exists
            initProjectEditor(activeProjectId); // Loads data, applies scoped styles, renders
            hash = `#/project/${activeProjectId}`;
            break;
        default: targetViewElement = dashboardView; currentView = 'dashboard'; renderDashboardView(); setItemViewMode(courseListContainer, currentItemViewMode, dashboardGridViewBtn, dashboardListViewBtn);
    }
    if (targetViewElement) {
        targetViewElement.classList.add('active');
        window.scrollTo(0, 0);
    }
    if (window.location.hash !== hash) { history.pushState({ view: viewName, courseId: activeCourseId, projectId: activeProjectId }, '', hash); }
}

function setItemViewMode(container, mode, gridBtn, listBtn) {
    if (!container || !gridBtn || !listBtn) return; currentItemViewMode = mode; localStorage.setItem(VIEW_PREFERENCE_KEY, mode);
    container.classList.remove('grid-view', 'list-view'); container.classList.add(mode === 'list' ? 'list-view' : 'grid-view');
    gridBtn.classList.toggle('active', mode === 'grid'); listBtn.classList.toggle('active', mode === 'list');
    if (container.id === 'course-list') { renderDashboardView(); } else if (container.id === 'project-list') { renderProjectListForCourse(activeCourseId); }
}

// --- Rendering Functions ---

function renderDashboardView() {
    if (!courseListContainer) return;
    courseListContainer.innerHTML = '';
    const isListView = courseListContainer.classList.contains('list-view');
    const isStudentMode = dashboardView.classList.contains('student-mode');
    const courses = appData.courses || [];

    courses.forEach(course => {
        const itemElement = createItemElement(course, isListView ? 'list' : 'grid', 'course', isStudentMode); // Pass student mode flag
        courseListContainer.appendChild(itemElement);
    });

    // Only show Add Course button if not in student mode and limit not reached
    if (!isStudentMode && courses.length < MAX_COURSES) {
        const addCourseElement = createAddItemElement(isListView ? 'list' : 'grid', 'course');
        courseListContainer.appendChild(addCourseElement);
        document.getElementById('max-courses-msg')?.remove();
    } else if (courses.length >= MAX_COURSES && !document.getElementById('max-courses-msg')) {
        courseListContainer.insertAdjacentHTML('afterend', `<p id="max-courses-msg" style="color:var(--danger); font-size:0.9em; text-align: center; margin-top: 15px;">Maximum courses (${MAX_COURSES}) reached.</p>`);
    } else if (isStudentMode){
         document.getElementById('max-courses-msg')?.remove(); // Remove msg if student mode active
    }
}

function renderProjectListForCourse(courseId) {
    if (!projectListContainer) return;
    projectListContainer.innerHTML = '';
    const course = findCourse(courseId);
    if (!course) return;
    courseViewTitle.textContent = `Projects`;
    const projects = course.projects || [];
    const isListView = projectListContainer.classList.contains('list-view');
    const isStudentMode = courseView.classList.contains('student-mode'); // Check course view mode

    projects.forEach(project => {
        const itemElement = createItemElement(project, isListView ? 'list' : 'grid', 'project', isStudentMode); // Pass student mode
        projectListContainer.appendChild(itemElement);
    });

    // Only show Add Project button if not in student mode and limit not reached
    if (!isStudentMode && projects.length < MAX_PROJECTS_PER_COURSE) {
        const addProjectElement = createAddItemElement(isListView ? 'list' : 'grid', 'project');
        projectListContainer.appendChild(addProjectElement);
        document.getElementById('max-projects-msg')?.remove();
    } else if (projects.length >= MAX_PROJECTS_PER_COURSE && !document.getElementById('max-projects-msg')) {
        projectListContainer.insertAdjacentHTML('afterend', `<p id="max-projects-msg" style="color:var(--danger); font-size:0.9em; text-align: center; margin-top: 15px;">Maximum projects (${MAX_PROJECTS_PER_COURSE}) reached for this course.</p>`);
    } else if (isStudentMode) {
        document.getElementById('max-projects-msg')?.remove();
    }
}

// CHANGED: Added isStudentMode parameter to conditionally hide inline actions
function createItemElement(itemData, viewType, itemType, isStudentMode = false) {
    const itemElement = document.createElement('div');
    itemElement.className = `${viewType === 'list' ? 'item-row' : 'item-card'} item-container`;
    itemElement.dataset[itemType === 'course' ? 'courseId' : 'projectId'] = itemData.id;
    if (itemType === 'project') {
        itemElement.dataset.courseId = activeCourseId;
    }

    const imageUrl = itemData.imageUrl || (itemType === 'course' ? DEFAULT_COURSE_IMAGE : DEFAULT_PROJECT_IMAGE);
    const descriptionHtml = itemData.description ? `<p>${escapeHtml(itemData.description)}</p>` : '';
    const editAction = itemType === 'course' ? 'edit-course' : 'edit-project';
    const removeAction = itemType === 'course' ? 'remove-course' : 'remove-project';
    // Conditionally create actions HTML
    const inlineActionsHtml = isStudentMode ? '' : `
        <div class="item-inline-actions">
            <button class="edit-btn action-btn" data-action="${editAction}" title="Edit ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}">âœï¸</button>
            <button class="remove-btn action-btn" data-action="${removeAction}" title="Remove ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}">Ã—</button>
        </div>`;
    const headingHtml = `
        <div class="item-heading-container">
            <h4>${escapeHtml(itemData.name)}</h4>
            ${inlineActionsHtml}
        </div>`;

    // Use course/project specific styles if available for the heading color
    let itemStyle = null;
    if (itemType === 'course') {
         itemStyle = findCourse(itemData.id)?.styles;
    } else if (itemType === 'project') {
         const parentCourseStyle = findProjectCourse(itemData.id)?.styles; // Project usually inherits course style in list view
         itemStyle = parentCourseStyle; // Could also load project-specific style if needed here
    }
    const primaryColor = itemStyle?.primaryColor || DEFAULT_PRIMARY_COLOR;

    if (viewType === 'list') {
        itemElement.innerHTML = `
            <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(itemData.name)}" class="item-image" onerror="handleImageError(this)" data-error="false" data-error-fallback-applied="false">
            <div class="item-content">
                <div class="item-text-details">
                    ${headingHtml}
                    ${descriptionHtml}
                </div>
            </div>`;
    } else { // Grid View
        itemElement.innerHTML = `
            <img src="${escapeHtml(imageUrl)}" alt="${escapeHtml(itemData.name)}" class="item-image" onerror="handleImageError(this)" data-error="false" data-error-fallback-applied="false">
            <div class="item-content">
                ${headingHtml}
                ${descriptionHtml || '<p style="flex-grow: 1; visibility: hidden; margin:0; padding: 0; height: 1px;"></p>'}
                <div class="item-card-actions"></div>
            </div>`;
    }

    const h4 = itemElement.querySelector('h4');
    if(h4) h4.style.color = primaryColor; // Apply specific heading color

    const img = itemElement.querySelector('.item-image');
    if (img) { setTimeout(() => checkRenderedImageError(img), 0); }

    return itemElement;
}


function createAddItemElement(viewType, itemType) {
    const addElement = document.createElement('div');
    addElement.className = viewType === 'list' ? 'add-item-row' : 'add-item-card';
    addElement.dataset.action = itemType === 'course' ? 'add-course' : 'add-project';
    addElement.title = `Add New ${itemType.charAt(0).toUpperCase() + itemType.slice(1)}`;
    addElement.innerHTML = '+';
    addElement.style.color = DEFAULT_PRIMARY_COLOR;
    addElement.addEventListener('mouseenter', () => addElement.style.borderColor = DEFAULT_PRIMARY_COLOR);
    addElement.addEventListener('mouseleave', () => addElement.style.borderColor = '#c4cde0');
    return addElement;
}

function renderCourseView(courseId) {
    const course = findCourse(courseId);
    if (!course) { console.error(`Course not found: ${courseId}`); showView('dashboard'); return; }

    // Header uses styles applied in applyCourseSpecificStyles
    courseContentMainTitle.textContent = escapeHtml(course.name);
    if (courseHeaderImage) {
        // Use course.headerImage (added in loadAppData)
        courseHeaderImage.src = course.headerImage || DEFAULT_HEADER_IMAGE;
        courseHeaderImage.alt = `${escapeHtml(course.name)} Header Image`;
        courseHeaderImage.dataset.error = "false"; courseHeaderImage.dataset.errorFallbackApplied = "false";
        courseHeaderImage.onerror = () => handleImageError(courseHeaderImage);
        setTimeout(() => checkRenderedImageError(courseHeaderImage), 0);
    }

    courseContentArea.innerHTML = '';
    if (course.content && course.content.length > 0) {
        course.content.forEach(elementData => { renderElement(elementData, courseContentArea, 'course-element'); });
    } else if (!courseView.classList.contains('student-mode')) { // Only show placeholder in editor mode
        courseContentArea.innerHTML = '<p style="text-align: center; color: #888; padding: 20px 0; font-style: italic;">This course has no introductory content yet. Add some below!</p>';
    }

    renderProjectListForCourse(courseId);

    // Show/hide add controls based on view mode
    courseElementAddControls.style.display = courseView.classList.contains('student-mode') ? 'none' : 'block';
    updateViewModeButton(toggleViewModeBtn, courseView.classList.contains('student-mode'));
}

function checkRenderedImageError(imgElement) { if (imgElement && imgElement.complete && imgElement.naturalWidth === 0 && !imgElement.dataset.errorFallbackApplied) { handleImageError(imgElement); } else if (imgElement && !imgElement.complete) { imgElement.onload = () => { /* Loaded */ }; imgElement.onerror = () => handleImageError(imgElement); } }

// --- Generic Element Rendering ---
function renderElement(elData, container, contextType = 'project-element') {
    const wrap = document.createElement('div');
    const d = elData.data || {};
    const alignment = d.alignment || DEFAULT_ALIGNMENT; // Default block alignment
    const size = d.size || DEFAULT_SIZE; // Default size for media/layout blocks
    wrap.className = `content-element element-${elData.type} align-${alignment}`; // Apply block alignment class
    // Apply width class only if NOT heading/text/markcomplete (which use inline styles or parent alignment)
    if (!['heading', 'text', 'markcomplete'].includes(elData.type)) {
        wrap.classList.add(`width-${size}`);
    }
    wrap.dataset.elementId = elData.id;
    wrap.appendChild(createStandardActions(elData.id, elData.type, contextType));
    let innerHtml = ''; // Use innerHtml for simple elements, appendChild for complex

    try {
        let elementStyles = ''; // For inline styles on the element itself
        let content = ''; // Inner content HTML

        // Build inline styles for text/heading elements
        if (elData.type === 'heading' || elData.type === 'text') {
            if (d.textColor) elementStyles += `color: ${escapeHtml(d.textColor)};`;
            if (d.fontFamily) elementStyles += `font-family: ${escapeHtml(d.fontFamily)};`;
            if (d.fontSize) elementStyles += `font-size: ${escapeHtml(getCssFontSize(d.fontSize))};`;
            if (d.textAlign && d.textAlign !== 'inherit') elementStyles += `text-align: ${escapeHtml(d.textAlign)};`; // Allow override of wrapper align
        }

        if (['image', 'video', 'presentation', 'challenges', 'quiz'].includes(elData.type)) {
            if (d.heading) innerHtml += `<h3 class="media-heading">${escapeHtml(d.heading)}</h3>`;
            if (d.description) innerHtml += `<p class="media-description">${escapeHtml(d.description)}</p>`;
        }

        switch (elData.type) {
            case 'heading':
                content = escapeHtml(d.text || 'Heading');
                innerHtml += `<h2 class="element-heading" style="${elementStyles}">${content}</h2>`;
                break;
            case 'text':
                content = escapeHtml(d.text || 'Text block...'); // Use escapeHtml for safety, pre-wrap handles newlines
                innerHtml += `<p class="element-text" style="${elementStyles}">${content}</p>`;
                break;
            case 'image':
                 const iUrl = d.url || '', iAlt = escapeHtml(d.alt || ''), iW = escapeHtml(d.width || 'auto'), iH = escapeHtml(d.height || 'auto');
                 const imgStyle = (size === 'auto' || !size) ? `style="width:${iW};height:${iH};"` : ''; // Only apply W/H if size=auto
                 innerHtml += `<div class="element-image-wrapper"><img src="${escapeHtml(iUrl)}" alt="${iAlt}" ${imgStyle} onerror="handleImageError(this)" data-error="false" data-error-fallback-applied="false"></div>`;
                 break;
            case 'video':
            case 'presentation':
                 const eUrl = d.url || 'about:blank', fUrl = getEmbedUrlWithOptions(eUrl);
                 const eTitle = escapeHtml(elData.type === 'video' ? 'Video Content' : 'Presentation Content');
                 innerHtml += `<div class="media-wrapper-16-9"><iframe src="${escapeHtml(fUrl)}" title="${eTitle}" frameborder="0" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>`;
                 break;
            case 'quiz':
                if (contextType === 'project-element') renderQuizElement_Editor(elData, wrap); // Appends directly to wrap
                else innerHtml += `<p>[Quiz Element - Viewable in Project Editor]</p>`;
                innerHtml = null; // Signal that content was handled directly
                break;
            case 'challenges':
                if (contextType === 'project-element') renderChallengesElement_Editor(elData, wrap); // Appends directly to wrap
                else innerHtml += `<p>[Challenges Element - Viewable in Project Editor]</p>`;
                innerHtml = null; // Signal that content was handled directly
                break;
            case 'markcomplete':
                if (contextType === 'project-element') {
                    const { sectionId, sectionType } = findSectionContextForElement_Editor(elData.id);
                    const isComplete = getSectionCompletionStatus(sectionId, sectionType);
                    const btnText = escapeHtml(d.text || 'Mark as Complete');
                    const completeText = escapeHtml(d.completedText || 'Completed');
                    innerHtml += `<button data-action="toggle-complete" data-section-id="${sectionId}" data-section-type="${sectionType}" class="${isComplete ? 'completed' : ''}">
                               <span class="button-text">${isComplete ? completeText : btnText}</span>
                               <span class="complete-icon">âœ…</span>
                             </button>`;
                } else { innerHtml = ''; }
                break;
            default: innerHtml = `<p>Unknown element type: ${escapeHtml(elData.type)}</p>`;
        }

        if (innerHtml !== null) { wrap.insertAdjacentHTML('beforeend', innerHtml); }
        const img = wrap.querySelector('img'); if(img) setTimeout(() => checkRenderedImageError(img), 0);

    } catch (e) { console.error("Error rendering element:", elData, e); wrap.insertAdjacentHTML('beforeend', `<p style="color:var(--danger);">Error rendering element.</p>`); }
    container.appendChild(wrap);
}

// CHANGED: Always create actions, even for markcomplete
function createStandardActions(id, type, contextType) {
    const el = document.createElement('div'); el.className = 'element-actions';
    const editAction = contextType === 'course-element' ? 'edit-course-element' : 'edit-element';
    const removeAction = contextType === 'course-element' ? 'remove-course-element' : 'remove-element';
    el.innerHTML = `<button class="edit-btn action-btn" title="Edit" data-action="${editAction}" data-element-id="${id}">âœï¸</button><button class="remove-btn action-btn" title="Remove" data-action="${removeAction}" data-element-id="${id}">&times;</button>`;
    return el;
}


// --- Project Editor Initialization and Core Logic ---
function initProjectEditor(projectId) {
    console.log(`Initializing project editor for: ${projectId}`); currentProjectData = loadSpecificProjectData(projectId);
    if (!currentProjectData) { console.error("Failed to load project data for editor."); showView('course', activeCourseId); return; }
    projectEditorElements = {
        projectTitleElement: document.getElementById('projectTitle'),
        projectSubtitleElement: document.getElementById('projectSubtitle'),
        projectHeaderImageElement: document.getElementById('projectHeaderImage'),
        tabsContainer: projectView.querySelector('#project-tabs'),
        contentArea: projectView.querySelector('#tab-content-area'),
        addControls: projectView.querySelector('#element-add-controls'),
        addTabButton: projectView.querySelector('#add-tab-btn'),
        editStylesButton: projectView.querySelector('#edit-project-styles-btn'),
        sidebarToggleButton: projectView.querySelector('#toggle-sidebar-btn'),
        progressBarFill: projectView.querySelector('#project-progress-fill'),
        progressBarContainer: projectView.querySelector('#project-progress-container'),
        projectHeaderExtension: projectView.querySelector('.project-header-extension')
    };
    if (!projectEditorElements.tabsContainer || !projectEditorElements.contentArea || !projectEditorElements.addControls || !projectEditorElements.projectHeaderImageElement || !projectEditorElements.sidebarToggleButton || !projectEditorElements.progressBarFill) {
        console.error("Essential project editor elements not found!");
        projectView.querySelector('#project-main-content').innerHTML = '<p style="color: var(--danger); text-align: center;">Error loading project editor components.</p>';
        return;
    }
    projectEditorState.currentTabId = null; projectEditorState.currentSubTabId = null;
    applyProjectStyles_Editor(); // Apply styles first
    renderSidebar_Editor(); // Render sidebar
    initContent_Editor(); // Select first tab & render content
    setupEventListeners_Editor();
    updateProjectProgress(); // Initial progress calculation
    projectView.classList.remove('student-mode'); // Ensure editor mode
    projectView.classList.remove('sidebar-minimized'); // Ensure sidebar starts open
    updateViewModeButton(toggleProjectViewModeBtn, false);
    console.log("Project Editor Initialized.");
}
const projectEditorState = { currentTabId: null, currentSubTabId: null };

// --- Apply Project Styles (SCOPED) ---
function applyProjectStyles_Editor() { // Updated for project scope
    const projectViewElement = document.getElementById('project-view');
    if (!projectViewElement || !currentProjectData) return;

    const styles = currentProjectData.styles || {};

    const finalPrimary = styles.primaryColor || DEFAULT_PRIMARY_COLOR;
    const finalSecondary = styles.secondaryColor || DEFAULT_SECONDARY_COLOR;
    const finalAccent = styles.accentColor || DEFAULT_ACCENT_COLOR;
    const finalTextColor = styles.globalTextColor || DEFAULT_TEXT_COLOR;
    const finalFontFamily = styles.globalFontFamily || DEFAULT_FONT_FAMILY;
    const finalFontSizeName = styles.globalFontSize || DEFAULT_FONT_SIZE_NAME;

    projectViewElement.style.setProperty('--project-primary', finalPrimary);
    projectViewElement.style.setProperty('--project-secondary', finalSecondary);
    projectViewElement.style.setProperty('--project-accent', finalAccent);
    projectViewElement.style.setProperty('--project-text-color', finalTextColor);
    projectViewElement.style.setProperty('--project-font-family', finalFontFamily);

    const finalCssFontSize = getCssFontSize(finalFontSizeName) || DEFAULT_FONT_SIZE_CSS; // Use helper
    projectViewElement.style.setProperty('--project-font-size', finalCssFontSize);

    const rgb = hexToRgb(finalPrimary);
    projectViewElement.style.setProperty('--project-primary-rgb', rgb || hexToRgb(DEFAULT_PRIMARY_COLOR));

    projectEditorElements.projectTitleElement.textContent = currentProjectData.title || 'Project';
    projectEditorElements.projectSubtitleElement.textContent = currentProjectData.subtitle || '';
    const imgElement = projectEditorElements.projectHeaderImageElement;
    if (imgElement) {
         // CHANGED: Use project cover image (from metadata) primarily
         const projectMeta = findProjectMeta(activeProjectId);
         imgElement.src = projectMeta?.imageUrl || currentProjectData.headerImage || DEFAULT_PROJECT_IMAGE; // Use cover, fallback header, fallback default
         imgElement.alt = `${escapeHtml(currentProjectData.title || 'Project')} Header Image`;
         imgElement.dataset.error = "false"; imgElement.dataset.errorFallbackApplied = "false";
         imgElement.onerror = () => handleImageError(imgElement);
         setTimeout(() => checkRenderedImageError(imgElement), 0);
    } else { console.error("Project header image element not found."); }

    if (projectEditorElements.progressBarFill) {
         projectEditorElements.progressBarFill.style.backgroundColor = finalPrimary;
    }
    console.log("Project-specific styles applied to #project-view.");
}
function applyCourseSpecificStyles(courseId) {
    const courseViewElement = document.getElementById('course-view');
    const course = findCourse(courseId);
    const contentAreaEl = document.getElementById('course-content-area');

    if (!course || !courseViewElement) { // Removed check for contentAreaEl as it might not exist yet
         console.warn("Cannot apply course styles - course or view element not found.");
         // Reset to defaults on the view element if possible
         courseViewElement?.style.setProperty('--course-primary', DEFAULT_COURSE_PRIMARY);
         courseViewElement?.style.setProperty('--course-secondary', DEFAULT_COURSE_SECONDARY);
         courseViewElement?.style.setProperty('--course-accent', DEFAULT_COURSE_ACCENT);
         courseViewElement?.style.setProperty('--course-text-color', DEFAULT_COURSE_TEXT);
         if (contentAreaEl) contentAreaEl.style.backgroundColor = DEFAULT_COURSE_BG;
         return;
    }

    const styles = course.styles || {};
    const primary = styles.primaryColor || DEFAULT_COURSE_PRIMARY;
    const secondary = styles.secondaryColor || DEFAULT_COURSE_SECONDARY;
    const accent = styles.accentColor || DEFAULT_COURSE_ACCENT;
    const textColor = styles.textColor || DEFAULT_COURSE_TEXT;
    const bgColor = styles.backgroundColor || DEFAULT_COURSE_BG;

    courseViewElement.style.setProperty('--course-primary', primary);
    courseViewElement.style.setProperty('--course-secondary', secondary);
    courseViewElement.style.setProperty('--course-accent', accent);
    courseViewElement.style.setProperty('--course-text-color', textColor);
    if (contentAreaEl) contentAreaEl.style.backgroundColor = bgColor; // Apply direct bg color if element exists

    console.log(`Applied specific styles for course ${courseId}`);
}


function renderSidebar_Editor() { // Added completion class
    const { tabsContainer } = projectEditorElements; tabsContainer.innerHTML = ''; if (!currentProjectData.tabs?.length) { tabsContainer.innerHTML = '<p style="text-align:center;color:#888;font-style:italic;">No tabs.</p>'; return; } currentProjectData.tabs.forEach(t => { if (!t?.id) return; const tEl = document.createElement('div'); tEl.className = 'tab'; if(t.isComplete) tEl.classList.add('completed-section'); // Add completion class
        tEl.dataset.tabId = t.id; let isPActive = (t.id === projectEditorState.currentTabId && !projectEditorState.currentSubTabId && (!t.subTabs || t.subTabs.length === 0)); const nSpan = document.createElement('span'); nSpan.className = 'tab-name'; nSpan.textContent = t.name || '...'; nSpan.dataset.tabId = t.id; tEl.appendChild(nSpan); tEl.appendChild(createControlsDiv_Editor('tab', t.id)); tabsContainer.appendChild(tEl); if (Array.isArray(t.subTabs) && t.subTabs.length > 0) { if (t.id === projectEditorState.currentTabId && projectEditorState.currentSubTabId && t.subTabs.some(st => st?.id === projectEditorState.currentSubTabId)) { isPActive = false; } t.subTabs.forEach(st => { if (!st?.id) return; const sEl = document.createElement('div'); sEl.className = 'sub-tab'; if(st.isComplete) sEl.classList.add('completed-section'); // Add completion class
            sEl.dataset.subTabId = st.id; sEl.dataset.parentTabId = t.id; if (st.id === projectEditorState.currentSubTabId && t.id === projectEditorState.currentTabId) sEl.classList.add('active'); const sName = document.createElement('span'); sName.className = 'sub-tab-name'; sName.textContent = st.name || '...'; sName.dataset.parentTabId = t.id; sName.dataset.subTabId = st.id; sEl.appendChild(sName); sEl.appendChild(createControlsDiv_Editor('subtab', t.id, st.id)); tabsContainer.appendChild(sEl); }); } if (isPActive) tEl.classList.add('active'); });
}
function createControlsDiv_Editor(type, tId, sId = null) { const d = document.createElement('div'); d.className = type === 'tab' ? 'tab-controls' : 'sub-tab-controls'; let h = ''; if (type === 'tab') { h += `<button class="add-btn action-btn" title="Add Sub-Tab" data-action="add-subtab" data-tab-id="${tId}">+ Sub</button><button class="edit-btn action-btn" title="Edit Tab" data-action="edit-tab" data-tab-id="${tId}">âœï¸</button><button class="remove-btn action-btn" title="Remove Tab" data-action="remove-tab" data-tab-id="${tId}">&times;</button>`; } else { h += `<button class="edit-btn action-btn" title="Edit Sub-Tab" data-action="edit-subtab" data-parent-tab-id="${tId}" data-sub-tab-id="${sId}">âœï¸</button><button class="remove-btn action-btn" title="Remove Sub-Tab" data-action="remove-subtab" data-parent-tab-id="${tId}" data-sub-tab-id="${sId}">&times;</button>`; } d.innerHTML = h; return d; }
function renderContentArea_Editor() {
    const { contentArea, addControls } = projectEditorElements; contentArea.innerHTML = ''; addControls.style.display = 'none'; const contentArray = getCurrentContentArray_Editor(); if (contentArray === null) { const tabData = findTabData_Editor(projectEditorState.currentTabId); if (!projectEditorState.currentTabId) contentArea.innerHTML = '<p>Select a tab from the sidebar to view its content.</p>'; else if (tabData && Array.isArray(tabData.subTabs) && tabData.subTabs.length > 0 && !projectEditorState.currentSubTabId) contentArea.innerHTML = '<p>This tab has sub-tabs. Please select a sub-tab to view content.</p>'; else contentArea.innerHTML = '<p>Select a valid section from the sidebar.</p>'; return; }
     // Show add controls only if NOT in student mode
    if (!projectView.classList.contains('student-mode')) {
        addControls.style.display = 'block';
    }
    if (contentArray.length === 0) {
        if (!projectView.classList.contains('student-mode')) { // Show placeholder only in editor mode
             contentArea.innerHTML = '<p>This section is empty. Add elements using the controls below.</p>';
        }
    } else { contentArray.forEach(elData => { if (elData?.id && elData.type) { renderElement(elData, contentArea, 'project-element'); } }); }
}
function renderQuizElement_Editor(quizData, wrap) { const cont = document.createElement('div'); cont.className = 'quiz-container-inner'; cont.dataset.quizId = quizData.id; const qs = quizData.data?.questions || []; if (qs.length === 0) { cont.innerHTML = '<p>No questions defined for this quiz yet.</p>'; } else { qs.forEach((q, i) => { if (!q) return; const qDiv = document.createElement('div'); qDiv.className = 'quiz-question'; qDiv.dataset.questionIndex = i; const qCont = document.createElement('div'); qCont.className = 'quiz-question-content';
        // Render text first
        qCont.innerHTML = `<p class="quiz-question-text">${i + 1}. ${escapeHtml(q.questionText || '...')}</p>`;
        // Render image after text if exists
        if (q.questionImageUrl) { const img = document.createElement('img'); img.className = 'quiz-question-image'; img.src = escapeHtml(q.questionImageUrl); img.alt = `Question ${i + 1} Image`; img.onerror = () => handleImageError(img); img.dataset.error = "false"; img.dataset.errorFallbackApplied = "false"; qCont.appendChild(img); setTimeout(() => checkRenderedImageError(img), 0); }
        qDiv.appendChild(qCont); const optsDiv = document.createElement('div'); optsDiv.className = 'quiz-options'; const cAns = String(q.correctAnswer || '').trim(); const iAns = Array.isArray(q.incorrectAnswers) ? q.incorrectAnswers : []; const iImgs = Array.isArray(q.incorrectAnswersImageUrls) ? q.incorrectAnswersImageUrls : []; const iOpts = iAns.map((t, idx) => ({ text: String(t || '').trim(), img: iImgs[idx] || null })).filter(o => o.text || o.img); // Filter if neither text nor img exists
        const allOptsData = [{ text: cAns, img: q.correctAnswerImageUrl || null, isC: true }, ...iOpts.map(o => ({ ...o, isC: false }))].filter(o => o.text || o.img); // Filter final list
        if (allOptsData.length > 0) { [...allOptsData].sort(() => Math.random() - 0.5).forEach(oD => { const oEl = document.createElement('div'); oEl.className = 'quiz-option'; oEl.dataset.isCorrect = oD.isC.toString();
            // Render text first if exists
            if (oD.text) oEl.innerHTML += `<span class="quiz-option-text">${escapeHtml(oD.text)}</span>`;
            // Render image after text if exists
            if (oD.img) { const optImg = document.createElement('img'); optImg.className = 'quiz-option-image'; optImg.src = escapeHtml(oD.img); optImg.alt = 'Option Image'; optImg.onerror = () => handleImageError(optImg); optImg.dataset.error = "false"; optImg.dataset.errorFallbackApplied = "false"; oEl.appendChild(optImg); setTimeout(() => checkRenderedImageError(optImg), 0); }
             optsDiv.appendChild(oEl); });
        } else { optsDiv.innerHTML = '<p style="font-size:0.9em;color:red;">No options defined.</p>'; } qDiv.appendChild(optsDiv); qDiv.innerHTML += `<div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;">Incorrect</div>`; cont.appendChild(qDiv); }); }
        // Show submit button only if not in student mode OR quiz not answered
        const showSubmit = !projectView.classList.contains('student-mode'); // Always show in editor
         if(showSubmit || qs.every(q => !q.classList?.contains('answered'))) { // Show in student if not answered
             cont.innerHTML += `<button class="quiz-submit-btn" data-action="submit-quiz" data-quiz-id="${quizData.id}" ${qs.length === 0 ? 'disabled' : ''}>Submit Answers</button>`;
         }
        cont.innerHTML += `<div class="final-quiz-result" style="display:none;"></div>`;
         wrap.appendChild(cont);
}
function renderChallengesElement_Editor(elData, wrap) { // CHANGED: Use image wrapper with layout classes
    const chs = elData.data?.challenges || [];
    const list = document.createElement('ul'); list.className = 'challenges-list';
    if (chs.length === 0) {
        list.innerHTML = '<li><p>No challenges defined yet.</p></li>';
    } else {
        chs.forEach(c => {
            if (!c?.id || !c.heading) return;
            const item = document.createElement('li');
            item.className = 'challenge-item';
            item.dataset.challengeId = c.id;

            let itemHtml = '';
            const iconUrl = c.iconUrl || IMAGE_FALLBACK_SRC;
            itemHtml += `<img class="challenge-icon" src="${escapeHtml(iconUrl)}" alt="Challenge Icon" onerror="handleImageError(this)" data-error="false" data-error-fallback-applied="false">`;

            itemHtml += '<div class="challenge-content">';
            itemHtml += `<h4>${escapeHtml(c.heading)}</h4>`;
            if (c.description) itemHtml += `<p>${escapeHtml(c.description)}</p>`;
            itemHtml += '</div>'; // Close challenge-content

            // Image Wrapper (conditionally added)
            if (c.imageUrl) {
                const imgAlign = c.imageAlignment || DEFAULT_ALIGNMENT;
                const imgSize = c.imageSize || DEFAULT_SIZE;
                let imgStyles = '';
                let sizeClass = `size-${imgSize}`;
                if(imgSize === 'custom') {
                     if(c.imageWidth) imgStyles += `width:${escapeHtml(c.imageWidth)};`;
                     if(c.imageHeight) imgStyles += `height:${escapeHtml(c.imageHeight)};`;
                     sizeClass = 'size-custom'; // Ensure custom size class is applied
                }

                itemHtml += `<div class="challenge-image-wrapper align-${imgAlign}">`; // Add alignment class
                itemHtml += `<img class="challenge-image ${sizeClass}" src="${escapeHtml(c.imageUrl)}" alt="Challenge Image" style="${imgStyles}" onerror="handleImageError(this)" data-error="false" data-error-fallback-applied="false">`;
                itemHtml += '</div>'; // Close challenge-image-wrapper
            }

            item.innerHTML = itemHtml;
            item.querySelectorAll('img').forEach(img => setTimeout(() => checkRenderedImageError(img), 0));
            list.appendChild(item);
        });
    }
    wrap.appendChild(list);
}

function initContent_Editor() { let targetTabId = null; let targetSubTabId = null; if (currentProjectData.tabs?.length > 0 && currentProjectData.tabs[0]?.id) { targetTabId = currentProjectData.tabs[0].id; const firstTab = currentProjectData.tabs[0]; if(Array.isArray(firstTab.subTabs) && firstTab.subTabs.length > 0 && firstTab.subTabs[0]?.id) { targetSubTabId = firstTab.subTabs[0].id; } } if (targetTabId) { setActiveTab_Editor(targetTabId, targetSubTabId); } else { renderSidebar_Editor(); renderContentArea_Editor(); } }
function findTabData_Editor(tabId) { return currentProjectData?.tabs?.find(t => t?.id === tabId) || null; }
function findSubTabData_Editor(parentTabId, subTabId) { return findTabData_Editor(parentTabId)?.subTabs?.find(st => st?.id === subTabId) || null; }
function getCurrentContentArray_Editor() { const tab = findTabData_Editor(projectEditorState.currentTabId); if (!tab) return null; if (projectEditorState.currentSubTabId) { const subTab = findSubTabData_Editor(projectEditorState.currentTabId, projectEditorState.currentSubTabId); if (subTab) { if (!Array.isArray(subTab.content)) subTab.content = []; return subTab.content; } return null; } else { if (tab.subTabs === null || (Array.isArray(tab.subTabs) && tab.subTabs.length === 0)) { if (!Array.isArray(tab.content)) tab.content = []; return tab.content; } return null; } }
function findElementData_Editor(elementId) { if (!currentProjectData?.tabs || !elementId) return null; for (const t of currentProjectData.tabs) { if (!t) continue; if ((t.subTabs === null || (Array.isArray(t.subTabs) && t.subTabs.length === 0)) && Array.isArray(t.content)) { const i = t.content.findIndex(el => el?.id === elementId); if (i !== -1) return { element: t.content[i], parentArray: t.content, parentType: 'tab', parentId: t.id, index: i }; } else if (Array.isArray(t.subTabs)) { for (const s of t.subTabs) { if (!s) continue; if (!Array.isArray(s.content)) s.content = []; const i = s.content.findIndex(el => el?.id === elementId); if (i !== -1) return { element: s.content[i], parentArray: s.content, parentType: 'subtab', parentId: s.id, grandparentTabId: t.id, index: i }; } } } console.warn("Element not found in Project Editor context:", elementId); return null; }
function findSectionContextForElement_Editor(elementId) {
    const result = findElementData_Editor(elementId);
    if (!result) return { sectionId: null, sectionType: null };
    return {
        sectionId: result.parentId, // Use parentId (which is tab or subtab ID)
        sectionType: result.parentType // 'tab' or 'subtab'
    };
}
function setActiveTab_Editor(tId, sId = null) {
    const tData = findTabData_Editor(tId);
    if (!tData) {
        if (currentProjectData.tabs && currentProjectData.tabs.length > 0) {
            const firstTab = currentProjectData.tabs[0];
            const firstSubTabId = (Array.isArray(firstTab.subTabs) && firstTab.subTabs.length > 0 && firstTab.subTabs[0]?.id) ? firstTab.subTabs[0].id : null;
            setActiveTab_Editor(firstTab.id, firstSubTabId);
        } else {
            projectEditorState.currentTabId = null; projectEditorState.currentSubTabId = null;
            renderSidebar_Editor(); renderContentArea_Editor();
        }
        return;
    }

    const oldT = projectEditorState.currentTabId, oldS = projectEditorState.currentSubTabId;
    projectEditorState.currentTabId = tId;
    projectEditorState.currentSubTabId = null; // Reset subtab first

    if (Array.isArray(tData.subTabs) && tData.subTabs.length > 0) {
        if (sId && findSubTabData_Editor(tId, sId)) {
            projectEditorState.currentSubTabId = sId; // Set if valid subtab ID provided
        } else if (tData.subTabs[0]?.id) {
             projectEditorState.currentSubTabId = tData.subTabs[0].id; // Default to first subtab
        }
    }

    if (projectEditorState.currentTabId !== oldT || projectEditorState.currentSubTabId !== oldS) {
        console.log(`Editor Active Tab: T=${projectEditorState.currentTabId}, S=${projectEditorState.currentSubTabId}`);
        renderSidebar_Editor();
        renderContentArea_Editor();
    }
}
function addTabAction_Editor() { const id = generateId('tab_'); const t = { id, name: `Tab ${currentProjectData.tabs.length + 1}`, subTabs: null, isComplete: false, content: [] }; if (!Array.isArray(currentProjectData.tabs)) currentProjectData.tabs = []; currentProjectData.tabs.push(t); saveSpecificProjectData(activeProjectId, currentProjectData); setActiveTab_Editor(id); updateProjectProgress(); openEditModal('tab', id, null, true); }
function addSubTabAction_Editor(pId) { const pTab = findTabData_Editor(pId); if (!pTab) return; const id = generateId('sub_'); const st = { id, name: `Sub ${pTab.subTabs?.length ? pTab.subTabs.length + 1 : 1}`, isComplete: false, content: [] }; if (!Array.isArray(pTab.subTabs)) { if (pTab.content?.length) { if (!confirm("Adding a sub-tab will remove any direct content from this tab. Continue?")) return; } pTab.content = undefined; pTab.subTabs = []; } pTab.subTabs.push(st); saveSpecificProjectData(activeProjectId, currentProjectData); setActiveTab_Editor(pId, id); updateProjectProgress(); openEditModal('subtab', id, pId, true); }
function addElementAction_Editor(type) { if (!projectEditorState.currentTabId) { alert("Please select a tab or sub-tab section first."); return; } const arr = getCurrentContentArray_Editor(); if (arr === null) { alert(findTabData_Editor(projectEditorState.currentTabId)?.subTabs ? "Please select a sub-tab first." : "Cannot add element to this section."); return; } const id = generateId(type + '_'); openEditModal('element', id, null, true, type); }
function removeTabAction_Editor(id) { const i = currentProjectData.tabs?.findIndex(t => t?.id === id); if (i === -1) return; if (!confirm(`Are you sure you want to permanently delete the tab "${escapeHtml(currentProjectData.tabs[i].name)}"?`)) return; currentProjectData.tabs.splice(i, 1); saveSpecificProjectData(activeProjectId, currentProjectData); if (projectEditorState.currentTabId === id) { projectEditorState.currentTabId = null; projectEditorState.currentSubTabId = null; initContent_Editor(); } else renderSidebar_Editor(); updateProjectProgress(); }
function removeSubTabAction_Editor(pId, id) { const pTab = findTabData_Editor(pId); const i = pTab?.subTabs?.findIndex(st => st?.id === id); if (!pTab || i === -1) return; if (!confirm(`Are you sure you want to permanently delete the sub-tab "${escapeHtml(pTab.subTabs[i].name)}"?`)) return; pTab.subTabs.splice(i, 1); saveSpecificProjectData(activeProjectId, currentProjectData); if (projectEditorState.currentSubTabId === id && projectEditorState.currentTabId === pId) { projectEditorState.currentSubTabId = null; setActiveTab_Editor(pId); } else renderSidebar_Editor(); updateProjectProgress(); }
function removeElementAction_Editor(id) { const res = findElementData_Editor(id); if (!res) { alert("Could not find the element to remove."); return; } if (!confirm(`Are you sure you want to remove this ${res.element.type} element?`)) return; res.parentArray.splice(res.index, 1); saveSpecificProjectData(activeProjectId, currentProjectData); renderContentArea_Editor(); }
function selectQuizOption_Editor(optEl) { const qDiv = optEl.closest('.quiz-question'); if (!qDiv || qDiv.classList.contains('answered') || projectView.classList.contains('student-mode')) return; qDiv.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected')); optEl.classList.add('selected'); }
function submitQuizAction_Editor(quizId) { const qEl = projectEditorElements.contentArea?.querySelector(`.content-element[data-element-id="${quizId}"]`); const cont = qEl?.querySelector('.quiz-container-inner'); if (!cont) return; const qs = cont.querySelectorAll('.quiz-question'); let score = 0, answered = 0; const total = qs.length; let firstUnanswered = null; if (total === 0) { alert("This quiz has no questions!"); return; } qs.forEach(q => { const sel = q.querySelector('.quiz-option.selected'); q.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none'); q.classList.remove('answered'); q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('correct', 'incorrect')); if (sel) { answered++; q.classList.add('answered'); const isC = sel.dataset.isCorrect === 'true'; q.querySelectorAll('.quiz-option').forEach(o => { if (o.dataset.isCorrect === 'true') o.classList.add('correct'); if (o === sel && !isC) o.classList.add('incorrect'); }); if (isC) { score++; const fb = q.querySelector('.quiz-feedback.correct'); if (fb) fb.style.display = 'block'; } else { const fb = q.querySelector('.quiz-feedback.incorrect'); if (fb) { const cOpt = q.querySelector('.quiz-option.correct .quiz-option-text'); const cTxt = cOpt ? cOpt.textContent : 'N/A'; fb.innerHTML = `Incorrect. The correct answer was: <strong>${escapeHtml(cTxt)}</strong>`; fb.style.display = 'block'; } } } else { if (!firstUnanswered) firstUnanswered = q; } }); const btn = cont.querySelector('.quiz-submit-btn'); const resDiv = cont.querySelector('.final-quiz-result'); if (answered < total) { alert(`Please answer all ${total} questions before submitting.`); if (firstUnanswered) { firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstUnanswered.style.outline = '2px solid var(--danger)'; setTimeout(() => { if (firstUnanswered) firstUnanswered.style.outline = 'none'; }, 2500); } } else { const perc = total > 0 ? Math.round((score / total) * 100) : 0; if (resDiv) { resDiv.textContent = `Quiz Complete! Your score: ${score} out of ${total} (${perc}%)`; resDiv.className = `final-quiz-result ${perc >= 70 ? 'success' : 'fail'}`; resDiv.style.display = 'block'; resDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } if (btn) btn.disabled = true; qs.forEach(q => q.classList.add('answered')); } }
function toggleSectionCompletion(sectionId, sectionType) {
    let sectionData = null; let parentTabId = null;
    if (sectionType === 'tab') {
        sectionData = findTabData_Editor(sectionId);
    } else if (sectionType === 'subtab') {
         outerLoop: for (const tab of currentProjectData.tabs) { if (Array.isArray(tab.subTabs)) { for (const subTab of tab.subTabs) { if (subTab.id === sectionId) { sectionData = subTab; parentTabId = tab.id; break outerLoop; } } } }
    }
    if (sectionData) {
        sectionData.isComplete = !sectionData.isComplete;
        console.log(`Section ${sectionType} ${sectionId} marked as ${sectionData.isComplete ? 'complete' : 'incomplete'}`);
        saveSpecificProjectData(activeProjectId, currentProjectData);
        // Re-render sidebar and content only if the change affects the current view
        const currentTabActive = projectEditorState.currentTabId === (parentTabId || sectionId);
        const currentSubTabActive = projectEditorState.currentSubTabId === sectionId;
        if(currentTabActive) { // Optimization: only re-render if affected
             renderSidebar_Editor(); // Update sidebar visuals (checkmarks)
            if(currentSubTabActive || (sectionType === 'tab' && !projectEditorState.currentSubTabId)) {
                renderContentArea_Editor(); // Re-render content to update button state
            }
        }
        updateProjectProgress(); // Update progress bar
    } else { console.error(`Could not find ${sectionType} data for ID: ${sectionId}`); }
}
function getSectionCompletionStatus(sectionId, sectionType) {
     let sectionData = null;
     if (sectionType === 'tab') {
         sectionData = findTabData_Editor(sectionId);
     } else if (sectionType === 'subtab') {
          outerLoop: for (const tab of currentProjectData.tabs) { if (Array.isArray(tab.subTabs)) { for (const subTab of tab.subTabs) { if (subTab.id === sectionId) { sectionData = subTab; break outerLoop; } } } }
     }
     return sectionData ? sectionData.isComplete : false;
}
function updateProjectProgress() {
    if (!currentProjectData || !projectEditorElements.progressBarFill || !projectEditorElements.progressBarContainer) return;
    let totalSections = 0; let completedSections = 0;
    currentProjectData.tabs.forEach(tab => { if (!tab) return; if (Array.isArray(tab.subTabs) && tab.subTabs.length > 0) { tab.subTabs.forEach(subTab => { if(subTab) { totalSections++; if (subTab.isComplete) completedSections++; }}); } else { totalSections++; if (tab.isComplete) completedSections++; } });
    const percentage = totalSections > 0 ? Math.round((completedSections / totalSections) * 100) : 0;
    projectEditorElements.progressBarFill.style.width = `${percentage}%`;
    projectEditorElements.progressBarFill.textContent = `${percentage}%`;
    projectEditorElements.progressBarContainer.title = `${completedSections} / ${totalSections} Sections Complete`;
    console.log(`Project Progress: ${completedSections}/${totalSections} (${percentage}%)`);
}

// --- Global Modal & Saving ---
function openEditModal(type, id = null, parentId = null, isNew = false, elementTypeForNew = null) {
    if (!modal || !modalFormContent || !modalTitle) { console.error("Modal elements not found!"); return; } editingContext = { type, id, parentId, isNew, elementType: elementTypeForNew }; modalFormContent.innerHTML = ''; let title = 'Edit'; let formHtml = ''; let currentData = null;
    try {
        switch (type) {
            case 'course': // Only adding new
                title = 'Add New Course'; currentData = { name: '', description: '', imageUrl: '', headerImage: '', styles: {} };
                formHtml = `<label for="edit-item-name">Course Name:</label><input type="text" id="edit-item-name" required><label for="edit-item-description">Short Description (for list view):</label><textarea id="edit-item-description" rows="3"></textarea><label for="edit-item-imageurl">Course Cover Image URL (Optional):</label><input type="url" id="edit-item-imageurl" placeholder="https://..."><label for="edit-item-headerurl">Course Header Image URL (Optional):</label><input type="url" id="edit-item-headerurl" placeholder="https://...">`;
                // Add color pickers for new course
                formHtml += `<fieldset><legend>Course Theme</legend><div class="color-picker"><label>Primary:</label><input type="color" id="edit-style-primary" value="${DEFAULT_COURSE_PRIMARY}"><label>Secondary:</label><input type="color" id="edit-style-secondary" value="${DEFAULT_COURSE_SECONDARY}"><label>Accent:</label><input type="color" id="edit-style-accent" value="${DEFAULT_COURSE_ACCENT}"></div><label for="edit-course-style-bgcolor">Intro BG Color:</label><input type="color" id="edit-course-style-bgcolor" value="${DEFAULT_COURSE_BG}"><label for="edit-course-style-textcolor">Intro Text Color:</label><input type="color" id="edit-course-style-textcolor" value="${DEFAULT_COURSE_TEXT}"></fieldset>`;
                break;
            case 'project': // Adding/editing project meta from course view
                 title = isNew ? 'Add New Project' : 'Edit Project'; currentData = isNew ? { name: '', description: '', imageUrl: '' } : findProjectMeta(id); if (!currentData && !isNew) throw new Error("Project metadata not found."); if (!findCourse(parentId) && isNew) throw new Error("Cannot add project: Parent course ID is missing or invalid."); formHtml = `<label for="edit-item-name">Project Name:</label><input type="text" id="edit-item-name" value="${escapeHtml(currentData.name || '')}" required><label for="edit-item-description">Short Description (for list view):</label><textarea id="edit-item-description" rows="3">${escapeHtml(currentData.description || '')}</textarea><label for="edit-item-imageurl">Project Cover Image URL (Optional):</label><input type="url" id="edit-item-imageurl" value="${escapeHtml(currentData.imageUrl || '')}" placeholder="https://...">`;
                 break; // Styles edited via project editor
            case 'courseStyles': // Edit existing course info & styles
                 title = 'Edit Course Info & Styles';
                 const courseForStyles = findCourse(activeCourseId); // Use activeCourseId directly
                 if (!courseForStyles) throw new Error(`Cannot edit styles: Active course not found (ID: ${activeCourseId}).`); // CHANGED: Improved error
                 currentData = courseForStyles; formHtml = generateCourseStyleForm(currentData); break;
            case 'course-element':
                 const courseForElement = findCourse(activeCourseId); if (!courseForElement) throw new Error("Cannot edit element: Active course not found."); title = isNew ? `Add New ${elementTypeForNew || 'Element'} to Course` : 'Edit Course Element';
                 if (!isNew) {
                    const findResult = findCourseElementData(activeCourseId, id); if (!findResult) throw new Error("Course element data not found.");
                    currentData = findResult.element;
                    ensureElementDefaults(currentData); // Ensure loaded data has all fields
                    title = `Edit ${currentData.type.charAt(0).toUpperCase() + currentData.type.slice(1)}`;
                 } else {
                    const elementType = elementTypeForNew || id?.split('_')[0]; if (!elementType || ['quiz', 'challenges', 'markcomplete'].includes(elementType)) throw new Error("Invalid element type for course content.");
                    currentData = { id: id, type: elementType, data: getDefaultElementData(elementType) };
                    editingContext.elementType = elementType;
                 }
                 formHtml = generateElementForm(currentData); break;
            case 'tab':
                 currentData = findTabData_Editor(id); if (!currentData && !isNew) throw new Error("Tab data not found."); title = isNew ? 'Add New Tab' : 'Edit Tab';
                 formHtml = `<label for="edit-generic-name">Tab Name:</label><input type="text" id="edit-generic-name" value="${escapeHtml(currentData?.name || '')}" required>`; break;
            case 'subtab':
                 currentData = findSubTabData_Editor(parentId, id); if (!currentData && !isNew) throw new Error("Sub-tab data not found."); title = isNew ? 'Add New Sub-Tab' : 'Edit Sub-Tab';
                 formHtml = `<label for="edit-generic-name">Sub-Tab Name:</label><input type="text" id="edit-generic-name" value="${escapeHtml(currentData?.name || '')}" required>`; break;
            case 'element':
                 title = isNew ? `Add New ${elementTypeForNew || 'Element'} to Project Section` : 'Edit Project Element';
                 if (!isNew) {
                    const findResult = findElementData_Editor(id); if (!findResult) throw new Error("Project element data not found.");
                    currentData = findResult.element;
                    ensureElementDefaults(currentData); // Ensure loaded data has all fields
                    title = `Edit ${currentData.type.charAt(0).toUpperCase() + currentData.type.slice(1)}`;
                 } else {
                    const elementType = elementTypeForNew || id?.split('_')[0]; if (!elementType) throw new Error("Element type not specified for new project element.");
                    currentData = { id: id, type: elementType, data: getDefaultElementData(elementType) };
                    editingContext.elementType = elementType;
                 }
                 formHtml = generateElementForm(currentData); break;
            case 'styles': // Edit existing project info & styles
                 title = 'Edit Project Info & Styles'; currentData = currentProjectData; if (!currentData) throw new Error("No project loaded to edit styles."); formHtml = generateStyleForm_Editor(currentData); break;
            default: throw new Error(`Unknown modal type: ${type}`);
        }
        modalTitle.textContent = title; modalFormContent.innerHTML = formHtml; modal.style.display = 'flex'; const firstInput = modalFormContent.querySelector('input:not([type=hidden]):not([type=color]), textarea, select'); if (firstInput) setTimeout(() => firstInput.focus(), 50);

        // Add event listener for custom font size input display
        const fontSizeSelect = modalFormContent.querySelector('#edit-global-style-size, #edit-element-size');
        const customSizeInput = modalFormContent.querySelector('#edit-global-style-size-custom, #edit-element-size-custom');
        if (fontSizeSelect && customSizeInput) {
            fontSizeSelect.addEventListener('change', (e) => {
                 customSizeInput.classList.toggle('visible', e.target.value === 'custom');
                 if(e.target.value !== 'custom') customSizeInput.value = '';
            });
        }
        // Add event listener for challenge custom image size input display
        modalFormContent.querySelectorAll('.challenge-image-size-select').forEach(select => {
            const itemDiv = select.closest('.challenge-edit-item');
            const customInputs = itemDiv.querySelectorAll('.custom-size-input');
            const toggleCustom = () => {
                 const show = select.value === 'custom';
                 customInputs.forEach(inpDiv => inpDiv.classList.toggle('visible', show));
                 if(!show) {
                     itemDiv.querySelector('.challenge-image-width-input').value = '';
                     itemDiv.querySelector('.challenge-image-height-input').value = '';
                 }
            };
            select.addEventListener('change', toggleCustom);
            // toggleCustom(); // Initial check (redundant as handled by render function)
        });
        // Listener for clearing element text color
        const clearColorBtn = modalFormContent.querySelector('#clear-element-color-btn');
        const colorInput = modalFormContent.querySelector('#edit-element-color');
        if(clearColorBtn && colorInput) {
            clearColorBtn.addEventListener('click', () => {
                colorInput.value = '#000000'; // Reset input visually (doesn't matter much)
                 // We'll save it as null/empty in the save function based on a flag or checking if it's default black? Easier to just rely on saving '' below.
                 // For now, just make button disappear
                 clearColorBtn.style.display = 'none';
            });
             colorInput.addEventListener('input', () => { // Show clear button if color is changed from default
                 clearColorBtn.style.display = 'inline-block';
             });
        }
         // Add event listener for image custom size input display (generic elements)
         const imageSizeSelect = modalFormContent.querySelector('#edit-element-size');
         const imageCustomWidth = modalFormContent.querySelector('#edit-element-width')?.closest('.custom-size-input');
         const imageCustomHeight = modalFormContent.querySelector('#edit-element-height')?.closest('.custom-size-input');
         if (imageSizeSelect && (imageCustomWidth || imageCustomHeight)) {
             imageSizeSelect.addEventListener('change', (e) => {
                 const showCustom = e.target.value === 'auto'; // 'auto' means custom W/H for images
                 if(imageCustomWidth) imageCustomWidth.classList.toggle('visible', showCustom);
                 if(imageCustomHeight) imageCustomHeight.classList.toggle('visible', showCustom);
                 if (!showCustom) {
                     if(imageCustomWidth) imageCustomWidth.querySelector('input').value = '';
                     if(imageCustomHeight) imageCustomHeight.querySelector('input').value = '';
                 }
             });
         }


    } catch (e) { console.error("Error opening or preparing edit modal:", e); alert(`Error opening modal: ${e.message}`); closeModal(); }
}

function generateCourseStyleForm(courseData) {
    const s = courseData.styles || {};
    return `
        <fieldset><legend>Course Info</legend>
            <label for="edit-item-name">Course Name:</label><input type="text" id="edit-item-name" value="${escapeHtml(courseData.name || '')}" required>
            <label for="edit-item-description">Short Description (for list view):</label><textarea id="edit-item-description" rows="3">${escapeHtml(courseData.description || '')}</textarea>
            <label for="edit-item-imageurl">Course Cover Image URL (Optional):</label><input type="url" id="edit-item-imageurl" value="${escapeHtml(courseData.imageUrl || '')}" placeholder="https://...">
             <label for="edit-item-headerurl">Course Header Image URL (Optional):</label><input type="url" id="edit-item-headerurl" value="${escapeHtml(courseData.headerImage || '')}" placeholder="https://...">
         </fieldset>
        <fieldset><legend>Course Theme</legend>
            <div class="color-picker">
                <label>Primary:</label><input type="color" id="edit-style-primary" value="${s.primaryColor || DEFAULT_COURSE_PRIMARY}">
                <label>Secondary:</label><input type="color" id="edit-style-secondary" value="${s.secondaryColor || DEFAULT_COURSE_SECONDARY}">
                <label>Accent:</label><input type="color" id="edit-style-accent" value="${s.accentColor || DEFAULT_COURSE_ACCENT}">
            </div><br>
             <label for="edit-course-style-bgcolor">Intro Content Background Color:</label><input type="color" id="edit-course-style-bgcolor" value="${s.backgroundColor || DEFAULT_COURSE_BG}"><br>
            <label for="edit-course-style-textcolor">Intro Content Text Color:</label><input type="color" id="edit-course-style-textcolor" value="${s.textColor || DEFAULT_COURSE_TEXT}">
            <p style="font-size: 0.8em; color: #666;">(Theme colors apply to the header and list items. BG/Text colors apply only to the introductory content area.)</p>
        </fieldset>`;
}

// CHANGED: Added text style controls, updated layout controls, markcomplete alignment
function generateElementForm(elementData) {
    const d = elementData.data || {}; const type = elementData.type; let h = '';
    const currentAlignment = d.alignment || DEFAULT_ALIGNMENT;
    const currentSize = d.size || DEFAULT_SIZE;
    const currentTextAlign = d.textAlign || DEFAULT_TEXT_ALIGN; // Default text align within element

    // Add Block Alignment/Size controls for relevant types (wrapper alignment/size)
    if (['image', 'video', 'presentation', 'markcomplete'].includes(type)) {
        h += `<fieldset><legend>Layout</legend><div class="layout-controls">`;
        // Block Alignment
        h += `<div><label for="edit-element-alignment">Block Alignment:</label><select id="edit-element-alignment">
                <option value="left" ${currentAlignment === 'left' ? 'selected' : ''}>Left</option>
                <option value="center" ${currentAlignment === 'center' ? 'selected' : ''}>Center</option>
                <option value="right" ${currentAlignment === 'right' ? 'selected' : ''}>Right</option>
              </select></div>`;
        // Block Size Preset (only for media, not markcomplete)
        if (['image', 'video', 'presentation'].includes(type)) {
            const currentImageWidth = d.width || 'auto';
            const currentImageHeight = d.height || 'auto';
            const showCustomSize = currentSize === 'auto'; // 'auto' means custom for images

            h += `<div><label for="edit-element-size">Size:</label><select id="edit-element-size">
                    <option value="small" ${currentSize === 'small' ? 'selected' : ''}>Small</option>
                    <option value="medium" ${currentSize === 'medium' ? 'selected' : ''}>Medium</option>
                    <option value="large" ${currentSize === 'large' ? 'selected' : ''}>Large</option>
                    <option value="full" ${currentSize === 'full' ? 'selected' : ''}>Full Width</option>
                    ${type === 'image' ? `<option value="auto" ${currentSize === 'auto' ? 'selected' : ''}>Custom W/H</option>` : ''}
                  </select></div>`;
             // Custom size inputs for image 'auto' size
            if (type === 'image') {
                h += `<div class="custom-size-input ${showCustomSize ? 'visible' : ''}">
                        <label for="edit-element-width">Width (e.g., 300px, 100%):</label>
                        <input type="text" id="edit-element-width" value="${escapeHtml(currentImageWidth)}">
                     </div>
                     <div class="custom-size-input ${showCustomSize ? 'visible' : ''}">
                         <label for="edit-element-height">Height (e.g., 200px, auto):</label>
                         <input type="text" id="edit-element-height" value="${escapeHtml(currentImageHeight)}">
                     </div>`;
             }
        }
        h += `</div></fieldset>`;
    }

    // Add Text Style controls for heading/text
    if (['heading', 'text'].includes(type)) {
        h += `<fieldset><legend>Text Styles</legend>`;
        // Text Alignment Control (within the element)
         h += `<div class="layout-controls"><div><label for="edit-element-text-align">Text Alignment:</label><select id="edit-element-text-align">
                 <option value="left" ${currentTextAlign === 'left' ? 'selected' : ''}>Left</option>
                 <option value="center" ${currentTextAlign === 'center' ? 'selected' : ''}>Center</option>
                 <option value="right" ${currentTextAlign === 'right' ? 'selected' : ''}>Right</option>
                </select></div></div>`;
        h += generateTextStyleFormControls_Element(d); // Add font, size, color controls
        h += `</fieldset>`;
    }


    if (['image', 'video', 'presentation', 'quiz', 'challenges'].includes(type)) { h += `<fieldset><legend>Optional Display Info</legend><label for="edit-media-heading">Display Heading (Optional):</label><input id="edit-media-heading" type="text" value="${escapeHtml(d.heading || '')}" placeholder="E.g., Introduction Video"><label for="edit-media-description">Display Description (Optional):</label><textarea id="edit-media-description" rows="3" placeholder="A short description that appears above the media/section.">${escapeHtml(d.description || '')}</textarea></fieldset>`; }
    h += `<fieldset><legend>${type.charAt(0).toUpperCase() + type.slice(1)} Content</legend>`;
    switch (type) {
        case 'heading': h += `<label for="edit-element-text">Heading Text:</label><input type="text" id="edit-element-text" value="${escapeHtml(d.text || '')}" required>`; break;
        case 'text': h += `<label for="edit-element-text">Text Content:</label><textarea id="edit-element-text" rows="6">${escapeHtml(d.text || '')}</textarea>`; break;
        case 'image':
             h += `<label for="edit-element-url">Image URL:</label><input type="url" id="edit-element-url" value="${escapeHtml(d.url || '')}" required placeholder="https://..."><label for="edit-element-alt">Alternative Text (for accessibility):</label><input type="text" id="edit-element-alt" value="${escapeHtml(d.alt || '')}" placeholder="Describe the image"><p style="font-size:0.8em; color:#666; margin-top:-10px;">Custom Width/Height inputs are used only if Size is set to 'Custom W/H'.</p>`;
             // Custom W/H inputs moved inside layout controls above
             break;
        case 'video': case 'presentation': const urlLabel = type === 'video' ? 'Video URL (YouTube, Vimeo, etc.):' : 'Presentation URL (Google Slides, etc.):'; h += `<label for="edit-element-url">${urlLabel}</label><input type="url" id="edit-element-url" value="${escapeHtml(d.url || '')}" required placeholder="https://...">`; break;
        case 'quiz': if (editingContext.type !== 'element') h += '<p>Quiz editing is only available within the Project Editor.</p>'; else h += generateQuizEditForm_Editor(d); break;
        case 'challenges': if (editingContext.type !== 'element') h += '<p>Challenges editing is only available within the Project Editor.</p>'; else h += generateChallengesEditForm_Editor(d); break;
        case 'markcomplete':
             h += `<p>This element adds a 'Mark as Complete' button for the current project section.</p><label for="edit-element-text">Button Text (when incomplete):</label><input type="text" id="edit-element-text" value="${escapeHtml(d.text || 'Mark as Complete')}"><label for="edit-element-completed-text">Button Text (when complete):</label><input type="text" id="edit-element-completed-text" value="${escapeHtml(d.completedText || 'Completed')}" placeholder="Completed">`;
             // Alignment is handled in the Layout fieldset above
             break;
        default: h += '<p>Cannot edit this element type.</p>';
    } h += `</fieldset>`; return h;
}

// CHANGED: Updated labels, use textarea for subtitle, handle header image consistently
function generateStyleForm_Editor(projectData) {
    const s = projectData.styles || {};
    const projectMeta = findProjectMeta(activeProjectId); // Get metadata for cover image
    // Use cover image URL from metadata preferentially for the input field value
    const coverOrHeaderImageUrl = projectMeta?.imageUrl || projectData.headerImage || '';
    return `
        <fieldset><legend>Info & Header</legend>
            <label for="edit-style-title">Project Title:</label><input type="text" id="edit-style-title" value="${escapeHtml(projectData.title || '')}" required>
            <label for="edit-style-subtitle">Project Subtitle:</label><textarea id="edit-style-subtitle" rows="3">${escapeHtml(projectData.subtitle || '')}</textarea>
            <label for="edit-style-coverimg">Cover / Header Image URL:</label><input type="url" id="edit-style-coverimg" value="${escapeHtml(coverOrHeaderImageUrl)}">
            <p style="font-size:0.8em; color:#666; margin-top:-10px;">This image is used for the project list and the project header.</p>
        </fieldset>
        <fieldset><legend>Project Theme Colors</legend>
            <div class="color-picker">
                <label>Primary:</label><input type="color" id="edit-style-primary" value="${s.primaryColor || DEFAULT_PRIMARY_COLOR}">
                <label>Secondary:</label><input type="color" id="edit-style-secondary" value="${s.secondaryColor || DEFAULT_SECONDARY_COLOR}">
                <label>Accent:</label><input type="color" id="edit-style-accent" value="${s.accentColor || DEFAULT_ACCENT_COLOR}">
            </div>
        </fieldset>
        <fieldset><legend>Default Project Text Styles</legend>
             ${generateGlobalTextStyleFormControls_Project(s)}
        </fieldset>`;
}

// This generates controls for the PROJECT-WIDE default text styles modal
function generateGlobalTextStyleFormControls_Project(styles={}) {
    const currentFontFamily = styles.globalFontFamily || DEFAULT_FONT_FAMILY;
    const currentFontSize = styles.globalFontSize || DEFAULT_FONT_SIZE_NAME;
    const currentTextColor = styles.globalTextColor || DEFAULT_TEXT_COLOR;
    let fontFamilyOptions = FONT_FAMILIES.map(font => `<option value="${escapeHtml(font.value)}" ${currentFontFamily === font.value ? 'selected' : ''}>${escapeHtml(font.name)}</option>`).join('');
    let fontSizeOptions = FONT_SIZES.map(size => { let isSelected = (currentFontSize === size); if (size === 'custom' && currentFontSize && !FONT_SIZES.slice(0,-1).includes(currentFontSize)) isSelected = true; return `<option value="${size}" ${isSelected ? 'selected' : ''}>${size === 'custom' ? 'Custom...' : size.charAt(0).toUpperCase() + size.slice(1)}</option>`; }).join('');
    const isCustomSize = currentFontSize && !FONT_SIZES.slice(0, -1).includes(currentFontSize);
    const customSizeValue = isCustomSize ? currentFontSize : '';
    return `<div class="project-text-style-options">
                <label for="edit-global-style-font">Font Family:</label><select id="edit-global-style-font">${fontFamilyOptions}</select><br>
                <label for="edit-global-style-size">Font Size:</label><select id="edit-global-style-size">${fontSizeOptions}</select>
                <input type="text" id="edit-global-style-size-custom" placeholder="e.g., 17px" value="${escapeHtml(customSizeValue)}" class="custom-size-input ${isCustomSize ? 'visible' : ''}"><br>
                <label for="edit-global-style-color">Text Color:</label><input type="color" id="edit-global-style-color" value="${currentTextColor}">
            </div>`;
}
// CHANGED: New function to generate text style controls for individual ELEMENTS
function generateTextStyleFormControls_Element(elementData={}) {
    const currentFontFamily = elementData.fontFamily || ''; // Empty means inherit
    const currentFontSize = elementData.fontSize || ''; // Empty means inherit
    const currentTextColor = elementData.textColor || ''; // Empty means inherit

    let fontFamilyOptions = `<option value="" ${!currentFontFamily ? 'selected' : ''}>Inherit Default</option>` +
                            FONT_FAMILIES.map(font => `<option value="${escapeHtml(font.value)}" ${currentFontFamily === font.value ? 'selected' : ''}>${escapeHtml(font.name)}</option>`).join('');
    let fontSizeOptions = `<option value="" ${!currentFontSize ? 'selected' : ''}>Inherit Default</option>` +
                           FONT_SIZES.map(size => { let isSelected = (currentFontSize === size); if (size === 'custom' && currentFontSize && !FONT_SIZES.slice(0,-1).includes(currentFontSize) && currentFontSize !== '') isSelected = true; return `<option value="${size}" ${isSelected ? 'selected' : ''}>${size === 'custom' ? 'Custom...' : size.charAt(0).toUpperCase() + size.slice(1)}</option>`; }).join('');
    const isCustomSize = currentFontSize && !FONT_SIZES.slice(0, -1).includes(currentFontSize) && currentFontSize !== '';
    const customSizeValue = isCustomSize ? currentFontSize : '';

    return `<div class="text-style-controls">
                <label for="edit-element-font">Font Family:</label><select id="edit-element-font">${fontFamilyOptions}</select><br>
                <label for="edit-element-size">Font Size:</label><select id="edit-element-size">${fontSizeOptions}</select>
                <input type="text" id="edit-element-size-custom" placeholder="e.g., 17px" value="${escapeHtml(customSizeValue)}" class="custom-size-input ${isCustomSize ? 'visible' : ''}"><br>
                <label for="edit-element-color">Text Color:</label><input type="color" id="edit-element-color" value="${currentTextColor || '#000000'}">
                <button type="button" class="action-btn" id="clear-element-color-btn" title="Inherit Default Color" style="${!currentTextColor ? 'display:none;' : ''}">Use Default</button>
            </div>`;
}

// CHANGED: Added placeholder text clarification
function generateQuizEditForm_Editor(quizData){ let h = '<fieldset><legend>Quiz Questions</legend><div id="quiz-editor-questions-container">'; const qs = quizData.questions || []; if (qs.length === 0) h += '<p id="quiz-editor-no-questions-msg">No questions added yet.</p>'; else qs.forEach((q, i) => { h += renderSingleQuizQuestionForm_Editor(q, i); }); h += '</div></fieldset><button type="button" id="quiz-editor-add-question-btn" class="add-btn quiz-edit-add-question-btn">+ Add Question</button>'; return h; }
function renderSingleQuizQuestionForm_Editor(q={},i){ const inc = Array.isArray(q.incorrectAnswers) ? q.incorrectAnswers : []; const incImgs = Array.isArray(q.incorrectAnswersImageUrls) ? q.incorrectAnswersImageUrls : []; let h = `<div class="quiz-edit-question" data-question-index="${i}"><h4>Question ${i + 1}<button type="button" class="remove-btn action-btn quiz-editor-remove-question-btn" data-index="${i}" title="Remove Question ${i + 1}">Ã—</button></h4><label for="quiz-q-text-${i}">Question Text:</label><textarea id="quiz-q-text-${i}" rows="2" required>${escapeHtml(q.questionText || '')}</textarea><div class="quiz-image-input"><label for="quiz-q-image-${i}">Question Image URL (Optional):</label><input type="url" id="quiz-q-image-${i}" value="${escapeHtml(q.questionImageUrl || '')}"></div><hr><p style="font-size:0.9em; color:#555;">For each answer, provide text OR an image URL (or both, text is prioritized for display).</p><label for="quiz-q-correct-${i}" style="color:var(--success);font-weight:bold;">Correct Answer:</label><input type="text" id="quiz-q-correct-${i}" value="${escapeHtml(q.correctAnswer || '')}" placeholder="Correct Answer Text (Required if no image)"><div class="quiz-image-input"><label for="quiz-q-correct-image-${i}">Correct Answer Image URL (Optional):</label><input type="url" id="quiz-q-correct-image-${i}" value="${escapeHtml(q.correctAnswerImageUrl || '')}"></div><label>Incorrect Answers (up to 3):</label>`; for (let j = 0; j < 3; j++) { h += `<div style="border-left:2px solid #eee;padding-left:10px;margin-bottom:10px;"><input type="text" class="quiz-q-incorrect" id="quiz-q-incorrect-${i}-${j}" value="${escapeHtml(inc[j] || '')}" placeholder="Incorrect answer ${j + 1} (Text)"><div class="quiz-image-input"><label for="quiz-q-incorrect-image-${i}-${j}">Incorrect Answer ${j + 1} Image URL (Optional):</label><input type="url" class="quiz-q-incorrect-image" id="quiz-q-incorrect-image-${i}-${j}" value="${escapeHtml(incImgs[j] || '')}"></div></div>`; } h += `</div>`; return h; }
// CHANGED: Added challenge image layout controls
function generateChallengesEditForm_Editor(chData){ const d = chData || { challenges: [] }; let h = `<fieldset><legend>Challenges Items</legend><div id="challenges-editor-list">`; const chs = d.challenges || []; if (chs.length === 0) h += '<p id="challenges-editor-no-items-msg">No challenge items added yet.</p>'; else chs.forEach((c, i) => h += renderSingleChallengeForm_Editor(c, i)); h += `</div></fieldset><button type="button" id="challenges-editor-add-btn" class="add-btn" ${chs.length >= MAX_CHALLENGES ? 'disabled' : ''}>+ Add Challenge Item</button>${chs.length >= MAX_CHALLENGES ? `<p style="color:var(--danger);font-size:0.9em;">Maximum challenges (${MAX_CHALLENGES}) reached.</p>` : ''}`; return h; }
function renderSingleChallengeForm_Editor(c={},i){
    const imgAlign = c.imageAlignment || DEFAULT_ALIGNMENT;
    const imgSize = c.imageSize || DEFAULT_SIZE;
    const imgW = c.imageWidth || 'auto';
    const imgH = c.imageHeight || 'auto';
    const showCustomSize = imgSize === 'custom';

    return `<div class="challenge-edit-item" data-challenge-index="${i}" data-challenge-id="${c.id || ''}"><h5>Challenge Item ${i + 1}<button type="button" class="remove-btn action-btn challenges-editor-remove-btn" data-index="${i}" title="Remove Challenge ${i + 1}">Ã—</button></h5>
        <label for="challenge-heading-${i}">Heading:</label><input type="text" class="challenge-heading-input" id="challenge-heading-${i}" value="${escapeHtml(c.heading || '')}" required>
        <label for="challenge-icon-${i}">Icon URL (Optional):</label><input type="url" class="challenge-icon-input" id="challenge-icon-${i}" value="${escapeHtml(c.iconUrl || '')}">
        <label for="challenge-desc-${i}">Description:</label><textarea class="challenge-desc-input" id="challenge-desc-${i}" rows="2">${escapeHtml(c.description || '')}</textarea>
        <label for="challenge-image-${i}">Image URL (Optional):</label><input type="url" class="challenge-image-input" id="challenge-image-${i}" value="${escapeHtml(c.imageUrl || '')}" >
        <!-- Challenge Image Layout Controls -->
        <div class="challenge-image-layout-controls">
            <div><label for="challenge-image-align-${i}">Image Alignment:</label><select class="challenge-image-align-select" id="challenge-image-align-${i}">
                <option value="left" ${imgAlign === 'left' ? 'selected' : ''}>Left</option>
                <option value="center" ${imgAlign === 'center' ? 'selected' : ''}>Center</option>
                <option value="right" ${imgAlign === 'right' ? 'selected' : ''}>Right</option>
            </select></div>
            <div><label for="challenge-image-size-${i}">Image Size:</label><select class="challenge-image-size-select" id="challenge-image-size-${i}">
                <option value="small" ${imgSize === 'small' ? 'selected' : ''}>Small</option>
                <option value="medium" ${imgSize === 'medium' ? 'selected' : ''}>Medium</option>
                <option value="large" ${imgSize === 'large' ? 'selected' : ''}>Large</option>
                <option value="custom" ${imgSize === 'custom' ? 'selected' : ''}>Custom W/H</option>
            </select></div>
            <div class="custom-size-input ${showCustomSize ? 'visible' : ''}">
                <label for="challenge-image-width-${i}">Width:</label>
                <input type="text" class="challenge-image-width-input" id="challenge-image-width-${i}" value="${escapeHtml(imgW)}" placeholder="e.g. 200px">
            </div>
            <div class="custom-size-input ${showCustomSize ? 'visible' : ''}">
                <label for="challenge-image-height-${i}">Height:</label>
                <input type="text" class="challenge-image-height-input" id="challenge-image-height-${i}" value="${escapeHtml(imgH)}" placeholder="e.g. auto">
            </div>
        </div>
    </div>`;
}

function closeModal() { if (modal) modal.style.display = 'none'; if (modalFormContent) modalFormContent.innerHTML = ''; editingContext = { type: null, id: null, parentId: null, isNew: false, elementType: null }; }

// Save Action - Updated cases
function saveEditAction() {
    const { type, id, parentId, isNew, elementType } = editingContext;
    if (!type || !modalFormContent) { closeModal(); return; }
    console.log("Saving:", editingContext);
    try {
        let name, description, imageUrl, headerUrl; // Common vars

        switch (type) {
            case 'course': // Adding NEW course
                 name = getModalValue('#edit-item-name'); description = getModalValue('#edit-item-description', '', false); imageUrl = getModalValue('#edit-item-imageurl', null); headerUrl = getModalValue('#edit-item-headerurl', null);
                 if (!name) throw new Error("Course name is required.");
                 if (appData.courses.length >= MAX_COURSES) throw new Error("Maximum courses reached.");
                 const newCourse = {
                     id: generateId('course_'), name, description, imageUrl, headerImage: headerUrl || imageUrl, // Default header to cover if not set
                     projects: [], content: [],
                     styles: {
                        primaryColor: getModalValue('#edit-style-primary', DEFAULT_COURSE_PRIMARY, false),
                        secondaryColor: getModalValue('#edit-style-secondary', DEFAULT_COURSE_SECONDARY, false),
                        accentColor: getModalValue('#edit-style-accent', DEFAULT_COURSE_ACCENT, false),
                        backgroundColor: getModalValue('#edit-course-style-bgcolor', DEFAULT_COURSE_BG, false),
                        textColor: getModalValue('#edit-course-style-textcolor', DEFAULT_COURSE_TEXT, false)
                    }
                 };
                 appData.courses.push(newCourse);
                 saveAppData(); renderDashboardView();
                 break;
            case 'project': // Adding/editing project meta from course view
                 name = getModalValue('#edit-item-name'); description = getModalValue('#edit-item-description', '', false); imageUrl = getModalValue('#edit-item-imageurl', null); // This is the cover image
                 if (!name) throw new Error("Project name is required.");
                 const courseForProject = findCourse(parentId); // parentId is courseId here
                 if (!courseForProject) throw new Error("Parent course not found when saving project.");
                 if (isNew) {
                      if (courseForProject.projects.length >= MAX_PROJECTS_PER_COURSE) throw new Error(`Maximum projects reached for course "${courseForProject.name}".`);
                      const newProjectId = generateId('proj_'); const newProjectMeta = { id: newProjectId, name, description, imageUrl }; courseForProject.projects.push(newProjectMeta);
                      const defaultProjData = getDefaultProjectDataTemplate(); defaultProjData.title = name; defaultProjData.subtitle = description; defaultProjData.headerImage = imageUrl; // Set header image from cover
                      saveSpecificProjectData(newProjectId, defaultProjData);
                 } else {
                     const projectMeta = findProjectMeta(id); if (!projectMeta) throw new Error("Project metadata not found for editing.");
                     projectMeta.name = name; projectMeta.description = description; projectMeta.imageUrl = imageUrl;
                     const projectData = loadSpecificProjectData(id); projectData.title = name; projectData.subtitle = description; projectData.headerImage = imageUrl; // Sync header image
                     saveSpecificProjectData(id, projectData);
                 }
                 saveAppData(); renderCourseView(parentId);
                 break;
            case 'courseStyles': // Editing existing course info & styles
                  const courseToStyle = findCourse(activeCourseId);
                  if (!courseToStyle) throw new Error("Course not found for saving styles.");
                  courseToStyle.name = getModalValue('#edit-item-name') || courseToStyle.name;
                  courseToStyle.description = getModalValue('#edit-item-description', '', false);
                  courseToStyle.imageUrl = getModalValue('#edit-item-imageurl') || null; // Cover
                  courseToStyle.headerImage = getModalValue('#edit-item-headerurl') || courseToStyle.imageUrl || null; // Header, default to cover
                  if (!courseToStyle.styles) courseToStyle.styles = {};
                  courseToStyle.styles.primaryColor = getModalValue('#edit-style-primary', DEFAULT_COURSE_PRIMARY, false);
                  courseToStyle.styles.secondaryColor = getModalValue('#edit-style-secondary', DEFAULT_COURSE_SECONDARY, false);
                  courseToStyle.styles.accentColor = getModalValue('#edit-style-accent', DEFAULT_COURSE_ACCENT, false);
                  courseToStyle.styles.backgroundColor = getModalValue('#edit-course-style-bgcolor', DEFAULT_COURSE_BG, false);
                  courseToStyle.styles.textColor = getModalValue('#edit-course-style-textcolor', DEFAULT_COURSE_TEXT, false);
                  saveAppData();
                  applyCourseSpecificStyles(activeCourseId); // Re-apply styles first
                  renderCourseView(activeCourseId); // Then re-render
                  break;
            case 'course-element': const courseForSave = findCourse(activeCourseId); if (!courseForSave) throw new Error("Cannot save element: Active course not found."); const savedElementDataC = saveElementEditFromModal(id, isNew, elementType); if (isNew) { if (!Array.isArray(courseForSave.content)) courseForSave.content = []; courseForSave.content.push(savedElementDataC); } saveAppData(); renderCourseView(activeCourseId); break;
            case 'tab': case 'subtab': const genericName = getModalValue('#edit-generic-name'); if (!genericName) throw new Error("Name cannot be empty."); let itemToUpdate; if (type === 'tab') { itemToUpdate = findTabData_Editor(id); if (!itemToUpdate) throw new Error("Tab not found for saving."); } else { itemToUpdate = findSubTabData_Editor(parentId, id); if (!itemToUpdate) throw new Error("Sub-tab not found for saving."); } itemToUpdate.name = genericName; saveSpecificProjectData(activeProjectId, currentProjectData); renderSidebar_Editor(); break;
            case 'element': const savedProjectElementData = saveElementEditFromModal(id, isNew, elementType); if (isNew) { const targetArray = getCurrentContentArray_Editor(); if (!targetArray) throw new Error("Target array not found for new project element."); targetArray.push(savedProjectElementData); } saveSpecificProjectData(activeProjectId, currentProjectData); renderContentArea_Editor(); break;
            case 'styles': // Editing existing project info & styles
                  if (!currentProjectData) throw new Error("No project data loaded to save styles.");
                  currentProjectData.title = getModalValue('#edit-style-title') || currentProjectData.title;
                  currentProjectData.subtitle = getModalValue('#edit-style-subtitle', '', false);
                  const newCoverHeaderImage = getModalValue('#edit-style-coverimg', null); // Read from the combined input
                  currentProjectData.headerImage = newCoverHeaderImage; // Save to project data
                  // Also update metadata
                   const projectMetaForStyleSave = findProjectMeta(activeProjectId);
                   if (projectMetaForStyleSave) {
                       projectMetaForStyleSave.imageUrl = newCoverHeaderImage; // Update cover image in metadata
                   }

                  if (!currentProjectData.styles) currentProjectData.styles = {};
                  currentProjectData.styles.primaryColor = getModalValue('#edit-style-primary', DEFAULT_PRIMARY_COLOR, false);
                  currentProjectData.styles.secondaryColor = getModalValue('#edit-style-secondary', DEFAULT_SECONDARY_COLOR, false);
                  currentProjectData.styles.accentColor = getModalValue('#edit-style-accent', DEFAULT_ACCENT_COLOR, false);
                  currentProjectData.styles.globalTextColor = getModalValue('#edit-global-style-color', DEFAULT_TEXT_COLOR, false);
                  currentProjectData.styles.globalFontFamily = getModalValue('#edit-global-style-font', DEFAULT_FONT_FAMILY, false);
                  const sizeSelProj = modalFormContent.querySelector('#edit-global-style-size');
                  const fontSizeVal = sizeSelProj?.value || '';
                  if (fontSizeVal === 'custom') {
                     const customSize = getModalValue('#edit-global-style-size-custom', '').trim();
                     currentProjectData.styles.globalFontSize = (customSize && (customSize.includes('px') || customSize.includes('em') || customSize.includes('%') || /^\d+(\.\d+)?$/.test(customSize))) ? customSize : DEFAULT_FONT_SIZE_NAME;
                  } else {
                     currentProjectData.styles.globalFontSize = fontSizeVal || DEFAULT_FONT_SIZE_NAME;
                  }
                  saveSpecificProjectData(activeProjectId, currentProjectData); // Saves project data AND triggers metadata save if needed
                  applyProjectStyles_Editor(); // Re-apply styles
                  break;
            default: throw new Error(`Unknown save type: ${type}`);
        }
        closeModal();
    } catch (e) { console.error("Error saving edit:", e); alert(`Save failed: ${e.message}`); }
}

// CHANGED: Handle element-specific text styles, markcomplete alignment, custom size for image 'auto'
function saveElementEditFromModal(elementId, isNew, elementTypeFromContext) {
    let elementData; let isCourseContext = editingContext.type === 'course-element';
    if (isNew) { const elementType = elementTypeFromContext || elementId?.split('_')[0]; if (!elementType) throw new Error("Cannot determine element type for new element."); elementData = { id: elementId, type: elementType, data: getDefaultElementData(elementType) }; }
    else { const findResult = isCourseContext ? findCourseElementData(activeCourseId, elementId) : findElementData_Editor(elementId); if (!findResult) throw new Error(`Element data not found for saving: ${elementId}`); elementData = findResult.element; if (!elementData.data) elementData.data = {}; }
    const getVal = (sel, trim = true) => getModalValue(sel, '', trim);
    const getSelVal = (sel) => modalFormContent?.querySelector(sel)?.value || null;

    // Save Block Alignment/Size for relevant types
    if (['image', 'video', 'presentation', 'markcomplete'].includes(elementData.type)) {
        elementData.data.alignment = getSelVal('#edit-element-alignment') || DEFAULT_ALIGNMENT;
        if (['image', 'video', 'presentation'].includes(elementData.type)) {
            elementData.data.size = getSelVal('#edit-element-size') || DEFAULT_SIZE;
            // Save custom W/H only if size is 'auto' for images
            if (elementData.type === 'image' && elementData.data.size === 'auto') {
                let width = getVal('#edit-element-width') || 'auto';
                let height = getVal('#edit-element-height') || 'auto';
                const sizeRegex = /^(auto|(\d+(\.\d+)?(px|%|em|rem|vw|vh)?))$/i;
                elementData.data.width = sizeRegex.test(width) ? width : 'auto';
                elementData.data.height = sizeRegex.test(height) ? height : 'auto';
            } else if (elementData.type === 'image') { // Clear w/h if not auto
                delete elementData.data.width;
                delete elementData.data.height;
            }
        }
    }

    // Save Text Styles for heading/text
    if (['heading', 'text'].includes(elementData.type)) {
        elementData.data.textAlign = getSelVal('#edit-element-text-align') || DEFAULT_TEXT_ALIGN;
        elementData.data.fontFamily = getSelVal('#edit-element-font') || null; // Null means inherit

        const colorVal = getVal('#edit-element-color', false);
        const clearBtnHidden = !modalFormContent?.querySelector('#clear-element-color-btn') || modalFormContent.querySelector('#clear-element-color-btn').style.display === 'none';
        // Save null if clear button was clicked (is hidden) or if color is default black #000000
        elementData.data.textColor = (clearBtnHidden || colorVal === '#000000') ? null : colorVal;

        const sizeSel = getSelVal('#edit-element-size');
        if (sizeSel === 'custom') {
            const customSize = getVal('#edit-element-size-custom').trim();
            // Validate custom size input
            elementData.data.fontSize = (customSize && (customSize.includes('px') || customSize.includes('em') || customSize.includes('%') || /^\d+(\.\d+)?$/.test(customSize))) ? customSize : null;
        } else {
            elementData.data.fontSize = sizeSel || null; // Store preset name ('small', 'medium', etc.) or null
        }
    }


    if (['image', 'video', 'presentation', 'quiz', 'challenges'].includes(elementData.type)) { elementData.data.heading = getVal('#edit-media-heading'); elementData.data.description = getVal('#edit-media-description', false); }
    switch (elementData.type) {
        case 'heading': elementData.data.text = getVal('#edit-element-text'); if (!elementData.data.text.trim()) throw new Error("Heading text cannot be empty."); break;
        case 'text': elementData.data.text = getVal('#edit-element-text', false); break;
        case 'image': elementData.data.url = getVal('#edit-element-url'); if (!elementData.data.url) throw new Error("Image URL is required."); if (!elementData.data.url.startsWith('http') && !elementData.data.url.startsWith('//') && !elementData.data.url.startsWith('data:')) { console.warn(`URL "${elementData.data.url}" might not be valid.`); } elementData.data.alt = getVal('#edit-element-alt'); break; // W/H saved above
        case 'video': case 'presentation': elementData.data.url = getVal('#edit-element-url'); if (!elementData.data.url) throw new Error("URL is required."); if (!elementData.data.url.startsWith('http') && !elementData.data.url.startsWith('//')) { console.warn(`URL "${elementData.data.url}" might not be valid.`); } delete elementData.data.alt; delete elementData.data.width; delete elementData.data.height; break;
        case 'quiz': if (isCourseContext) throw new Error("Cannot save Quiz element in course context."); saveQuizEditFromModal_Project(elementData.data); break;
        case 'challenges': if (isCourseContext) throw new Error("Cannot save Challenges element in course context."); saveChallengesEditFromModal_Project(elementData.data); break;
        case 'markcomplete':
             elementData.data.text = getVal('#edit-element-text') || 'Mark as Complete';
             elementData.data.completedText = getVal('#edit-element-completed-text') || 'Completed';
             // Alignment saved above
             break;
        default: throw new Error(`Cannot save unknown element type: ${elementData.type}`);
    } return elementData;
}

function saveQuizEditFromModal_Project(quizData) { // Ensure text or image required for answers
    if (!modalFormContent) throw new Error("Modal form content not found while saving quiz."); quizData.questions = []; modalFormContent.querySelectorAll('.quiz-edit-question').forEach((qForm, i) => { const qTxt = qForm.querySelector(`#quiz-q-text-${i}`)?.value.trim(); const cAnsText = qForm.querySelector(`#quiz-q-correct-${i}`)?.value.trim(); const cAnsImg = qForm.querySelector(`#quiz-q-correct-image-${i}`)?.value.trim() || null; if (!qTxt || (!cAnsText && !cAnsImg)) { console.warn(`Skipping Question ${i + 1}: Missing question text or correct answer (text or image).`); return; } const qImg = qForm.querySelector(`#quiz-q-image-${i}`)?.value.trim() || null; const iAns = [], iImgs = []; for (let j = 0; j < 3; j++) { const iTxt = qForm.querySelector(`#quiz-q-incorrect-${i}-${j}`)?.value.trim(); const iImgUrl = qForm.querySelector(`#quiz-q-incorrect-image-${i}-${j}`)?.value.trim() || null; if (iTxt || iImgUrl) { // Only add if text or image exists
            iAns.push(iTxt || ''); // Push empty string if only image
            iImgs.push(iImgUrl); } else { iImgs.push(null); /* Maintain array length consistency if needed? Or just filter later */ } } // Filter out potential trailing nulls if needed, ensure length matches iAns
        const finalIImgs = iImgs.slice(0, iAns.length); while(finalIImgs.length < iAns.length) finalIImgs.push(null); quizData.questions.push({ questionText: qTxt, questionImageUrl: qImg, correctAnswer: cAnsText, correctAnswerImageUrl: cAnsImg, incorrectAnswers: iAns, incorrectAnswersImageUrls: finalIImgs }); }); console.log("Quiz questions saved:", quizData.questions); }

// CHANGED: Save challenge image layout data
function saveChallengesEditFromModal_Project(chData) {
    if (!modalFormContent) throw new Error("Modal form content not found while saving challenges."); chData.challenges = []; modalFormContent.querySelectorAll('.challenge-edit-item').forEach(item => { const head = item.querySelector('.challenge-heading-input')?.value.trim(); if (!head) { console.warn("Skipping challenge item: Heading is missing."); return; }
        const imgAlign = item.querySelector('.challenge-image-align-select')?.value || DEFAULT_ALIGNMENT;
        const imgSize = item.querySelector('.challenge-image-size-select')?.value || DEFAULT_SIZE;
        let imgW = null, imgH = null;
        if (imgSize === 'custom') {
            imgW = item.querySelector('.challenge-image-width-input')?.value.trim() || 'auto';
            imgH = item.querySelector('.challenge-image-height-input')?.value.trim() || 'auto';
            const sizeRegex = /^(auto|(\d+(\.\d+)?(px|%|em|rem|vw|vh)?))$/i;
            if(!sizeRegex.test(imgW)) imgW = 'auto';
            if(!sizeRegex.test(imgH)) imgH = 'auto';
        }

        chData.challenges.push({
             id: item.dataset.challengeId || generateId('chal_'),
             heading: head,
             iconUrl: item.querySelector('.challenge-icon-input')?.value.trim() || null,
             description: item.querySelector('.challenge-desc-input')?.value || '',
             imageUrl: item.querySelector('.challenge-image-input')?.value.trim() || null,
             imageAlignment: imgAlign,
             imageSize: imgSize,
             imageWidth: imgW, // Only relevant if imageSize is 'custom'
             imageHeight: imgH // Only relevant if imageSize is 'custom'
        });
    }); console.log("Challenge items saved:", chData.challenges);
}


// --- Event Listeners Setup ---
function setupGlobalEventListeners() {
    // Dashboard Click Handler (Handles item clicks, add, edit, remove, view toggle)
    dashboardView?.addEventListener('click', (e) => {
        const target = e.target;
        const button = target.closest('button');
        const itemContainer = target.closest('.item-container[data-course-id]');
        const addCard = target.closest('.add-item-card[data-action="add-course"], .add-item-row[data-action="add-course"]');

        if (button) {
            e.stopPropagation();
            const action = button.dataset.action;
            const buttonId = button.id;

            if (buttonId === 'dashboard-grid-view-btn') { setItemViewMode(courseListContainer, 'grid', dashboardGridViewBtn, dashboardListViewBtn); return; }
            if (buttonId === 'dashboard-list-view-btn') { setItemViewMode(courseListContainer, 'list', dashboardGridViewBtn, dashboardListViewBtn); return; }
            if (buttonId === 'toggle-dashboard-view-mode-btn') { toggleViewMode(dashboardView, button); return; } // Use generic toggle

            const courseId = button.closest('[data-course-id]')?.dataset.courseId;
            if (action && courseId) {
                switch (action) {
                    case 'edit-course': openEditModal('courseStyles', courseId); break; // Use courseStyles modal now
                    case 'remove-course': removeCourse(courseId); break;
                }
                return;
            }
        } else if (addCard) {
             e.stopPropagation();
             const courses = appData.courses || [];
             if (courses.length < MAX_COURSES) {
                 openEditModal('course', null, null, true); // Open 'Add Course' modal
             } else { alert(`Maximum courses (${MAX_COURSES}) reached.`); }
        } else if (itemContainer && !target.closest('.item-inline-actions button')) { // Ensure click is not on action buttons
            e.stopPropagation();
            showView('course', itemContainer.dataset.courseId);
        }
    });

    // Course View Click Handler (Handles project items, course elements, header buttons)
    courseView?.addEventListener('click', (e) => {
        const target = e.target;
        const button = target.closest('button');
        const projectItemContainer = target.closest('.item-container[data-project-id]');
        const addProjectCard = target.closest('.add-item-card[data-action="add-project"], .add-item-row[data-action="add-project"]');

        if (button) {
            e.stopPropagation();
            const action = button.dataset.action;
            const buttonId = button.id;

            if (buttonId === 'course-grid-view-btn') { setItemViewMode(projectListContainer, 'grid', courseGridViewBtn, courseListViewBtn); return; }
            if (buttonId === 'course-list-view-btn') { setItemViewMode(projectListContainer, 'list', courseGridViewBtn, courseListViewBtn); return; }
            if (buttonId === 'back-to-dashboard-btn') { showView('dashboard'); return; }
            if (buttonId === 'edit-course-styles-btn') { openEditModal('courseStyles', activeCourseId); return; }
            if (buttonId === 'toggle-view-mode-btn') { toggleViewMode(courseView, button); return; } // Use generic toggle

            if (action === 'add-course-element') {
                const elementType = button.dataset.type;
                if (elementType) {
                    openEditModal('course-element', generateId(elementType + '_'), activeCourseId, true, elementType);
                }
                return;
            }

            const projectIdForAction = button.closest('[data-project-id]')?.dataset.projectId;
            if (projectIdForAction && ['edit-project', 'remove-project'].includes(action)) {
                const courseIdForAction = button.closest('[data-course-id]')?.dataset.courseId || activeCourseId;
                switch (action) {
                    case 'edit-project': openEditModal('project', projectIdForAction, courseIdForAction); break;
                    case 'remove-project': removeProject(projectIdForAction, courseIdForAction); break;
                }
                return;
            }

            const elementIdForAction = button.closest('[data-element-id]')?.dataset.elementId;
            if (elementIdForAction && ['edit-course-element', 'remove-course-element'].includes(action)) {
                switch (action) {
                    case 'edit-course-element': openEditModal('course-element', elementIdForAction, activeCourseId); break;
                    case 'remove-course-element': removeCourseElement(activeCourseId, elementIdForAction); break;
                }
                return;
            }
        } else if (addProjectCard) {
             e.stopPropagation();
             const course = findCourse(activeCourseId);
             const projectCount = course?.projects?.length || 0;
             if (projectCount < MAX_PROJECTS_PER_COURSE) {
                 openEditModal('project', null, activeCourseId, true);
             } else { alert(`Maximum projects (${MAX_PROJECTS_PER_COURSE}) reached for this course.`); }
        } else if (projectItemContainer && !target.closest('.item-inline-actions button')) { // Ensure click is not on action buttons
            e.stopPropagation();
            showView('project', projectItemContainer.dataset.courseId, projectItemContainer.dataset.projectId);
        }
    });

    // Project View Click Handler (Header buttons and sidebar toggle only)
    projectView?.addEventListener('click', (e) => {
         const target = e.target;
         const button = target.closest('button');
         if (button) {
             const buttonId = button.id;
             if (buttonId === 'back-to-projects-btn') {
                 if (activeCourseId) showView('course', activeCourseId); else showView('dashboard');
             } else if (buttonId === 'edit-project-styles-btn') {
                 openEditModal('styles', activeProjectId);
             } else if (buttonId === 'toggle-project-view-mode-btn') {
                 toggleViewMode(projectView, button); // Use generic toggle
                 // Re-render relevant parts based on mode change
                  renderContentArea_Editor();
                 // No need to hide header extension here, CSS handles it if needed
             } else if (buttonId === 'toggle-sidebar-btn') { // Sidebar Toggle
                  projectView.classList.toggle('sidebar-minimized');
             }
         }
    });

    // Modal Listeners
    closeModalButton?.addEventListener('click', closeModal); cancelModalButton?.addEventListener('click', closeModal); saveModalButton?.addEventListener('click', saveEditAction); modalFormContent?.addEventListener('click', handleModalFormInternalClick); document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal?.style.display === 'flex') closeModal(); }); window.addEventListener('hashchange', handleHashChange);

    // Global change listener for dynamic form elements (like custom size inputs)
    document.addEventListener('change', (e) => {
        if (!e.target) return;

        // Project-wide custom font size
        if (e.target.id === 'edit-global-style-size') {
            const customInput = modalFormContent?.querySelector('#edit-global-style-size-custom');
            if (customInput) {
                customInput.classList.toggle('visible', e.target.value === 'custom');
                if(e.target.value !== 'custom') customInput.value = '';
            }
        }
        // Element-specific custom font size
        if (e.target.id === 'edit-element-size') {
             const customInput = modalFormContent?.querySelector('#edit-element-size-custom');
             if (customInput) {
                 customInput.classList.toggle('visible', e.target.value === 'custom');
                 if(e.target.value !== 'custom') customInput.value = '';
             }
             // Also handle image 'auto' size -> custom W/H inputs
             const imageCustomWidth = modalFormContent?.querySelector('#edit-element-width')?.closest('.custom-size-input');
             const imageCustomHeight = modalFormContent?.querySelector('#edit-element-height')?.closest('.custom-size-input');
              if (imageCustomWidth || imageCustomHeight) {
                  const showCustom = e.target.value === 'auto';
                  if(imageCustomWidth) imageCustomWidth.classList.toggle('visible', showCustom);
                  if(imageCustomHeight) imageCustomHeight.classList.toggle('visible', showCustom);
                  if (!showCustom) {
                       if(imageCustomWidth) imageCustomWidth.querySelector('input').value = '';
                       if(imageCustomHeight) imageCustomHeight.querySelector('input').value = '';
                  }
              }
         }
         // Challenge image custom size
         if(e.target.classList.contains('challenge-image-size-select')) {
             const itemDiv = e.target.closest('.challenge-edit-item');
             const customInputs = itemDiv?.querySelectorAll('.custom-size-input');
             if(customInputs) {
                 const show = e.target.value === 'custom';
                 customInputs.forEach(inpDiv => inpDiv.classList.toggle('visible', show));
                 if(!show) {
                     itemDiv.querySelector('.challenge-image-width-input').value = '';
                     itemDiv.querySelector('.challenge-image-height-input').value = '';
                 }
             }
         }
    });

}

// --- View Mode Toggle ---
function toggleViewMode(viewElement, buttonElement) {
    if (!viewElement || !buttonElement) return;
    const isStudentMode = viewElement.classList.toggle('student-mode');
    updateViewModeButton(buttonElement, isStudentMode);
    console.log(`${viewElement.id} view mode switched to: ${isStudentMode ? 'Student' : 'Editor'}`);

    // Update rendering for the specific view if needed
    if (viewElement.id === 'dashboard-view') {
        renderDashboardView(); // Re-render course list (hides actions/add button)
    } else if (viewElement.id === 'course-view') {
        renderCourseView(activeCourseId); // Re-render course content and project list
    } else if (viewElement.id === 'project-view') {
        // Handled by project-specific listeners/renderers
        renderSidebar_Editor(); // Re-render sidebar to hide controls
        renderContentArea_Editor(); // Re-render content area to hide controls/change behavior
    }
}
function updateViewModeButton(buttonElement, isStudentMode) {
    if (!buttonElement) return;
    const studentIcon = buttonElement.querySelector('.icon-student-view');
    const editorIcon = buttonElement.querySelector('.icon-editor-view');

    if (studentIcon && editorIcon) {
        studentIcon.style.display = isStudentMode ? 'none' : 'inline-block';
        editorIcon.style.display = isStudentMode ? 'inline-block' : 'none';
    }
    // Update title attribute
    buttonElement.title = isStudentMode ? 'Switch to Editor View' : 'Switch to Student View';
}


// --- CRUD Functions ---
function removeCourse(courseId) { const course = findCourse(courseId); if (!course) return; if (confirm(`DELETE Course "${escapeHtml(course.name)}"?\n\nThis will also permanently delete ALL ${course.projects.length} associated projects and ALL course content!`)) { course.projects.forEach(p => deleteSpecificProjectData(p.id)); appData.courses = appData.courses.filter(c => c.id !== courseId); saveAppData(); renderDashboardView(); } }
function removeProject(projectId, courseId) { const projectMeta = findProjectMeta(projectId); if (!projectMeta) return; if (confirm(`DELETE Project "${escapeHtml(projectMeta.name)}"? This action cannot be undone.`)) { deleteSpecificProjectData(projectId); const course = findCourse(courseId); if (course) { course.projects = course.projects.filter(p => p.id !== projectId); saveAppData(); renderCourseView(courseId); } else { console.warn("Parent course not found during project removal, reloading dashboard."); showView('dashboard'); } } }
function removeCourseElement(courseId, elementId) { const course = findCourse(courseId); const findResult = findCourseElementData(courseId, elementId); if (!course || !findResult) { alert("Could not find the course or element to remove."); return; } if (confirm(`Are you sure you want to remove this ${findResult.element.type} element from the course description?`)) { course.content.splice(findResult.index, 1); saveAppData(); renderCourseView(courseId); } }

// Handles clicks inside the modal form, specifically for dynamic lists like quiz questions/challenges
function handleModalFormInternalClick(e) {
    const target = e.target; const { type: currentModalType } = editingContext;
    if (currentModalType === 'element' || currentModalType === 'course-element') {
         const isProjectQuizChallengesEdit = (currentModalType === 'element') && (modalFormContent.querySelector('#quiz-editor-questions-container') || modalFormContent.querySelector('#challenges-editor-list'));
         if (isProjectQuizChallengesEdit) {
            // Quiz Question Add/Remove
            if (target.matches('#quiz-editor-add-question-btn')) { const cont = modalFormContent.querySelector('#quiz-editor-questions-container'); const msg = modalFormContent.querySelector('#quiz-editor-no-questions-msg'); if (cont) { if (msg) msg.remove(); const idx = cont.children.length; cont.insertAdjacentHTML('beforeend', renderSingleQuizQuestionForm_Editor({}, idx)); const nI = cont.querySelector(`#quiz-q-text-${idx}`); if(nI) setTimeout(()=>nI.focus(), 50); } }
            else if (target.matches('.quiz-editor-remove-question-btn')) { const idx = parseInt(target.dataset.index, 10); if (!isNaN(idx) && confirm(`Remove Question ${idx + 1}?`)) { const qDiv = target.closest('.quiz-edit-question'); if (qDiv) { qDiv.remove(); const cont = modalFormContent.querySelector('#quiz-editor-questions-container'); if (cont && cont.children.length === 0 && !cont.querySelector('#quiz-editor-no-questions-msg')) { cont.innerHTML = '<p id="quiz-editor-no-questions-msg" style="text-align:center; font-style:italic;">No questions added yet.</p>';}} } }
            // Challenge Item Add/Remove
            else if (target.matches('#challenges-editor-add-btn')) { if (target.disabled) return; const list = modalFormContent.querySelector('#challenges-editor-list'); const msg = modalFormContent.querySelector('#challenges-editor-no-items-msg'); const count = list ? list.querySelectorAll('.challenge-edit-item').length : 0; if (list && count < MAX_CHALLENGES) { if (msg) msg.remove(); const idx = count; list.insertAdjacentHTML('beforeend', renderSingleChallengeForm_Editor({}, idx)); const nI = list.querySelector(`#challenge-heading-${idx}`); if(nI) setTimeout(()=>nI.focus(), 50); if (count + 1 >= MAX_CHALLENGES) target.disabled = true; } }
            else if (target.matches('.challenges-editor-remove-btn')) { const idx = parseInt(target.dataset.index, 10); if (!isNaN(idx) && confirm(`Remove Challenge Item ${idx + 1}?`)) { const cDiv = target.closest('.challenge-edit-item'); if (cDiv) { cDiv.remove(); const addBtn = modalFormContent.querySelector('#challenges-editor-add-btn'); if (addBtn) { const currentCount = modalFormContent.querySelectorAll('.challenge-edit-item').length; addBtn.disabled = (currentCount >= MAX_CHALLENGES); } const list = modalFormContent.querySelector('#challenges-editor-list'); if (list && list.children.length === 0 && !list.querySelector('#challenges-editor-no-items-msg')) { list.innerHTML = '<p id="challenges-editor-no-items-msg" style="text-align:center; font-style:italic;">No challenge items added yet.</p>'; }} } }
        }
    }
}

// --- Project Editor Event Listeners Management ---
let isProjectEditorListenersActive = false;
const projectEditorEventHandlers = { handleProjectSidebarClick, handleProjectAddControlsClick, handleProjectContentAreaClick };

function setupEventListeners_Editor() {
    if (isProjectEditorListenersActive || currentView !== 'project') return; console.log("Setting up project editor event listeners."); const { addTabButton, tabsContainer, contentArea, addControls } = projectEditorElements;
    addTabButton?.addEventListener('click', addTabAction_Editor);
    tabsContainer?.addEventListener('click', projectEditorEventHandlers.handleProjectSidebarClick);
    addControls?.addEventListener('click', projectEditorEventHandlers.handleProjectAddControlsClick);
    contentArea?.addEventListener('click', projectEditorEventHandlers.handleProjectContentAreaClick);
    // Sidebar toggle and view mode toggle are handled globally now via projectView listener
    isProjectEditorListenersActive = true;
}
function teardownEventListeners_Editor() {
    if (!isProjectEditorListenersActive) return; console.log("Tearing down project editor event listeners."); const { addTabButton, tabsContainer, contentArea, addControls } = projectEditorElements;
    addTabButton?.removeEventListener('click', addTabAction_Editor);
    tabsContainer?.removeEventListener('click', projectEditorEventHandlers.handleProjectSidebarClick);
    addControls?.removeEventListener('click', projectEditorEventHandlers.handleProjectAddControlsClick);
    contentArea?.removeEventListener('click', projectEditorEventHandlers.handleProjectContentAreaClick);
    isProjectEditorListenersActive = false;
}

function handleProjectSidebarClick(e) {
    // Only proceed if we are actually in the project view
    if (currentView !== 'project') return;

    const target = e.target;
    const btn = target.closest('button[data-action]'); // Check if an action button was clicked
    const name = target.closest('.tab-name, .sub-tab-name'); // Check if a tab/sub-tab name was clicked
    const isStudent = projectView.classList.contains('student-mode');

    // --- Handle Action Button Clicks ---
    if (btn) {
        // If an action button was clicked AND we are in student mode, ignore the click entirely.
        if (isStudent) {
            e.stopPropagation(); // Stop further processing
            console.log("Sidebar action button clicked in student mode - ignoring.");
            return;
        } else {
            // Otherwise (action button clicked in EDITOR mode), process the action.
            e.stopPropagation();
            const act = btn.dataset.action;
            const tId = btn.dataset.tabId || btn.dataset.parentTabId;
            const sId = btn.dataset.subTabId;

            // Basic validation for actions requiring a tab ID
            if (!tId && ['edit-subtab', 'remove-subtab', 'add-subtab'].includes(act)) {
                console.warn("Action requires tab ID.");
                return;
            }

            // Perform the action based on the button's data attributes
            switch (act) {
                case 'edit-tab': openEditModal('tab', tId); break;
                case 'remove-tab': removeTabAction_Editor(tId); break;
                case 'add-subtab': addSubTabAction_Editor(tId); break;
                case 'edit-subtab': openEditModal('subtab', sId, tId); break;
                case 'remove-subtab': removeSubTabAction_Editor(tId, sId); break;
                default: console.warn(`Unknown sidebar action: ${act}`);
            }
            return; // Action handled, no need to check for name click
        }
    }

    // --- Handle Tab/Sub-tab Name Clicks (for navigation) ---
    // Allow navigation clicks in BOTH student and editor mode.
    if (name) {
        e.stopPropagation(); // Prevent potential event bubbling issues
        if (name.classList.contains('sub-tab-name')) {
            // Clicked on a sub-tab name
            setActiveTab_Editor(name.dataset.parentTabId, name.dataset.subTabId);
        } else if (name.classList.contains('tab-name')) {
            // Clicked on a main tab name
            setActiveTab_Editor(name.dataset.tabId);
        }
    }
}

function handleProjectAddControlsClick(e) { if (currentView !== 'project' || projectView.classList.contains('student-mode')) return; // Only allow adding in editor mode
    if (e.target.tagName === 'BUTTON' && e.target.dataset.type) { addElementAction_Editor(e.target.dataset.type); } }
function handleProjectContentAreaClick(e) {
    if (currentView !== 'project') return;
    const t = e.target;
    const actBtn = t.closest('button[data-action]');
    const qOpt = t.closest('.quiz-option');
    const isStudent = projectView.classList.contains('student-mode');

    if (actBtn) {
        e.stopPropagation(); // Prevent other actions if a button was clicked
        const act = actBtn.dataset.action;
        const elId = t.closest('.content-element')?.dataset.elementId;
        const qId = t.closest('.quiz-container-inner')?.dataset.quizId || actBtn.dataset.quizId;

        switch (act) {
            case 'edit-element': if (elId && !isStudent) openEditModal('element', elId); break; // Editor only
            case 'remove-element': if (elId && !isStudent) removeElementAction_Editor(elId); break; // Editor only
            case 'submit-quiz': if (qId) submitQuizAction_Editor(qId); break; // Allowed in both? (Submit only works if unanswered)
            case 'toggle-complete': // Handle Mark Complete Button Click
                 const sectionId = actBtn.dataset.sectionId;
                 const sectionType = actBtn.dataset.sectionType;
                 if (sectionId && sectionType) {
                     if (!isStudent || !actBtn.classList.contains('completed')) {
                         // Allow toggle in editor mode always, or in student mode only if NOT completed
                         toggleSectionCompletion(sectionId, sectionType);
                     }
                 }
                 break;
        }
    } else if (qOpt && !isStudent) { // Allow selecting quiz options only in editor mode (student mode handled by submit)
        selectQuizOption_Editor(qOpt);
    }
}


// --- Routing ---
function handleHashChange() {
    const hash = window.location.hash; console.log("Routing based on hash:", hash);
    teardownEventListeners_Editor();
    if (currentView === 'project' && !hash.startsWith('#/project/')) {
        if (projectView) {
             projectView.style.cssText = '';
             projectView.classList.remove('sidebar-minimized');
             projectView.classList.remove('student-mode'); // Reset student mode when leaving project
        }
        console.log("Reset project-specific styles & sidebar state on leaving project view.");
    }
    if (!hash || hash === '#') { showView('dashboard'); }
    else if (hash.startsWith('#/course/')) { const courseId = hash.substring('#/course/'.length); showView('course', courseId); }
    else if (hash.startsWith('#/project/')) { const projectId = hash.substring('#/project/'.length); showView('project', null, projectId); }
    else { console.warn(`Unknown hash "${hash}", redirecting to dashboard.`); showView('dashboard'); }
}

// --- Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Loaded. Initializing Application.");
    loadAppData();
    setupGlobalEventListeners();
    handleHashChange(); // Initial view load based on hash or default
});

</script>

</body>
</html>
