<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Editor & Viewer</title>
<style>
    /* --- Base Styles (Keep existing) --- */
    :root {
        --primary: #5E81F4;
        --secondary: #FF7AC6;
        --accent: #FFB800;
        --light: #F5F7FA;
        --dark: #1A1D28;
        --success: #7CE7AC;
        --danger: #FF7E7E;
    }
    html { scroll-behavior: smooth; box-sizing: border-box; }
    *, *:before, *:after { box-sizing: inherit; }
    body { font-family: 'Comic Sans MS', 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: var(--light); color: var(--dark); line-height: 1.6; font-size: 16px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
    h2 { color: var(--primary); border-bottom: 3px solid var(--secondary); padding-bottom: 8px; display: inline-block; font-size: 1.3rem; margin-top: 0; margin-bottom: 20px; }
    h3 { color: var(--dark); margin-top: 25px; margin-bottom: 10px; font-size: 1.15rem; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border-width: 0; }

    /* --- Header Styles (Slightly modified for Course/Project Context) --- */
    .page-header { /* Generic header for both views */
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        text-align: center;
        position: relative;
    }
    .page-header img.header-image { /* Class for header images */
        width: 120px; /* Slightly larger default */
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 3px solid white;
    }
    .page-header .header-title-container { flex-grow: 1; }
    .page-header .header-title { color: white; margin: 0 0 5px 0; font-size: 1.8rem; text-shadow: 1px 1px 3px rgba(0,0,0,0.2); }
    .page-header .header-subtitle { color: rgba(255, 255, 255, 0.9); font-size: 1rem; margin: 0; }

    /* --- Edit/Export Buttons --- */
    .edit-btn, .export-btn, .back-btn {
        position: absolute;
        top: 15px;
        background-color: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.5);
        width: 38px; /* Slightly larger */
        height: 38px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 19px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transition: background-color 0.3s, transform 0.2s;
        z-index: 10;
        text-decoration: none; /* For back button link */
    }
    .edit-btn:hover, .export-btn:hover, .back-btn:hover { background-color: rgba(255, 255, 255, 0.4); transform: scale(1.1); }
    .edit-btn { right: 15px; } /* Position relative to header */
    .export-btn { right: 65px; }
    .back-btn { left: 15px; font-size: 24px; /* Make arrow bigger */ }


    /* --- Course View Specific Styles --- */
    #course-view { animation: fadeIn 0.5s; }
    #course-description-container {
        background-color: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 25px;
        font-size: 1rem;
        line-height: 1.7;
    }
    #projectGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Responsive grid */
        gap: 20px;
        margin-top: 20px;
    }
    .project-tab {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.07);
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
    }
    .project-tab:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    .project-tab img {
        width: 100%;
        height: 200px; /* Fixed height for grid consistency */
        object-fit: cover;
        display: block;
    }
    .project-tab-info {
        padding: 15px;
        text-align: center;
        background-color: #fdfdff; /* Slightly different bg for info */
        flex-grow: 1; /* Allow info area to grow */
        display: flex;
        align-items: center; /* Center text vertically */
        justify-content: center; /* Center text horizontally */
    }
    .project-tab-info span {
        font-weight: bold;
        color: var(--primary);
        font-size: 1.05rem;
    }

    /* --- Project View Specific Styles (Container) --- */
    #project-view {
        /* Existing project styles will apply inside this */
         animation: fadeIn 0.5s;
    }
    /* Reuse page-header styles */
    #project-view .page-header .header-image { width: 100px; height: 100px; }
    #project-view .page-header .header-title { font-size: 1.6rem; }
    #project-view .page-header .header-subtitle { font-size: 0.95rem; }


    /* --- Keep Existing Project Content Styles --- */
    .progress-container{width:100%;background-color:#e0e0e0;border-radius:10px;margin:20px 0;height:10px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));border-radius:10px;width:0%;transition:width .5s ease-in-out}
    .tabs{display:flex;gap:8px;margin-bottom:15px;overflow-x:auto;padding-bottom:5px;-webkit-overflow-scrolling:touch}
    .tabs::-webkit-scrollbar{display:none}
    .tab{padding:8px 15px;background-color:#fff;border-radius:30px;cursor:pointer;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.05);white-space:nowrap;font-size:.9rem;flex-shrink:0;transition:background-color .3s,color .3s,transform .2s}
    .tab.active{background-color:var(--primary);color:#fff;transform:translateY(-2px)}
    .tab:hover:not(.active){background-color:#eef2ff;transform:translateY(-1px)}
    .tab-content{display:none;background-color:#fff;padding:20px;border-radius:15px;box-shadow:0 4px 12px rgba(0,0,0,.05);animation:fadeIn .5s ease-out;margin-bottom:20px}
    .tab-content.active{display:block}
    .video-container{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:15px 0;border-radius:10px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
    .video-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:10px;border:none}
    .slide{display:none;text-align:center}
    .slideshow{position:relative;margin:15px 0;background-color:#f9f9ff;padding:15px;border-radius:10px}
    .slide-content-wrapper{position:relative;padding-bottom:56.25%;height:0;overflow:hidden;margin:0 auto 15px;max-width:100%;background-color:#eee;border-radius:8px}
    .slide iframe,.slide img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);background-color:transparent}
    .slide p{margin:10px 0 0;font-size:.9rem;color:#555}
    .slide.active{display:block;animation:fadeIn .5s}
    .slide-nav{text-align:center;margin-top:15px;display:flex;justify-content:center;gap:10px}
    .slide-nav button{background-color:var(--primary);color:#fff;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:.9rem;transition:background-color .3s,transform .2s}
    .slide-nav button:hover{background-color:#4a6cdc;transform:scale(1.05)}
    .step{display:flex;gap:15px;margin-bottom:20px;padding:15px;background-color:#fdfdff;border-radius:10px;align-items:flex-start;border-left:5px solid var(--secondary);box-shadow:0 1px 4px rgba(0,0,0,.04)}
    .step-number{background-color:var(--secondary);color:#fff;min-width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;font-size:.9rem;margin-top:3px}
    .step-content{flex:1;display:flex;flex-direction:column}
    .step-content strong{font-size:1.05rem;color:var(--primary);display:block;margin-bottom:5px}
    .step-content p.description{margin:0 0 15px;font-size:.95rem;color:#333;line-height:1.5}
    .step-content p.description:last-child{margin-bottom:0}
    .step-content .step-media{margin-top:10px;max-width:100%;width:100%;overflow:hidden;border-radius:8px;background-color:#f0f0f0}
    .step-content .step-media img{display:block;max-width:100%;height:auto;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .step-content .step-media iframe{display:block;width:100%;aspect-ratio:16/9;border:none;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .quiz-question{background-color:#fdfdff;padding:20px;margin-bottom:15px;border-radius:10px;box-shadow:0 2px 8px rgba(94,129,244,.1);border:1px solid #e0e8ff}
    .quiz-question p.question-text{margin:0 0 15px;font-size:1rem;font-weight:700;color:var(--dark)}
    .quiz-options{margin-top:10px;display:flex;flex-direction:column;gap:8px}
    .quiz-option{display:block;padding:12px 15px;margin-bottom:0;background-color:#f5f7fa;border:1px solid #d8dde6;border-radius:8px;cursor:pointer;transition:all .3s ease;font-size:.9rem;position:relative;text-align:left;opacity:1}
    .quiz-option:hover{background-color:#e8ecf3;border-color:#c4cde0}
    .quiz-option.selected{border-color:var(--primary);background-color:#e8f0fe}
    .quiz-option.correct{background-color:var(--success);color:#fff;border-color:#63c899;font-weight:700}
    .quiz-option.correct.selected{background-color:var(--success);color:#fff;border-color:#63c899}
    .quiz-option.incorrect.selected{background-color:var(--danger);color:#fff;border-color:#e66a6a;font-weight:700;text-decoration:line-through;text-decoration-thickness:2px;border-color:#e66a6a!important}
    .quiz-question.answered .quiz-option:not(.selected):not(.correct){opacity:.6;cursor:default;background-color:#f5f7fa;border-color:#d8dde6;text-decoration:none}
    .quiz-question.answered .quiz-option.correct:not(.selected){opacity:1}
    .quiz-feedback{margin-top:12px;padding:10px 15px;border-radius:5px;display:none;font-size:.85rem;border-width:1px;border-style:solid}
    .quiz-feedback.correct{background-color:#e6f7ed;color:#1d6c45;border-color:#c3e6cb}
    .quiz-feedback.incorrect{background-color:#fde8e8;color:#9b1c1c;border-color:#f5c6cb}
    .final-quiz-result{margin-top:20px;padding:15px;border-radius:8px;text-align:center;font-weight:700;font-size:1.1rem}
    .final-quiz-result.success{background-color:#e6f7ed;color:#1d6c45;border:1px solid #c3e6cb}
    .final-quiz-result.fail{background-color:#fde8e8;color:#9b1c1c;border:1px solid #f5c6cb}
    .submit-btn{background-color:var(--accent);color:var(--dark);border:none;padding:12px 25px;border-radius:30px;font-weight:700;cursor:pointer;margin-top:25px;font-size:1rem;transition:all .3s;display:block;width:100%;max-width:250px;margin-left:auto;margin-right:auto;box-shadow:0 2px 5px rgba(0,0,0,.1)}
    .submit-btn:hover:not(:disabled){background-color:#ffc833;box-shadow:0 4px 8px rgba(0,0,0,.15);transform:translateY(-1px)}
    .submit-btn:disabled{background-color:#ccc;color:#666;cursor:not-allowed;box-shadow:none;transform:none;opacity:.7}


    /* --- Modal Styles (Generic - Keep Existing) --- */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,.6);z-index:1000;overflow-y:auto;padding:30px 0}
    .modal-content{background-color:#fff;margin:30px auto;padding:25px 30px;border-radius:10px;width:90%;max-width:800px;box-shadow:0 5px 15px rgba(0,0,0,.3);position:relative}
    .close-modal{position:absolute;top:10px;right:15px;font-size:28px;font-weight:700;color:#aaa;cursor:pointer;line-height:1;z-index:1001;padding:5px}
    .close-modal:hover{color:#333}
    .edit-form{margin-top:20px}
    .edit-form label{display:block;margin-bottom:5px;font-weight:700;color:var(--primary);font-size:.9rem}
    .edit-form input[type=text],.edit-form input[type=url],.edit-form textarea,.edit-form select{width:100%;padding:10px;margin-bottom:15px;border:1px solid #ccc;border-radius:5px;font-size:.9rem;box-sizing:border-box}
    .edit-form textarea{resize:vertical;min-height:60px}
    .edit-form button,button.remove-item-btn,button.add-item-btn{background-color:var(--primary);color:#fff;border:none;padding:10px 15px;border-radius:5px;cursor:pointer;margin-right:10px;margin-top:5px;font-size:.9rem;transition:background-color .3s}
    .edit-form button:hover,button.remove-item-btn:hover,button.add-item-btn:hover{background-color:#4a6cdc}
    button.remove-item-btn{background-color:var(--danger);margin-left:10px;font-weight:700;line-height:1;padding:6px 10px}
    button.remove-item-btn:hover{background-color:#e66a6a}
    button.add-item-btn{background-color:var(--success);display:block;margin-top:15px;margin-left:0;margin-right:0;width:-moz-fit-content;width:fit-content}
    button.add-item-btn:hover{background-color:#63c899}
    .edit-section{margin-top:20px;padding-top:15px;border-top:1px solid #eee}
    .edit-item-group{margin-bottom:20px;padding:15px;border:1px solid #ddd;border-radius:8px;background-color:#fdfdff;position:relative}
    .edit-item-group .remove-item-btn{position:absolute;top:10px;right:10px;font-size:1.2rem}
    .edit-item-group>label{font-weight:700;color:var(--dark);font-size:.95rem;margin-top:5px}
    .edit-item-group label{font-weight:400;color:#555;font-size:.85rem}
    .edit-item-group input[type=text],.edit-item-group input[type=url],.edit-item-group textarea,.edit-item-group select{margin-bottom:10px}
    .media-controls{margin-top:10px;padding-top:10px;border-top:1px dashed #eee}
    .media-controls label{font-weight:400;color:#555;font-size:.85rem}
    .media-url-input{margin-top:5px}
    .color-picker{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;align-items:center}
    .color-option{width:30px;height:30px;border-radius:50%;cursor:pointer;border:2px solid #ddd;transition:transform .2s,border-color .2s}
    .color-option.selected{border:3px solid #000;transform:scale(1.1)}
    input[type=color]{width:35px;height:35px;border:none;padding:0;border-radius:50%;overflow:hidden;cursor:pointer;vertical-align:middle}
    .font-selector{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
    .font-option{padding:5px 12px;border:1px solid #ddd;border-radius:4px;cursor:pointer;transition:background-color .3s,color .3s}
    .font-option.selected{background-color:var(--primary);color:#fff;border-color:var(--primary)}
    .size-selector{display:flex;gap:10px;align-items:center;margin-bottom:15px}
    .size-option{padding:5px 12px;border:1px solid #ddd;border-radius:4px;cursor:pointer;transition:background-color .3s,color .3s}
    .size-option.selected{background-color:var(--primary);color:#fff;border-color:var(--primary)}
    .incorrect-answer-label{font-size:.85rem;color:#777;margin-top:8px;font-weight:400}

     /* --- Course Editor Specific Styles --- */
     #courseEditModal #projectTabsEditor { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
     #projectTabsEditor h4 { margin-bottom: 15px; }
     #projectTabsList { max-height: 300px; overflow-y: auto; padding-right: 10px;} /* Scrollable list */
     .project-tab-edit-item {
         display: grid;
         grid-template-columns: auto 1fr auto; /* Index, Inputs, Remove Button */
         gap: 10px;
         align-items: center;
         padding: 10px;
         border: 1px solid #eee;
         border-radius: 5px;
         margin-bottom: 10px;
     }
      .project-tab-edit-item .index { font-weight: bold; }
      .project-tab-edit-item .inputs { display: flex; flex-direction: column; gap: 5px;}
      .project-tab-edit-item label { font-size: 0.8rem; margin-bottom: 2px;}
      .project-tab-edit-item input { padding: 6px; font-size: 0.85rem;}


    /* --- Media Queries (Keep Existing) --- */
    @media (min-width:768px){.page-header{flex-direction:row;text-align:left;align-items:center;padding:25px;gap:25px}.page-header img.header-image{width:150px;height:150px}.page-header .header-title{font-size:2rem}.page-header .header-subtitle{font-size:1.1rem}.step{align-items:center}.step-number{margin-top:0;width:35px;height:35px;font-size:1rem}.step-content .step-media{max-width:70%;margin-left:auto;margin-right:auto}#project-view .page-header img.header-image{width:120px;height:120px}#project-view .page-header .header-title{font-size:2rem}#project-view .page-header .header-subtitle{font-size:1rem}}
    @media (max-width:600px){.container{padding:10px}.page-header{padding:15px}.tab-content{padding:15px}.edit-btn{right:10px;top:10px}.export-btn{right:55px;top:10px}.back-btn{left:10px;top:10px}h2{font-size:1.2rem}.page-header .header-title{font-size:1.5rem}.page-header .header-subtitle{font-size:.9rem}.modal-content{padding:20px}.step-content .step-media{max-width:100%}#project-view .page-header .header-title{font-size:1.4rem}#project-view .page-header .header-subtitle{font-size:.9rem}}

</style>
</head>
<body>

<!-- Container for the whole application -->
<div class="container">

    <!-- == COURSE VIEW (Visible by default) == -->
    <div id="course-view">
        <div class="page-header" id="course-header">
             <button class="edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details">✏️</button>
             <button class="export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML">⬇️</button>
             <img src="" alt="Course Image" class="header-image" id="courseImage">
             <div class="header-title-container">
                 <h1 class="header-title" id="courseTitle">Course Title</h1>
                 <!-- Course subtitle/short desc could go here if needed -->
             </div>
        </div>

        <div id="course-description-container">
            <h2>About This Course</h2>
            <p id="courseDescription">Loading course description...</p>
        </div>

        <h2>Projects</h2>
        <div id="projectGrid">
            <!-- Project tabs will be dynamically inserted here -->
            <p>Loading projects...</p>
        </div>
    </div>

    <!-- == PROJECT VIEW (Hidden by default) == -->
    <div id="project-view" style="display: none;">
        <!-- Project Header (Populated Dynamically) -->
        <div class="page-header" id="project-header">
            <button class="back-btn" onclick="showCourseView()" aria-label="Back to Course">←</button>
            <button class="edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project">✏️</button>
            <!-- NO Export button here -->
            <img src="" alt="Project Image" class="header-image" id="projectImage">
            <div class="header-title-container">
                <h1 class="header-title" id="projectTitle">Project Title</h1>
                <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
            </div>
        </div>

        <!-- Existing Project Content Structure -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <div class="tabs" id="projectTabs">
            <!-- Project tabs (Overview, Video etc.) inserted dynamically -->
        </div>
        <div id="projectTabContentContainer">
            <!-- Project Tab Content (Overview, Video etc.) inserted dynamically -->
             <div id="overview" class="tab-content"><h2>Overview</h2><p id="overviewText"></p><h3>What You'll Learn</h3><div id="learnContainer"></div></div>
             <div id="video" class="tab-content"><h2>Video Lesson</h2><p id="videoIntroText"></p><h3 id="videoTitle"></h3><div class="video-container"><iframe src="" frameborder="0" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="mainVideo" title="Project Video"></iframe></div><h3>Key Points</h3><ul id="videoKeyPoints"></ul></div>
             <div id="slides" class="tab-content"><h2>Step-by-Step</h2><div class="slideshow" id="slideshowContainer"></div><div class="slide-nav"><button onclick="prevSlide()">Previous</button><button onclick="nextSlide()">Next</button></div></div>
             <div id="challenges" class="tab-content"><h2>Challenges</h2><p>Try these challenges:</p><div id="challengesContainer"></div></div>
             <div id="quiz" class="tab-content"><h2>Quiz</h2><p>Test your knowledge:</p><div id="quizContainer"></div><button class="submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz</button></div>
        </div>
    </div>

</div><!-- End .container -->


<!-- ==== MODALS ==== -->

<!-- == COURSE Editor Modal == -->
<div id="courseEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor">&times;</span>
        <h2>Edit Course Details</h2>
        <div class="edit-form">
            <div class="edit-section">
                <label for="editCourseTitle">Course Title:</label>
                <input type="text" id="editCourseTitle">

                <label for="editCourseImage">Course Header Image URL:</label>
                <input type="url" id="editCourseImage">

                <label for="editCourseDescription">Course Description:</label>
                <textarea id="editCourseDescription" rows="6"></textarea>
            </div>

            <!-- Project Tabs Editor -->
            <div id="projectTabsEditor" class="edit-section">
                 <h4>Manage Project Tabs</h4>
                 <div id="projectTabsList">
                     <!-- Project tab edit items will be listed here -->
                 </div>
                 <button type="button" class="add-item-btn" onclick="addProjectTabEditField()">Add New Project Tab</button>
            </div>


            <hr style="margin: 25px 0;">
            <button type="button" onclick="saveCourseChanges()" style="background-color: var(--success); margin-right: 15px;">Save Course Changes</button>
            <button type="button" onclick="closeModal('courseEditModal')" style="background-color: #aaa;">Cancel</button>
        </div>
    </div>
</div>


<!-- == PROJECT Editor Modal (Modified) == -->
<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor">&times;</span>
        <h2>Edit Project Details</h2>
         <p style="font-size: 0.85rem; color: #666;">Editing project: <strong id="editingProjectNameLabel"></strong></p>
        <div class="edit-form">
             <input type="hidden" id="editingProjectId"> <!-- Store ID of project being edited -->

            <label for="editSectionProject">Select Section to Edit:</label>
            <select id="editSectionProject" onchange="showProjectEditSection()">
                <option value="projTitle">Project Title & Image</option>
                <option value="projTab">Project Tab Appearance</option> <!-- New section -->
                <option value="overview">Overview Text</option>
                <option value="learn">What You'll Learn</option>
                <option value="video">Video Lesson</option>
                <option value="slides">Step-by-Step Slides</option>
                <option value="challenges">Challenges</option>
                <option value="quiz">Quiz Questions</option>
                <option value="style">Style & Colors</option>
            </select>

            <!-- === Project Title Edit (Project Modal) === -->
            <div id="projTitleEdit" class="edit-section">
                <label for="editProjectTitle">Project Title:</label>
                <input type="text" id="editProject_Title"> <!-- Use unique IDs -->

                <label for="editProjectSubtitle">Subtitle:</label>
                <input type="text" id="editProject_Subtitle">

                <label for="editProjectHeaderImage">Project Header Image URL:</label>
                <input type="url" id="editProject_HeaderImage">
                <p style="font-size: 0.8rem; color: #666;">Appears in the project page header. Recommended: ~100x100px.</p>
            </div>

             <!-- === Project Tab Appearance Edit (Project Modal) === -->
             <div id="projTabEdit" class="edit-section" style="display:none;">
                  <label for="editProjectTabName">Tab Name (on Course Page):</label>
                  <input type="text" id="editProject_TabName">

                  <label for="editProjectTabImage">Tab Image URL (on Course Page):</label>
                  <input type="url" id="editProject_TabImage">
                  <p style="font-size: 0.8rem; color: #666;">Square image recommended (e.g., 300x300px).</p>
             </div>


            <!-- === Overview Edit (Project Modal) === -->
            <div id="overviewEdit" class="edit-section" style="display:none;">
                <label for="editProject_OverviewText">Overview Text:</label>
                <textarea id="editProject_OverviewText" rows="5"></textarea>
            </div>

            <!-- === Learn Edit (Project Modal) === -->
            <div id="learnEdit" class="edit-section" style="display:none;">
                <h3>"What You'll Learn" Items</h3>
                <div id="learnEditContainer"> <!-- Populated by loadLearnEditFields --> </div>
                <button type="button" class="add-item-btn" onclick="addLearnEditField()">Add Learning Item</button>
            </div>

            <!-- === Video Edit (Project Modal) === -->
            <div id="videoEdit" class="edit-section" style="display:none;">
                 <label for="editProject_VideoIntroText">Introduction Text:</label>
                 <input type="text" id="editProject_VideoIntroText">
                 <label for="editProject_VideoTitle">Video Section Title:</label>
                 <input type="text" id="editProject_VideoTitle">
                 <label for="editProject_VideoUrl">Video Embed URL:</label>
                 <input type="url" id="editProject_VideoUrl">
                 <label for="editProject_VideoKeyPoints">Key Points (one per line):</label>
                 <textarea id="editProject_VideoKeyPoints" rows="5"></textarea>
            </div>

            <!-- === Slides Edit (Project Modal) === -->
            <div id="slidesEdit" class="edit-section" style="display:none;">
                <h3>Step-by-Step Slides</h3>
                <div id="slidesEditContainer"> <!-- Populated by loadSlidesEditFields --> </div>
                <button type="button" class="add-item-btn" onclick="addSlideEditField()">Add Slide</button>
            </div>

            <!-- === Challenges Edit (Project Modal) === -->
            <div id="challengesEdit" class="edit-section" style="display:none;">
                <h3>Project Challenges</h3>
                <div id="challengesEditContainer"> <!-- Populated by loadChallengesEditFields --> </div>
                <button type="button" class="add-item-btn" onclick="addChallengeEditField()">Add Challenge</button>
            </div>

            <!-- === Quiz Edit (Project Modal) === -->
            <div id="quizEdit" class="edit-section" style="display:none;">
                <h3>Quiz Questions</h3>
                 <div id="quizEditContainer"> <!-- Populated by loadQuizEditFields --> </div>
                 <button type="button" class="add-item-btn" onclick="addQuizEditField()">Add Question</button>
            </div>

            <!-- === Style Edit (Project Modal) === -->
            <div id="styleEdit" class="edit-section" style="display:none;">
                 <h4>Theme Colors (Project Specific)</h4>
                 <label>Primary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectColor('primary', this.style.backgroundColor)"></div>
                     <input type="color" id="primaryColorPicker" oninput="customColorSelected('primary', this.value)" aria-label="Custom Primary Color">
                 </div>
                 <label>Secondary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectColor('secondary', this.style.backgroundColor)"></div>
                     <input type="color" id="secondaryColorPicker" oninput="customColorSelected('secondary', this.value)" aria-label="Custom Secondary Color">
                 </div>
                 <label>Accent Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectColor('accent', this.style.backgroundColor)"></div>
                     <input type="color" id="accentColorPicker" oninput="customColorSelected('accent', this.value)" aria-label="Custom Accent Color">
                 </div>
                 <h4>Typography (Project Specific)</h4>
                 <label>Font Family:</label>
                 <div class="font-selector">
                     <div class="font-option" onclick="selectFont('Comic Sans MS, Segoe UI, sans-serif')" style="font-family: 'Comic Sans MS', sans-serif;">Comic Sans</div>
                     <!-- Add other font options -->
                     <div class="font-option" onclick="selectFont('Arial, Helvetica, sans-serif')" style="font-family: Arial, sans-serif;">Arial</div>
                 </div>
                 <label>Base Text Size:</label>
                 <div class="size-selector">
                     <div class="size-option" onclick="selectSize('small')">Small</div>
                     <div class="size-option selected" onclick="selectSize('medium')">Medium</div>
                     <div class="size-option" onclick="selectSize('large')">Large</div>
                 </div>
            </div>

            <hr style="margin: 25px 0;">
            <button type="button" onclick="saveProjectChanges()" style="background-color: var(--success); margin-right: 15px;">Save Project Changes</button>
            <button type="button" onclick="closeModal('projectEditModal')" style="background-color: #aaa;">Cancel</button>
        </div>
    </div>
</div>


<script>
    // --- Global Data Storage ---
    let courseData = {
        title: "Micro:bit Adventures",
        description: "Explore the exciting world of physical computing with the BBC micro:bit! This course contains several projects to get you started.",
        imageUrl: "https://images.unsplash.com/photo-1619410283995-43d9134e7656?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8NXx8cHJvZ3JhbW1pbmd8ZW58MHx8MHx8fDA%3D&auto=format&fit=crop&w=500&q=60", // Placeholder course image
        projects: [
            // Project 1 Data (Structure mirroring previous single project)
            {
                id: 'proj_heart', // Unique ID for this project
                tabName: "Beating Heart",
                tabImage: "https://www.elecfreaks.com/wp-content/uploads/2022/12/2-1.png", // Image for the course page tab
                // --- All the project-specific data from previous version ---
                projectTitle: "Beating Heart Project",
                projectSubtitle: "Make your Micro:bit display a beating heart animation!",
                projectHeaderImage: "https://www.elecfreaks.com/wp-content/uploads/2022/12/2-1.png", // Image for the project page header
                overviewText: "In this project, you'll learn how to create a beating heart animation on your Micro:bit's LED display. This is a great first project to understand how the Micro:bit works!",
                videoIntroText: "Watch this video to learn how to create the beating heart animation:",
                videoTitle: "Programming the Beating Heart",
                videoUrl: "https://www.youtube.com/embed/2yzT7_QGLLc",
                videoKeyPoints: ["LED matrix is 5x5", "'on start' vs 'forever'", "Use 'pause' for timing"],
                learnData: [ { title: "Hardware Basics", description: "LED matrix and flashing code.", mediaType: 'none', mediaUrl: '' }, /* ... more learn items ... */ ],
                slidesData: [ { url: "...", description: "...", type: "iframe" }, /* ... more slides ... */ ],
                challengesData: [ { title: "Faster/Slower?", description: "Change pause times.", mediaType: 'none', mediaUrl: '' }, /* ... more challenges ... */ ],
                quizData: [ { questionText: "...", correctAnswer: "...", incorrectAnswers: ["..."] }, /* ... more questions ... */ ],
                style: { primaryColor: '#5E81F4', secondaryColor: '#FF7AC6', accentColor: '#FFB800', fontFamily: 'Comic Sans MS, Segoe UI, sans-serif', baseSize: 'medium' }
            },
            // Project 2 Data (Placeholder)
            {
                 id: 'proj_smiley',
                 tabName: "Smiley Buttons",
                 tabImage: "https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png",
                 projectTitle: "Smiley Buttons Project",
                 projectSubtitle: "Show different faces when buttons are pressed.",
                 projectHeaderImage: "https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png",
                 overviewText: "Learn how to react to button presses.",
                 videoUrl: "", // Add relevant URLs
                 videoKeyPoints: [],
                 learnData: [],
                 slidesData: [],
                 challengesData: [],
                 quizData: [],
                 style: { primaryColor: '#7CE7AC', secondaryColor: '#FFB800', accentColor: '#5E81F4', fontFamily: 'Arial, Helvetica, sans-serif', baseSize: 'medium' }
             }
             // Add more project objects here
        ]
    };

    // State variable to track the currently viewed project ID
    let currentProjectId = null;
    let currentProjectDataCache = null; // Cache for faster access

    // --- Constants for limits ---
    const MAX_PROJECTS = 9; // e.g., 3x3 grid max
    const MAX_SLIDES = 10;
    const MAX_CHALLENGES = 10;
    const MAX_LEARN_ITEMS = 8;
    const MAX_QUIZ_QUESTIONS = 10;
    const MAX_INCORRECT_ANSWERS = 3;


    // --- VIEW NAVIGATION ---
    function showCourseView() {
        document.getElementById('course-view').style.display = 'block';
        document.getElementById('project-view').style.display = 'none';
        currentProjectId = null; // No project is active
        currentProjectDataCache = null;
        document.title = courseData.title || "Course Viewer"; // Update page title
        window.scrollTo(0, 0); // Scroll to top
         // Optional: Use history API for back button support
         // history.pushState({ view: 'course' }, '', '#course');
    }

    function showProjectView(projectId) {
        const project = courseData.projects.find(p => p.id === projectId);
        if (!project) {
            console.error(`Project with ID ${projectId} not found!`);
            showCourseView(); // Go back to course if project doesn't exist
            return;
        }

        currentProjectId = projectId;
        currentProjectDataCache = project; // Cache the found project data

        renderProjectPage(project); // Populate the project view template

        document.getElementById('course-view').style.display = 'none';
        document.getElementById('project-view').style.display = 'block';
        document.title = project.projectTitle || "Project Viewer"; // Update page title
        window.scrollTo(0, 0); // Scroll to top
         // Optional: Use history API
         // history.pushState({ view: 'project', id: projectId }, '', `#project-${projectId}`);
    }


    // --- COURSE PAGE RENDERING ---
    function renderCoursePage() {
        console.log("Rendering Course Page");
        const course = courseData; // Use the global courseData

        // Update Course Header
        document.getElementById('courseTitle').textContent = course.title;
        document.getElementById('courseImage').src = course.imageUrl || ''; // Handle missing image
        document.getElementById('courseImage').alt = course.title + " Image";
        document.getElementById('courseDescription').textContent = course.description;

        // Update Project Grid
        const grid = document.getElementById('projectGrid');
        grid.innerHTML = ''; // Clear existing grid items

        if (!course.projects || course.projects.length === 0) {
            grid.innerHTML = '<p>No projects have been added to this course yet.</p>';
            return;
        }

        course.projects.forEach(project => {
            if (!project || !project.id) return; // Skip invalid projects

            const tab = document.createElement('a'); // Use links for better semantics
            tab.className = 'project-tab';
            tab.href = `#project-${project.id}`; // Link for potential JS routing/fallback
            tab.onclick = (event) => {
                event.preventDefault(); // Prevent default link behavior
                showProjectView(project.id);
            };

            const img = document.createElement('img');
            img.src = project.tabImage || 'https://via.placeholder.com/300x200/eee/999?text=Project'; // Placeholder
            img.alt = project.tabName || 'Project Tab';
            img.loading = 'lazy';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-tab-info';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = project.tabName || 'Unnamed Project';
            infoDiv.appendChild(nameSpan);

            tab.appendChild(img);
            tab.appendChild(infoDiv);
            grid.appendChild(tab);
        });
    }


    // --- PROJECT PAGE RENDERING ---
    function renderProjectPage(project) {
        console.log("Rendering Project:", project?.projectTitle);
        if (!project) {
             console.error("renderProjectPage called with null project");
             // Optionally display an error in the project view
             document.getElementById('project-view').innerHTML = '<p>Error loading project data.</p>';
             return;
         }

        // Apply Project Specific Styles First (so they are overridden by general styles if needed)
        applyProjectStyles(project.style);

        // Populate Project Header
        const projectHeader = document.getElementById('project-header');
        if (projectHeader) {
            projectHeader.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || ''; // Fallback to tab image
            projectHeader.querySelector('#projectImage').alt = project.projectTitle + " Header Image";
            projectHeader.querySelector('#projectTitle').textContent = project.projectTitle;
            projectHeader.querySelector('#projectSubtitle').textContent = project.projectSubtitle;
        }

        // -- Populate Project Tabs & Content --
        // Get references to containers within the #project-view
        const projectTabsContainer = document.getElementById('projectTabs');
        const projectTabContentContainer = document.getElementById('projectTabContentContainer');
        if (!projectTabsContainer || !projectTabContentContainer) {
             console.error("Project tab containers not found!");
             return;
        }

        // **Important:** We assume the basic tab structure (Overview, Video, etc.)
        // is *fixed* in the HTML within #project-view. We just populate the content inside.

        // Populate Overview Tab
        const overviewContent = projectTabContentContainer.querySelector('#overview');
        if (overviewContent) {
            overviewContent.querySelector('#overviewText').textContent = project.overviewText || '';
            renderLearnItemsForProject(project.learnData || [], overviewContent.querySelector('#learnContainer'));
        }

        // Populate Video Tab
        const videoContent = projectTabContentContainer.querySelector('#video');
        if (videoContent) {
            videoContent.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
            videoContent.querySelector('#videoTitle').textContent = project.videoTitle || '';
            videoContent.querySelector('#mainVideo').src = project.videoUrl || '';
            const keyPointsUL = videoContent.querySelector('#videoKeyPoints');
            keyPointsUL.innerHTML = ''; // Clear old points
             (project.videoKeyPoints || []).forEach(p => {
                  const li = document.createElement('li');
                  li.textContent = p;
                  keyPointsUL.appendChild(li);
             });
        }

        // Populate Slides Tab
        const slidesContent = projectTabContentContainer.querySelector('#slides');
        if (slidesContent) {
            renderSlideshowForProject(project.slidesData || [], slidesContent.querySelector('#slideshowContainer'));
        }

        // Populate Challenges Tab
        const challengesContent = projectTabContentContainer.querySelector('#challenges');
        if (challengesContent) {
            renderChallengesForProject(project.challengesData || [], challengesContent.querySelector('#challengesContainer'));
        }

        // Populate Quiz Tab
        const quizContent = projectTabContentContainer.querySelector('#quiz');
        if (quizContent) {
             renderQuizForProject(project.quizData || [], quizContent.querySelector('#quizContainer'), quizContent.querySelector('#submitQuizBtn'));
        }


        // Reset progress bar and activate the first project tab (e.g., Overview)
        const firstProjectTabButton = projectTabsContainer.querySelector('.tab');
        if (firstProjectTabButton) {
             const clickAttr = firstProjectTabButton.getAttribute('onclick') || '';
              const match = clickAttr.match(/openProjectTab\('([^']+)'/);
              const firstTabName = match ? match[1] : null;
              if (firstTabName) {
                   openProjectTab(firstTabName, firstProjectTabButton); // Activate first tab visually
              }
        } else {
             // Fallback if no tabs defined in HTML
             const firstProjectTabContent = projectTabContentContainer.querySelector('.tab-content');
             if (firstProjectTabContent) firstProjectTabContent.classList.add('active');
             updateProjectProgressBar(''); // Reset progress
        }
    }

    // --- Project Specific Rendering Helpers (called by renderProjectPage) ---
     function renderLearnItemsForProject(learnItemsData, container) {
         if (!container) return;
         container.innerHTML = '';
         const validItems = learnItemsData.filter(item => item.title && item.title.trim() !== '');
         if (validItems.length === 0) { container.innerHTML = '<p>Learning objectives will be listed here.</p>'; return; }

         validItems.forEach((item, index) => {
             const el = document.createElement('div'); el.className = 'step';
             el.innerHTML = `<div class="step-number">${index + 1}</div>
                             <div class="step-content">
                                 <strong></strong>
                                 <p class="description"></p>
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
             const descP = el.querySelector('p.description');
             if (item.description) { descP.textContent = item.description; } else { descP.remove(); }

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl) {
                 mediaDiv.style.display = 'block';
                 if (item.mediaType === 'image') {
                     mediaDiv.innerHTML = `<img src="${item.mediaUrl}" loading="lazy" alt="${item.title} Media">`;
                 } else if (item.mediaType === 'video') {
                     mediaDiv.innerHTML = `<iframe src="${item.mediaUrl}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${item.title} Media"></iframe>`;
                 }
             }
             container.appendChild(el);
         });
     }

    function renderChallengesForProject(challengesItemsData, container) {
         if (!container) return;
         container.innerHTML = '';
         const validItems = challengesItemsData.filter(item => item.title && item.title.trim() !== '');
         if (validItems.length === 0) { container.innerHTML = '<p>No challenges available for this project.</p>'; return; }

         validItems.forEach((item) => { // Index not needed for '★'
             const el = document.createElement('div'); el.className = 'step';
             el.innerHTML = `<div class="step-number">★</div>
                              <div class="step-content">
                                 <strong></strong>
                                 <p class="description"></p>
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
             const descP = el.querySelector('p.description');
             if (item.description) { descP.textContent = item.description; } else { descP.remove(); }

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl) {
                 mediaDiv.style.display = 'block';
                 if (item.mediaType === 'image') {
                     mediaDiv.innerHTML = `<img src="${item.mediaUrl}" loading="lazy" alt="${item.title} Media">`;
                 } else if (item.mediaType === 'video') {
                      mediaDiv.innerHTML = `<iframe src="${item.mediaUrl}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${item.title} Media"></iframe>`;
                 }
             }
             container.appendChild(el);
         });
    }

     function renderSlideshowForProject(slidesItemsData, container) {
         const nav = container?.parentElement?.querySelector('.slide-nav'); // Find nav relative to slideshow container
         if (!container || !nav) return;
         container.innerHTML = '';
         const validSlides = slidesItemsData.filter(slide => slide.url && slide.url.trim() !== '');

         if (validSlides.length === 0) {
             container.innerHTML = '<p>No slides available.</p>';
             nav.style.display = 'none'; return;
         }
         nav.style.display = 'flex';

         validSlides.forEach((slide, index) => {
             const slideDiv = document.createElement('div'); slideDiv.className = 'slide';
             slideDiv.innerHTML = `<div class="slide-content-wrapper"></div>
                                   <p></p>`; // Structure
             const wrapper = slideDiv.querySelector('.slide-content-wrapper');
             const caption = slideDiv.querySelector('p');

             if (slide.type === 'iframe') {
                 wrapper.innerHTML = `<iframe src="${slide.url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${slide.description || `Slide ${index + 1}`}"></iframe>`;
             } else if (slide.type === 'image') {
                 wrapper.innerHTML = `<img src="${slide.url}" loading="lazy" alt="${slide.description || `Slide ${index + 1}`}">`;
             }
             if (slide.description) { caption.textContent = slide.description; } else { caption.remove(); }
             container.appendChild(slideDiv);
         });
         currentSlideIndex = 0;
         showSlide(currentSlideIndex); // Show first slide
     }

      function renderQuizForProject(quizItemsData, container, submitBtn) {
          if (!container || !submitBtn) return;
          container.innerHTML = '';
          container.querySelector('.final-quiz-result')?.remove(); // Clear previous result
          submitBtn.disabled = false;
          submitBtn.style.display = 'none';

          const validQuestions = (quizItemsData || []).filter(q => q.questionText && q.correctAnswer);
          if (validQuestions.length === 0) {
              container.innerHTML = '<p>No quiz questions available.</p>'; return;
          }
          submitBtn.style.display = 'block';

          validQuestions.forEach((q, index) => {
               // ... (Quiz rendering logic - same as previous renderQuiz, just uses quizItemsData) ...
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;"></div><div class="quiz-feedback incorrect" style="display:none;"></div>`;

                questionDiv.querySelector('.question-text').textContent = `${index + 1}. ${q.questionText}`;
                const optionsDiv = questionDiv.querySelector('.quiz-options');
                let options = [q.correctAnswer, ...(q.incorrectAnswers || []).filter(ans => ans && ans.trim() !== '')];
                shuffleArray(options);

                options.forEach((optionText) => {
                    const isCorrect = (optionText === q.correctAnswer);
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = optionText;
                    optionEl.setAttribute('role', 'button');
                    optionEl.setAttribute('tabindex', '0');
                    optionEl.onclick = () => selectQuizOption(optionEl); // Uses the global selectQuizOption
                    optionEl.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(optionEl); }};
                    optionEl.setAttribute('data-is-correct', isCorrect.toString());
                    optionsDiv.appendChild(optionEl);
                });
               container.appendChild(questionDiv);
          });
      }

    // --- Project-Specific Tab/Progress/Slides/Quiz Interaction ---
    // These functions now operate within the context of the #project-view
    function openProjectTab(tabName, element) {
        const container = document.getElementById('projectTabContentContainer');
        if (!container) return;
        container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

        const buttonsContainer = document.getElementById('projectTabs');
        if (buttonsContainer) {
            buttonsContainer.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        }

        const targetContent = container.querySelector('#' + tabName); // Find content within project view
        if (targetContent) targetContent.classList.add('active');
        element?.classList.add('active');

        updateProjectProgressBar(tabName);
    }

    function updateProjectProgressBar(tabName) {
         // Assumes the standard project tab order within #projectTabs
         const progressBar = document.getElementById('progressBar'); // The single progress bar
         if (!progressBar) return;

         let progress = 0;
         const tabOrder = ['overview', 'video', 'slides', 'challenges', 'quiz'];
         const tabIndex = tabOrder.indexOf(tabName);
         if (tabIndex >= 0) {
             progress = ((tabIndex + 1) / tabOrder.length) * 100;
         }
         progressBar.style.width = progress + '%';
    }

    // showSlide, nextSlide, prevSlide remain largely the same, operating on #slideshowContainer within #project-view
    let currentSlideIndex = 0; // Reset when project changes in renderSlideshowForProject
     function showSlide(n) {
        const slides = document.querySelectorAll('#project-view #slideshowContainer .slide'); // Scope to project view
        const validSlidesCount = slides.length;
        if (validSlidesCount === 0) return;
        slides.forEach(slide => slide.classList.remove('active'));
        currentSlideIndex = (n % validSlidesCount + validSlidesCount) % validSlidesCount;
        if(slides[currentSlideIndex]) slides[currentSlideIndex].classList.add('active');
    }
    function nextSlide() { showSlide(currentSlideIndex + 1); }
    function prevSlide() { showSlide(currentSlideIndex - 1); }

    // selectQuizOption and submitQuiz remain largely the same, operating on #quizContainer within #project-view
    function selectQuizOption(optionElement) {
        const questionDiv = optionElement.closest('.quiz-question');
        if (!questionDiv || questionDiv.classList.contains('answered')) return;
        questionDiv.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
        optionElement.classList.add('selected');
    }
    function submitQuiz() {
         // Logic is identical to previous version, targets elements within #project-view's #quizContainer
         const questions = document.querySelectorAll('#project-view #quizContainer .quiz-question'); // Scope query
         let answeredCount = 0;
         let score = 0;
         const totalQuestions = questions.length;
         if (totalQuestions === 0) return;
         let firstUnanswered = null;

         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              // Reset visual state first
              qDiv.classList.remove('answered');
              qDiv.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none');
              qDiv.querySelectorAll('.quiz-option').forEach(opt => {
                   opt.classList.remove('correct', 'incorrect');
                   opt.style.opacity = '1'; opt.style.cursor = 'pointer';
                   opt.onclick = () => selectQuizOption(opt);
                   opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); }};
              });

              if (selectedOption) { answeredCount++; } else if (!firstUnanswered) { firstUnanswered = qDiv; }
         });

         if (answeredCount < totalQuestions) {
             alert(`Please answer all ${totalQuestions} questions!`);
             if(firstUnanswered) { /* Highlight/scroll */ firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});firstUnanswered.style.outline='2px solid red';setTimeout(()=>{if(firstUnanswered)firstUnanswered.style.outline='none';},2000); }
             return;
         }

         // All answered, show results
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              const feedbackCorrect = qDiv.querySelector('.quiz-feedback.correct');
              const feedbackIncorrect = qDiv.querySelector('.quiz-feedback.incorrect');
              const allOptions = qDiv.querySelectorAll('.quiz-option');
              qDiv.classList.add('answered');
              const isCorrect = selectedOption.getAttribute('data-is-correct') === 'true';

              allOptions.forEach(opt => {
                   const optIsCorrect = opt.getAttribute('data-is-correct') === 'true';
                   if (optIsCorrect) opt.classList.add('correct');
                   if (opt.classList.contains('selected')) { if (!isCorrect) opt.classList.add('incorrect'); }
                   else if (!optIsCorrect) { opt.style.opacity = "0.6"; }
                   opt.style.cursor = "default"; opt.onclick = null; opt.onkeydown = null;
              });

              if (isCorrect) { score++; if(feedbackCorrect){ feedbackCorrect.textContent='Correct!'; feedbackCorrect.style.display='block'; }}
              else { if(feedbackIncorrect){ const correctOpt = qDiv.querySelector('.quiz-option.correct'); feedbackIncorrect.textContent = `Not quite. Correct: "${correctOpt?correctOpt.textContent:'?'}"`; feedbackIncorrect.style.display='block'; } }
         });

         const submitBtn = document.querySelector('#project-view #submitQuizBtn'); // Scope query
         if(submitBtn) submitBtn.disabled = true;

         const resultContainer = document.querySelector('#project-view #quizContainer'); // Scope query
         let resultDiv = resultContainer?.querySelector('.final-quiz-result');
          if (!resultDiv && resultContainer) { resultDiv = document.createElement('div'); resultDiv.className = 'final-quiz-result'; resultContainer.appendChild(resultDiv); }
          if (resultDiv) {
              resultDiv.textContent = `Quiz Complete! Score: ${score}/${totalQuestions}`;
              const scorePercent = totalQuestions > 0 ? score / totalQuestions : 0;
              resultDiv.className = 'final-quiz-result ' + (scorePercent >= 0.7 ? 'success' : 'fail');
              resultDiv.style.display = 'block';
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
    }

    // --- Apply Project Styles ---
    function applyProjectStyles(styleData) {
         // Apply styles to the project view container or elements within it
         // This version just sets CSS variables scoped potentially, or globally
         // A more robust solution might scope styles better (e.g., add a class to #project-view)
         const root = document.documentElement; // Apply globally for simplicity here
         root.style.setProperty('--primary', styleData?.primaryColor || '#5E81F4');
         root.style.setProperty('--secondary', styleData?.secondaryColor || '#FF7AC6');
         root.style.setProperty('--accent', styleData?.accentColor || '#FFB800');
         root.style.fontFamily = styleData?.fontFamily || 'Comic Sans MS, Segoe UI, sans-serif';
         let baseSize = '16px';
         if (styleData?.baseSize === 'small') baseSize = '14px';
         else if (styleData?.baseSize === 'large') baseSize = '18px';
         root.style.fontSize = baseSize;
    }


    // --- MODAL & EDITING LOGIC ---

    // General Modal Controls
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.style.display = 'none';
    }

    // --- Course Editor ---
    function openCourseEditModal() {
         const modal = document.getElementById('courseEditModal');
         if (!modal) return;

         // Load course data
         modal.querySelector('#editCourseTitle').value = courseData.title;
         modal.querySelector('#editCourseImage').value = courseData.imageUrl;
         modal.querySelector('#editCourseDescription').value = courseData.description;

         // Load project tabs list
         renderProjectTabsEditor();

         modal.style.display = 'block';
    }

     function renderProjectTabsEditor() {
         const listContainer = document.getElementById('projectTabsList');
         if (!listContainer) return;
         listContainer.innerHTML = ''; // Clear list

         courseData.projects.forEach((project, index) => {
             const itemDiv = document.createElement('div');
             itemDiv.className = 'project-tab-edit-item';
             itemDiv.setAttribute('data-project-id', project.id); // Store ID

             itemDiv.innerHTML = `
                 <span class="index">${index + 1}.</span>
                 <div class="inputs">
                     <label for="tab-name-${project.id}">Tab Name:</label>
                     <input type="text" id="tab-name-${project.id}" class="edit-tab-name" value="${project.tabName || ''}">
                     <label for="tab-image-${project.id}">Tab Image URL:</label>
                     <input type="url" id="tab-image-${project.id}" class="edit-tab-image" value="${project.tabImage || ''}">
                 </div>
                 <button type="button" class="remove-item-btn" onclick="removeProjectTab('${project.id}')" aria-label="Remove Project ${index + 1}">&times;</button>
             `;
             listContainer.appendChild(itemDiv);
         });
     }

     function addProjectTabEditField() {
          if (courseData.projects.length >= MAX_PROJECTS) {
              alert(`Maximum of ${MAX_PROJECTS} projects allowed.`);
              return;
          }
          // Create a new basic project structure
          const newProjectId = `proj_${Date.now()}`; // Simple unique ID
          const newProject = {
              id: newProjectId,
              tabName: "New Project",
              tabImage: "",
              projectTitle: "New Project Title",
              projectSubtitle: "A new Micro:bit adventure",
              projectHeaderImage: "",
              overviewText: "Edit this overview...",
              videoUrl: "", videoKeyPoints: [], learnData: [], slidesData: [], challengesData: [], quizData: [],
              // Inherit default styles or course styles? Let's use defaults.
              style: { primaryColor: '#5E81F4', secondaryColor: '#FF7AC6', accentColor: '#FFB800', fontFamily: 'Comic Sans MS, Segoe UI, sans-serif', baseSize: 'medium' }
          };
          courseData.projects.push(newProject);
          renderProjectTabsEditor(); // Re-render the list in the editor
          // Scroll to the new item?
          document.getElementById('projectTabsList')?.lastElementChild?.scrollIntoView();
     }

     function removeProjectTab(projectIdToRemove) {
          if (!confirm(`Are you sure you want to remove project tab "${courseData.projects.find(p=>p.id===projectIdToRemove)?.tabName || projectIdToRemove}"? This cannot be undone.`)) {
               return;
          }
          courseData.projects = courseData.projects.filter(p => p.id !== projectIdToRemove);
          renderProjectTabsEditor(); // Re-render the list
     }


    function saveCourseChanges() {
         // Save course details
         courseData.title = document.getElementById('editCourseTitle')?.value.trim() || courseData.title;
         courseData.imageUrl = document.getElementById('editCourseImage')?.value.trim() || courseData.imageUrl;
         courseData.description = document.getElementById('editCourseDescription')?.value.trim() || courseData.description;

         // Save changes to project tab names/images
         const tabEditItems = document.querySelectorAll('#projectTabsList .project-tab-edit-item');
         tabEditItems.forEach(item => {
             const projectId = item.getAttribute('data-project-id');
             const project = courseData.projects.find(p => p.id === projectId);
             if (project) {
                 project.tabName = item.querySelector('.edit-tab-name')?.value.trim() || project.tabName;
                 project.tabImage = item.querySelector('.edit-tab-image')?.value.trim() || project.tabImage;
             }
         });

         renderCoursePage(); // Update the main course page display
         closeModal('courseEditModal');
         alert("Course changes saved!");
    }


    // --- Project Editor ---
    function openProjectEditModal() {
         const modal = document.getElementById('projectEditModal');
         if (!modal || !currentProjectId || !currentProjectDataCache) {
              console.error("Cannot open project editor: No project selected or modal not found.");
              return;
          }
         const project = currentProjectDataCache; // Use the cached project data

         // Store the ID and show which project is being edited
         modal.querySelector('#editingProjectId').value = project.id;
         modal.querySelector('#editingProjectNameLabel').textContent = project.projectTitle || project.tabName;

         // Load project title/header data
         modal.querySelector('#editProject_Title').value = project.projectTitle || '';
         modal.querySelector('#editProject_Subtitle').value = project.projectSubtitle || '';
         modal.querySelector('#editProject_HeaderImage').value = project.projectHeaderImage || '';

          // Load project tab appearance data
          modal.querySelector('#editProject_TabName').value = project.tabName || '';
          modal.querySelector('#editProject_TabImage').value = project.tabImage || '';

         // Load other project sections (Overview, Video, etc.)
         modal.querySelector('#editProject_OverviewText').value = project.overviewText || '';
         modal.querySelector('#editProject_VideoIntroText').value = project.videoIntroText || '';
         modal.querySelector('#editProject_VideoTitle').value = project.videoTitle || '';
         modal.querySelector('#editProject_VideoUrl').value = project.videoUrl || '';
         modal.querySelector('#editProject_VideoKeyPoints').value = (project.videoKeyPoints || []).join('\n');

         // Load dynamic list data into their respective editor containers
         // We need copies of the data loading functions, scoped to the project modal's containers
         loadLearnEditFieldsForProject(project.learnData || [], modal.querySelector('#learnEditContainer'));
         loadSlidesEditFieldsForProject(project.slidesData || [], modal.querySelector('#slidesEditContainer'));
         loadChallengesEditFieldsForProject(project.challengesData || [], modal.querySelector('#challengesEditContainer'));
         loadQuizEditFieldsForProject(project.quizData || [], modal.querySelector('#quizEditContainer'));

         // Load project-specific styles
         loadStyleSelectionsForProject(project.style || {}, modal); // Pass modal context if needed

         modal.style.display = 'block';
         showProjectEditSection(); // Show the default section
    }

     // Need copies of dynamic field loaders scoped to project editor modal
     function loadLearnEditFieldsForProject(data, container) { /* ... similar to loadLearnEditFields, uses data & targets container ... */
          if (!container) return;
          container.innerHTML = '';
          data.forEach((item, index) => {
               const content = (i) => `...`; // Same input structure as loadLearnEditFields
               container.appendChild(createEditItemGroup(index, 'learn', content, handleRemoveLearnItem)); // Reuse handler, it works by DOM traversal
          });
     }
      // ... Implement similar load...ForProject functions for Slides, Challenges, Quiz ...
      // These primarily differ by targeting the containers within #projectEditModal
       function loadSlidesEditFieldsForProject(data, container) {
           if (!container) return; container.innerHTML = '';
           data.forEach((slide, index) => {
               const content = (i) => `...`; // Use slide inputs structure
               container.appendChild(createEditItemGroup(index, 'slide', content, handleRemoveSlideItem));
           });
       }
       function loadChallengesEditFieldsForProject(data, container) {
            if (!container) return; container.innerHTML = '';
            data.forEach((challenge, index) => {
                const content = (i) => `...`; // Use challenge inputs structure with media
                container.appendChild(createEditItemGroup(index, 'challenge', content, handleRemoveChallengeItem));
            });
       }
       function loadQuizEditFieldsForProject(data, container) {
           if (!container) return; container.innerHTML = '';
           data.forEach((q, index) => {
                const content = (i) => `...`; // Use quiz inputs structure
                container.appendChild(createEditItemGroup(index, 'quiz', content, handleRemoveQuizItem));
           });
       }

     function loadStyleSelectionsForProject(styleData, modal) {
          // Targets color pickers etc. within the project modal
           const modalRoot = modal || document.getElementById('projectEditModal'); // Fallback if modal not passed
           if (!modalRoot) return;
          // Apply logic similar to loadStyleSelections, but use querySelector scoped to modalRoot
           const primaryPicker = modalRoot.querySelector('#primaryColorPicker');
           if (primaryPicker) primaryPicker.value = styleData?.primaryColor || '#5E81F4';
           // ... update other pickers and selectors (font, size) within the modal ...
     }


     // Add/Remove handlers for project editor (reuse existing findIndexAndRemove)
     // But ensure the reload function called is the *ForProject* version
     function handleRemoveLearnItem(elementToRemove) { findIndexAndRemove(elementToRemove, currentProjectDataCache.learnData, () => loadLearnEditFieldsForProject(currentProjectDataCache.learnData, document.querySelector('#projectEditModal #learnEditContainer'))); }
     function handleRemoveSlideItem(elementToRemove) { findIndexAndRemove(elementToRemove, currentProjectDataCache.slidesData, () => loadSlidesEditFieldsForProject(currentProjectDataCache.slidesData, document.querySelector('#projectEditModal #slidesEditContainer'))); }
     function handleRemoveChallengeItem(elementToRemove) { findIndexAndRemove(elementToRemove, currentProjectDataCache.challengesData, () => loadChallengesEditFieldsForProject(currentProjectDataCache.challengesData, document.querySelector('#projectEditModal #challengesEditContainer'))); }
     function handleRemoveQuizItem(elementToRemove) { findIndexAndRemove(elementToRemove, currentProjectDataCache.quizData, () => loadQuizEditFieldsForProject(currentProjectDataCache.quizData, document.querySelector('#projectEditModal #quizEditContainer'))); }

     // Add item functions for project editor (add to currentProjectDataCache and reload *ForProject*)
     function addLearnEditField() { if (currentProjectDataCache?.learnData.length >= MAX_LEARN_ITEMS) return; currentProjectDataCache.learnData.push({ title: "", description: "", mediaType:'none', mediaUrl:'' }); loadLearnEditFieldsForProject(currentProjectDataCache.learnData, document.querySelector('#projectEditModal #learnEditContainer')); /* scroll/focus */ }
     function addSlideEditField() { if (currentProjectDataCache?.slidesData.length >= MAX_SLIDES) return; currentProjectDataCache.slidesData.push({ url: "", description: "", type:"iframe" }); loadSlidesEditFieldsForProject(currentProjectDataCache.slidesData, document.querySelector('#projectEditModal #slidesEditContainer')); /* scroll/focus */ }
     function addChallengeEditField() { if (currentProjectDataCache?.challengesData.length >= MAX_CHALLENGES) return; currentProjectDataCache.challengesData.push({ title: "", description: "", mediaType:'none', mediaUrl:'' }); loadChallengesEditFieldsForProject(currentProjectDataCache.challengesData, document.querySelector('#projectEditModal #challengesEditContainer')); /* scroll/focus */ }
     function addQuizEditField() { if (currentProjectDataCache?.quizData.length >= MAX_QUIZ_QUESTIONS) return; currentProjectDataCache.quizData.push({ questionText:"", correctAnswer:"", incorrectAnswers: Array(MAX_INCORRECT_ANSWERS).fill("") }); loadQuizEditFieldsForProject(currentProjectDataCache.quizData, document.querySelector('#projectEditModal #quizEditContainer')); /* scroll/focus */ }


     // Show sections within the PROJECT editor modal
     function showProjectEditSection() {
         const modal = document.getElementById('projectEditModal');
         const select = document.getElementById('editSectionProject');
         if (!modal || !select) return;
         modal.querySelectorAll('.edit-section').forEach(section => section.style.display = 'none');
         const sectionId = select.value + 'Edit';
         const targetSection = modal.querySelector('#' + sectionId);
         if (targetSection) targetSection.style.display = 'block';
     }


    function saveProjectChanges() {
         const projectId = document.getElementById('editingProjectId')?.value;
         const project = courseData.projects.find(p => p.id === projectId);
         if (!project) {
             alert("Error: Could not find project data to save.");
             return;
         }

         const modal = document.getElementById('projectEditModal');
         if (!modal) return;

         try {
             // Save Project Title/Header/Tab Info
             project.projectTitle = modal.querySelector('#editProject_Title')?.value.trim() || project.projectTitle;
             project.projectSubtitle = modal.querySelector('#editProject_Subtitle')?.value.trim() || project.projectSubtitle;
             project.projectHeaderImage = modal.querySelector('#editProject_HeaderImage')?.value.trim() || project.projectHeaderImage;
             project.tabName = modal.querySelector('#editProject_TabName')?.value.trim() || project.tabName;
             project.tabImage = modal.querySelector('#editProject_TabImage')?.value.trim() || project.tabImage;


             // Save other sections (Overview, Video, etc.) using same logic as previous saveChanges,
             // but targeting inputs within the #projectEditModal and saving to the `project` object.
             project.overviewText = modal.querySelector('#editProject_OverviewText')?.value.trim() || project.overviewText;
             project.videoIntroText = modal.querySelector('#editProject_VideoIntroText')?.value.trim() || project.videoIntroText;
             // ... and so on for video title, url, keypoints ...

              // Save dynamic lists (Learn, Slides, Challenges, Quiz)
              // Re-use the saving logic from previous `saveChanges` but scope selectors to modal and save to `project.*Data`
               project.learnData = [];
               modal.querySelectorAll('#learnEditContainer .edit-item-group').forEach(item => { /* ... extract and push to project.learnData ... */ });
               project.slidesData = [];
               modal.querySelectorAll('#slidesEditContainer .edit-item-group').forEach(item => { /* ... extract and push to project.slidesData ... */ });
               project.challengesData = [];
               modal.querySelectorAll('#challengesEditContainer .edit-item-group').forEach(item => { /* ... extract and push to project.challengesData ... */ });
               project.quizData = [];
               modal.querySelectorAll('#quizEditContainer .edit-item-group').forEach(item => { /* ... extract and push to project.quizData ... */ });


             // Save Styles (Read from style pickers/selectors in modal)
              // project.style.primaryColor = modal.querySelector('#primaryColorPicker')?.value || project.style.primaryColor;
              // ... save other styles ...

             // Important: Re-render the *currently viewed* project page
             renderProjectPage(project);
             // Also re-render the course page grid in case tab name/image changed
             renderCoursePage();

             closeModal('projectEditModal');
             alert(`Project "${project.projectTitle}" changes saved!`);

         } catch (error) {
              console.error("Error saving project changes:", error);
              alert("An error occurred saving project changes.");
         }
    }

    // --- Utility Functions (Keep Existing: shuffleArray, areColorsEqual) ---
    function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}
    function areColorsEqual(c1,c2){try{const d=document.createElement('div');d.style.color=c1;const n1=d.style.color;d.style.color=c2;const n2=d.style.color;return!(!n1||!n2)&&n1===n2}catch(e){return String(c1).trim().toLowerCase()===String(c2).trim().toLowerCase()}}


    // --- EXPORT COURSE ---
    function exportCourseHTML() {
        console.log("Starting COURSE export...");
        try {
            // 1. Create a clone of the *entire current document* structure
            const exportDocElement = document.documentElement.cloneNode(true);

            // 2. Remove ALL editor modals and buttons from the clone
            exportDocElement.querySelector('#courseEditModal')?.remove();
            exportDocElement.querySelector('#projectEditModal')?.remove();
            exportDocElement.querySelectorAll('.edit-btn').forEach(btn => btn.remove());
            exportDocElement.querySelectorAll('.export-btn').forEach(btn => btn.remove());
            // Keep .back-btn in the project view

            // 3. Clean up quiz/project states in the clone (ensure course view is default)
            exportDocElement.querySelector('#course-view').style.display = 'block';
            exportDocElement.querySelector('#project-view').style.display = 'none';
            exportDocElement.querySelectorAll('.quiz-question').forEach(qDiv => { /* ... reset quiz styles ... */ }); // Simplified - see previous
            exportDocElement.querySelector('#project-view #quizContainer .final-quiz-result')?.remove();
             const exportSubmitBtn = exportDocElement.querySelector('#project-view #submitQuizBtn');
             if(exportSubmitBtn) exportSubmitBtn.disabled = false;


            // 4. Remove ALL original script tags
            exportDocElement.querySelectorAll('script').forEach(script => script.remove());

            // 5. Add the MINIMAL viewer script
            const viewerScript = document.createElement('script');
            viewerScript.textContent = `
                // --- EXPORTED VIEWER SCRIPT ---
                const courseDataForView = ${JSON.stringify(courseData)}; // Embed ALL data
                let currentSlideIndex = 0;
                let currentProjectIdForView = null; // Track viewed project in export

                // --- Utilities (Keep shuffleArray) ---
                function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}

                // --- View Navigation ---
                function showCourseView() {
                    document.getElementById('course-view').style.display = 'block';
                    document.getElementById('project-view').style.display = 'none';
                    currentProjectIdForView = null;
                    document.title = courseDataForView.title || "Course";
                    window.scrollTo(0,0);
                }
                function showProjectView(projectId) {
                     const project = courseDataForView.projects.find(p => p.id === projectId);
                     if (!project) { showCourseView(); return; }
                     currentProjectIdForView = projectId;
                     renderProjectPageForView(project); // Use the export-specific renderer
                     document.getElementById('course-view').style.display = 'none';
                     document.getElementById('project-view').style.display = 'block';
                     document.title = project.projectTitle || "Project";
                     window.scrollTo(0,0);
                 }

                 // --- Style Application ---
                 function applyProjectStylesForView(styleData) {
                     const root = document.documentElement;
                     root.style.setProperty('--primary', styleData?.primaryColor || '#5E81F4');
                     root.style.setProperty('--secondary', styleData?.secondaryColor || '#FF7AC6');
                     root.style.setProperty('--accent', styleData?.accentColor || '#FFB800');
                     root.style.fontFamily = styleData?.fontFamily || 'Comic Sans MS, Segoe UI, sans-serif';
                     let baseSize = '16px';
                     if (styleData?.baseSize === 'small') baseSize = '14px';
                     else if (styleData?.baseSize === 'large') baseSize = '18px';
                     root.style.fontSize = baseSize;
                 }


                // --- Content Rendering (Simplified for Export) ---
                function renderCoursePageForView() {
                    const course = courseDataForView;
                    document.getElementById('courseTitle').textContent = course.title;
                    document.getElementById('courseImage').src = course.imageUrl || '';
                    document.getElementById('courseImage').alt = course.title + " Image";
                    document.getElementById('courseDescription').textContent = course.description;
                    const grid = document.getElementById('projectGrid');
                    grid.innerHTML = '';
                    if (!course.projects || course.projects.length === 0) { grid.innerHTML = '<p>No projects found.</p>'; return; }

                    course.projects.forEach(project => {
                        if (!project || !project.id) return;
                        const tab = document.createElement('a');
                        tab.className = 'project-tab';
                        tab.href = '#project-' + project.id; // Use hash for link
                        tab.onclick = (e) => { e.preventDefault(); showProjectView(project.id); };
                        tab.innerHTML = \`<img src="\${project.tabImage || '...'}" alt="\${project.tabName}" loading="lazy"><div class="project-tab-info"><span>\${project.tabName || '...'}</span></div>\`;
                        grid.appendChild(tab);
                    });
                }

                 function renderProjectPageForView(project) {
                      console.log("Viewing Project (Export):", project?.projectTitle);
                      if (!project) return;

                      applyProjectStylesForView(project.style); // Apply project styles

                       // Populate Header (Simplified query within project view assumed)
                       const projectView = document.getElementById('project-view');
                       if (!projectView) return;
                       projectView.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || '';
                       projectView.querySelector('#projectImage').alt = project.projectTitle + " Header Image";
                       projectView.querySelector('#projectTitle').textContent = project.projectTitle;
                       projectView.querySelector('#projectSubtitle').textContent = project.projectSubtitle;

                       // -- Populate Content Tabs --
                       // Reuse rendering helpers, ensure they target correct containers within projectView

                        renderLearnItemsForProjectView(project.learnData || [], projectView.querySelector('#learnContainer'));
                        renderVideoForProjectView(project, projectView); // Pass project for video data
                        renderSlideshowForProjectView(project.slidesData || [], projectView.querySelector('#slideshowContainer'));
                        renderChallengesForProjectView(project.challengesData || [], projectView.querySelector('#challengesContainer'));
                        renderQuizForProjectView(project.quizData || [], projectView.querySelector('#quizContainer'), projectView.querySelector('#submitQuizBtn'));

                        // Activate first tab
                        const firstProjectTabButton = projectView.querySelector('#projectTabs .tab');
                        if (firstProjectTabButton) {
                             const clickAttr = firstProjectTabButton.getAttribute('onclick') || '';
                              const match = clickAttr.match(/openProjectTab\\('([^']+)'/);
                              const firstTabName = match ? match[1] : null;
                              if (firstTabName) openProjectTab(firstTabName, firstProjectTabButton);
                        } else {
                             const firstContent = projectView.querySelector('.tab-content');
                             if(firstContent) firstContent.classList.add('active');
                             updateProjectProgressBar('');
                        }
                 }

                 // --- Export-Specific Rendering Helpers ---
                  function renderLearnItemsForProjectView(data, container) {
                       if (!container) return; container.innerHTML = '';
                       const valid = data.filter(i => i.title); if(valid.length === 0){ container.innerHTML='<p>...</p>'; return; }
                       valid.forEach((item, idx) => {
                            const el = document.createElement('div'); el.className = 'step';
                            el.innerHTML = \`<div class="step-number">\${idx+1}</div><div class="step-content"><strong></strong><p class="description"></p><div class="step-media" style="display:none;"></div></div>\`;
                            el.querySelector('strong').textContent = item.title;
                            const p = el.querySelector('p'); if (item.description) p.textContent = item.description; else p.remove();
                            const media = el.querySelector('.step-media');
                            if(item.mediaType !== 'none' && item.mediaUrl){ media.style.display='block'; if(item.mediaType==='image') media.innerHTML=\`<img src="\${item.mediaUrl}" loading="lazy" alt="">\`; else if(item.mediaType==='video') media.innerHTML=\`<iframe src="\${item.mediaUrl}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>\`; }
                            container.appendChild(el);
                       });
                  }
                  function renderVideoForProjectView(project, viewContainer){
                       if(!viewContainer) return;
                       viewContainer.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
                       viewContainer.querySelector('#videoTitle').textContent = project.videoTitle || '';
                       viewContainer.querySelector('#mainVideo').src = project.videoUrl || '';
                       const ul = viewContainer.querySelector('#videoKeyPoints'); ul.innerHTML = '';
                       (project.videoKeyPoints || []).forEach(p => ul.innerHTML += \`<li>\${p}</li>\`);
                  }
                  function renderSlideshowForProjectView(data, container){
                       const nav = container?.parentElement?.querySelector('.slide-nav');
                       if (!container || !nav) return; container.innerHTML = '';
                       const valid = data.filter(s => s.url); if(valid.length === 0){ container.innerHTML='<p>...</p>'; nav.style.display='none'; return; } nav.style.display='flex';
                       valid.forEach((slide, idx) => {
                           const el = document.createElement('div'); el.className = 'slide';
                           el.innerHTML = \`<div class="slide-content-wrapper"></div><p></p>\`;
                           const w = el.querySelector('.slide-content-wrapper');
                           const c = el.querySelector('p');
                           if(slide.type==='iframe') w.innerHTML=\`<iframe src="\${slide.url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>\`;
                           else if(slide.type==='image') w.innerHTML=\`<img src="\${slide.url}" loading="lazy" alt="">\`;
                           if(slide.description) c.textContent = slide.description; else c.remove();
                           container.appendChild(el);
                       });
                       currentSlideIndex = 0; showSlide(0); // Use global showSlide
                  }
                  function renderChallengesForProjectView(data, container){
                      if (!container) return; container.innerHTML = '';
                      const valid = data.filter(i => i.title); if(valid.length === 0){ container.innerHTML='<p>...</p>'; return; }
                      valid.forEach(item => {
                           const el = document.createElement('div'); el.className = 'step';
                           el.innerHTML = \`<div class="step-number">★</div><div class="step-content"><strong></strong><p class="description"></p><div class="step-media" style="display:none;"></div></div>\`;
                           el.querySelector('strong').textContent = item.title;
                           const p = el.querySelector('p'); if (item.description) p.textContent = item.description; else p.remove();
                            const media = el.querySelector('.step-media');
                            if(item.mediaType !== 'none' && item.mediaUrl){ media.style.display='block'; if(item.mediaType==='image') media.innerHTML=\`<img src="\${item.mediaUrl}" loading="lazy" alt="">\`; else if(item.mediaType==='video') media.innerHTML=\`<iframe src="\${item.mediaUrl}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation"></iframe>\`; }
                           container.appendChild(el);
                      });
                  }
                  function renderQuizForProjectView(data, container, submitBtn){
                       if (!container || !submitBtn) return;
                       container.innerHTML = ''; container.querySelector('.final-quiz-result')?.remove();
                       submitBtn.disabled = false; submitBtn.style.display = 'none';
                       const valid = (data || []).filter(q => q.questionText && q.correctAnswer);
                       if (valid.length === 0) { container.innerHTML='<p>...</p>'; return; } submitBtn.style.display = 'block';
                       valid.forEach((q, index) => {
                            const div = document.createElement('div'); div.className = 'quiz-question';
                            div.innerHTML = \`<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;"></div><div class="quiz-feedback incorrect" style="display:none;"></div>\`;
                            div.querySelector('.question-text').textContent = \`\${index+1}. \${q.questionText}\`;
                            const optsDiv = div.querySelector('.quiz-options');
                            let opts = [q.correctAnswer, ...(q.incorrectAnswers || []).filter(a=>a&&a.trim())]; shuffleArray(opts);
                            opts.forEach(optTxt => {
                                const correct = (optTxt === q.correctAnswer);
                                const optEl = document.createElement('div'); optEl.className='quiz-option'; optEl.textContent=optTxt;
                                optEl.setAttribute('role','button'); optEl.setAttribute('tabindex','0');
                                optEl.onclick=()=>selectQuizOption(optEl); // Use global handler
                                optEl.onkeydown=(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(optEl);}};
                                optEl.setAttribute('data-is-correct', correct.toString());
                                optsDiv.appendChild(optEl);
                            });
                            container.appendChild(div);
                       });
                  }

                // --- Project Interaction (Keep: openProjectTab, updateProjectProgressBar, showSlide, next/prevSlide, selectQuizOption, submitQuiz) ---
                // These functions are defined above and should work in the export context
                 function openProjectTab(tabName, element) { /* ... same as editor ... */ const c=document.getElementById('projectTabContentContainer');if(!c)return;c.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));const b=document.getElementById('projectTabs');if(b)b.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));const t=c.querySelector('#'+tabName);if(t)t.classList.add('active');element?.classList.add('active');updateProjectProgressBar(tabName); }
                 function updateProjectProgressBar(tabName) { /* ... same as editor ... */ const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tabName);if(i>=0)r=(i+1)/o.length*100;p.style.width=r+'%'; }
                 // showSlide, nextSlide, prevSlide defined above
                 // selectQuizOption, submitQuiz defined above


                // --- Initial Load ---
                document.addEventListener('DOMContentLoaded', function() {
                    console.log("Exported Course Loaded.");
                    renderCoursePageForView(); // Render the course grid
                    showCourseView(); // Ensure course view is visible initially
                    console.log("Export Initialization Complete.");
                });
            `; // End viewerScript.textContent

            exportDocElement.querySelector('body').appendChild(viewerScript);
            console.log("Viewer script added to clone.");

            // 6. Generate HTML string
            const htmlContent = '<!DOCTYPE html>\n' + exportDocElement.outerHTML;

            // 7. Trigger Download
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const filename = (courseData.title || "course_export").replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_').toLowerCase() + '.html';
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();

            // 8. Cleanup
            setTimeout(() => { if(document.body.contains(a)) document.body.removeChild(a); URL.revokeObjectURL(url); console.log("Export cleanup done."); }, 150);

        } catch (error) {
            console.error("Error during COURSE export:", error);
            alert("An error occurred during course export. Check console.");
        }
    }

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Course Editor/Viewer Initializing...");
        renderCoursePage(); // Render the initial course page view
        showCourseView(); // Ensure course view is visible first
        console.log("Initialization complete.");
    });

</script>

</body>
</html>
```
