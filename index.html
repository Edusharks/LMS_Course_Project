<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Course Editor & Viewer - Combined</title>
<style>
    :root {
        --primary: #5E81F4;
        --secondary: #FF7AC6;
        --accent: #FFB800;
        --light: #F5F7FA;
        --dark: #1A1D28;
        --success: #7CE7AC;
        --danger: #FF7E7E;
        --base-font-family: 'Segoe UI', sans-serif;
        --base-font-size: 16px;
        --transition-speed: 0.3s;
        --transition-ease: ease;
    }

    html {
        scroll-behavior: smooth;
        box-sizing: border-box;
        font-size: var(--base-font-size);
    }

    *, *:before, *:after {
        box-sizing: inherit;
    }

    body {
        font-family: var(--base-font-family);
        margin: 0;
        padding: 0;
        background-color: var(--light);
        color: var(--dark);
        line-height: 1.6;
        transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease);
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px 15px;
    }

    h2 {
        color: var(--primary);
        border-bottom: 3px solid var(--secondary);
        padding-bottom: 8px;
        display: inline-block;
        font-size: 1.4rem;
        margin-top: 0;
        margin-bottom: 25px;
        transition: color var(--transition-speed) var(--transition-ease), border-color var(--transition-speed) var(--transition-ease);
    }

    h3 {
        color: var(--dark);
        margin-top: 30px;
        margin-bottom: 15px;
        font-size: 1.2rem;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border-width: 0;
    }

    .page-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
        padding: 25px 20px;
        border-radius: 18px;
        box-shadow: 0 6px 15px rgba(0,0,0,0.08);
        text-align: center;
        position: relative;
        transition: background var(--transition-speed) var(--transition-ease);
    }

    .page-header img.header-image {
        width: 120px;
        height: 120px;
        object-fit: cover;
        border-radius: 12px;
        border: 4px solid white;
    }

    .page-header .header-title-container {
        flex-grow: 1;
    }

    .page-header .header-title {
        color: white;
        margin: 0 0 8px 0;
        font-size: 1.9rem;
        text-shadow: 1px 1px 4px rgba(0,0,0,0.25);
    }

    .page-header .header-subtitle {
        color: rgba(255, 255, 255, 0.95);
        font-size: 1.05rem;
        margin: 0;
    }

    .edit-btn, .export-btn, .back-btn {
        position: absolute;
        top: 20px;
        background-color: rgba(255, 255, 255, 0.25);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.6);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        box-shadow: 0 3px 7px rgba(0,0,0,0.2);
        transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        z-index: 10;
        text-decoration: none;
    }

    .edit-btn:hover, .export-btn:hover, .back-btn:hover {
        background-color: rgba(255, 255, 255, 0.5);
        transform: scale(1.1);
        box-shadow: 0 4px 9px rgba(0,0,0,0.25);
    }

    #course-view .page-header .edit-btn {
        right: 20px;
    }

    #course-view .page-header .export-btn {
        right: 75px;
    }

    #project-view .page-header .edit-btn {
        right: 20px;
    }

    #project-view .page-header .back-btn {
        right: 75px;
        font-size: 24px;
    }

    #course-view {
        animation: fadeIn 0.5s;
    }

    #course-description-container {
        background-color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 30px;
        font-size: 1.05rem;
        line-height: 1.7;
    }

    #course-description-container h2 {
        margin-bottom: 15px;
        font-size: 1.3rem;
    }

    /* --- NEW: Course Multimedia Section Styles --- */
    #course-multimedia-section {
        background-color: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        margin-bottom: 30px;
        position: relative; /* For positioning the toggle button */
        overflow: hidden; /* Prevents content overflow when minimized */
         transition: padding-top 0.3s ease, padding-bottom 0.3s ease; /* Smooth transition */
    }

    #course-multimedia-section h2 {
        margin-bottom: 20px;
        font-size: 1.3rem;
    }

    #course-multimedia-content {
        margin-top: 15px;
        max-width: 100%;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        border-radius: 12px;
        background-color: #f0f0f0; /* Placeholder bg */
         transition: max-height 0.4s ease-out, opacity 0.3s ease-in;
         max-height: 1000px; /* Large enough for content */
         opacity: 1;
    }

    #course-multimedia-content img,
    #course-multimedia-content iframe {
        display: block;
        max-width: 100%;
        height: auto;
        border: none;
        border-radius: 12px;
        box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }

    /* Aspect ratio for video/presentation if needed */
    #course-multimedia-content .media-wrapper-16-9 {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 */
        height: 0;
        overflow: hidden;
    }
     #course-multimedia-content .media-wrapper-16-9 iframe {
        position: absolute;
        top: 0;
        left: 0;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
     }


    #toggle-multimedia-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background-color: rgba(0, 0, 0, 0.1);
        color: var(--dark);
        border: 1px solid rgba(0, 0, 0, 0.2);
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        font-weight: bold;
        line-height: 1;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: background-color 0.3s, transform 0.2s;
        z-index: 5;
        padding: 0; /* Remove default padding */
    }

    #toggle-multimedia-btn:hover {
        background-color: rgba(0, 0, 0, 0.2);
        transform: scale(1.05);
    }

    /* Minimized State */
    #course-multimedia-section.multimedia-minimized {
         padding-top: 15px; /* Reduce padding when minimized */
         padding-bottom: 15px;
    }
     #course-multimedia-section.multimedia-minimized #course-multimedia-content {
        max-height: 0;
        opacity: 0;
        margin-top: 0; /* Remove margin when hidden */
        overflow: hidden; /* Ensure content is fully hidden */
    }
    /* --- End Course Multimedia Styles --- */


    #projectGrid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
        margin-top: 20px;
    }

    .project-tab {
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        overflow: hidden;
        cursor: pointer;
        transition: transform var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease);
        display: flex;
        flex-direction: column;
        text-decoration: none;
        color: inherit;
        position: relative;
    }

    .project-tab:hover {
        transform: translateY(-6px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.12);
    }

    .project-tab img {
        width: 100%;
        height: 200px;
        object-fit: cover;
        object-position: center; 
        border-bottom: 1px solid #eee;
    }

    .project-tab-info {
        padding: 20px 15px;
        text-align: center;
        background-color: #fdfdff;
        flex-grow: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .project-tab-info span {
        font-weight: 600;
        color: var(--primary);
        font-size: 1.1rem;
        transition: color var(--transition-speed) var(--transition-ease);
    }

    .completion-tick {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 30px;
        height: 30px;
        background-color: var(--success);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 19px;
        font-weight: bold;
        line-height: 1;
        box-shadow: 0 2px 5px rgba(0,0,0,0.25);
        z-index: 5;
    }

    #project-view {
        animation: fadeIn 0.5s;
    }

    #project-view .page-header .header-image {
        width: 100px;
        height: 100px;
        border-radius: 10px;
    }

    #project-view .page-header .header-title {
        font-size: 1.7rem;
    }

    #project-view .page-header .header-subtitle {
        font-size: 1rem;
    }

    .progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 10px;
        margin: 25px 0;
        height: 12px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        border-radius: 10px;
        width: 0%;
        transition: width .5s ease-in-out, background var(--transition-speed) var(--transition-ease);
    }

    #projectTabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        overflow-x: auto;
        padding-bottom: 8px;
        -webkit-overflow-scrolling: touch;
    }

    #projectTabs::-webkit-scrollbar {
        height: 4px;
        background-color: #eee;
        border-radius: 2px;
    }

    #projectTabs::-webkit-scrollbar-thumb {
        background-color: var(--primary);
        border-radius: 2px;
    }

    #projectTabs .tab {
        padding: 10px 20px;
        background-color: #fff;
        border-radius: 30px;
        cursor: pointer;
        font-weight: 700;
        box-shadow: 0 3px 10px rgba(0,0,0,.06);
        white-space: nowrap;
        font-size: .95rem;
        flex-shrink: 0;
        transition: background-color .3s, color .3s, transform .2s, box-shadow .3s;
        border: 1px solid #eee;
    }

    #projectTabs .tab.active {
        background-color: var(--primary);
        color: #fff;
        transform: translateY(-3px);
        box-shadow: 0 5px 12px rgba(var(--primary-rgb, 94, 129, 244),.3);
    }

    #projectTabs .tab:hover:not(.active) {
        background-color: #eef2ff;
        transform: translateY(-2px);
        box-shadow: 0 4px 11px rgba(0,0,0,.08);
    }

    #projectTabContentContainer .tab-content {
        display: none;
        background-color: #fff;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,.06);
        animation: fadeIn .5s ease-out;
        margin-bottom: 25px;
    }

    #projectTabContentContainer .tab-content h2 {
        font-size: 1.3rem;
        margin-bottom: 20px;
    }

    #projectTabContentContainer .tab-content.active {
        display: block;
    }

    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        margin: 20px 0;
        border-radius: 12px;
        box-shadow: 0 5px 12px rgba(0,0,0,.1);
    }

    .video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border-radius: 12px;
        border: none;
    }

    .slide {
        display: none;
        text-align: center;
    }

    .slideshow {
        position: relative;
        margin: 20px 0;
        background-color: #f9f9ff;
        padding: 20px;
        border-radius: 12px;
    }

    .slide-content-wrapper {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
        margin: 0 auto 20px;
        max-width: 100%;
        background-color: #eee;
        border-radius: 10px;
    }

    .slide iframe, .slide img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,.1);
        background-color: transparent;
    }

    .slide p {
        margin: 15px 0 0;
        font-size: .95rem;
        color: #444;
    }

    .slide.active {
        display: block;
        animation: fadeIn .5s;
    }

    .slide-nav {
        text-align: center;
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        gap: 15px;
    }

    .slide-nav button {
        background-color: var(--primary);
        color: #fff;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        transition: background-color .3s, transform .2s, box-shadow .3s;
        box-shadow: 0 2px 5px rgba(0,0,0,.1);
    }

    .slide-nav button:hover {
        background-color: #4a6cdc;
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0,0,0,.15);
    }

    .step {
        display: flex;
        gap: 20px;
        margin-bottom: 25px;
        padding: 20px;
        background-color: #fdfdff;
        border-radius: 12px;
        align-items: flex-start;
        border-left: 6px solid var(--secondary);
        box-shadow: 0 2px 6px rgba(0,0,0,.05);
        transition: border-color var(--transition-speed) var(--transition-ease);
    }

    .step-number {
        background-color: var(--secondary);
        color: #fff;
        min-width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        flex-shrink: 0;
        font-size: 1rem;
        margin-top: 4px;
        transition: background-color var(--transition-speed) var(--transition-ease);
    }

    .step-content {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .step-content strong {
        font-size: 1.1rem;
        color: var(--primary);
        display: block;
        margin-bottom: 8px;
        transition: color var(--transition-speed) var(--transition-ease);
    }

    .step-content p.description {
        margin: 0 0 15px;
        font-size: 1rem;
        color: #333;
        line-height: 1.6;
    }

    .step-content p.description:last-child {
        margin-bottom: 0;
    }

    .step-content .step-media {
        margin-top: 15px;
        max-width: 100%;
        width: 100%;
        overflow: hidden;
        border-radius: 10px;
        background-color: #f0f0f0;
    }

    .step-content .step-media img {
        display: block;
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }

    .step-content .step-media iframe {
        display: block;
        width: 100%;
        aspect-ratio: 16/9;
        border: none;
        border-radius: 10px;
        box-shadow: 0 3px 8px rgba(0,0,0,.1);
    }

    .quiz-question {
        background-color: #fdfdff;
        padding: 25px;
        margin-bottom: 20px;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(94,129,244,.12);
        border: 1px solid #e0e8ff;
    }

    .quiz-question p.question-text {
        margin: 0 0 20px;
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--dark);
    }

    .quiz-options {
        margin-top: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .quiz-option {
        display: block;
        padding: 14px 18px;
        margin-bottom: 0;
        background-color: #f5f7fa;
        border: 1px solid #d8dde6;
        border-radius: 10px;
        cursor: pointer;
        transition: all .3s ease;
        font-size: 1rem;
        position: relative;
        text-align: left;
        opacity: 1;
    }

    .quiz-option:hover {
        background-color: #e8ecf3;
        border-color: #c4cde0;
        transform: translateX(3px);
    }

    .quiz-option.selected {
        border-color: var(--primary);
        background-color: #e8f0fe;
        font-weight: 500;
    }

    .quiz-option.correct {
        background-color: var(--success);
        color: #fff;
        border-color: #63c899;
        font-weight: 700;
    }

    .quiz-option.correct.selected {
        background-color: var(--success);
        color: #fff;
        border-color: #63c899;
    }

    .quiz-option.incorrect.selected {
        background-color: var(--danger);
        color: #fff;
        border-color: #e66a6a;
        font-weight: 700;
        text-decoration: line-through;
        text-decoration-thickness: 2px;
        border-color: #e66a6a!important;
    }

    .quiz-question.answered .quiz-option:not(.selected):not(.correct) {
        opacity: .6;
        cursor: default;
        background-color: #f5f7fa;
        border-color: #d8dde6;
        text-decoration: none;
        transform: none;
    }

    .quiz-question.answered .quiz-option.correct:not(.selected) {
        opacity: 1;
    }

    .quiz-feedback {
        margin-top: 15px;
        padding: 12px 18px;
        border-radius: 8px;
        display: none;
        font-size: .9rem;
        border-width: 1px;
        border-style: solid;
        font-weight: 500;
    }

    .quiz-feedback.correct {
        background-color: #e6f7ed;
        color: #1d6c45;
        border-color: #c3e6cb;
    }

    .quiz-feedback.incorrect {
        background-color: #fde8e8;
        color: #9b1c1c;
        border-color: #f5c6cb;
    }

    .final-quiz-result {
        margin-top: 25px;
        padding: 18px;
        border-radius: 10px;
        text-align: center;
        font-weight: 700;
        font-size: 1.15rem;
    }

    .final-quiz-result.success {
        background-color: #e6f7ed;
        color: #1d6c45;
        border: 1px solid #c3e6cb;
    }

    .final-quiz-result.fail {
        background-color: #fde8e8;
        color: #9b1c1c;
        border: 1px solid #f5c6cb;
    }

    .submit-btn {
        background-color: var(--accent);
        color: var(--dark);
        border: none;
        padding: 14px 30px;
        border-radius: 30px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 30px;
        font-size: 1.05rem;
        transition: all .3s;
        display: block;
        width: 100%;
        max-width: 280px;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 3px 8px rgba(0,0,0,.15);
        transition: background-color var(--transition-speed) var(--transition-ease), color var(--transition-speed) var(--transition-ease), box-shadow var(--transition-speed) var(--transition-ease), transform var(--transition-speed) var(--transition-ease);
    }

    .submit-btn:hover:not(:disabled) {
        background-color: #ffc833;
        box-shadow: 0 5px 12px rgba(0,0,0,.2);
        transform: translateY(-2px);
    }

    .submit-btn:disabled {
        background-color: #ccc;
        color: #666;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
        opacity: .7;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,.7);
        z-index: 1000;
        overflow-y: auto;
        padding: 40px 15px;
    }

    .modal-content {
        background-color: #fff;
        margin: 40px auto;
        padding: 30px 35px;
        border-radius: 15px;
        width: 90%;
        max-width: 850px;
        box-shadow: 0 8px 25px rgba(0,0,0,.3);
        position: relative;
    }

    .close-modal {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 32px;
        font-weight: 700;
        color: #aaa;
        cursor: pointer;
        line-height: 1;
        z-index: 1001;
        padding: 5px;
        transition: color 0.3s;
    }

    .close-modal:hover {
        color: #333;
    }

    .modal h2 {
        margin-bottom: 25px;
    }

    .edit-form {
        margin-top: 25px;
    }

    .edit-form label {
        display: block;
        margin-bottom: 6px;
        font-weight: 600;
        color: var(--primary);
        font-size: .95rem;
    }

    .edit-form input[type=text], .edit-form input[type=url], .edit-form textarea, .edit-form select {
        width: 100%;
        padding: 12px;
        margin-bottom: 18px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
        transition: border-color 0.3s;
    }

    .edit-form input:focus, .edit-form textarea:focus, .edit-form select:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(var(--primary-rgb, 94, 129, 244), 0.2);
    }

    .edit-form textarea {
        resize: vertical;
        min-height: 80px;
    }

    .edit-form button, button.remove-item-btn, button.add-item-btn {
        background-color: var(--primary);
        color: #fff;
        border: none;
        padding: 10px 18px;
        border-radius: 6px;
        cursor: pointer;
        margin-right: 10px;
        margin-top: 10px;
        font-size: .95rem;
        font-weight: 500;
        transition: background-color .3s, transform 0.2s, box-shadow 0.3s;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .edit-form button:hover, button.remove-item-btn:hover, button.add-item-btn:hover {
        background-color: #4a6cdc;
        transform: translateY(-1px);
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .modal-actions {
        margin-top: 30px;
        text-align: right;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }

    .modal-actions button {
        display: inline-block;
    }

    .modal-actions button[onclick^="save"] {
        background-color: var(--success);
    }

    .modal-actions button[onclick^="save"]:hover {
        background-color: #63c899;
    }

    .modal-actions button[onclick^="closeModal"] {
        background-color: #aaa;
        margin-right: 0;
    }

    .modal-actions button[onclick^="closeModal"]:hover {
        background-color: #888;
    }

    button.remove-item-btn {
        background-color: var(--danger);
        margin-left: 10px;
        font-weight: 700;
        line-height: 1;
        padding: 6px 10px;
        width: 30px;
        height: 30px;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: none;
    }

    button.remove-item-btn:hover {
        background-color: #e66a6a;
        transform: scale(1.1);
    }

    button.add-item-btn {
        background-color: var(--success);
        display: inline-block;
        margin-top: 15px;
        margin-left: 0;
        margin-right: 0;
        width: fit-content;
    }

    button.add-item-btn:hover {
        background-color: #63c899;
    }

    .edit-section {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    .edit-item-group {
        margin-bottom: 25px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 10px;
        background-color: #fdfdff;
        position: relative;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .edit-item-group .remove-item-btn {
        position: absolute;
        top: 15px;
        right: 15px;
    }

    .edit-item-group>label {
        font-weight: 700;
        color: var(--dark);
        font-size: 1rem;
        margin-top: 5px;
        display: block;
        margin-bottom: 10px;
    }

    .edit-item-group label {
        font-weight: 500;
        color: #555;
        font-size: .9rem;
    }

    .edit-item-group input[type=text], .edit-item-group input[type=url], .edit-item-group textarea, .edit-item-group select {
        margin-bottom: 12px;
    }

    .media-controls {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed #eee;
    }

    .media-controls label {
        font-weight: 500;
        color: #555;
        font-size: .9rem;
    }

    .media-url-input-container {
        margin-top: 8px;
    }

    /* NEW: Course Multimedia Editor Fields Container */
    .course-multimedia-editor-fields {
        margin-top: 8px;
        padding-left: 10px;
        border-left: 3px solid #eee;
    }

    .incorrect-answer-label {
        font-size: .9rem;
        color: #777;
        margin-top: 10px;
        font-weight: 500;
    }

    .color-picker {
        display: flex;
        gap: 12px;
        margin-bottom: 18px;
        flex-wrap: wrap;
        align-items: center;
    }

    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid #ddd;
        transition: transform .2s, border-color .2s, box-shadow .2s;
    }

    .color-option.selected {
        border: 3px solid var(--dark);
        transform: scale(1.15);
        box-shadow: 0 0 8px rgba(0,0,0,0.2);
    }

    input[type=color] {
        width: 38px;
        height: 38px;
        border: 1px solid #ccc;
        padding: 2px;
        border-radius: 50%;
        overflow: hidden;
        cursor: pointer;
        vertical-align: middle;
        background-color: white;
    }

    input[type=color]::-webkit-color-swatch-wrapper {
        padding: 0;
    }

    input[type=color]::-webkit-color-swatch {
        border: none;
        border-radius: 50%;
    }

    input[type=color].inherited-style {
        border: 2px dashed #aaa !important;
    }

    .font-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 18px;
        flex-wrap: wrap;
    }

    .font-option {
        padding: 6px 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color .3s, color .3s, border-color .3s;
        font-size: 0.9rem;
    }

    .font-option.selected {
        background-color: var(--primary);
        color: #fff;
        border-color: var(--primary);
        font-weight: 500;
    }

    .font-option:hover:not(.selected) {
        background-color: #eef2ff;
        border-color: #c4cde0;
    }

    .size-selector {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 18px;
    }

    .size-option {
        padding: 6px 14px;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        transition: background-color .3s, color .3s, border-color .3s;
        font-size: 0.9rem;
    }

    .size-option.selected {
        background-color: var(--primary);
        color: #fff;
        border-color: var(--primary);
        font-weight: 500;
    }

    .size-option:hover:not(.selected) {
        background-color: #eef2ff;
        border-color: #c4cde0;
    }

    #courseEditModal #projectTabsEditor {
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }

    #projectTabsEditor h4 {
        margin-bottom: 18px;
        color: var(--primary);
        display: inline-block;
        border-bottom: 2px solid var(--secondary);
        padding-bottom: 6px;
        font-size: 1.1rem;
    }

    #projectTabsList {
        max-height: 350px;
        overflow-y: auto;
        padding-right: 10px;
    }

    .project-tab-edit-item {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 15px;
        align-items: center;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 8px;
        margin-bottom: 12px;
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }

    .project-tab-edit-item .index {
        font-weight: bold;
        font-size: 1rem;
        color: var(--secondary);
    }

    .project-tab-edit-item .inputs {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .project-tab-edit-item label {
        font-size: 0.85rem;
        margin-bottom: 3px;
        color: #555;
        font-weight: 500;
    }

    .project-tab-edit-item input {
        padding: 8px;
        font-size: 0.9rem;
    }

    #projectEditModal .edit-section h4, #courseEditModal .edit-section h4 {
        color: var(--primary);
        margin-bottom: 15px;
        padding-bottom: 6px;
        border-bottom: 2px solid var(--secondary);
        display: inline-block;
        font-size: 1.15rem;
    }

    #projectEditModal .edit-section h5 {
        color: var(--dark);
        margin-top: 25px;
        margin-bottom: 12px;
        font-size: 1.05rem;
        font-weight: 600;
    }

    #projectEditModal #editingProjectNameLabel {
        color: var(--secondary);
        font-weight: bold;
    }

    #projectEditModal .form-hint, #courseEditModal .form-hint { /* Apply hint style in course modal too */
        font-size: 0.85rem;
        color: #666;
        margin-top: -10px;
        margin-bottom: 15px;
    }

    @media (min-width:768px) {
        .container {
            padding: 30px;
        }

        .page-header {
            flex-direction: row;
            text-align: left;
            align-items: center;
            padding: 30px 35px;
            gap: 30px;
        }

        #course-view .page-header img.header-image {
            width: 150px;
            height: 150px;
            border-radius: 15px;
        }

        .page-header .header-title {
            font-size: 2.2rem;
        }

        .page-header .header-subtitle {
            font-size: 1.2rem;
        }

        .step {
            align-items: center;
        }

        .step-number {
            margin-top: 0;
            width: 40px;
            height: 40px;
            font-size: 1.1rem;
        }

        .step-content .step-media {
            max-width: 65%;
            margin-left: auto;
            margin-right: auto;
        }

        #project-view .page-header img.header-image {
            width: 120px;
            height: 120px;
        }

        #project-view .page-header .header-title {
            font-size: 2.1rem;
        }

        #project-view .page-header .header-subtitle {
            font-size: 1.1rem;
        }

        #projectTabs .tab {
            padding: 12px 25px;
            font-size: 1rem;
        }
    }

    @media (max-width:600px) {
        .container {
            padding: 15px 10px;
        }

        .page-header {
            padding: 20px 15px;
        }

        #projectTabContentContainer .tab-content {
            padding: 20px;
        }

        .edit-btn, .export-btn, .back-btn {
            width: 36px;
            height: 36px;
            font-size: 18px;
            top: 15px;
        }

        #course-view .page-header .edit-btn {
            right: 15px;
        }

        #course-view .page-header .export-btn {
            right: 65px;
        }

        #project-view .page-header .edit-btn {
            right: 15px;
        }

        #project-view .page-header .back-btn {
            right: 65px;
            font-size: 22px;
        }

        h2 {
            font-size: 1.3rem;
        }

        .page-header .header-title {
            font-size: 1.6rem;
        }

        .page-header .header-subtitle {
            font-size: .95rem;
        }

        .modal-content {
            padding: 25px 20px;
        }

        #course-multimedia-section { /* Adjust padding for small screens */
             padding: 20px 15px;
        }
         #toggle-multimedia-btn { /* Adjust position for small screens */
             top: 15px;
             right: 15px;
         }

        .step {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .step-number {
            margin-top: 0;
            margin-bottom: 5px;
        }

        .step-content .step-media {
            max-width: 100%;
        }

        #project-view .page-header .header-title {
            font-size: 1.5rem;
        }

        #project-view .page-header .header-subtitle {
            font-size: .95rem;
        }

        .modal-actions {
            text-align: center;
        }

        .modal-actions button {
            width: 48%;
            margin: 5px 1%;
        }

        .modal-actions button[onclick^="closeModal"] {
            margin-right: 1%;
        }
    }
</style>
</head>
<body>
<!-- Container for the whole application -->
<div class="container">

    <!-- == COURSE VIEW (Visible by default) == -->
    <div id="course-view">
        <header class="page-header" id="course-header">
             <button class="edit-btn" onclick="openCourseEditModal()" aria-label="Edit Course Details" title="Edit Course">✏️</button>
             <button class="export-btn" onclick="exportCourseHTML()" aria-label="Export Course HTML" title="Export Course">⬇️</button>
             <img src="https://static.wixstatic.com/media/ecb02e_d86006f33f6c4a448e2c1ec1517c2690~mv2.png" alt="Course Image" class="header-image" id="courseImage">
             <div class="header-title-container">
                 <h1 class="header-title" id="courseTitle">Course Title</h1>
                 <!-- Course subtitle/short desc could go here if needed -->
             </div>
        </header>

        <section id="course-description-container">
            <h2>About This Course</h2>
            <p id="courseDescription">Loading course description...</p>
        </section>

        <!-- ===== NEW: Course Multimedia Section ===== -->
        <section id="course-multimedia-section" style="display: none;"> 
             <h2>Introduction</h2> 
             <button id="toggle-multimedia-btn" onclick="toggleCourseMultimedia()" aria-label="Toggle Multimedia Visibility" title="Minimize/Maximize">
                 — {/* Minimize Symbol */}
             </button>
             <div id="course-multimedia-content">
                 <!-- Multimedia (Image/Video/Iframe) will be inserted here by JS -->
                 <p>Loading multimedia...</p>
             </div>
        </section>
        <!-- ===== End Course Multimedia Section ===== -->


        <section>
            <h2>Projects</h2>
            <div id="projectGrid">
                <!-- Project tabs will be dynamically inserted here -->
                <p>Loading projects...</p>
            </div>
        </section>
    </div>

    <!-- == PROJECT VIEW (Hidden by default) == -->
    <div id="project-view" style="display: none;">
        <!-- Project Header (Populated Dynamically) -->
        <header class="page-header" id="project-header">
            <button class="back-btn" id="backToCourseBtn" onclick="showCourseView()" aria-label="Back to Course" title="Back to Course">←</button>
            <button class="edit-btn" onclick="openProjectEditModal()" aria-label="Edit Project" title="Edit Project">✏️</button>
            <!-- Project Export Button REMOVED -->
            <img src="" alt="Project Image" class="header-image" id="projectImage">
            <div class="header-title-container">
                <h1 class="header-title" id="projectTitle">Project Title</h1>
                <p class="header-subtitle" id="projectSubtitle">Project Subtitle</p>
            </div>
        </header>

        <!-- Existing Project Content Structure (Merged from Project Code) -->
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        <nav class="tabs" id="projectTabs">
            <!-- Tabs are dynamically generated or hardcoded if fixed -->
            <!-- Example structure (content loaded dynamically) -->
            <div class="tab active" onclick="openProjectTab('overview', this)">Overview</div>
            <div class="tab" onclick="openProjectTab('video', this)">Video Lesson</div>
            <div class="tab" onclick="openProjectTab('slides', this)">Step-by-Step</div>
            <div class="tab" onclick="openProjectTab('challenges', this)">Challenges</div>
            <div class="tab" onclick="openProjectTab('quiz', this)">Quiz</div>
        </nav>
        <main id="projectTabContentContainer">
            <!-- Project Tab Content Templates -->
             <section id="overview" class="tab-content active">
                 <h2>About This Project</h2>
                 <p id="overviewText">Loading overview...</p>
                 <h3>What You'll Learn</h3>
                 <div id="learnContainer"><p>Loading learning objectives...</p></div>
             </section>
             <section id="video" class="tab-content">
                 <h2>Video Lesson</h2>
                 <p id="videoIntroText"></p>
                 <h3 id="videoTitle"></h3>
                 <div class="video-container">
                     <iframe src="" frameborder="0" loading="lazy" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen id="mainVideo" title="Project Video"></iframe>
                 </div>
                 <h3>Key Points</h3>
                 <ul id="videoKeyPoints" style="font-size: 0.95rem; padding-left: 25px; list-style: disc;"><p>Loading key points...</p></ul>
             </section>
             <section id="slides" class="tab-content">
                 <h2>Step-by-Step Guide</h2>
                 <div class="slideshow" id="slideshowContainer"><p>Loading slides...</p></div>
                 <nav class="slide-nav">
                     <button onclick="prevSlide()">Previous</button>
                     <button onclick="nextSlide()">Next</button>
                 </nav>
             </section>
             <section id="challenges" class="tab-content">
                 <h2>Project Challenges</h2>
                 <p>Try these challenges to test your skills:</p>
                 <div id="challengesContainer"><p>Loading challenges...</p></div>
             </section>
             <section id="quiz" class="tab-content">
                 <h2>Project Quiz</h2>
                 <p>Test your knowledge from this project:</p>
                 <div id="quizContainer"><p>Loading quiz...</p></div>
                 <!-- Final result area added by script -->
                 <button class="submit-btn" id="submitQuizBtn" onclick="submitQuiz()">Submit Quiz</button>
             </section>
        </main>
    </div>

</div><!-- End .container -->


<!-- ==== MODALS ==== -->

<!-- == COURSE Editor Modal == -->
<div id="courseEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('courseEditModal')" title="Close Editor" aria-label="Close Course Editor">×</span>
        <h2>Edit Course Details</h2>
        <form class="edit-form" onsubmit="event.preventDefault(); saveCourseChanges();">
            <section class="edit-section" style="border-top: none; padding-top: 0;">
                <h4>Course Metadata</h4>
                <label for="editCourseTitle">Course Title:</label>
                <input type="text" id="editCourseTitle" required>

                <label for="editCourseImage">Course Header Image URL:</label>
                <input type="url" id="editCourseImage" placeholder="https://example.com/image.jpg">

                <label for="editCourseDescription">Course Description:</label>
                <textarea id="editCourseDescription" rows="6"></textarea>
            </section>

            <!-- === NEW: Course Multimedia Editor === -->
             <section id="courseMultimediaEditor" class="edit-section">
                 <h4>Course Multimedia (Optional)</h4>
                 <p class="form-hint">Add an introductory image, video, or presentation displayed above the projects on the course page.</p>
                 <label for="editCourseMultimediaType">Multimedia Type:</label>
                 <select id="editCourseMultimediaType" onchange="toggleCourseMultimediaEditorFields(this.value)">
                     <option value="none">None (Hidden)</option>
                     <option value="image">Image</option>
                     <option value="video">Video Embed</option>
                     <option value="presentation">Presentation Embed</option>
                 </select>

                 <div id="courseMultimediaEditorFieldsContainer" class="course-multimedia-editor-fields" style="display:none;"> 
                     <label for="editCourseMultimediaUrl">Media URL:</label>
                     <input type="url" id="editCourseMultimediaUrl" placeholder="Enter Image URL or Embed URL...">

                     <label for="editCourseMultimediaTitle">Media Title (Optional):</label>
                     <input type="text" id="editCourseMultimediaTitle" placeholder="e.g., Course Intro Video (used for accessibility)">
                 </div>
             </section>
             <!-- === End Course Multimedia Editor === -->


            <!-- Course Theme Color Editor -->
            <section id="courseStyleEditor" class="edit-section">
                 <h4>Course Theme Colors</h4>
                 <p class="form-hint">Set the main colors used globally unless overridden by a specific project.</p>
                 <label>Primary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('primary', '#5E81F4')" title="Blue"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('primary', '#FF7AC6')" title="Pink"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('primary', '#7CE7AC')" title="Green"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('primary', '#FFB800')" title="Orange"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('primary', '#9B51E0')" title="Purple"></div>
                     <input type="color" id="coursePrimaryColorPicker" oninput="customCourseColorSelected('primary', this.value)" aria-label="Custom Primary Color">
                 </div>
                 <label>Secondary Color:</label>
                 <div class="color-picker">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('secondary', '#5E81F4')" title="Blue"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('secondary', '#FF7AC6')" title="Pink"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('secondary', '#7CE7AC')" title="Green"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('secondary', '#FFB800')" title="Orange"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('secondary', '#9B51E0')" title="Purple"></div>
                     <input type="color" id="courseSecondaryColorPicker" oninput="customCourseColorSelected('secondary', this.value)" aria-label="Custom Secondary Color">
                 </div>
                 <label>Accent Color:</label>
                 <div class="color-picker">
                      <div class="color-option" style="background-color: #FFB800;" onclick="selectCourseColor('accent', '#FFB800')" title="Orange"></div>
                      <div class="color-option" style="background-color: #FF7AC6;" onclick="selectCourseColor('accent', '#FF7AC6')" title="Pink"></div>
                      <div class="color-option" style="background-color: #7CE7AC;" onclick="selectCourseColor('accent', '#7CE7AC')" title="Green"></div>
                      <div class="color-option" style="background-color: #5E81F4;" onclick="selectCourseColor('accent', '#5E81F4')" title="Blue"></div>
                      <div class="color-option" style="background-color: #9B51E0;" onclick="selectCourseColor('accent', '#9B51E0')" title="Purple"></div>
                     <input type="color" id="courseAccentColorPicker" oninput="customCourseColorSelected('accent', this.value)" aria-label="Custom Accent Color">
                 </div>
            </section>

            <!-- Project Tabs Editor -->
            <section id="projectTabsEditor" class="edit-section">
                 <h4>Manage Project Tabs</h4>
                  <!-- UPDATED Hint Text -->
                 <p class="form-hint">Add, remove, or rename project tabs. Max projects.</p>
                 <div id="projectTabsList">
                     <!-- Project tab edit items will be listed here -->
                 </div>
                 <button type="button" class="add-item-btn" onclick="addProjectTabEditField()">+ Add New Project Tab</button>
            </section>

            <div class="modal-actions">
                 <button type="button" onclick="closeModal('courseEditModal')">Cancel</button>
                 <button type="submit">Save Course</button> 
            </div>
        </form>
    </div>
</div>


<!-- == PROJECT Editor Modal (Merged) == -->
<div id="projectEditModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('projectEditModal')" title="Close Editor" aria-label="Close Project Editor">×</span>
        <h2>Edit Project Details</h2>
         <p style="font-size: 0.9rem; color: #555; margin-bottom: 20px;">Editing project: <strong id="editingProjectNameLabel"></strong></p>
        <form class="edit-form" onsubmit="event.preventDefault(); saveProjectChanges();">
             <input type="hidden" id="editingProjectId"> <!-- Store ID of project being edited -->

            <label for="editSectionProject">Select Section to Edit:</label>
            <select id="editSectionProject" onchange="showProjectEditSection()">
                <option value="projMeta">Project Header & Course Tab</option>
                <option value="overview">Overview & Learn</option>
                <option value="video">Video Lesson</option>
                <option value="slides">Step-by-Step Slides</option>
                <option value="challenges">Challenges</option>
                <option value="quiz">Quiz Questions</option>
                <option value="projStyle">Project Styles (Font, Size, Colors)</option>
            </select>

            <!-- === Project Metadata Edit === -->
            <section id="projMetaEdit" class="edit-section" style="border-top: none; padding-top: 10px;">
                 <h4>Project Header & Course Tab</h4>
                <label for="editProject_Title">Project Title:</label>
                <input type="text" id="editProject_Title" required>
                <label for="editProject_Subtitle">Subtitle:</label>
                <input type="text" id="editProject_Subtitle" placeholder="Short description for project page header">
                <label for="editProject_HeaderImage">Project Header Image URL:</label>
                <input type="url" id="editProject_HeaderImage" placeholder="https://example.com/header.png">
                <p class="form-hint">Appears on the project page. ~100x100px recommended.</p>
                 <hr style="margin: 20px 0;">
                 <label for="editProject_TabName">Tab Name (on Course Page):</label>
                 <input type="text" id="editProject_TabName" required placeholder="e.g., Beating Heart">
                 <label for="editProject_TabImage">Tab Image URL (on Course Page):</label>
                 <input type="url" id="editProject_TabImage" placeholder="https://example.com/grid-image.jpg">
                 <p class="form-hint">Appears on the main course grid. Square image (~300x300px) recommended.</p>
            </section>

            <!-- === Overview & Learn Edit === -->
            <section id="overviewEdit" class="edit-section" style="display:none;">
                 <h4>Overview Content</h4>
                <label for="editProject_OverviewText">Overview Text:</label>
                <textarea id="editProject_OverviewText" rows="5" placeholder="Describe the project..."></textarea>
                 <hr style="margin: 25px 0;">
                  <h4>"What You'll Learn" Items</h4>
                  <p class="form-hint">Add key learning objectives. Optionally include media. Max items.</p>
                  <div id="learnEditContainer"> <!-- Populated by loadLearnEditFieldsForProject --> </div>
                  <button type="button" class="add-item-btn" onclick="addLearnEditField()">+ Add Learning Item</button>
            </section>

            <!-- === Video Edit === -->
            <section id="videoEdit" class="edit-section" style="display:none;">
                 <h4>Video Lesson Content</h4>
                 <label for="editProject_VideoIntroText">Introduction Text (Above Video):</label>
                 <input type="text" id="editProject_VideoIntroText" placeholder="e.g., Watch this video to see how it's done...">
                 <label for="editProject_VideoTitle">Video Section Title (Above Video):</label>
                 <input type="text" id="editProject_VideoTitle" placeholder="e.g., Programming the Animation">
                 <label for="editProject_VideoUrl">Video Embed URL:</label>
                 <input type="url" id="editProject_VideoUrl" placeholder="e.g., https://www.youtube.com/embed/VIDEO_ID">
                 <label for="editProject_VideoKeyPoints">Key Points (one per line, below video):</label>
                 <textarea id="editProject_VideoKeyPoints" rows="5" placeholder="Point 1
Point 2
Point 3..."></textarea>
            </section>

            <!-- === Slides Edit === -->
            <section id="slidesEdit" class="edit-section" style="display:none;">
                <h4>Step-by-Step Slides</h4>
                <p class="form-hint">Add slides with multimedia content (image or embed URL). Max slides.</p>
                <div id="slidesEditContainer"> <!-- Populated by loadSlidesEditFieldsForProject --> </div>
                <button type="button" class="add-item-btn" onclick="addSlideEditField()">+ Add Slide</button>
            </section>

            <!-- === Challenges Edit === -->
            <section id="challengesEdit" class="edit-section" style="display:none;">
                <h4>Project Challenges</h4>
                <p class="form-hint">Add challenges for users, optionally with an image or video. Max challenges.</p>
                <div id="challengesEditContainer"> <!-- Populated by loadChallengesEditFieldsForProject --> </div>
                <button type="button" class="add-item-btn" onclick="addChallengeEditField()">+ Add Challenge</button>
            </section>

            <!-- === Quiz Edit === -->
            <section id="quizEdit" class="edit-section" style="display:none;">
                <h4>Quiz Questions</h4>
                <p class="form-hint">Add questions. Mark one answer as correct. Provide 3 incorrect options. </p>
                 <div id="quizEditContainer"> <!-- Populated by loadQuizEditFieldsForProject --> </div>
                 <button type="button" class="add-item-btn" onclick="addQuizEditField()">+ Add Question</button>
            </section>

            <!-- === Project Style Edit === -->
            <section id="projStyleEdit" class="edit-section" style="display:none;">
                 <h4>Project Specific Styles</h4>
                 <p class="form-hint">Optionally override the global course styles just for this project.</p>

                 <h5>Color Overrides</h5>
                 <p class="form-hint" style="margin-bottom: 10px;">Select colors below to override the main course theme for this project only. The color picker will show a dashed border if inheriting the course color.</p>
                  <button type="button" onclick="clearProjectColorOverrides()" style="font-size: 0.85rem; padding: 5px 10px; margin-bottom: 20px; background-color: #bbb; font-weight: normal; box-shadow: none;">Use Course Default Colors</button>

                 <label>Project Primary Color Override:</label>
                 <div class="color-picker" id="projectPrimaryColorPickerContainer">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('primary', '#5E81F4')" title="Blue"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('primary', '#FF7AC6')" title="Pink"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('primary', '#7CE7AC')" title="Green"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('primary', '#FFB800')" title="Orange"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('primary', '#9B51E0')" title="Purple"></div>
                     <input type="color" id="projectPrimaryColorPicker" oninput="customProjectColorSelected('primary', this.value)" aria-label="Custom Project Primary Color">
                 </div>
                 <label>Project Secondary Color Override:</label>
                 <div class="color-picker" id="projectSecondaryColorPickerContainer">
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('secondary', '#5E81F4')" title="Blue"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('secondary', '#FF7AC6')" title="Pink"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('secondary', '#7CE7AC')" title="Green"></div>
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('secondary', '#FFB800')" title="Orange"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('secondary', '#9B51E0')" title="Purple"></div>
                     <input type="color" id="projectSecondaryColorPicker" oninput="customProjectColorSelected('secondary', this.value)" aria-label="Custom Project Secondary Color">
                 </div>
                 <label>Project Accent Color Override:</label>
                 <div class="color-picker" id="projectAccentColorPickerContainer">
                     <div class="color-option" style="background-color: #FFB800;" onclick="selectProjectColor('accent', '#FFB800')" title="Orange"></div>
                     <div class="color-option" style="background-color: #FF7AC6;" onclick="selectProjectColor('accent', '#FF7AC6')" title="Pink"></div>
                     <div class="color-option" style="background-color: #7CE7AC;" onclick="selectProjectColor('accent', '#7CE7AC')" title="Green"></div>
                     <div class="color-option" style="background-color: #5E81F4;" onclick="selectProjectColor('accent', '#5E81F4')" title="Blue"></div>
                     <div class="color-option" style="background-color: #9B51E0;" onclick="selectProjectColor('accent', '#9B51E0')" title="Purple"></div>
                     <input type="color" id="projectAccentColorPicker" oninput="customProjectColorSelected('accent', this.value)" aria-label="Custom Project Accent Color">
                 </div>

                 <h5 style="margin-top: 30px;">Font & Size Override</h5>
                 <label>Font Family Override:</label>
                 <div class="font-selector" id="projectFontSelector">
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', null)" >Use Course Default</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Segoe UI', sans-serif`)" style="font-family: 'Segoe UI', sans-serif;">Segoe UI</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Arial', Helvetica, sans-serif`)" style="font-family: Arial, sans-serif;">Arial</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Georgia', 'Times New Roman', serif`)" style="font-family: Georgia, serif;">Georgia</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Courier New', monospace`)" style="font-family: 'Courier New', monospace;">Courier New</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Verdana', Geneva, sans-serif`)" style="font-family: Verdana, sans-serif;">Verdana</div>
                     <div class="font-option" onclick="selectProjectStyle('fontFamily', `'Comic Sans MS', cursive, sans-serif`)" style="font-family: 'Comic Sans MS', cursive;">Comic Sans</div>
                 </div>

                 <label>Base Text Size Override:</label>
                 <div class="size-selector" id="projectSizeSelector">
                      <div class="size-option" onclick="selectProjectStyle('baseSize', null)">Use Course Default</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'small')">Small (14px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'medium')">Medium (16px)</div>
                     <div class="size-option" onclick="selectProjectStyle('baseSize', 'large')">Large (18px)</div>
                 </div>
            </section>

            <div class="modal-actions">
                <button type="button" onclick="closeModal('projectEditModal')">Cancel</button>
                <button type="submit">Save Project</button>
            </div>
        </form>
    </div>
</div>


<script>
    // --- Global Data Storage ---
    let courseData = {
        title: "Micro:bit Level 1",
        description: "Explore the exciting world of physical computing with the BBC micro:bit! This course contains several projects designed to introduce you to coding concepts and hardware interaction in a fun, hands-on way.",
        imageUrl: "https://static.wixstatic.com/media/ecb02e_d86006f33f6c4a448e2c1ec1517c2690~mv2.png",
        // NEW: Course Multimedia Data
        courseMultimedia: {
             type: 'video', // 'none', 'image', 'video', 'presentation'
             url: 'https://video.wixstatic.com/video/ecb02e_618c362136c24e12886ac4ef43b86562/720p/mp4/file.mp4', // Example Image URL
             title: 'Introduction to Microbit', // Optional title/alt text
             minimized: false ,// Initial state
             attributes: {
                 autoplay: false,
                 paused: true  // Custom attribute your player might check
          }
         },
        // Course-level theme colors
        style: {
            primaryColor: '#5E81F4',   // Blue
            secondaryColor: '#FF7AC6', // Pink
            accentColor: '#FFB800',    // Orange
            // No course-level font/size needed here, defaults in :root CSS
        },
        projects: [
            // Project 1: Catch and Win Game (Data merged from project page)
            {
                id: 'proj_catch and win',
                tabName: "8.Catch and Win",
                tabImage: "https://static.wixstatic.com/media/ecb02e_da4d01ce625b4cc0a0f79b7e553f50f9~mv2.gif", // MakeCode Share Image
                projectTitle: "Catch and Win Game",
                projectSubtitle: "Make your Own game with Microbit",
                projectHeaderImage: "https://static.wixstatic.com/media/ecb02e_0d14c8f0fcc740b49dd9dee5dddf4802~mv2.gif",
                overviewText: " Turn your Micro:bit into a fun arcade-style game! Control a paddle at the bottom of the screen using the A and B buttons to catch falling objects. Every successful catch earns you points, but miss too many, and it’s game over !",
                videoIntroText: 'none',
                videoTitle: "Catcha and Win Game Play",
                videoUrl: "https://video.wixstatic.com/video/ecb02e_6cd237055ba94d3aa4c314361c4a6619/720p/mp4/file.mp4", // Example Video
                videoKeyPoints: [
                    "The player sprite is controlled with Button A (left) and Button B (right).",
                    "Falling objects spawn randomly at the top (y=0) of the 5x5 LED grid.",
                    "Collision happens when object's (x,y) matches player's (x,4) position.",
                    "Use 'plot (x,y)' to display and 'unplot (x,y)' to clear sprites.",
                    "The 'forever' block handles continuous game movement and logic.",
                    "'pause (ms)' controls game speed (lower = faster difficulty).",
                    "Variables track score, player_x position, and missed objects count.",
                    "Game ends when missed objects reach a set limit (e.g., 3 misses).",
                    "'show number' displays the final score when game ends."
                 ],
                learnData: [
                    { title: "Micro:bit LEDs", description: "Understand the 5x5 LED grid and how each LED can be turned on or off.", mediaType: 'image', mediaUrl: 'https://os.mbed.com/docs/mbed-os/v6.16/apis/assets/images/Glossary_MB_LEDMatrix.png' },
                    { title: "'Forever' Loop", description: "Learn how the 'forever' block continuously runs the code inside it, essential for animations.", mediaType: 'none', mediaUrl: '' },
                    { title: "Displaying Images", description: "Explore using 'show leds' to draw custom shapes and 'show icon' for built-in images like hearts.", mediaType: 'image', mediaUrl: 'https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif' },
                    { title: "Timing with 'Pause'", description: "Understand how the 'pause (ms)' block controls the speed of the animation by creating delays.", mediaType: 'none', mediaUrl: '' },
                    { title: "Sequencing", description: "Recognize that the order of code blocks determines the sequence of the animation steps.", mediaType: 'none', mediaUrl: '' }
                ],
                slidesData: [
                    { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_7cvWKT73g7Pv", description: "1. Final Code: This is what the completed code blocks look like.", type: "iframe" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-2.gif", description: "2. Drag out a 'show leds' block into the 'forever' loop.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-3.gif", description: "3. Draw the large heart shape by clicking the squares.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-4.gif", description: "4. Add a 'pause (ms)' block and set it to 500ms (half a second).", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-5.gif", description: "5. Add another 'show leds' block and draw the small heart.", type: "image" },
                    { url: "https://microbit.org/images/lessons/flashing-heart/animated-step-6.gif", description: "6. Add a final 'pause (ms)' block, also set to 500ms.", type: "image" },
                ],
                challengesData: [
                    { title: "Speed Control", description: "Experiment by changing the numbers in the 'pause (ms)' blocks. What happens if you use 1000? What about 100?", mediaType: 'none', mediaUrl: '' },
                    { title: "Different Icon", description: "Instead of 'show leds', try using the 'show icon' block with different heart sizes (Heart, SmallHeart). Does it look different?", mediaType: 'none', mediaUrl: '' },
                    { title: "Your Own Animation", description: "Create a completely different two-frame animation. Maybe a blinking eye or a simple shape that grows and shrinks?", mediaType: 'image', mediaUrl: 'https://lancaster-university.github.io/microbit-docs/assets/images/microbit-smiley.png' },
                ],
                quizData: [
                    { questionText: "Which block makes code run over and over again?", correctAnswer: "'forever'", incorrectAnswers: ["'on start'", "'pause (ms)'", "'show icon'"] },
                    { questionText: "How many LEDs are in the Micro:bit's display grid?", correctAnswer: "25 (5x5)", incorrectAnswers: ["10 (2x5)", "5 (1x5)", "50 (5x10)"] },
                    { questionText: "What unit does the 'pause (ms)' block use?", correctAnswer: "Milliseconds", incorrectAnswers: ["Seconds", "Minutes", "Microseconds"] },
                    { questionText: "To make an animation, you show an image, then _______, then show another image.", correctAnswer: "Pause", incorrectAnswers: ["Stop", "Repeat", "Shake"] }
                ],
                // Project specific style overrides (null = inherit from course)
                style: {
                    fontFamily: null, // Inherit Font
                    baseSize: null, // Inherit size
                    primaryColor: '#E63946', // Red Primary for this project only
                    secondaryColor: '#F1FAEE', // Off-white Secondary
                    accentColor: '#A8DADC', // Light Blue Accent
                 },
                 isCompleted: false // Completion flag
            },
            // Project 2: Smiley Buttons (Basic data for structure)
            {
                 id: 'proj_smiley',
                 tabName: "Smiley Buttons",
                 tabImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K", // MakeCode Share Image
                 projectTitle: "Smiley Buttons Interaction",
                 projectSubtitle: "Show different faces when buttons A and B are pressed.",
                 projectHeaderImage: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K",
                 overviewText: "Learn how to make your Micro:bit react to input! In this project, pressing button A will show a happy face, and pressing button B will show a sad face. This introduces event handling and basic input.",
                 videoIntroText: "This video demonstrates how to use the 'on button pressed' blocks:",
                 videoTitle: "Handling Button Inputs",
                 videoUrl: "https://www.youtube.com/embed/Gk_Q8Rv9AlU", // Example Video
                 videoKeyPoints: [
                     "Use 'on button A pressed' block to detect button A clicks.",
                     "Use 'on button B pressed' block for button B.",
                     "Code inside these blocks only runs when the corresponding button is pressed.",
                     "'show icon' is useful for displaying standard faces."
                    ],
                 learnData: [
                     {title:"Input Events", description:"Understand that 'on button pressed' blocks trigger code based on an external event (a button click).", mediaType:'none', mediaUrl:''},
                     {title:"Event Handlers", description:"Learn that these specific blocks handle specific events.", mediaType:'none', mediaUrl:''},
                     {title:"Button Identification", description:"Distinguish between button A and button B on the Micro:bit.", mediaType:'image', mediaUrl:'https://teach.microbit.org/images/buttons.png'}
                  ],
                 slidesData: [
                    { url: "https://makecode.microbit.org/v0/beta-sim.html?nohw=1#pub:_LL1gP83dhL7K", description: "1. Final Code: Separate blocks for Button A and Button B presses.", type: "iframe" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-2.gif", description: "2. Drag out an 'on button A pressed' block.", type: "image" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-3.gif", description: "3. Place a 'show icon' block inside and select the Happy face.", type: "image" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-4.gif", description: "4. Drag out another 'on button pressed' block and change 'A' to 'B'.", type: "image" },
                    { url: "https://microbit.org/images/lessons/smiley-buttons/animated-step-5.gif", description: "5. Place a 'show icon' block inside the 'B' block and select the Sad face.", type: "image" },
                 ],
                 challengesData: [
                     {title: "Surprise Face!", description: "Can you add an 'on button A+B pressed' block to show a 'Surprised' face when both buttons are pressed together?", mediaType:'none', mediaUrl:''},
                     {title: "Clear the Screen", description: "Add a 'clear screen' block inside each button press event *before* showing the icon. What changes?", mediaType:'none', mediaUrl:''},
                     {title: "Different Icons", description: "Choose completely different icons for button A and button B.", mediaType:'none', mediaUrl:''}
                 ],
                 quizData: [
                     {questionText: "Which block runs code ONLY when Button A is clicked?", correctAnswer:"'on button A pressed'", incorrectAnswers:["'forever'", "'on start'", "'show leds'"]},
                     {questionText: "What is the term for something that happens outside the normal code flow, like a button press?", correctAnswer:"Event", incorrectAnswers:["Loop", "Variable", "Sequence"]},
                     {questionText: "If you want to show a pre-drawn image, which block is often easiest?", correctAnswer:"'show icon'", incorrectAnswers:["'show leds'", "'pause (ms)'", "'clear screen'"]}
                 ],
                 // Default style (inherits all from course)
                 style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null },
                 isCompleted: false
             }
            // Add more project objects here... (up to 15)
        ]
    };

    // State variables
    let currentProjectId = null; // ID of the project being viewed/edited
    let currentProjectDataCache = null; // Temporary store for project data during editing
    let currentSlideIndex = 0;

    // --- Constants for limits ---
    // UPDATED Project Limit
    const MAX_PROJECTS = 15;
    const MAX_SLIDES = 10; const MAX_CHALLENGES = 10;
    const MAX_LEARN_ITEMS = 8; const MAX_QUIZ_QUESTIONS = 10; const MAX_INCORRECT_ANSWERS = 3;

    // --- THEME APPLICATION ---
    // Helper to convert hex to RGB for CSS variables
    function hexToRgb(hex) {
      let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    }

    function applyThemeColors(primary, secondary, accent) {
        const root = document.documentElement;
        root.style.setProperty('--primary', primary || '#5E81F4');
        root.style.setProperty('--secondary', secondary || '#FF7AC6');
        root.style.setProperty('--accent', accent || '#FFB800');

        // Set RGB versions for potential use in rgba() shadows etc.
        const primaryRgb = hexToRgb(primary || '#5E81F4');
        if (primaryRgb) root.style.setProperty('--primary-rgb', `${primaryRgb.r}, ${primaryRgb.g}, ${primaryRgb.b}`);
        const secondaryRgb = hexToRgb(secondary || '#FF7AC6');
        if (secondaryRgb) root.style.setProperty('--secondary-rgb', `${secondaryRgb.r}, ${secondaryRgb.g}, ${secondaryRgb.b}`);
    }

    function applyCourseTheme() {
        console.log("Applying COURSE theme");
        const courseStyle = courseData.style || {};
        applyThemeColors(courseStyle.primaryColor, courseStyle.secondaryColor, courseStyle.accentColor);

        // Apply global font/size defaults (these vars are used by body style)
        const root = document.documentElement;
        root.style.setProperty('--base-font-family', `'Segoe UI', sans-serif`); // Course default font
        root.style.setProperty('--base-font-size', '16px'); // Course default size

        // Ensure project-specific inline styles are cleared when returning to course view
        const projectViewEl = document.getElementById('project-view');
         if (projectViewEl) {
             projectViewEl.style.fontFamily = '';
             projectViewEl.style.fontSize = '';
        }
    }

    function applyProjectSpecificStyles(project) {
        if (!project) return;
        console.log("Applying PROJECT specific styles (if any) for:", project.id);
        const projectStyle = project.style || {};
        const courseStyle = courseData.style || {}; // Fallback to course style

        // Apply Color Overrides (only if defined in project style, otherwise use course)
        applyThemeColors(
            projectStyle.primaryColor || courseStyle.primaryColor,
            projectStyle.secondaryColor || courseStyle.secondaryColor,
            projectStyle.accentColor || courseStyle.accentColor
        );

        // Apply Font Family Override (directly on #project-view element)
        const projectViewEl = document.getElementById('project-view');
        if (projectViewEl) {
             const projectFont = projectStyle.fontFamily; // Can be null
             // Use project font if set, otherwise fall back to the CSS variable (which reflects course default)
             projectViewEl.style.fontFamily = projectFont ? projectFont : 'var(--base-font-family)';
        }

        // Apply Base Size Override (directly on #project-view element)
        if (projectViewEl) {
             const projectSize = projectStyle.baseSize; // Can be null, 'small', 'medium', 'large'
             let effectiveFontSize = 'var(--base-font-size)'; // Use CSS variable (reflects course default) by default
             if (projectSize === 'small') effectiveFontSize = '14px';
             else if (projectSize === 'large') effectiveFontSize = '18px';
             else if (projectSize === 'medium') effectiveFontSize = '16px'; // Explicit medium override

             projectViewEl.style.fontSize = effectiveFontSize;
        }
    }


    // --- VIEW NAVIGATION ---
    function showCourseView() {
        document.getElementById('course-view').style.display = 'block';
        document.getElementById('project-view').style.display = 'none';
        currentProjectId = null;
        currentProjectDataCache = null;
        document.title = courseData.title || "Course Viewer";
        applyCourseTheme(); // Reset theme to course defaults
        renderCoursePage(); // Re-render to show updated completion ticks AND multimedia section
        window.scrollTo(0, 0);
    }

    function showProjectView(projectId) {
        const project = courseData.projects.find(p => p.id === projectId);
        if (!project) {
            console.error(`Project with ID ${projectId} not found!`);
            showCourseView(); // Go back if project doesn't exist
            return;
        }

        currentProjectId = projectId;
        // DO NOT cache here for viewing, only for editing. Render directly from courseData.

        renderProjectPage(project); // Populate the project view template with data

        document.getElementById('course-view').style.display = 'none';
        document.getElementById('project-view').style.display = 'block';
        document.title = project.projectTitle || "Project Viewer";

        // Apply course theme first, then project-specific overrides
        applyCourseTheme();
        applyProjectSpecificStyles(project);

        window.scrollTo(0, 0);
         // Update history for potential back button usage / deep linking
         try { history.pushState({ projectId: projectId }, project.projectTitle || '', `#project-${projectId}`); } catch (e) { console.warn("History API not supported or pushState failed."); }
    }
     // Handle browser back/forward navigation
     window.onpopstate = function(event) {
         if (event.state && event.state.projectId) {
             showProjectView(event.state.projectId);
         } else {
             showCourseView();
         }
     };


    // --- COURSE PAGE RENDERING ---
    function renderCoursePage() {
        console.log("Rendering Course Page");
        const course = courseData;

        // Update Course Header
        document.getElementById('courseTitle').textContent = course.title;
        const courseImg = document.getElementById('courseImage');
        if(courseImg) { courseImg.src = course.imageUrl || ''; courseImg.alt = course.title + " Image"; }
        document.getElementById('courseDescription').textContent = course.description;

        // === Render Course Multimedia ===
        renderCourseMultimedia();

        // === Render Project Grid ===
        const grid = document.getElementById('projectGrid');
        grid.innerHTML = ''; // Clear existing

        if (!course.projects || course.projects.length === 0) {
            grid.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No projects have been added to this course yet.</p>';
            return;
        }

        course.projects.forEach(project => {
            if (!project || !project.id) return; // Skip if project or ID is missing

            const tab = document.createElement('a');
            tab.className = 'project-tab';
            tab.href = `#project-${project.id}`;
            // Prevent default link behavior, use JS navigation
            tab.onclick = (event) => { event.preventDefault(); showProjectView(project.id); };

            const img = document.createElement('img');
            img.src = project.tabImage || 'https://via.placeholder.com/300x200/eee/999?text=Project';
            img.alt = project.tabName || 'Project Tab';
            img.loading = 'lazy';

            const infoDiv = document.createElement('div');
            infoDiv.className = 'project-tab-info';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = project.tabName || 'Unnamed Project';
            infoDiv.appendChild(nameSpan);

            tab.appendChild(img);
            tab.appendChild(infoDiv);

            // Add completion tick if project is completed
            if (project.isCompleted) {
                const tick = document.createElement('span');
                tick.className = 'completion-tick';
                tick.innerHTML = '✔'; // Checkmark symbol
                tick.setAttribute('aria-label', 'Project Completed');
                tick.title = 'Project Completed';
                tab.appendChild(tick);
            }

            grid.appendChild(tab);
        });
    }

    // --- NEW: Course Multimedia Rendering ---
    function renderCourseMultimedia() {
         const section = document.getElementById('course-multimedia-section');
         const contentDiv = document.getElementById('course-multimedia-content');
         const toggleBtn = document.getElementById('toggle-multimedia-btn');
         const multimediaData = courseData.courseMultimedia || { type: 'none', url: '', title: '', minimized: false };

         if (!section || !contentDiv || !toggleBtn) {
             console.error("Multimedia elements not found in DOM.");
             return;
         }

         // Reset state
         contentDiv.innerHTML = '';
         section.classList.remove('multimedia-minimized');

         if (multimediaData.type === 'none' || !multimediaData.url) {
             section.style.display = 'none'; // Hide the entire section
             return;
         }

         // Show the section if type is not 'none' and URL exists
         section.style.display = 'block';

         const url = multimediaData.url.trim();
         const title = multimediaData.title?.trim() || 'Course Multimedia'; // Use provided title or default

         // Create media element based on type
         if (multimediaData.type === 'image') {
             const img = document.createElement('img');
             img.src = url;
             img.alt = title;
             img.loading = 'lazy';
             contentDiv.appendChild(img);
         } else if (multimediaData.type === 'video' || multimediaData.type === 'presentation') {
             // Use a wrapper for potential aspect ratio styling
             const wrapper = document.createElement('div');
             wrapper.className = 'media-wrapper-16-9'; // Add class for 16:9 aspect ratio
             const iframe = document.createElement('iframe');

             let videoUrl = new URL(url);
    
             // Check if it's YouTube
              if (url.includes('youtube.com') || url.includes('youtu.be')) {
                     videoUrl.searchParams.set('autoplay', '0'); // YouTube style
                  } 
                 // Assume Wix or other if not YouTube
             else {
                 videoUrl.searchParams.set('autoplay', 'false'); // Wix style
                  }
    
             iframe.src = videoUrl.toString();           
             iframe.title = title;
             iframe.frameBorder = "0";
             iframe.loading = 'lazy';
             iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
             iframe.allowFullscreen = true;
             iframe.sandbox="allow-scripts allow-same-origin allow-presentation"; // Security for embeds
             wrapper.appendChild(iframe);
             contentDiv.appendChild(wrapper);
         } else {
             contentDiv.innerHTML = '<p style="color: #888; font-style: italic;">Unsupported multimedia type.</p>';
         }

         // Set initial minimized state and button text/symbol
         if (multimediaData.minimized) {
             section.classList.add('multimedia-minimized');
             toggleBtn.innerHTML = '+'; // Plus symbol for expand
             toggleBtn.title = 'Maximize';
             toggleBtn.setAttribute('aria-label', 'Maximize Multimedia');
         } else {
             section.classList.remove('multimedia-minimized');
             toggleBtn.innerHTML = '—'; // Minus symbol for minimize
             toggleBtn.title = 'Minimize';
             toggleBtn.setAttribute('aria-label', 'Minimize Multimedia');
         }
    }

     // --- NEW: Toggle Course Multimedia Visibility ---
     function toggleCourseMultimedia() {
         const section = document.getElementById('course-multimedia-section');
         const toggleBtn = document.getElementById('toggle-multimedia-btn');
         if (!section || !toggleBtn || !courseData.courseMultimedia) return;

         // Toggle the state in data
         courseData.courseMultimedia.minimized = !courseData.courseMultimedia.minimized;

         // Toggle the class and button appearance
         section.classList.toggle('multimedia-minimized');
         if (courseData.courseMultimedia.minimized) {
             toggleBtn.innerHTML = '+'; // Plus symbol
             toggleBtn.title = 'Maximize';
             toggleBtn.setAttribute('aria-label', 'Maximize Multimedia');
         } else {
             toggleBtn.innerHTML = '—'; // Minus symbol
             toggleBtn.title = 'Minimize';
             toggleBtn.setAttribute('aria-label', 'Minimize Multimedia');
         }
     }


    // --- PROJECT PAGE RENDERING ---
    function renderProjectPage(project) {
        console.log("Rendering Project:", project?.projectTitle);
        if (!project) {
            console.error("renderProjectPage called with null project");
            return;
        }

        const projectView = document.getElementById('project-view');
        if (!projectView) return;

        // Populate Project Header
        const projectHeader = projectView.querySelector('#project-header');
        if (projectHeader) {
            projectHeader.querySelector('#projectImage').src = project.projectHeaderImage || project.tabImage || 'https://via.placeholder.com/100x100/eee/999?text=Proj';
            projectHeader.querySelector('#projectImage').alt = project.projectTitle + " Header Image";
            projectHeader.querySelector('#projectTitle').textContent = project.projectTitle || 'Project Title';
            projectHeader.querySelector('#projectSubtitle').textContent = project.projectSubtitle || '';
        }

        // -- Populate Project Tab Content --
        const contentContainer = projectView.querySelector('#projectTabContentContainer');
        if (!contentContainer) return;

        // Overview Tab
        const overviewContent = contentContainer.querySelector('#overview');
        if (overviewContent) {
            overviewContent.querySelector('#overviewText').textContent = project.overviewText || 'No overview provided.';
            renderLearnItemsForProject(project.learnData || [], overviewContent.querySelector('#learnContainer'));
        } else { console.warn("Overview content area not found"); }

        // Video Tab
        const videoContent = contentContainer.querySelector('#video');
        if (videoContent) {
             const videoIframe = videoContent.querySelector('#mainVideo');
             const keyPointsUL = videoContent.querySelector('#videoKeyPoints');
             videoContent.querySelector('#videoIntroText').textContent = project.videoIntroText || '';
             videoContent.querySelector('#videoTitle').textContent = project.videoTitle || '';
             if(videoIframe) videoIframe.src = project.videoUrl || '';
             if(keyPointsUL) {
                 keyPointsUL.innerHTML = ''; // Clear old points
                 if (project.videoKeyPoints && project.videoKeyPoints.length > 0) {
                     project.videoKeyPoints.forEach(p => {
                          if (p && p.trim()) {
                              const li = document.createElement('li'); li.textContent = p; keyPointsUL.appendChild(li);
                          }
                     });
                 }
                 if (keyPointsUL.innerHTML === '') keyPointsUL.innerHTML = '<li style="color: #888; font-style: italic;">No key points provided.</li>';
             }
        } else { console.warn("Video content area not found"); }

        // Slides Tab
        const slidesContent = contentContainer.querySelector('#slides');
        if (slidesContent) {
            renderSlideshowForProject(project.slidesData || [], slidesContent.querySelector('#slideshowContainer'));
        } else { console.warn("Slides content area not found"); }

        // Challenges Tab
        const challengesContent = contentContainer.querySelector('#challenges');
        if (challengesContent) {
            renderChallengesForProject(project.challengesData || [], challengesContent.querySelector('#challengesContainer'));
        } else { console.warn("Challenges content area not found"); }

        // Quiz Tab
        const quizContent = contentContainer.querySelector('#quiz');
        if (quizContent) {
             renderQuizForProject(project.quizData || [], quizContent.querySelector('#quizContainer'), quizContent.querySelector('#submitQuizBtn'));
        } else { console.warn("Quiz content area not found"); }

        // Activate the first project tab ('Overview') and update progress
        const projectTabsBar = projectView.querySelector('#projectTabs');
        if (projectTabsBar) {
             const firstProjectTabButton = projectTabsBar.querySelector('.tab'); // Assume first is Overview
             if (firstProjectTabButton) {
                  // Find the tabName from the first button's onclick
                  const clickAttr = firstProjectTabButton.getAttribute('onclick') || '';
                  const match = clickAttr.match(/openProjectTab\('([^']+)'/);
                  const firstTabName = match ? match[1] : 'overview'; // Default to overview if parsing fails
                  openProjectTab(firstTabName, firstProjectTabButton);
             } else {
                  updateProjectProgressBar(''); // Reset progress if no tabs
             }
        }
    }


    // --- Project Specific Content Rendering Helpers ---
    function renderLearnItemsForProject(learnItemsData, container) {
         if (!container) return; container.innerHTML = '';
         const validItems = (learnItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p style="color: #888; font-style: italic;">No learning objectives specified.</p>'; return; }
         validItems.forEach((item, index) => {
             const el = document.createElement('div'); el.className = 'step'; // Use step styling
             el.innerHTML = `<div class="step-number">${index + 1}</div>
                             <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
             if(item.description) el.querySelector('p.description').textContent = item.description;

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                 const url = item.mediaUrl.trim();
                 if (url) { // Check if URL is not empty after trim
                    mediaDiv.style.display = 'block';
                    const title = item.title || 'Media';
                    if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                    else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
                 }
             }
             container.appendChild(el);
         });
    }

    function renderChallengesForProject(challengesItemsData, container) {
         if (!container) return; container.innerHTML = '';
         const validItems = (challengesItemsData || []).filter(item => item.title && item.title.trim());
         if (validItems.length === 0) { container.innerHTML = '<p style="color: #888; font-style: italic;">No challenges specified for this project.</p>'; return; }
         validItems.forEach((item) => {
             const el = document.createElement('div'); el.className = 'step'; // Reuse step styling
             el.innerHTML = `<div class="step-number" style="background-color: var(--accent); color: var(--dark); display: flex; justify-content: center; align-items: flex-start; padding-top: 5px;">★</div>
                              <div class="step-content">
                                 <strong></strong>
                                 ${ item.description ? '<p class="description"></p>' : '' }
                                 <div class="step-media" style="display: none;"></div>
                             </div>`;
             el.querySelector('strong').textContent = item.title;
            if(item.description) el.querySelector('p.description').textContent = item.description;

             const mediaDiv = el.querySelector('.step-media');
             if (item.mediaType && item.mediaType !== 'none' && item.mediaUrl && item.mediaUrl.trim()) {
                 const url = item.mediaUrl.trim();
                  if (url) { // Check if URL is not empty after trim
                     mediaDiv.style.display = 'block';
                     const title = item.title || 'Media';
                     if (item.mediaType === 'image') mediaDiv.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
                     else if (item.mediaType === 'video') mediaDiv.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
                  }
             }
             container.appendChild(el);
         });
    }

     function renderSlideshowForProject(slidesItemsData, container) {
         const slidesView = container?.closest('.tab-content#slides'); // Get parent tab content
         const nav = slidesView?.querySelector('.slide-nav'); // Find nav within the slides tab
         if (!container || !nav) { console.error("Slideshow container or nav not found"); return; }
         container.innerHTML = '';
         const validSlides = (slidesItemsData || []).filter(slide => slide.url && slide.url.trim());

         if (validSlides.length === 0) {
             container.innerHTML = '<p style="color: #888; font-style: italic;">No slides available for this project.</p>';
             nav.style.display = 'none'; // Hide nav if no slides
             return;
         }

         nav.style.display = 'flex'; // Ensure nav is visible
         validSlides.forEach((slide, index) => {
             const slideDiv = document.createElement('div'); slideDiv.className = 'slide';
             const contentType = slide.type === 'image' ? 'image' : 'iframe';
             const url = slide.url.trim();
             const title = slide.description || `Slide ${index + 1}`;

             slideDiv.innerHTML = `<div class="slide-content-wrapper"></div>${slide.description ? '<p></p>' : ''}`;
             const wrapper = slideDiv.querySelector('.slide-content-wrapper');
             if (contentType === 'iframe') {
                 wrapper.innerHTML = `<iframe src="${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="${title}"></iframe>`;
             } else if (contentType === 'image') {
                 wrapper.innerHTML = `<img src="${url}" loading="lazy" alt="${title}">`;
             }
             if (slide.description) slideDiv.querySelector('p').textContent = slide.description;

             container.appendChild(slideDiv);
         });

         currentSlideIndex = 0;
         showSlide(currentSlideIndex); // Show the first slide
     }

      function renderQuizForProject(quizItemsData, container, submitBtn) {
          if (!container || !submitBtn) { console.error("Quiz container or submit btn not found"); return; }
          container.innerHTML = ''; // Clear previous quiz
          // Remove any previous final result message within the quiz tab content
          container.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();

          submitBtn.disabled = false; // Re-enable button
          submitBtn.style.display = 'none'; // Hide initially

          const validQuestions = (quizItemsData || []).filter(q => q.questionText && q.questionText.trim() && q.correctAnswer && q.correctAnswer.trim());

          if (validQuestions.length === 0) {
              container.innerHTML = '<p style="color: #888; font-style: italic;">No quiz questions available for this project.</p>';
              return; // Keep button hidden
          }

          submitBtn.style.display = 'block'; // Show submit button only if questions exist

          validQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'quiz-question';
                questionDiv.innerHTML = `<p class="question-text"></p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>`;
                questionDiv.querySelector('.question-text').textContent = `${index + 1}. ${q.questionText}`;
                const optionsDiv = questionDiv.querySelector('.quiz-options');

                // Combine correct and valid incorrect answers
                let options = [q.correctAnswer.trim()];
                 (q.incorrectAnswers || []).forEach(ans => { if (ans && ans.trim()) options.push(ans.trim()); });

                shuffleArray(options); // Randomize option order

                options.forEach((optionText) => {
                    const isCorrect = (optionText === q.correctAnswer.trim());
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = optionText;
                    optionEl.setAttribute('role', 'button');
                    optionEl.setAttribute('tabindex', '0');
                    optionEl.onclick = () => selectQuizOption(optionEl);
                    optionEl.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(optionEl); }};
                    optionEl.setAttribute('data-is-correct', isCorrect.toString());
                    optionsDiv.appendChild(optionEl);
                });
               container.appendChild(questionDiv);
          });
      }

    // --- Project-Specific Tab/Progress/Slides/Quiz Interaction ---
    function openProjectTab(tabName, element) {
        const container = document.getElementById('projectTabContentContainer');
        if (!container) return;
        container.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        const buttonsContainer = document.getElementById('projectTabs');
        if (buttonsContainer) buttonsContainer.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        const targetContent = container.querySelector('#' + tabName);
        if (targetContent) targetContent.classList.add('active');
        element?.classList.add('active');
        updateProjectProgressBar(tabName);
    }

    function updateProjectProgressBar(tabName) {
         const progressBar = document.getElementById('progressBar');
         if (!progressBar) return;
         let progress = 0;
         const tabOrder = ['overview', 'video', 'slides', 'challenges', 'quiz'];
         const tabIndex = tabOrder.indexOf(tabName);
         if (tabIndex >= 0) {
             progress = ((tabIndex + 1) / tabOrder.length) * 100;
         }
         progressBar.style.width = progress + '%';
    }

    function showSlide(n) {
        const slides = document.querySelectorAll('#project-view #slideshowContainer .slide');
        const validSlidesCount = slides.length;
        if (validSlidesCount === 0) return;

        slides.forEach(slide => slide.classList.remove('active'));
        currentSlideIndex = (n % validSlidesCount + validSlidesCount) % validSlidesCount;
        if(slides[currentSlideIndex]) {
            slides[currentSlideIndex].classList.add('active');
        }
    }
    function nextSlide() { showSlide(currentSlideIndex + 1); }
    function prevSlide() { showSlide(currentSlideIndex - 1); }

    function selectQuizOption(optionElement) {
        const questionDiv = optionElement.closest('.quiz-question');
        if (!questionDiv || questionDiv.classList.contains('answered')) return;
        // Clear selection only within this question
        questionDiv.querySelectorAll('.quiz-option').forEach(opt => opt.classList.remove('selected'));
        optionElement.classList.add('selected');
    }

    function submitQuiz() {
         const questions = document.querySelectorAll('#project-view #quizContainer .quiz-question');
         let answeredCount = 0, score = 0;
         const totalQuestions = questions.length;
         if (totalQuestions === 0) return;

         let firstUnanswered = null;

         // 1. Check if all questions are answered and reset styles (for potential re-submit scenario - though usually disabled)
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              qDiv.classList.remove('answered'); // Reset state
              qDiv.querySelectorAll('.quiz-feedback').forEach(fb => fb.style.display = 'none');
              qDiv.querySelectorAll('.quiz-option').forEach(opt => {
                   opt.classList.remove('correct', 'incorrect');
                   opt.style.opacity = '1';
                   opt.style.cursor = 'pointer';
                   opt.onclick = () => selectQuizOption(opt); // Re-attach click
                   opt.onkeydown = (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectQuizOption(opt); }};
              });
              // Reset required outline
              qDiv.style.outline = '';
              if (selectedOption) {
                   answeredCount++;
              } else if (!firstUnanswered) {
                   firstUnanswered = qDiv;
              }
         });

         // 2. Stop if not all answered
         if (answeredCount < totalQuestions) {
             alert(`Please answer all ${totalQuestions} questions before submitting!`);
             if(firstUnanswered) {
                 firstUnanswered.scrollIntoView({behavior:'smooth',block:'center'});
                 // Visual cue for the first unanswered question
                 firstUnanswered.style.outline='2px solid var(--danger)';
                 setTimeout(()=> { if(firstUnanswered) firstUnanswered.style.outline=''; }, 2500);
             }
             return;
         }

         // 3. Grade the Quiz
         questions.forEach((qDiv) => {
              const selectedOption = qDiv.querySelector('.quiz-option.selected');
              const feedbackCorrect = qDiv.querySelector('.quiz-feedback.correct');
              const feedbackIncorrect = qDiv.querySelector('.quiz-feedback.incorrect');
              const allOptions = qDiv.querySelectorAll('.quiz-option');

              qDiv.classList.add('answered'); // Mark as answered for display styling
              const isSelectedCorrect = selectedOption.getAttribute('data-is-correct') === 'true';

              // Disable interactions and style options
              allOptions.forEach(opt => {
                   const optIsCorrect = opt.getAttribute('data-is-correct') === 'true';
                   if (optIsCorrect) opt.classList.add('correct');
                   if (opt === selectedOption) {
                       if (!isSelectedCorrect) opt.classList.add('incorrect');
                   } else if (!optIsCorrect) {
                        // Keep opacity 1 for correct answer if it wasn't selected
                        if(!optIsCorrect || opt !== qDiv.querySelector('.quiz-option.correct')) {
                           opt.style.opacity = "0.6";
                        }
                   }
                   opt.style.cursor = "default";
                   opt.onclick = null; opt.onkeydown = null; // Disable interactions
              });

              // Provide feedback
              if (isSelectedCorrect) {
                    score++;
                    if(feedbackCorrect) feedbackCorrect.style.display='block';
              } else {
                  if(feedbackIncorrect) {
                      const correctOptionElement = qDiv.querySelector('.quiz-option.correct');
                      feedbackIncorrect.textContent = `Not quite. The correct answer was: "${correctOptionElement ? correctOptionElement.textContent : 'N/A'}".`;
                      feedbackIncorrect.style.display='block';
                  }
              }
         });

         // 4. Show Final Result & Mark Complete
         const submitBtn = document.querySelector('#project-view #submitQuizBtn');
         if(submitBtn) submitBtn.disabled = true; // Disable after successful submission

         const quizTabContent = document.querySelector('#project-view #quiz'); // Find the quiz tab content div
         let resultDiv = quizTabContent?.querySelector('.final-quiz-result');
         if (!resultDiv && quizTabContent) { // Create if doesn't exist, append inside tab content
              resultDiv = document.createElement('div');
              quizTabContent.appendChild(resultDiv);
          }

          if (resultDiv) {
              const scorePercent = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
              const passThreshold = 70; // Example passing threshold (70%)
              const passed = scorePercent >= passThreshold;

              resultDiv.textContent = `Quiz Complete! You scored ${score} out of ${totalQuestions} (${scorePercent}%).`;
              resultDiv.className = 'final-quiz-result ' + (passed ? 'success' : 'fail');
              resultDiv.style.display = 'block';
              resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });

              // Mark project as completed if quiz was passed
              if (passed && currentProjectId) {
                  markProjectAsCompleted(currentProjectId);
                  // The visual update (tick mark) happens when navigating back to course view
              }
          }
    }

     function markProjectAsCompleted(projectId) {
         const project = courseData.projects.find(p => p.id === projectId);
         if (project && !project.isCompleted) {
             console.log(`Marking project ${projectId} as completed.`);
             project.isCompleted = true;
             // TODO: Add persistence logic here if needed (e.g., localStorage)
             // localStorage.setItem(`completion_${projectId}`, 'true');
         }
     }

     // --- Check completion status on load (if using persistence) ---
     function checkProjectCompletionStatus() {
        // Example using localStorage:
        // courseData.projects.forEach(project => {
        //    if (localStorage.getItem(`completion_${project.id}`) === 'true') {
        //       project.isCompleted = true;
        //    }
        // });
     }

    // --- MODAL & EDITING LOGIC ---

    // General Modal Controls
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'none';
        currentProjectDataCache = null; // Clear cache when closing project modal
    }

    // --- Course Editor ---
    function openCourseEditModal() {
         const modal = document.getElementById('courseEditModal');
         if (!modal) return;
         // Load existing course data into fields
         modal.querySelector('#editCourseTitle').value = courseData.title || '';
         modal.querySelector('#editCourseImage').value = courseData.imageUrl || '';
         modal.querySelector('#editCourseDescription').value = courseData.description || '';

          // Load Course Multimedia fields
         const multiData = courseData.courseMultimedia || { type: 'none', url: '', title: '' };
         const multiTypeSelect = modal.querySelector('#editCourseMultimediaType');
         const multiUrlInput = modal.querySelector('#editCourseMultimediaUrl');
         const multiTitleInput = modal.querySelector('#editCourseMultimediaTitle');
         if (multiTypeSelect) multiTypeSelect.value = multiData.type;
         if (multiUrlInput) multiUrlInput.value = multiData.url || '';
         if (multiTitleInput) multiTitleInput.value = multiData.title || '';
         toggleCourseMultimediaEditorFields(multiData.type); // Show/hide fields based on loaded type

         renderProjectTabsEditor(); // Render the list of projects for management
         loadCourseColorSelections(); // Load current course colors into pickers
         modal.style.display = 'block';
    }

    // NEW: Show/hide multimedia URL/Title fields in the COURSE editor
    function toggleCourseMultimediaEditorFields(selectedType) {
         const fieldsContainer = document.getElementById('courseMultimediaEditorFieldsContainer');
         const urlInput = document.getElementById('editCourseMultimediaUrl');
         const titleInput = document.getElementById('editCourseMultimediaTitle');
         if (!fieldsContainer || !urlInput || !titleInput) return;

         if (selectedType === 'none') {
             fieldsContainer.style.display = 'none';
             urlInput.required = false; // Not required if hidden
         } else {
             fieldsContainer.style.display = 'block';
             urlInput.required = true; // URL is required if type is selected
              urlInput.placeholder = (selectedType === 'image') ? 'Enter Image URL...' : 'Enter Video/Presentation Embed URL...';
         }
    }

     function renderProjectTabsEditor() {
         const listContainer = document.getElementById('projectTabsList');
         if (!listContainer) return;
         listContainer.innerHTML = ''; // Clear current list

         (courseData.projects || []).forEach((project, index) => {
             if (!project || !project.id) return;
             const itemDiv = document.createElement('div');
             itemDiv.className = 'project-tab-edit-item';
             itemDiv.setAttribute('data-project-id', project.id);
             itemDiv.innerHTML = `
                 <span class="index">${index + 1}</span>
                 <div class="inputs">
                     <label for="tab-name-${project.id}">Tab Name:</label>
                     <input type="text" id="tab-name-${project.id}" class="edit-tab-name" value="${project.tabName || ''}" required>
                     <label for="tab-image-${project.id}">Tab Image URL:</label>
                     <input type="url" id="tab-image-${project.id}" class="edit-tab-image" value="${project.tabImage || ''}" placeholder="https://...">
                 </div>
                 <button type="button" class="remove-item-btn" onclick="removeProjectTab('${project.id}', this)" title="Remove this project" aria-label="Remove Project ${project.tabName || index + 1}">&times;</button>
             `;
             listContainer.appendChild(itemDiv);
         });
         if (!courseData.projects || courseData.projects.length === 0) {
              listContainer.innerHTML = '<p style="font-style: italic; color: #666; text-align: center; padding: 10px 0;">No projects added yet.</p>';
         }
     }

     function addProjectTabEditField() {
          if ((courseData.projects || []).length >= MAX_PROJECTS) {
               alert(`Maximum ${MAX_PROJECTS} projects allowed per course.`);
               return;
          }
          const newProjectIndex = (courseData.projects?.length || 0) + 1;
          const newProjectId = `proj_${Date.now()}_${Math.random().toString(36).substring(2, 7)}`; // More unique ID
          const newProject = {
                id: newProjectId,
                tabName: `New Project ${newProjectIndex}`, tabImage: "",
                projectTitle: `New Project ${newProjectIndex} Title`, projectSubtitle: "", projectHeaderImage: "",
                overviewText: "Add project description here.", videoIntroText: "", videoTitle: "", videoUrl: "", videoKeyPoints: [],
                learnData: [], slidesData: [], challengesData: [], quizData: [],
                style: { fontFamily: null, baseSize: null, primaryColor: null, secondaryColor: null, accentColor: null },
                isCompleted: false
            };

          if (!courseData.projects) courseData.projects = [];
          courseData.projects.push(newProject);
          renderProjectTabsEditor(); // Refresh the list in the modal
          // Scroll to the newly added item
          const listContainer = document.getElementById('projectTabsList');
          const newItemElement = listContainer?.querySelector(`[data-project-id="${newProjectId}"]`);
          newItemElement?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          newItemElement?.querySelector('input')?.focus(); // Focus the first input
     }

     function removeProjectTab(projectIdToRemove, buttonElement) {
          const projIndex = courseData.projects.findIndex(p=>p.id===projectIdToRemove);
          if (projIndex === -1) return;

          const projName = courseData.projects[projIndex]?.tabName || projectIdToRemove;
          if (!confirm(`⚠️ Are you sure you want to REMOVE project "${projName}"?\n\nThis action CANNOT be undone and will permanently delete all its content (overview, video, slides, challenges, quiz, etc.).`)) {
               return;
          }
          // Remove the project from the main data array
          courseData.projects.splice(projIndex, 1);
          // Remove the item visually from the editor list immediately
          const itemToRemove = buttonElement?.closest('.project-tab-edit-item');
          itemToRemove?.remove();
          // Re-render the list to update indices if desired, or just let it be.
          renderProjectTabsEditor(); // Easiest way to update numbering
          renderCoursePage(); // Refresh the main course grid view
          // If the deleted project was currently being viewed, go back to course view
          if (currentProjectId === projectIdToRemove) {
              showCourseView();
          }
     }

    // Course Color Picker Logic
     function selectCourseColor(type, color) {
        // Store preference in the main course data
        if (!courseData.style) courseData.style = {};
        courseData.style[type + 'Color'] = color;
        // Apply theme to see changes live
        applyCourseTheme();

        // Update visual selection state in the COURSE editor modal
        const pickerInputId = `course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
        const pickerInput = document.getElementById(pickerInputId);
         const pickerContainer = pickerInput?.closest('.color-picker');
         if (pickerInput) pickerInput.value = color; // Set input value for the custom picker
         if (pickerContainer) {
             pickerContainer.querySelectorAll('.color-option').forEach(option => {
                 option.classList.toggle('selected', areColorsEqual(option.style.backgroundColor, color));
             });
         }
    }
    function customCourseColorSelected(type, color) {
        selectCourseColor(type, color); // Use the same function to update data and UI
        // Deselect preset options when custom color is chosen via input[type=color]
        const pickerInputId = `course${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
        const pickerContainer = document.getElementById(pickerInputId)?.closest('.color-picker');
        pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));
    }
     function loadCourseColorSelections() {
         // Set the colors in the editor using the select function (updates UI & data)
         selectCourseColor('primary', courseData.style?.primaryColor || '#5E81F4');
         selectCourseColor('secondary', courseData.style?.secondaryColor || '#FF7AC6');
         selectCourseColor('accent', courseData.style?.accentColor || '#FFB800');
     }

    function saveCourseChanges() {
         const modal = document.getElementById('courseEditModal');
         if (!modal) return;

         // --- Validation for Multimedia URL if type is not 'none' ---
         const multiType = modal.querySelector('#editCourseMultimediaType')?.value || 'none';
         const multiUrlInput = modal.querySelector('#editCourseMultimediaUrl');
         const multiUrl = multiUrlInput?.value.trim();
         let isValid = true;

         if (multiType !== 'none' && !multiUrl) {
             alert(`Please provide a valid URL for the selected Course Multimedia type (${multiType}).`);
             multiUrlInput?.focus();
             multiUrlInput.style.borderColor = 'red';
             isValid = false;
         } else if (multiUrlInput) {
             multiUrlInput.style.borderColor = ''; // Reset border if valid or not required
         }

         if (!isValid) return; // Stop saving if validation failed
         // --- End Validation ---

         // Save Course Title, Image, Description
         courseData.title = document.getElementById('editCourseTitle')?.value.trim() || courseData.title;
         courseData.imageUrl = document.getElementById('editCourseImage')?.value.trim() || courseData.imageUrl;
         courseData.description = document.getElementById('editCourseDescription')?.value.trim() || courseData.description;

         // Save Course Multimedia settings
         if (!courseData.courseMultimedia) courseData.courseMultimedia = {}; // Initialize if needed
         courseData.courseMultimedia.type = multiType;
         if (multiType === 'none') {
             courseData.courseMultimedia.url = '';
             courseData.courseMultimedia.title = '';
         } else {
             courseData.courseMultimedia.url = multiUrl;
             courseData.courseMultimedia.title = modal.querySelector('#editCourseMultimediaTitle')?.value.trim() || '';
         }
         // Note: We don't reset 'minimized' here, keep the user's preference.

         // Save Project Tab Names and Images (from the editor list)
         document.querySelectorAll('#projectTabsList .project-tab-edit-item').forEach(item => {
             const projectId = item.getAttribute('data-project-id');
             const project = courseData.projects.find(p => p.id === projectId);
             if (project) {
                 project.tabName = item.querySelector('.edit-tab-name')?.value.trim() || project.tabName || 'Unnamed Project';
                 project.tabImage = item.querySelector('.edit-tab-image')?.value.trim() || project.tabImage;
             }
         });

         // Course colors are saved implicitly via selectCourseColor

         applyCourseTheme(); // Apply potentially changed course colors globally
         renderCoursePage(); // Re-render the main course page (including multimedia)
         closeModal('courseEditModal');
         alert("Course changes saved successfully!");
    }


    // --- Project Editor ---
    function openProjectEditModal() {
         const modal = document.getElementById('projectEditModal');
         if (!modal || !currentProjectId) {
              alert("Please navigate to a project page first to edit it.");
              return;
         }
         const projectIndex = courseData.projects.findIndex(p => p.id === currentProjectId);
          if (projectIndex === -1) {
               alert("Error: Cannot find data for the current project.");
               return;
          }
         // Create a DEEP CLONE of the project data for editing to allow cancellation
         currentProjectDataCache = JSON.parse(JSON.stringify(courseData.projects[projectIndex]));

         const project = currentProjectDataCache; // Work with the clone

         modal.querySelector('#editingProjectId').value = project.id;
         modal.querySelector('#editingProjectNameLabel').textContent = project.projectTitle || project.tabName || 'Unnamed Project';

         // Load simple text/URL fields from the CLONE
         modal.querySelector('#editProject_Title').value = project.projectTitle || '';
         modal.querySelector('#editProject_Subtitle').value = project.projectSubtitle || '';
         modal.querySelector('#editProject_HeaderImage').value = project.projectHeaderImage || '';
         modal.querySelector('#editProject_TabName').value = project.tabName || '';
         modal.querySelector('#editProject_TabImage').value = project.tabImage || '';
         modal.querySelector('#editProject_OverviewText').value = project.overviewText || '';
         modal.querySelector('#editProject_VideoIntroText').value = project.videoIntroText || '';
         modal.querySelector('#editProject_VideoTitle').value = project.videoTitle || '';
         modal.querySelector('#editProject_VideoUrl').value = project.videoUrl || '';
         modal.querySelector('#editProject_VideoKeyPoints').value = (project.videoKeyPoints || []).join('\n');

         // Load data for dynamic list sections FROM THE CLONE
         loadLearnEditFieldsForProject(project.learnData || [], modal.querySelector('#learnEditContainer'));
         loadSlidesEditFieldsForProject(project.slidesData || [], modal.querySelector('#slidesEditContainer'));
         loadChallengesEditFieldsForProject(project.challengesData || [], modal.querySelector('#challengesEditContainer'));
         loadQuizEditFieldsForProject(project.quizData || [], modal.querySelector('#quizEditContainer'));

         // Load project-specific styles FROM THE CLONE
         loadProjectStyleSelections(project.style || {});
         loadProjectColorSelections(project.style || {}); // Load colors AFTER styles

         modal.style.display = 'block'; // Show the modal
         // Set default section and show it
         document.getElementById('editSectionProject').value = 'projMeta';
         showProjectEditSection();
    }

     // --- Editor Field Loaders (Project Modal Specific - Operate on CACHED data) ---
     // Helper to create grouped items in project editor
     function createEditItemGroup(index, typePrefix, contentGenerator, removeHandler) {
          const itemGroup = document.createElement('div');
          itemGroup.className = 'edit-item-group';
          itemGroup.innerHTML = contentGenerator(index); // Generate specific inputs via callback

          const removeBtn = document.createElement('button');
          removeBtn.type = 'button'; removeBtn.className = 'remove-item-btn';
          removeBtn.innerHTML = '&times;';
          removeBtn.title = `Remove this ${typePrefix} item`;
          removeBtn.setAttribute('aria-label', `Remove ${typePrefix.charAt(0).toUpperCase() + typePrefix.slice(1)} Item ${index + 1}`);
          removeBtn.onclick = () => removeHandler(itemGroup); // Pass the group element
          itemGroup.appendChild(removeBtn);

          // Auto-show/hide media URL input based on initial select value
          const mediaTypeSelect = itemGroup.querySelector('.media-type-select');
          if (mediaTypeSelect) handleMediaTypeChange(mediaTypeSelect); // Trigger initial check

          return itemGroup;
     }
     function handleMediaTypeChange(selectElement) { // Helper for media URL visibility
        const urlInputContainer = selectElement.closest('.edit-item-group')?.querySelector('.media-url-input-container');
        if (urlInputContainer) { urlInputContainer.style.display = (selectElement.value === 'none' || !selectElement.value) ? 'none' : 'block'; }
     }
     // Loaders - they receive the *cached* data array and the container element
     function loadLearnEditFieldsForProject(data, container) {
          if (!container) return; container.innerHTML = '';
          const items = data || []; // Ensure it's an array
          items.forEach((item, index) => {
              const prefix = 'learn'; // For IDs
              const content = (i) => `
                  <label for="${prefix}-title-${i}"><b>Item ${i + 1} Title:</b></label>
                  <input type="text" id="${prefix}-title-${i}" class="${prefix}-title" value="${item.title || ''}" required placeholder="e.g., Understanding Loops">
                  <label for="${prefix}-desc-${i}">Description:</label>
                  <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="2" placeholder="Explain the concept...">${item.description || ''}</textarea>
                  <div class="media-controls">
                     <label for="${prefix}-media-type-${i}">Optional Media:</label>
                     <select id="${prefix}-media-type-${i}" class="media-type-select" onchange="handleMediaTypeChange(this)">
                         <option value="none" ${!item.mediaType || item.mediaType === 'none' ? 'selected' : ''}>None</option>
                         <option value="image" ${item.mediaType === 'image' ? 'selected' : ''}>Image URL</option>
                         <option value="video" ${item.mediaType === 'video' ? 'selected' : ''}>Video Embed URL</option>
                     </select>
                     <div class="media-url-input-container" style="display: none;"> ${/* Initially hidden by handleMediaTypeChange */''}
                         <label for="${prefix}-media-url-${i}" class="sr-only">Media URL:</label>
                         <input type="url" id="${prefix}-media-url-${i}" class="media-url-input" placeholder="Enter Media URL..." value="${item.mediaUrl || ''}">
                     </div>
                  </div>`;
              container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveLearnItem));
          });
          if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No learning items added.</p>';
     }
     function loadSlidesEditFieldsForProject(data, container) {
        if (!container) return; container.innerHTML = '';
        const items = data || [];
        items.forEach((slide, index) => {
            const prefix = 'slide';
            const content = (i) => `
                <label for="${prefix}-url-${i}"><b>Slide ${i + 1} URL (Image or Embed Link):</b></label>
                <input type="url" id="${prefix}-url-${i}" class="${prefix}-url" value="${slide.url || ''}" required placeholder="https://...">
                <label for="${prefix}-desc-${i}">Description (Optional Caption):</label>
                <input type="text" id="${prefix}-desc-${i}" class="${prefix}-desc" value="${slide.description || ''}" placeholder="Brief description of the slide...">
                <label for="${prefix}-type-${i}">Content Type:</label>
                <select id="${prefix}-type-${i}" class="${prefix}-type">
                    <option value="iframe" ${!slide.type || slide.type === 'iframe' ? 'selected' : ''}>Embed (Video/Presentation)</option>
                    <option value="image" ${slide.type === 'image' ? 'selected' : ''}>Image</option>
                </select>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveSlideItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No slides added.</p>';
     }
      function loadChallengesEditFieldsForProject(data, container) {
        if (!container) return; container.innerHTML = '';
        const items = data || [];
        items.forEach((challenge, index) => {
            const prefix = 'challenge';
             const content = (i) => `
                <label for="${prefix}-title-${i}"><b>Challenge ${i + 1} Title:</b></label>
                <input type="text" id="${prefix}-title-${i}" class="${prefix}-title" value="${challenge.title || ''}" required placeholder="e.g., Make it Faster">
                <label for="${prefix}-desc-${i}">Description:</label>
                <textarea id="${prefix}-desc-${i}" class="${prefix}-desc" rows="2" placeholder="Describe the challenge...">${challenge.description || ''}</textarea>
                 <div class="media-controls">
                    <label for="${prefix}-media-type-${i}">Optional Media:</label>
                    <select id="${prefix}-media-type-${i}" class="media-type-select" onchange="handleMediaTypeChange(this)">
                        <option value="none" ${!challenge.mediaType || challenge.mediaType === 'none' ? 'selected' : ''}>None</option>
                        <option value="image" ${challenge.mediaType === 'image' ? 'selected' : ''}>Image URL</option>
                        <option value="video" ${challenge.mediaType === 'video' ? 'selected' : ''}>Video Embed URL</option>
                    </select>
                    <div class="media-url-input-container" style="display: none;">
                         <label for="${prefix}-media-url-${i}" class="sr-only">Media URL:</label>
                         <input type="url" id="${prefix}-media-url-${i}" class="media-url-input" placeholder="Enter Media URL..." value="${challenge.mediaUrl || ''}">
                    </div>
                </div>`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveChallengeItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No challenges added.</p>';
     }
      function loadQuizEditFieldsForProject(data, container) {
        if (!container) return; container.innerHTML = '';
        const items = data || [];
        items.forEach((q, index) => {
             const prefix = 'quiz';
            let incorrectInputsHTML = '';
            for (let i = 0; i < MAX_INCORRECT_ANSWERS; i++) {
                const val = (q.incorrectAnswers && q.incorrectAnswers[i]) ? q.incorrectAnswers[i] : '';
                // Add required attribute only to the first incorrect answer for basic validation
                const requiredAttr = (i === 0) ? '' : ''; // Removed required from incorrect for flexibility
                incorrectInputsHTML += `
                    <label for="${prefix}-incorrect-${index}-${i}" class="incorrect-answer-label">Incorrect Option ${i + 1}:</label>
                    <input type="text" id="${prefix}-incorrect-${index}-${i}" class="${prefix}-incorrect" value="${val}" placeholder="(Optional)" ${requiredAttr}>`;
            }
            const content = (i) => `
                <label for="${prefix}-question-${i}"><b>Question ${i + 1}:</b></label>
                <textarea id="${prefix}-question-${i}" class="${prefix}-question" rows="2" required placeholder="What is...?">${q.questionText || ''}</textarea>
                <label for="${prefix}-correct-${i}" style="color: var(--success); font-weight: bold;">Correct Answer:</label>
                <input type="text" id="${prefix}-correct-${i}" class="${prefix}-correct" value="${q.correctAnswer || ''}" required placeholder="The right answer">
                ${incorrectInputsHTML}`;
            container.appendChild(createEditItemGroup(index, prefix, content, handleRemoveQuizItem));
        });
        if (items.length === 0) container.innerHTML = '<p style="font-style: italic; color: #666; text-align: center;">No quiz questions added.</p>';
      }

     // Project Style & Color Editor Logic (Operates on CACHE)
     function loadProjectStyleSelections(projectStyleData) {
         const modal = document.getElementById('projectEditModal');
         if (!modal) return;
         const styleData = projectStyleData || {};

         // Font Family
         const currentFont = styleData.fontFamily || null; // Explicitly null if not set
          const fontSelector = modal.querySelector('#projectFontSelector');
          if (fontSelector) {
              fontSelector.querySelectorAll('.font-option').forEach(option => {
                   const onclickAttr = option.getAttribute('onclick');
                   // Match null or the quoted string, handling potential single/double quotes variations
                   const match = onclickAttr?.match(/selectProjectStyle\('fontFamily',\s*(null|(['"`])(.*?)\2)\)/);
                  let optionValue = undefined;
                  if (match) {
                      optionValue = match[1] === 'null' ? null : match[3]; // Get 'null' or the font string
                  }
                  option.classList.toggle('selected', optionValue === currentFont);
              });
          }

         // Base Size
         const currentSize = styleData.baseSize || null;
         const sizeSelector = modal.querySelector('#projectSizeSelector');
         if (sizeSelector) {
             sizeSelector.querySelectorAll('.size-option').forEach(option => {
                  const onclickAttr = option.getAttribute('onclick');
                  const match = onclickAttr?.match(/selectProjectStyle\('baseSize',\s*(null|'small'|'medium'|'large')\)/);
                  const optionValue = match ? (match[1] === 'null' ? null : match[1]) : undefined;
                  option.classList.toggle('selected', optionValue === currentSize);
             });
         }
     }
     function loadProjectColorSelections(projectStyleData) {
        const styleData = projectStyleData || {};
        // Pass null if no project-specific color override is set in the cache
        selectProjectColor('primary', styleData.primaryColor || null, false); // Don't apply live preview on initial load
        selectProjectColor('secondary', styleData.secondaryColor || null, false);
        selectProjectColor('accent', styleData.accentColor || null, false);
     }

     // Selects project style (font/size), updates CACHE and modal UI
     function selectProjectStyle(styleProperty, value) {
         if (!currentProjectDataCache) return;
         if (!currentProjectDataCache.style) currentProjectDataCache.style = {};
         currentProjectDataCache.style[styleProperty] = value;
         // Update the visual selection in the PROJECT editor modal
         loadProjectStyleSelections(currentProjectDataCache.style);
         // Apply live preview to project in background (if visible)
         if (document.getElementById('project-view').style.display !== 'none') {
            applyProjectSpecificStyles(currentProjectDataCache);
         }
     }
     // Selects project color override, updates CACHE and modal UI
     function selectProjectColor(type, color, applyLive = true) { // 'color' can be null or hex string
         if (!currentProjectDataCache) return;
         if (!currentProjectDataCache.style) currentProjectDataCache.style = {};
         currentProjectDataCache.style[type + 'Color'] = color; // color can be null

         // Update PROJECT editor modal UI
         const pickerInputId = `project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPicker`;
         const pickerInput = document.getElementById(pickerInputId);
         const pickerContainer = document.getElementById(`${pickerInputId}Container`);

         if (pickerInput) {
             // Set the value of the input[type=color]
             // If 'color' is null (meaning inherit), show the course color in the picker for reference.
             const effectiveColor = color || courseData.style?.[type + 'Color'] || '#ffffff'; // Fallback to white if course color missing
             pickerInput.value = effectiveColor;
             // Visually indicate if the color is inherited vs overridden
             pickerInput.classList.toggle('inherited-style', color === null);
         }
         if (pickerContainer) {
             pickerContainer.querySelectorAll('.color-option').forEach(option => {
                 // Only select a preset if an override color is set AND it matches the preset
                 option.classList.toggle('selected', color !== null && areColorsEqual(option.style.backgroundColor, color));
             });
         }
         // Optional live preview (apply changes to background project view)
         if (applyLive && document.getElementById('project-view').style.display !== 'none') {
             applyProjectSpecificStyles(currentProjectDataCache);
         }
     }
     function customProjectColorSelected(type, color) {
        selectProjectColor(type, color, true); // Apply live preview
        // Deselect preset options when custom color is chosen via input[type=color]
        const pickerContainer = document.getElementById(`project${type.charAt(0).toUpperCase() + type.slice(1)}ColorPickerContainer`);
        pickerContainer?.querySelectorAll('.color-option').forEach(option => option.classList.remove('selected'));
     }
     function clearProjectColorOverrides() {
         if (!confirm("Reset this project's colors to use the main course theme? Any custom colors set here will be removed.")) return;
         // Set colors to null in cache, trigger UI update (without live preview initially)
         selectProjectColor('primary', null, false);
         selectProjectColor('secondary', null, false);
         selectProjectColor('accent', null, false);
         // Apply live preview after clearing all
          if (document.getElementById('project-view').style.display !== 'none') {
             applyProjectSpecificStyles(currentProjectDataCache);
          }
         alert("Project colors reset to course defaults. Save the project to make this permanent.");
     }

     // --- Add/Remove handlers for dynamic list items in project editor (operate on CACHE) ---
     function findIndexAndRemove(element, dataArrayName, reloadFunctionName) {
        if (!currentProjectDataCache || !currentProjectDataCache[dataArrayName]) return;
        const container = element.parentNode; // Should be the container holding all item groups
        const items = Array.from(container.children).filter(child => child.classList.contains('edit-item-group'));
        const index = items.indexOf(element); // Find the index of the element to remove

        if (index > -1) {
             // Confirm removal for items with potentially significant content (Quiz, Slides)
             const itemType = dataArrayName.replace('Data', '');
             let confirmMsg = `Are you sure you want to remove this ${itemType} item?`;
             if (itemType === 'quiz' || itemType === 'slide') {
                 confirmMsg = `⚠️ Are you sure you want to permanently remove this ${itemType} item and its content?`;
             }

             if (confirm(confirmMsg)) {
                 currentProjectDataCache[dataArrayName].splice(index, 1); // Remove from the cached data array
                 // Reload fields for this section using the updated cached data
                 window[reloadFunctionName](currentProjectDataCache[dataArrayName], container);
             }
        } else {
            console.error("Could not find item index to remove.");
            element.remove(); // Fallback: Just remove the element visually if index fails
        }
     }
     function handleRemoveLearnItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'learnData', 'loadLearnEditFieldsForProject'); }
     function handleRemoveSlideItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'slidesData', 'loadSlidesEditFieldsForProject'); }
     function handleRemoveChallengeItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'challengesData', 'loadChallengesEditFieldsForProject'); }
     function handleRemoveQuizItem(elementToRemove) { findIndexAndRemove(elementToRemove, 'quizData', 'loadQuizEditFieldsForProject'); }

     // Add item functions for project editor (operate on CACHE)
     function addItemToProjectData(dataArrayName, maxItems, newItemObject, reloadFunctionName, containerSelector, focusSelector = null) {
         if (!currentProjectDataCache) return; // Need cache context
         if (!currentProjectDataCache[dataArrayName]) currentProjectDataCache[dataArrayName] = []; // Ensure array exists
         if (currentProjectDataCache[dataArrayName].length >= maxItems) { alert(`Maximum ${maxItems} items allowed for this section.`); return; }

         currentProjectDataCache[dataArrayName].push(newItemObject); // Add to cache

         const container = document.querySelector(containerSelector);
         // Reload the UI section using the updated cache
         if (container && typeof window[reloadFunctionName] === 'function') {
             window[reloadFunctionName](currentProjectDataCache[dataArrayName], container);
             // Scroll and focus the newly added item
             const lastItem = container.lastElementChild;
             if (lastItem && lastItem.classList.contains('edit-item-group')) {
                   lastItem.scrollIntoView({behavior:'smooth', block:'nearest'});
                   if(focusSelector) {
                       const inputToFocus = lastItem.querySelector(focusSelector);
                       inputToFocus?.focus();
                   }
             }
         } else { console.error(`Reload function ${reloadFunctionName} or container ${containerSelector} not found.`); }
     }
     function addLearnEditField() { addItemToProjectData('learnData', MAX_LEARN_ITEMS, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadLearnEditFieldsForProject', '#projectEditModal #learnEditContainer', '.learn-title'); }
     function addSlideEditField() { addItemToProjectData('slidesData', MAX_SLIDES, { url: "", description: "", type:"iframe" }, 'loadSlidesEditFieldsForProject', '#projectEditModal #slidesEditContainer', '.slide-url'); }
     function addChallengeEditField() { addItemToProjectData('challengesData', MAX_CHALLENGES, { title: "", description: "", mediaType:'none', mediaUrl:'' }, 'loadChallengesEditFieldsForProject', '#projectEditModal #challengesEditContainer', '.challenge-title'); }
     function addQuizEditField() { addItemToProjectData('quizData', MAX_QUIZ_QUESTIONS, { questionText:"", correctAnswer:"", incorrectAnswers: Array(MAX_INCORRECT_ANSWERS).fill("") }, 'loadQuizEditFieldsForProject', '#projectEditModal #quizEditContainer', '.quiz-question'); }


     // Show different editing sections within the PROJECT editor modal
     function showProjectEditSection() {
         const modal = document.getElementById('projectEditModal');
         const select = document.getElementById('editSectionProject');
         if (!modal || !select) return;
         // Hide all sections first
         modal.querySelectorAll('.edit-section').forEach(section => section.style.display = 'none');
         // Construct the ID of the section to show (e.g., 'overview' -> 'overviewEdit')
         const sectionIdToShow = select.value + 'Edit';
         const targetSection = modal.querySelector('#' + sectionIdToShow);
         if (targetSection) {
             targetSection.style.display = 'block';
             // Scroll the section into view within the modal if needed
             // targetSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
         } else { console.warn("Edit section not found:", sectionIdToShow); }
     }

    // Saves changes from Project Modal back to main courseData
    function saveProjectChanges() {
         const projectId = document.getElementById('editingProjectId')?.value;
         const projectIndex = courseData.projects.findIndex(p => p.id === projectId);
         if (projectIndex === -1 || !currentProjectDataCache) { alert("Error: Could not find project data to save."); return; }

         const modal = document.getElementById('projectEditModal');
         if (!modal) { alert("Error: Project edit modal not found."); return; }

         // --- Create a new object with data read from the modal & cache ---
         let updatedProjectData = {
             id: projectId, // Keep the original ID
             isCompleted: currentProjectDataCache.isCompleted, // Preserve completion status
             // Deep copy style object from cache to avoid reference issues
             style: currentProjectDataCache.style ? JSON.parse(JSON.stringify(currentProjectDataCache.style)) : {},

             // Read simple fields from modal
             projectTitle: modal.querySelector('#editProject_Title')?.value.trim() || 'Project Title',
             projectSubtitle: modal.querySelector('#editProject_Subtitle')?.value.trim() || '',
             projectHeaderImage: modal.querySelector('#editProject_HeaderImage')?.value.trim() || '',
             tabName: modal.querySelector('#editProject_TabName')?.value.trim() || 'Unnamed Tab',
             tabImage: modal.querySelector('#editProject_TabImage')?.value.trim() || '',
             overviewText: modal.querySelector('#editProject_OverviewText')?.value.trim() || '',
             videoIntroText: modal.querySelector('#editProject_VideoIntroText')?.value.trim() || '',
             videoTitle: modal.querySelector('#editProject_VideoTitle')?.value.trim() || '',
             videoUrl: modal.querySelector('#editProject_VideoUrl')?.value.trim() || '',
             videoKeyPoints: modal.querySelector('#editProject_VideoKeyPoints')?.value.split('\n').map(s => s.trim()).filter(s => s),

             // Read dynamic list fields from modal inputs
             learnData: [], slidesData: [], challengesData: [], quizData: []
         };

         let isValid = true; // Flag for validation

         try {
             // Learn Items
             modal.querySelectorAll('#learnEditContainer .edit-item-group').forEach(item => {
                 const titleInput = item.querySelector('.learn-title');
                 const title = titleInput?.value.trim();
                 if (title) { // Only save if title exists
                     const mediaTypeSelect = item.querySelector('.media-type-select');
                     const mediaUrlInput = item.querySelector('.media-url-input');
                     const mediaType = mediaTypeSelect?.value || 'none';
                     const mediaUrl = (mediaType !== 'none' && mediaUrlInput) ? mediaUrlInput.value.trim() : '';
                      // Basic URL validation if media type is selected
                      if (mediaType !== 'none' && !mediaUrl) {
                          alert(`Please provide a URL for the ${mediaType} in Learning Item "${title}".`);
                          mediaUrlInput?.focus(); isValid = false; throw new Error("Validation failed"); // Stop processing
                      }
                     updatedProjectData.learnData.push({
                         title: title,
                         description: item.querySelector('.learn-desc')?.value.trim() || "",
                         mediaType: mediaType,
                         mediaUrl: mediaUrl
                     });
                     titleInput.style.borderColor = ''; // Reset border on success
                 } else if (titleInput?.required && !title) {
                     alert("Please provide a title for all Learning Items.");
                     titleInput.style.borderColor = 'red'; titleInput.focus(); isValid = false; throw new Error("Validation failed");
                 }
             });
             if (!isValid) return; // Stop if validation failed

             // Slides
             modal.querySelectorAll('#slidesEditContainer .edit-item-group').forEach(item => {
                  const urlInput = item.querySelector('.slide-url');
                  const url = urlInput?.value.trim();
                  if (url) {
                      updatedProjectData.slidesData.push({
                           url: url,
                           description: item.querySelector('.slide-desc')?.value.trim() || "",
                           type: item.querySelector('.slide-type')?.value || "iframe"
                       });
                       urlInput.style.borderColor = '';
                  } else if (urlInput?.required && !url) {
                       alert("Please provide a URL for all Slides.");
                       urlInput.style.borderColor = 'red'; urlInput.focus(); isValid = false; throw new Error("Validation failed");
                  }
             });
              if (!isValid) return;

              // Challenges
             modal.querySelectorAll('#challengesEditContainer .edit-item-group').forEach(item => {
                  const titleInput = item.querySelector('.challenge-title');
                  const title = titleInput?.value.trim();
                  if (title) {
                      const mediaTypeSelect = item.querySelector('.media-type-select');
                      const mediaUrlInput = item.querySelector('.media-url-input');
                      const mediaType = mediaTypeSelect?.value || 'none';
                      const mediaUrl = (mediaType !== 'none' && mediaUrlInput) ? mediaUrlInput.value.trim() : '';
                      if (mediaType !== 'none' && !mediaUrl) {
                          alert(`Please provide a URL for the ${mediaType} in Challenge "${title}".`);
                          mediaUrlInput?.focus(); isValid = false; throw new Error("Validation failed");
                      }
                      updatedProjectData.challengesData.push({
                           title: title,
                           description: item.querySelector('.challenge-desc')?.value.trim() || "",
                           mediaType: mediaType,
                           mediaUrl: mediaUrl
                      });
                      titleInput.style.borderColor = '';
                  } else if (titleInput?.required && !title) {
                       alert("Please provide a title for all Challenges.");
                       titleInput.style.borderColor = 'red'; titleInput.focus(); isValid = false; throw new Error("Validation failed");
                  }
             });
              if (!isValid) return;

             // Quiz Questions
             modal.querySelectorAll('#quizEditContainer .edit-item-group').forEach(item => {
                  const questionInput = item.querySelector('.quiz-question');
                  const correctInput = item.querySelector('.quiz-correct');
                  const question = questionInput?.value.trim();
                  const correct = correctInput?.value.trim();

                  if (question && correct) {
                       let incorrect = [];
                       item.querySelectorAll('.quiz-incorrect').forEach(inp => { if(inp.value.trim()) incorrect.push(inp.value.trim()); });
                       // Optional: Validate minimum number of incorrect answers if needed
                       // if (incorrect.length < 1) { /* alert or validation message */ }
                       updatedProjectData.quizData.push({ questionText: question, correctAnswer: correct, incorrectAnswers: incorrect });
                       questionInput.style.borderColor = ''; correctInput.style.borderColor = '';
                  } else {
                      if (questionInput?.required && !question) {
                           alert("Please provide text for all Quiz Questions.");
                           questionInput.style.borderColor = 'red'; questionInput.focus(); isValid = false; throw new Error("Validation failed");
                      }
                      if (correctInput?.required && !correct) {
                           alert("Please provide a Correct Answer for all Quiz Questions.");
                           correctInput.style.borderColor = 'red'; correctInput.focus(); isValid = false; throw new Error("Validation failed");
                      }
                  }
             });
              if (!isValid) return;

             // --- COMMIT Changes: Replace the project object in the main courseData array ---
             courseData.projects[projectIndex] = updatedProjectData;

             // --- Update UI & Close ---
             applyProjectSpecificStyles(updatedProjectData); // Apply new styles immediately
             renderProjectPage(updatedProjectData); // Update the project view display with new data
             renderCoursePage();       // Update the course grid (tab name/image might have changed)
             closeModal('projectEditModal');
             alert(`Project "${updatedProjectData.projectTitle || updatedProjectData.tabName}" changes saved successfully!`);
             currentProjectDataCache = null; // Clear the edit cache

         } catch (error) {
              // Only log the error if it's the validation error we threw
              if (error.message !== "Validation failed") {
                  console.error("Error saving project changes:", error);
                  alert("An error occurred while saving the project. Check the console for details.");
              }
              // Don't close modal on validation error
         }
    }

    // --- Utility Functions ---
    function shuffleArray(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}}
    // More robust color comparison
    function areColorsEqual(color1, color2){
        if (!color1 || !color2) return color1 === color2; // Handle null/undefined cases
        if (color1.toLowerCase() === color2.toLowerCase()) return true; // Quick check for identical strings

        // Convert both to a consistent format (RGBA) for comparison
        const convertToRgba = (color) => {
            const ctx = document.createElement('canvas').getContext('2d');
            if (!ctx) return null; // Canvas not supported
            ctx.fillStyle = color;
            const computedColor = ctx.fillStyle; // This gives hex or rgba depending on browser/input

            // If it's already rgba, return it
            if (computedColor.startsWith('rgba')) return computedColor;

            // If it's hex, convert to rgba
            if (computedColor.startsWith('#')) {
                const rgb = hexToRgb(computedColor);
                return rgb ? `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 1)` : null;
            }
            // Add handling for rgb() if needed, though fillStyle often returns hex or rgba
            if (computedColor.startsWith('rgb(')) {
                 return computedColor.replace('rgb(', 'rgba(').replace(')', ', 1)');
            }

            return computedColor; // Return as is if format is unknown/unhandled
        };

        try {
            const rgba1 = convertToRgba(color1);
            const rgba2 = convertToRgba(color2);
            return rgba1 && rgba2 && rgba1 === rgba2;
        } catch (e) {
            console.warn("Color comparison failed, falling back to string comparison:", e);
            return String(color1).trim().toLowerCase() === String(color2).trim().toLowerCase();
        }
    }

    // --- EXPORT COURSE ---
    function exportCourseHTML() {
        console.log("Starting COURSE export...");
        try {
            // Ensure base course theme is active for export styles
            applyCourseTheme();
            const exportDocElement = document.documentElement.cloneNode(true);

            // --- Clean up editor-specific UI ---
            exportDocElement.querySelector('#courseEditModal')?.remove();
            exportDocElement.querySelector('#projectEditModal')?.remove();
            exportDocElement.querySelectorAll('.edit-btn').forEach(btn => btn.remove());
            exportDocElement.querySelectorAll('.export-btn').forEach(btn => btn.remove()); // Course export button

            // --- Keep the Back Button for the Project View ---
            // The line removing '.back-btn' is removed, as it's needed for navigation in the exported file.

            // --- Prepare for Viewer State ---
            // Reset view state to show course view by default in the exported file
            exportDocElement.querySelector('#course-view').style.display = 'block';
            exportDocElement.querySelector('#project-view').style.display = 'none';
            // Clear any lingering project-specific inline styles from the project view container
             const exportProjectViewEl = exportDocElement.querySelector('#project-view');
             if(exportProjectViewEl) { exportProjectViewEl.style.fontFamily = ''; exportProjectViewEl.style.fontSize = ''; }

             // Prepare multimedia section for export (ensure correct initial state)
             const exportMultiSection = exportDocElement.querySelector('#course-multimedia-section');
             if (exportMultiSection) {
                if (courseData.courseMultimedia?.type === 'none' || !courseData.courseMultimedia?.url) {
                     exportMultiSection.style.display = 'none';
                 } else {
                     exportMultiSection.style.display = 'block';
                     exportMultiSection.classList.toggle('multimedia-minimized', !!courseData.courseMultimedia?.minimized);
                     // Update button in export template based on data
                     const exportToggleBtn = exportMultiSection.querySelector('#toggle-multimedia-btn');
                     if (exportToggleBtn) {
                         exportToggleBtn.innerHTML = courseData.courseMultimedia?.minimized ? '&#x2B;' : '—';
                     }
                 }
             }


            // Reset quiz state visually in the template before embedding data
            exportDocElement.querySelectorAll('.quiz-question').forEach(q => {
                q.classList.remove('answered');
                q.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected', 'correct', 'incorrect'));
                 q.querySelectorAll('.quiz-feedback').forEach(f => f.style.display = 'none');
             });
            exportDocElement.querySelector('.final-quiz-result')?.remove();
            const exportSubmitBtn = exportDocElement.querySelector('#project-view #submitQuizBtn');
            if (exportSubmitBtn) exportSubmitBtn.disabled = false;

            // --- Embed Data and Viewer Script ---
            // Remove ALL original script tags (including this one)
            exportDocElement.querySelectorAll('script').forEach(script => script.remove());

            // Create the minimal viewer script
            const viewerScript = document.createElement('script');
            // Embed the CURRENT, complete courseData state. Use JSON.stringify carefully.
            const courseDataString = JSON.stringify(courseData)
                .replace(/</g, '\\u003c') // Escape potential HTML tags within data
                .replace(/>/g, '\\u003e');

            // Updated Minified Viewer Logic (Includes multimedia rendering and toggle)
            viewerScript.textContent = `
// --- EXPORTED VIEWER SCRIPT (SELF-CONTAINED) ---
const courseDataForView = ${courseDataString};
let currentSlideIndex = 0; let currentProjectIdForView = null;
// Utils
function shuffleArray(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}}
function hexToRgb(h){let r=/^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(h);return r?{r:parseInt(r[1],16),g:parseInt(r[2],16),b:parseInt(r[3],16)}:null}
// Theme
function applyThemeClrs(p,s,a){const r=document.documentElement;r.style.setProperty('--primary',p||'#5E81F4');r.style.setProperty('--secondary',s||'#FF7AC6');r.style.setProperty('--accent',a||'#FFB800');const pr=hexToRgb(p||'#5E81F4');if(pr)r.style.setProperty('--primary-rgb',\`\${pr.r}, \${pr.g}, \${pr.b}\`);const sr=hexToRgb(s||'#FF7AC6');if(sr)r.style.setProperty('--secondary-rgb',\`\${sr.r}, \${sr.g}, \${sr.b}\`)}
function applyCourseThemeForView(){const cs=courseDataForView.style||{};applyThemeClrs(cs.primaryColor,cs.secondaryColor,cs.accentColor);const r=document.documentElement;r.style.setProperty('--base-font-family',"'Segoe UI', sans-serif");r.style.setProperty('--base-font-size','16px');const pv=document.getElementById('project-view');if(pv){pv.style.fontFamily='';pv.style.fontSize=''}}
function applyProjectStylesForView(p){if(!p)return;const ps=p.style||{};const cs=courseDataForView.style||{};applyThemeClrs(ps.primaryColor||cs.primaryColor,ps.secondaryColor||cs.secondaryColor,ps.accentColor||cs.accentColor);const pv=document.getElementById('project-view');if(!pv)return;pv.style.fontFamily=ps.fontFamily||'var(--base-font-family)';let ef='var(--base-font-size)';if(ps.baseSize==='small')ef='14px';else if(ps.baseSize==='large')ef='18px';else if(ps.baseSize==='medium')ef='16px';pv.style.fontSize=ef}
// Navigation
function showCourseView(){document.getElementById('course-view').style.display='block';document.getElementById('project-view').style.display='none';currentProjectIdForView=null;document.title=courseDataForView.title||"Course";applyCourseThemeForView();renderCoursePageForView();window.scrollTo(0,0)}
function showProjectView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(!p){showCourseView();return}currentProjectIdForView=pid;renderProjectPageForView(p);document.getElementById('course-view').style.display='none';document.getElementById('project-view').style.display='block';document.title=p.projectTitle||"Project";applyCourseThemeForView();applyProjectStylesForView(p);window.scrollTo(0,0);try{history.pushState({projectId:pid},p.projectTitle||'',\`#project-\${pid}\`)}catch(e){}}
window.onpopstate=function(e){if(e.state&&e.state.projectId){showProjectView(e.state.projectId)}else{showCourseView()}};
// Rendering
function renderCoursePageForView(){const c=courseDataForView;document.getElementById('courseTitle').textContent=c.title;const i=document.getElementById('courseImage');if(i){i.src=c.imageUrl||'';i.alt=c.title+" Image"}document.getElementById('courseDescription').textContent=c.description;renderCourseMultimediaForView();const g=document.getElementById('projectGrid');g.innerHTML='';if(!c.projects||c.projects.length===0){g.innerHTML='<p style="text-align:center;color:#666;">No projects.</p>';return}c.projects.forEach(p=>{if(!p||!p.id)return;const t=document.createElement('a');t.className='project-tab';t.href=\`#project-\${p.id}\`;t.onclick=e=>{e.preventDefault();showProjectView(p.id)};t.innerHTML=\`<img src="\${p.tabImage||'https://via.placeholder.com/300x200/eee/999?text=Prj'}" alt="\${p.tabName||'Project'}" loading="lazy"><div class="project-tab-info"><span>\${p.tabName||'Project'}</span></div>\`;if(p.isCompleted){const k=document.createElement('span');k.className='completion-tick';k.innerHTML='&#10004;';k.setAttribute('aria-label','Completed');k.title='Completed';t.appendChild(k)}g.appendChild(t)})}
function renderCourseMultimediaForView(){const s=document.getElementById('course-multimedia-section'),d=document.getElementById('course-multimedia-content'),b=document.getElementById('toggle-multimedia-btn'),m=courseDataForView.courseMultimedia||{type:'none',url:'',title:'',minimized:!1};if(!s||!d||!b)return;d.innerHTML='';s.classList.remove('multimedia-minimized');if(m.type==='none'||!m.url){s.style.display='none';return}s.style.display='block';const u=m.url.trim(),t=m.title?.trim()||'Course Multimedia';if(m.type==='image'){const i=document.createElement('img');i.src=u;i.alt=t;i.loading='lazy';d.appendChild(i)}else if(m.type==='video'||m.type==='presentation'){const w=document.createElement('div');w.className='media-wrapper-16-9';const f=document.createElement('iframe');f.src=u;f.title=t;f.frameBorder="0";f.loading='lazy';f.allow="accelerometer; autoplay=false ; clipboard-write; encrypted-media; gyroscope; picture-in-picture";f.allowFullscreen=!0;f.sandbox="allow-scripts allow-same-origin allow-presentation";w.appendChild(f);d.appendChild(w)}else{d.innerHTML='<p>Unsupported type.</p>'}if(m.minimized){s.classList.add('multimedia-minimized');b.innerHTML='&#x2B;';b.title='Maximize';b.setAttribute('aria-label','Maximize')}else{s.classList.remove('multimedia-minimized');b.innerHTML='—';b.title='Minimize';b.setAttribute('aria-label','Minimize')}}
function toggleCourseMultimedia(){const s=document.getElementById('course-multimedia-section'),b=document.getElementById('toggle-multimedia-btn');if(!s||!b||!courseDataForView.courseMultimedia)return;courseDataForView.courseMultimedia.minimized=!courseDataForView.courseMultimedia.minimized;s.classList.toggle('multimedia-minimized');if(courseDataForView.courseMultimedia.minimized){b.innerHTML='&#x2B;';b.title='Maximize';b.setAttribute('aria-label','Maximize')}else{b.innerHTML='—';b.title='Minimize';b.setAttribute('aria-label','Minimize')}}
function renderProjectPageForView(p){if(!p)return;const pv=document.getElementById('project-view');if(!pv)return;const h=pv.querySelector('#project-header');if(h){h.querySelector('#projectImage').src=p.projectHeaderImage||p.tabImage||'';h.querySelector('#projectImage').alt=p.projectTitle+" Hdr";h.querySelector('#projectTitle').textContent=p.projectTitle;h.querySelector('#projectSubtitle').textContent=p.projectSubtitle}const ct=pv.querySelector('#projectTabContentContainer');if(!ct)return;const ov=ct.querySelector('#overview');if(ov){ov.querySelector('#overviewText').textContent=p.overviewText||'';renderLearnItemsForProjectView(p.learnData||[],ov.querySelector('#learnContainer'))}const vd=ct.querySelector('#video');if(vd){vd.querySelector('#videoIntroText').textContent=p.videoIntroText||'';vd.querySelector('#videoTitle').textContent=p.videoTitle||'';vd.querySelector('#mainVideo').src=p.videoUrl||'';const ul=vd.querySelector('#videoKeyPoints');ul.innerHTML='';(p.videoKeyPoints||[]).forEach(pt=>{if(pt&&pt.trim())ul.innerHTML+=\`<li>\${pt}</li>\`});if(!ul.innerHTML)ul.innerHTML='<li style="color:#888;font-style:italic;">No key points.</li>'}const sl=ct.querySelector('#slides');if(sl)renderSlideshowForProjectView(p.slidesData||[],sl.querySelector('#slideshowContainer'));const ch=ct.querySelector('#challenges');if(ch)renderChallengesForProjectView(p.challengesData||[],ch.querySelector('#challengesContainer'));const qz=ct.querySelector('#quiz');if(qz)renderQuizForProjectView(p.quizData||[],qz.querySelector('#quizContainer'),qz.querySelector('#submitQuizBtn'));const tb=pv.querySelector('#projectTabs');const ftb=tb?.querySelector('.tab');if(ftb){const ca=ftb.getAttribute('onclick')||'';const m=ca.match(/openProjectTab\\('([^']+)'/);openProjectTab(m?m[1]:'overview',ftb)}else{updateProjectProgressBar('')}}
function renderMedia(typ,url,tit){if(!url)return'';if(typ==='image')return\`<img src="\${url}" loading="lazy" alt="\${tit}">\`;if(typ==='video'||typ==='presentation')return\`<iframe src="\${url}" frameborder="0" loading="lazy" allowfullscreen sandbox="allow-scripts allow-same-origin allow-presentation" title="\${tit}"></iframe>\`;return''}
function renderLearnItemsForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color:#888;">No objectives.</p>';return}v.forEach((i,x)=>{const e=document.createElement('div');e.className='step';e.innerHTML=\`<div class="step-number">\${x+1}</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display: none;"></div></div>\`;const m=e.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title||'Media');if(mu){m.style.display='block';m.innerHTML=mu}c.appendChild(e)})}
function renderChallengesForProjectView(d,c){if(!c)return;c.innerHTML='';const v=(d||[]).filter(i=>i.title&&i.title.trim());if(v.length===0){c.innerHTML='<p style="color:#888;">No challenges.</p>';return}v.forEach(i=>{const e=document.createElement('div');e.className='step';e.innerHTML=\`<div class="step-number" style="background-color:var(--accent);color:var(--dark);display: flex; justify-content: center; align-items: flex-start; padding-top: 5px;">★</div><div class="step-content"><strong>\${i.title}</strong>\${i.description?\`<p class="description">\${i.description}</p>\`:''}<div class="step-media" style="display: none;"></div></div>\`;const m=e.querySelector('.step-media');const mu=renderMedia(i.mediaType,i.mediaUrl,i.title||'Media');if(mu){m.style.display='block';m.innerHTML=mu}c.appendChild(e)})}
function renderSlideshowForProjectView(d,c){const n=c?.closest('.tab-content#slides')?.querySelector('.slide-nav');if(!c||!n){return}c.innerHTML='';const v=(d||[]).filter(s=>s.url&&s.url.trim());if(v.length===0){c.innerHTML='<p style="color:#888;">No slides.</p>';n.style.display='none';return}n.style.display='flex';v.forEach((s,x)=>{const dv=document.createElement('div');dv.className='slide';const u=s.url.trim();const t=s.type==='image'?'image':'iframe';const ds=s.description||'';const ti=ds||'Slide '+(x+1);dv.innerHTML=\`<div class="slide-content-wrapper"></div>\${ds?\`<p>\${ds}</p>\`:''}\`;const w=dv.querySelector('.slide-content-wrapper');w.innerHTML=renderMedia(t,u,ti);c.appendChild(dv)});currentSlideIndex=0;showSlide(0)}
function renderQuizForProjectView(d,c,b){if(!c||!b)return;c.innerHTML='';c.closest('.tab-content#quiz')?.querySelector('.final-quiz-result')?.remove();b.disabled=!1;b.style.display='none';const v=(d||[]).filter(q=>q.questionText&&q.questionText.trim()&&q.correctAnswer&&q.correctAnswer.trim());if(v.length===0){c.innerHTML='<p style="color:#888;">No quiz.</p>';return}b.style.display='block';v.forEach((q,x)=>{const dv=document.createElement('div');dv.className='quiz-question';dv.innerHTML=\`<p class="question-text">\${x+1}. \${q.questionText}</p><div class="quiz-options"></div><div class="quiz-feedback correct" style="display:none;">Correct!</div><div class="quiz-feedback incorrect" style="display:none;"></div>\`;const od=dv.querySelector('.quiz-options');let os=[q.correctAnswer.trim()];(q.incorrectAnswers||[]).forEach(a=>{if(a&&a.trim())os.push(a.trim())});shuffleArray(os);os.forEach(ot=>{const cr=ot===q.correctAnswer.trim();const oe=document.createElement('div');oe.className='quiz-option';oe.textContent=ot;oe.setAttribute('role','button');oe.setAttribute('tabindex','0');oe.onclick=()=>selectQuizOption(oe);oe.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(oe)}};oe.setAttribute('data-is-correct',cr.toString());od.appendChild(oe)});c.appendChild(dv)})}
// Interactions
function openProjectTab(tn,el){const c=document.getElementById('projectTabContentContainer');if(!c)return;c.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));const bs=document.getElementById('projectTabs');if(bs)bs.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));const t=c.querySelector('#'+tn);if(t)t.classList.add('active');el?.classList.add('active');updateProjectProgressBar(tn)}
function updateProjectProgressBar(tn){const p=document.getElementById('progressBar');if(!p)return;let r=0;const o=['overview','video','slides','challenges','quiz'];const i=o.indexOf(tn);if(i>=0)r=((i+1)/o.length)*100;p.style.width=r+'%'}
function showSlide(n){const s=document.querySelectorAll('#project-view #slideshowContainer .slide');const c=s.length;if(c===0)return;s.forEach(sl=>sl.classList.remove('active'));currentSlideIndex=(n%c+c)%c;if(s[currentSlideIndex])s[currentSlideIndex].classList.add('active')}
function nextSlide(){showSlide(currentSlideIndex+1)}function prevSlide(){showSlide(currentSlideIndex-1)}
function selectQuizOption(oe){const qd=oe.closest('.quiz-question');if(!qd||qd.classList.contains('answered'))return;qd.querySelectorAll('.quiz-option').forEach(o=>o.classList.remove('selected'));oe.classList.add('selected')}
function markProjectAsCompletedInView(pid){const p=courseDataForView.projects.find(pr=>pr.id===pid);if(p&&!p.isCompleted)p.isCompleted=!0;/*Add localStorage persistence here if needed*/}
function submitQuiz(){const qs=document.querySelectorAll('#project-view #quizContainer .quiz-question');let an=0,sc=0;const tt=qs.length;if(tt===0)return;let fu=null;qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');q.classList.remove('answered');q.querySelectorAll('.quiz-feedback').forEach(f=>f.style.display='none');q.querySelectorAll('.quiz-option').forEach(o=>{o.classList.remove('correct','incorrect');o.style.opacity='1';o.style.cursor='pointer';o.onclick=()=>selectQuizOption(o);o.onkeydown=e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();selectQuizOption(o)}}});q.style.outline='';if(s)an++;else if(!fu)fu=q});if(an<tt){alert('Please answer all '+tt+' questions!');if(fu){fu.scrollIntoView({behavior:'smooth',block:'center'});fu.style.outline='2px solid var(--danger)';setTimeout(()=>fu.style.outline='',2500)}return}qs.forEach(q=>{const s=q.querySelector('.quiz-option.selected');const fc=q.querySelector('.quiz-feedback.correct');const fi=q.querySelector('.quiz-feedback.incorrect');const ao=q.querySelectorAll('.quiz-option');q.classList.add('answered');const isc=s.getAttribute('data-is-correct')==='true';ao.forEach(o=>{const oc=o.getAttribute('data-is-correct')==='true';if(oc)o.classList.add('correct');if(o===s){if(!isc)o.classList.add('incorrect')}else if(!oc||o!==q.querySelector('.quiz-option.correct')){o.style.opacity="0.6"}o.style.cursor="default";o.onclick=null;o.onkeydown=null});if(isc){sc++;if(fc)fc.style.display='block'}else{if(fi){const co=q.querySelector('.quiz-option.correct');fi.textContent=\`Not quite. Correct: "\${co?co.textContent:'N/A'}"\`;fi.style.display='block'}}});const b=document.querySelector('#project-view #submitQuizBtn');if(b)b.disabled=!0;const qc=document.querySelector('#project-view #quiz');let rd=qc?.querySelector('.final-quiz-result');if(!rd&&qc){rd=document.createElement('div');qc.appendChild(rd)}if(rd){const pc=tt>0?Math.round((sc/tt)*100):0;const ps=pc>=70;rd.textContent=\`Quiz Complete! Score: \${sc}/\${tt} (\${pc}%).\`;rd.className='final-quiz-result '+(ps?'success':'fail');rd.style.display='block';rd.scrollIntoView({behavior:'smooth',block:'center'});if(ps&&currentProjectIdForView)markProjectAsCompletedInView(currentProjectIdForView)}}
// Init
document.addEventListener('DOMContentLoaded', function() {
    applyCourseThemeForView();
    renderCoursePageForView(); // Render course page including multimedia
    let dsp=!1;
    if (window.location.hash && window.location.hash.startsWith('#project-')) {
        const pid = window.location.hash.substring(9);
        if (courseDataForView.projects.some(p => p.id === pid)) {
            showProjectView(pid); dsp=!0;
        }
    }
    if (!dsp) showCourseView(); // Show course view if no valid project hash
    console.log("Exported Course Viewer Initialized.");
});
            `;
            exportDocElement.querySelector('body').appendChild(viewerScript);

            // Generate HTML string and trigger download
            const htmlContent = '<!DOCTYPE html>\n' + exportDocElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const downloadUrl = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = downloadUrl;
            const filename = (courseData.title || "course_export").replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_').toLowerCase() + '.html';
            a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(downloadUrl);
            console.log("Course export completed.");

        } catch (error) {
            console.error("Error during COURSE export:", error);
            alert("An error occurred during course export. Check the browser console for details.");
        }
    }

    // --- INITIAL PAGE LOAD (Editor Mode) ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Course Editor/Viewer Initializing...");
        // checkProjectCompletionStatus(); // Load completion status if using persistence
        applyCourseTheme(); // Apply initial theme
        renderCoursePage(); // Render the course grid AND multimedia

        // Check hash on load for deep linking into a project (in editor mode)
        let displayedProject = false;
        if (window.location.hash && window.location.hash.startsWith('#project-')) {
            const pid = window.location.hash.substring(9); // Get ID from hash
            if (courseData.projects.some(p => p.id === pid)) {
                showProjectView(pid);
                displayedProject = true;
            }
        }
        // If no valid project hash, show the course view
        if (!displayedProject) {
            showCourseView();
        }

        console.log("Initialization complete.");
    });

</script>

</body>
</html>
